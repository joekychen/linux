<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › aedsp16.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>aedsp16.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">   sound/oss/aedsp16.c</span>

<span class="cm">   Audio Excel DSP 16 software configuration routines</span>
<span class="cm">   Copyright (C) 1995,1996,1997,1998  Riccardo Facchetti (fizban@tin.it)</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Include the main OSS Lite header file. It include all the os, OSS Lite, etc</span>
<span class="cm"> * headers needed by this source.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &quot;sound_config.h&quot;</span>

<span class="cm">/*</span>

<span class="cm">   READ THIS</span>

<span class="cm">   This module started to configure the Audio Excel DSP 16 Sound Card.</span>
<span class="cm">   Now works with the SC-6000 (old aedsp16) and new SC-6600 based cards.</span>

<span class="cm">   NOTE: I have NO idea about Audio Excel DSP 16 III. If someone owns this</span>
<span class="cm">   audio card and want to see the kernel support for it, please contact me.</span>

<span class="cm">   Audio Excel DSP 16 is an SB pro II, Microsoft Sound System and MPU-401</span>
<span class="cm">   compatible card.</span>
<span class="cm">   It is software-only configurable (no jumpers to hard-set irq/dma/mpu-irq),</span>
<span class="cm">   so before this module, the only way to configure the DSP under linux was</span>
<span class="cm">   boot the MS-DOS loading the sound.sys device driver (this driver soft-</span>
<span class="cm">   configure the sound board hardware by massaging someone of its registers),</span>
<span class="cm">   and then ctrl-alt-del to boot linux with the DSP configured by the DOS</span>
<span class="cm">   driver.</span>

<span class="cm">   This module works configuring your Audio Excel DSP 16&#39;s irq, dma and</span>
<span class="cm">   mpu-401-irq. The OSS Lite routines rely on the fact that if the</span>
<span class="cm">   hardware is there, they can detect it. The problem with AEDSP16 is</span>
<span class="cm">   that no hardware can be found by the probe routines if the sound card</span>
<span class="cm">   is not configured properly. Sometimes the kernel probe routines can find</span>
<span class="cm">   an SBPRO even when the card is not configured (this is the standard setup</span>
<span class="cm">   of the card), but the SBPRO emulation don&#39;t work well if the card is not</span>
<span class="cm">   properly initialized. For this reason</span>

<span class="cm">   aedsp16_init_board()</span>

<span class="cm">   routine is called before the OSS Lite probe routines try to detect the</span>
<span class="cm">   hardware.</span>

<span class="cm">   NOTE (READ THE NOTE TOO, IT CONTAIN USEFUL INFORMATIONS)</span>

<span class="cm">   NOTE: Now it works with SC-6000 and SC-6600 based audio cards. The new cards</span>
<span class="cm">   have no jumper switch at all. No more WSS or MPU-401 I/O port switches. They</span>
<span class="cm">   have to be configured by software.</span>

<span class="cm">   NOTE: The driver is merged with the new OSS Lite sound driver. It works</span>
<span class="cm">   as a lowlevel driver.</span>

<span class="cm">   The Audio Excel DSP 16 Sound Card emulates both SBPRO and MSS;</span>
<span class="cm">   the OSS Lite sound driver can be configured for SBPRO and MSS cards</span>
<span class="cm">   at the same time, but the aedsp16 can&#39;t be two cards!!</span>
<span class="cm">   When we configure it, we have to choose the SBPRO or the MSS emulation</span>
<span class="cm">   for AEDSP16. We also can install a *REAL* card of the other type (see [1]).</span>

<span class="cm">   NOTE: If someone can test the combination AEDSP16+MSS or AEDSP16+SBPRO</span>
<span class="cm">   please let me know if it works.</span>

<span class="cm">   The MPU-401 support can be compiled in together with one of the other</span>
<span class="cm">   two operating modes.</span>

<span class="cm">   NOTE: This is something like plug-and-play: we have only to plug</span>
<span class="cm">   the AEDSP16 board in the socket, and then configure and compile</span>
<span class="cm">   a kernel that uses the AEDSP16 software configuration capability.</span>
<span class="cm">   No jumper setting is needed!</span>

<span class="cm">   For example, if you want AEDSP16 to be an SBPro, on irq 10, dma 3</span>
<span class="cm">   you have just to make config the OSS Lite package, configuring</span>
<span class="cm">   the AEDSP16 sound card, then activating the SBPro emulation mode</span>
<span class="cm">   and at last configuring IRQ and DMA.</span>
<span class="cm">   Compile the kernel and run it.</span>

<span class="cm">   NOTE: This means for SC-6000 cards that you can choose irq and dma,</span>
<span class="cm">   but not the I/O addresses. To change I/O addresses you have to set</span>
<span class="cm">   them with jumpers. For SC-6600 cards you have no jumpers so you have</span>
<span class="cm">   to set up your full card configuration in the make config.</span>

<span class="cm">   You can change the irq/dma/mirq settings WITHOUT THE NEED to open</span>
<span class="cm">   your computer and massage the jumpers (there are no irq/dma/mirq</span>
<span class="cm">   jumpers to be configured anyway, only I/O BASE values have to be</span>
<span class="cm">   configured with jumpers)</span>

<span class="cm">   For some ununderstandable reason, the card default of irq 7, dma 1,</span>
<span class="cm">   don&#39;t work for me. Seems to be an IRQ or DMA conflict. Under heavy</span>
<span class="cm">   HDD work, the kernel start to erupt out a lot of messages like:</span>

<span class="cm">   &#39;Sound: DMA timed out - IRQ/DRQ config error?&#39;</span>

<span class="cm">   For what I can say, I have NOT any conflict at irq 7 (under linux I&#39;m</span>
<span class="cm">   using the lp polling driver), and dma line 1 is unused as stated by</span>
<span class="cm">   /proc/dma. I can suppose this is a bug of AEDSP16. I know my hardware so</span>
<span class="cm">   I&#39;m pretty sure I have not any conflict, but may be I&#39;m wrong. Who knows!</span>
<span class="cm">   Anyway a setting of irq 10, dma 3 works really fine.</span>

<span class="cm">   NOTE: if someone can use AEDSP16 with irq 7, dma 1, please let me know</span>
<span class="cm">   the emulation mode, all the installed hardware and the hardware</span>
<span class="cm">   configuration (irq and dma settings of all the hardware).</span>

<span class="cm">   This init module should work with SBPRO+MSS, when one of the two is</span>
<span class="cm">   the AEDSP16 emulation and the other the real card. (see [1])</span>
<span class="cm">   For example:</span>

<span class="cm">   AEDSP16 (0x220) in SBPRO emu (0x220) + real MSS + other</span>
<span class="cm">   AEDSP16 (0x220) in MSS emu + real SBPRO (0x240) + other</span>

<span class="cm">   MPU401 should work. (see [2])</span>

<span class="cm">   [1]</span>
<span class="cm">       ---</span>
<span class="cm">       Date: Mon, 29 Jul 1997 08:35:40 +0100</span>
<span class="cm">       From: Mr S J Greenaway &lt;sjg95@unixfe.rl.ac.uk&gt;</span>

<span class="cm">       [...]</span>
<span class="cm">       Just to let you know got my Audio Excel (emulating a MSS) working</span>
<span class="cm">       with my original SB16, thanks for the driver!</span>
<span class="cm">       [...]</span>
<span class="cm">       ---</span>

<span class="cm">   [2] Not tested by me for lack of hardware.</span>

<span class="cm">   TODO, WISHES AND TECH</span>

<span class="cm">   - About I/O ports allocation -</span>

<span class="cm">   Request the 2x0h region (port base) in any case if we are using this card.</span>

<span class="cm">   NOTE: the &quot;aedsp16 (base)&quot; string with which we are requesting the aedsp16</span>
<span class="cm">   port base region (see code) does not mean necessarily that we are emulating</span>
<span class="cm">   sbpro.  Even if this region is the sbpro I/O ports region, we use this</span>
<span class="cm">   region to access the control registers of the card, and if emulating</span>
<span class="cm">   sbpro, I/O sbpro registers too. If we are emulating MSS, the sbpro</span>
<span class="cm">   registers are not used, in no way, to emulate an sbpro: they are</span>
<span class="cm">   used only for configuration purposes.</span>

<span class="cm">   Started Fri Mar 17 16:13:18 MET 1995</span>

<span class="cm">   v0.1 (ALPHA, was a user-level program called AudioExcelDSP16.c)</span>
<span class="cm">   - Initial code.</span>
<span class="cm">   v0.2 (ALPHA)</span>
<span class="cm">   - Cleanups.</span>
<span class="cm">   - Integrated with Linux voxware v 2.90-2 kernel sound driver.</span>
<span class="cm">   - SoundBlaster Pro mode configuration.</span>
<span class="cm">   - Microsoft Sound System mode configuration.</span>
<span class="cm">   - MPU-401 mode configuration.</span>
<span class="cm">   v0.3 (ALPHA)</span>
<span class="cm">   - Cleanups.</span>
<span class="cm">   - Rearranged the code to let aedsp16_init_board be more general.</span>
<span class="cm">   - Erased the REALLY_SLOW_IO. We don&#39;t need it. Erased the linux/io.h</span>
<span class="cm">   inclusion too. We rely on os.h</span>
<span class="cm">   - Used the  to get a variable</span>
<span class="cm">   len string (we are not sure about the len of Copyright string).</span>
<span class="cm">   This works with any SB and compatible.</span>
<span class="cm">   - Added the code to request_region at device init (should go in</span>
<span class="cm">   the main body of voxware).</span>
<span class="cm">   v0.4 (BETA)</span>
<span class="cm">   - Better configure.c patch for aedsp16 configuration (better</span>
<span class="cm">   logic of inclusion of AEDSP16 support)</span>
<span class="cm">   - Modified the conditional compilation to better support more than</span>
<span class="cm">   one sound card of the emulated type (read the NOTES above)</span>
<span class="cm">   - Moved the sb init routine from the attach to the very first</span>
<span class="cm">   probe in sb_card.c</span>
<span class="cm">   - Rearrangements and cleanups</span>
<span class="cm">   - Wiped out some unnecessary code and variables: this is kernel</span>
<span class="cm">   code so it is better save some TEXT and DATA</span>
<span class="cm">   - Fixed the request_region code. We must allocate the aedsp16 (sbpro)</span>
<span class="cm">   I/O ports in any case because they are used to access the DSP</span>
<span class="cm">   configuration registers and we can not allow anyone to get them.</span>
<span class="cm">   v0.5</span>
<span class="cm">   - cleanups on comments</span>
<span class="cm">   - prep for diffs against v3.0-proto-950402</span>
<span class="cm">   v0.6</span>
<span class="cm">   - removed the request_region()s when compiling the MODULE sound.o</span>
<span class="cm">   because we are not allowed (by the actual voxware structure) to</span>
<span class="cm">   release_region()</span>
<span class="cm">   v0.7 (pre ALPHA, not distributed)</span>
<span class="cm">   - started porting this module to kernel 1.3.84. Dummy probe/attach</span>
<span class="cm">   routines.</span>
<span class="cm">   v0.8 (ALPHA)</span>
<span class="cm">   - attached all the init routines.</span>
<span class="cm">   v0.9 (BETA)</span>
<span class="cm">   - Integrated with linux-pre2.0.7</span>
<span class="cm">   - Integrated with configuration scripts.</span>
<span class="cm">   - Cleaned up and beautyfied the code.</span>
<span class="cm">   v0.9.9 (BETA)</span>
<span class="cm">   - Thanks to Piercarlo Grandi: corrected the conditonal compilation code.</span>
<span class="cm">     Now only the code configured is compiled in, with some memory saving.</span>
<span class="cm">   v0.9.10</span>
<span class="cm">   - Integration into the sound/lowlevel/ section of the sound driver.</span>
<span class="cm">   - Re-organized the code.</span>
<span class="cm">   v0.9.11 (not distributed)</span>
<span class="cm">   - Rewritten the init interface-routines to initialize the AEDSP16 in</span>
<span class="cm">     one shot.</span>
<span class="cm">   - More cosmetics.</span>
<span class="cm">   - SC-6600 support.</span>
<span class="cm">   - More soft/hard configuration.</span>
<span class="cm">   v0.9.12</span>
<span class="cm">   - Refined the v0.9.11 code with conditional compilation to distinguish</span>
<span class="cm">     between SC-6000 and SC-6600 code.</span>
<span class="cm">   v1.0.0</span>
<span class="cm">   - Prep for merging with OSS Lite and Linux kernel 2.1.13</span>
<span class="cm">   - Corrected a bug in request/check/release region calls (thanks to the</span>
<span class="cm">     new kernel exception handling).</span>
<span class="cm">   v1.1</span>
<span class="cm">   - Revamped for integration with new modularized sound drivers: to enhance</span>
<span class="cm">     the flexibility of modular version, I have removed all the conditional</span>
<span class="cm">     compilation for SBPRO, MPU and MSS code. Now it is all managed with</span>
<span class="cm">     the ae_config structure.</span>
<span class="cm">   v1.2</span>
<span class="cm">   - Module informations added.</span>
<span class="cm">   - Removed aedsp16_delay_10msec(), now using mdelay(10)</span>
<span class="cm">   - All data and funcs moved to .*.init section.</span>
<span class="cm">   v1.3</span>
<span class="cm">   Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt; - 2000/09/27</span>
<span class="cm">   - got rid of check_region</span>

<span class="cm">   Known Problems:</span>
<span class="cm">   - Audio Excel DSP 16 III don&#39;t work with this driver.</span>

<span class="cm">   Credits:</span>
<span class="cm">   Many thanks to Gerald Britton &lt;gbritton@CapAccess.org&gt;. He helped me a</span>
<span class="cm">   lot in testing the 0.9.11 and 0.9.12 versions of this driver.</span>

<span class="cm"> */</span>


<span class="cp">#define VERSION &quot;1.3&quot;		</span><span class="cm">/* Version of Audio Excel DSP 16 driver */</span><span class="cp"></span>

<span class="cp">#undef	AEDSP16_DEBUG 		</span><span class="cm">/* Define this to 1 to enable debug code     */</span><span class="cp"></span>
<span class="cp">#undef	AEDSP16_DEBUG_MORE 	</span><span class="cm">/* Define this to 1 to enable more debug     */</span><span class="cp"></span>
<span class="cp">#undef	AEDSP16_INFO 		</span><span class="cm">/* Define this to 1 to enable info code      */</span><span class="cp"></span>

<span class="cp">#if defined(AEDSP16_DEBUG)</span>
<span class="cp"># define DBG(x)  printk x</span>
<span class="cp"># if defined(AEDSP16_DEBUG_MORE)</span>
<span class="cp">#  define DBG1(x) printk x</span>
<span class="cp"># else</span>
<span class="cp">#  define DBG1(x)</span>
<span class="cp"># endif</span>
<span class="cp">#else</span>
<span class="cp"># define DBG(x)</span>
<span class="cp"># define DBG1(x)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Misc definitions</span>
<span class="cm"> */</span>
<span class="cp">#define TRUE	1</span>
<span class="cp">#define FALSE	0</span>

<span class="cm">/*</span>
<span class="cm"> * Region Size for request/check/release region.</span>
<span class="cm"> */</span>
<span class="cp">#define IOBASE_REGION_SIZE	0x10</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware related defaults</span>
<span class="cm"> */</span>
<span class="cp">#define DEF_AEDSP16_IOB 0x220   </span><span class="cm">/* 0x220(default) 0x240                 */</span><span class="cp"></span>
<span class="cp">#define DEF_AEDSP16_IRQ 7	</span><span class="cm">/* 5 7(default) 9 10 11                 */</span><span class="cp"></span>
<span class="cp">#define DEF_AEDSP16_MRQ 0	</span><span class="cm">/* 5 7 9 10 0(default), 0 means disable */</span><span class="cp"></span>
<span class="cp">#define DEF_AEDSP16_DMA 1	</span><span class="cm">/* 0 1(default) 3                       */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Commands of AEDSP16&#39;s DSP (SBPRO+special).</span>
<span class="cm"> * Some of them are COMMAND_xx, in the future they may change.</span>
<span class="cm"> */</span>
<span class="cp">#define WRITE_MDIRQ_CFG   0x50	</span><span class="cm">/* Set M&amp;I&amp;DRQ mask (the real config)   */</span><span class="cp"></span>
<span class="cp">#define COMMAND_52        0x52	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define READ_HARD_CFG     0x58	</span><span class="cm">/* Read Hardware Config (I/O base etc)  */</span><span class="cp"></span>
<span class="cp">#define COMMAND_5C        0x5c	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define COMMAND_60        0x60	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define COMMAND_66        0x66	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define COMMAND_6C        0x6c	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define COMMAND_6E        0x6e	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define COMMAND_88        0x88	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define DSP_INIT_MSS      0x8c	</span><span class="cm">/* Enable Microsoft Sound System mode   */</span><span class="cp"></span>
<span class="cp">#define COMMAND_C5        0xc5	</span><span class="cm">/*                                      */</span><span class="cp"></span>
<span class="cp">#define GET_DSP_VERSION   0xe1	</span><span class="cm">/* Get DSP Version                      */</span><span class="cp"></span>
<span class="cp">#define GET_DSP_COPYRIGHT 0xe3	</span><span class="cm">/* Get DSP Copyright                    */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Offsets of AEDSP16 DSP I/O ports. The offset is added to base I/O port</span>
<span class="cm"> * to have the actual I/O port.</span>
<span class="cm"> * Register permissions are:</span>
<span class="cm"> * (wo) == Write Only</span>
<span class="cm"> * (ro) == Read  Only</span>
<span class="cm"> * (w-) == Write</span>
<span class="cm"> * (r-) == Read</span>
<span class="cm"> */</span>
<span class="cp">#define DSP_RESET    0x06	</span><span class="cm">/* offset of DSP RESET             (wo) */</span><span class="cp"></span>
<span class="cp">#define DSP_READ     0x0a	</span><span class="cm">/* offset of DSP READ              (ro) */</span><span class="cp"></span>
<span class="cp">#define DSP_WRITE    0x0c	</span><span class="cm">/* offset of DSP WRITE             (w-) */</span><span class="cp"></span>
<span class="cp">#define DSP_COMMAND  0x0c	</span><span class="cm">/* offset of DSP COMMAND           (w-) */</span><span class="cp"></span>
<span class="cp">#define DSP_STATUS   0x0c	</span><span class="cm">/* offset of DSP STATUS            (r-) */</span><span class="cp"></span>
<span class="cp">#define DSP_DATAVAIL 0x0e	</span><span class="cm">/* offset of DSP DATA AVAILABLE    (ro) */</span><span class="cp"></span>


<span class="cp">#define RETRY           10	</span><span class="cm">/* Various retry values on I/O opera-   */</span><span class="cp"></span>
<span class="cp">#define STATUSRETRY   1000	</span><span class="cm">/* tions. Sometimes we have to          */</span><span class="cp"></span>
<span class="cp">#define HARDRETRY   500000	</span><span class="cm">/* wait for previous cmd to complete    */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Size of character arrays that store name and version of sound card</span>
<span class="cm"> */</span>
<span class="cp">#define CARDNAMELEN	15	</span><span class="cm">/* Size of the card&#39;s name in chars     */</span><span class="cp"></span>
<span class="cp">#define CARDVERLEN	10	</span><span class="cm">/* Size of the card&#39;s version in chars	*/</span><span class="cp"></span>
<span class="cp">#define CARDVERDIGITS	2	</span><span class="cm">/* Number of digits in the version	*/</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_SC6600)</span>
<span class="cm">/*</span>
<span class="cm"> * Bitmapped flags of hard configuration</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Decode macros (xl == low byte, xh = high byte)</span>
<span class="cm"> */</span>
<span class="cp">#define IOBASE(xl)		((xl &amp; 0x01)?0x240:0x220)</span>
<span class="cp">#define JOY(xl)  		(xl &amp; 0x02)</span>
<span class="cp">#define MPUADDR(xl)		( 			\</span>
<span class="cp">				(xl &amp; 0x0C)?0x330:	\</span>
<span class="cp">				(xl &amp; 0x08)?0x320:	\</span>
<span class="cp">				(xl &amp; 0x04)?0x310:	\</span>
<span class="cp">						0x300)</span>
<span class="cp">#define WSSADDR(xl)		((xl &amp; 0x10)?0xE80:0x530)</span>
<span class="cp">#define CDROM(xh)		(xh &amp; 0x20)</span>
<span class="cp">#define CDROMADDR(xh)		(((xh &amp; 0x1F) &lt;&lt; 4) + 0x200)</span>
<span class="cm">/*</span>
<span class="cm"> * Encode macros</span>
<span class="cm"> */</span>
<span class="cp">#define BLDIOBASE(xl, val) {		\</span>
<span class="cp">	xl &amp;= ~0x01; 			\</span>
<span class="cp">	if (val == 0x240)		\</span>
<span class="cp">		xl |= 0x01;		\</span>
<span class="cp">	}</span>
<span class="cp">#define BLDJOY(xl, val) {		\</span>
<span class="cp">	xl &amp;= ~0x02; 			\</span>
<span class="cp">	if (val == 1)			\</span>
<span class="cp">		xl |= 0x02;		\</span>
<span class="cp">	}</span>
<span class="cp">#define BLDMPUADDR(xl, val) {		\</span>
<span class="cp">	xl &amp;= ~0x0C;			\</span>
<span class="cp">	switch (val) {			\</span>
<span class="cp">		case 0x330:		\</span>
<span class="cp">			xl |= 0x0C;	\</span>
<span class="cp">			break;		\</span>
<span class="cp">		case 0x320:		\</span>
<span class="cp">			xl |= 0x08;	\</span>
<span class="cp">			break;		\</span>
<span class="cp">		case 0x310:		\</span>
<span class="cp">			xl |= 0x04;	\</span>
<span class="cp">			break;		\</span>
<span class="cp">		case 0x300:		\</span>
<span class="cp">			xl |= 0x00;	\</span>
<span class="cp">			break;		\</span>
<span class="cp">		default:		\</span>
<span class="cp">			xl |= 0x00;	\</span>
<span class="cp">			break;		\</span>
<span class="cp">		}			\</span>
<span class="cp">	}</span>
<span class="cp">#define BLDWSSADDR(xl, val) {		\</span>
<span class="cp">	xl &amp;= ~0x10; 			\</span>
<span class="cp">	if (val == 0xE80)		\</span>
<span class="cp">		xl |= 0x10;		\</span>
<span class="cp">	}</span>
<span class="cp">#define BLDCDROM(xh, val) {		\</span>
<span class="cp">	xh &amp;= ~0x20; 			\</span>
<span class="cp">	if (val == 1)			\</span>
<span class="cp">		xh |= 0x20;		\</span>
<span class="cp">	}</span>
<span class="cp">#define BLDCDROMADDR(xh, val) {		\</span>
<span class="cp">	int tmp = val;			\</span>
<span class="cp">	tmp -= 0x200;			\</span>
<span class="cp">	tmp &gt;&gt;= 4;			\</span>
<span class="cp">	tmp &amp;= 0x1F;			\</span>
<span class="cp">	xh |= tmp;			\</span>
<span class="cp">	xh &amp;= 0x7F;			\</span>
<span class="cp">	xh |= 0x40;			\</span>
<span class="cp">	}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SC6600 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Bit mapped flags for calling aedsp16_init_board(), and saving the current</span>
<span class="cm"> * emulation mode.</span>
<span class="cm"> */</span>
<span class="cp">#define INIT_NONE   (0   )</span>
<span class="cp">#define INIT_SBPRO  (1&lt;&lt;0)</span>
<span class="cp">#define INIT_MSS    (1&lt;&lt;1)</span>
<span class="cp">#define INIT_MPU401 (1&lt;&lt;2)</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="n">soft_cfg</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* bitmapped config */</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">soft_cfg_mss</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* bitmapped mss config */</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">ver</span><span class="p">[</span><span class="n">CARDVERDIGITS</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>	<span class="cm">/* DSP Ver:</span>
<span class="cm">						   hi-&gt;ver[0] lo-&gt;ver[1] */</span>

<span class="cp">#if defined(CONFIG_SC6600)</span>
<span class="k">static</span> <span class="kt">int</span>	<span class="n">hard_cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>     <span class="cm">/* lo&lt;-hard_cfg[0] hi&lt;-hard_cfg[1]      */</span>
                     <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SC6600 */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_SC6600)</span>
<span class="cm">/* Decoded hard configuration */</span>
<span class="k">struct</span>	<span class="n">d_hcfg</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">joystick</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpubase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wssbase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cdrom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cdrombase</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">d_hcfg</span> <span class="n">decoded_hcfg</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SC6600 */</span><span class="cp"></span>

<span class="cm">/* orVals contain the values to be or&#39;ed       				*/</span>
<span class="k">struct</span> <span class="n">orVals</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">val</span><span class="p">;</span>		<span class="cm">/* irq|mirq|dma                         */</span>
	<span class="kt">int</span>	<span class="n">or</span><span class="p">;</span>		<span class="cm">/* soft_cfg |= TheStruct.or             */</span>
<span class="p">};</span>

<span class="cm">/* aedsp16_info contain the audio card configuration                  */</span>
<span class="k">struct</span> <span class="n">aedsp16_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">base_io</span><span class="p">;</span>            <span class="cm">/* base I/O address for accessing card  */</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>                <span class="cm">/* irq value for DSP I/O                */</span>
	<span class="kt">int</span> <span class="n">mpu_irq</span><span class="p">;</span>            <span class="cm">/* irq for mpu401 interface I/O         */</span>
	<span class="kt">int</span> <span class="n">dma</span><span class="p">;</span>                <span class="cm">/* dma value for DSP I/O                */</span>
	<span class="kt">int</span> <span class="n">mss_base</span><span class="p">;</span>           <span class="cm">/* base I/O for Microsoft Sound System  */</span>
	<span class="kt">int</span> <span class="n">mpu_base</span><span class="p">;</span>           <span class="cm">/* base I/O for MPU-401 emulation       */</span>
	<span class="kt">int</span> <span class="n">init</span><span class="p">;</span>               <span class="cm">/* Initialization status of the card    */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Magic values that the DSP will eat when configuring irq/mirq/dma</span>
<span class="cm"> */</span>
<span class="cm">/* DSP IRQ conversion array             */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">orVals</span> <span class="n">orIRQ</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* MPU-401 IRQ conversion array         */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">orVals</span> <span class="n">orMIRQ</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* DMA Channels conversion array        */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">orVals</span> <span class="n">orDMA</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">aedsp16_info</span> <span class="n">ae_config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DEF_AEDSP16_IOB</span><span class="p">,</span>
	<span class="n">DEF_AEDSP16_IRQ</span><span class="p">,</span>
	<span class="n">DEF_AEDSP16_MRQ</span><span class="p">,</span>
	<span class="n">DEF_AEDSP16_DMA</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">INIT_NONE</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Buffers to store audio card informations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span>     <span class="n">DSPCopyright</span><span class="p">[</span><span class="n">CARDNAMELEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span>     <span class="n">DSPVersion</span><span class="p">[</span><span class="n">CARDVERLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_wait_data</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">loop</span> <span class="o">=</span> <span class="n">STATUSRETRY</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DBG1</span><span class="p">((</span><span class="s">&quot;aedsp16_wait_data (0x%x): &quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		  <span class="n">ret</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">DSP_DATAVAIL</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for data available (bit 7 of ret == 1)</span>
<span class="cm">	 */</span>
	  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">loop</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG1</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG1</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">inbyte</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;    Read DSP Byte (0x%x): &quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_wait_data</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">inbyte</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">DSP_READ</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;read [0x%x]/{%c}.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inbyte</span><span class="p">,</span> <span class="n">inbyte</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">inbyte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_test_dsp</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_dsp_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Reset DSP</span>
<span class="cm">	 */</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;Reset DSP:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">DSP_RESET</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">DSP_RESET</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_test_dsp</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">loop</span> <span class="o">=</span> <span class="n">HARDRETRY</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;    Write DSP Byte (0x%x) [0x%x]: &quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span> <span class="o">+</span> <span class="n">DSP_STATUS</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * DSP ready to receive data if bit 7 of ret == 0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">DSP_COMMAND</span><span class="p">);</span>
			<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="o">--</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] DSP Command (0x%x) timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SC6600)</span>

<span class="cp">#if defined(AEDSP16_INFO) || defined(AEDSP16_DEBUG)</span>
<span class="kt">void</span> <span class="n">__init</span> <span class="nf">aedsp16_pinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;</span><span class="se">\n</span><span class="s"> Base address:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">iobase</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; Joystick    : %s present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">joystick</span><span class="o">?</span><span class="s">&quot;&quot;</span><span class="o">:</span><span class="s">&quot; not&quot;</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; WSS addr    :  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">wssbase</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; MPU-401 addr:  %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">mpubase</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; CDROM       : %s present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span><span class="o">!=</span><span class="mi">4</span><span class="p">)</span><span class="o">?</span><span class="s">&quot;&quot;</span><span class="o">:</span><span class="s">&quot; not&quot;</span><span class="p">));</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; CDROMADDR   :  %x</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrombase</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">aedsp16_hard_decode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; aedsp16_hard_decode: 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

<span class="cm">/*</span>
<span class="cm"> * Decode Cfg Bytes.</span>
<span class="cm"> */</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">iobase</span>	<span class="o">=</span> <span class="n">IOBASE</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">joystick</span>	<span class="o">=</span> <span class="n">JOY</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">wssbase</span>	<span class="o">=</span> <span class="n">WSSADDR</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">mpubase</span>	<span class="o">=</span> <span class="n">MPUADDR</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span>	<span class="o">=</span> <span class="n">CDROM</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrombase</span>	<span class="o">=</span> <span class="n">CDROMADDR</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="cp">#if defined(AEDSP16_INFO) || defined(AEDSP16_DEBUG)</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; Original sound card configuration:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">aedsp16_pinfo</span><span class="p">();</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Now set up the real kernel configuration.</span>
<span class="cm"> */</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">iobase</span>	<span class="o">=</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">;</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">wssbase</span>	<span class="o">=</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span><span class="p">;</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">mpubase</span>	<span class="o">=</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_base</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SC6600_JOY)</span>
 	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">joystick</span>	<span class="o">=</span> <span class="n">CONFIG_SC6600_JOY</span><span class="p">;</span> <span class="cm">/* Enable */</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_SC6600_CDROM)</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span>	<span class="o">=</span> <span class="n">CONFIG_SC6600_CDROM</span><span class="p">;</span> <span class="cm">/* 4:N-3:I-2:G-1:P-0:S */</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_SC6600_CDROMBASE)</span>
	<span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrombase</span>	<span class="o">=</span> <span class="n">CONFIG_SC6600_CDROMBASE</span><span class="p">;</span> <span class="cm">/* 0 Disable */</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(AEDSP16_DEBUG)</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; New Values:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">aedsp16_pinfo</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">aedsp16_hard_encode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; aedsp16_hard_encode: 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

	<span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="n">BLDIOBASE</span> <span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">BLDWSSADDR</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">wssbase</span><span class="p">);</span>
	<span class="n">BLDMPUADDR</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">mpubase</span><span class="p">);</span>
	<span class="n">BLDJOY</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">joystick</span><span class="p">);</span>
	<span class="n">BLDCDROM</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span><span class="p">);</span>
	<span class="n">BLDCDROMADDR</span><span class="p">(</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrombase</span><span class="p">);</span>

<span class="cp">#if defined(AEDSP16_DEBUG)</span>
	<span class="n">aedsp16_pinfo</span><span class="p">();</span>
<span class="cp">#endif</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot; aedsp16_hard_encode: 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_hard_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;aedsp16_hard_write:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_6C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_6C</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_C5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_C5</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_hard_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;aedsp16_hard_read:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">READ_HARD_CFG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">READ_HARD_CFG</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">READ_HARD_CFG</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hard_cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">READ_HARD_CFG</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">READ_HARD_CFG</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_ext_cfg_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>

	<span class="kt">int</span> <span class="n">extcfg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_66</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_66</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">extcfg</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">extcfg</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">extcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrombase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">extcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">mpubase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">extcfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">extcfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] Write extcfg: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] Write extcfg: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">decoded_hcfg</span><span class="p">.</span><span class="n">cdrom</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_52</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_52</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="p">,</span> <span class="n">COMMAND_52</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0x7F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_60</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_60</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] Write val: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_SC6600 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_cfg_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WRITE_MDIRQ_CFG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WRITE_MDIRQ_CFG</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">soft_cfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] Initialization of (M)IRQ and DMA: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_init_mss</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;aedsp16_init_mss:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">DSP_INIT_MSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_init_mss [0x%x]: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">DSP_INIT_MSS</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_cfg_write</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">soft_cfg_mss</span><span class="p">,</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_setup_board</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">loop</span> <span class="o">=</span> <span class="n">RETRY</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SC6600)</span>
	<span class="kt">int</span>	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_hard_read</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_hard_read: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_52</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_52</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">COMMAND_52</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_88</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_88</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">aedsp16_wait_data</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">loop</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">COMMAND_88</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if !defined(CONFIG_SC6600)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_cfg_write</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_SC6600)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_60</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_60</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_6E</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_6E</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ver</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_hard_write</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_hard_write: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(THIS_IS_A_THING_I_HAVE_NOT_TESTED_YET)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_cfg_write</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_stdcfg</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">WRITE_MDIRQ_CFG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WRITE_MDIRQ_CFG</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * 0x0A == (IRQ 7, DMA 1, MIRQ 0)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_stdcfg: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_dsp_version</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;Get DSP Version:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">GET_DSP_VERSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GET_DSP_VERSION</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * We already know how many int are stored (2), so we know when the</span>
<span class="cm">	 * string is finished.</span>
<span class="cm">	 */</span>
		<span class="n">ver</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">CARDVERDIGITS</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">DSPVersion</span><span class="p">,</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span> <span class="n">ver</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ver</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_dsp_copyright</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;Get DSP Copyright:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_write</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">GET_DSP_COPYRIGHT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">GET_DSP_COPYRIGHT</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">aedsp16_read</span><span class="p">(</span><span class="n">port</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If no more data available, return to the caller, no error if len&gt;0.</span>
<span class="cm">	 * We have no other way to know when the string is finished.</span>
<span class="cm">	 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">DSPCopyright</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

	  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">CARDNAMELEN</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;success.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">aedsp16_init_tables</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">DSPCopyright</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CARDNAMELEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">DSPVersion</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CARDVERLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">orIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">==</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">soft_cfg</span> <span class="o">|=</span> <span class="n">orIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>
			<span class="n">soft_cfg_mss</span> <span class="o">|=</span> <span class="n">orIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">orMIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orMIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span> <span class="o">==</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_irq</span><span class="p">)</span>
			<span class="n">soft_cfg</span> <span class="o">|=</span> <span class="n">orMIRQ</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">orDMA</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orDMA</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">==</span> <span class="n">ae_config</span><span class="p">.</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">soft_cfg</span> <span class="o">|=</span> <span class="n">orDMA</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>
			<span class="n">soft_cfg_mss</span> <span class="o">|=</span> <span class="n">orDMA</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">or</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">aedsp16_init_board</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aedsp16_init_tables</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_dsp_reset</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_dsp_reset: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_dsp_copyright</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_dsp_copyright: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * My AEDSP16 card return SC-6000 in DSPCopyright, so</span>
<span class="cm">	 * if we have something different, we have to be warned.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;SC-6000&quot;</span><span class="p">,</span> <span class="n">DSPCopyright</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] Warning: non SC-6000 audio card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_dsp_version</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_dsp_version: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_stdcfg</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_stdcfg: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SC6600)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_hard_read</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_hard_read: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aedsp16_hard_decode</span><span class="p">();</span>

	<span class="n">aedsp16_hard_encode</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_hard_write</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_hard_write: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_ext_cfg_write</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_ext_cfg_write: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SC6600 */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_setup_board</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] aedsp16_setup_board: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">aedsp16_init_mss</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">)</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;[AEDSP16] Can not initialize&quot;</span>
				       <span class="s">&quot;Microsoft Sound System mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#if !defined(MODULE) || defined(AEDSP16_INFO) || defined(AEDSP16_DEBUG)</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Audio Excel DSP 16 init v%s (%s %s) [&quot;</span><span class="p">,</span>
		<span class="n">VERSION</span><span class="p">,</span> <span class="n">DSPCopyright</span><span class="p">,</span>
		<span class="n">DSPVersion</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MPU401</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MPU401&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_SBPRO</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_SBPRO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SBPro&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;MSS&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* MODULE || AEDSP16_INFO || AEDSP16_DEBUG */</span><span class="cp"></span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_aedsp16_sb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;init_aedsp16_sb: &quot;</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * If the card is already init&#39;ed MSS, we can not init it to SBPRO too</span>
<span class="cm"> * because the board can not emulate simultaneously MSS and SBPRO.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_SBPRO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">|=</span> <span class="n">INIT_SBPRO</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uninit_aedsp16_sb</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;uninit_aedsp16_sb: &quot;</span><span class="p">));</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INIT_SBPRO</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_aedsp16_mss</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;init_aedsp16_mss: &quot;</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * If the card is already init&#39;ed SBPRO, we can not init it to MSS too</span>
<span class="cm"> * because the board can not emulate simultaneously MSS and SBPRO.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_SBPRO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * We must allocate the CONFIG_AEDSP16_BASE region too because these are the </span>
<span class="cm"> * I/O ports to access card&#39;s control registers.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MPU401</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">IOBASE_REGION_SIZE</span><span class="p">,</span>
				<span class="s">&quot;aedsp16 (base)&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span>
			<span class="s">&quot;AEDSP16 BASE I/O port region is already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">|=</span> <span class="n">INIT_MSS</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uninit_aedsp16_mss</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;uninit_aedsp16_mss: &quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MPU401</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">IOBASE_REGION_SIZE</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;AEDSP16 base region released.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INIT_MSS</span><span class="p">;</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_aedsp16_mpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;init_aedsp16_mpu: &quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MPU401</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * We must request the CONFIG_AEDSP16_BASE region too because these are the I/O </span>
<span class="cm"> * ports to access card&#39;s control registers.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INIT_MSS</span> <span class="o">|</span> <span class="n">INIT_SBPRO</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">IOBASE_REGION_SIZE</span><span class="p">,</span>
					<span class="s">&quot;aedsp16 (base)&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span>
			<span class="s">&quot;AEDSP16 BASE I/O port region is already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">|=</span> <span class="n">INIT_MPU401</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uninit_aedsp16_mpu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;uninit_aedsp16_mpu: &quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INIT_MSS</span> <span class="o">|</span> <span class="n">INIT_SBPRO</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;</span> <span class="n">INIT_MPU401</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span> <span class="n">IOBASE_REGION_SIZE</span><span class="p">);</span>
		<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;AEDSP16 base region released.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">init</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INIT_MPU401</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_aedsp16</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">initialized</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">((</span><span class="s">&quot;Initializing BASE[0x%x] IRQ[%d] DMA[%d] MIRQ[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span><span class="p">,</span><span class="n">ae_config</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span><span class="n">ae_config</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_irq</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_aedsp16_sb</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uninit_aedsp16_sb</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">initialized</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_aedsp16_mpu</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uninit_aedsp16_mpu</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">initialized</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * In the sequence of init routines, the MSS init MUST be the last!</span>
<span class="cm"> * This because of the special register programming the MSS mode needs.</span>
<span class="cm"> * A board reset would disable the MSS mode restoring the default SBPRO</span>
<span class="cm"> * mode.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_aedsp16_mss</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uninit_aedsp16_mss</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">initialized</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initialized</span><span class="p">)</span>
		<span class="n">initialized</span> <span class="o">=</span> <span class="n">aedsp16_init_board</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">initialized</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">uninit_aedsp16</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">uninit_aedsp16_mss</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">uninit_aedsp16_sb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_base</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">uninit_aedsp16_mpu</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">io</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">mpu_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">mss_base</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">mpu_base</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="s">&quot;I/O base address (0x220 0x240)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ line (5 7 9 10 11)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;dma line (0 1 3)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">,</span> <span class="s">&quot;MPU-401 IRQ line (5 7 9 10 0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mss_base</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mss_base</span><span class="p">,</span> <span class="s">&quot;MSS emulation I/O base address (0x530 0xE80)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mpu_base</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_base</span><span class="p">,</span><span class="s">&quot;MPU-401 I/O base address (0x300 0x310 0x320 0x330)&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Riccardo Facchetti &lt;fizban@tin.it&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Audio Excel DSP 16 Driver Version &quot;</span> <span class="n">VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">do_init_aedsp16</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Audio Excel DSP 16 init driver Copyright (C) Riccardo Facchetti 1995-98</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">io</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">dma</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;aedsp16: I/O, IRQ and DMA are mandatory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">base_io</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
	<span class="n">ae_config</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">ae_config</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>

	<span class="n">ae_config</span><span class="p">.</span><span class="n">mss_base</span> <span class="o">=</span> <span class="n">mss_base</span><span class="p">;</span>
	<span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_base</span> <span class="o">=</span> <span class="n">mpu_base</span><span class="p">;</span>
	<span class="n">ae_config</span><span class="p">.</span><span class="n">mpu_irq</span> <span class="o">=</span> <span class="n">mpu_irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_aedsp16</span><span class="p">()</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;aedsp16: initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX</span>
<span class="cm">		 * What error should we return here ?</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_aedsp16</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">uninit_aedsp16</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">do_init_aedsp16</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_aedsp16</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_aedsp16</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* io, irq, dma, mss_io, mpu_io, mpu_irq */</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	
	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

	<span class="n">io</span>	 <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">irq</span>	 <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dma</span>	 <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">mss_base</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">mpu_base</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">mpu_irq</span>	 <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;aedsp16=&quot;</span><span class="p">,</span> <span class="n">setup_aedsp16</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
