<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › dmabuf.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dmabuf.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sound/oss/dmabuf.c</span>
<span class="cm"> *</span>
<span class="cm"> * The DMA buffer manager for digitized voice applications</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> *</span>
<span class="cm"> * Thomas Sailer   : moved several static variables into struct audio_operations</span>
<span class="cm"> *                   (which is grossly misnamed btw.) because they have the same</span>
<span class="cm"> *                   lifetime as the rest in there and dynamic allocation saves</span>
<span class="cm"> *                   12k or so</span>
<span class="cm"> * Thomas Sailer   : remove {in,out}_sleep_flag. It was used for the sleeper to</span>
<span class="cm"> *                   determine if it was woken up by the expiring timeout or by</span>
<span class="cm"> *                   an explicit wake_up. The return value from schedule_timeout</span>
<span class="cm"> *		     can be used instead; if 0, the wakeup was due to the timeout.</span>
<span class="cm"> *</span>
<span class="cm"> * Rob Riggs		Added persistent DMA buffers (1998/10/17)</span>
<span class="cm"> */</span>

<span class="cp">#define BE_CONSERVATIVE</span>
<span class="cp">#define SAMPLE_ROUNDUP 0</span>

<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &quot;sound_config.h&quot;</span>

<span class="cp">#define DMAP_FREE_ON_CLOSE      0</span>
<span class="cp">#define DMAP_KEEP_ON_CLOSE      1</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sound_dmap_flag</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dma_reset_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dma_reset_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">local_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_mode</span><span class="p">);</span>



<span class="k">static</span> <span class="kt">int</span> <span class="n">debugmem</span><span class="p">;</span>    	<span class="cm">/* switched off by default */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma_buffsize</span> <span class="o">=</span> <span class="n">DSP_BUFFSIZE</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">dmabuf_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">tmout</span><span class="p">;</span>

	<span class="n">tmout</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">;</span>
	<span class="n">tmout</span> <span class="o">+=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* Some safety distance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">tmout</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span>
		<span class="n">tmout</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmout</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_alloc_dmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">end_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_pagesize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_MAP_MAPPED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Already done */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_buffsize</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">dma_buffsize</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">dma_pagesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	
	<span class="cm">/*</span>
<span class="cm">	 *	Now check for the Cyrix problem.</span>
<span class="cm">	 */</span>
	 
	<span class="k">if</span><span class="p">(</span><span class="n">isa_dma_bridge_buggy</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span>
		<span class="n">dma_pagesize</span><span class="o">=</span><span class="mi">32768</span><span class="p">;</span>
	 
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">=</span> <span class="n">dma_buffsize</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">&gt;</span> <span class="n">dma_pagesize</span><span class="p">)</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">=</span> <span class="n">dma_pagesize</span><span class="p">;</span>
	<span class="n">start_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now loop until we get a free buffer. Try to get smaller buffer if</span>
<span class="cm">	 * it fails. Don&#39;t accept smaller than 8k buffer for performance</span>
<span class="cm">	 * reasons.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">start_addr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">;</span> <span class="n">sz</span><span class="o">++</span><span class="p">,</span> <span class="n">size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sz</span><span class="p">);</span>
		<span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="o">|</span><span class="n">__GFP_NOWARN</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound error: Couldn&#39;t allocate DMA buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* make some checks */</span>
		<span class="n">end_addr</span> <span class="o">=</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debugmem</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;sound: start 0x%lx, end 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">start_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">end_addr</span><span class="p">);</span>
		
		<span class="cm">/* now check if it fits into the same dma-pagesize */</span>

		<span class="k">if</span> <span class="p">(((</span><span class="kt">long</span><span class="p">)</span> <span class="n">start_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">dma_pagesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">end_addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">dma_pagesize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		    <span class="o">||</span> <span class="n">end_addr</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">MAX_DMA_ADDRESS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sound: Got invalid address 0x%lx for %db DMA-buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">=</span> <span class="n">start_addr</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">start_addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">start_addr</span><span class="p">);</span> <span class="n">page</span> <span class="o">&lt;=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">end_addr</span><span class="p">);</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span>
		<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sound_free_dmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_addr</span><span class="p">,</span> <span class="n">end_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Don&#39;t free mmapped buffer. Will use it next time */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">;</span> <span class="n">sz</span><span class="o">++</span><span class="p">,</span> <span class="n">size</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">start_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">;</span>
	<span class="n">end_addr</span> <span class="o">=</span> <span class="n">start_addr</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">start_addr</span><span class="p">);</span> <span class="n">page</span> <span class="o">&lt;=</span> <span class="n">virt_to_page</span><span class="p">(</span><span class="n">end_addr</span><span class="p">);</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Intel version !!!!!!!!! */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* printk( &quot;Start DMA%d %d, %d\n&quot;,  chan,  (int)(physaddr-dmap-&gt;raw_buf_phys),  count); */</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">set_dma_mode</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">dma_mode</span><span class="p">);</span>
	<span class="n">set_dma_addr</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">physaddr</span><span class="p">);</span>
	<span class="n">set_dma_count</span><span class="p">(</span><span class="n">chan</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">enable_dma</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_init_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span> <span class="o">=</span> <span class="mi">8000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">;</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_NONE</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">cfrag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DMA_BUSY</span><span class="p">;</span>	<span class="cm">/* Other flags off */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_dmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_BUSY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">sound_alloc_dmap</span><span class="p">(</span><span class="n">dmap</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound: DMA buffers not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>	<span class="cm">/* Memory allocation failed during boot */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">sound_open_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unable to grab(2) DMA%d for the audio driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_init_buffers</span><span class="p">(</span><span class="n">dmap</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">underrun_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_fragments</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>	<span class="cm">/* Just a large value */</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span> <span class="o">=</span> <span class="mi">8000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">applic_profile</span> <span class="o">=</span> <span class="n">APF_NORMAL</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">audio_callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">callback_parm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_dmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sound_close_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">flags</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">disable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_BUSY</span><span class="p">)</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_NONE</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_BUSY</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">sound_dmap_flag</span> <span class="o">==</span> <span class="n">DMAP_FREE_ON_CLOSE</span><span class="p">)</span>
		<span class="n">sound_free_dmap</span><span class="p">(</span><span class="n">dmap</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">default_set_bits</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SNDCTL_DSP_SETFMT</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bits</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">default_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SNDCTL_DSP_SPEED</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">default_set_channels</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SNDCTL_DSP_CHANNELS</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_driver</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_speed</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">set_speed</span> <span class="o">=</span> <span class="n">default_set_speed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_bits</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">set_bits</span> <span class="o">=</span> <span class="n">default_set_bits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span> <span class="o">=</span> <span class="n">default_set_channels</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DMAbuf_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="p">)</span>
		  <span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">))</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="n">check_driver</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">dmap_out</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="n">dmap_in</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap_in</span> <span class="o">==</span> <span class="n">dmap_out</span><span class="p">)</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_DUPLEX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">open_dmap</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OPEN_WRITE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">open_dmap</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
				<span class="n">close_dmap</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DSP_DEFAULT_SPEED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_OUTPUT</span><span class="p">)</span> 
		<span class="n">memset</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span>
		       <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* MUST not hold the spinlock */</span>
<span class="kt">void</span> <span class="nf">DMAbuf_reset</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">dma_reset_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">dma_reset_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_reset_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span><span class="n">f</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_STARTED</span><span class="p">))</span>	<span class="cm">/* DMA is not active */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	First wait until the current fragment has been played completely</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_SYNCING</span><span class="p">;</span>

	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">underrun_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&amp;&amp;</span> 
	    <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">underrun_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">out_sleeper</span><span class="p">,</span>
					       <span class="n">dmabuf_timeout</span><span class="p">(</span><span class="n">dmap</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DMA_SYNCING</span> <span class="o">|</span> <span class="n">DMA_ACTIVE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Finally shut the device off</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">halt_output</span><span class="p">)</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">halt_io</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">halt_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_STARTED</span><span class="p">;</span>
	
	<span class="n">f</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
	<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">disable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_reset_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">halt_input</span><span class="p">)</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">halt_io</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">halt_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_STARTED</span><span class="p">;</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* MUST be called with holding the dmap-&gt;lock */</span>
<span class="kt">void</span> <span class="nf">DMAbuf_launch_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">*</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Don&#39;t start DMA yet */</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_OUTPUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NODMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_STARTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">prepare_for_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">))</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NODMA</span><span class="p">))</span>
				<span class="n">local_start_dma</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">,</span><span class="n">DMA_MODE_WRITE</span><span class="p">);</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_STARTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_OUTPUT</span><span class="p">;</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">output_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span>
				      <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">*</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DMAbuf_sync</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ACTIVE</span><span class="p">))</span>
			<span class="n">DMAbuf_launch_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_SYNCING</span><span class="p">;</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">underrun_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">nbufs</span> <span class="o">&amp;&amp;</span>
		       <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&amp;&amp;</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">underrun_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">dmabuf_timeout</span><span class="p">(</span><span class="n">dmap</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* FIXME: not safe may miss events */</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">out_sleeper</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_SYNCING</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DMA_SYNCING</span> <span class="o">|</span> <span class="n">DMA_ACTIVE</span><span class="p">);</span>
		
		<span class="cm">/*</span>
<span class="cm">		 * Some devices such as GUS have huge amount of on board RAM for the</span>
<span class="cm">		 * audio data. We have to wait until the device has finished playing.</span>
<span class="cm">		 */</span>

		<span class="cm">/* still holding the lock */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* Device has hidden buffers */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			       <span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">(</span><span class="n">dev</span><span class="p">)){</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">out_sleeper</span><span class="p">,</span>
							       <span class="n">dmabuf_timeout</span><span class="p">(</span><span class="n">dmap</span><span class="p">));</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DMAbuf_release</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">){</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_OUTPUT</span><span class="p">))</span>
				<span class="n">DMAbuf_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_OUTPUT</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>

	<span class="n">DMAbuf_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">close_dmap</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">!=</span> <span class="n">OPEN_WRITE</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)))</span>
		<span class="n">close_dmap</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">);</span>
	<span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* called with dmap-&gt;lock dold */</span>
<span class="kt">int</span> <span class="nf">DMAbuf_activate_recording</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">int</span>  <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Direction change */</span>
		<span class="cm">/* release lock - it&#39;s not recursive */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">DMAbuf_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">DMAbuf_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">prepare_for_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_INPUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span><span class="p">)</span>
			<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">local_start_dma</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span>
				     <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">*</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* acquires lock */</span>
<span class="kt">int</span> <span class="nf">DMAbuf_getrdbuffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dontblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">go</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span><span class="p">)</span>
		<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*		  printk(KERN_WARNING &quot;Sound: Can&#39;t read from mmapped device (1)\n&quot;);*/</span>
		  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		  <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">while</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">DMAbuf_activate_recording</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Wait for the next block */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dontblock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">go</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">))</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">dmabuf_timeout</span><span class="p">(</span><span class="n">dmap</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">in_sleeper</span><span class="p">,</span>
							 <span class="n">timeout</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIXME: include device name */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound: DMA (input) timed out - IRQ/DRQ config error?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dma_reset_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]];</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">-</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DMAbuf_rmchars</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buff_no</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cm">/*		  printk(&quot;Sound: Can&#39;t read from mmapped device (2)\n&quot;);*/</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* This buffer is completely empty */</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">--</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* MUST be called with dmap-&gt;lock hold */</span>
<span class="kt">int</span> <span class="nf">DMAbuf_get_buffer_pointer</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Try to approximate the active byte position of the DMA pointer within the</span>
<span class="cm">	 *	buffer area as well as possible.</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ACTIVE</span><span class="p">))</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
		
		<span class="n">f</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		
		<span class="n">pos</span> <span class="o">=</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		
		<span class="n">pos</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">-</span> <span class="n">pos</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">direction</span> <span class="o">==</span> <span class="n">DMODE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span>
						<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span>
						<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
			<span class="n">enable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
			
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* printk( &quot;%04x &quot;,  pos); */</span>

	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	DMAbuf_start_devices() is called by the /dev/music driver to start</span>
<span class="cm"> *	one or more audio devices at desired moment.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">DMAbuf_start_devices</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">devmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">num_audiodevs</span><span class="p">;</span> <span class="n">dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devmask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* OK to start the device */</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">*</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* via poll called without a lock ?*/</span>
<span class="kt">int</span> <span class="nf">DMAbuf_space_in_queue</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lim</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lim</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">lim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;=</span> <span class="n">lim</span><span class="p">)</span>	<span class="cm">/* No space at all */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Verify that there are no more pending buffers than the limit</span>
<span class="cm">	 *	defined by the process.</span>
<span class="cm">	 */</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_fragments</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">lim</span><span class="p">)</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">lim</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">tmp</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/* This buffer has been counted twice */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span>	<span class="cm">/* There is a partial fragment */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">max</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* MUST not hold the spinlock  - this function may sleep */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">output_sleep</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dontblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dontblock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for free space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NOTIMEOUT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> 
		<span class="n">timeout_value</span> <span class="o">=</span> <span class="n">dmabuf_timeout</span><span class="p">(</span><span class="n">dmap</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">timeout_value</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
	<span class="n">timeout_value</span> <span class="o">=</span> <span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">out_sleeper</span><span class="p">,</span>
						       <span class="n">timeout_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">!=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">timeout_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound: DMA (output) timed out - IRQ/DRQ config error?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dma_reset_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* called with the lock held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_output_space</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">active_offs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="n">offs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxfrags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">occupied_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">);</span>

	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">maxfrags</span> <span class="o">=</span> <span class="n">DMAbuf_space_in_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">occupied_bytes</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef BE_CONSERVATIVE</span>
	<span class="n">active_offs</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">active_offs</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">DMAbuf_get_buffer_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="n">DMODE_OUTPUT</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Check for pointer wrapping situation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active_offs</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span>
		<span class="n">active_offs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">active_offs</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">offs</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SAMPLE_ROUNDUP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">offs</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: Got unexpected offs %ld. Giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offs</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Counter = %ld, bytes=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">+</span> <span class="n">offs</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">active_offs</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">-</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span><span class="p">;</span>	<span class="cm">/* Number of unused bytes in buffer */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">offs</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">-</span> <span class="n">offs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">maxfrags</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">-</span> <span class="n">occupied_bytes</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxfrags</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">-</span> <span class="n">occupied_bytes</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SAMPLE_ROUNDUP</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* acquires lock  */</span>
<span class="kt">int</span> <span class="nf">DMAbuf_getwrbuffer</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dontblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/*		printk(KERN_DEBUG &quot;Sound: Can&#39;t write to mmapped device (3)\n&quot;);*/</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span><span class="p">)</span>
		<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_INPUT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Direction change */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">DMAbuf_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_OUTPUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">find_output_space</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">output_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dontblock</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* has to acquire dmap-&gt;lock */</span>
<span class="kt">int</span> <span class="nf">DMAbuf_move_wrpointer</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_ptr</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">post</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">post</span><span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_POST</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_POST</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">cfrag</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_DIRTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wrap the byte counters */</span>
		<span class="kt">long</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
		<span class="n">decr</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-=</span> <span class="n">decr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">end_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">[</span><span class="n">p</span><span class="p">];</span>

	<span class="cm">/* Update the fragment based bookkeeping too */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Let the low level driver perform some postprocessing to</span>
<span class="cm">	 *	the written data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">postprocess_write</span><span class="p">)</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">postprocess_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ACTIVE</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">post</span> <span class="o">||</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="n">DMAbuf_launch_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">DMAbuf_start_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMA_MODE_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span> <span class="o">:</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sound: DMA buffer(1) == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Device %d, chn=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">dmap</span> <span class="o">==</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sound_start_dma</span><span class="p">(</span><span class="n">dmap</span><span class="p">,</span> <span class="n">physaddr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">dma_mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">DMAbuf_start_dma</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">local_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">physaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMA_MODE_WRITE</span><span class="p">)</span> <span class="o">?</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span> <span class="o">:</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sound: DMA buffer(2) == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Device %s, chn=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">dmap</span> <span class="o">==</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;out&quot;</span> <span class="o">:</span> <span class="s">&quot;in&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NODMA</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sound_start_dma</span><span class="p">(</span><span class="n">dmap</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">,</span> <span class="n">dma_mode</span> <span class="o">|</span> <span class="n">DMA_AUTOINIT</span><span class="p">);</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_STARTED</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">finish_output_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">audio_callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">audio_callback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">callback_parm</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">out_sleeper</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">poll_sleeper</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* called with dmap-&gt;lock held in irq context*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_outputintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">this_fragment</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: Error. Audio interrupt (%d) after freeing buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Virtual memory mapped access */</span>
		<span class="cm">/* mmapped access */</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	    <span class="cm">/* Wrapped */</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Overflow */</span>
				<span class="kt">long</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
				<span class="n">decr</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-=</span> <span class="n">decr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Yes increment it (don&#39;t decrement) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">))</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_ACTIVE</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
		<span class="n">DMAbuf_launch_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>
		<span class="n">finish_output_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">--</span><span class="p">;</span>
	<span class="n">this_fragment</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Wrapped */</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Overflow */</span>
			<span class="kt">long</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
			<span class="n">decr</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-=</span> <span class="n">decr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">))</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_ACTIVE</span><span class="p">;</span>
		
	<span class="cm">/*</span>
<span class="cm">	 *	This is  dmap-&gt;qlen &lt;= 0 except when closing when</span>
<span class="cm">	 *	dmap-&gt;qlen &lt; 0</span>
<span class="cm">	 */</span>
	 
	<span class="k">while</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">closing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">underrun_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DIRTY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">applic_profile</span> <span class="o">!=</span> <span class="n">APF_CPUINTENS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_DIRTY</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span>
			       <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">DMAbuf_launch_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>
	<span class="n">finish_output_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* called in irq context */</span>
<span class="kt">void</span> <span class="nf">DMAbuf_outputintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">notify_only</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NODMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>
		
		<span class="n">f</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
		
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">-</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
			<span class="n">enable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
		
		<span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>	<span class="cm">/* Actual qhead */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">!=</span> <span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">)</span>
			<span class="n">do_outputintr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">notify_only</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">do_outputintr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">notify_only</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">DMAbuf_outputintr</span><span class="p">);</span>

<span class="cm">/* called with dmap-&gt;lock held in irq context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_inputintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: Fatal error. Audio interrupt after freeing buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Wrapped */</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Overflow */</span>
				<span class="kt">long</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
				<span class="n">decr</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-=</span> <span class="n">decr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span><span class="p">)</span>
				<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">local_start_dma</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">,</span><span class="n">DMA_MODE_READ</span><span class="p">);</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span>
					     <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
				<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">*</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound: Recording overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">underrun_count</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Just throw away the oldest fragment but keep the engine running */</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* Wrapped */</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Overflow */</span>
				<span class="kt">long</span> <span class="n">decr</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>
				<span class="n">decr</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-=</span> <span class="n">decr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NODMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local_start_dma</span><span class="p">(</span><span class="n">adev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">,</span> <span class="n">DMA_MODE_READ</span><span class="p">);</span>
		<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">start_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf_phys</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">*</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_ACTIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">in_sleeper</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">poll_sleeper</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* called in irq context */</span>
<span class="kt">void</span> <span class="nf">DMAbuf_inputintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_NODMA</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">f</span><span class="p">;</span>
		
		<span class="n">f</span><span class="o">=</span><span class="n">claim_dma_lock</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
			<span class="n">disable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">clear_dma_ff</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">-</span> <span class="n">get_dma_residue</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
			<span class="n">enable_dma</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">release_dma_lock</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>	<span class="cm">/* Actual qhead */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">)</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">!=</span> <span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">)</span>
			<span class="n">do_inputintr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">do_inputintr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">DMAbuf_inputintr</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">DMAbuf_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! This routine could be called several times.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adev</span> <span class="o">&amp;&amp;</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">d</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">panic</span><span class="p">(</span><span class="s">&quot;OSS: audio_devs[%d]-&gt;d == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">parent_dev</span><span class="p">)</span> <span class="p">{</span>	 <span class="cm">/* Use DMA map of the parent dev */</span>
			<span class="kt">int</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">parent_dev</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmaps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmaps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Persistent DMA buffers allocated here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sound_dmap_flag</span> <span class="o">==</span> <span class="n">DMAP_KEEP_ON_CLOSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">sound_alloc_dmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">sound_alloc_dmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* No kernel lock - DMAbuf_activate_recording protected by global cli/sti */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">poll_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">!=</span> <span class="n">DMODE_INPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_NONE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">adev</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&amp;&amp;</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">DMAbuf_activate_recording</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">poll_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_INPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">==</span> <span class="n">DMODE_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DMAbuf_space_in_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">DMAbuf_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">poll_sleeper</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">poll_input</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">wait</span><span class="p">)</span> <span class="o">|</span> <span class="n">poll_output</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">DMAbuf_deinit</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">adev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="cm">/* This routine is called when driver is being unloaded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Persistent DMA buffers deallocated here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sound_dmap_flag</span> <span class="o">==</span> <span class="n">DMAP_KEEP_ON_CLOSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sound_free_dmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span>
			<span class="n">sound_free_dmap</span><span class="p">(</span><span class="n">adev</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
