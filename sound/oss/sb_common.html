<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › sb_common.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sb_common.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sound/oss/sb_common.c</span>
<span class="cm"> *</span>
<span class="cm"> * Common routines for Sound Blaster compatible cards.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Daniel J. Rodriksson: Modified sbintr to handle 8 and 16 bit interrupts</span>
<span class="cm"> *                       for full duplex support ( only sb16 by now )</span>
<span class="cm"> * Rolf Fokkens:	 Added (BETA?) support for ES1887 chips.</span>
<span class="cm"> * (fokkensr@vertis.nl)	 Which means: You can adjust the recording levels.</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/01/18 - separated sb_card and sb_common -</span>
<span class="cm"> * Jeff Garzik &lt;jgarzik@pobox.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 2000/09/18 - got rid of attach_uart401</span>
<span class="cm"> * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/01/26 - replaced CLI/STI with spinlocks</span>
<span class="cm"> * Chris Rankin &lt;rankinc@zipworld.com.au&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;sound_config.h&quot;</span>
<span class="cp">#include &quot;sound_firmware.h&quot;</span>

<span class="cp">#include &quot;mpu401.h&quot;</span>

<span class="cp">#include &quot;sb_mixer.h&quot;</span>
<span class="cp">#include &quot;sb.h&quot;</span>
<span class="cp">#include &quot;sb_ess.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * global module flag</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">sb_be_quiet</span><span class="p">;</span>

<span class="k">static</span> <span class="n">sb_devc</span> <span class="o">*</span><span class="n">detected_devc</span><span class="p">;</span>	<span class="cm">/* For communication from probe to init */</span>
<span class="k">static</span> <span class="n">sb_devc</span> <span class="o">*</span><span class="n">last_devc</span><span class="p">;</span>	<span class="cm">/* For MPU401 initialization */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">jazz_irq_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">jazz_dma_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">smw_free</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Jazz16 chipset specific control variables</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">jazz16_base</span><span class="p">;</span>			<span class="cm">/* Not detected */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">jazz16_bits</span><span class="p">;</span>	<span class="cm">/* I/O relocation bits */</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">jazz16_lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Logitech Soundman Wave specific initialization code</span>
<span class="cm"> */</span>

<span class="cp">#ifdef SMW_MIDI0001_INCLUDED</span>
<span class="cp">#include &quot;smw-midi0001.h&quot;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">smw_ucode</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">smw_ucodeLen</span><span class="p">;</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">sb_devc</span> <span class="o">*</span><span class="n">last_sb</span><span class="p">;</span>		<span class="cm">/* Last sb loaded */</span>

<span class="kt">int</span> <span class="nf">sb_dsp_command</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* Timeout */</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Note! the i&lt;500000 is an emergency exit. The sb_dsp_command() is sometimes</span>
<span class="cm">	 * called while interrupts are disabled. This means that the timer is</span>
<span class="cm">	 * disabled also. However the timeout situation is a abnormal condition.</span>
<span class="cm">	 * Normally the DSP should be ready to accept commands after just couple of</span>
<span class="cm">	 * loops.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">500000</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">limit</span><span class="o">-</span><span class="n">jiffies</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">outb</span><span class="p">((</span><span class="n">val</span><span class="p">),</span> <span class="n">DSP_COMMAND</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound Blaster:  DSP command(%x) timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sb_dsp_get_byte</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb_intr</span> <span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">src</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SB16</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">IRQ_STAT</span><span class="p">);</span>	<span class="cm">/* Interrupt source register */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span>						<span class="cm">/* MPU401 interrupt */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">midi_irq_cookie</span><span class="p">)</span>
				<span class="n">uart401intr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">midi_irq_cookie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>	<span class="cm">/* Not a DSP interrupt */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">fullduplex</span> <span class="o">||</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
				<span class="n">DMAbuf_outputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
				<span class="n">DMAbuf_inputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_INIT</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_MIDI</span>:
				<span class="n">sb_midi_interrupt</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="cm">/* printk(KERN_WARNING &quot;Sound Blaster: Unexpected interrupt\n&quot;); */</span>
				<span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active_16</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_mode_16</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">IMODE_OUTPUT</span>:
				<span class="n">DMAbuf_outputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_INPUT</span>:
				<span class="n">DMAbuf_inputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">IMODE_INIT</span>:
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="cm">/* printk(KERN_WARNING &quot;Sound Blaster: Unexpected interrupt\n&quot;); */</span>
				<span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Acknowledge interrupts </span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SB16</span> <span class="o">&amp;&amp;</span> <span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVL16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_intr</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">pcibase</span><span class="o">+</span><span class="mh">0x1A</span><span class="p">);</span>
	<span class="n">src</span><span class="o">&amp;=</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
		<span class="n">sb_intr</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sbintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MDL_ESSPCI</span>:
		<span class="n">pci_intr</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		
	<span class="k">case</span> <span class="n">MDL_ESS</span>:
		<span class="n">ess_intr</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">sb_intr</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sb_dsp_reset</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loopc</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Entered sb_dsp_reset()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ess_dsp_reset</span> <span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="cm">/* This is only for non-ESS chips */</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">DSP_RESET</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DSP_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loopc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loopc</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span> <span class="n">loopc</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sb: No response to RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Sorry */</span>
	<span class="p">}</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sb_dsp_reset() OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dsp_get_vers</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Entered dsp_get_vers()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">);</span>	<span class="cm">/* Get version */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">DSP_READ</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;DSP version %d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb16_set_dma_hw</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SB16: Invalid 8 bit DMA (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">);</span>

	<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">DMA_NR</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sb16_set_mpu_port</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This routine initializes new MIDI port setup register of SB Vibra (CT2502).</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bits</span> <span class="o">=</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x06</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x300</span>:
			<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">bits</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x330</span>:
			<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">bits</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">bits</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">);</span>		<span class="cm">/* Disable MPU */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SB16: Invalid MIDI I/O port %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb16_set_irq_hw</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ival</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">level</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">ival</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">ival</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
			<span class="n">ival</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="n">ival</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SB16: Invalid IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">IRQ_NR</span><span class="p">,</span> <span class="n">ival</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">relocate_Jazz16</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jazz16_base</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">jazz16_base</span> <span class="o">!=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x220</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x240</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x260</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">jazz16_bits</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">jazz16_base</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Magic wake up sequence by writing to 0x201 (aka Joystick port)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0xAF</span><span class="p">),</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x50</span><span class="p">),</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">bits</span><span class="p">),</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_Jazz16</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * First try to check that the card has Jazz16 chip. It identifies itself</span>
<span class="cm">	 * by returning 0x12 as response to DSP command 0xfa.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xfa</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_get_byte</span><span class="p">(</span><span class="n">devc</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x12</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * OK so far. Now configure the IRQ and DMA channel used by the card.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">jazz_irq_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Jazz16: Invalid interrupt (IRQ%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">jazz_dma_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Jazz16: Invalid 8 bit DMA (DMA%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Jazz16: No 16 bit DMA channel defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">jazz_dma_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Jazz16: Invalid 16 bit DMA (DMA%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">jazz_dma_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">]</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">jazz_dma_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">jazz_irq_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we have configured a standard Jazz16 device. </span>
<span class="cm">	 */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_JAZZ</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Jazz16&quot;</span><span class="p">);</span>

	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Jazz16&quot;</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">SB_NO_MIDI</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">relocate_ess1688</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x220</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x230</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x240</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x250</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span><span class="p">;</span>	<span class="cm">/* Wrong port */</span>
	<span class="p">}</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Doing ESS1688 address selection</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * ES1688 supports two alternative ways for software address config.</span>
<span class="cm">	 * First try the so called Read-Sequence-Key method.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Reset the sequence logic */</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>

	<span class="cm">/* Perform the read sequence */</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x22b</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x22b</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x22b</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="mh">0x229</span><span class="p">);</span>

	<span class="cm">/* Select the base address by reading from it. Then probe using the port. */</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">))</span>	<span class="cm">/* Bingo */</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c">				/* This causes system lockups (Nokia 386/25 at least) */</span>
<span class="c">	/*</span>
<span class="c">	 * The last resort is the system control register method.</span>
<span class="c">	 */</span>

<span class="c">	outb((0x00), 0xfb);	/* 0xFB is the unlock register */</span>
<span class="c">	outb((0x00), 0xe0);	/* Select index 0 */</span>
<span class="c">	outb((bits), 0xe1);	/* Write the config bits */</span>
<span class="c">	outb((0x00), 0xf9);	/* 0xFB is the lock register */</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sb_dsp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pciio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sb_module_options</span> <span class="o">*</span><span class="n">sbmo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="n">sb_info</span><span class="p">;</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sb_info</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">sb_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb_info</span><span class="p">));</span>	<span class="cm">/* Zero everything */</span>

	<span class="cm">/* Copy module options in place */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sbmo</span><span class="p">)</span> <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">,</span> <span class="n">sbmo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sb_module_options</span><span class="p">));</span>

	<span class="n">sb_info</span><span class="p">.</span><span class="n">my_mididev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sb_info</span><span class="p">.</span><span class="n">my_mixerdev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sb_info</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize variables </span>
<span class="cm">	 */</span>
	
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sb_dsp_detect(%x) entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">pcibase</span> <span class="o">=</span> <span class="n">pciio</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">pci</span> <span class="o">==</span> <span class="n">SB_PCI_ESSMAESTRO</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_ESSPCI</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">SB_PCI_IRQ</span><span class="p">;</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">driver_use_1</span> <span class="o">|=</span> <span class="n">SB_PCI_IRQ</span><span class="p">;</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span>	<span class="o">=</span> <span class="n">MDL_ESSPCI</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">pci</span> <span class="o">==</span> <span class="n">SB_PCI_YAMAHA</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_YMPCI</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">SB_PCI_IRQ</span><span class="p">;</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">driver_use_1</span> <span class="o">|=</span> <span class="n">SB_PCI_IRQ</span><span class="p">;</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span>	<span class="o">=</span> <span class="n">MDL_YMPCI</span><span class="p">;</span>
		
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Yamaha PCI mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">sbmo</span><span class="p">.</span><span class="n">acer</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0b</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0b</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x0b</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Detect the device</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">))</span>
		<span class="n">dsp_get_vers</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_JAZZ</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_SMW</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">relocate_Jazz16</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_ESS</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">relocate_ess1688</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SB reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="cp">#ifdef MODULE</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sb: dsp reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dsp_get_vers</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_AZTECH</span><span class="p">)</span>		<span class="cm">/* SG Washington? */</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>	<span class="cm">/* Enter WSS mode */</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

					<span class="cm">/* Have some delay */</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="n">inb</span><span class="p">(</span><span class="n">DSP_DATA_AVAIL</span><span class="p">);</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">SB_NO_AUDIO</span> <span class="o">|</span> <span class="n">SB_NO_MIDI</span><span class="p">;</span>	<span class="cm">/* Mixer only */</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_AZTECH</span><span class="p">;</span>
				<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_ESSPCI</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_ESSPCI</span><span class="p">;</span>
		
	<span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_YMPCI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;YMPCI selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_YMPCI</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="cm">/*</span>
<span class="cm">	 * Save device information for sb_dsp_init()</span>
<span class="cm">	 */</span>


	<span class="n">detected_devc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">sb_devc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">detected_devc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sb: Can&#39;t allocate memory for device information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">detected_devc</span><span class="p">,</span> <span class="n">devc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sb_devc</span><span class="p">));</span>
	<span class="n">MDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SB %d.%02d detected OK (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sb_dsp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="k">extern</span> <span class="kt">int</span> <span class="n">sb_be_quiet</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">mixer22</span><span class="p">,</span> <span class="n">mixer30</span><span class="p">;</span>
	
<span class="cm">/*</span>
<span class="cm"> * Check if we had detected a SB device earlier</span>
<span class="cm"> */</span>
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sb_dsp_init(%x) entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
	<span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">detected_devc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">MDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;No detected device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devc</span> <span class="o">=</span> <span class="n">detected_devc</span><span class="p">;</span>
	<span class="n">detected_devc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">!=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;I/O port mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now continue initialization of the device</span>
<span class="cm">	 */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">driver_use_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_AUDIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_MIDI</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>			<span class="cm">/* IRQ setup */</span>
		
		<span class="cm">/*</span>
<span class="cm">		 *	ESS PCI cards do shared PCI IRQ stuff. Since they</span>
<span class="cm">		 *	will get shared PCI irq lines we must cope.</span>
<span class="cm">		 */</span>
		 
		<span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span><span class="o">&amp;</span><span class="n">SB_PCI_IRQ</span><span class="p">)</span><span class="o">?</span><span class="n">IRQF_SHARED</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sbintr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s">&quot;soundblaster&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SB: Can&#39;t allocate IRQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb16_set_irq_hw</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">))</span>	<span class="cm">/* Unsupported IRQ */</span>
			<span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="p">);</span>
				<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>		<span class="cm">/* Handle various chipsets which claim they are SB Pro compatible */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">ess_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MDL_JAZZ</span> <span class="o">&amp;&amp;</span>
					 <span class="n">devc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">MDL_SMW</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">init_Jazz16</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;This is a genuine SB Pro</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">11</span> <span class="p">)</span>	<span class="cm">/* Won&#39;t work */</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">))</span>	<span class="cm">/* Cause interrupt immediately */</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sb: Interrupt test on IRQ%d failed - Probable IRQ conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IRQ test OK (IRQ%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>			<span class="cm">/* IRQ setup */</span>

	<span class="n">last_sb</span> <span class="o">=</span> <span class="n">devc</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* SB 1.0 or 1.5 */</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">MDL_SB1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">2</span>:		<span class="cm">/* SB 2.x */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">MDL_SB2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">MDL_SB201</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">3</span>:		<span class="cm">/* SB Pro and most clones */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">MDL_SBPRO</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sound Blaster Pro (8 BIT ONLY)&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MDL_ESS</span>:
				<span class="n">ess_dsp_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">MDL_SB16</span><span class="p">;</span>
			<span class="cm">/* </span>
<span class="cm">			 * ALS007 and ALS100 return DSP version 4.2 and have 2 post-reset !=0</span>
<span class="cm">			 * registers at 0x3c and 0x4c (output ctrl registers on ALS007) whereas</span>
<span class="cm">			 * a &quot;standard&quot; SB16 doesn&#39;t have a register at 0x4c.  ALS100 actively</span>
<span class="cm">			 * updates register 0x22 whenever 0x30 changes, as per the SB16 spec.</span>
<span class="cm">			 * Since ALS007 doesn&#39;t, this can be used to differentiate the 2 cards.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x4c</span><span class="p">))</span> 
			<span class="p">{</span>
				<span class="n">mixer30</span> <span class="o">=</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x30</span><span class="p">);</span>
				<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,(</span><span class="n">mixer22</span><span class="o">=</span><span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x22</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
				<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="mh">0xff</span><span class="p">);</span>
				<span class="cm">/* ALS100 will force 0x30 to 0xf8 like SB16; ALS007 will allow 0xff. */</span>
				<span class="cm">/* Register 0x22 &amp; 0xf0 on ALS100 == 0xf0; on ALS007 it == 0x10.     */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">))</span> 
				<span class="p">{</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ALS100</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sound Blaster 16 (ALS-100)&quot;</span><span class="p">;</span>
        			<span class="p">}</span>
        			<span class="k">else</span>
        			<span class="p">{</span>
        				<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x3c</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">);</span>    <span class="cm">/* Enable all inputs */</span>
					<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x4c</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">);</span>
					<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x22</span><span class="p">,</span><span class="n">mixer22</span><span class="p">);</span> <span class="cm">/* Restore 0x22 to original value */</span>
					<span class="n">devc</span><span class="o">-&gt;</span><span class="n">submodel</span> <span class="o">=</span> <span class="n">SUBMDL_ALS007</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sound Blaster 16 (ALS-007)&quot;</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span><span class="mh">0x30</span><span class="p">,</span><span class="n">mixer30</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sound Blaster 16&quot;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>  <span class="s">&quot;SB16: Bad or missing 16 bit DMA channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">sb16_set_dma_hw</span><span class="p">(</span><span class="n">devc</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="p">);</span>
			        <span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">SB_NO_MIDI</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_MIXER</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">sb_mixer_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_MIDI</span><span class="p">))</span>
		<span class="n">sb_dsp_midi_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sound Blaster (8 BIT/MONO ONLY)&quot;</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s (%d.%02d)&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">conf_printf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assuming that a sound card is Sound Blaster (compatible) is the most common</span>
<span class="cm">	 * configuration error and the mother of all problems. Usually sound cards</span>
<span class="cm">	 * emulate SB Pro but in addition they have a 16 bit native mode which should be</span>
<span class="cm">	 * used in Unix. See Readme.cards for more information about configuring OSS/Free</span>
<span class="cm">	 * properly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&lt;=</span> <span class="n">MDL_SBPRO</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* &quot;True&quot; SB Pro should have v3.1 (rare ones may have 3.2). */</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;This sound card may not be fully Sound Blaster Pro compatible.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;In many cases there is another way to configure OSS so that</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;it works properly with OSS (for example in 16 bit mode).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Please ignore this message if you _really_ have a SB Pro.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_be_quiet</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SBPRO</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SB DSP version is just %d.%02d which means that your card is</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;several years old (8 bit only device) or alternatively the sound driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;is incorrectly configured.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">;</span>
	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">last_devc</span> <span class="o">=</span> <span class="n">devc</span><span class="p">;</span>	<span class="cm">/* For SB MPU detection */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_AUDIO</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">,</span> <span class="s">&quot;SoundBlaster8&quot;</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound Blaster: Can&#39;t allocate 8 bit DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">,</span> <span class="s">&quot;SoundBlaster16&quot;</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound Blaster:  can&#39;t allocate 16 bit DMA channel %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sb_audio_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">MDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sound Blaster:  no audio devices found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* if (sbmpu) below we allow mpu401 to manage the midi devs</span>
<span class="cm">   otherwise we have to unload them. (Andrzej Krzysztofowicz) */</span>
   
<span class="kt">void</span> <span class="nf">sb_dsp_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sbmpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">devc</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&amp;</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">pcibase</span><span class="p">)</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">pcibase</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_AUDIO</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_AUDIO</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">SB_NO_MIDI</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="p">);</span>

			<span class="n">sb_mixer_unload</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
			<span class="cm">/* We don&#39;t have to do this bit any more the UART401 is its own</span>
<span class="cm">				master  -- Krzysztof Halasa */</span>
			<span class="cm">/* But we have to do it, if UART401 is not detected */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sbmpu</span><span class="p">)</span>
				<span class="n">sound_unload_mididev</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">my_mididev</span><span class="p">);</span>
			<span class="n">sound_unload_audiodev</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">detected_devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Mixer access routines</span>
<span class="cm"> *</span>
<span class="cm"> *	ES1887 modifications: some mixer registers reside in the</span>
<span class="cm"> *	range above 0xa0. These must be accessed in another way.</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">sb_setmixer</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ess_setmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_ADDR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_DATA</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sb_getmixer</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_ESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ess_getmixer</span> <span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">port</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">MIXER_ADDR</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">MIXER_DATA</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sb_chgmixer</span>
	<span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	MPU401 MIDI initialization.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smw_putmem</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>  <span class="cm">/* NOT the SB card? */</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Low address bits */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* High address bits */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">val</span><span class="p">),</span> <span class="n">base</span><span class="p">);</span>	<span class="cm">/* Data */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">smw_getmem</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>  <span class="cm">/* NOT the SB card? */</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>	<span class="cm">/* Low address bits */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* High address bits */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>	<span class="cm">/* Data */</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smw_midi_init</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpu_base</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mp_base</span> <span class="o">=</span> <span class="n">mpu_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>		<span class="cm">/* Microcontroller base */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">control</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 *  Reset the microcontroller so that the RAM can be accessed</span>
<span class="cm">	 */</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">mpu_base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">control</span> <span class="o">|</span> <span class="mi">3</span><span class="p">),</span> <span class="n">mpu_base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* Set last two bits to 1 (?) */</span>
	<span class="n">outb</span><span class="p">(((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mpu_base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* xxxxxxx0 resets the mc */</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>	<span class="cm">/* Wait at least 1ms */</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">control</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">),</span> <span class="n">mpu_base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* xxxxxx00 enables RAM */</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Detect microcontroller by probing the 8k RAM area</span>
<span class="cm">	 */</span>
	<span class="n">smw_putmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">smw_putmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smw_getmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="o">||</span> <span class="n">smw_getmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;SM Wave: No microcontroller RAM detected (%02x, %02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">smw_getmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">smw_getmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No RAM */</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  There is RAM so assume it&#39;s really a SM Wave</span>
<span class="cm">	 */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MDL_SMW</span><span class="p">;</span>
	<span class="n">smw_mixer_init</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smw_ucode</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">smw_ucodeLen</span> <span class="o">=</span> <span class="n">mod_firmware_load</span><span class="p">(</span><span class="s">&quot;/etc/sound/midi0001.bin&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">smw_ucode</span><span class="p">);</span>
		<span class="n">smw_free</span> <span class="o">=</span> <span class="n">smw_ucode</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smw_ucodeLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smw_ucodeLen</span> <span class="o">!=</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SM Wave: Invalid microcode (MIDI0001.BIN) length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Download microcode</span>
<span class="cm">		 */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">smw_putmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">smw_ucode</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="cm">/*</span>
<span class="cm">		 *  Verify microcode</span>
<span class="cm">		 */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8192</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">smw_getmem</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">mp_base</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">smw_ucode</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SM Wave: Microcode verification failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SMW_SCSI_IRQ</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the SCSI interrupt (IRQ2/9, IRQ3 or IRQ10). The SCSI interrupt</span>
<span class="cm">	 * is disabled by default.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME - make this a module option</span>
<span class="cm">	 *</span>
<span class="cm">	 * BTW the Zilog 5380 SCSI controller is located at MPU base + 0x10.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scsi_irq_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">};</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">scsi_irq_bits</span><span class="p">[</span><span class="n">SMW_SCSI_IRQ</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SMW_OPL4_ENABLE</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Make the OPL4 chip visible on the PC bus at 0x380.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  There is no need to enable this feature since this driver</span>
<span class="cm">	 *  doesn&#39;t support OPL4 yet. Also there is no RAM in SM Wave so</span>
<span class="cm">	 *  enabling OPL4 is pretty useless.</span>
<span class="cm">	 */</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>	<span class="cm">/* Uses IRQ12 if bit 0x20 == 0 */</span>
	<span class="cm">/* control |= 0x20;      Uncomment this if you want to use IRQ7 */</span>
<span class="cp">#endif</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">control</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">),</span> <span class="n">mpu_base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* xxxxxx11 restarts */</span>
	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SoundMan Wave&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_Jazz16_midi</span><span class="p">(</span><span class="n">sb_devc</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mpu_base</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb_base</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">irq</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span>
	    <span class="n">jazz_irq_bits</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Jazz16: Invalid MIDI interrupt (IRQ%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sb_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x220</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x240</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x260</span>:
			<span class="n">bits</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bits</span> <span class="o">=</span> <span class="n">jazz16_bits</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mpu_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x310</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x320</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x330</span>:
			<span class="n">bits</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Jazz16: Invalid MIDI I/O port %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpu_base</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *	Magic wake up sequence by writing to 0x201 (aka Joystick port)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xAF</span><span class="p">,</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">jazz16_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Jazz16&quot;</span><span class="p">;</span>
	<span class="n">smw_midi_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">jazz_dma_bits</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma8</span><span class="p">]</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">jazz_dma_bits</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sb_dsp_command</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">jazz_irq_bits</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">]</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">jazz_irq_bits</span><span class="p">[</span><span class="n">irq</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">probe_sbmpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sb_devc</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">last_devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last_devc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">last_devc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* The real vibra16 is fine about this, but we have to go</span>
<span class="cm">		   wipe up after Cyrix again */</span>
		   	   
		<span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_SB16</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bits</span> <span class="o">=</span> <span class="n">sb_getmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x06</span><span class="p">;</span>
			<span class="n">sb_setmixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="n">bits</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">);</span>		<span class="cm">/* Disable MPU */</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if defined(CONFIG_SOUND_MPU401)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MDL_ESS</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ports</span><span class="p">;</span>
		<span class="n">ports</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mpu401&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ports</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sbmpu: I/O port conflict (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ess_midi_init</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ESS1xxx MPU&quot;</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">midi_irq_cookie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_mpu401</span><span class="p">(</span><span class="n">hw_config</span><span class="p">,</span> <span class="n">ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">attach_mpu401</span><span class="p">(</span><span class="n">hw_config</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_sb</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">last_sb</span><span class="o">-&gt;</span><span class="n">midi_irq_cookie</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MDL_SB16</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">!=</span> <span class="mh">0x300</span> <span class="o">&amp;&amp;</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">!=</span> <span class="mh">0x330</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SB16: Invalid MIDI port %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sound Blaster 16&quot;</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
				<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">minor</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span>		<span class="cm">/* What is Vibra&#39;s version??? */</span>
				<span class="n">sb16_set_mpu_port</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_JAZZ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
				<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_Jazz16_midi</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MDL_YMPCI</span>:
			<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Yamaha PCI Legacy&quot;</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Yamaha PCI legacy UART401 check.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">ret</span> <span class="o">=</span> <span class="n">probe_uart401</span><span class="p">(</span><span class="n">hw_config</span><span class="p">,</span> <span class="n">owner</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">last_sb</span><span class="o">-&gt;</span><span class="n">midi_irq_cookie</span><span class="o">=</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unload_sbmpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_SOUND_MPU401)</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ESS1xxx MPU&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unload_mpu401</span><span class="p">(</span><span class="n">hw_config</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">unload_uart401</span><span class="p">(</span><span class="n">hw_config</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sb_dsp_init</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sb_dsp_detect</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sb_dsp_unload</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sb_be_quiet</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">probe_sbmpu</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unload_sbmpu</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">smw_free</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
