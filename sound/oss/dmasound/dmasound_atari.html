<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › dmasound › dmasound_atari.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dmasound_atari.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/sound/oss/dmasound/dmasound_atari.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Atari TT and Falcon DMA Sound Driver</span>
<span class="cm"> *</span>
<span class="cm"> *  See linux/sound/oss/dmasound/dmasound_core.c for copyright and credits</span>
<span class="cm"> *  prior to 28/01/2001</span>
<span class="cm"> *</span>
<span class="cm"> *  28/01/2001 [0.1] Iain Sandoe</span>
<span class="cm"> *		     - added versioning</span>
<span class="cm"> *		     - put in and populated the hardware_afmts field.</span>
<span class="cm"> *             [0.2] - put in SNDCTL_DSP_GETCAPS value.</span>
<span class="cm"> *  01/02/2001 [0.3] - put in default hard/soft settings.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/soundcard.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/atariints.h&gt;</span>
<span class="cp">#include &lt;asm/atari_stram.h&gt;</span>

<span class="cp">#include &quot;dmasound.h&quot;</span>

<span class="cp">#define DMASOUND_ATARI_REVISION 0</span>
<span class="cp">#define DMASOUND_ATARI_EDITION 3</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">is_falcon</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_sq_ignore_int</span><span class="p">;</span>	<span class="cm">/* ++TeSche: used for Falcon */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">expand_bal</span><span class="p">;</span>	<span class="cm">/* Balance factor for expanding (not volume!) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">expand_data</span><span class="p">;</span>	<span class="cm">/* Data for expanding */</span>


<span class="cm">/*** Translations ************************************************************/</span>


<span class="cm">/* ++TeSche: radically changed for new expanding purposes...</span>
<span class="cm"> *</span>
<span class="cm"> * These two routines now deal with copying/expanding/translating the samples</span>
<span class="cm"> * from user space into our buffer at the right frequency. They take care about</span>
<span class="cm"> * how much data there&#39;s actually to read, how much buffer space there is and</span>
<span class="cm"> * to convert samples into the right frequency/encoding. They will only work on</span>
<span class="cm"> * complete samples so it may happen they leave some bytes in the input stream</span>
<span class="cm"> * if the user didn&#39;t write a multiple of the current sample size. They both</span>
<span class="cm"> * return the number of bytes they&#39;ve used from both streams so you may detect</span>
<span class="cm"> * such a situation. Luckily all programs should be able to cope with that.</span>
<span class="cm"> *</span>
<span class="cm"> * I think I&#39;ve optimized anything as far as one can do in plain C, all</span>
<span class="cm"> * variables should fit in registers and the loops are really short. There&#39;s</span>
<span class="cm"> * one loop for every possible situation. Writing a more generalized and thus</span>
<span class="cm"> * parameterized loop would only produce slower code. Feel free to optimize</span>
<span class="cm"> * this in assembler if you like. :)</span>
<span class="cm"> *</span>
<span class="cm"> * I think these routines belong here because they&#39;re not yet really hardware</span>
<span class="cm"> * independent, especially the fact that the Falcon can play 16bit samples</span>
<span class="cm"> * only in stereo is hardcoded in both of them!</span>
<span class="cm"> *</span>
<span class="cm"> * ++geert: split in even more functions (one per format)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_law</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			  <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			  <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_s8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			 <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			 <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_u8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			 <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			 <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_s16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_u16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_s16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ct_u16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_law</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			   <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			   <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_s8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			  <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			  <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_u8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			  <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			  <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_s16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_u16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_s16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">ata_ctx_u16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">);</span>


<span class="cm">/*** Low level stuff *********************************************************/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">AtaAlloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AtaFree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AtaIrqInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AtaIrqCleanUp</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AtaSetBass</span><span class="p">(</span><span class="kt">int</span> <span class="n">bass</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AtaSetTreble</span><span class="p">(</span><span class="kt">int</span> <span class="n">treble</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">TTSilence</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">TTInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TTSetFormat</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TTSetVolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TTSetGain</span><span class="p">(</span><span class="kt">int</span> <span class="n">gain</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FalconSilence</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FalconInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">FalconSetFormat</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">FalconSetVolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AtaPlayNextFrame</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AtaPlay</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">AtaInterrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">);</span>

<span class="cm">/*** Mid level stuff *********************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">TTMixerInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">FalconMixerInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AtaMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TTMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">FalconMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AtaWriteSqSetup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AtaSqOpen</span><span class="p">(</span><span class="n">fmode_t</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">TTStateInfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">space</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">FalconStateInfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">space</span><span class="p">);</span>


<span class="cm">/*** Translations ************************************************************/</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_law</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			  <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			  <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">AFMT_MU_LAW</span> <span class="o">?</span> <span class="n">dmasound_ulaw2dma8</span>
							  <span class="o">:</span> <span class="n">dmasound_alaw2dma8</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">data</span><span class="p">];</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_s8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			 <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			 <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">userPtr</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_u8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			 <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			 <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">);</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_char</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span> <span class="o">^</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span> <span class="o">^</span> <span class="mh">0x8080</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_s16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">userPtr</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_u16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_int</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span> <span class="o">^</span> <span class="mh">0x80008000</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_s16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_long</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16dbl</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ct_u16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			    <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			    <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_short</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_long</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16dbl</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x80008000</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_law</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			   <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			   <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">AFMT_MU_LAW</span> <span class="o">?</span> <span class="n">dmasound_ulaw2dma8</span>
							  <span class="o">:</span> <span class="n">dmasound_alaw2dma8</span><span class="p">;</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_char</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_char</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">userCount</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
				<span class="n">userCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span><span class="o">--</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u_char</span> <span class="n">c</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">table</span><span class="p">[</span><span class="n">c</span><span class="p">];</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_s8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			  <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			  <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_char</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">userCount</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span><span class="o">--</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_u8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			  <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			  <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_char</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">userCount</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">^=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">userCount</span><span class="o">--</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span><span class="o">--</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">^=</span> <span class="mh">0x8080</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_s16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_long</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_u16be</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">^=</span> <span class="mh">0x8000</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_long</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">^=</span> <span class="mh">0x80008000</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_s16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_long</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16dbl</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ata_ctx_u16le</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			     <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span>
			     <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* this should help gcc to stuff everything into registers */</span>
	<span class="kt">long</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">expand_bal</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">hSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">sSpeed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">used</span><span class="p">,</span> <span class="n">usedf</span><span class="p">;</span>

	<span class="n">used</span> <span class="o">=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="n">usedf</span> <span class="o">=</span> <span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u_short</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x8000</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_long</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">u_long</span> <span class="n">data</span> <span class="o">=</span> <span class="n">expand_data</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frameLeft</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">userCount</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">u_int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">userPtr</span><span class="p">))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="n">userPtr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">le2be16dbl</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x80008000</span><span class="p">;</span>
				<span class="n">userCount</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">bal</span> <span class="o">+=</span> <span class="n">hSpeed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">frameLeft</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">bal</span> <span class="o">-=</span> <span class="n">sSpeed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">expand_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expand_bal</span> <span class="o">=</span> <span class="n">bal</span><span class="p">;</span>
	<span class="n">used</span> <span class="o">-=</span> <span class="n">userCount</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">usedf</span><span class="o">-</span><span class="n">frameLeft</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">TRANS</span> <span class="n">transTTNormal</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_ulaw</span>	<span class="o">=</span> <span class="n">ata_ct_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_alaw</span>	<span class="o">=</span> <span class="n">ata_ct_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s8</span>		<span class="o">=</span> <span class="n">ata_ct_s8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u8</span>		<span class="o">=</span> <span class="n">ata_ct_u8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">TRANS</span> <span class="n">transTTExpanding</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_ulaw</span>	<span class="o">=</span> <span class="n">ata_ctx_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_alaw</span>	<span class="o">=</span> <span class="n">ata_ctx_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s8</span>		<span class="o">=</span> <span class="n">ata_ctx_s8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u8</span>		<span class="o">=</span> <span class="n">ata_ctx_u8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">TRANS</span> <span class="n">transFalconNormal</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_ulaw</span>	<span class="o">=</span> <span class="n">ata_ct_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_alaw</span>	<span class="o">=</span> <span class="n">ata_ct_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s8</span>		<span class="o">=</span> <span class="n">ata_ct_s8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u8</span>		<span class="o">=</span> <span class="n">ata_ct_u8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s16be</span>	<span class="o">=</span> <span class="n">ata_ct_s16be</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u16be</span>	<span class="o">=</span> <span class="n">ata_ct_u16be</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s16le</span>	<span class="o">=</span> <span class="n">ata_ct_s16le</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u16le</span>	<span class="o">=</span> <span class="n">ata_ct_u16le</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">TRANS</span> <span class="n">transFalconExpanding</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_ulaw</span>	<span class="o">=</span> <span class="n">ata_ctx_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_alaw</span>	<span class="o">=</span> <span class="n">ata_ctx_law</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s8</span>		<span class="o">=</span> <span class="n">ata_ctx_s8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u8</span>		<span class="o">=</span> <span class="n">ata_ctx_u8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s16be</span>	<span class="o">=</span> <span class="n">ata_ctx_s16be</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u16be</span>	<span class="o">=</span> <span class="n">ata_ctx_u16be</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s16le</span>	<span class="o">=</span> <span class="n">ata_ctx_s16le</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u16le</span>	<span class="o">=</span> <span class="n">ata_ctx_u16le</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*** Low level stuff *********************************************************/</span>



<span class="cm">/*</span>
<span class="cm"> * Atari (TT/Falcon)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">AtaAlloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atari_stram_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;dmasound&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">AtaFree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atari_stram_free</span><span class="p">(</span> <span class="n">obj</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">AtaIrqInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set up timer A. Timer A</span>
<span class="cm">	   will receive a signal upon end of playing from the sound</span>
<span class="cm">	   hardware. Furthermore Timer A is able to count events</span>
<span class="cm">	   and will cause an interrupt after a programmed number</span>
<span class="cm">	   of events. So all we need to keep the music playing is</span>
<span class="cm">	   to provide the sound hardware with new data upon</span>
<span class="cm">	   an interrupt from timer A. */</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* ++roman: Stop timer before programming! */</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_dt_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Cause interrupt after first event. */</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_a</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* Turn on event counting. */</span>
	<span class="cm">/* Register interrupt handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">,</span> <span class="n">AtaInterrupt</span><span class="p">,</span> <span class="n">IRQ_TYPE_SLOW</span><span class="p">,</span> <span class="s">&quot;DMA sound&quot;</span><span class="p">,</span>
			<span class="n">AtaInterrupt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">int_en_a</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* Turn interrupt on. */</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">int_mk_a</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">AtaIrqCleanUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">tim_ct_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* stop timer */</span>
	<span class="n">st_mfp</span><span class="p">.</span><span class="n">int_en_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* turn interrupt off */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">,</span> <span class="n">AtaInterrupt</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>


<span class="cp">#define TONE_VOXWARE_TO_DB(v) \</span>
<span class="cp">	(((v) &lt; 0) ? -12 : ((v) &gt; 100) ? 12 : ((v) - 50) * 6 / 25)</span>
<span class="cp">#define TONE_DB_TO_VOXWARE(v) (((v) * 25 + ((v) &gt; 0 ? 5 : -5)) / 6 + 50)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">AtaSetBass</span><span class="p">(</span><span class="kt">int</span> <span class="n">bass</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">bass</span> <span class="o">=</span> <span class="n">TONE_VOXWARE_TO_DB</span><span class="p">(</span><span class="n">bass</span><span class="p">);</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_BASS</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bass</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">TONE_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bass</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">AtaSetTreble</span><span class="p">(</span><span class="kt">int</span> <span class="n">treble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span> <span class="o">=</span> <span class="n">TONE_VOXWARE_TO_DB</span><span class="p">(</span><span class="n">treble</span><span class="p">);</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_TREBLE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">TONE_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * TT</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">TTSilence</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DMASND_CTRL_OFF</span><span class="p">;</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_PSG_HIGH</span><span class="p">);</span> <span class="cm">/* mix in PSG signal 1:1 */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">TTInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">50066</span><span class="p">,</span> <span class="mi">25033</span><span class="p">,</span> <span class="mi">12517</span><span class="p">,</span> <span class="mi">6258</span><span class="p">};</span>

	<span class="cm">/* search a frequency that fits into the allowed error range */</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* this isn&#39;t as much useful for a TT than for a Falcon, but</span>
<span class="cm">		 * then it doesn&#39;t hurt very much to implement it for a TT too.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">100</span> <span class="o">*</span> <span class="n">abs</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span> <span class="o">-</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">catchRadius</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transTTNormal</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transTTExpanding</span><span class="p">;</span>

	<span class="n">TTSilence</span><span class="p">();</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">50066</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we would need to squeeze the sound, but we won&#39;t do that */</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">50066</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">DMASND_MODE_50KHZ</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transTTNormal</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">25033</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">50066</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">DMASND_MODE_50KHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">12517</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">25033</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">DMASND_MODE_25KHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">6258</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">12517</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">DMASND_MODE_12KHZ</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">6258</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">DMASND_MODE_6KHZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span> <span class="o">?</span>
			  <span class="n">DMASND_MODE_STEREO</span> <span class="o">:</span> <span class="n">DMASND_MODE_MONO</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">DMASND_MODE_8BIT</span> <span class="o">|</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">expand_bal</span> <span class="o">=</span> <span class="o">-</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">TTSetFormat</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TT sound DMA supports only 8bit modes */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AFMT_QUERY</span>:
		<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_MU_LAW</span>:
	<span class="k">case</span> <span class="n">AFMT_A_LAW</span>:
	<span class="k">case</span> <span class="n">AFMT_S8</span>:
	<span class="k">case</span> <span class="n">AFMT_U8</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">==</span> <span class="n">SND_DEV_DSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">TTInit</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define VOLUME_VOXWARE_TO_DB(v) \</span>
<span class="cp">	(((v) &lt; 0) ? -40 : ((v) &gt; 100) ? 0 : ((v) * 2) / 5 - 40)</span>
<span class="cp">#define VOLUME_DB_TO_VOXWARE(v) ((((v) + 40) * 5 + 1) / 2)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">TTSetVolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="n">VOLUME_VOXWARE_TO_DB</span><span class="p">(</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_BALLEFT</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">));</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="n">VOLUME_VOXWARE_TO_DB</span><span class="p">((</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_BALRIGHT</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">VOLUME_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">VOLUME_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define GAIN_VOXWARE_TO_DB(v) \</span>
<span class="cp">	(((v) &lt; 0) ? -80 : ((v) &gt; 100) ? 0 : ((v) * 4) / 5 - 80)</span>
<span class="cp">#define GAIN_DB_TO_VOXWARE(v) ((((v) + 80) * 5 + 1) / 4)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">TTSetGain</span><span class="p">(</span><span class="kt">int</span> <span class="n">gain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">GAIN_VOXWARE_TO_DB</span><span class="p">(</span><span class="n">gain</span><span class="p">);</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_VOLUME</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">gain</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">GAIN_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">gain</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Falcon</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">FalconSilence</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* stop playback, set sample rate 50kHz for PSG sound */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DMASND_CTRL_OFF</span><span class="p">;</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DMASND_MODE_50KHZ</span> <span class="o">|</span> <span class="n">DMASND_MODE_STEREO</span> <span class="o">|</span> <span class="n">DMASND_MODE_8BIT</span><span class="p">;</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">int_div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* STE compatible divider */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">int_ctrl</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">cbar_src</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="cm">/* no matrix inputs */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">cbar_dst</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="cm">/* no matrix outputs */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">dac_src</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* connect ADC to DAC, disconnect matrix */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">adc_src</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* ADC Input = PSG */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">FalconInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divider</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">49170</span><span class="p">,</span> <span class="mi">32780</span><span class="p">,</span> <span class="mi">24585</span><span class="p">,</span> <span class="mi">19668</span><span class="p">,</span> <span class="mi">16390</span><span class="p">,</span> <span class="mi">12292</span><span class="p">,</span> <span class="mi">9834</span><span class="p">,</span> <span class="mi">8195</span><span class="p">};</span>

	<span class="cm">/* search a frequency that fits into the allowed error range */</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* if we will tolerate 3% error 8000Hz-&gt;8195Hz (2.38%) would</span>
<span class="cm">		 * be playable without expanding, but that now a kernel runtime</span>
<span class="cm">		 * option</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">100</span> <span class="o">*</span> <span class="n">abs</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span> <span class="o">-</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">catchRadius</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transFalconNormal</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transFalconExpanding</span><span class="p">;</span>

	<span class="n">FalconSilence</span><span class="p">();</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the Falcon can play 16bit samples only in stereo */</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">49170</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we would need to squeeze the sound, but we won&#39;t do that */</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">49170</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transFalconNormal</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">32780</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">49170</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">24585</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">32780</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">19668</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">24585</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">16390</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">19668</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">12292</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">16390</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">9834</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">12292</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">8195</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">9834</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">8195</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">int_div</span> <span class="o">=</span> <span class="n">divider</span><span class="p">;</span>

	<span class="cm">/* Setup Falcon sound DMA for playback */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">int_ctrl</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="cm">/* Timer A int at play end */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">track_select</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="cm">/* play 1 track, track 1 */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">cbar_src</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span> <span class="cm">/* DMA(25MHz) --&gt; DAC */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">cbar_dst</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">rec_track_select</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">dac_src</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* connect matrix to DAC */</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">adc_src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ADC Input = Mic */</span>

	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span> <span class="o">?</span>
			  <span class="n">DMASND_MODE_STEREO</span> <span class="o">:</span> <span class="n">DMASND_MODE_MONO</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span>
		 <span class="n">DMASND_MODE_8BIT</span> <span class="o">:</span> <span class="n">DMASND_MODE_16BIT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">DMASND_MODE_6KHZ</span><span class="p">;</span>

	<span class="n">expand_bal</span> <span class="o">=</span> <span class="o">-</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">FalconSetFormat</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="cm">/* Falcon sound DMA supports 8bit and 16bit modes */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AFMT_QUERY</span>:
		<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_MU_LAW</span>:
	<span class="k">case</span> <span class="n">AFMT_A_LAW</span>:
	<span class="k">case</span> <span class="n">AFMT_U8</span>:
	<span class="k">case</span> <span class="n">AFMT_S8</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S16_BE</span>:
	<span class="k">case</span> <span class="n">AFMT_U16_BE</span>:
	<span class="k">case</span> <span class="n">AFMT_S16_LE</span>:
	<span class="k">case</span> <span class="n">AFMT_U16_LE</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* :-) */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">==</span> <span class="n">SND_DEV_DSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">FalconInit</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This is for the Falcon output *attenuation* in 1.5dB steps,</span>
<span class="cm"> * i.e. output level from 0 to -22.5dB in -1.5dB steps.</span>
<span class="cm"> */</span>
<span class="cp">#define VOLUME_VOXWARE_TO_ATT(v) \</span>
<span class="cp">	((v) &lt; 0 ? 15 : (v) &gt; 100 ? 0 : 15 - (v) * 3 / 20)</span>
<span class="cp">#define VOLUME_ATT_TO_VOXWARE(v) (100 - (v) * 20 / 3)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">FalconSetVolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="n">VOLUME_VOXWARE_TO_ATT</span><span class="p">(</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="n">VOLUME_VOXWARE_TO_ATT</span><span class="p">((</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">output_atten</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">VOLUME_ATT_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">VOLUME_ATT_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">AtaPlayNextFrame</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="cm">/* used by AtaPlay() if all doubts whether there really is something</span>
<span class="cm">	 * to be played are already wiped out.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">write_sq</span><span class="p">.</span><span class="n">front</span><span class="p">];</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="p">((</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="o">?</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span>
					       <span class="o">:</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span><span class="p">);</span>
	<span class="cm">/* end might not be a legal virtual address. */</span>
	<span class="n">DMASNDSetEnd</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">DMASNDSetBase</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">start</span><span class="p">));</span>
	<span class="cm">/* Since only an even number of samples per frame can</span>
<span class="cm">	   be played, we might lose one byte here. (TO DO) */</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">front</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">front</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_count</span><span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DMASND_CTRL_ON</span> <span class="o">|</span> <span class="n">DMASND_CTRL_REPEAT</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">AtaPlay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ++TeSche: Note that write_sq.active is no longer just a flag but</span>
<span class="cm">	 * holds the number of frames the DMA is currently programmed for</span>
<span class="cm">	 * instead, may be 0, 1 (currently being played) or 2 (pre-programmed).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Changes done to write_sq.count and write_sq.active are a bit more</span>
<span class="cm">	 * subtle again so now I must admit I also prefer disabling the irq</span>
<span class="cm">	 * here rather than considering all possible situations. But the point</span>
<span class="cm">	 * is that disabling the irq doesn&#39;t have any bad influence on this</span>
<span class="cm">	 * version of the driver as we benefit from having pre-programmed the</span>
<span class="cm">	 * DMA wherever possible: There&#39;s no need to reload the DMA at the</span>
<span class="cm">	 * exact time of an interrupt but only at some time while the</span>
<span class="cm">	 * pre-programmed frame is playing!</span>
<span class="cm">	 */</span>
	<span class="n">atari_disable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span>	<span class="cm">/* DMA is &#39;full&#39; */</span>
	    <span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* nothing to do */</span>
		<span class="n">atari_enable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* looks like there&#39;s nothing &#39;in&#39; the DMA yet, so try</span>
<span class="cm">		 * to put two frames into it (at least one is available).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">&lt;</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hmmm, the only existing frame is not</span>
<span class="cm">			 * yet filled and we&#39;re not syncing?</span>
<span class="cm">			 */</span>
			<span class="n">atari_enable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">AtaPlayNextFrame</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no more frames */</span>
			<span class="n">atari_enable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		    <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">&lt;</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hmmm, there were two frames, but the second</span>
<span class="cm">			 * one is not yet filled and we&#39;re not syncing?</span>
<span class="cm">			 */</span>
			<span class="n">atari_enable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">AtaPlayNextFrame</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* there&#39;s already a frame being played so we may only stuff</span>
<span class="cm">		 * one new into the DMA, but even if this may be the last</span>
<span class="cm">		 * frame existing the previous one is still on write_sq.count.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		    <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">&lt;</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hmmm, the only existing frame is not</span>
<span class="cm">			 * yet filled and we&#39;re not syncing?</span>
<span class="cm">			 */</span>
			<span class="n">atari_enable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">AtaPlayNextFrame</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atari_enable_irq</span><span class="p">(</span><span class="n">IRQ_MFP_TIMA</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">AtaInterrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* ++TeSche: if you should want to test this... */</span>
<span class="c">	static int cnt;</span>
<span class="c">	if (write_sq.active == 2)</span>
<span class="c">		if (++cnt == 10) {</span>
<span class="c">			/* simulate losing an interrupt */</span>
<span class="c">			cnt = 0;</span>
<span class="c">			return IRQ_HANDLED;</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq_ignore_int</span> <span class="o">&amp;&amp;</span> <span class="n">is_falcon</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ++TeSche: Falcon only: ignore first irq because it comes</span>
<span class="cm">		 * immediately after starting a frame. after that, irqs come</span>
<span class="cm">		 * (almost) like on the TT.</span>
<span class="cm">		 */</span>
		<span class="n">write_sq_ignore_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* playing was interrupted and sq_reset() has already cleared</span>
<span class="cm">		 * the sq variables, so better don&#39;t do anything here.</span>
<span class="cm">		 */</span>
		<span class="n">WAKE_UP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">sync_queue</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Probably ;) one frame is finished. Well, in fact it may be that a</span>
<span class="cm">	 * pre-programmed one is also finished because there has been a long</span>
<span class="cm">	 * delay in interrupt delivery and we&#39;ve completely lost one, but</span>
<span class="cm">	 * there&#39;s no way to detect such a situation. In such a case the last</span>
<span class="cm">	 * frame will be played more than once and the situation will recover</span>
<span class="cm">	 * as soon as the irq gets through.</span>
<span class="cm">	 */</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">DMASND_CTRL_OFF</span><span class="p">;</span>
		<span class="n">write_sq_ignore_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WAKE_UP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">action_queue</span><span class="p">);</span>
	<span class="cm">/* At least one block of the queue is free now</span>
<span class="cm">	   so wake up a writing process blocked because</span>
<span class="cm">	   of a full queue. */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="cm">/* We must be a bit carefully here: write_sq.count indicates the</span>
<span class="cm">		 * number of buffers used and not the number of frames to be</span>
<span class="cm">		 * played. If write_sq.count==1 and write_sq.active==1 that</span>
<span class="cm">		 * means the only remaining frame was already programmed</span>
<span class="cm">		 * earlier (and is currently running) so we mustn&#39;t call</span>
<span class="cm">		 * AtaPlay() here, otherwise we&#39;ll play one frame too much.</span>
<span class="cm">		 */</span>
		<span class="n">AtaPlay</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="n">WAKE_UP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">sync_queue</span><span class="p">);</span>
	<span class="cm">/* We are not playing after AtaPlay(), so there</span>
<span class="cm">	   is nothing to play any more. Wake up a process</span>
<span class="cm">	   waiting for audio output to drain. */</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*** Mid level stuff *********************************************************/</span>


<span class="cm">/*</span>
<span class="cm"> * /dev/mixer abstraction</span>
<span class="cm"> */</span>

<span class="cp">#define RECLEVEL_VOXWARE_TO_GAIN(v)	\</span>
<span class="cp">	((v) &lt; 0 ? 0 : (v) &gt; 100 ? 15 : (v) * 3 / 20)</span>
<span class="cp">#define RECLEVEL_GAIN_TO_VOXWARE(v)	(((v) * 20 + 2) / 3)</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">TTMixerInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_VOLUME</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_BALLEFT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_BALRIGHT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_TREBLE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">atari_microwire_cmd</span><span class="p">(</span><span class="n">MW_LM1992_BASS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">FalconMixerInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">output_atten</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">output_atten</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AtaMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_SPEAKER</span>:
		    <span class="k">if</span> <span class="p">(</span><span class="n">is_falcon</span> <span class="o">||</span> <span class="n">MACH_IS_TT</span><span class="p">)</span> <span class="p">{</span>
			    <span class="kt">int</span> <span class="n">porta</span><span class="p">;</span>
			    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			    <span class="n">sound_ym</span><span class="p">.</span><span class="n">rd_data_reg_sel</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			    <span class="n">porta</span> <span class="o">=</span> <span class="n">sound_ym</span><span class="p">.</span><span class="n">rd_data_reg_sel</span><span class="p">;</span>
			    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">porta</span> <span class="o">&amp;</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">100</span><span class="p">);</span>
		    <span class="p">}</span>
		    <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_VOLUME</span>:
		    <span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound_set_volume</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_SPEAKER</span>:
		    <span class="k">if</span> <span class="p">(</span><span class="n">is_falcon</span> <span class="o">||</span> <span class="n">MACH_IS_TT</span><span class="p">)</span> <span class="p">{</span>
			    <span class="kt">int</span> <span class="n">porta</span><span class="p">;</span>
			    <span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			    <span class="n">sound_ym</span><span class="p">.</span><span class="n">rd_data_reg_sel</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			    <span class="n">porta</span> <span class="o">=</span> <span class="p">(</span><span class="n">sound_ym</span><span class="p">.</span><span class="n">rd_data_reg_sel</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			    <span class="n">sound_ym</span><span class="p">.</span><span class="n">wd_data</span> <span class="o">=</span> <span class="n">porta</span><span class="p">;</span>
			    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">porta</span> <span class="o">&amp;</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">100</span><span class="p">);</span>
		    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">TTMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_RECMASK</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_DEVMASK</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
				 <span class="n">SOUND_MASK_VOLUME</span> <span class="o">|</span> <span class="n">SOUND_MASK_TREBLE</span> <span class="o">|</span> <span class="n">SOUND_MASK_BASS</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">MACH_IS_TT</span> <span class="o">?</span> <span class="n">SOUND_MASK_SPEAKER</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_STEREODEVS</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_MASK_VOLUME</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_VOLUME</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
				 <span class="n">VOLUME_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">)</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">VOLUME_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_BASS</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TONE_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bass</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_TREBLE</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">TONE_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_OGAIN</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">GAIN_DB_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">gain</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_BASS</span>:
		<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound_set_bass</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_TREBLE</span>:
		<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound_set_treble</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_OGAIN</span>:
		<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound_set_gain</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">AtaMixerIoctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FalconMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_RECMASK</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_MASK_MIC</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_DEVMASK</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_MASK_VOLUME</span> <span class="o">|</span> <span class="n">SOUND_MASK_MIC</span> <span class="o">|</span> <span class="n">SOUND_MASK_SPEAKER</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_STEREODEVS</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_MASK_VOLUME</span> <span class="o">|</span> <span class="n">SOUND_MASK_MIC</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_VOLUME</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
			<span class="n">VOLUME_ATT_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">VOLUME_ATT_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_CAPS</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_CAP_EXCL_INPUT</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_MIC</span>:
		<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">input_gain</span> <span class="o">=</span>
			<span class="n">RECLEVEL_VOXWARE_TO_GAIN</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span>
			<span class="n">RECLEVEL_VOXWARE_TO_GAIN</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/* fall thru, return set value */</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_MIC</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
			<span class="n">RECLEVEL_GAIN_TO_VOXWARE</span><span class="p">(</span><span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">input_gain</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">RECLEVEL_GAIN_TO_VOXWARE</span><span class="p">(</span><span class="n">tt_dmasnd</span><span class="p">.</span><span class="n">input_gain</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">AtaMixerIoctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AtaWriteSqSetup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_sq_ignore_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AtaSqOpen</span><span class="p">(</span><span class="n">fmode_t</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_sq_ignore_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">TTStateInfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">vol left  %ddB [-40...  0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">vol right %ddB [-40...  0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">bass      %ddB [-12...+12]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">bass</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">treble    %ddB [-12...+12]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dmasound_atari: overflowed state buffer alloc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">space</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">FalconStateInfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">vol left  %ddB [-22.5 ... 0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">vol right %ddB [-22.5 ... 0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dmasound_atari: overflowed state buffer alloc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">space</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*** Machine definitions *****************************************************/</span>

<span class="k">static</span> <span class="n">SETTINGS</span> <span class="n">def_hard_falcon</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">format</span>		<span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed</span>		<span class="o">=</span> <span class="mi">8195</span>
<span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="n">SETTINGS</span> <span class="n">def_hard_tt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">format</span>	<span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed</span>	<span class="o">=</span> <span class="mi">12517</span>
<span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="n">SETTINGS</span> <span class="n">def_soft</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">format</span>	<span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed</span>	<span class="o">=</span> <span class="mi">8000</span>
<span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="n">MACHINE</span> <span class="n">machTT</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Atari&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name2</span>		<span class="o">=</span> <span class="s">&quot;TT&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_alloc</span>	<span class="o">=</span> <span class="n">AtaAlloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_free</span>	<span class="o">=</span> <span class="n">AtaFree</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irqinit</span>	<span class="o">=</span> <span class="n">AtaIrqInit</span><span class="p">,</span>
<span class="cp">#ifdef MODULE</span>
	<span class="p">.</span><span class="n">irqcleanup</span>	<span class="o">=</span> <span class="n">AtaIrqCleanUp</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">TTInit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">silence</span>	<span class="o">=</span> <span class="n">TTSilence</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setFormat</span>	<span class="o">=</span> <span class="n">TTSetFormat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setVolume</span>	<span class="o">=</span> <span class="n">TTSetVolume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setBass</span>	<span class="o">=</span> <span class="n">AtaSetBass</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setTreble</span>	<span class="o">=</span> <span class="n">AtaSetTreble</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setGain</span>	<span class="o">=</span> <span class="n">TTSetGain</span><span class="p">,</span>
	<span class="p">.</span><span class="n">play</span>		<span class="o">=</span> <span class="n">AtaPlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_init</span>	<span class="o">=</span> <span class="n">TTMixerInit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_ioctl</span>	<span class="o">=</span> <span class="n">TTMixerIoctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_sq_setup</span>	<span class="o">=</span> <span class="n">AtaWriteSqSetup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sq_open</span>	<span class="o">=</span> <span class="n">AtaSqOpen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_info</span>	<span class="o">=</span> <span class="n">TTStateInfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_dsp_speed</span>	<span class="o">=</span> <span class="mi">6258</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="p">((</span><span class="n">DMASOUND_ATARI_REVISION</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">DMASOUND_ATARI_EDITION</span><span class="p">),</span>
	<span class="p">.</span><span class="n">hardware_afmts</span>	<span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">,</span>  <span class="cm">/* h&#39;ware-supported formats *only* here */</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span>  <span class="n">DSP_CAP_BATCH</span>	<span class="cm">/* As per SNDCTL_DSP_GETCAPS */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__initdata</span> <span class="n">MACHINE</span> <span class="n">machFalcon</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Atari&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name2</span>		<span class="o">=</span> <span class="s">&quot;FALCON&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_alloc</span>	<span class="o">=</span> <span class="n">AtaAlloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_free</span>	<span class="o">=</span> <span class="n">AtaFree</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irqinit</span>	<span class="o">=</span> <span class="n">AtaIrqInit</span><span class="p">,</span>
<span class="cp">#ifdef MODULE</span>
	<span class="p">.</span><span class="n">irqcleanup</span>	<span class="o">=</span> <span class="n">AtaIrqCleanUp</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">FalconInit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">silence</span>	<span class="o">=</span> <span class="n">FalconSilence</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setFormat</span>	<span class="o">=</span> <span class="n">FalconSetFormat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setVolume</span>	<span class="o">=</span> <span class="n">FalconSetVolume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setBass</span>	<span class="o">=</span> <span class="n">AtaSetBass</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setTreble</span>	<span class="o">=</span> <span class="n">AtaSetTreble</span><span class="p">,</span>
	<span class="p">.</span><span class="n">play</span>		<span class="o">=</span> <span class="n">AtaPlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_init</span>	<span class="o">=</span> <span class="n">FalconMixerInit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_ioctl</span>	<span class="o">=</span> <span class="n">FalconMixerIoctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_sq_setup</span>	<span class="o">=</span> <span class="n">AtaWriteSqSetup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sq_open</span>	<span class="o">=</span> <span class="n">AtaSqOpen</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_info</span>	<span class="o">=</span> <span class="n">FalconStateInfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_dsp_speed</span>	<span class="o">=</span> <span class="mi">8195</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="p">((</span><span class="n">DMASOUND_ATARI_REVISION</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">DMASOUND_ATARI_EDITION</span><span class="p">),</span>
	<span class="p">.</span><span class="n">hardware_afmts</span>	<span class="o">=</span> <span class="p">(</span><span class="n">AFMT_S8</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span><span class="p">),</span> <span class="cm">/* h&#39;ware-supported formats *only* here */</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span>  <span class="n">DSP_CAP_BATCH</span>	<span class="cm">/* As per SNDCTL_DSP_GETCAPS */</span>
<span class="p">};</span>


<span class="cm">/*** Config &amp; Setup **********************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dmasound_atari_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MACH_IS_ATARI</span> <span class="o">&amp;&amp;</span> <span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">PCM_8BIT</span><span class="p">))</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">CODEC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span> <span class="o">=</span> <span class="n">machFalcon</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="o">=</span> <span class="n">def_soft</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_hard</span> <span class="o">=</span> <span class="n">def_hard_falcon</span> <span class="p">;</span>
		<span class="n">is_falcon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ATARIHW_PRESENT</span><span class="p">(</span><span class="n">MICROWIRE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span> <span class="o">=</span> <span class="n">machTT</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="o">=</span> <span class="n">def_soft</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_hard</span> <span class="o">=</span> <span class="n">def_hard_tt</span> <span class="p">;</span>
		<span class="n">is_falcon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">st_mfp</span><span class="p">.</span><span class="n">int_en_a</span> <span class="o">&amp;</span> <span class="n">st_mfp</span><span class="p">.</span><span class="n">int_mk_a</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dmasound_init</span><span class="p">();</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DMA sound driver: Timer A interrupt already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">dmasound_atari_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound_deinit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">dmasound_atari_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">dmasound_atari_cleanup</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
