<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › dmasound › dmasound_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dmasound_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/sound/oss/dmasound/dmasound_core.c</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  OSS/Free compatible Atari TT/Falcon and Amiga DMA sound driver for</span>
<span class="cm"> *  Linux/m68k</span>
<span class="cm"> *  Extended to support Power Macintosh for Linux/ppc by Paul Mackerras</span>
<span class="cm"> *</span>
<span class="cm"> *  (c) 1995 by Michael Schlueter &amp; Michael Marte</span>
<span class="cm"> *</span>
<span class="cm"> *  Michael Schlueter (michael@duck.syd.de) did the basic structure of the VFS</span>
<span class="cm"> *  interface and the u-law to signed byte conversion.</span>
<span class="cm"> *</span>
<span class="cm"> *  Michael Marte (marte@informatik.uni-muenchen.de) did the sound queue,</span>
<span class="cm"> *  /dev/mixer, /dev/sndstat and complemented the VFS interface. He would like</span>
<span class="cm"> *  to thank:</span>
<span class="cm"> *    - Michael Schlueter for initial ideas and documentation on the MFP and</span>
<span class="cm"> *	the DMA sound hardware.</span>
<span class="cm"> *    - Therapy? for their CD &#39;Troublegum&#39; which really made me rock.</span>
<span class="cm"> *</span>
<span class="cm"> *  /dev/sndstat is based on code by Hannu Savolainen, the author of the</span>
<span class="cm"> *  VoxWare family of drivers.</span>
<span class="cm"> *</span>
<span class="cm"> *  This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> *  License.  See the file COPYING in the main directory of this archive</span>
<span class="cm"> *  for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  History:</span>
<span class="cm"> *</span>
<span class="cm"> *	1995/8/25	First release</span>
<span class="cm"> *</span>
<span class="cm"> *	1995/9/02	Roman Hodek:</span>
<span class="cm"> *			  - Fixed atari_stram_alloc() call, the timer</span>
<span class="cm"> *			    programming and several race conditions</span>
<span class="cm"> *	1995/9/14	Roman Hodek:</span>
<span class="cm"> *			  - After some discussion with Michael Schlueter,</span>
<span class="cm"> *			    revised the interrupt disabling</span>
<span class="cm"> *			  - Slightly speeded up U8-&gt;S8 translation by using</span>
<span class="cm"> *			    long operations where possible</span>
<span class="cm"> *			  - Added 4:3 interpolation for /dev/audio</span>
<span class="cm"> *</span>
<span class="cm"> *	1995/9/20	Torsten Scherer:</span>
<span class="cm"> *			  - Fixed a bug in sq_write and changed /dev/audio</span>
<span class="cm"> *			    converting to play at 12517Hz instead of 6258Hz.</span>
<span class="cm"> *</span>
<span class="cm"> *	1995/9/23	Torsten Scherer:</span>
<span class="cm"> *			  - Changed sq_interrupt() and sq_play() to pre-program</span>
<span class="cm"> *			    the DMA for another frame while there&#39;s still one</span>
<span class="cm"> *			    running. This allows the IRQ response to be</span>
<span class="cm"> *			    arbitrarily delayed and playing will still continue.</span>
<span class="cm"> *</span>
<span class="cm"> *	1995/10/14	Guenther Kelleter, Torsten Scherer:</span>
<span class="cm"> *			  - Better support for Falcon audio (the Falcon doesn&#39;t</span>
<span class="cm"> *			    raise an IRQ at the end of a frame, but at the</span>
<span class="cm"> *			    beginning instead!). uses &#39;if (codec_dma)&#39; in lots</span>
<span class="cm"> *			    of places to simply switch between Falcon and TT</span>
<span class="cm"> *			    code.</span>
<span class="cm"> *</span>
<span class="cm"> *	1995/11/06	Torsten Scherer:</span>
<span class="cm"> *			  - Started introducing a hardware abstraction scheme</span>
<span class="cm"> *			    (may perhaps also serve for Amigas?)</span>
<span class="cm"> *			  - Can now play samples at almost all frequencies by</span>
<span class="cm"> *			    means of a more generalized expand routine</span>
<span class="cm"> *			  - Takes a good deal of care to cut data only at</span>
<span class="cm"> *			    sample sizes</span>
<span class="cm"> *			  - Buffer size is now a kernel runtime option</span>
<span class="cm"> *			  - Implemented fsync() &amp; several minor improvements</span>
<span class="cm"> *			Guenther Kelleter:</span>
<span class="cm"> *			  - Useful hints and bug fixes</span>
<span class="cm"> *			  - Cross-checked it for Falcons</span>
<span class="cm"> *</span>
<span class="cm"> *	1996/3/9	Geert Uytterhoeven:</span>
<span class="cm"> *			  - Support added for Amiga, A-law, 16-bit little</span>
<span class="cm"> *			    endian.</span>
<span class="cm"> *			  - Unification to drivers/sound/dmasound.c.</span>
<span class="cm"> *</span>
<span class="cm"> *	1996/4/6	Martin Mitchell:</span>
<span class="cm"> *			  - Updated to 1.3 kernel.</span>
<span class="cm"> *</span>
<span class="cm"> *	1996/6/13       Topi Kanerva:</span>
<span class="cm"> *			  - Fixed things that were broken (mainly the amiga</span>
<span class="cm"> *			    14-bit routines)</span>
<span class="cm"> *			  - /dev/sndstat shows now the real hardware frequency</span>
<span class="cm"> *			  - The lowpass filter is disabled by default now</span>
<span class="cm"> *</span>
<span class="cm"> *	1996/9/25	Geert Uytterhoeven:</span>
<span class="cm"> *			  - Modularization</span>
<span class="cm"> *</span>
<span class="cm"> *	1998/6/10	Andreas Schwab:</span>
<span class="cm"> *			  - Converted to use sound_core</span>
<span class="cm"> *</span>
<span class="cm"> *	1999/12/28	Richard Zidlicky:</span>
<span class="cm"> *			  - Added support for Q40</span>
<span class="cm"> *</span>
<span class="cm"> *	2000/2/27	Geert Uytterhoeven:</span>
<span class="cm"> *			  - Clean up and split the code into 4 parts:</span>
<span class="cm"> *			      o dmasound_core: machine-independent code</span>
<span class="cm"> *			      o dmasound_atari: Atari TT and Falcon support</span>
<span class="cm"> *			      o dmasound_awacs: Apple PowerMac support</span>
<span class="cm"> *			      o dmasound_paula: Amiga support</span>
<span class="cm"> *</span>
<span class="cm"> *	2000/3/25	Geert Uytterhoeven:</span>
<span class="cm"> *			  - Integration of dmasound_q40</span>
<span class="cm"> *			  - Small clean ups</span>
<span class="cm"> *</span>
<span class="cm"> *	2001/01/26 [1.0] Iain Sandoe</span>
<span class="cm"> *			  - make /dev/sndstat show revision &amp; edition info.</span>
<span class="cm"> *			  - since dmasound.mach.sq_setup() can fail on pmac</span>
<span class="cm"> *			    its type has been changed to int and the returns</span>
<span class="cm"> *			    are checked.</span>
<span class="cm"> *		   [1.1]  - stop missing translations from being called.</span>
<span class="cm"> *	2001/02/08 [1.2]  - remove unused translation tables &amp; move machine-</span>
<span class="cm"> *			    specific tables to low-level.</span>
<span class="cm"> *			  - return correct info. for SNDCTL_DSP_GETFMTS.</span>
<span class="cm"> *		   [1.3]  - implement SNDCTL_DSP_GETCAPS fully.</span>
<span class="cm"> *		   [1.4]  - make /dev/sndstat text length usage deterministic.</span>
<span class="cm"> *			  - make /dev/sndstat call to low-level</span>
<span class="cm"> *			    dmasound.mach.state_info() pass max space to ll driver.</span>
<span class="cm"> *			  - tidy startup banners and output info.</span>
<span class="cm"> *		   [1.5]  - tidy up a little (removed some unused #defines in</span>
<span class="cm"> *			    dmasound.h)</span>
<span class="cm"> *			  - fix up HAS_RECORD conditionalisation.</span>
<span class="cm"> *			  - add record code in places it is missing...</span>
<span class="cm"> *			  - change buf-sizes to bytes to allow &lt; 1kb for pmac</span>
<span class="cm"> *			    if user param entry is &lt; 256 the value is taken to</span>
<span class="cm"> *			    be in kb &gt; 256 is taken to be in bytes.</span>
<span class="cm"> *			  - make default buff/frag params conditional on</span>
<span class="cm"> *			    machine to allow smaller values for pmac.</span>
<span class="cm"> *			  - made the ioctls, read &amp; write comply with the OSS</span>
<span class="cm"> *			    rules on setting params.</span>
<span class="cm"> *			  - added parsing of _setup() params for record.</span>
<span class="cm"> *	2001/04/04 [1.6]  - fix bug where sample rates higher than maximum were</span>
<span class="cm"> *			    being reported as OK.</span>
<span class="cm"> *			  - fix open() to return -EBUSY as per OSS doc. when</span>
<span class="cm"> *			    audio is in use - this is independent of O_NOBLOCK.</span>
<span class="cm"> *			  - fix bug where SNDCTL_DSP_POST was blocking.</span>
<span class="cm"> */</span>

 <span class="cm">/* Record capability notes 30/01/2001:</span>
<span class="cm">  * At present these observations apply only to pmac LL driver (the only one</span>
<span class="cm">  * that can do record, at present).  However, if other LL drivers for machines</span>
<span class="cm">  * with record are added they may apply.</span>
<span class="cm">  *</span>
<span class="cm">  * The fragment parameters for the record and play channels are separate.</span>
<span class="cm">  * However, if the driver is opened O_RDWR there is no way (in the current OSS</span>
<span class="cm">  * API) to specify their values independently for the record and playback</span>
<span class="cm">  * channels.  Since the only common factor between the input &amp; output is the</span>
<span class="cm">  * sample rate (on pmac) it should be possible to open /dev/dspX O_WRONLY and</span>
<span class="cm">  * /dev/dspY O_RDONLY.  The input &amp; output channels could then have different</span>
<span class="cm">  * characteristics (other than the first that sets sample rate claiming the</span>
<span class="cm">  * right to set it for ever).  As it stands, the format, channels, number of</span>
<span class="cm">  * bits &amp; sample rate are assumed to be common.  In the future perhaps these</span>
<span class="cm">  * should be the responsibility of the LL driver - and then if a card really</span>
<span class="cm">  * does not share items between record &amp; playback they can be specified</span>
<span class="cm">  * separately.</span>
<span class="cm">*/</span>

<span class="cm">/* Thread-safeness of shared_resources notes: 31/01/2001</span>
<span class="cm"> * If the user opens O_RDWR and then splits record &amp; play between two threads</span>
<span class="cm"> * both of which inherit the fd - and then starts changing things from both</span>
<span class="cm"> * - we will have difficulty telling.</span>
<span class="cm"> *</span>
<span class="cm"> * It&#39;s bad application coding - but ...</span>
<span class="cm"> * TODO: think about how to sort this out... without bogging everything down in</span>
<span class="cm"> * semaphores.</span>
<span class="cm"> *</span>
<span class="cm"> * Similarly, the OSS spec says &quot;all changes to parameters must be between</span>
<span class="cm"> * open() and the first read() or write(). - and a bit later on (by</span>
<span class="cm"> * implication) &quot;between SNDCTL_DSP_RESET and the first read() or write() after</span>
<span class="cm"> * it&quot;.  If the app is multi-threaded and this rule is broken between threads</span>
<span class="cm"> * we will have trouble spotting it - and the fault will be rather obscure :-(</span>
<span class="cm"> *</span>
<span class="cm"> * We will try and put out at least a kmsg if we see it happen... but I think</span>
<span class="cm"> * it will be quite hard to trap it with an -EXXX return... because we can&#39;t</span>
<span class="cm"> * see the fault until after the damage is done.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sound.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/soundcard.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;dmasound.h&quot;</span>

<span class="cp">#define DMASOUND_CORE_REVISION 1</span>
<span class="cp">#define DMASOUND_CORE_EDITION 6</span>

    <span class="cm">/*</span>
<span class="cm">     *  Declarations</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">dmasound_catchRadius</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dmasound_catchRadius</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">numWriteBufs</span> <span class="o">=</span> <span class="n">DEFAULT_N_BUFFERS</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">numWriteBufs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">writeBufSize</span> <span class="o">=</span> <span class="n">DEFAULT_BUFF_SIZE</span> <span class="p">;</span>	<span class="cm">/* in bytes */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">writeBufSize</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sq_unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mixer_unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">state_unit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_installed</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="cm">/* control over who can modify resources shared between play/record */</span>
<span class="k">static</span> <span class="n">fmode_t</span> <span class="n">shared_resource_owner</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">shared_resources_initialised</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     *  Mid level stuff</span>
<span class="cm">     */</span>

<span class="k">struct</span> <span class="n">sound_settings</span> <span class="n">dmasound</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">__SPIN_LOCK_UNLOCKED</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sound_silence</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">silence</span><span class="p">();</span> <span class="cm">/* _MUST_ stop DMA */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sound_set_format</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">setFormat</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>

	<span class="cm">/* trap out-of-range speed settings.</span>
<span class="cm">	   at present we allow (arbitrarily) low rates - using soft</span>
<span class="cm">	   up-conversion - but we can&#39;t allow &gt; max because there is</span>
<span class="cm">	   no soft down-conversion.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">max_dsp_speed</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">max_dsp_speed</span><span class="p">))</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">max_dsp_speed</span> <span class="p">;</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">==</span> <span class="n">SND_DEV_DSP</span><span class="p">)</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_set_stereo</span><span class="p">(</span><span class="kt">int</span> <span class="n">stereo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stereo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">;</span>

	<span class="n">stereo</span> <span class="o">=</span> <span class="o">!!</span><span class="n">stereo</span><span class="p">;</span>    <span class="cm">/* should be 0 or 1 now */</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">==</span> <span class="n">SND_DEV_DSP</span><span class="p">)</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">stereo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sound_copy_translate</span><span class="p">(</span><span class="n">TRANS</span> <span class="o">*</span><span class="n">trans</span><span class="p">,</span> <span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span>
				    <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="p">(</span><span class="o">*</span><span class="n">ct_func</span><span class="p">)(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="kt">size_t</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">ssize_t</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">AFMT_MU_LAW</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_ulaw</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_A_LAW</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_alaw</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_S8</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_s8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_U8</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_u8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_S16_BE</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_s16be</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_U16_BE</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_u16be</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_S16_LE</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_s16le</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">AFMT_U16_LE</span>:
		<span class="n">ct_func</span> <span class="o">=</span> <span class="n">trans</span><span class="o">-&gt;</span><span class="n">ct_u16le</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if the user has requested a non-existent translation don&#39;t try</span>
<span class="cm">	   to call it but just return 0 bytes moved</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ct_func</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ct_func</span><span class="p">(</span><span class="n">userPtr</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">frameUsed</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     *  /dev/mixer abstraction</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">busy</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">modify_counter</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mixer</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mixer</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="n">mixer</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_WRITE</span><span class="p">)</span>
	    <span class="n">mixer</span><span class="p">.</span><span class="n">modify_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">OSS_GETVERSION</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_VERSION</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_INFO</span>:
		<span class="p">{</span>
		    <span class="n">mixer_info</span> <span class="n">info</span><span class="p">;</span>
		    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		    <span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">name2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
		    <span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">name2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
		    <span class="n">info</span><span class="p">.</span><span class="n">modify_counter</span> <span class="o">=</span> <span class="n">mixer</span><span class="p">.</span><span class="n">modify_counter</span><span class="p">;</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			    <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">mixer_ioctl</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">mixer_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">mixer_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mixer_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">mixer_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">mixer_unlocked_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">mixer_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">mixer_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mixer_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">int</span> <span class="n">mixer_unit</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">mixer_unit</span> <span class="o">=</span> <span class="n">register_sound_mixer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer_fops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mixer_unit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mixer</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">bass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">mixer_init</span><span class="p">)</span>
	    <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">mixer_init</span><span class="p">();</span>
<span class="p">}</span>


    <span class="cm">/*</span>
<span class="cm">     *  Sound queue stuff, the heart of the driver</span>
<span class="cm">     */</span>

<span class="k">struct</span> <span class="n">sound_queue</span> <span class="n">dmasound_write_sq</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sq_reset_output</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_allocate_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sound_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="o">=</span> <span class="n">num</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">num</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">dma_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">dma_free</span><span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sq_release_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">sound_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">dma_free</span><span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sound_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">setup_func</span><span class="p">)(</span><span class="kt">void</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hard_frame</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* are we already set? - and not changeable */</span>
<span class="cp">#ifdef DEBUG_DMASOUND</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_core: tried to sq_setup a locked queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="cm">/* don&#39;t think we have a race prob. here _check_ */</span>

	<span class="cm">/* make sure that the parameters are set up</span>
<span class="cm">	   This should have been done already...</span>
<span class="cm">	*/</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">init</span><span class="p">();</span>

	<span class="cm">/* OK.  If the user has set fragment parameters explicitly, then we</span>
<span class="cm">	   should leave them alone... as long as they are valid.</span>
<span class="cm">	   Invalid user fragment params can occur if we allow the whole buffer</span>
<span class="cm">	   to be used when the user requests the fragments sizes (with no soft</span>
<span class="cm">	   x-lation) and then the user subsequently sets a soft x-lation that</span>
<span class="cm">	   requires increased internal buffering.</span>

<span class="cm">	   Othwerwise (if the user did not set them) OSS says that we should</span>
<span class="cm">	   select frag params on the basis of 0.5 s output &amp; 0.1 s input</span>
<span class="cm">	   latency. (TODO.  For now we will copy in the defaults.)</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frags</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_count</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_active</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span><span class="p">;</span>
		<span class="cm">/* set up the user info */</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frags</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frag_size</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frag_size</span> <span class="o">*=</span>
			<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frag_size</span> <span class="o">/=</span>
			<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* work out requested block size */</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frag_size</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*=</span>
			<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">/=</span>
			<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>
		<span class="cm">/* the user wants to write frag-size chunks */</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">/=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span> <span class="p">;</span>
		<span class="cm">/* this only works for size values which are powers of 2 */</span>
		<span class="n">hard_frame</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="mi">8</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">+=</span>  <span class="p">(</span><span class="n">hard_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">hard_frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* make sure we are aligned */</span>
		<span class="cm">/* let&#39;s just check for obvious mistakes */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_DMASOUND</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_core: invalid frag size (user set %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frag_size</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frags</span> <span class="o">&lt;=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_count</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frags</span> <span class="p">;</span>
			<span class="cm">/* if user has set max_active - then use it */</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_active</span> <span class="o">=</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_active</span> <span class="o">&lt;=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_count</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_active</span> <span class="o">:</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_count</span> <span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_DMASOUND</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_core: invalid frag count (user set %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frags</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_count</span> <span class="o">=</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_active</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">front</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">rear_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">syncing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sq</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">write_sq</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">sq</span><span class="o">-&gt;</span><span class="n">rear</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	    <span class="n">setup_func</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">write_sq_setup</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_func</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">setup_func</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sq_play</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">play</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sq_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">uLeft</span><span class="p">,</span>
			<span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">uWritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">dest</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">uUsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bUsed</span><span class="p">,</span> <span class="n">bLeft</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="p">;</span>

	<span class="cm">/* ++TeSche: Is something like this necessary?</span>
<span class="cm">	 * Hey, that&#39;s an honest question! Or does any other part of the</span>
<span class="cm">	 * filesystem already checks this situation? I really don&#39;t know.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uLeft</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* implement any changes we have made to the soft/hard params.</span>
<span class="cm">	   this is not satisfactory really, all we have done up to now is to</span>
<span class="cm">	   say what we would like - there hasn&#39;t been any real checking of capability</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shared_resources_initialised</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">init</span><span class="p">()</span> <span class="p">;</span>
		<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up the sq if it is not already done. This may seem a dumb place</span>
<span class="cm">	   to do it - but it is what OSS requires.  It means that write() can</span>
<span class="cm">	   return memory allocation errors.  To avoid this possibility use the</span>
<span class="cm">	   GETBLKSIZE or GETOSPACE ioctls (after you&#39;ve fiddled with all the</span>
<span class="cm">	   params you want to change) - these ioctls also force the setup.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">uWritten</span> <span class="o">=</span> <span class="n">sq_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_sq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">uWritten</span> <span class="p">;</span>
		<span class="n">uWritten</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/* FIXME: I think that this may be the wrong behaviour when we get strapped</span>
<span class="cm">	for time and the cpu is close to being (or actually) behind in sending data.</span>
<span class="cm">	- because we&#39;ve lost the time that the N samples, already in the buffer,</span>
<span class="cm">	would have given us to get here with the next lot from the user.</span>
<span class="cm">*/</span>
	<span class="cm">/* The interrupt doesn&#39;t start to play the last, incomplete frame.</span>
<span class="cm">	 * Thus we can append to it without disabling the interrupts! (Note</span>
<span class="cm">	 * also that write_sq.rear isn&#39;t affected by the interrupt.)</span>
<span class="cm">	 */</span>

	<span class="cm">/* as of 1.6 this behaviour changes if SNDCTL_DSP_POST has been issued:</span>
<span class="cm">	   this will mimic the behaviour of syncing and allow the sq_play() to</span>
<span class="cm">	   queue a partial fragment.  Since sq_play() may/will be called from</span>
<span class="cm">	   the IRQ handler - at least on Pmac we have to deal with it.</span>
<span class="cm">	   The strategy - possibly not optimum - is to kill _POST status if we</span>
<span class="cm">	   get here.  This seems, at least, reasonable - in the sense that POST</span>
<span class="cm">	   is supposed to indicate that we might not write before the queue</span>
<span class="cm">	   is drained - and if we get here in time then it does not apply.</span>
<span class="cm">	*/</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">2</span> <span class="p">;</span> <span class="cm">/* take out POST status */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bLeft</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span><span class="o">-</span><span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dest</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">write_sq</span><span class="p">.</span><span class="n">rear</span><span class="p">];</span>
		<span class="n">bUsed</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span><span class="p">;</span>
		<span class="n">uUsed</span> <span class="o">=</span> <span class="n">sound_copy_translate</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">uLeft</span><span class="p">,</span>
					     <span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bUsed</span><span class="p">,</span> <span class="n">bLeft</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uUsed</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">uUsed</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">uUsed</span><span class="p">;</span>
		<span class="n">uWritten</span> <span class="o">+=</span> <span class="n">uUsed</span><span class="p">;</span>
		<span class="n">uLeft</span> <span class="o">=</span> <span class="p">(</span><span class="n">uUsed</span> <span class="o">&lt;=</span> <span class="n">uLeft</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">uLeft</span> <span class="o">-</span> <span class="n">uUsed</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">;</span> <span class="cm">/* paranoia */</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">=</span> <span class="n">bUsed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">uLeft</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_active</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sq_play</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">non_blocking</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">uWritten</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">uWritten</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">SLEEP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">action_queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">uWritten</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">uWritten</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Here, we can avoid disabling the interrupt by first</span>
<span class="cm">		 * copying and translating the data, and then updating</span>
<span class="cm">		 * the write_sq variables. Until this is done, the interrupt</span>
<span class="cm">		 * won&#39;t see the new frame and we can work on it</span>
<span class="cm">		 * undisturbed.</span>
<span class="cm">		 */</span>

		<span class="n">dest</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">buffers</span><span class="p">[(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">rear</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_count</span><span class="p">];</span>
		<span class="n">bUsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bLeft</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span><span class="p">;</span>
		<span class="n">uUsed</span> <span class="o">=</span> <span class="n">sound_copy_translate</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">uLeft</span><span class="p">,</span>
					     <span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bUsed</span><span class="p">,</span> <span class="n">bLeft</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uUsed</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">uUsed</span><span class="p">;</span>
		<span class="n">uWritten</span> <span class="o">+=</span> <span class="n">uUsed</span><span class="p">;</span>
		<span class="n">uLeft</span> <span class="o">=</span> <span class="p">(</span><span class="n">uUsed</span> <span class="o">&lt;=</span> <span class="n">uLeft</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">uLeft</span> <span class="o">-</span> <span class="n">uUsed</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">;</span> <span class="cm">/* paranoia */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bUsed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_sq</span><span class="p">.</span><span class="n">rear</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">rear</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_count</span><span class="p">;</span>
			<span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">=</span> <span class="n">bUsed</span><span class="p">;</span>
			<span class="n">write_sq</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* uUsed may have been 0 */</span>

	<span class="n">sq_play</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">uUsed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">?</span> <span class="n">uUsed</span><span class="o">:</span> <span class="n">uWritten</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sq_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retVal</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retVal</span> <span class="o">=</span> <span class="n">sq_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_sq</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retVal</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span> <span class="p">)</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_sq</span><span class="p">.</span><span class="n">action_queue</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_active</span> <span class="o">||</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span> <span class="o">-</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sq_init_waitqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">sound_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">action_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">open_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">sync_queue</span><span class="p">);</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* blocking open() */</span>
<span class="c">static inline void sq_wake_up(struct sound_queue *sq, struct file *file,</span>
<span class="c">			      fmode_t mode)</span>
<span class="c">{</span>
<span class="c">	if (file-&gt;f_mode &amp; mode) {</span>
<span class="c">		sq-&gt;busy = 0; /* CHECK: IS THIS OK??? */</span>
<span class="c">		WAKE_UP(sq-&gt;open_queue);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_open2</span><span class="p">(</span><span class="k">struct</span> <span class="n">sound_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">fmode_t</span> <span class="n">mode</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">numbufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* blocking open() */</span>
<span class="c">			rc = -EBUSY;</span>
<span class="c">			if (file-&gt;f_flags &amp; O_NONBLOCK)</span>
<span class="c">				return rc;</span>
<span class="c">			rc = -EINTR;</span>
<span class="c">			while (sq-&gt;busy) {</span>
<span class="c">				SLEEP(sq-&gt;open_queue);</span>
<span class="c">				if (signal_pending(current))</span>
<span class="c">					return rc;</span>
<span class="c">			}</span>
<span class="c">			rc = 0;</span>
<span class="cp">#else</span>
			<span class="cm">/* OSS manual says we will return EBUSY regardless</span>
<span class="cm">			   of O_NOBLOCK.</span>
<span class="cm">			*/</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Let&#39;s play spot-the-race-condition */</span>

		<span class="cm">/* allocate the default number &amp; size of buffers.</span>
<span class="cm">		   (i.e. specified in _setup() or as module params)</span>
<span class="cm">		   can&#39;t be changed at the moment - but _could_ be perhaps</span>
<span class="cm">		   in the setfragments ioctl.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">((</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">sq_allocate_buffers</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="n">numbufs</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">)))</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"> /* blocking open() */</span>
<span class="c">			sq_wake_up(sq, file, mode);</span>
<span class="cp">#else</span>
			<span class="n">sq</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sq</span><span class="o">-&gt;</span><span class="n">non_blocking</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define write_sq_init_waitqueue()	sq_init_waitqueue(&amp;write_sq)</span>
<span class="cp">#if 0</span><span class="c"> /* blocking open() */</span>
<span class="c">#define write_sq_wake_up(file)		sq_wake_up(&amp;write_sq, file, FMODE_WRITE)</span>
<span class="cp">#endif</span>
<span class="cp">#define write_sq_release_buffers()	sq_release_buffers(&amp;write_sq)</span>
<span class="cp">#define write_sq_open(file)	\</span>
<span class="cp">	sq_open2(&amp;write_sq, file, FMODE_WRITE, numWriteBufs, writeBufSize )</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">write_sq_open</span><span class="p">(</span><span class="n">file</span><span class="p">);</span> <span class="cm">/* checks the f_mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: if O_RDWR, release any resources grabbed by write part */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span> <span class="p">;</span> <span class="cm">/* I think this is what is required by open(2) */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">sq_open</span><span class="p">)</span>
	    <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">sq_open</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">);</span>

	<span class="cm">/* CHECK whether this is sensible - in the case that dsp0 could be opened</span>
<span class="cm">	  O_RDONLY and dsp1 could be opened O_WRONLY</span>
<span class="cm">	*/</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="cm">/* OK. - we should make some attempt at consistency. At least the H&#39;ware</span>
<span class="cm">	   options should be set with a valid mode.  We will make it that the LL</span>
<span class="cm">	   driver must supply defaults for hard &amp; soft params.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shared_resource_owner</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* you can make this AFMT_U8/mono/8K if you want to mimic old</span>
<span class="cm">		   OSS behaviour - while we still have soft translations ;-) */</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_hard</span> <span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef DMASOUND_STRICT_OSS_COMPLIANCE</span>
	<span class="cm">/* none of the current LL drivers can actually do this &quot;native&quot; at the moment</span>
<span class="cm">	   OSS does not really require us to supply /dev/audio if we can&#39;t do it.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">==</span> <span class="n">SND_DEV_AUDIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sound_set_speed</span><span class="p">(</span><span class="mi">8000</span><span class="p">);</span>
		<span class="n">sound_set_stereo</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">sound_set_format</span><span class="p">(</span><span class="n">AFMT_MU_LAW</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sq_reset_output</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sound_silence</span><span class="p">();</span> <span class="cm">/* this _must_ stop DMA, we might be about to lose the buffers */</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* write_sq.front = (write_sq.rear+1) % write_sq.max_count;*/</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">front</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">rear</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="cm">/* same as for set-up */</span>

	<span class="cm">/* OK - we can unlock the parameters and fragment settings */</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">user_frags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">user_frag_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sq_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sq_reset_output</span><span class="p">()</span> <span class="p">;</span>
	<span class="cm">/* we could consider resetting the shared_resources_owner here... but I</span>
<span class="cm">	   think it is probably still rather non-obvious to application writer</span>
<span class="cm">	*/</span>

	<span class="cm">/* we release everything else though */</span>
	<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_fsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dentry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sq_play</span><span class="p">();</span>	<span class="cm">/* there may be an incomplete frame waiting */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SLEEP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">sync_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* While waiting for audio output to drain, an</span>
<span class="cm">			 * interrupt occurred.  Stop audio output immediately</span>
<span class="cm">			 * and clear the queue. */</span>
			<span class="n">sq_reset_output</span><span class="p">();</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;dmasound: Timeout draining output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sq_reset_output</span><span class="p">();</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* flag no sync regardless of whether we had a DSP_POST or not */</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">sq_fsync</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">);</span>

		<span class="n">sq_reset_output</span><span class="p">()</span> <span class="p">;</span> <span class="cm">/* make sure dma is stopped and all is quiet */</span>
		<span class="n">write_sq_release_buffers</span><span class="p">();</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">shared_resource_owner</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* it&#39;s us that has them */</span>
		<span class="n">shared_resource_owner</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_hard</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"> /* blocking open() */</span>
<span class="c">	/* Wake up a process waiting for the queue being released.</span>
<span class="c">	 * Note: There may be several processes waiting for a call</span>
<span class="c">	 * to open() returning. */</span>

<span class="c">	/* Iain: hmm I don&#39;t understand this next comment ... */</span>
<span class="c">	/* There is probably a DOS atack here. They change the mode flag. */</span>
<span class="c">	/* XXX add check here,*/</span>
<span class="c">	read_sq_wake_up(file); /* checks f_mode */</span>
<span class="c">	write_sq_wake_up(file); /* checks f_mode */</span>
<span class="cp">#endif /* blocking open() */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* here we see if we have a right to modify format, channels, size and so on</span>
<span class="cm">   if no-one else has claimed it already then we do...</span>

<span class="cm">   TODO: We might change this to mask O_RDWR such that only one or the other channel</span>
<span class="cm">   is the owner - if we have problems.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">shared_resources_are_mine</span><span class="p">(</span><span class="n">fmode_t</span> <span class="n">md</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shared_resource_owner</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">shared_resource_owner</span> <span class="o">&amp;</span> <span class="n">md</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">shared_resource_owner</span> <span class="o">=</span> <span class="n">md</span> <span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* if either queue is locked we must deny the right to change shared params</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queues_are_quiescent</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check and set a queue&#39;s fragments per user&#39;s wishes...</span>
<span class="cm">   we will check against the pre-defined literals and the actual sizes.</span>
<span class="cm">   This is a bit fraught - because soft translations can mess with our</span>
<span class="cm">   buffer requirements *after* this call - OSS says &quot;call setfrags first&quot;</span>
<span class="cm">*/</span>

<span class="cm">/* It is possible to replace all the -EINVAL returns with an override that</span>
<span class="cm">   just puts the allowable value in.  This may be what many OSS apps require</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_queue_frags</span><span class="p">(</span><span class="k">struct</span> <span class="n">sound_queue</span> <span class="o">*</span><span class="n">sq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sq</span><span class="o">-&gt;</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_DMASOUND</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_core: tried to set_queue_frags on a locked queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MIN_FRAG_SIZE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_FRAG_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">size</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* now in bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">bufSize</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span> <span class="cm">/* this might still not work */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bufs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bufs</span> <span class="o">&gt;</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span><span class="p">)</span> <span class="cm">/* the user is allowed say &quot;don&#39;t care&quot; with 0x7fff */</span>
		<span class="n">bufs</span> <span class="o">=</span> <span class="n">sq</span><span class="o">-&gt;</span><span class="n">numBufs</span> <span class="p">;</span>

	<span class="cm">/* there is, currently, no way to specify max_active separately</span>
<span class="cm">	   from max_count.  This could be a LL driver issue - I guess</span>
<span class="cm">	   if there is a requirement for these values to be different then</span>
<span class="cm">	  we will have to pass that info. up to this level.</span>
<span class="cm">	*/</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frags</span> <span class="o">=</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">max_active</span> <span class="o">=</span> <span class="n">bufs</span> <span class="p">;</span>
	<span class="n">sq</span><span class="o">-&gt;</span><span class="n">user_frag_size</span> <span class="o">=</span> <span class="n">size</span> <span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">nbufs</span><span class="p">;</span>
	<span class="n">audio_buf_info</span> <span class="n">info</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_RESET</span>:
		<span class="n">sq_reset</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETFMTS</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">hardware_afmts</span> <span class="p">;</span> <span class="cm">/* this is what OSS says.. */</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETBLKSIZE</span>:
		<span class="cm">/* this should tell the caller about bytes that the app can</span>
<span class="cm">		   read/write - the app doesn&#39;t care about our internal buffers.</span>
<span class="cm">		   We force sq_setup() here as per OSS 1.1 (which should</span>
<span class="cm">		   compute the values necessary).</span>
<span class="cm">		   Since there is no mechanism to specify read/write separately, for</span>
<span class="cm">		   fds opened O_RDWR, the write_sq values will, arbitrarily, overwrite</span>
<span class="cm">		   the read_sq ones.</span>
<span class="cm">		*/</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span> <span class="p">)</span>
				<span class="n">sq_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_sq</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">user_frag_size</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_POST</span>:
		<span class="cm">/* all we are going to do is to tell the LL that any</span>
<span class="cm">		   partial frags can be queued for output.</span>
<span class="cm">		   The LL will have to clear this flag when last output</span>
<span class="cm">		   is queued.</span>
<span class="cm">		*/</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span> <span class="o">|=</span> <span class="mh">0x2</span> <span class="p">;</span>
		<span class="n">sq_play</span><span class="p">()</span> <span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SYNC</span>:
		<span class="cm">/* This call, effectively, has the same behaviour as SNDCTL_DSP_RESET</span>
<span class="cm">		   except that it waits for output to finish before resetting</span>
<span class="cm">		   everything - read, however, is killed immediately.</span>
<span class="cm">		*/</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">sq_fsync</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="p">);</span>
			<span class="n">sq_reset_output</span><span class="p">()</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* if we are the shared resource owner then release them */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">shared_resource_owner</span><span class="p">)</span>
			<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">result</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_RATE</span>:
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SPEED</span>:
		<span class="cm">/* changing this on the fly will have weird effects on the sound.</span>
<span class="cm">		   Where there are rate conversions implemented in soft form - it</span>
<span class="cm">		   will cause the _ctx_xxx() functions to be substituted.</span>
<span class="cm">		   However, there doesn&#39;t appear to be any reason to dis-allow it from</span>
<span class="cm">		   a driver pov.</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shared_resources_are_mine</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">sound_set_speed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="cm">/* OSS says these next 4 actions are undefined when the device is</span>
<span class="cm">	   busy/active - we will just return -EINVAL.</span>
<span class="cm">	   To be allowed to change one - (a) you have to own the right</span>
<span class="cm">	    (b) the queue(s) must be quiescent</span>
<span class="cm">	*/</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_STEREO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">shared_resources_are_mine</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">queues_are_quiescent</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">sound_set_stereo</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_WRITE_CHANNELS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">shared_resources_are_mine</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">queues_are_quiescent</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="cm">/* the user might ask for 20 channels, we will return 1 or 2 */</span>
			<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">sound_set_stereo</span><span class="p">(</span><span class="n">data</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFMT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">shared_resources_are_mine</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">queues_are_quiescent</span><span class="p">())</span> <span class="p">{</span>
		    	<span class="kt">int</span> <span class="n">format</span><span class="p">;</span>
			<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="n">format</span> <span class="o">=</span> <span class="n">sound_set_format</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">!=</span> <span class="n">AFMT_QUERY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SUBDIVIDE</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFRAGMENT</span>:
		<span class="cm">/* we can do this independently for the two queues - with the</span>
<span class="cm">		   proviso that for fds opened O_RDWR we cannot separate the</span>
<span class="cm">		   actions and both queues will be set per the last call.</span>
<span class="cm">		   NOTE: this does *NOT* actually set the queue up - merely</span>
<span class="cm">		   registers our intentions.</span>
<span class="cm">		*/</span>
		<span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">nbufs</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span> <span class="p">;</span> <span class="cm">/* 0x7fff is &#39;use maximum&#39; */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">set_queue_frags</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_sq</span><span class="p">,</span> <span class="n">nbufs</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">result</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* NOTE: this return value is irrelevant - OSS specifically says that</span>
<span class="cm">		   the value is &#39;random&#39; and that the user _must_ check the actual</span>
<span class="cm">		   frags values using SNDCTL_DSP_GETBLKSIZE or similar */</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOSPACE</span>:
		<span class="cm">/*</span>
<span class="cm">		*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span> <span class="p">)</span>
				<span class="n">sq_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_sq</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_active</span> <span class="o">-</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fragstotal</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_active</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">user_frag_size</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">*</span> <span class="n">info</span><span class="p">.</span><span class="n">fragsize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETCAPS</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">mixer_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">sq_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sq_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">sq_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">sq_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">sq_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">sq_unlocked_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sq_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">sq_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sq_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sq_fops</span><span class="p">;</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">int</span> <span class="n">sq_unit</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">sq_unit</span> <span class="o">=</span> <span class="n">register_sound_dsp</span><span class="p">(</span><span class="n">fops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sq_unit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dmasound_core: couldn&#39;t register fops</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">sq_unit</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_sq_init_waitqueue</span><span class="p">();</span>

	<span class="cm">/* These parameters will be restored for every clean open()</span>
<span class="cm">	 * in the case of multiple open()s (e.g. dsp0 &amp; dsp1) they</span>
<span class="cm">	 * will be set so long as the shared resources have no owner.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shared_resource_owner</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_hard</span> <span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="p">;</span>
		<span class="n">shared_resources_initialised</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>


    <span class="cm">/*</span>
<span class="cm">     *  /dev/sndstat</span>
<span class="cm">     */</span>

<span class="cm">/* we allow more space for record-enabled because there are extra output lines.</span>
<span class="cm">   the number here must include the amount we are prepared to give to the low-level</span>
<span class="cm">   driver.</span>
<span class="cm">*/</span>

<span class="cp">#define STAT_BUFF_LEN 768</span>

<span class="cm">/* this is how much space we will allow the low-level driver to use</span>
<span class="cm">   in the stat buffer.  Currently, 2 * (80 character line + &lt;NL&gt;).</span>
<span class="cm">   We do not police this (it is up to the ll driver to be honest).</span>
<span class="cm">*/</span>

<span class="cp">#define LOW_LEVEL_STAT_ALLOC 162</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">busy</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">STAT_BUFF_LEN</span><span class="p">];</span>	<span class="cm">/* state.buf should not overflow! */</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">state</span><span class="p">;</span>

<span class="cm">/* publish this function for use by low-level code, if required */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_afmt_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">afmt</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">afmt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">AFMT_MU_LAW</span>:
                <span class="k">return</span> <span class="s">&quot;mu-law&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_A_LAW</span>:
                <span class="k">return</span> <span class="s">&quot;A-law&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_U8</span>:
                <span class="k">return</span> <span class="s">&quot;unsigned 8 bit&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_S8</span>:
                <span class="k">return</span> <span class="s">&quot;signed 8 bit&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_S16_BE</span>:
                <span class="k">return</span> <span class="s">&quot;signed 16 bit BE&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_U16_BE</span>:
                <span class="k">return</span> <span class="s">&quot;unsigned 16 bit BE&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_S16_LE</span>:
                <span class="k">return</span> <span class="s">&quot;signed 16 bit LE&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">AFMT_U16_LE</span>:
                <span class="k">return</span> <span class="s">&quot;unsigned 16 bit LE&quot;</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="s">&quot;format not set&quot;</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
            <span class="nl">default:</span>
                <span class="k">break</span> <span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&quot;ERROR: Unsupported AFMT_XXXX code&quot;</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">busy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">state</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;%sDMA sound driver rev %03d :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">DMASOUND_CORE_REVISION</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">version</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;Core driver edition %02d.%02d : %s driver edition %02d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DMASOUND_CORE_REVISION</span><span class="p">,</span> <span class="n">DMASOUND_CORE_EDITION</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">name2</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">;</span>

	<span class="cm">/* call the low-level module to fill in any stat info. that it has</span>
<span class="cm">	   if present.  Maximum buffer usage is specified.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">state_info</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">state_info</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">LOW_LEVEL_STAT_ALLOC</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* make usage of the state buffer as deterministic as poss.</span>
<span class="cm">	   exceptional conditions could cause overrun - and this is flagged as</span>
<span class="cm">	   a kernel error.</span>
<span class="cm">	*/</span>

	<span class="cm">/* formats and settings */</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s"> === Formats &amp; settings ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;Parameter %20s%20s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;soft&quot;</span><span class="p">,</span><span class="s">&quot;hard&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;Format   :%20s%20s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">get_afmt_string</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span><span class="p">),</span>
		<span class="n">get_afmt_string</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">format</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;Samp Rate:%14d s/sec%14d s/sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;Channels :%20s%20s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span> <span class="o">?</span> <span class="s">&quot;stereo&quot;</span> <span class="o">:</span> <span class="s">&quot;mono&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span> <span class="o">?</span> <span class="s">&quot;stereo&quot;</span> <span class="o">:</span> <span class="s">&quot;mono&quot;</span> <span class="p">);</span>

	<span class="cm">/* sound queue status */</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\t\t</span><span class="s"> === Sound Queue status ===</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;Allocated:%8s%6s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;Buffers&quot;</span><span class="p">,</span><span class="s">&quot;Size&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;%9s:%8d%6d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">numBufs</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">bufSize</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;Current  : MaxFrg FragSiz MaxAct Frnt Rear &quot;</span>
		<span class="s">&quot;Cnt RrSize A B S L  xruns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span><span class="s">&quot;%9s:%7d%8d%7d%5d%5d%4d%7d%2d%2d%2d%2d%7d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_count</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span><span class="p">,</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">max_active</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">front</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">rear</span><span class="p">,</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">,</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">busy</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">locked</span><span class="p">,</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">xruns</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef DEBUG_DMASOUND</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound: stat buffer used %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">STAT_BUFF_LEN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dmasound_core: stat buffer overflowed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">state</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="n">state</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmasound_core_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">state_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			  <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="n">state</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">state</span><span class="p">.</span><span class="n">ptr</span><span class="p">],</span> <span class="n">n</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">state_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">state_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">state_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">state_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef MODULE</span>
	<span class="kt">int</span> <span class="n">state_unit</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">state_unit</span> <span class="o">=</span> <span class="n">register_sound_special</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state_fops</span><span class="p">,</span> <span class="n">SND_DEV_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_unit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">state_unit</span> <span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>


    <span class="cm">/*</span>
<span class="cm">     *  Config &amp; Setup</span>
<span class="cm">     *</span>
<span class="cm">     *  This function is called by _one_ chipset-specific driver</span>
<span class="cm">     */</span>

<span class="kt">int</span> <span class="nf">dmasound_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="p">;</span>
<span class="cp">#ifdef MODULE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_installed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set up sound queue, /dev/audio and /dev/dsp. */</span>

	<span class="cm">/* Set default settings. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">sq_init</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span> <span class="p">;</span>

	<span class="cm">/* Set up /dev/sndstat. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">state_init</span><span class="p">())</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span> <span class="p">;</span>

	<span class="cm">/* Set up /dev/mixer. */</span>
	<span class="n">mixer_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">irqinit</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DMA sound driver: Interrupt initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef MODULE</span>
	<span class="n">irq_installed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s DMA sound driver rev %03d installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">DMASOUND_CORE_REVISION</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">version</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;Core driver edition %02d.%02d : %s driver edition %02d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">DMASOUND_CORE_REVISION</span><span class="p">,</span> <span class="n">DMASOUND_CORE_EDITION</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">name2</span><span class="p">,</span>
		<span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Write will use %4d fragments of %7d bytes as default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">numWriteBufs</span><span class="p">,</span> <span class="n">writeBufSize</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>

<span class="kt">void</span> <span class="nf">dmasound_deinit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_installed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sound_silence</span><span class="p">();</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">irqcleanup</span><span class="p">();</span>
		<span class="n">irq_installed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">write_sq_release_buffers</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixer_unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">unregister_sound_mixer</span><span class="p">(</span><span class="n">mixer_unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">unregister_sound_special</span><span class="p">(</span><span class="n">state_unit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sq_unit</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">unregister_sound_dsp</span><span class="p">(</span><span class="n">sq_unit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmasound_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

	<span class="cm">/* check the bootstrap parameter for &quot;dmasound=&quot; */</span>

	<span class="cm">/* FIXME: other than in the most naive of cases there is no sense in these</span>
<span class="cm">	 *	  buffers being other than powers of two.  This is not checked yet.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_CATCH_RADIUS</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_setup: invalid catch radius, using default = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">catchRadius</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">catchRadius</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_BUFFERS</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_setup: invalid number of buffers, using default = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">numWriteBufs</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">numWriteBufs</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="cm">/* check for small buffer specs */</span>
			<span class="n">size</span> <span class="o">&lt;&lt;=</span> <span class="mi">10</span> <span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MIN_BUFSIZE</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_BUFSIZE</span><span class="p">)</span>
                        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_setup: invalid write buffer size, using default = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">writeBufSize</span><span class="p">);</span>
                <span class="k">else</span>
                        <span class="n">writeBufSize</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;dmasound_setup: invalid number of arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;dmasound=&quot;</span><span class="p">,</span> <span class="n">dmasound_setup</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* !MODULE */</span><span class="cp"></span>

    <span class="cm">/*</span>
<span class="cm">     *  Conversion tables</span>
<span class="cm">     */</span>

<span class="cp">#ifdef HAS_8BIT_TABLES</span>
<span class="cm">/* 8 bit mu-law */</span>

<span class="kt">char</span> <span class="n">dmasound_ulaw2dma8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">-</span><span class="mi">126</span><span class="p">,</span>	<span class="o">-</span><span class="mi">122</span><span class="p">,</span>	<span class="o">-</span><span class="mi">118</span><span class="p">,</span>	<span class="o">-</span><span class="mi">114</span><span class="p">,</span>	<span class="o">-</span><span class="mi">110</span><span class="p">,</span>	<span class="o">-</span><span class="mi">106</span><span class="p">,</span>	<span class="o">-</span><span class="mi">102</span><span class="p">,</span>	<span class="o">-</span><span class="mi">98</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">94</span><span class="p">,</span>	<span class="o">-</span><span class="mi">90</span><span class="p">,</span>	<span class="o">-</span><span class="mi">86</span><span class="p">,</span>	<span class="o">-</span><span class="mi">82</span><span class="p">,</span>	<span class="o">-</span><span class="mi">78</span><span class="p">,</span>	<span class="o">-</span><span class="mi">74</span><span class="p">,</span>	<span class="o">-</span><span class="mi">70</span><span class="p">,</span>	<span class="o">-</span><span class="mi">66</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">63</span><span class="p">,</span>	<span class="o">-</span><span class="mi">61</span><span class="p">,</span>	<span class="o">-</span><span class="mi">59</span><span class="p">,</span>	<span class="o">-</span><span class="mi">57</span><span class="p">,</span>	<span class="o">-</span><span class="mi">55</span><span class="p">,</span>	<span class="o">-</span><span class="mi">53</span><span class="p">,</span>	<span class="o">-</span><span class="mi">51</span><span class="p">,</span>	<span class="o">-</span><span class="mi">49</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">47</span><span class="p">,</span>	<span class="o">-</span><span class="mi">45</span><span class="p">,</span>	<span class="o">-</span><span class="mi">43</span><span class="p">,</span>	<span class="o">-</span><span class="mi">41</span><span class="p">,</span>	<span class="o">-</span><span class="mi">39</span><span class="p">,</span>	<span class="o">-</span><span class="mi">37</span><span class="p">,</span>	<span class="o">-</span><span class="mi">35</span><span class="p">,</span>	<span class="o">-</span><span class="mi">33</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">31</span><span class="p">,</span>	<span class="o">-</span><span class="mi">30</span><span class="p">,</span>	<span class="o">-</span><span class="mi">29</span><span class="p">,</span>	<span class="o">-</span><span class="mi">28</span><span class="p">,</span>	<span class="o">-</span><span class="mi">27</span><span class="p">,</span>	<span class="o">-</span><span class="mi">26</span><span class="p">,</span>	<span class="o">-</span><span class="mi">25</span><span class="p">,</span>	<span class="o">-</span><span class="mi">24</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">23</span><span class="p">,</span>	<span class="o">-</span><span class="mi">22</span><span class="p">,</span>	<span class="o">-</span><span class="mi">21</span><span class="p">,</span>	<span class="o">-</span><span class="mi">20</span><span class="p">,</span>	<span class="o">-</span><span class="mi">19</span><span class="p">,</span>	<span class="o">-</span><span class="mi">18</span><span class="p">,</span>	<span class="o">-</span><span class="mi">17</span><span class="p">,</span>	<span class="o">-</span><span class="mi">16</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">16</span><span class="p">,</span>	<span class="o">-</span><span class="mi">15</span><span class="p">,</span>	<span class="o">-</span><span class="mi">15</span><span class="p">,</span>	<span class="o">-</span><span class="mi">14</span><span class="p">,</span>	<span class="o">-</span><span class="mi">14</span><span class="p">,</span>	<span class="o">-</span><span class="mi">13</span><span class="p">,</span>	<span class="o">-</span><span class="mi">13</span><span class="p">,</span>	<span class="o">-</span><span class="mi">12</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">12</span><span class="p">,</span>	<span class="o">-</span><span class="mi">11</span><span class="p">,</span>	<span class="o">-</span><span class="mi">11</span><span class="p">,</span>	<span class="o">-</span><span class="mi">10</span><span class="p">,</span>	<span class="o">-</span><span class="mi">10</span><span class="p">,</span>	<span class="o">-</span><span class="mi">9</span><span class="p">,</span>	<span class="o">-</span><span class="mi">9</span><span class="p">,</span>	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">125</span><span class="p">,</span>	<span class="mi">121</span><span class="p">,</span>	<span class="mi">117</span><span class="p">,</span>	<span class="mi">113</span><span class="p">,</span>	<span class="mi">109</span><span class="p">,</span>	<span class="mi">105</span><span class="p">,</span>	<span class="mi">101</span><span class="p">,</span>	<span class="mi">97</span><span class="p">,</span>
	<span class="mi">93</span><span class="p">,</span>	<span class="mi">89</span><span class="p">,</span>	<span class="mi">85</span><span class="p">,</span>	<span class="mi">81</span><span class="p">,</span>	<span class="mi">77</span><span class="p">,</span>	<span class="mi">73</span><span class="p">,</span>	<span class="mi">69</span><span class="p">,</span>	<span class="mi">65</span><span class="p">,</span>
	<span class="mi">62</span><span class="p">,</span>	<span class="mi">60</span><span class="p">,</span>	<span class="mi">58</span><span class="p">,</span>	<span class="mi">56</span><span class="p">,</span>	<span class="mi">54</span><span class="p">,</span>	<span class="mi">52</span><span class="p">,</span>	<span class="mi">50</span><span class="p">,</span>	<span class="mi">48</span><span class="p">,</span>
	<span class="mi">46</span><span class="p">,</span>	<span class="mi">44</span><span class="p">,</span>	<span class="mi">42</span><span class="p">,</span>	<span class="mi">40</span><span class="p">,</span>	<span class="mi">38</span><span class="p">,</span>	<span class="mi">36</span><span class="p">,</span>	<span class="mi">34</span><span class="p">,</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="mi">30</span><span class="p">,</span>	<span class="mi">29</span><span class="p">,</span>	<span class="mi">28</span><span class="p">,</span>	<span class="mi">27</span><span class="p">,</span>	<span class="mi">26</span><span class="p">,</span>	<span class="mi">25</span><span class="p">,</span>	<span class="mi">24</span><span class="p">,</span>	<span class="mi">23</span><span class="p">,</span>
	<span class="mi">22</span><span class="p">,</span>	<span class="mi">21</span><span class="p">,</span>	<span class="mi">20</span><span class="p">,</span>	<span class="mi">19</span><span class="p">,</span>	<span class="mi">18</span><span class="p">,</span>	<span class="mi">17</span><span class="p">,</span>	<span class="mi">16</span><span class="p">,</span>	<span class="mi">15</span><span class="p">,</span>
	<span class="mi">15</span><span class="p">,</span>	<span class="mi">14</span><span class="p">,</span>	<span class="mi">14</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span>	<span class="mi">11</span><span class="p">,</span>
	<span class="mi">11</span><span class="p">,</span>	<span class="mi">10</span><span class="p">,</span>	<span class="mi">10</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span>	<span class="mi">7</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span>	<span class="mi">7</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>
	<span class="mi">5</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>
	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span>
<span class="p">};</span>

<span class="cm">/* 8 bit A-law */</span>

<span class="kt">char</span> <span class="n">dmasound_alaw2dma8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">-</span><span class="mi">22</span><span class="p">,</span>	<span class="o">-</span><span class="mi">21</span><span class="p">,</span>	<span class="o">-</span><span class="mi">24</span><span class="p">,</span>	<span class="o">-</span><span class="mi">23</span><span class="p">,</span>	<span class="o">-</span><span class="mi">18</span><span class="p">,</span>	<span class="o">-</span><span class="mi">17</span><span class="p">,</span>	<span class="o">-</span><span class="mi">20</span><span class="p">,</span>	<span class="o">-</span><span class="mi">19</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">30</span><span class="p">,</span>	<span class="o">-</span><span class="mi">29</span><span class="p">,</span>	<span class="o">-</span><span class="mi">32</span><span class="p">,</span>	<span class="o">-</span><span class="mi">31</span><span class="p">,</span>	<span class="o">-</span><span class="mi">26</span><span class="p">,</span>	<span class="o">-</span><span class="mi">25</span><span class="p">,</span>	<span class="o">-</span><span class="mi">28</span><span class="p">,</span>	<span class="o">-</span><span class="mi">27</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">11</span><span class="p">,</span>	<span class="o">-</span><span class="mi">11</span><span class="p">,</span>	<span class="o">-</span><span class="mi">12</span><span class="p">,</span>	<span class="o">-</span><span class="mi">12</span><span class="p">,</span>	<span class="o">-</span><span class="mi">9</span><span class="p">,</span>	<span class="o">-</span><span class="mi">9</span><span class="p">,</span>	<span class="o">-</span><span class="mi">10</span><span class="p">,</span>	<span class="o">-</span><span class="mi">10</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">15</span><span class="p">,</span>	<span class="o">-</span><span class="mi">15</span><span class="p">,</span>	<span class="o">-</span><span class="mi">16</span><span class="p">,</span>	<span class="o">-</span><span class="mi">16</span><span class="p">,</span>	<span class="o">-</span><span class="mi">13</span><span class="p">,</span>	<span class="o">-</span><span class="mi">13</span><span class="p">,</span>	<span class="o">-</span><span class="mi">14</span><span class="p">,</span>	<span class="o">-</span><span class="mi">14</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">86</span><span class="p">,</span>	<span class="o">-</span><span class="mi">82</span><span class="p">,</span>	<span class="o">-</span><span class="mi">94</span><span class="p">,</span>	<span class="o">-</span><span class="mi">90</span><span class="p">,</span>	<span class="o">-</span><span class="mi">70</span><span class="p">,</span>	<span class="o">-</span><span class="mi">66</span><span class="p">,</span>	<span class="o">-</span><span class="mi">78</span><span class="p">,</span>	<span class="o">-</span><span class="mi">74</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">118</span><span class="p">,</span>	<span class="o">-</span><span class="mi">114</span><span class="p">,</span>	<span class="o">-</span><span class="mi">126</span><span class="p">,</span>	<span class="o">-</span><span class="mi">122</span><span class="p">,</span>	<span class="o">-</span><span class="mi">102</span><span class="p">,</span>	<span class="o">-</span><span class="mi">98</span><span class="p">,</span>	<span class="o">-</span><span class="mi">110</span><span class="p">,</span>	<span class="o">-</span><span class="mi">106</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">43</span><span class="p">,</span>	<span class="o">-</span><span class="mi">41</span><span class="p">,</span>	<span class="o">-</span><span class="mi">47</span><span class="p">,</span>	<span class="o">-</span><span class="mi">45</span><span class="p">,</span>	<span class="o">-</span><span class="mi">35</span><span class="p">,</span>	<span class="o">-</span><span class="mi">33</span><span class="p">,</span>	<span class="o">-</span><span class="mi">39</span><span class="p">,</span>	<span class="o">-</span><span class="mi">37</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">59</span><span class="p">,</span>	<span class="o">-</span><span class="mi">57</span><span class="p">,</span>	<span class="o">-</span><span class="mi">63</span><span class="p">,</span>	<span class="o">-</span><span class="mi">61</span><span class="p">,</span>	<span class="o">-</span><span class="mi">51</span><span class="p">,</span>	<span class="o">-</span><span class="mi">49</span><span class="p">,</span>	<span class="o">-</span><span class="mi">55</span><span class="p">,</span>	<span class="o">-</span><span class="mi">53</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>	<span class="o">-</span><span class="mi">2</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>	<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">6</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>	<span class="o">-</span><span class="mi">5</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>	<span class="o">-</span><span class="mi">8</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>	<span class="o">-</span><span class="mi">7</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>	<span class="o">-</span><span class="mi">3</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>	<span class="o">-</span><span class="mi">4</span><span class="p">,</span>
	<span class="mi">21</span><span class="p">,</span>	<span class="mi">20</span><span class="p">,</span>	<span class="mi">23</span><span class="p">,</span>	<span class="mi">22</span><span class="p">,</span>	<span class="mi">17</span><span class="p">,</span>	<span class="mi">16</span><span class="p">,</span>	<span class="mi">19</span><span class="p">,</span>	<span class="mi">18</span><span class="p">,</span>
	<span class="mi">29</span><span class="p">,</span>	<span class="mi">28</span><span class="p">,</span>	<span class="mi">31</span><span class="p">,</span>	<span class="mi">30</span><span class="p">,</span>	<span class="mi">25</span><span class="p">,</span>	<span class="mi">24</span><span class="p">,</span>	<span class="mi">27</span><span class="p">,</span>	<span class="mi">26</span><span class="p">,</span>
	<span class="mi">10</span><span class="p">,</span>	<span class="mi">10</span><span class="p">,</span>	<span class="mi">11</span><span class="p">,</span>	<span class="mi">11</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span>	<span class="mi">8</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span>	<span class="mi">9</span><span class="p">,</span>
	<span class="mi">14</span><span class="p">,</span>	<span class="mi">14</span><span class="p">,</span>	<span class="mi">15</span><span class="p">,</span>	<span class="mi">15</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span>	<span class="mi">12</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span>	<span class="mi">13</span><span class="p">,</span>
	<span class="mi">86</span><span class="p">,</span>	<span class="mi">82</span><span class="p">,</span>	<span class="mi">94</span><span class="p">,</span>	<span class="mi">90</span><span class="p">,</span>	<span class="mi">70</span><span class="p">,</span>	<span class="mi">66</span><span class="p">,</span>	<span class="mi">78</span><span class="p">,</span>	<span class="mi">74</span><span class="p">,</span>
	<span class="mi">118</span><span class="p">,</span>	<span class="mi">114</span><span class="p">,</span>	<span class="mi">126</span><span class="p">,</span>	<span class="mi">122</span><span class="p">,</span>	<span class="mi">102</span><span class="p">,</span>	<span class="mi">98</span><span class="p">,</span>	<span class="mi">110</span><span class="p">,</span>	<span class="mi">106</span><span class="p">,</span>
	<span class="mi">43</span><span class="p">,</span>	<span class="mi">41</span><span class="p">,</span>	<span class="mi">47</span><span class="p">,</span>	<span class="mi">45</span><span class="p">,</span>	<span class="mi">35</span><span class="p">,</span>	<span class="mi">33</span><span class="p">,</span>	<span class="mi">39</span><span class="p">,</span>	<span class="mi">37</span><span class="p">,</span>
	<span class="mi">59</span><span class="p">,</span>	<span class="mi">57</span><span class="p">,</span>	<span class="mi">63</span><span class="p">,</span>	<span class="mi">61</span><span class="p">,</span>	<span class="mi">51</span><span class="p">,</span>	<span class="mi">49</span><span class="p">,</span>	<span class="mi">55</span><span class="p">,</span>	<span class="mi">53</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>	<span class="mi">1</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">5</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>	<span class="mi">5</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>	<span class="mi">4</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span>	<span class="mi">7</span><span class="p">,</span>	<span class="mi">7</span><span class="p">,</span>	<span class="mi">7</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>	<span class="mi">6</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>	<span class="mi">2</span><span class="p">,</span>
	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span><span class="p">,</span>	<span class="mi">3</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* HAS_8BIT_TABLES */</span><span class="cp"></span>

    <span class="cm">/*</span>
<span class="cm">     *  Visible symbols for modules</span>
<span class="cm">     */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound_init</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound_deinit</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound_write_sq</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound_catchRadius</span><span class="p">);</span>
<span class="cp">#ifdef HAS_8BIT_TABLES</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound_ulaw2dma8</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">dmasound_alaw2dma8</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
