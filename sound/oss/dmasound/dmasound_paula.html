<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › dmasound › dmasound_paula.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dmasound_paula.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  linux/sound/oss/dmasound/dmasound_paula.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Amiga `Paula&#39; DMA Sound Driver</span>
<span class="cm"> *</span>
<span class="cm"> *  See linux/sound/oss/dmasound/dmasound_core.c for copyright and credits</span>
<span class="cm"> *  prior to 28/01/2001</span>
<span class="cm"> *</span>
<span class="cm"> *  28/01/2001 [0.1] Iain Sandoe</span>
<span class="cm"> *		     - added versioning</span>
<span class="cm"> *		     - put in and populated the hardware_afmts field.</span>
<span class="cm"> *             [0.2] - put in SNDCTL_DSP_GETCAPS value.</span>
<span class="cm"> *	       [0.3] - put in constraint on state buffer usage.</span>
<span class="cm"> *	       [0.4] - put in default hard/soft settings</span>
<span class="cm">*/</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/soundcard.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/setup.h&gt;</span>
<span class="cp">#include &lt;asm/amigahw.h&gt;</span>
<span class="cp">#include &lt;asm/amigaints.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>

<span class="cp">#include &quot;dmasound.h&quot;</span>

<span class="cp">#define DMASOUND_PAULA_REVISION 0</span>
<span class="cp">#define DMASOUND_PAULA_EDITION 4</span>

<span class="cp">#define custom amiga_custom</span>
   <span class="cm">/*</span>
<span class="cm">    *	The minimum period for audio depends on htotal (for OCS/ECS/AGA)</span>
<span class="cm">    *	(Imported from arch/m68k/amiga/amisound.c)</span>
<span class="cm">    */</span>

<span class="k">extern</span> <span class="k">volatile</span> <span class="n">u_short</span> <span class="n">amiga_audio_min_period</span><span class="p">;</span>


   <span class="cm">/*</span>
<span class="cm">    *	amiga_mksound() should be able to restore the period after beeping</span>
<span class="cm">    *	(Imported from arch/m68k/amiga/amisound.c)</span>
<span class="cm">    */</span>

<span class="k">extern</span> <span class="n">u_short</span> <span class="n">amiga_audio_period</span><span class="p">;</span>


   <span class="cm">/*</span>
<span class="cm">    *	Audio DMA masks</span>
<span class="cm">    */</span>

<span class="cp">#define AMI_AUDIO_OFF	(DMAF_AUD0 | DMAF_AUD1 | DMAF_AUD2 | DMAF_AUD3)</span>
<span class="cp">#define AMI_AUDIO_8	(DMAF_SETCLR | DMAF_MASTER | DMAF_AUD0 | DMAF_AUD1)</span>
<span class="cp">#define AMI_AUDIO_14	(AMI_AUDIO_8 | DMAF_AUD2 | DMAF_AUD3)</span>


    <span class="cm">/*</span>
<span class="cm">     *  Helper pointers for 16(14)-bit sound</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">write_sq_block_size_half</span><span class="p">,</span> <span class="n">write_sq_block_size_quarter</span><span class="p">;</span>


<span class="cm">/*** Low level stuff *********************************************************/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">AmiAlloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiFree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiIrqInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiIrqCleanUp</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiSilence</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiSetFormat</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiSetVolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiSetTreble</span><span class="p">(</span><span class="kt">int</span> <span class="n">treble</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiPlayNextFrame</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiPlay</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">AmiInterrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_HEARTBEAT</span>

    <span class="cm">/*</span>
<span class="cm">     *  Heartbeat interferes with sound since the 7 kHz low-pass filter and the</span>
<span class="cm">     *  power LED are controlled by the same line.</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">saved_heartbeat</span><span class="p">)(</span><span class="kt">int</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">disable_heartbeat</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mach_heartbeat</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">saved_heartbeat</span> <span class="o">=</span> <span class="n">mach_heartbeat</span><span class="p">;</span>
	    <span class="n">mach_heartbeat</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">AmiSetTreble</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">enable_heartbeat</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_heartbeat</span><span class="p">)</span>
	    <span class="n">mach_heartbeat</span> <span class="o">=</span> <span class="n">saved_heartbeat</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_HEARTBEAT */</span><span class="cp"></span>
<span class="cp">#define disable_heartbeat()	do { } while (0)</span>
<span class="cp">#define enable_heartbeat()	do { } while (0)</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_HEARTBEAT */</span><span class="cp"></span>


<span class="cm">/*** Mid level stuff *********************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">AmiMixerInit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiWriteSqSetup</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">AmiStateInfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">space</span><span class="p">);</span>


<span class="cm">/*** Translations ************************************************************/</span>

<span class="cm">/* ++TeSche: radically changed for new expanding purposes...</span>
<span class="cm"> *</span>
<span class="cm"> * These two routines now deal with copying/expanding/translating the samples</span>
<span class="cm"> * from user space into our buffer at the right frequency. They take care about</span>
<span class="cm"> * how much data there&#39;s actually to read, how much buffer space there is and</span>
<span class="cm"> * to convert samples into the right frequency/encoding. They will only work on</span>
<span class="cm"> * complete samples so it may happen they leave some bytes in the input stream</span>
<span class="cm"> * if the user didn&#39;t write a multiple of the current sample size. They both</span>
<span class="cm"> * return the number of bytes they&#39;ve used from both streams so you may detect</span>
<span class="cm"> * such a situation. Luckily all programs should be able to cope with that.</span>
<span class="cm"> *</span>
<span class="cm"> * I think I&#39;ve optimized anything as far as one can do in plain C, all</span>
<span class="cm"> * variables should fit in registers and the loops are really short. There&#39;s</span>
<span class="cm"> * one loop for every possible situation. Writing a more generalized and thus</span>
<span class="cm"> * parameterized loop would only produce slower code. Feel free to optimize</span>
<span class="cm"> * this in assembler if you like. :)</span>
<span class="cm"> *</span>
<span class="cm"> * I think these routines belong here because they&#39;re not yet really hardware</span>
<span class="cm"> * independent, especially the fact that the Falcon can play 16bit samples</span>
<span class="cm"> * only in stereo is hardcoded in both of them!</span>
<span class="cm"> *</span>
<span class="cm"> * ++geert: split in even more functions (one per format)</span>
<span class="cm"> */</span>


    <span class="cm">/*</span>
<span class="cm">     *  Native format</span>
<span class="cm">     */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ami_ct_s8</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userPtr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">userCount</span><span class="p">,</span>
			 <span class="n">u_char</span> <span class="n">frame</span><span class="p">[],</span> <span class="kt">ssize_t</span> <span class="o">*</span><span class="n">frameUsed</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">frameLeft</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">used</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="p">];</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">userPtr</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="o">*</span><span class="n">frameUsed</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">u_char</span> <span class="o">*</span><span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="o">+</span><span class="n">write_sq_block_size_half</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="n">userCount</span><span class="p">,</span> <span class="n">frameLeft</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">count</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="o">*</span><span class="n">left</span><span class="o">++</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">)</span>
			    <span class="o">||</span> <span class="n">get_user</span><span class="p">(</span><span class="o">*</span><span class="n">right</span><span class="o">++</span><span class="p">,</span> <span class="n">userPtr</span><span class="o">++</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">frameUsed</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">used</span><span class="p">;</span>
<span class="p">}</span>


    <span class="cm">/*</span>
<span class="cm">     *  Copy and convert 8 bit data</span>
<span class="cm">     */</span>

<span class="cp">#define GENERATE_AMI_CT8(funcname, convsample)				\</span>
<span class="cp">static ssize_t funcname(const u_char __user *userPtr, size_t userCount,	\</span>
<span class="cp">			u_char frame[], ssize_t *frameUsed,		\</span>
<span class="cp">			ssize_t frameLeft)				\</span>
<span class="cp">{									\</span>
<span class="cp">	ssize_t count, used;						\</span>
<span class="cp">									\</span>
<span class="cp">	if (!dmasound.soft.stereo) {					\</span>
<span class="cp">		u_char *p = &amp;frame[*frameUsed];				\</span>
<span class="cp">		count = min_t(size_t, userCount, frameLeft) &amp; ~1;	\</span>
<span class="cp">		used = count;						\</span>
<span class="cp">		while (count &gt; 0) {					\</span>
<span class="cp">			u_char data;					\</span>
<span class="cp">			if (get_user(data, userPtr++))			\</span>
<span class="cp">				return -EFAULT;				\</span>
<span class="cp">			*p++ = convsample(data);			\</span>
<span class="cp">			count--;					\</span>
<span class="cp">		}							\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		u_char *left = &amp;frame[*frameUsed&gt;&gt;1];			\</span>
<span class="cp">		u_char *right = left+write_sq_block_size_half;		\</span>
<span class="cp">		count = min_t(size_t, userCount, frameLeft)&gt;&gt;1 &amp; ~1;	\</span>
<span class="cp">		used = count*2;						\</span>
<span class="cp">		while (count &gt; 0) {					\</span>
<span class="cp">			u_char data;					\</span>
<span class="cp">			if (get_user(data, userPtr++))			\</span>
<span class="cp">				return -EFAULT;				\</span>
<span class="cp">			*left++ = convsample(data);			\</span>
<span class="cp">			if (get_user(data, userPtr++))			\</span>
<span class="cp">				return -EFAULT;				\</span>
<span class="cp">			*right++ = convsample(data);			\</span>
<span class="cp">			count--;					\</span>
<span class="cp">		}							\</span>
<span class="cp">	}								\</span>
<span class="cp">	*frameUsed += used;						\</span>
<span class="cp">	return used;							\</span>
<span class="cp">}</span>

<span class="cp">#define AMI_CT_ULAW(x)	(dmasound_ulaw2dma8[(x)])</span>
<span class="cp">#define AMI_CT_ALAW(x)	(dmasound_alaw2dma8[(x)])</span>
<span class="cp">#define AMI_CT_U8(x)	((x) ^ 0x80)</span>

<span class="n">GENERATE_AMI_CT8</span><span class="p">(</span><span class="n">ami_ct_ulaw</span><span class="p">,</span> <span class="n">AMI_CT_ULAW</span><span class="p">)</span>
<span class="n">GENERATE_AMI_CT8</span><span class="p">(</span><span class="n">ami_ct_alaw</span><span class="p">,</span> <span class="n">AMI_CT_ALAW</span><span class="p">)</span>
<span class="n">GENERATE_AMI_CT8</span><span class="p">(</span><span class="n">ami_ct_u8</span><span class="p">,</span> <span class="n">AMI_CT_U8</span><span class="p">)</span>


    <span class="cm">/*</span>
<span class="cm">     *  Copy and convert 16 bit data</span>
<span class="cm">     */</span>

<span class="cp">#define GENERATE_AMI_CT_16(funcname, convsample)			\</span>
<span class="cp">static ssize_t funcname(const u_char __user *userPtr, size_t userCount,	\</span>
<span class="cp">			u_char frame[], ssize_t *frameUsed,		\</span>
<span class="cp">			ssize_t frameLeft)				\</span>
<span class="cp">{									\</span>
<span class="cp">	const u_short __user *ptr = (const u_short __user *)userPtr;	\</span>
<span class="cp">	ssize_t count, used;						\</span>
<span class="cp">	u_short data;							\</span>
<span class="cp">									\</span>
<span class="cp">	if (!dmasound.soft.stereo) {					\</span>
<span class="cp">		u_char *high = &amp;frame[*frameUsed&gt;&gt;1];			\</span>
<span class="cp">		u_char *low = high+write_sq_block_size_half;		\</span>
<span class="cp">		count = min_t(size_t, userCount, frameLeft)&gt;&gt;1 &amp; ~1;	\</span>
<span class="cp">		used = count*2;						\</span>
<span class="cp">		while (count &gt; 0) {					\</span>
<span class="cp">			if (get_user(data, ptr++))			\</span>
<span class="cp">				return -EFAULT;				\</span>
<span class="cp">			data = convsample(data);			\</span>
<span class="cp">			*high++ = data&gt;&gt;8;				\</span>
<span class="cp">			*low++ = (data&gt;&gt;2) &amp; 0x3f;			\</span>
<span class="cp">			count--;					\</span>
<span class="cp">		}							\</span>
<span class="cp">	} else {							\</span>
<span class="cp">		u_char *lefth = &amp;frame[*frameUsed&gt;&gt;2];			\</span>
<span class="cp">		u_char *leftl = lefth+write_sq_block_size_quarter;	\</span>
<span class="cp">		u_char *righth = lefth+write_sq_block_size_half;	\</span>
<span class="cp">		u_char *rightl = righth+write_sq_block_size_quarter;	\</span>
<span class="cp">		count = min_t(size_t, userCount, frameLeft)&gt;&gt;2 &amp; ~1;	\</span>
<span class="cp">		used = count*4;						\</span>
<span class="cp">		while (count &gt; 0) {					\</span>
<span class="cp">			if (get_user(data, ptr++))			\</span>
<span class="cp">				return -EFAULT;				\</span>
<span class="cp">			data = convsample(data);			\</span>
<span class="cp">			*lefth++ = data&gt;&gt;8;				\</span>
<span class="cp">			*leftl++ = (data&gt;&gt;2) &amp; 0x3f;			\</span>
<span class="cp">			if (get_user(data, ptr++))			\</span>
<span class="cp">				return -EFAULT;				\</span>
<span class="cp">			data = convsample(data);			\</span>
<span class="cp">			*righth++ = data&gt;&gt;8;				\</span>
<span class="cp">			*rightl++ = (data&gt;&gt;2) &amp; 0x3f;			\</span>
<span class="cp">			count--;					\</span>
<span class="cp">		}							\</span>
<span class="cp">	}								\</span>
<span class="cp">	*frameUsed += used;						\</span>
<span class="cp">	return used;							\</span>
<span class="cp">}</span>

<span class="cp">#define AMI_CT_S16BE(x)	(x)</span>
<span class="cp">#define AMI_CT_U16BE(x)	((x) ^ 0x8000)</span>
<span class="cp">#define AMI_CT_S16LE(x)	(le2be16((x)))</span>
<span class="cp">#define AMI_CT_U16LE(x)	(le2be16((x)) ^ 0x8000)</span>

<span class="n">GENERATE_AMI_CT_16</span><span class="p">(</span><span class="n">ami_ct_s16be</span><span class="p">,</span> <span class="n">AMI_CT_S16BE</span><span class="p">)</span>
<span class="n">GENERATE_AMI_CT_16</span><span class="p">(</span><span class="n">ami_ct_u16be</span><span class="p">,</span> <span class="n">AMI_CT_U16BE</span><span class="p">)</span>
<span class="n">GENERATE_AMI_CT_16</span><span class="p">(</span><span class="n">ami_ct_s16le</span><span class="p">,</span> <span class="n">AMI_CT_S16LE</span><span class="p">)</span>
<span class="n">GENERATE_AMI_CT_16</span><span class="p">(</span><span class="n">ami_ct_u16le</span><span class="p">,</span> <span class="n">AMI_CT_U16LE</span><span class="p">)</span>


<span class="k">static</span> <span class="n">TRANS</span> <span class="n">transAmiga</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ct_ulaw</span>	<span class="o">=</span> <span class="n">ami_ct_ulaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_alaw</span>	<span class="o">=</span> <span class="n">ami_ct_alaw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s8</span>		<span class="o">=</span> <span class="n">ami_ct_s8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u8</span>		<span class="o">=</span> <span class="n">ami_ct_u8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s16be</span>	<span class="o">=</span> <span class="n">ami_ct_s16be</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u16be</span>	<span class="o">=</span> <span class="n">ami_ct_u16be</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_s16le</span>	<span class="o">=</span> <span class="n">ami_ct_s16le</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ct_u16le</span>	<span class="o">=</span> <span class="n">ami_ct_u16le</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*** Low level stuff *********************************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">StopDMA</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">AMI_AUDIO_OFF</span><span class="p">;</span>
	<span class="n">enable_heartbeat</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">AmiAlloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">amiga_chip_alloc</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="s">&quot;dmasound [Paula]&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">AmiFree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">obj</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amiga_chip_free</span> <span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">AmiIrqInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* turn off DMA for audio channels */</span>
	<span class="n">StopDMA</span><span class="p">();</span>

	<span class="cm">/* Register interrupt handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_AUD0</span><span class="p">,</span> <span class="n">AmiInterrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;DMA sound&quot;</span><span class="p">,</span>
			<span class="n">AmiInterrupt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">AmiIrqCleanUp</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* turn off DMA for audio channels */</span>
	<span class="n">StopDMA</span><span class="p">();</span>
	<span class="cm">/* release the interrupt */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">IRQ_AMIGA_AUD0</span><span class="p">,</span> <span class="n">AmiInterrupt</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">AmiSilence</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* turn off DMA for audio channels */</span>
	<span class="n">StopDMA</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">AmiInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">AmiSilence</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">amiga_colorclock</span><span class="o">/</span><span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">speed</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">amiga_audio_min_period</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">trans_write</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transAmiga</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&lt;</span> <span class="n">amiga_audio_min_period</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we would need to squeeze the sound, but we won&#39;t do that */</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">amiga_audio_min_period</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">period</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">amiga_colorclock</span><span class="o">/</span><span class="p">(</span><span class="n">period</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">audper</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">amiga_audio_period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">AmiSetFormat</span><span class="p">(</span><span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Amiga sound DMA supports 8bit and 16bit (pseudo 14 bit) modes */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AFMT_QUERY</span>:
		<span class="k">return</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_MU_LAW</span>:
	<span class="k">case</span> <span class="n">AFMT_A_LAW</span>:
	<span class="k">case</span> <span class="n">AFMT_U8</span>:
	<span class="k">case</span> <span class="n">AFMT_S8</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AFMT_S16_BE</span>:
	<span class="k">case</span> <span class="n">AFMT_U16_BE</span>:
	<span class="k">case</span> <span class="n">AFMT_S16_LE</span>:
	<span class="k">case</span> <span class="n">AFMT_U16_LE</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* :-) */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">minDev</span> <span class="o">==</span> <span class="n">SND_DEV_DSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
		<span class="n">dmasound</span><span class="p">.</span><span class="n">dsp</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">AmiInit</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">format</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define VOLUME_VOXWARE_TO_AMI(v) \</span>
<span class="cp">	(((v) &lt; 0) ? 0 : ((v) &gt; 100) ? 64 : ((v) * 64)/100)</span>
<span class="cp">#define VOLUME_AMI_TO_VOXWARE(v) ((v)*100/64)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AmiSetVolume</span><span class="p">(</span><span class="kt">int</span> <span class="n">volume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="n">VOLUME_VOXWARE_TO_AMI</span><span class="p">(</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="n">VOLUME_VOXWARE_TO_AMI</span><span class="p">((</span><span class="n">volume</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">VOLUME_AMI_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">)</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">VOLUME_AMI_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AmiSetTreble</span><span class="p">(</span><span class="kt">int</span> <span class="n">treble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span> <span class="o">=</span> <span class="n">treble</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">treble</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">ciaa</span><span class="p">.</span><span class="n">pra</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ciaa</span><span class="p">.</span><span class="n">pra</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">treble</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define AMI_PLAY_LOADED		1</span>
<span class="cp">#define AMI_PLAY_PLAYING	2</span>
<span class="cp">#define AMI_PLAY_MASK		3</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">AmiPlayNextFrame</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">ch0</span><span class="p">,</span> <span class="o">*</span><span class="n">ch1</span><span class="p">,</span> <span class="o">*</span><span class="n">ch2</span><span class="p">,</span> <span class="o">*</span><span class="n">ch3</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* used by AmiPlay() if all doubts whether there really is something</span>
<span class="cm">	 * to be played are already wiped out.</span>
<span class="cm">	 */</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">write_sq</span><span class="p">.</span><span class="n">front</span><span class="p">];</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">index</span> <span class="o">?</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span>
					<span class="o">:</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">stereo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch0</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">ch1</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="n">write_sq_block_size_half</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ch0</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">ch1</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disable_heartbeat</span><span class="p">();</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">ch0</span><span class="p">);</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">ch1</span><span class="p">);</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">AMI_AUDIO_8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">ch0</span><span class="p">);</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">ch1</span><span class="p">);</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">==</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We can play pseudo 14-bit only with the maximum volume */</span>
			<span class="n">ch3</span> <span class="o">=</span> <span class="n">ch0</span><span class="o">+</span><span class="n">write_sq_block_size_quarter</span><span class="p">;</span>
			<span class="n">ch2</span> <span class="o">=</span> <span class="n">ch1</span><span class="o">+</span><span class="n">write_sq_block_size_quarter</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* we are being affected by the beeps */</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* restoring volume here helps a bit */</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">ch2</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audlc</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">ZTWO_PADDR</span><span class="p">(</span><span class="n">ch3</span><span class="p">);</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audlen</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">AMI_AUDIO_14</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">custom</span><span class="p">.</span><span class="n">dmacon</span> <span class="o">=</span> <span class="n">AMI_AUDIO_8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">front</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">front</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">max_count</span><span class="p">;</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">|=</span> <span class="n">AMI_PLAY_LOADED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">AmiPlay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minframes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_AUD0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">AMI_PLAY_LOADED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* There&#39;s already a frame loaded */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_AUD0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">AMI_PLAY_PLAYING</span><span class="p">)</span>
		<span class="cm">/* Increase threshold: frame 1 is already being played */</span>
		<span class="n">minframes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">minframes</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nothing to do */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_AUD0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="n">minframes</span> <span class="o">&amp;&amp;</span>
	    <span class="n">write_sq</span><span class="p">.</span><span class="n">rear_size</span> <span class="o">&lt;</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">syncing</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hmmm, the only existing frame is not</span>
<span class="cm">		 * yet filled and we&#39;re not syncing?</span>
<span class="cm">		 */</span>
		<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_AUD0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AmiPlayNextFrame</span><span class="p">(</span><span class="n">minframes</span><span class="p">);</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_AUD0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">AmiInterrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minframes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_AUD0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Playing was interrupted and sq_reset() has already cleared</span>
<span class="cm">		 * the sq variables, so better don&#39;t do anything here.</span>
<span class="cm">		 */</span>
		<span class="n">WAKE_UP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">sync_queue</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">AMI_PLAY_PLAYING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We&#39;ve just finished a frame */</span>
		<span class="n">write_sq</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">WAKE_UP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">action_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">&amp;</span> <span class="n">AMI_PLAY_LOADED</span><span class="p">)</span>
		<span class="cm">/* Increase threshold: frame 1 is already being played */</span>
		<span class="n">minframes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Shift the flags */</span>
	<span class="n">write_sq</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AMI_PLAY_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span>
		<span class="cm">/* No frame is playing, disable audio DMA */</span>
		<span class="n">StopDMA</span><span class="p">();</span>

	<span class="n">custom</span><span class="p">.</span><span class="n">intena</span> <span class="o">=</span> <span class="n">IF_SETCLR</span> <span class="o">|</span> <span class="n">IF_AUD0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">minframes</span><span class="p">)</span>
		<span class="cm">/* Try to play the next frame */</span>
		<span class="n">AmiPlay</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_sq</span><span class="p">.</span><span class="n">active</span><span class="p">)</span>
		<span class="cm">/* Nothing to play anymore.</span>
<span class="cm">		   Wake up a process waiting for audio output to drain. */</span>
		<span class="n">WAKE_UP</span><span class="p">(</span><span class="n">write_sq</span><span class="p">.</span><span class="n">sync_queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*** Mid level stuff *********************************************************/</span>


<span class="cm">/*</span>
<span class="cm"> * /dev/mixer abstraction</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">AmiMixerInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* For pseudo 14bit */</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">;</span>
	<span class="n">custom</span><span class="p">.</span><span class="n">aud</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">audvol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* For pseudo 14bit */</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AmiMixerIoctl</span><span class="p">(</span><span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_DEVMASK</span>:
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_MASK_VOLUME</span> <span class="o">|</span> <span class="n">SOUND_MASK_TREBLE</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_RECMASK</span>:
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_STEREODEVS</span>:
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">SOUND_MASK_VOLUME</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_VOLUME</span>:
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span>
			    <span class="n">VOLUME_AMI_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">VOLUME_AMI_TO_VOXWARE</span><span class="p">(</span><span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_VOLUME</span>:
		    <span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound_set_volume</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_READ_TREBLE</span>:
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound</span><span class="p">.</span><span class="n">treble</span><span class="p">);</span>
	    <span class="k">case</span> <span class="n">SOUND_MIXER_WRITE_TREBLE</span>:
		    <span class="n">IOCTL_IN</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		    <span class="k">return</span> <span class="n">IOCTL_OUT</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">dmasound_set_treble</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">AmiWriteSqSetup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_sq_block_size_half</span> <span class="o">=</span> <span class="n">write_sq</span><span class="p">.</span><span class="n">block_size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">write_sq_block_size_quarter</span> <span class="o">=</span> <span class="n">write_sq_block_size_half</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">AmiStateInfo</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">sound.volume_left = %d [0...64]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_left</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">sound.volume_right = %d [0...64]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dmasound</span><span class="p">.</span><span class="n">volume_right</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">space</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;dmasound_paula: overflowed state buffer alloc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">space</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*** Machine definitions *****************************************************/</span>

<span class="k">static</span> <span class="n">SETTINGS</span> <span class="n">def_hard</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">format</span>	<span class="o">=</span> <span class="n">AFMT_S8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed</span>	<span class="o">=</span> <span class="mi">8000</span>
<span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="n">SETTINGS</span> <span class="n">def_soft</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">format</span>	<span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">speed</span>	<span class="o">=</span> <span class="mi">8000</span>
<span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="n">MACHINE</span> <span class="n">machAmiga</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Amiga&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name2</span>		<span class="o">=</span> <span class="s">&quot;AMIGA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_alloc</span>	<span class="o">=</span> <span class="n">AmiAlloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dma_free</span>	<span class="o">=</span> <span class="n">AmiFree</span><span class="p">,</span>
	<span class="p">.</span><span class="n">irqinit</span>	<span class="o">=</span> <span class="n">AmiIrqInit</span><span class="p">,</span>
<span class="cp">#ifdef MODULE</span>
	<span class="p">.</span><span class="n">irqcleanup</span>	<span class="o">=</span> <span class="n">AmiIrqCleanUp</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">AmiInit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">silence</span>	<span class="o">=</span> <span class="n">AmiSilence</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setFormat</span>	<span class="o">=</span> <span class="n">AmiSetFormat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setVolume</span>	<span class="o">=</span> <span class="n">AmiSetVolume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setTreble</span>	<span class="o">=</span> <span class="n">AmiSetTreble</span><span class="p">,</span>
	<span class="p">.</span><span class="n">play</span>		<span class="o">=</span> <span class="n">AmiPlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_init</span>	<span class="o">=</span> <span class="n">AmiMixerInit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mixer_ioctl</span>	<span class="o">=</span> <span class="n">AmiMixerIoctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_sq_setup</span>	<span class="o">=</span> <span class="n">AmiWriteSqSetup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">state_info</span>	<span class="o">=</span> <span class="n">AmiStateInfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">min_dsp_speed</span>	<span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="p">((</span><span class="n">DMASOUND_PAULA_REVISION</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">DMASOUND_PAULA_EDITION</span><span class="p">),</span>
	<span class="p">.</span><span class="n">hardware_afmts</span>	<span class="o">=</span> <span class="p">(</span><span class="n">AFMT_S8</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span><span class="p">),</span> <span class="cm">/* h&#39;ware-supported formats *only* here */</span>
	<span class="p">.</span><span class="n">capabilities</span>	<span class="o">=</span> <span class="n">DSP_CAP_BATCH</span>          <span class="cm">/* As per SNDCTL_DSP_GETCAPS */</span>
<span class="p">};</span>


<span class="cm">/*** Config &amp; Setup **********************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amiga_audio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span> <span class="o">=</span> <span class="n">machAmiga</span><span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_hard</span> <span class="o">=</span> <span class="n">def_hard</span> <span class="p">;</span>
	<span class="n">dmasound</span><span class="p">.</span><span class="n">mach</span><span class="p">.</span><span class="n">default_soft</span> <span class="o">=</span> <span class="n">def_soft</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">dmasound_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">amiga_audio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmasound_deinit</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">amiga_audio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">amiga_audio_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;amiga-audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amiga_audio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amiga_audio_driver</span><span class="p">,</span> <span class="n">amiga_audio_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amiga_audio_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amiga_audio_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amiga_audio_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">amiga_audio_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:amiga-audio&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
