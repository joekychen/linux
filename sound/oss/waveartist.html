<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › waveartist.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>waveartist.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/sound/oss/waveartist.c</span>
<span class="cm"> *</span>
<span class="cm"> * The low level driver for the RWA010 Rockwell Wave Artist</span>
<span class="cm"> * codec chip used in the Rebel.com NetWinder.</span>
<span class="cm"> *</span>
<span class="cm"> * Cleaned up and integrated into 2.1 by Russell King (rmk@arm.linux.org.uk)</span>
<span class="cm"> * and Pat Beirne (patb@corel.ca)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) by Rebel.com 1998-1999</span>
<span class="cm"> *</span>
<span class="cm"> * RWA010 specs received under NDA from Rockwell</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:</span>
<span class="cm"> * 11-10-2000	Bartlomiej Zolnierkiewicz &lt;bkz@linux-ide.org&gt;</span>
<span class="cm"> *		Added __init to waveartist_init()</span>
<span class="cm"> */</span>

<span class="cm">/* Debugging */</span>
<span class="cp">#define DEBUG_CMD	1</span>
<span class="cp">#define DEBUG_OUT	2</span>
<span class="cp">#define DEBUG_IN	4</span>
<span class="cp">#define DEBUG_INTR	8</span>
<span class="cp">#define DEBUG_MIXER	16</span>
<span class="cp">#define DEBUG_TRIGGER	32</span>

<span class="cp">#define debug_flg (0)</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>


<span class="cp">#include &quot;sound_config.h&quot;</span>
<span class="cp">#include &quot;waveartist.h&quot;</span>

<span class="cp">#ifdef CONFIG_ARM</span>
<span class="cp">#include &lt;mach/hardware.h&gt;</span>
<span class="cp">#include &lt;asm/mach-types.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef NO_DMA</span>
<span class="cp">#define NO_DMA	255</span>
<span class="cp">#endif</span>

<span class="cp">#define SUPPORTED_MIXER_DEVICES		(SOUND_MASK_SYNTH      |\</span>
<span class="cp">					 SOUND_MASK_PCM        |\</span>
<span class="cp">					 SOUND_MASK_LINE       |\</span>
<span class="cp">					 SOUND_MASK_MIC        |\</span>
<span class="cp">					 SOUND_MASK_LINE1      |\</span>
<span class="cp">					 SOUND_MASK_RECLEV     |\</span>
<span class="cp">					 SOUND_MASK_VOLUME     |\</span>
<span class="cp">					 SOUND_MASK_IMIX)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x5555</span><span class="p">,</span>		<span class="cm">/* Master Volume	 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Bass			 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Treble		 */</span>
	<span class="mh">0x2323</span><span class="p">,</span>		<span class="cm">/* Synth (FM)		 */</span>
	<span class="mh">0x4b4b</span><span class="p">,</span>		<span class="cm">/* PCM			 */</span>
	<span class="mh">0x6464</span><span class="p">,</span>		<span class="cm">/* PC Speaker		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Ext Line		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Mic			 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* CD			 */</span>
	<span class="mh">0x6464</span><span class="p">,</span>		<span class="cm">/* Recording monitor	 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* SB PCM (ALT PCM)	 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Recording level	 */</span>
	<span class="mh">0x6464</span><span class="p">,</span>		<span class="cm">/* Input gain		 */</span>
	<span class="mh">0x6464</span><span class="p">,</span>		<span class="cm">/* Output gain		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Line1 (Aux1)		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Line2 (Aux2)		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Line3 (Aux3)		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Digital1		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Digital2		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Digital3		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Phone In		 */</span>
	<span class="mh">0x6464</span><span class="p">,</span>		<span class="cm">/* Phone Out		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Video		 */</span>
	<span class="mh">0x0000</span><span class="p">,</span>		<span class="cm">/* Radio		 */</span>
	<span class="mh">0x0000</span>		<span class="cm">/* Monitor		 */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_info</span>  <span class="n">hw</span><span class="p">;</span>	<span class="cm">/* hardware */</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">chip_name</span><span class="p">;</span>

	<span class="kt">int</span>		<span class="n">xfer_count</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">audio_mode</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">open_mode</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">audio_flags</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">record_dev</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">playback_dev</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">dev_no</span><span class="p">;</span>

	<span class="cm">/* Mixer parameters */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">waveartist_mixer_info</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="o">*</span><span class="n">levels</span><span class="p">;</span>	   <span class="cm">/* cache of volume settings   */</span>
	<span class="kt">int</span>		<span class="n">recmask</span><span class="p">;</span>	   <span class="cm">/* currently enabled recording device! */</span>

<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>
	<span class="kt">signed</span> <span class="kt">int</span>	<span class="n">slider_vol</span><span class="p">;</span>	   <span class="cm">/* hardware slider volume     */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">handset_detect</span>	<span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">telephone_detect</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">no_autoselect</span>	<span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* handset/telephone autoselects a path */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">spkr_mute_state</span>	<span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* set by ioctl or autoselect */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">line_mute_state</span>	<span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* set by ioctl or autoselect */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">use_slider</span>	<span class="o">:</span><span class="mi">1</span><span class="p">;</span><span class="cm">/* use slider setting for o/p vol */</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="n">wavnc_info</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This is the implementation specific mixer information.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">waveartist_mixer_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">supported_devs</span><span class="p">;</span>	   <span class="cm">/* Supported devices */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">recording_devs</span><span class="p">;</span>	   <span class="cm">/* Recordable devies */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">stereo_devs</span><span class="p">;</span>	   <span class="cm">/* Stereo devices	*/</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">select_input</span><span class="p">)(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">decode_mixer</span><span class="p">)(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">get_mixer</span><span class="p">)(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">wavnc_port_info</span> <span class="p">{</span>
	<span class="kt">int</span>		<span class="n">open_mode</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">speed</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">channels</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">audio_format</span><span class="p">;</span>
<span class="p">}</span> <span class="n">wavnc_port_info</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>		<span class="n">nr_waveartist_devs</span><span class="p">;</span>
<span class="k">static</span> <span class="n">wavnc_info</span>	<span class="n">adev_info</span><span class="p">[</span><span class="n">MAX_AUDIO_DEV</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">waveartist_lock</span><span class="p">);</span>

<span class="cp">#ifndef CONFIG_ARCH_NETWINDER</span>
<span class="cp">#define machine_is_netwinder() 0</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">vnc_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vnc_configure_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input_mask</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vnc_private_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vnc_slider_tick</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">waveartist_set_ctlr</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">clear</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctlr_port</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CTLR</span><span class="p">;</span>

	<span class="n">clear</span> <span class="o">=</span> <span class="o">~</span><span class="n">clear</span> <span class="o">&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">ctlr_port</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">clear</span> <span class="o">|</span> <span class="n">set</span><span class="p">,</span> <span class="n">ctlr_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Toggle IRQ acknowledge line</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">waveartist_iack</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctlr_port</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CTLR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_ctlr</span><span class="p">;</span>

	<span class="n">old_ctlr</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ctlr_port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IRQ_ACK</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">old_ctlr</span> <span class="o">|</span> <span class="n">IRQ_ACK</span><span class="p">,</span> <span class="n">ctlr_port</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">old_ctlr</span><span class="p">,</span> <span class="n">ctlr_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">waveartist_sleep</span><span class="p">(</span><span class="kt">int</span> <span class="n">timeout_ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout_ms</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_reset</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">waveartist_set_ctlr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">RESET</span><span class="p">);</span>
	<span class="n">waveartist_sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">waveartist_set_ctlr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMD_RF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CMDR</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mh">0x55aa</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;WaveArtist: reset timeout &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;(res=%04X)&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Helper function to send and receive words</span>
<span class="cm"> * from WaveArtist.  It handles all the handshaking</span>
<span class="cm"> * and can send or receive multiple words.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_cmd</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">nr_cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">nr_resp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_base</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;waveartist_cmd: cmd=&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%04X &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMD_RF</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">old_data</span><span class="p">;</span>

		<span class="cm">/* flush the port</span>
<span class="cm">		 */</span>

		<span class="n">old_data</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CMDR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_CMD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;flushed %04X...&quot;</span><span class="p">,</span> <span class="n">old_data</span><span class="p">);</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">timed_out</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMD_WE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">outw</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">io_base</span> <span class="o">+</span> <span class="n">CMDR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">timed_out</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_resp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">count</span><span class="p">;</span> <span class="n">count</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CMD_RF</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CMDR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timed_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;waveartist_cmd: resp=&quot;</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_resp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%04X &quot;</span><span class="p">,</span> <span class="n">resp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;waveartist_cmd: timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">timed_out</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send one command word</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">waveartist_cmd1</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">waveartist_cmd</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send one command, receive one word</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">waveartist_cmd1_r</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">waveartist_cmd</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a double command, receive one</span>
<span class="cm"> * word (and throw it away)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">waveartist_cmd2</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">waveartist_cmd</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vals</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a triple command</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">waveartist_cmd3</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">waveartist_cmd</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_getrev</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">WACMD_GETREV</span><span class="p">;</span>

	<span class="n">waveartist_cmd</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">rev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">rev</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">rev</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">waveartist_halt_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">waveartist_halt_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">waveartist_halt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">waveartist_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_audiodevs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">devc</span>  <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">||</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span>  <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span>  <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">waveartist_trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">record_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">playback_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_close</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">waveartist_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span><span class="p">;</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_output_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">count</span> <span class="o">=</span> <span class="n">__count</span><span class="p">;</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_OUT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;waveartist: output block, buf=0x%lx, count=0x%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * 16 bit data</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">intrflag</span> <span class="o">&amp;&amp;</span>
	    <span class="n">count</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">			 * Auto DMA mode on. No need to react</span>
<span class="cm">			 */</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set sample count</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTSIZE</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_start_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">count</span> <span class="o">=</span> <span class="n">__count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_IN</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;waveartist: start input, buf=0x%lx, count=0x%x...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span><span class="p">))</span>	<span class="cm">/* 16 bit data */</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">intrflag</span> <span class="o">&amp;&amp;</span>
	    <span class="n">count</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">			 * Auto DMA mode on. No need to react</span>
<span class="cm">			 */</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set sample count</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTSIZE</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">waveartist_get_speed</span><span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * program the speed, channels, bits</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">8000</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x2E71</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">11025</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">22050</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * non-standard - just calculate</span>
<span class="cm">		 */</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">/</span> <span class="mi">44100</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">waveartist_get_bits</span><span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">==</span> <span class="n">AFMT_S8</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="c1">//default AFMT_U8</span>

	<span class="k">return</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">speed</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">speed</span> <span class="o">=</span> <span class="n">waveartist_get_speed</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>
	<span class="n">bits</span>  <span class="o">=</span> <span class="n">waveartist_get_bits</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTFORMAT</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the &quot;</span>
		       <span class="s">&quot;record format to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTCHANNELS</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting record &quot;</span>
		       <span class="s">&quot;to %d channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * write cmd SetSampleSpeedTimeConstant</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTSPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the record &quot;</span>
		       <span class="s">&quot;speed to %dHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTDMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the record &quot;</span>
		       <span class="s">&quot;data path to 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTFORMAT</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the record &quot;</span>
		       <span class="s">&quot;format to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">waveartist_halt_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WA CTLR reg: 0x%02X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CTLR</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WA STAT reg: 0x%02X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WA IRQS reg: 0x%02X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">IRQSTAT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">speed</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * program the speed, channels, bits</span>
<span class="cm">	 */</span>
	<span class="n">speed</span> <span class="o">=</span> <span class="n">waveartist_get_speed</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>
	<span class="n">bits</span>  <span class="o">=</span> <span class="n">waveartist_get_bits</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTSPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTSPEED</span><span class="p">,</span> <span class="n">speed</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the playback &quot;</span>
		       <span class="s">&quot;speed to %dHz.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTCHANNELS</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the playback &quot;</span>
		       <span class="s">&quot;to %d channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTDMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the playback &quot;</span>
		       <span class="s">&quot;data path to 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_cmd2</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTFORMAT</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: error setting the playback &quot;</span>
		       <span class="s">&quot;format to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">waveartist_halt_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_INTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WA CTLR reg: 0x%02X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">CTLR</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WA STAT reg: 0x%02X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;WA IRQS reg: 0x%02X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">IRQSTAT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_halt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">waveartist_halt_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">waveartist_halt_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_halt_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop capture</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTSTOP</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear interrupt by toggling</span>
<span class="cm">	 * the IRQ_ACK bit in CTRL</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_REQ</span><span class="p">)</span>
		<span class="n">waveartist_iack</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>devc->audio<em>mode &amp;= ~PCM</em>ENABLE_INPUT;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_halt_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTSTOP</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear interrupt by toggling</span>
<span class="cm">	 * the IRQ_ACK bit in CTRL</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_REQ</span><span class="p">)</span>
		<span class="n">waveartist_iack</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>devc->audio<em>mode &amp;= ~PCM</em>ENABLE_OUTPUT;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span>	<span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">wavnc_port_info</span>	<span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_TRIGGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;wavnc: audio trigger &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;in &quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * enable ADC Data Transfer to PC</span>
<span class="cm">		 */</span>
		<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_INPUTSTART</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * enable DAC data transfer from PC</span>
<span class="cm">		 */</span>
		<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_OUTPUTSTART</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">5000</span><span class="p">)</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mi">44100</span><span class="p">)</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>

	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span>
<span class="nf">waveartist_set_channels</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">waveartist_set_bits</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">AFMT_U8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="n">AFMT_S8</span><span class="p">))</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>

	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">waveartist_audio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">waveartist_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">waveartist_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">waveartist_output_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">waveartist_start_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>			<span class="o">=</span> <span class="n">waveartist_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">waveartist_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">waveartist_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">waveartist_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_input</span>		<span class="o">=</span> <span class="n">waveartist_halt_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_output</span>		<span class="o">=</span> <span class="n">waveartist_halt_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">waveartist_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">waveartist_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">waveartist_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">waveartist_set_channels</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">waveartist_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span>	   <span class="n">irqstatus</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">);</span>
	<span class="n">irqstatus</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">IRQSTAT</span><span class="p">);</span>
	<span class="n">status</span>    <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span> <span class="o">+</span> <span class="n">STATR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_INTR</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;waveartist_intr: stat=%02x, irqstat=%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">status</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRQ_REQ</span><span class="p">)</span>	<span class="cm">/* Clear interrupt */</span>
		<span class="n">waveartist_iack</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: unexpected interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* PCM buffer done</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DMA0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DMAbuf_outputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">playback_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DMA1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DMAbuf_inputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">record_dev</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>	<span class="c1">//default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: Unknown interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>We do not use SB mode natively...</p></td><td class="code"><div class="highlight"><pre>		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: Unexpected SB interrupt...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------</span>
<span class="cm"> * Mixer stuff</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mix_ent</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">reg_l</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">reg_r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">max</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mix_ent</span> <span class="n">mix_devs</span><span class="p">[</span><span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_VOLUME   */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_BASS     */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_TREBLE   */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_SYNTH    */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_PCM      */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_SPEAKER  */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_LINE     */</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">3</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_MIC      */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_CD       */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_IMIX     */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_ALTPCM   */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{ 3, 7, 0, 10 }, /* SOUND_MIXER_RECLEV   */</span>
<span class="c">	{ 0, 0, 0,  0 }, /* SOUND_MIXER_IGAIN    */</span>
<span class="cp">#else</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_RECLEV   */</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">7</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_IGAIN    */</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_OGAIN    */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_LINE1    */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">31</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_LINE2    */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_LINE3    */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_DIGITAL1 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_DIGITAL2 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_DIGITAL3 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_PHONEIN  */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_PHONEOUT */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_VIDEO    */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* SOUND_MIXER_RADIO    */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">}</span>  <span class="cm">/* SOUND_MIXER_MONITOR  */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_mixer_update</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichDev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lev_left</span><span class="p">,</span> <span class="n">lev_right</span><span class="p">;</span>

	<span class="n">lev_left</span>  <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">whichDev</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">lev_right</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">whichDev</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lev_left</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">lev_left</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lev_right</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">lev_right</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

<span class="cp">#define SCALE(lev,max)	((lev) * (max) / 100)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_netwinder</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">whichDev</span> <span class="o">==</span> <span class="n">SOUND_MIXER_PHONEOUT</span><span class="p">)</span>
		<span class="n">whichDev</span> <span class="o">=</span> <span class="n">SOUND_MIXER_VOLUME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mix_devs</span><span class="p">[</span><span class="n">whichDev</span><span class="p">].</span><span class="n">reg_l</span> <span class="o">||</span> <span class="n">mix_devs</span><span class="p">[</span><span class="n">whichDev</span><span class="p">].</span><span class="n">reg_r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">mix_ent</span> <span class="o">*</span><span class="n">mix</span> <span class="o">=</span> <span class="n">mix_devs</span> <span class="o">+</span> <span class="n">whichDev</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>

		<span class="n">mask</span> <span class="o">=</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;&lt;</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">lev_left</span>  <span class="o">=</span> <span class="n">SCALE</span><span class="p">(</span><span class="n">lev_left</span><span class="p">,</span>  <span class="n">mix</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="n">lev_right</span> <span class="o">=</span> <span class="n">SCALE</span><span class="p">(</span><span class="n">lev_right</span><span class="p">,</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">mix</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>

		<span class="cm">/* read left setting */</span>
		<span class="n">left</span>  <span class="o">=</span> <span class="n">waveartist_cmd1_r</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_GET_LEVEL</span> <span class="o">|</span>
					       <span class="n">mix</span><span class="o">-&gt;</span><span class="n">reg_l</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="cm">/* read right setting */</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">waveartist_cmd1_r</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_GET_LEVEL</span> <span class="o">|</span>
						<span class="n">mix</span><span class="o">-&gt;</span><span class="n">reg_r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">left</span>  <span class="o">=</span> <span class="p">(</span><span class="n">left</span>  <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lev_left</span>  <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">right</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lev_right</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>

		<span class="cm">/* write left,right back */</span>
		<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">whichDev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_PCM</span>:
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_LEVEL</span><span class="p">,</span>
					<span class="n">SCALE</span><span class="p">(</span><span class="n">lev_left</span><span class="p">,</span>  <span class="mi">32767</span><span class="p">),</span>
					<span class="n">SCALE</span><span class="p">(</span><span class="n">lev_right</span><span class="p">,</span> <span class="mi">32767</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_SYNTH</span>:
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x0100</span> <span class="o">|</span> <span class="n">WACMD_SET_LEVEL</span><span class="p">,</span>
					<span class="n">SCALE</span><span class="p">(</span><span class="n">lev_left</span><span class="p">,</span>  <span class="mi">32767</span><span class="p">),</span>
					<span class="n">SCALE</span><span class="p">(</span><span class="n">lev_right</span><span class="p">,</span> <span class="mi">32767</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the ADC MUX to the specified values.  We do NOT do any</span>
<span class="cm"> * checking of the values passed, since we assume that the</span>
<span class="cm"> * relevant *_select_input function has done that for us.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_set_adc_mux</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">left_dev</span><span class="p">,</span> <span class="kt">char</span> <span class="n">right_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_08</span><span class="p">,</span> <span class="n">reg_09</span><span class="p">;</span>

	<span class="n">reg_08</span> <span class="o">=</span> <span class="n">waveartist_cmd1_r</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_GET_LEVEL</span> <span class="o">|</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="n">reg_09</span> <span class="o">=</span> <span class="n">waveartist_cmd1_r</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_GET_LEVEL</span> <span class="o">|</span> <span class="mh">0x0900</span><span class="p">);</span>

	<span class="n">reg_08</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg_08</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="n">right_dev</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="o">|</span> <span class="n">left_dev</span><span class="p">;</span>

	<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">reg_08</span><span class="p">,</span> <span class="n">reg_09</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decode a recording mask into a mixer selection as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *     OSS Source	WA Source	Actual source</span>
<span class="cm"> *  SOUND_MASK_IMIX	Mixer		Mixer output (same as AD1848)</span>
<span class="cm"> *  SOUND_MASK_LINE	Line		Line in</span>
<span class="cm"> *  SOUND_MASK_LINE1	Aux 1		Aux 1 in</span>
<span class="cm"> *  SOUND_MASK_LINE2	Aux 2		Aux 2 in</span>
<span class="cm"> *  SOUND_MASK_MIC	Mic		Microphone</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">waveartist_select_input</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recmask</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_l</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recdev</span> <span class="o">=</span> <span class="n">ADC_MUX_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_IMIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_IMIX</span><span class="p">;</span>
		<span class="n">recdev</span> <span class="o">=</span> <span class="n">ADC_MUX_MIXER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_LINE2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_LINE2</span><span class="p">;</span>
		<span class="n">recdev</span> <span class="o">=</span> <span class="n">ADC_MUX_AUX2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_LINE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_LINE1</span><span class="p">;</span>
		<span class="n">recdev</span> <span class="o">=</span> <span class="n">ADC_MUX_AUX1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_LINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_LINE</span><span class="p">;</span>
		<span class="n">recdev</span> <span class="o">=</span> <span class="n">ADC_MUX_LINE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_MIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_MIC</span><span class="p">;</span>
		<span class="n">recdev</span> <span class="o">=</span> <span class="n">ADC_MUX_MIC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dev_l</span> <span class="o">=</span> <span class="o">*</span><span class="n">dev_r</span> <span class="o">=</span> <span class="n">recdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">recmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_decode_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lev_l</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lev_r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_VOLUME</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_SYNTH</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_PCM</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_MIC</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_IGAIN</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE1</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE2</span>:
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">lev_l</span> <span class="o">|</span> <span class="n">lev_r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_IMIX</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">waveartist_get_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">waveartist_mixer_info</span> <span class="n">waveartist_mixer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">supported_devs</span>	<span class="o">=</span> <span class="n">SUPPORTED_MIXER_DEVICES</span> <span class="o">|</span> <span class="n">SOUND_MASK_IGAIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recording_devs</span>	<span class="o">=</span> <span class="n">SOUND_MASK_LINE</span>  <span class="o">|</span> <span class="n">SOUND_MASK_MIC</span>   <span class="o">|</span>
			<span class="n">SOUND_MASK_LINE1</span> <span class="o">|</span> <span class="n">SOUND_MASK_LINE2</span> <span class="o">|</span>
			<span class="n">SOUND_MASK_IMIX</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo_devs</span>	<span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_MIXER_DEVICES</span> <span class="o">|</span> <span class="n">SOUND_MASK_IGAIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span>
			<span class="p">(</span><span class="n">SOUND_MASK_SPEAKER</span> <span class="o">|</span> <span class="n">SOUND_MASK_IMIX</span><span class="p">),</span>
	<span class="p">.</span><span class="n">select_input</span>	<span class="o">=</span> <span class="n">waveartist_select_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_mixer</span>	<span class="o">=</span> <span class="n">waveartist_decode_mixer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mixer</span>	<span class="o">=</span> <span class="n">waveartist_get_mixer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_set_recmask</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev_l</span><span class="p">,</span> <span class="n">dev_r</span><span class="p">;</span>

	<span class="n">recmask</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">recording_devs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If more than one recording device selected,</span>
<span class="cm">	 * disable the device that is currently in use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hweight32</span><span class="p">(</span><span class="n">recmask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">recmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Translate the recording device mask into</span>
<span class="cm">	 * the ADC multiplexer settings.</span>
<span class="cm">	 */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">select_input</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">recmask</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev_l</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_r</span><span class="p">);</span>

	<span class="n">waveartist_set_adc_mux</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev_l</span><span class="p">,</span> <span class="n">dev_r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_set_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lev_left</span>  <span class="o">=</span> <span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lev_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lev_left</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">lev_left</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lev_right</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">lev_right</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mono devices have their right volume forced to their</span>
<span class="cm">	 * left volume.  (from ALSA driver OSS emulation).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">stereo_devs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="n">lev_right</span> <span class="o">=</span> <span class="n">lev_left</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">decode_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">lev_left</span><span class="p">,</span> <span class="n">lev_right</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">waveartist_mixer_update</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">dev</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">waveartist_mixer_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">nr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * All SOUND_MIXER_* ioctls use type &#39;M&#39;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_netwinder</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vnc_private_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">nr</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:
			<span class="n">waveartist_set_recmask</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="n">SOUND_MIXER_NRDEVICES</span> <span class="o">&amp;&amp;</span>
			    <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">supported_devs</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nr</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">waveartist_set_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_DEVMASK</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">supported_devs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_STEREODEVS</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">stereo_devs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_RECMASK</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">recording_devs</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_CAPS</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">SOUND_CAP_EXCL_INPUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;</span> <span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span><span class="o">-&gt;</span><span class="n">get_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mixer_operations</span> <span class="n">waveartist_mixer_operations</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="s">&quot;WaveArtist&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;WaveArtist&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>	<span class="o">=</span> <span class="n">waveartist_mixer_ioctl</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waveartist_mixer_reset</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_MIXER</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: mixer_reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset mixer cmd</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_RST_MIXER</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set input for ADC to come from &#39;quiet&#39;</span>
<span class="cm">	 * turn on default modes</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="mh">0x9800</span><span class="p">,</span> <span class="mh">0xa836</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set mixer input select to none, RX filter gains 0 dB</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="mh">0x4c00</span><span class="p">,</span> <span class="mh">0x8c00</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set bit 0 reg 2 to 1 - unmute MonoOut</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="mh">0x2801</span><span class="p">,</span> <span class="mh">0x6800</span><span class="p">);</span>

	<span class="cm">/* set default input device = internal mic</span>
<span class="cm">	 * current recording device = none</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_set_recmask</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">waveartist_mixer_update</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">waveartist_init</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_port_info</span> <span class="o">*</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">rev</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dev_name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">my_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;%s (%s&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waveartist_getrev</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">rev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot; rev. &quot;</span><span class="p">);</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="s">&quot;)&quot;</span><span class="p">);</span>

	<span class="n">conf_printf2</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span>
		     <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span><span class="p">);</span>

	<span class="n">portc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wavnc_port_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">nomem</span><span class="p">;</span>

	<span class="n">my_dev</span> <span class="o">=</span> <span class="n">sound_install_audiodrv</span><span class="p">(</span><span class="n">AUDIO_DRIVER_VERSION</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">waveartist_audio_driver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_driver</span><span class="p">),</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span><span class="p">,</span> <span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_S8</span><span class="p">,</span>
			<span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">my_dev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">audio_devs</span><span class="p">[</span><span class="n">my_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span> <span class="o">=</span> <span class="n">portc</span><span class="p">;</span>

	<span class="n">waveartist_mixer_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear any pending interrupt</span>
<span class="cm">	 */</span>
	<span class="n">waveartist_iack</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">waveartist_intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: IRQ %d in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">uninstall</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Can&#39;t allocate DMA%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">uninstall_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span> <span class="o">!=</span> <span class="n">NO_DMA</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t allocate DMA%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">uninstall_dma</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">waveartist_set_ctlr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DMA1_IE</span> <span class="o">|</span> <span class="n">DMA0_IE</span><span class="p">);</span>

	<span class="n">audio_devs</span><span class="p">[</span><span class="n">my_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span> <span class="o">=</span>
		<span class="n">sound_install_mixer</span><span class="p">(</span><span class="n">MIXER_DRIVER_VERSION</span><span class="p">,</span>
				<span class="n">dev_name</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">waveartist_mixer_operations</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixer_operations</span><span class="p">),</span>
				<span class="n">devc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">my_dev</span><span class="p">;</span>

<span class="nl">uninstall_dma:</span>
	<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

<span class="nl">uninstall_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="p">);</span>

<span class="nl">uninstall:</span>
	<span class="n">sound_unload_audiodev</span><span class="p">(</span><span class="n">my_dev</span><span class="p">);</span>

<span class="nl">free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>

<span class="nl">nomem:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">probe_waveartist</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev_info</span><span class="p">[</span><span class="n">nr_waveartist_devs</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_waveartist_devs</span> <span class="o">&gt;=</span> <span class="n">MAX_AUDIO_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: too many audio devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>  <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;WaveArtist: I/O port conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;WaveArtist: Bad IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;WaveArtist: Bad DMA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;WaveArtist&quot;</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;RWA-010&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">attach_waveartist</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">waveartist_mixer_info</span> <span class="o">*</span><span class="n">mix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev_info</span><span class="p">[</span><span class="n">nr_waveartist_devs</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE! If irq &lt; 0, there is another driver which has allocated the</span>
<span class="cm">	 *   IRQ so that this driver doesn&#39;t need to allocate/deallocate it.</span>
<span class="cm">	 *   The actually used IRQ is ABS(irq).</span>
<span class="cm">	 */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">playback_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">record_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">&amp;&amp;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">!=</span> <span class="n">NO_DMA</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">|=</span> <span class="n">DMA_DUPLEX</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix</span> <span class="o">=</span> <span class="n">mix</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">=</span> <span class="n">waveartist_init</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_netwinder</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnc_timer</span><span class="p">);</span>
			<span class="n">vnc_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">vnc_slider_tick</span><span class="p">;</span>
			<span class="n">vnc_timer</span><span class="p">.</span><span class="n">expires</span>  <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">vnc_timer</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="n">nr_waveartist_devs</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnc_timer</span><span class="p">);</span>

			<span class="n">vnc_configure_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">nr_waveartist_devs</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">unload_waveartist</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_waveartist_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">==</span> <span class="n">adev_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">devc</span> <span class="o">=</span> <span class="n">adev_info</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mixer</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_netwinder</span><span class="p">())</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnc_timer</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

		<span class="n">waveartist_set_ctlr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">DMA1_IE</span><span class="o">|</span><span class="n">DMA0_IE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">irq</span><span class="p">,</span> <span class="n">devc</span><span class="p">);</span>

		<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span> <span class="o">&amp;&amp;</span>
		    <span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span> <span class="o">!=</span> <span class="n">NO_DMA</span><span class="p">)</span>
			<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dma2</span><span class="p">);</span>

		<span class="n">mixer</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sound_unload_mixerdev</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sound_unload_audiodev</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span><span class="p">);</span>

		<span class="n">nr_waveartist_devs</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_waveartist_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adev_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adev_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;waveartist: can&#39;t find device &quot;</span>
		       <span class="s">&quot;to unload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>

<span class="cm">/*</span>
<span class="cm"> * Rebel.com Netwinder specifics...</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/hardware/dec21285.h&gt;</span>
 
<span class="cp">#define	VNC_TIMER_PERIOD (HZ/4)	</span><span class="c1">//check slider 4 times/sec</span>

<span class="cp">#define	MIXER_PRIVATE3_RESET	0x53570000</span>
<span class="cp">#define	MIXER_PRIVATE3_READ	0x53570001</span>
<span class="cp">#define	MIXER_PRIVATE3_WRITE	0x53570002</span>

<span class="cp">#define	VNC_MUTE_INTERNAL_SPKR	0x01	</span><span class="c1">//the sw mute on/off control bit</span>
<span class="cp">#define	VNC_MUTE_LINE_OUT	0x10</span>
<span class="cp">#define VNC_PHONE_DETECT	0x20</span>
<span class="cp">#define VNC_HANDSET_DETECT	0x40</span>
<span class="cp">#define VNC_DISABLE_AUTOSWITCH	0x80</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">vnc_mute_spkr</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nw_gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nw_cpld_modify</span><span class="p">(</span><span class="n">CPLD_UNMUTE</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">CPLD_UNMUTE</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nw_gpio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vnc_mute_lout</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>

	<span class="n">left</span>  <span class="o">=</span> <span class="n">waveartist_cmd1_r</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_GET_LEVEL</span><span class="p">);</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">waveartist_cmd1_r</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_GET_LEVEL</span> <span class="o">|</span> <span class="mh">0x400</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
		
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vnc_volume_slider</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">signed</span> <span class="kt">int</span> <span class="n">old_slider_volume</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">int</span> <span class="n">volume</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="o">*</span><span class="n">CSR_TIMER1_LOAD</span> <span class="o">=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x201</span><span class="p">);</span>
	<span class="o">*</span><span class="n">CSR_TIMER1_CNTL</span> <span class="o">=</span> <span class="n">TIMER_CNTL_ENABLE</span> <span class="o">|</span> <span class="n">TIMER_CNTL_DIV1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0x201</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="n">volume</span><span class="o">--</span><span class="p">;</span>

	<span class="o">*</span><span class="n">CSR_TIMER1_CNTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	
	<span class="n">volume</span> <span class="o">=</span> <span class="mh">0x00ffffff</span> <span class="o">-</span> <span class="o">*</span><span class="n">CSR_TIMER1_VALUE</span><span class="p">;</span>


<span class="cp">#ifndef REVERSE</span>
	<span class="n">volume</span> <span class="o">=</span> <span class="mi">150</span> <span class="o">-</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">volume</span> <span class="o">=</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">25</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">volume</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * slider quite often reads +-8, so debounce this random noise</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">volume</span> <span class="o">-</span> <span class="n">old_slider_volume</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_slider_volume</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug_flg</span> <span class="o">&amp;</span> <span class="n">DEBUG_MIXER</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Slider volume: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">old_slider_volume</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decode a recording mask into a mixer selection on the NetWinder</span>
<span class="cm"> * as follows:</span>
<span class="cm"> *</span>
<span class="cm"> *     OSS Source	WA Source	Actual source</span>
<span class="cm"> *  SOUND_MASK_IMIX	Mixer		Mixer output (same as AD1848)</span>
<span class="cm"> *  SOUND_MASK_LINE	Line		Line in</span>
<span class="cm"> *  SOUND_MASK_LINE1	Left Mic	Handset</span>
<span class="cm"> *  SOUND_MASK_PHONEIN	Left Aux	Telephone microphone</span>
<span class="cm"> *  SOUND_MASK_MIC	Right Mic	Builtin microphone</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">netwinder_select_input</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recmask</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_l</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recdev_l</span> <span class="o">=</span> <span class="n">ADC_MUX_NONE</span><span class="p">,</span> <span class="n">recdev_r</span> <span class="o">=</span> <span class="n">ADC_MUX_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_IMIX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_IMIX</span><span class="p">;</span>
		<span class="n">recdev_l</span> <span class="o">=</span> <span class="n">ADC_MUX_MIXER</span><span class="p">;</span>
		<span class="n">recdev_r</span> <span class="o">=</span> <span class="n">ADC_MUX_MIXER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_LINE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_LINE</span><span class="p">;</span>
		<span class="n">recdev_l</span> <span class="o">=</span> <span class="n">ADC_MUX_LINE</span><span class="p">;</span>
		<span class="n">recdev_r</span> <span class="o">=</span> <span class="n">ADC_MUX_LINE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_LINE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_LINE1</span><span class="p">;</span>
		<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MONO</span><span class="p">);</span> <span class="cm">/* left */</span>
		<span class="n">recdev_l</span> <span class="o">=</span> <span class="n">ADC_MUX_MIC</span><span class="p">;</span>
		<span class="n">recdev_r</span> <span class="o">=</span> <span class="n">ADC_MUX_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_PHONEIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_PHONEIN</span><span class="p">;</span>
		<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MONO</span><span class="p">);</span> <span class="cm">/* left */</span>
		<span class="n">recdev_l</span> <span class="o">=</span> <span class="n">ADC_MUX_AUX1</span><span class="p">;</span>
		<span class="n">recdev_r</span> <span class="o">=</span> <span class="n">ADC_MUX_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_MIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_MIC</span><span class="p">;</span>
		<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MONO</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">);</span>	<span class="cm">/* right */</span>
		<span class="n">recdev_l</span> <span class="o">=</span> <span class="n">ADC_MUX_NONE</span><span class="p">;</span>
		<span class="n">recdev_r</span> <span class="o">=</span> <span class="n">ADC_MUX_MIC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dev_l</span> <span class="o">=</span> <span class="n">recdev_l</span><span class="p">;</span>
	<span class="o">*</span><span class="n">dev_r</span> <span class="o">=</span> <span class="n">recdev_r</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">recmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">netwinder_decode_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lev_l</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lev_r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_VOLUME</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_SYNTH</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_PCM</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_IGAIN</span>:
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">lev_l</span> <span class="o">|</span> <span class="n">lev_r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_MIC</span>:		<span class="cm">/* right mic only */</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lev_l</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE1</span>:		<span class="cm">/* left mic only  */</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xff00</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">|=</span> <span class="n">lev_l</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">SOUND_MIXER_MIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_PHONEIN</span>:	<span class="cm">/* left aux only  */</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lev_l</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">SOUND_MIXER_LINE1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_IMIX</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_PHONEOUT</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">netwinder_get_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">levels</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_VOLUME</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_SYNTH</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_PCM</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE</span>:
	<span class="k">case</span> <span class="n">SOUND_MIXER_IGAIN</span>:
		<span class="n">levels</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_MIC</span>:		<span class="cm">/* builtin mic: right mic only */</span>
		<span class="n">levels</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">levels</span> <span class="o">|=</span> <span class="n">levels</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_LINE1</span>:		<span class="cm">/* handset mic: left mic only */</span>
		<span class="n">levels</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">levels</span> <span class="o">|=</span> <span class="n">levels</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_PHONEIN</span>:	<span class="cm">/* phone mic: left aux1 only */</span>
		<span class="n">levels</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">levels</span> <span class="o">|=</span> <span class="n">levels</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">levels</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Waveartist specific mixer information.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">waveartist_mixer_info</span> <span class="n">netwinder_mixer</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">supported_devs</span>	<span class="o">=</span> <span class="n">SOUND_MASK_VOLUME</span>  <span class="o">|</span> <span class="n">SOUND_MASK_SYNTH</span>   <span class="o">|</span>
			<span class="n">SOUND_MASK_PCM</span>     <span class="o">|</span> <span class="n">SOUND_MASK_SPEAKER</span> <span class="o">|</span>
			<span class="n">SOUND_MASK_LINE</span>    <span class="o">|</span> <span class="n">SOUND_MASK_MIC</span>     <span class="o">|</span>
			<span class="n">SOUND_MASK_IMIX</span>    <span class="o">|</span> <span class="n">SOUND_MASK_LINE1</span>   <span class="o">|</span>
			<span class="n">SOUND_MASK_PHONEIN</span> <span class="o">|</span> <span class="n">SOUND_MASK_PHONEOUT</span><span class="o">|</span>
			<span class="n">SOUND_MASK_IGAIN</span><span class="p">,</span>

	<span class="p">.</span><span class="n">recording_devs</span>	<span class="o">=</span> <span class="n">SOUND_MASK_LINE</span>    <span class="o">|</span> <span class="n">SOUND_MASK_MIC</span>     <span class="o">|</span>
			<span class="n">SOUND_MASK_IMIX</span>    <span class="o">|</span> <span class="n">SOUND_MASK_LINE1</span>   <span class="o">|</span>
			<span class="n">SOUND_MASK_PHONEIN</span><span class="p">,</span>

	<span class="p">.</span><span class="n">stereo_devs</span>	<span class="o">=</span> <span class="n">SOUND_MASK_VOLUME</span>  <span class="o">|</span> <span class="n">SOUND_MASK_SYNTH</span>   <span class="o">|</span>
			<span class="n">SOUND_MASK_PCM</span>     <span class="o">|</span> <span class="n">SOUND_MASK_LINE</span>    <span class="o">|</span>
			<span class="n">SOUND_MASK_IMIX</span>    <span class="o">|</span> <span class="n">SOUND_MASK_IGAIN</span><span class="p">,</span>

	<span class="p">.</span><span class="n">select_input</span>	<span class="o">=</span> <span class="n">netwinder_select_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_mixer</span>	<span class="o">=</span> <span class="n">netwinder_decode_mixer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_mixer</span>	<span class="o">=</span> <span class="n">netwinder_get_mixer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vnc_configure_mixer</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">handset_detect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_LINE1</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">telephone_detect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_PHONEIN</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* unless someone has asked for LINE-IN,</span>
<span class="cm">			 * we default to MIC</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">&amp;</span> <span class="n">SOUND_MASK_LINE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">=</span> <span class="n">SOUND_MASK_MIC</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vnc_mute_spkr</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
		<span class="n">vnc_mute_lout</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">recmask</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">)</span>
			<span class="n">waveartist_set_recmask</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">recmask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vnc_slider</span><span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">signed</span> <span class="kt">int</span> <span class="n">slider_volume</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">old_hs</span><span class="p">,</span> <span class="n">old_td</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * read the &quot;buttons&quot; state.</span>
<span class="cm">	 *  Bit 4 = 0 means handset present</span>
<span class="cm">	 *  Bit 5 = 1 means phone offhook</span>
<span class="cm">	 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0x201</span><span class="p">);</span>

	<span class="n">old_hs</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">handset_detect</span><span class="p">;</span>
	<span class="n">old_td</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">telephone_detect</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">handset_detect</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">telephone_detect</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">old_hs</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">handset_detect</span> <span class="o">||</span>
	     <span class="n">old_td</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">telephone_detect</span><span class="p">))</span>
		<span class="n">vnc_configure_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">);</span>

	<span class="n">slider_volume</span> <span class="o">=</span> <span class="n">vnc_volume_slider</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re using software controlled volume, and</span>
<span class="cm">	 * the slider moves by more than 20%, then we</span>
<span class="cm">	 * switch back to slider controlled volume.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">slider_vol</span> <span class="o">-</span> <span class="n">slider_volume</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">use_slider</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * use only left channel</span>
<span class="cm">	 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slider_volume</span> <span class="o">!=</span> <span class="n">temp</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">use_slider</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">slider_vol</span> <span class="o">=</span> <span class="n">slider_volume</span><span class="p">;</span>

		<span class="n">waveartist_set_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">SOUND_MIXER_VOLUME</span><span class="p">,</span>
			<span class="n">slider_volume</span> <span class="o">|</span> <span class="n">slider_volume</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vnc_slider_tick</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">next_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vnc_slider</span><span class="p">(</span><span class="n">adev_info</span> <span class="o">+</span> <span class="n">data</span><span class="p">))</span>
		<span class="n">next_timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="c1">// mixer reported change</span>
	<span class="k">else</span>
		<span class="n">next_timeout</span> <span class="o">=</span> <span class="n">VNC_TIMER_PERIOD</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vnc_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">next_timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vnc_private_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavnc_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavnc_info</span> <span class="o">*</span><span class="p">)</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE1</span>:
	<span class="p">{</span>
		<span class="n">u_int</span> <span class="n">prev_spkr_mute</span><span class="p">,</span> <span class="n">prev_line_mute</span><span class="p">,</span> <span class="n">prev_auto_state</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="cm">/* check if parameter is logical */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">VNC_MUTE_INTERNAL_SPKR</span> <span class="o">|</span>
			    <span class="n">VNC_MUTE_LINE_OUT</span> <span class="o">|</span>
			    <span class="n">VNC_DISABLE_AUTOSWITCH</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">prev_auto_state</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span><span class="p">;</span>
		<span class="n">prev_spkr_mute</span>  <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span><span class="p">;</span>
		<span class="n">prev_line_mute</span>  <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span>   <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VNC_DISABLE_AUTOSWITCH</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VNC_MUTE_INTERNAL_SPKR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">VNC_MUTE_LINE_OUT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_spkr_mute</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span><span class="p">)</span>
			<span class="n">vnc_mute_spkr</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_line_mute</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span><span class="p">)</span>
			<span class="n">vnc_mute_lout</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prev_auto_state</span> <span class="o">!=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span><span class="p">)</span>
			<span class="n">vnc_configure_mixer</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define VNC_SOUND_PAUSE         0x53    </span><span class="c1">//to pause the DSP</span>
<span class="cp">#define VNC_SOUND_RESUME        0x57    </span><span class="c1">//to unpause the DSP</span>
		<span class="k">case</span> <span class="n">VNC_SOUND_PAUSE</span>:
			<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">VNC_SOUND_RESUME</span>:
			<span class="n">waveartist_cmd1</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* private ioctl to allow bulk access to waveartist */</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE3</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span>		<span class="n">mixer_reg</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">mixer_reg</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer_reg</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">mixer_reg</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MIXER_PRIVATE3_RESET</span>:
			<span class="n">waveartist_mixer_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MIXER_PRIVATE3_WRITE</span>:
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_MIXER</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>

			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_LEVEL</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
			<span class="n">waveartist_cmd3</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">WACMD_SET_LEVEL</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">mixer_reg</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MIXER_PRIVATE3_READ</span>:
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">waveartist_cmd</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mixer_reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">waveartist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">mixer_reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer_reg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read back the state from PRIVATE1 */</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE4</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span>  <span class="o">?</span> <span class="n">VNC_MUTE_INTERNAL_SPKR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">line_mute_state</span>  <span class="o">?</span> <span class="n">VNC_MUTE_LINE_OUT</span>      <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">handset_detect</span>   <span class="o">?</span> <span class="n">VNC_HANDSET_DETECT</span>     <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">telephone_detect</span> <span class="o">?</span> <span class="n">VNC_PHONE_DETECT</span>       <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
		      <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">no_autoselect</span>    <span class="o">?</span> <span class="n">VNC_DISABLE_AUTOSWITCH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * special case for master volume: if we</span>
<span class="cm">		 * received this call - switch from hw</span>
<span class="cm">		 * volume control to a software volume</span>
<span class="cm">		 * control, till the hw volume is modified</span>
<span class="cm">		 * to signal that user wants to be back in</span>
<span class="cm">		 * hardware...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">SOUND_MIXER_VOLUME</span><span class="p">)</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">use_slider</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* speaker output            */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">SOUND_MIXER_SPEAKER</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">+</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">spkr_mute_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">);</span>
			<span class="n">vnc_mute_spkr</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="n">cfg</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">attached</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dma2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_waveartist</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">waveartist_mixer_info</span> <span class="o">*</span><span class="n">mix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io</span> <span class="o">&amp;&amp;</span> <span class="n">machine_is_netwinder</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The NetWinder WaveArtist is at a fixed address.</span>
<span class="cm">		 * If the user does not supply an address, use the</span>
<span class="cm">		 * well-known parameters.</span>
<span class="cm">		 */</span>
		<span class="n">io</span>   <span class="o">=</span> <span class="mh">0x250</span><span class="p">;</span>
		<span class="n">irq</span>  <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">dma</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">dma2</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">waveartist_mixer</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ARCH_NETWINDER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">machine_is_netwinder</span><span class="p">())</span>
		<span class="n">mix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">netwinder_mixer</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">dma2</span> <span class="o">=</span> <span class="n">dma2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_waveartist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">attach_waveartist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">mix</span><span class="p">);</span>
	<span class="n">attached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_waveartist</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attached</span><span class="p">)</span>
		<span class="n">unload_waveartist</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_waveartist</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_waveartist</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_waveartist</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* io, irq, dma, dma2 */</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	
	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>
	
	<span class="n">io</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">irq</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dma</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dma2</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;waveartist=&quot;</span><span class="p">,</span> <span class="n">setup_waveartist</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Rockwell WaveArtist RWA-010 sound driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* IO base */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* IRQ */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* DMA */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma2</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* DMA2 */</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
