<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › sequencer.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sequencer.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sound/oss/sequencer.c</span>
<span class="cm"> *</span>
<span class="cm"> * The sequencer personality manager.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Thomas Sailer   : ioctl code reworked (vmalloc/vfree removed)</span>
<span class="cm"> * Alan Cox	   : reformatted and fixed a pair of null pointer bugs</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &quot;sound_config.h&quot;</span>

<span class="cp">#include &quot;midi_ctrl.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="n">sequencer_ok</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sound_timer_operations</span> <span class="o">*</span><span class="n">tmr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">tmr_no</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Currently selected timer */</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">pending_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* For timer change operation */</span>
<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seq_time</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="n">obsolete_api_used</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">lock</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local counts for number of synth and MIDI devices. These are initialized</span>
<span class="cm"> * by the sequencer_open.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">max_mididev</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">max_synthdev</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * The seq_mode gives the operating mode of the sequencer:</span>
<span class="cm"> *      1 = level1 (the default)</span>
<span class="cm"> *      2 = level2 (extended capabilities)</span>
<span class="cm"> */</span>

<span class="cp">#define SEQ_1	1</span>
<span class="cp">#define SEQ_2	2</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">seq_mode</span> <span class="o">=</span> <span class="n">SEQ_1</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">seq_sleeper</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_WAIT_QUEUE_HEAD</span><span class="p">(</span><span class="n">midi_sleeper</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="n">midi_opened</span><span class="p">[</span><span class="n">MAX_MIDI_DEV</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="n">midi_written</span><span class="p">[</span><span class="n">MAX_MIDI_DEV</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">prev_input_time</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">prev_event_time</span><span class="p">;</span>

<span class="cp">#include &quot;tuning.h&quot;</span>

<span class="cp">#define EV_SZ	8</span>
<span class="cp">#define IEV_SZ	8</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iqueue</span><span class="p">;</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">qhead</span><span class="p">,</span> <span class="n">qtail</span><span class="p">,</span> <span class="n">qlen</span><span class="p">;</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">iqhead</span><span class="p">,</span> <span class="n">iqtail</span><span class="p">,</span> <span class="n">iqlen</span><span class="p">;</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">seq_playing</span><span class="p">;</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">int</span> <span class="n">sequencer_busy</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">output_threshold</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span>     <span class="n">pre_event_timeout</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">synth_open_mask</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>      <span class="n">seq_queue</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">note</span><span class="p">,</span> <span class="kt">char</span> <span class="n">nonblock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">seq_startplay</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">seq_sync</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">seq_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cp">#if MAX_SYNTH_DEV &gt; 15</span>
<span class="cp">#error Too many synthesizer devices enabled.</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">sequencer_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ev_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ev_len</span> <span class="o">=</span> <span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_1</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iqlen</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
  			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
  		<span class="p">}</span>

 		<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">midi_sleeper</span><span class="p">,</span>
					       <span class="n">pre_event_timeout</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iqlen</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">iqlen</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">ev_len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">fixit</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">iqueue</span><span class="p">[</span><span class="n">iqhead</span> <span class="o">*</span> <span class="n">IEV_SZ</span><span class="p">];</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">)[</span><span class="n">p</span><span class="p">],</span> <span class="n">fixit</span><span class="p">,</span> <span class="n">ev_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">ev_len</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">-=</span> <span class="n">ev_len</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">iqhead</span> <span class="o">=</span> <span class="p">(</span><span class="n">iqhead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">;</span>
		<span class="n">iqlen</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sequencer_midi_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Currently NOP</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">seq_copy_to_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify that the len is valid for the current mode.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_1</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iqlen</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Overflow */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iqueue</span><span class="p">[</span><span class="n">iqtail</span> <span class="o">*</span> <span class="n">IEV_SZ</span><span class="p">],</span> <span class="n">event_rec</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">iqlen</span><span class="o">++</span><span class="p">;</span>
	<span class="n">iqtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">iqtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">midi_sleeper</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">seq_copy_to_input</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sequencer_midi_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tstamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>	<span class="cm">/* Ignore active sensing */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tstamp</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">seq_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tstamp</span> <span class="o">!=</span> <span class="n">prev_input_time</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">tstamp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tstamp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">SEQ_WAIT</span><span class="p">;</span>
		<span class="n">seq_copy_to_input</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tstamp</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">prev_input_time</span> <span class="o">=</span> <span class="n">tstamp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">event_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SEQ_MIDIPUTC</span><span class="p">;</span>
	<span class="n">event_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">event_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">event_rec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">seq_copy_to_input</span><span class="p">(</span><span class="n">event_rec</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">seq_input_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">this_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
		<span class="n">this_time</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">get_time</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">this_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">seq_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this_time</span> <span class="o">!=</span> <span class="n">prev_input_time</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp_event</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

		<span class="n">tmp_event</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">EV_TIMING</span><span class="p">;</span>
		<span class="n">tmp_event</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">TMR_WAIT_ABS</span><span class="p">;</span>
		<span class="n">tmp_event</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp_event</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmp_event</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_time</span><span class="p">;</span>

		<span class="n">seq_copy_to_input</span><span class="p">(</span><span class="n">tmp_event</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">prev_input_time</span> <span class="o">=</span> <span class="n">this_time</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_copy_to_input</span><span class="p">(</span><span class="n">event_rec</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">seq_input_event</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sequencer_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">event_rec</span><span class="p">[</span><span class="n">EV_SZ</span><span class="p">],</span> <span class="n">ev_code</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">ev_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sequencer_write(dev=%d, count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">event_rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">)[</span><span class="n">p</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ev_code</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev_code</span> <span class="o">==</span> <span class="n">SEQ_FULLSIZE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">fmt</span><span class="p">;</span>

			<span class="n">dev</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">max_synthdev</span> <span class="o">||</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

			<span class="n">fmt</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">load_patch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev_code</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span> <span class="o">&amp;&amp;</span> <span class="n">ev_code</span> <span class="o">==</span> <span class="n">SEQ_EXTENDED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sequencer: Invalid level 2 event %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ev_code</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ev_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="n">ev_size</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_playing</span><span class="p">)</span>
					<span class="n">seq_startplay</span><span class="p">();</span>
				<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
					   <span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">)[</span><span class="n">p</span> <span class="o">+</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sequencer: 4 byte event in level 2 mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ev_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SEQ_MIDIPUTC</span><span class="p">)</span>
				<span class="n">obsolete_api_used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">SEQ_MIDIPUTC</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">midi_opened</span><span class="p">[</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">max_mididev</span> <span class="o">||</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/*printk(&quot;Sequencer Error: Nonexistent MIDI device %d\n&quot;, dev);*/</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
								<span class="n">sequencer_midi_input</span><span class="p">,</span> <span class="n">sequencer_midi_output</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">seq_reset</span><span class="p">();</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sequencer Error: Unable to open Midi #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">midi_opened</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_queue</span><span class="p">(</span><span class="n">event_rec</span><span class="p">,</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">processed</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_playing</span><span class="p">)</span>
				<span class="n">seq_startplay</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">processed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">ev_size</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">-=</span> <span class="n">ev_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_playing</span><span class="p">)</span>
		<span class="n">seq_startplay</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">seq_queue</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">note</span><span class="p">,</span> <span class="kt">char</span> <span class="n">nonblock</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * Test if there is space in the queue</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&gt;=</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seq_playing</span><span class="p">)</span>
			<span class="n">seq_startplay</span><span class="p">();</span>	<span class="cm">/*</span>
<span class="cm">						 * Give chance to drain the queue</span>
<span class="cm">						 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nonblock</span> <span class="o">&amp;&amp;</span> <span class="n">qlen</span> <span class="o">&gt;=</span> <span class="n">SEQ_MAX_QUEUE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Sleep until there is enough space on the queue</span>
<span class="cm">		 */</span>
		<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&gt;=</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">				 * To be sure</span>
<span class="cm">				 */</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">[</span><span class="n">qtail</span> <span class="o">*</span> <span class="n">EV_SZ</span><span class="p">],</span> <span class="n">note</span><span class="p">,</span> <span class="n">EV_SZ</span><span class="p">);</span>

	<span class="n">qtail</span> <span class="o">=</span> <span class="p">(</span><span class="n">qtail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">;</span>
	<span class="n">qlen</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">extended_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">max_synthdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SEQ_NOTEOFF</span>:
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">kill_note</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_NOTEON</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">kill_note</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start_note</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_PGMCHANGE</span>:
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_instr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_AFTERTOUCH</span>:
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">aftertouch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_BALANCE</span>:
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">panning</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_CONTROLLER</span>:
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_VOLMODE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">volume_method</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">volume_method</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_voice</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">note</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">chn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">note</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">max_voice</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alloc_voice</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">note</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>  <span class="n">key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">voice</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">chn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">note</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">voice</span> <span class="o">=</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc_voice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
	<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">voice</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
	<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">alloc_times</span><span class="p">[</span><span class="n">voice</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">timestamp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">voice</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_chn_voice_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define dev event_rec[1]</span>
<span class="cp">#define cmd event_rec[2]</span>
<span class="cp">#define chn event_rec[3]</span>
<span class="cp">#define note event_rec[4]</span>
<span class="cp">#define parm event_rec[5]</span>

	<span class="kt">int</span> <span class="n">voice</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span> <span class="o">&gt;</span> <span class="n">max_synthdev</span> <span class="o">||</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc_voice</span><span class="p">)</span>
			<span class="n">voice</span> <span class="o">=</span> <span class="n">find_voice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">note</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MIDI_NOTEON</span> <span class="o">&amp;&amp;</span> <span class="n">parm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">MIDI_NOTEOFF</span><span class="p">;</span>
			<span class="n">parm</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MIDI_NOTEON</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">note</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">&amp;&amp;</span> <span class="n">note</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span>	<span class="cm">/* Not a seq2 feature */</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span> <span class="o">&amp;&amp;</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc_voice</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="cm">/* Internal synthesizer (FM, GUS, etc) */</span>
				<span class="n">voice</span> <span class="o">=</span> <span class="n">alloc_voice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">note</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">voice</span> <span class="o">=</span> <span class="n">chn</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">num_synths</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The MIDI channel 10 is a percussive channel. Use the note</span>
<span class="cm">				 * number to select the proper patch (128 to 255) to play.</span>
<span class="cm">				 */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chn</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_instr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="mi">128</span> <span class="o">+</span> <span class="n">note</span><span class="p">);</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">pgm_num</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">+</span> <span class="n">note</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">setup_voice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">chn</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start_note</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MIDI_NOTEOFF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">voice</span> <span class="o">=</span> <span class="n">chn</span><span class="p">;</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">kill_note</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">note</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MIDI_KEY_PRESSURE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">voice</span> <span class="o">=</span> <span class="n">chn</span><span class="p">;</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">aftertouch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">voice</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#undef dev</span>
<span class="cp">#undef cmd</span>
<span class="cp">#undef chn</span>
<span class="cp">#undef note</span>
<span class="cp">#undef parm</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_chn_common_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">chn</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="cm">/* unsigned char p2 = event_rec[5]; */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">w14</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span> <span class="o">&gt;</span> <span class="n">max_synthdev</span> <span class="o">||</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MIDI_PGM_CHANGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">pgm_num</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_synths</span><span class="p">)</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_instr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">p1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_instr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">p1</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MIDI_CTL_CHANGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chn</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">p1</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">controllers</span><span class="p">[</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">w14</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>	<span class="cm">/* Setting MSB should clear LSB to 0 */</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">controllers</span><span class="p">[</span><span class="n">p1</span> <span class="o">+</span> <span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">num_synths</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">w14</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>	<span class="cm">/* Combine MSB and LSB */</span>
					<span class="p">{</span>
						<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span>
							<span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">controllers</span><span class="p">[</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
							<span class="o">|</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span>
							<span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">controllers</span><span class="p">[</span><span class="n">p1</span> <span class="o">|</span> <span class="mi">32</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
						<span class="n">p1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">32</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="cm">/* Handle all playing notes on this channel */</span>

					<span class="n">key</span> <span class="o">=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">chn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">max_voice</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span>
							<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">w14</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>	<span class="cm">/* Mode 1 */</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">w14</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MIDI_PITCH_BEND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">bender_value</span> <span class="o">=</span> <span class="n">w14</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">num_synths</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="cm">/* Handle all playing notes on this channel */</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span><span class="p">;</span>

					<span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">chn</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">max_voice</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
						<span class="k">if</span> <span class="p">((</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">.</span><span class="n">map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="n">key</span><span class="p">)</span>
							<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bender</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">w14</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bender</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">w14</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span>	<span class="cm">/* MODE 1 */</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bender</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">w14</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">seq_timing_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">parm</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">,</span> <span class="n">event_rec</span><span class="p">))</span> <span class="o">==</span> <span class="n">TIMER_ARMED</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="n">qlen</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">output_threshold</span><span class="p">)</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">TMR_WAIT_REL</span>:
			<span class="n">parm</span> <span class="o">+=</span> <span class="n">prev_event_time</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * NOTE!  No break here. Execution of TMR_WAIT_REL continues in the</span>
<span class="cm">			 * next case (TMR_WAIT_ABS)</span>
<span class="cm">			 */</span>

		<span class="k">case</span> <span class="n">TMR_WAIT_ABS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">parm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">long</span> <span class="n">time</span><span class="p">;</span>

				<span class="n">time</span> <span class="o">=</span> <span class="n">parm</span><span class="p">;</span>
				<span class="n">prev_event_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>

				<span class="n">seq_playing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">request_sound_timer</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="n">qlen</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">output_threshold</span><span class="p">)</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">TIMER_ARMED</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TMR_START</span>:
			<span class="n">seq_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">prev_input_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prev_event_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TMR_STOP</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TMR_CONTINUE</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TMR_TEMPO</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TMR_ECHO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
				<span class="n">seq_copy_to_input</span><span class="p">(</span><span class="n">event_rec</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">parm</span> <span class="o">=</span> <span class="p">(</span><span class="n">parm</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">SEQ_ECHO</span><span class="p">);</span>
				<span class="n">seq_copy_to_input</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">parm</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TIMER_NOT_ARMED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_local_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">cmd</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">parm</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">LOCL_STARTAUDIO</span>:
			<span class="n">DMAbuf_start_devices</span><span class="p">(</span><span class="n">parm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_sysex_message</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">event_rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">event_rec</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">event_rec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;</span> <span class="n">max_synthdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">send_sysex</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">send_sysex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">play_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! This routine returns</span>
<span class="cm">	 *   0 = normal event played.</span>
<span class="cm">	 *   1 = Timer armed. Suspend playback until timer callback.</span>
<span class="cm">	 *   2 = MIDI output buffer full. Restore queue and suspend until timer</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">delay</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SEQ_NOTEOFF</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">kill_note</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">255</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_NOTEON</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">128</span> <span class="o">||</span> <span class="n">q</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
						<span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start_note</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_WAIT</span>:
			<span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">q</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">							 * Bytes 1 to 3 are containing the *</span>
<span class="cm">							 * delay in &#39;ticks&#39;</span>
<span class="cm">							 */</span>
			<span class="o">*</span><span class="n">delay</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">delay</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="kt">long</span> <span class="n">time</span><span class="p">;</span>

				<span class="n">seq_playing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">time</span> <span class="o">=</span> <span class="o">*</span><span class="n">delay</span><span class="p">;</span>
				<span class="n">prev_event_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>

				<span class="n">request_sound_timer</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="n">qlen</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">output_threshold</span><span class="p">)</span>
					<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * The timer is now active and will reinvoke this function</span>
<span class="cm">				 * after the timer expires. Return to the caller now.</span>
<span class="cm">				 */</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_PGMCHANGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">set_instr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_SYNCTIMER</span>: 	<span class="cm">/*</span>
<span class="cm">					 * Reset timer</span>
<span class="cm">					 */</span>
			<span class="n">seq_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">prev_input_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">prev_event_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_MIDIPUTC</span>:	<span class="cm">/*</span>
<span class="cm">					 * Put a midi character</span>
<span class="cm">					 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">midi_opened</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>

				<span class="n">dev</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_midis</span> <span class="o">||</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">outputc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
				<span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Output FIFO is full. Wait one timer cycle and try again.</span>
<span class="cm">					 */</span>

					<span class="n">seq_playing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">request_sound_timer</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span>
					<span class="n">midi_written</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_ECHO</span>:
			<span class="n">seq_copy_to_input</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/*</span>
<span class="cm">							 * Echo back to the process</span>
<span class="cm">							 */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_PRIVATE</span>:
			<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">max_synthdev</span><span class="p">)</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-&gt;</span><span class="n">hw_control</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SEQ_EXTENDED</span>:
			<span class="n">extended_event</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EV_CHN_VOICE</span>:
			<span class="n">seq_chn_voice_event</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EV_CHN_COMMON</span>:
			<span class="n">seq_chn_common_event</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EV_TIMING</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_timing_event</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">==</span> <span class="n">TIMER_ARMED</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EV_SEQ_LOCAL</span>:
			<span class="n">seq_local_event</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">EV_SYSEX</span>:
			<span class="n">seq_sysex_message</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called also as timer in irq context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_startplay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_one</span><span class="p">,</span> <span class="n">action</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">qhead</span> <span class="o">=</span> <span class="p">((</span><span class="n">this_one</span> <span class="o">=</span> <span class="n">qhead</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">;</span>
		<span class="n">qlen</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">seq_playing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">action</span> <span class="o">=</span> <span class="n">play_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">[</span><span class="n">this_one</span> <span class="o">*</span> <span class="n">EV_SZ</span><span class="p">])))</span>
		<span class="p">{</span>		<span class="cm">/* Suspend playback. Next timer routine invokes this routine again */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">qlen</span><span class="o">++</span><span class="p">;</span>
				<span class="n">qhead</span> <span class="o">=</span> <span class="n">this_one</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_playing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="n">qlen</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">output_threshold</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_controllers</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">controller</span><span class="p">,</span> <span class="kt">int</span> <span class="n">update_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">controller</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl_def_values</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_mode2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">max_synthdev</span> <span class="o">=</span> <span class="n">num_synths</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">num_midis</span><span class="p">;</span> <span class="n">dev</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">converter</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">max_synthdev</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">converter</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">max_synthdev</span><span class="p">;</span> <span class="n">dev</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">chn</span><span class="p">;</span>

		<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">sysex_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">emulation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">pgm_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">reset_controllers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">controllers</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">bender_value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* Neutral */</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">chn_info</span><span class="p">[</span><span class="n">chn</span><span class="p">].</span><span class="n">bender_range</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">max_mididev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq_mode</span> <span class="o">=</span> <span class="n">SEQ_2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sequencer_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sequencer_ok</span><span class="p">)</span>
		<span class="n">sequencer_init</span><span class="p">();</span>

	<span class="n">level</span> <span class="o">=</span> <span class="p">((</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="n">SND_DEV_SEQ2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sequencer_open(dev=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sequencer_ok</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cm">/*		printk(&quot;Sound card: sequencer not initialized\n&quot;);*/</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span>		<span class="cm">/* Patch manager device (obsolete) */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;synth0&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_midis</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*printk(&quot;Sequencer: No MIDI devices. Input not possible\n&quot;);*/</span>
			<span class="n">sequencer_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sequencer_busy</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sequencer_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">obsolete_api_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max_mididev</span> <span class="o">=</span> <span class="n">num_midis</span><span class="p">;</span>
	<span class="n">max_synthdev</span> <span class="o">=</span> <span class="n">num_synths</span><span class="p">;</span>
	<span class="n">pre_event_timeout</span> <span class="o">=</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">;</span>
	<span class="n">seq_mode</span> <span class="o">=</span> <span class="n">SEQ_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending_timer</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">tmr_no</span> <span class="o">=</span> <span class="n">pending_timer</span><span class="p">;</span>
		<span class="n">pending_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmr_no</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>	<span class="cm">/* Not selected yet */</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">best</span><span class="p">;</span>

		<span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_sound_timers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sound_timer_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">sound_timer_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">tmr_no</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">best</span> <span class="o">=</span> <span class="n">sound_timer_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">priority</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmr_no</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>	<span class="cm">/* Should not be */</span>
			<span class="n">tmr_no</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tmr</span> <span class="o">=</span> <span class="n">sound_timer_devs</span><span class="p">[</span><span class="n">tmr_no</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*printk(&quot;sequencer: No timer for level 2\n&quot;);*/</span>
			<span class="n">sequencer_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">setup_mode2</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_synthdev</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">max_mididev</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">sequencer_busy</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">synth_open_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_mididev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">midi_opened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">midi_written</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_synthdev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sequencer: Warning! Cannot open synth device #%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">midi_dev</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;(Maps to MIDI dev #%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">midi_dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">synth_open_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">midi_dev</span><span class="p">)</span>
				<span class="n">midi_opened</span><span class="p">[</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">midi_dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">prev_input_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prev_event_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READWRITE</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Initialize midi input devices</span>
<span class="cm">		 */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_mididev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">midi_opened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
	
				<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">=</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span>
					<span class="n">sequencer_midi_input</span><span class="p">,</span> <span class="n">sequencer_midi_output</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">midi_opened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="n">tmr</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">,</span> <span class="n">seq_mode</span><span class="p">);</span>
	<span class="p">}</span>

 	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
 	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">midi_sleeper</span><span class="p">);</span>
	<span class="n">output_threshold</span> <span class="o">=</span> <span class="n">SEQ_MAX_QUEUE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_drain_midi_queues</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Give the Midi drivers time to drain their output queues</span>
<span class="cm">	 */</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_mididev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">midi_opened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">midi_written</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer_status</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
						<span class="n">n</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Let&#39;s have a delay</span>
<span class="cm">		 */</span>

 		<span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
 			<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">,</span>
						       <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sequencer_release</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sequencer_release(dev=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the queue is empty (if we don&#39;t have nonblock)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OPEN_READ</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
  			<span class="n">seq_sync</span><span class="p">();</span>
 			<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">,</span>
						       <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
 			<span class="cm">/* Extra delay */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">seq_drain_midi_queues</span><span class="p">();</span>	<span class="cm">/*</span>
<span class="cm">						 * Ensure the output queues are empty</span>
<span class="cm">						 */</span>
	<span class="n">seq_reset</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">seq_drain_midi_queues</span><span class="p">();</span>	<span class="cm">/*</span>
<span class="cm">						 * Flush the all notes off messages</span>
<span class="cm">						 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_synthdev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>	<span class="cm">/*</span>
<span class="cm">						 * Actually opened</span>
<span class="cm">						 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="p">{</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

				<span class="n">module_put</span><span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">midi_dev</span><span class="p">)</span>
					<span class="n">midi_opened</span><span class="p">[</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">midi_dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_mididev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">midi_opened</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmr</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">tmr</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">obsolete_api_used</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;/dev/music: Obsolete (4 byte) API was used by %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="n">sequencer_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">seq_sync</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">seq_playing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">seq_startplay</span><span class="p">();</span>

 	<span class="k">if</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
 		<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">midi_outc</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! Calls sleep(). Don&#39;t call this from interrupt.</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This routine sends one byte to the Midi channel.</span>
<span class="cm">	 * If the output FIFO is full, it waits until there</span>
<span class="cm">	 * is space in the queue</span>
<span class="cm">	 */</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>		<span class="cm">/* Timeout */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
 	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">outputc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
 		<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">25</span><span class="p">);</span>
  		<span class="n">n</span><span class="o">--</span><span class="p">;</span>
  	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! Calls sleep(). Don&#39;t call this from interrupt.</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">sound_stop_timer</span><span class="p">();</span>

	<span class="n">seq_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">prev_input_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prev_event_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">qlen</span> <span class="o">=</span> <span class="n">qhead</span> <span class="o">=</span> <span class="n">qtail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iqlen</span> <span class="o">=</span> <span class="n">iqhead</span> <span class="o">=</span> <span class="n">iqtail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_synthdev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_synthdev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="p">{</span>
						<span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* All notes off */</span>
						<span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">controller</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Reset all ctl */</span>
						<span class="n">synth_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bender</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">);</span>	<span class="cm">/* Bender off */</span>
					<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>	<span class="cm">/* seq_mode == SEQ_1 */</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_mididev</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">midi_written</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>	<span class="cm">/*</span>
<span class="cm">						 * Midi used. Some notes may still be playing</span>
<span class="cm">						 */</span>
			<span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 *      Sending just a ACTIVE SENSING message should be enough to stop all</span>
<span class="cm">				 *      playing notes. Since there are devices not recognizing the</span>
<span class="cm">				 *      active sensing, we have to send some all notes off messages also.</span>
<span class="cm">				 */</span>
				<span class="n">midi_outc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">);</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">chn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chn</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">chn</span><span class="o">++</span><span class="p">)</span>
				<span class="p">{</span>
					<span class="n">midi_outc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="mh">0xb0</span> <span class="o">+</span> <span class="p">(</span><span class="n">chn</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)));</span>		<span class="cm">/* control change */</span>
					<span class="n">midi_outc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">);</span>	<span class="cm">/* All notes off */</span>
					<span class="n">midi_outc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Dummy parameter */</span>
				<span class="p">}</span>

				<span class="n">midi_devs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

				<span class="n">midi_written</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">midi_opened</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_playing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*      printk( &quot;Sequencer Warning: Unexpected sleeping process - Waking up\n&quot;); */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">seq_panic</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This routine is called by the application in case the user</span>
<span class="cm">	 * wants to reset the system to the default state.</span>
<span class="cm">	 */</span>

	<span class="n">seq_reset</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since some of the devices don&#39;t recognize the active sensing and</span>
<span class="cm">	 * all notes off messages, we have to shut all notes manually.</span>
<span class="cm">	 *</span>
<span class="cm">	 *      TO BE IMPLEMENTED LATER</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Also return the controllers to their default states</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sequencer_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">midi_dev</span><span class="p">,</span> <span class="n">orig_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">synth_info</span> <span class="n">inf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">seq_event_rec</span> <span class="n">event_rec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">orig_dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SNDCTL_TMR_TIMEBASE</span>:
		<span class="k">case</span> <span class="n">SNDCTL_TMR_TEMPO</span>:
		<span class="k">case</span> <span class="n">SNDCTL_TMR_START</span>:
		<span class="k">case</span> <span class="n">SNDCTL_TMR_STOP</span>:
		<span class="k">case</span> <span class="n">SNDCTL_TMR_CONTINUE</span>:
		<span class="k">case</span> <span class="n">SNDCTL_TMR_METRONOME</span>:
		<span class="k">case</span> <span class="n">SNDCTL_TMR_SOURCE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">!=</span> <span class="n">SEQ_2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SNDCTL_TMR_SELECT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">!=</span> <span class="n">SEQ_2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">pending_timer</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pending_timer</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pending_timer</span> <span class="o">&gt;=</span> <span class="n">num_sound_timers</span> <span class="o">||</span> <span class="n">sound_timer_devs</span><span class="p">[</span><span class="n">pending_timer</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">pending_timer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">pending_timer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_PANIC</span>:
			<span class="n">seq_panic</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_SYNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">seq_sync</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">qlen</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINTR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_RESET</span>:
			<span class="n">seq_reset</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_TESTMIDI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">midi_dev</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">midi_dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">midi_dev</span> <span class="o">&gt;=</span> <span class="n">max_mididev</span> <span class="o">||</span> <span class="o">!</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">midi_dev</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">midi_opened</span><span class="p">[</span><span class="n">midi_dev</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">midi_devs</span><span class="p">[</span><span class="n">midi_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">midi_dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">sequencer_midi_input</span><span class="p">,</span>
						     <span class="n">sequencer_midi_output</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">midi_opened</span><span class="p">[</span><span class="n">midi_dev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_GETINCOUNT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">iqlen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_GETOUTCOUNT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="n">qlen</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_GETTIME</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">seq_time</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_CTRLRATE</span>:
			<span class="cm">/*</span>
<span class="cm">			 * If *arg == 0, just return the current rate</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seq_mode</span> <span class="o">==</span> <span class="n">SEQ_2</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">tmr</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">tmr_no</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_RESETSAMPLES</span>:
		<span class="k">case</span> <span class="n">SNDCTL_SYNTH_REMOVESAMPLE</span>:
		<span class="k">case</span> <span class="n">SNDCTL_SYNTH_CONTROL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_synths</span> <span class="o">||</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">orig_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_NRSYNTHS</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">max_synthdev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_NRMIDIS</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">max_mididev</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SYNTH_MEMAVL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_synths</span> <span class="o">||</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">orig_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_FM_4OP_ENABLE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_synths</span> <span class="o">||</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SYNTH_INFO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">synth_info</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">max_synthdev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">orig_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

		<span class="cm">/* Like SYNTH_INFO but returns ID in the name field */</span>
		<span class="k">case</span> <span class="n">SNDCTL_SYNTH_ID</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">synth_info</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">max_synthdev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">orig_dev</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inf</span><span class="p">,</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inf</span><span class="p">));</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">inf</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">synth_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inf</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
			<span class="n">inf</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inf</span><span class="p">))</span><span class="o">?-</span><span class="n">EFAULT</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_OUTOFBAND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_rec</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event_rec</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">play_event</span><span class="p">(</span><span class="n">event_rec</span><span class="p">.</span><span class="n">arr</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_MIDI_INFO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">midi_info</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">max_mididev</span> <span class="o">||</span> <span class="o">!</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">midi_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">midi_info</span><span class="p">))</span><span class="o">?-</span><span class="n">EFAULT</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_SEQ_THRESHOLD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">SEQ_MAX_QUEUE</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">output_threshold</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_MIDI_PRETIME</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">val</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">pre_event_timeout</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">synth_open_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">synth_devs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* No kernel lock - we&#39;re using the global irq lock here */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sequencer_poll</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* input */</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">midi_sleeper</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iqlen</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

	<span class="cm">/* output */</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq_sleeper</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">-</span> <span class="n">qlen</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">output_threshold</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">sequencer_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_startplay</span><span class="p">();</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sequencer_timer</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">note_to_freq</span><span class="p">(</span><span class="kt">int</span> <span class="n">note_num</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * This routine converts a midi note to a frequency (multiplied by 1000)</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">note</span><span class="p">,</span> <span class="n">octave</span><span class="p">,</span> <span class="n">note_freq</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">notes</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="mi">261632</span><span class="p">,</span> <span class="mi">277189</span><span class="p">,</span> <span class="mi">293671</span><span class="p">,</span> <span class="mi">311132</span><span class="p">,</span> <span class="mi">329632</span><span class="p">,</span> <span class="mi">349232</span><span class="p">,</span>
		<span class="mi">369998</span><span class="p">,</span> <span class="mi">391998</span><span class="p">,</span> <span class="mi">415306</span><span class="p">,</span> <span class="mi">440000</span><span class="p">,</span> <span class="mi">466162</span><span class="p">,</span> <span class="mi">493880</span>
	<span class="p">};</span>

<span class="cp">#define BASE_OCTAVE	5</span>

	<span class="n">octave</span> <span class="o">=</span> <span class="n">note_num</span> <span class="o">/</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">note</span> <span class="o">=</span> <span class="n">note_num</span> <span class="o">%</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">note_freq</span> <span class="o">=</span> <span class="n">notes</span><span class="p">[</span><span class="n">note</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">octave</span> <span class="o">&lt;</span> <span class="n">BASE_OCTAVE</span><span class="p">)</span>
		<span class="n">note_freq</span> <span class="o">&gt;&gt;=</span> <span class="p">(</span><span class="n">BASE_OCTAVE</span> <span class="o">-</span> <span class="n">octave</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">octave</span> <span class="o">&gt;</span> <span class="n">BASE_OCTAVE</span><span class="p">)</span>
		<span class="n">note_freq</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="n">octave</span> <span class="o">-</span> <span class="n">BASE_OCTAVE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * note_freq &gt;&gt;= 1;</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">note_freq</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">note_to_freq</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">compute_finetune</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base_freq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bend</span><span class="p">,</span> <span class="kt">int</span> <span class="n">range</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">vibrato_cents</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">amount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">negative</span><span class="p">,</span> <span class="n">semitones</span><span class="p">,</span> <span class="n">cents</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bend</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base_freq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">range</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base_freq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">range</span> <span class="o">&gt;=</span> <span class="mi">8192</span><span class="p">)</span>
		<span class="n">range</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>

	<span class="n">bend</span> <span class="o">=</span> <span class="n">bend</span> <span class="o">*</span> <span class="n">range</span> <span class="o">/</span> <span class="mi">8192</span><span class="p">;</span>	<span class="cm">/* Convert to cents */</span>
	<span class="n">bend</span> <span class="o">+=</span> <span class="n">vibrato_cents</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bend</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">base_freq</span><span class="p">;</span>

	<span class="n">negative</span> <span class="o">=</span> <span class="n">bend</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bend</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bend</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bend</span> <span class="o">&gt;</span> <span class="n">range</span><span class="p">)</span>
		<span class="n">bend</span> <span class="o">=</span> <span class="n">range</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   if (bend &gt; 2399)</span>
<span class="cm">	   bend = 2399;</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bend</span> <span class="o">&gt;</span> <span class="mi">2399</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">multiplier</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">bend</span> <span class="o">-=</span> <span class="mi">2400</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">semitones</span> <span class="o">=</span> <span class="n">bend</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">cents</span> <span class="o">=</span> <span class="n">bend</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">amount</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">semitone_tuning</span><span class="p">[</span><span class="n">semitones</span><span class="p">]</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">*</span> <span class="n">cent_tuning</span><span class="p">[</span><span class="n">cents</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">base_freq</span> <span class="o">*</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">/</span> <span class="n">amount</span><span class="p">;</span>	<span class="cm">/* Bend down */</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">base_freq</span> <span class="o">*</span> <span class="n">amount</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">;</span>	<span class="cm">/* Bend up */</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">compute_finetune</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sequencer_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sequencer_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">*</span> <span class="n">EV_SZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sequencer: Can&#39;t allocate memory for sequencer output queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iqueue</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">SEQ_MAX_QUEUE</span> <span class="o">*</span> <span class="n">IEV_SZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iqueue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sequencer: Can&#39;t allocate memory for sequencer input queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sequencer_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sequencer_init</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sequencer_unload</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">iqueue</span><span class="p">);</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">iqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
