<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › soundcard.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>soundcard.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/sound/oss/soundcard.c</span>
<span class="cm"> *</span>
<span class="cm"> * Sound card driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Thomas Sailer     : ioctl code reworked (vmalloc/vfree removed)</span>
<span class="cm"> *                   integrated sound_switch.c</span>
<span class="cm"> * Stefan Reinauer   : integrated /proc/sound (equals to /dev/sndstat,</span>
<span class="cm"> *                   which should disappear in the near future)</span>
<span class="cm"> * Eric Dumas	     : devfs support (22-Jan-98) &lt;dumas@linux.eu.org&gt; with</span>
<span class="cm"> *                   fixups by C. Scott Ananian &lt;cananian@alumni.princeton.edu&gt;</span>
<span class="cm"> * Richard Gooch     : moved common (non OSS-specific) devices to sound_core.c</span>
<span class="cm"> * Rob Riggs	     : Added persistent DMA buffers support (1998/10/17)</span>
<span class="cm"> * Christoph Hellwig : Some cleanup work (2000/03/01)</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;sound_config.h&quot;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/signal.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/major.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * This ought to be moved into include/asm/dma.h</span>
<span class="cm"> */</span>
<span class="cp">#ifndef valid_dma</span>
<span class="cp">#define valid_dma(n) ((n) &gt;= 0 &amp;&amp; (n) &lt; MAX_DMA_CHANNELS &amp;&amp; (n) != 4)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Table for permanently allocated memory (used when unloading the module)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span>          <span class="n">sound_mem_blocks</span><span class="p">[</span><span class="n">MAX_MEM_BLOCKS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">soundcard_mutex</span><span class="p">);</span>
<span class="kt">int</span>             <span class="n">sound_nblocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Persistent DMA buffers */</span>
<span class="cp">#ifdef CONFIG_SOUND_DMAP</span>
<span class="kt">int</span>             <span class="n">sound_dmap_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="kt">int</span>             <span class="n">sound_dmap_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">char</span>     <span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">MAX_DMA_CHANNELS</span><span class="p">];</span>

<span class="cp">#define DMA_MAP_UNAVAIL		0</span>
<span class="cp">#define DMA_MAP_FREE		1</span>
<span class="cp">#define DMA_MAP_BUSY		2</span>


<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seq_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Time for /dev/sequencer */</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">sound_class</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Table for configurable mixer volume handling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">mixer_vol_table</span> <span class="n">mixer_vols</span><span class="p">[</span><span class="n">MAX_MIXER_DEV</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num_mixer_volumes</span><span class="p">;</span>

<span class="kt">int</span> <span class="o">*</span><span class="nf">load_mixer_volumes</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">levels</span><span class="p">,</span> <span class="kt">int</span> <span class="n">present</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_mixer_volumes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mixer_vols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span>
				<span class="n">mixer_vols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">mixer_vols</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">levels</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_mixer_volumes</span> <span class="o">&gt;=</span> <span class="n">MAX_MIXER_DEV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: Too many mixers (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">levels</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">num_mixer_volumes</span><span class="o">++</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">mixer_vols</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">present</span><span class="p">)</span>
		<span class="n">mixer_vols</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mixer_vols</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mixer_vols</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">mixer_vols</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">levels</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">load_mixer_volumes</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mixer_levels</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* mixer_vol_table is 174 bytes, so IMHO no reason to not allocate it on the stack */</span>
	<span class="n">mixer_vol_table</span> <span class="n">buf</span><span class="p">;</span>   

	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">load_mixer_volumes</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">levels</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_mixer_levels</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="p">(((</span><span class="n">mixer_vol_table</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">num_mixer_volumes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mixer_vols</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer_vol_table</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 4K page size but our output routines use some slack for overruns */</span>
<span class="cp">#define PROC_BLOCK_SIZE (3*1024)</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sound_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *	The OSS drivers aren&#39;t remotely happy without this locking,</span>
<span class="cm">	 *	and unless someone fixes them when they are about to bite the</span>
<span class="cm">	 *	big one anyway, we might as well bandage here..</span>
<span class="cm">	 */</span>
	 
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_read(dev=%d, count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
	<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
	<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">audio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_SEQ</span>:
	<span class="k">case</span> <span class="n">SND_DEV_SEQ2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sequencer_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_MIDIN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MIDIbuf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sound_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_write(dev=%d, count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_DEV_SEQ</span>:
	<span class="k">case</span> <span class="n">SND_DEV_SEQ2</span>:
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">sequencer_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
	<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
	<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">audio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_MIDIN</span>:
		<span class="n">ret</span> <span class="o">=</span>  <span class="n">MIDIbuf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_open(dev=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SND_NDEVS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid minor device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_DEV_CTL</span>:
		<span class="n">dev</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">MAX_MIXER_DEV</span> <span class="o">&amp;&amp;</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;mixer%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_mixers</span> <span class="o">||</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_SEQ</span>:
	<span class="k">case</span> <span class="n">SND_DEV_SEQ2</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sequencer_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_MIDIN</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">MIDIbuf_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
	<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
	<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">audio_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Invalid minor device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_release(dev=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_DEV_CTL</span>:
		<span class="n">module_put</span><span class="p">(</span><span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		
	<span class="k">case</span> <span class="n">SND_DEV_SEQ</span>:
	<span class="k">case</span> <span class="n">SND_DEV_SEQ2</span>:
		<span class="n">sequencer_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_MIDIN</span>:
		<span class="n">MIDIbuf_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
	<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
	<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
		<span class="n">audio_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound error: Releasing unknown device 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_mixer_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mixer_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">modify_counter</span> <span class="o">=</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">modify_counter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_old_mixer_info</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">_old_mixer_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
 	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
 	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_mixer_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">mixdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">mixdev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mixdev</span> <span class="o">&gt;=</span> <span class="n">MAX_MIXER_DEV</span><span class="p">)</span>
 		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
 	<span class="cm">/* Try to load the mixer... */</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">mixer_devs</span><span class="p">[</span><span class="n">mixdev</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
 		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;mixer%d&quot;</span><span class="p">,</span> <span class="n">mixdev</span><span class="p">);</span>
 	<span class="p">}</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">mixdev</span> <span class="o">&gt;=</span> <span class="n">num_mixers</span> <span class="o">||</span> <span class="o">!</span><span class="n">mixer_devs</span><span class="p">[</span><span class="n">mixdev</span><span class="p">])</span>
 		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_INFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">get_mixer_info</span><span class="p">(</span><span class="n">mixdev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_OLD_MIXER_INFO</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">get_old_mixer_info</span><span class="p">(</span><span class="n">mixdev</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_WRITE</span><span class="p">)</span>
		<span class="n">mixer_devs</span><span class="p">[</span><span class="n">mixdev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">modify_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mixer_devs</span><span class="p">[</span><span class="n">mixdev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">mixdev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">mixdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">sound_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_SIOC_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Have to validate the address given by the process.</span>
<span class="cm">		 */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">_SIOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65536</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_WRITE</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_READ</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_ioctl(dev=%d, cmd=0x%x, arg=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OSS_GETVERSION</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__put_user</span><span class="p">(</span><span class="n">SOUND_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">);</span>
	
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">num_mixers</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>   <span class="cm">/* Mixer ioctl */</span>
	    <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SND_DEV_CTL</span><span class="p">)</span> <span class="p">{</span>              
		<span class="n">dtype</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
		<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
		<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sound_mixer_ioctl</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span><span class="p">,</span>
						 <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>			
		<span class="k">default</span><span class="o">:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sound_mixer_ioctl</span><span class="p">(</span><span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_DEV_CTL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_GETLEVELS</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">get_mixer_levels</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_SETLEVELS</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">set_mixer_levels</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sound_mixer_ioctl</span><span class="p">(</span><span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_SEQ</span>:
	<span class="k">case</span> <span class="n">SND_DEV_SEQ2</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sequencer_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
	<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
	<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">audio_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SND_DEV_MIDIN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">MIDIbuf_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sound_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_poll(dev=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SND_DEV_SEQ</span>:
	<span class="k">case</span> <span class="n">SND_DEV_SEQ2</span>:
		<span class="k">return</span> <span class="n">sequencer_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SND_DEV_MIDIN</span>:
		<span class="k">return</span> <span class="n">MIDIbuf_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SND_DEV_DSP</span>:
	<span class="k">case</span> <span class="n">SND_DEV_DSP16</span>:
	<span class="k">case</span> <span class="n">SND_DEV_AUDIO</span>:
		<span class="k">return</span> <span class="n">DMAbuf_poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sound_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev_class</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">);</span>

	<span class="n">dev_class</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_class</span> <span class="o">!=</span> <span class="n">SND_DEV_DSP</span> <span class="o">&amp;&amp;</span> <span class="n">dev_class</span> <span class="o">!=</span> <span class="n">SND_DEV_DSP16</span> <span class="o">&amp;&amp;</span> <span class="n">dev_class</span> <span class="o">!=</span> <span class="n">SND_DEV_AUDIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: mmap() not supported for other than audio devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_WRITE</span><span class="p">)</span>	<span class="cm">/* Map write and read/write to the output buf */</span>
		<span class="n">dmap</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_READ</span><span class="p">)</span>
		<span class="n">dmap</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: Undefined mmap() access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: mmap() error. dmap == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: mmap() called when raw_buf == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: mmap() called twice for the same DMA buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: mmap() offset must be 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound: mmap() size = %ld. Should be %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
			<span class="n">virt_to_phys</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">,</span>
			<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">|=</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">)</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">mmap</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span>
	       <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span>
	       <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soundcard_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">oss_sound_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">sound_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">sound_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">sound_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">sound_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">sound_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sound_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">sound_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *	Create the required special subdevices</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_special_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">seq1</span><span class="p">,</span><span class="n">seq2</span><span class="p">;</span>
	<span class="n">seq1</span><span class="o">=</span><span class="n">register_sound_special</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oss_sound_fops</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">seq1</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bad</span><span class="p">;</span>
	<span class="n">seq2</span><span class="o">=</span><span class="n">register_sound_special</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oss_sound_fops</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">seq2</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">unregister_sound_special</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nl">bad:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">dmabuf</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dmabug</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dmabuf</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dmabug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/* additional minors for compatibility */</span>
<span class="k">struct</span> <span class="n">oss_minor_dev</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">minor</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">;</span>
<span class="p">}</span> <span class="n">dev_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SND_DEV_DSP16</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SND_DEV_AUDIO</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">oss_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dmabug</span><span class="p">)</span>
		<span class="n">isa_dma_bridge_buggy</span> <span class="o">=</span> <span class="n">dmabug</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_special_devices</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sound: driver already loaded/included in kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Protecting the innocent */</span>
	<span class="n">sound_dmap_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmabuf</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minor</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">register_sound_special</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oss_sound_fops</span><span class="p">,</span> <span class="n">minor</span><span class="p">))</span>
				<span class="n">dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_audiodevs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sound_nblocks</span> <span class="o">&gt;=</span> <span class="n">MAX_MEM_BLOCKS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound warning: Deallocation table was too small.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">oss_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enabled</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">))</span>
				<span class="n">unregister_sound_special</span><span class="p">(</span><span class="n">dev_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minor</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">num_audiodevs</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">unregister_sound_special</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">unregister_sound_special</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

	<span class="n">sound_stop_timer</span><span class="p">();</span>

	<span class="n">sequencer_unload</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_DMA_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DMA_MAP_UNAVAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Sound: Hmm, DMA%d was left allocated - fixed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sound_nblocks</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">sound_mem_blocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">oss_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">oss_cleanup</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;OSS Sound subsystem&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hannu Savolainen, et al.&quot;</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">sound_alloc_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">chn</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">deviceID</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">chn</span><span class="p">,</span> <span class="n">deviceID</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">=</span> <span class="n">DMA_MAP_FREE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">sound_open_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">chn</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">deviceID</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_dma</span><span class="p">(</span><span class="n">chn</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sound_open_dma: Invalid DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chn</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DMA_MAP_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;sound_open_dma: DMA channel %d busy or not allocated (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chn</span><span class="p">,</span> <span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">=</span> <span class="n">DMA_MAP_BUSY</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sound_open_dma</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sound_free_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">chn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">==</span> <span class="n">DMA_MAP_UNAVAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* printk( &quot;sound_free_dma: Bad access to DMA channel %d\n&quot;,  chn); */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">chn</span><span class="p">);</span>
	<span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">=</span> <span class="n">DMA_MAP_UNAVAIL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sound_free_dma</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">sound_close_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">chn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DMA_MAP_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sound_close_dma: Bad access to DMA channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma_alloc_map</span><span class="p">[</span><span class="n">chn</span><span class="p">]</span> <span class="o">=</span> <span class="n">DMA_MAP_FREE</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">sound_close_dma</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_sequencer_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sequencer_timer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">seq_timer</span><span class="p">,</span> <span class="n">do_sequencer_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">request_sound_timer</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">extern</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seq_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_timer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">count</span> <span class="o">+=</span> <span class="n">seq_time</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">seq_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sound_stop_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">seq_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">conf_printf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SOUND_TRACEINIT</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;%s&gt; at 0x%03x&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; irq %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">:</span> <span class="o">-</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dma %d&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;,%d&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">conf_printf</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">conf_printf2</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma2</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SOUND_TRACEINIT</span>
	<span class="k">return</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;%s&gt; at 0x%03x&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; irq %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">irq</span> <span class="o">:</span> <span class="o">-</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">printk</span><span class="p">(</span><span class="s">&quot; dma %d&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;,%d&quot;</span><span class="p">,</span> <span class="n">dma2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">conf_printf2</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
