<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › ad1848.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ad1848.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sound/oss/ad1848.c</span>
<span class="cm"> *</span>
<span class="cm"> * The low level driver for the AD1848/CS4248 codec chip which</span>
<span class="cm"> * is used for example in the MS Sound System.</span>
<span class="cm"> *</span>
<span class="cm"> * The CS4231 which is used in the GUS MAX and some other cards is</span>
<span class="cm"> * upwards compatible with AD1848 and this driver is able to drive it.</span>
<span class="cm"> *</span>
<span class="cm"> * CS4231A and AD1845 are upward compatible with CS4231. However</span>
<span class="cm"> * the new features of these chips are different.</span>
<span class="cm"> *</span>
<span class="cm"> * CS4232 is a PnP audio chip which contains a CS4231A (and SB, MPU).</span>
<span class="cm"> * CS4232A is an improved version of CS4232.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Thomas Sailer	: ioctl code reworked (vmalloc/vfree removed)</span>
<span class="cm"> *			  general sleep/wakeup clean up.</span>
<span class="cm"> * Alan Cox		: reformatted. Fixed SMP bugs. Moved to kernel alloc/free</span>
<span class="cm"> *		          of irqs. Use dev_id.</span>
<span class="cm"> * Christoph Hellwig	: adapted to module_init/module_exit</span>
<span class="cm"> * Aki Laukkanen	: added power management support</span>
<span class="cm"> * Arnaldo C. de Melo	: added missing restore_flags in ad1848_resume</span>
<span class="cm"> * Miguel Freitas       : added ISA PnP support</span>
<span class="cm"> * Alan Cox		: Added CS4236-&gt;4239 identification</span>
<span class="cm"> * Daniel T. Cobra	: Alernate config/mixer for later chips</span>
<span class="cm"> * Alan Cox		: Merged chip idents and config code</span>
<span class="cm"> *</span>
<span class="cm"> * TODO</span>
<span class="cm"> *		APM save restore assist code on IBM thinkpad</span>
<span class="cm"> *</span>
<span class="cm"> * Status:</span>
<span class="cm"> *		Tested. Believed fully functional.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/isapnp.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#define DEB(x)</span>
<span class="cp">#define DEB1(x)</span>
<span class="cp">#include &quot;sound_config.h&quot;</span>

<span class="cp">#include &quot;ad1848.h&quot;</span>
<span class="cp">#include &quot;ad1848_mixer.h&quot;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">dma1</span><span class="p">,</span> <span class="n">dma2</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">dual_dma</span><span class="p">;</span>	<span class="cm">/* 1, when two DMA channels allocated */</span>
	<span class="kt">int</span> 		<span class="n">subtype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">MCE_bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">saved_regs</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>	<span class="cm">/* Includes extended register space */</span>
	<span class="kt">int</span>             <span class="n">debug_flag</span><span class="p">;</span>

	<span class="kt">int</span>             <span class="n">audio_flags</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">record_dev</span><span class="p">,</span> <span class="n">playback_dev</span><span class="p">;</span>

	<span class="kt">int</span>             <span class="n">xfer_count</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">audio_mode</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">open_mode</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">intr_active</span><span class="p">;</span>
	<span class="kt">char</span>           <span class="o">*</span><span class="n">chip_name</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">model</span><span class="p">;</span>
<span class="cp">#define MD_1848		1</span>
<span class="cp">#define MD_4231		2</span>
<span class="cp">#define MD_4231A	3</span>
<span class="cp">#define MD_1845		4</span>
<span class="cp">#define MD_4232		5</span>
<span class="cp">#define MD_C930		6</span>
<span class="cp">#define MD_IWAVE	7</span>
<span class="cp">#define MD_4235         8 </span><span class="cm">/* Crystal Audio CS4235  */</span><span class="cp"></span>
<span class="cp">#define MD_1845_SSCAPE  9 </span><span class="cm">/* Ensoniq Soundscape PNP*/</span><span class="cp"></span>
<span class="cp">#define MD_4236		10 </span><span class="cm">/* 4236 and higher */</span><span class="cp"></span>
<span class="cp">#define MD_42xB		11 </span><span class="cm">/* CS 42xB */</span><span class="cp"></span>
<span class="cp">#define MD_4239		12 </span><span class="cm">/* CS4239 */</span><span class="cp"></span>

	<span class="cm">/* Mixer parameters */</span>
	<span class="kt">int</span>             <span class="n">recmask</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">supported_devices</span><span class="p">,</span> <span class="n">orig_devices</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">supported_rec_devices</span><span class="p">,</span> <span class="n">orig_rec_devices</span><span class="p">;</span>
	<span class="kt">int</span>            <span class="o">*</span><span class="n">levels</span><span class="p">;</span>
	<span class="kt">short</span>           <span class="n">mixer_reroute</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span>             <span class="n">dev_no</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer_ticks</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">timer_running</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">irq_ok</span><span class="p">;</span>
	<span class="n">mixer_ents</span>     <span class="o">*</span><span class="n">mix_devices</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">mixer_output_port</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ad1848_info</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ad1848_port_info</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">open_mode</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">speed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">speed_bits</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">channels</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">audio_format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">format_bits</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">ad1848_port_info</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">address_info</span> <span class="n">cfg</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">nr_ad1848_devs</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">deskpro_xl</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">deskpro_m</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">soundpro</span><span class="p">;</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">signed</span> <span class="kt">char</span> <span class="n">irq2dev</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="cp">#ifndef EXCLUDE_TIMERS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">timer_installed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">loaded</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ad_format_mask</span><span class="p">[</span><span class="mi">13</span> <span class="cm">/*devc-&gt;model */</span> <span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span><span class="p">,</span>	<span class="cm">/* AD1845 */</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="cm">/* CS4235 */</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span>	<span class="cm">/* Ensoniq Soundscape*/</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span>
	<span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span> <span class="o">|</span> <span class="n">AFMT_A_LAW</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span> <span class="o">|</span> <span class="n">AFMT_IMA_ADPCM</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">ad1848_info</span> <span class="n">adev_info</span><span class="p">[</span><span class="n">MAX_AUDIO_DEV</span><span class="p">];</span>

<span class="cp">#define io_Index_Addr(d)	((d)-&gt;base)</span>
<span class="cp">#define io_Indexed_Data(d)	((d)-&gt;base+1)</span>
<span class="cp">#define io_Status(d)		((d)-&gt;base+2)</span>
<span class="cp">#define io_Polled_IO(d)		((d)-&gt;base+3)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define CAP_F_TIMER 0x01     </span>
<span class="p">}</span> <span class="n">capabilities</span> <span class="p">[</span><span class="mi">10</span> <span class="cm">/*devc-&gt;model */</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
     <span class="p">{</span><span class="mi">0</span><span class="p">}</span>
    <span class="p">,{</span><span class="mi">0</span><span class="p">}</span>           <span class="cm">/* MD_1848  */</span>
    <span class="p">,{</span><span class="n">CAP_F_TIMER</span><span class="p">}</span> <span class="cm">/* MD_4231  */</span>
    <span class="p">,{</span><span class="n">CAP_F_TIMER</span><span class="p">}</span> <span class="cm">/* MD_4231A */</span>
    <span class="p">,{</span><span class="n">CAP_F_TIMER</span><span class="p">}</span> <span class="cm">/* MD_1845  */</span>
    <span class="p">,{</span><span class="n">CAP_F_TIMER</span><span class="p">}</span> <span class="cm">/* MD_4232  */</span>
    <span class="p">,{</span><span class="mi">0</span><span class="p">}</span>           <span class="cm">/* MD_C930  */</span>
    <span class="p">,{</span><span class="n">CAP_F_TIMER</span><span class="p">}</span> <span class="cm">/* MD_IWAVE */</span>
    <span class="p">,{</span><span class="mi">0</span><span class="p">}</span>           <span class="cm">/* MD_4235  */</span>
    <span class="p">,{</span><span class="n">CAP_F_TIMER</span><span class="p">}</span> <span class="cm">/* MD_1845_SSCAPE */</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isapnp</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isapnpjump</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">reverse</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">audio_activated</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isapnp</span><span class="p">;</span>
<span class="cp">#endif</span>



<span class="k">static</span> <span class="kt">int</span>      <span class="n">ad1848_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_close</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_output_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_start_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">ad1848_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>      <span class="n">ad1848_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_halt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_halt_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_halt_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>     <span class="n">ad1848_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">adintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>

<span class="cp">#ifndef EXCLUDE_TIMERS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ad1848_tmr_install</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ad1848_tmr_reprogram</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad_read</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">900000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/*Are we initializing */</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">xreg</span><span class="p">,</span> <span class="n">xra</span><span class="p">;</span>

		<span class="n">xreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">xra</span> <span class="o">=</span> <span class="p">(((</span><span class="n">xreg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span> <span class="o">|</span> <span class="p">((</span><span class="n">xreg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="mi">23</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">xra</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad_write</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">900000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Are we initializing */</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">xreg</span><span class="p">,</span> <span class="n">xra</span><span class="p">;</span>
		
		<span class="n">xreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">xra</span> <span class="o">=</span> <span class="p">(((</span><span class="n">xreg</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span> <span class="o">|</span> <span class="p">((</span><span class="n">xreg</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="mi">23</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">xra</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)),</span> <span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
		<span class="n">outb</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_for_calibration</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the auto calibration process has finished.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1)       Wait until the chip becomes ready (reads don&#39;t return 0x80).</span>
<span class="cm">	 * 2)       Wait until the ACI bit of I11 gets on and then off.</span>
<span class="cm">	 */</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848: Auto calibration timed out(1).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">80000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845_SSCAPE</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848: Auto calibration timed out(3).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad_mute</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save old register settings and mute output channels</span>
<span class="cm">	 */</span>
	 
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad_unmute</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad_enter_MCE</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">prev</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/*Are we initializing */</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad_leave_MCE</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prev</span><span class="p">,</span> <span class="n">acal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/*Are we initializing */</span>
		<span class="n">timeout</span><span class="o">--</span><span class="p">;</span>

	<span class="n">acal</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x00</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear the MCE bit */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">prev</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Not in MCE mode */</span>
	<span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x00</span><span class="p">),</span> <span class="n">io_Index_Addr</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear the MCE bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acal</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>	<span class="cm">/* Auto calibration is enabled */</span>
		<span class="n">wait_for_calibration</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_set_recmask</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">recdev</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span><span class="p">;</span>

	<span class="cm">/* Rename the mixer bits if necessary */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* Count selected device bits */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">soundpro</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">SOUND_MASK_MIC</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Too many devices selected */</span>
			<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">;</span>	<span class="cm">/* Filter out active settings */</span>

			<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* Count selected device bits */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
					<span class="n">n</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">=</span> <span class="n">SOUND_MASK_MIC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MASK_MIC</span>:
			<span class="n">recdev</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MASK_LINE</span>:
		<span class="k">case</span> <span class="n">SOUND_MASK_LINE3</span>:
			<span class="n">recdev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MASK_CD</span>:
		<span class="k">case</span> <span class="n">SOUND_MASK_LINE1</span>:
			<span class="n">recdev</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MASK_IMIX</span>:
			<span class="n">recdev</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">SOUND_MASK_MIC</span><span class="p">;</span>
			<span class="n">recdev</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">recdev</span> <span class="o">&lt;&lt;=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="n">recdev</span><span class="p">);</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="n">recdev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* soundpro */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">set_rec_bit</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* For each bit */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* Device not supported */</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">LEFT_CHN</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">RIGHT_CHN</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">nbits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* Inexistent channel */</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * This is tricky:</span>
<span class="cm">				 * set_rec_bit becomes 1 if the corresponding bit in mask is set</span>
<span class="cm">				 * then it gets flipped if the polarity is inverse</span>
<span class="cm">				 */</span>
				<span class="n">set_rec_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">recpol</span><span class="p">;</span>

				<span class="n">val</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">recreg</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">recpos</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">set_rec_bit</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">recpos</span><span class="p">);</span>
				<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">recreg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Rename the mixer bits back if necessary */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="p">{</span>
				<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">oss_change_bits</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regval</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">muteval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">newval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mute</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mutemask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set_mute_bit</span><span class="p">;</span>

	<span class="n">set_mute_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">newval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">mutepol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">polarity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* Reverse */</span>
		<span class="n">newval</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">newval</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">nbits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">bitpos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">mutepos</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
	<span class="p">{</span>			<span class="cm">/* if there is no mute bit */</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No mute bit; do nothing special */</span>
		<span class="n">mutemask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* No mute bit; do nothing special */</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">mute</span> <span class="o">=</span> <span class="p">(</span><span class="n">set_mute_bit</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">mutepos</span><span class="p">);</span>
		<span class="n">mutemask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">chn</span><span class="p">].</span><span class="n">mutepos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">newval</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="n">newval</span> <span class="o">*</span> <span class="n">mask</span><span class="p">)</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* Scale it */</span>
	<span class="o">*</span><span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>			<span class="cm">/* Clear bits */</span>
	<span class="o">*</span><span class="n">regval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">newval</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>		<span class="cm">/* Set new value */</span>

	<span class="o">*</span><span class="n">muteval</span> <span class="o">&amp;=</span> <span class="n">mutemask</span><span class="p">;</span>
	<span class="o">*</span><span class="n">muteval</span> <span class="o">|=</span> <span class="n">mute</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_mixer_get</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_mixer_set_channel</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">regoffs</span><span class="p">,</span> <span class="n">muteregoffs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="n">muteval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">regoffs</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">channel</span><span class="p">].</span><span class="n">regno</span><span class="p">;</span>
	<span class="n">muteregoffs</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">channel</span><span class="p">].</span><span class="n">mutereg</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">regoffs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">muteregoffs</span> <span class="o">!=</span> <span class="n">regoffs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">muteval</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">muteregoffs</span><span class="p">);</span>
		<span class="n">oss_change_bits</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">muteval</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">oss_change_bits</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">regoffs</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">regoffs</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">muteregoffs</span> <span class="o">!=</span> <span class="n">regoffs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">muteregoffs</span><span class="p">,</span> <span class="n">muteval</span><span class="p">);</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">muteregoffs</span><span class="p">]</span> <span class="o">=</span> <span class="n">muteval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_mixer_set</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000000ff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retvol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">LEFT_CHN</span><span class="p">].</span><span class="n">nbits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">RIGHT_CHN</span><span class="p">].</span><span class="n">nbits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Mono control */</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">retvol</span> <span class="o">=</span> <span class="n">left</span> <span class="o">|</span> <span class="p">(</span><span class="n">right</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* Scale volumes */</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">mix_cvt</span><span class="p">[</span><span class="n">left</span><span class="p">];</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">mix_cvt</span><span class="p">[</span><span class="n">right</span><span class="p">];</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">retvol</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the left channel</span>
<span class="cm">	 */</span>
	<span class="n">ad1848_mixer_set_channel</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">LEFT_CHN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the right channel</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span><span class="p">[</span><span class="n">dev</span><span class="p">][</span><span class="n">RIGHT_CHN</span><span class="p">].</span><span class="n">nbits</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ad1848_mixer_set_channel</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">RIGHT_CHN</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retvol</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_mixer_reset</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ad1848_mix_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s_%d&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">,</span> <span class="n">nr_ad1848_devs</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">=</span> <span class="n">MODE1_REC_DEVICES</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">MD_4231</span>:
		<span class="k">case</span> <span class="n">MD_4231A</span>:
		<span class="k">case</span> <span class="n">MD_1845</span>:
		<span class="k">case</span> <span class="n">MD_1845_SSCAPE</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">MODE2_MIXER_DEVICES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MD_C930</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">C930_MIXER_DEVICES</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">c930_mix_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MD_IWAVE</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">MODE3_MIXER_DEVICES</span><span class="p">;</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">iwave_mix_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MD_42xB</span>:
		<span class="k">case</span> <span class="n">MD_4239</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">cs42xb_mix_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">MODE3_MIXER_DEVICES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MD_4232</span>:
		<span class="k">case</span> <span class="n">MD_4235</span>:
		<span class="k">case</span> <span class="n">MD_4236</span>:
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">MODE3_MIXER_DEVICES</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">MD_1848</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">soundpro</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">SPRO_MIXER_DEVICES</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">=</span> <span class="n">SPRO_REC_DEVICES</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mix_devices</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">spro_mix_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">=</span> <span class="n">MODE1_MIXER_DEVICES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">orig_devices</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">orig_rec_devices</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span> <span class="o">=</span> <span class="n">load_mixer_volumes</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">default_mixer_levels</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">ad1848_mixer_set</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	
	<span class="n">ad1848_set_recmask</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">SOUND_MASK_MIC</span><span class="p">);</span>
	
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_output_port</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">|</span> <span class="n">AUDIO_HEADPHONE</span> <span class="o">|</span> <span class="n">AUDIO_LINE_OUT</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">soundpro</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_output_port</span> <span class="o">&amp;</span> <span class="n">AUDIO_SPEAKER</span><span class="p">)</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Unmute mono out */</span>
		<span class="k">else</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Mute mono out */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * From the &quot;wouldn&#39;t it be nice if the mixer API had (better)</span>
<span class="cm">		 * support for custom stuff&quot; category</span>
<span class="cm">		 */</span>
		<span class="cm">/* Enable surround mode and SB16 mixer */</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_mixer_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="n">mixer_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_PRIVATE1</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">AUDIO_SPEAKER</span> <span class="o">|</span> <span class="n">AUDIO_HEADPHONE</span> <span class="o">|</span> <span class="n">AUDIO_LINE_OUT</span><span class="p">);</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_output_port</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">AUDIO_HEADPHONE</span> <span class="o">|</span> <span class="n">AUDIO_LINE_OUT</span><span class="p">;</span>	<span class="cm">/* Always on */</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_output_port</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AUDIO_SPEAKER</span><span class="p">)</span>
				<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Unmute mono out */</span>
			<span class="k">else</span>
				<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>		<span class="cm">/* Mute mono out */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_output_port</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_PRIVATE2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">(</span><span class="n">ad1848_control</span><span class="p">(</span><span class="n">AD1848_MIXER_REROUTE</span><span class="p">,</span> <span class="n">val</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">cmd</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;M&#39;</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_SIOC_WRITE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">ad1848_set_recmask</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				
				<span class="nl">default:</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">ad1848_mixer_set</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> 
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> 
			<span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Return parameters</span>
<span class="cm">				 */</span>
			    
				<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">recmask</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				
				<span class="k">case</span> <span class="n">SOUND_MIXER_DEVMASK</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				
				<span class="k">case</span> <span class="n">SOUND_MIXER_STEREODEVS</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_C930</span><span class="p">)</span>
						<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SOUND_MASK_SPEAKER</span> <span class="o">|</span> <span class="n">SOUND_MASK_IMIX</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				
				<span class="k">case</span> <span class="n">SOUND_MIXER_RECMASK</span>:
					<span class="n">val</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">SOUND_MIXER_CAPS</span>:
					<span class="n">val</span><span class="o">=</span><span class="n">SOUND_CAP_EXCL_INPUT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="nl">default:</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">ad1848_mixer_get</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The sampling speed is encoded in the least significant nibble of I8. The</span>
<span class="cm">	 * LSB selects the clock source (0=24.576 MHz, 1=16.9344 MHz) and other</span>
<span class="cm">	 * three bits select the divisor (indirectly):</span>
<span class="cm">	 *</span>
<span class="cm">	 * The available speeds are in the following table. Keep the speeds in</span>
<span class="cm">	 * the increasing order.</span>
<span class="cm">	 */</span>
	<span class="k">typedef</span> <span class="k">struct</span>
	<span class="p">{</span>
		<span class="kt">int</span>             <span class="n">speed</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">speed_struct</span><span class="p">;</span>

	<span class="k">static</span> <span class="n">speed_struct</span> <span class="n">speed_table</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">{</span><span class="mi">5510</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">5510</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">6620</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">8000</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">9600</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">11025</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">16000</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">18900</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">22050</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">27420</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">32000</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">33075</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">37800</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">44100</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">48000</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">selected</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">speed_table</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">speed_struct</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>	<span class="cm">/* AD1845 has different timer than others */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">)</span>
			<span class="n">arg</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">;</span>

		<span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed_bits</span> <span class="o">=</span> <span class="n">speed_table</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">bits</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;</span> <span class="n">speed_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">speed</span><span class="p">)</span>
		<span class="n">selected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;</span> <span class="n">speed_table</span><span class="p">[</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">speed</span><span class="p">)</span>
		<span class="n">selected</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="cm">/*really */</span> <span class="p">;</span> <span class="n">selected</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span>
			<span class="n">selected</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">arg</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span><span class="p">;</span>

			<span class="n">diff1</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">-</span> <span class="n">speed_table</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">speed</span><span class="p">;</span>
			<span class="n">diff2</span> <span class="o">=</span> <span class="n">speed_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">speed</span> <span class="o">-</span> <span class="n">arg</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">diff1</span> <span class="o">&lt;</span> <span class="n">diff2</span><span class="p">)</span>
				<span class="n">selected</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">selected</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">selected</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848: Can&#39;t find speed???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">selected</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed_table</span><span class="p">[</span><span class="n">selected</span><span class="p">].</span><span class="n">speed</span><span class="p">;</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed_bits</span> <span class="o">=</span> <span class="n">speed_table</span><span class="p">[</span><span class="n">selected</span><span class="p">].</span><span class="n">bits</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">short</span> <span class="nf">ad1848_set_channels</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ad1848_set_bits</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">format_tbl</span>
	<span class="p">{</span>
		  <span class="kt">int</span>             <span class="n">format</span><span class="p">;</span>
		  <span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">format2bits</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="p">{</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_MU_LAW</span><span class="p">,</span> <span class="mi">1</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_A_LAW</span><span class="p">,</span> <span class="mi">3</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_IMA_ADPCM</span><span class="p">,</span> <span class="mi">5</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_U8</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_S16_LE</span><span class="p">,</span> <span class="mi">2</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_S16_BE</span><span class="p">,</span> <span class="mi">6</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_S8</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_U16_LE</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">}</span>
		<span class="p">,</span>
		<span class="p">{</span>
			<span class="n">AFMT_U16_BE</span><span class="p">,</span> <span class="mi">0</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format2bits</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">format_tbl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">arg</span> <span class="o">&amp;</span> <span class="n">ad_format_mask</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">]))</span>
		<span class="n">arg</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>

	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format2bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">format</span> <span class="o">==</span> <span class="n">arg</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">format_bits</span> <span class="o">=</span> <span class="n">format2bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>		<span class="cm">/* Was not supported */</span>

			<span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="cm">/* Still hanging here. Something must be terribly wrong */</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">format_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="n">ad1848_audio_driver</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>			<span class="o">=</span> <span class="n">ad1848_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>			<span class="o">=</span> <span class="n">ad1848_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_block</span>		<span class="o">=</span> <span class="n">ad1848_output_block</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_input</span>		<span class="o">=</span> <span class="n">ad1848_start_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_input</span>	<span class="o">=</span> <span class="n">ad1848_prepare_for_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_for_output</span>	<span class="o">=</span> <span class="n">ad1848_prepare_for_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_io</span>		<span class="o">=</span> <span class="n">ad1848_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_input</span>		<span class="o">=</span> <span class="n">ad1848_halt_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">halt_output</span>		<span class="o">=</span> <span class="n">ad1848_halt_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>		<span class="o">=</span> <span class="n">ad1848_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_speed</span>		<span class="o">=</span> <span class="n">ad1848_set_speed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bits</span>		<span class="o">=</span> <span class="n">ad1848_set_bits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_channels</span>		<span class="o">=</span> <span class="n">ad1848_set_channels</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mixer_operations</span> <span class="n">ad1848_mixer_operations</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="s">&quot;SOUNDPORT&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;AD1848/CS4248/CS4231&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>	<span class="o">=</span> <span class="n">ad1848_mixer_ioctl</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_audiodevs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="cm">/* here we don&#39;t have to protect against intr */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">||</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">mode</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dual_dma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dual_dma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ad1848_trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">record_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">playback_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm"> * Mute output until the playback really starts. This decreases clicking (hope so).</span>
<span class="cm"> */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ad_mute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_close</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="n">DEB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_close(void)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ad1848_halt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span><span class="p">;</span>
	<span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ad_unmute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_output_block</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">==</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cnt</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span><span class="p">))</span>	<span class="cm">/* 16 bit data */</span>
			<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">intrflag</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cnt</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">			 * Auto DMA mode on. No need to react</span>
<span class="cm">			 */</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_start_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intrflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">==</span> <span class="n">AFMT_IMA_ADPCM</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">cnt</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_S16_BE</span><span class="p">))</span>	<span class="cm">/* 16 bit data */</span>
			<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cnt</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">intrflag</span> <span class="o">&amp;&amp;</span>
		<span class="n">cnt</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">			 * Auto DMA mode on. No need to react</span>
<span class="cm">			 */</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1848</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="n">cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ad_unmute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">intr_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_prepare_for_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">fs</span><span class="p">,</span> <span class="n">old_fs</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="n">ad_mute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed_bits</span> <span class="o">|</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">format_bits</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fs</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">ad_enter_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>	<span class="cm">/* Enables changes to the format select reg */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span> <span class="cm">/* Use alternate speed select registers */</span>
	<span class="p">{</span>
		<span class="n">fs</span> <span class="o">&amp;=</span> <span class="mh">0xf0</span><span class="p">;</span>	<span class="cm">/* Mask off the rate select bits */</span>

		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Speed MSB */</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Speed LSB */</span>
	<span class="p">}</span>
	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_4232</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;=</span> <span class="n">MD_4236</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_IWAVE</span><span class="p">)</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">);</span>	<span class="cm">/* Disable variable frequency select */</span>

	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write to I8 starts resynchronization. Wait until it completes.</span>
<span class="cm">	 */</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;=</span> <span class="n">MD_4232</span><span class="p">)</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">);</span>

	<span class="n">ad_leave_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>	<span class="cm">/*</span>
<span class="cm">				 * Starts the calibration process.</span>
<span class="cm">				 */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifndef EXCLUDE_TIMERS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">timer_installed</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">old_fs</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ad1848_tmr_reprogram</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ad1848_halt_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_prepare_for_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fs</span><span class="p">,</span> <span class="n">old_fs</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">fs</span> <span class="o">=</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed_bits</span> <span class="o">|</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">format_bits</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">fs</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">ad_enter_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>	<span class="cm">/* Enables changes to the format select reg */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845_SSCAPE</span><span class="p">))</span>	<span class="cm">/* Use alternate speed select registers */</span>
	<span class="p">{</span>
		<span class="n">fs</span> <span class="o">&amp;=</span> <span class="mh">0xf0</span><span class="p">;</span>	<span class="cm">/* Mask off the rate select bits */</span>

		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Speed MSB */</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Speed LSB */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_4232</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_IWAVE</span><span class="p">)</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">);</span>	<span class="cm">/* Disable variable frequency select */</span>

	<span class="cm">/*</span>
<span class="cm">	 * If mode &gt;= 2 (CS4231), set I28. It&#39;s the capture format register.</span>
<span class="cm">	 */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1848</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">old_fs</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Write to I28 starts resynchronization. Wait until it completes.</span>
<span class="cm">		 */</span>
		
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1848</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * CS4231 compatible devices don&#39;t have separate sampling rate selection</span>
<span class="cm">			 * register for recording an playback. The I8 register is shared so we have to</span>
<span class="cm">			 * set the speed encoding bits of it too.</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp</span> <span class="o">=</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">speed_bits</span> <span class="o">|</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">);</span>

			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Write to I8 starts resynchronization. Wait until it completes.</span>
<span class="cm">			 */</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>

			<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>			<span class="cm">/* For AD1848 set I8. */</span>

		<span class="n">old_fs</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Write to I8 starts resynchronization. Wait until it completes.</span>
<span class="cm">		 */</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_4232</span><span class="p">)</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">);</span>

	<span class="n">ad_leave_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>	<span class="cm">/*</span>
<span class="cm">				 * Starts the calibration process.</span>
<span class="cm">				 */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">xfer_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifndef EXCLUDE_TIMERS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">timer_installed</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">old_fs</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">ad1848_tmr_reprogram</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ad1848_halt_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_halt</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bits</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
		<span class="n">ad1848_halt_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="mh">0x02</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
		<span class="n">ad1848_halt_input</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_halt_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Capture not enabled */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ad_mute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="kt">int</span>             <span class="n">tmout</span><span class="p">;</span>
		
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
		        <span class="n">disable_dma</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmout</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">tmout</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">);</span>	<span class="cm">/* Stop capture */</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
		        <span class="n">enable_dma</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear interrupt status */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear interrupt status */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_halt_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Playback not enabled */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ad_mute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="kt">int</span>             <span class="n">tmout</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
		        <span class="n">disable_dma</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tmout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmout</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">tmout</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">);</span>	<span class="cm">/* Stop playback */</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">isa_dma_bridge_buggy</span><span class="p">)</span>
		       <span class="n">enable_dma</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear interrupt status */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear interrupt status */</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_trigger</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_port_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp</span><span class="p">,</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">state</span> <span class="o">&amp;=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">old</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span>
			  <span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
		  <span class="k">else</span>
			  <span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">portc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x01</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ad_mute(devc); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		  <span class="n">ad_unmute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_init_hw</span><span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span> <span class="n">devc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">init_values</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initial values for the indirect registers of CS4248/AD1848.</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="kt">int</span>      <span class="n">init_values_a</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* Positions 16 to 31 just for CS4231/2 and ad1845 */</span>
		<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="kt">int</span>      <span class="n">init_values_b</span><span class="p">[]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="cm">/* </span>
<span class="cm">		   Values for the newer chips</span>
<span class="cm">		   Some of the register initialization values were changed. In</span>
<span class="cm">		   order to get rid of the click that preceded PCM playback,</span>
<span class="cm">		   calibration was disabled on the 10th byte. On that same byte,</span>
<span class="cm">		   dual DMA was enabled; on the 11th byte, ADC dithering was</span>
<span class="cm">		   enabled, since that is theoretically desirable; on the 13th</span>
<span class="cm">		   byte, Mode 3 was selected, to enable access to extended</span>
<span class="cm">		   registers.</span>
<span class="cm">		 */</span>
		<span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0xa8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
 		<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
 		<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 *	Select initialisation data</span>
<span class="cm">	 */</span>
	 
	<span class="n">init_values</span> <span class="o">=</span> <span class="n">init_values_a</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;=</span> <span class="n">MD_4236</span><span class="p">)</span>
		<span class="n">init_values</span> <span class="o">=</span> <span class="n">init_values_b</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">init_values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>


	<span class="n">ad_mute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>		<span class="cm">/* Initialize some variables */</span>
	<span class="n">ad_unmute</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>	<span class="cm">/* Leave it unmuted now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;</span> <span class="n">MD_1848</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="k">else</span> 
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>		<span class="cm">/* Mode2 = enabled */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_IWAVE</span><span class="p">)</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>	<span class="cm">/* Select codec mode 3 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">init_values</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_IWAVE</span><span class="p">)</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>	<span class="cm">/* Playback and capture counters enabled */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;</span> <span class="n">MD_1848</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* Dual DMA mode */</span>
		<span class="k">else</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* Single DMA mode */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">27</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">);</span>		<span class="cm">/* Alternate freq select enabled */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_IWAVE</span><span class="p">)</span>
		<span class="p">{</span>		<span class="cm">/* Some magic Interwave specific initialization */</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>	<span class="cm">/* Select codec mode 3 */</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>	<span class="cm">/* Playback and capture counters enabled */</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">);</span>	<span class="cm">/* Alternate feature enable */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		  <span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_DUPLEX</span><span class="p">;</span>
		  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">);</span>	<span class="cm">/* Single DMA mode */</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">soundpro</span><span class="p">)</span>
			  <span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Mode2 = enabled */</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear pending interrupts */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Toggle the MCE bit. It completes the initialization phase.</span>
<span class="cm">	 */</span>

	<span class="n">ad_enter_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>	<span class="cm">/* In case the bit was off */</span>
	<span class="n">ad_leave_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="n">ad1848_mixer_reset</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ad1848_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ports</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ad_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">osp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev_info</span><span class="p">[</span><span class="n">nr_ad1848_devs</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp1</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">tmp2</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">optiC930</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* OPTi 82C930 flag */</span>
	<span class="kt">int</span> <span class="n">interwave</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ad1847_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cs4248_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sscape_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">io_base</span> <span class="o">=</span> <span class="n">ports</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io_base</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ad_flags</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ad_flags</span> <span class="o">==</span> <span class="mh">0x12345678</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">interwave</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ad_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ad_flags</span> <span class="o">==</span> <span class="mh">0x87654321</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">sscape_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ad_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ad_flags</span> <span class="o">==</span> <span class="mh">0x12345677</span><span class="p">)</span>
		<span class="p">{</span>
		    <span class="n">cs4248_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		    <span class="o">*</span><span class="n">ad_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_ad1848_devs</span> <span class="o">&gt;=</span> <span class="n">MAX_AUDIO_DEV</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ad1848 - Too many audio devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">io_base</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">MCE_bit</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AD1848&quot;</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_1848</span><span class="p">;</span>	<span class="cm">/* AD1848 or CS4248 */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">levels</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">debug_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that the I/O address is in use.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The bit 0x80 of the base I/O port is known to be 0 after the</span>
<span class="cm">	 * chip has performed its power on initialization. Just assume</span>
<span class="cm">	 * this has happened before the OS is starting.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the I/O address is unused, it typically returns 0xff.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect: The base I/O address appears to be dead</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the device to stop initialization</span>
<span class="cm">	 */</span>
	
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">x</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step A</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Not ready. Let&#39;s wait */</span>
		<span class="n">ad_leave_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>	<span class="cm">/* Not a AD1848 */</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect error - step A (%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Test if it&#39;s possible to change contents of the indirect registers.</span>
<span class="cm">	 * Registers 0 and 1 are ADC volume registers. The bit 0x10 is read only</span>
<span class="cm">	 * so try to avoid using it.</span>
<span class="cm">	 */</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>	<span class="cm">/* 0x55 with bit 0x10 clear */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xaa</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x45</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">==</span> <span class="mh">0x65</span><span class="p">)</span>	<span class="cm">/* AD1847 has couple of bits hardcoded to 1 */</span>
			<span class="n">ad1847_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect error - step B (%x/%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step C</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x45</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0xaa</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">==</span> <span class="mh">0x8a</span><span class="p">)</span>	<span class="cm">/* AD1847 has few bits hardcoded to 1 */</span>
			<span class="n">ad1847_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect error - step C (%x/%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The indirect register I12 has some read only bits. Let&#39;s</span>
<span class="cm">	 * try to change them.</span>
<span class="cm">	 */</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="p">(</span><span class="o">~</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect error - step D (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! Last 4 bits of the reg I12 tell the chip revision.</span>
<span class="cm">	 *   0x01=RevB and 0x0A=RevC.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * The original AD1848/CS4248 has just 15 indirect registers. This means</span>
<span class="cm">	 * that I0 and I16 should return the same value (etc.).</span>
<span class="cm">	 * However this doesn&#39;t work with CS4248. Actually it seems to be impossible</span>
<span class="cm">	 * to detect if the chip is a CS4231 or CS4248.</span>
<span class="cm">	 * Ensure that the Mode2 enable bit of I12 is 0. Otherwise this test fails</span>
<span class="cm">	 * with CS4231.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * OPTi 82C930 has mode2 control bit in another place. This test will fail</span>
<span class="cm">	 * with it. Accept this situation as a possible indication of this chip.</span>
<span class="cm">	 */</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step F</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Mode2=disabled */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect step F(%d/%x/%x) - OPTi chip???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ad1847_flag</span><span class="p">)</span>
				<span class="n">optiC930</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try to switch the chip to mode2 (CS4231) by setting the MODE2 bit (0x40).</span>
<span class="cm">	 * The bit 0x80 is always 1 in CS4248 and CS4231.</span>
<span class="cm">	 */</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step G</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ad_flags</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ad_flags</span> <span class="o">==</span> <span class="mi">400</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ad_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Set mode2, clear 0x80 */</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">ad_flags</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ad_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ad_flags</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ad_flags</span> <span class="o">|=</span> <span class="n">AD_F_CS4248</span><span class="p">;</span>

		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4248&quot;</span><span class="p">;</span>	<span class="cm">/* Our best knowledge just now */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">optiC930</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *      CS4231 detected - is it?</span>
<span class="cm">		 *</span>
<span class="cm">		 *      Verify that setting I0 doesn&#39;t change I16.</span>
<span class="cm">		 */</span>
		
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step H</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Set I16 to known value */</span>

		<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">!=</span> <span class="mh">0x45</span><span class="p">)</span>	<span class="cm">/* No change -&gt; CS4231? */</span>
		<span class="p">{</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>	<span class="cm">/* Rotten bits? */</span>
			<span class="p">{</span>
				<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect error - step H(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="cm">/*</span>
<span class="cm">			 * Verify that some bits of I25 are read only.</span>
<span class="cm">			 */</span>

			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step I</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>	<span class="cm">/* Original bits */</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">~</span><span class="n">tmp1</span><span class="p">);</span>	<span class="cm">/* Invert all bits */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 *      It&#39;s at least CS4231</span>
<span class="cm">				 */</span>

				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4231&quot;</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4231</span><span class="p">;</span>
				
				<span class="cm">/*</span>
<span class="cm">				 * It could be an AD1845 or CS4231A as well.</span>
<span class="cm">				 * CS4231 and AD1845 report the same revision info in I25</span>
<span class="cm">				 * while the CS4231A reports different.</span>
<span class="cm">				 */</span>

				<span class="n">id</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Device busy??? */</span>
					<span class="n">id</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>	<span class="cm">/* Device still busy??? */</span>
					<span class="n">id</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
				<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step J (%02x/%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">)));</span>

                                <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* </span>
<span class="cm">					 * It must be a CS4231 or AD1845. The register I23 of</span>
<span class="cm">					 * CS4231 is undefined and it appears to be read only.</span>
<span class="cm">					 * AD1845 uses I23 for setting sample rate. Assume</span>
<span class="cm">					 * the chip is AD1845 if I23 is changeable.</span>
<span class="cm">					 */</span>

					<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">);</span>
					<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="o">~</span><span class="n">tmp</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">interwave</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_IWAVE</span><span class="p">;</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;IWave&quot;</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span>	<span class="cm">/* AD1845 ? */</span>
					<span class="p">{</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;AD1845&quot;</span><span class="p">;</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_1845</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cs4248_flag</span><span class="p">)</span>
					<span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ad_flags</span><span class="p">)</span>
							  <span class="o">*</span><span class="n">ad_flags</span> <span class="o">|=</span> <span class="n">AD_F_CS4248</span><span class="p">;</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4248&quot;</span><span class="p">;</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_1848</span><span class="p">;</span>
						<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Mode2 off */</span>
					<span class="p">}</span>
					<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>	<span class="cm">/* Restore */</span>
				<span class="p">}</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="k">switch</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* CS4236/CS4235/CS42xB/CS4239 */</span>
						<span class="p">{</span>
							<span class="kt">int</span> <span class="n">xid</span><span class="p">;</span>
							<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">);</span> <span class="cm">/* switch to mode 3 */</span>
							<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">);</span> <span class="cm">/* select extended register 25 */</span>
							<span class="n">xid</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_Indexed_Data</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>
							<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">);</span> <span class="cm">/* back to mode 0 */</span>
							<span class="k">switch</span> <span class="p">(</span><span class="n">xid</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span>
							<span class="p">{</span>
								<span class="k">case</span> <span class="mh">0x00</span>:
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4237B(B)&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_42xB</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="mh">0x08</span>:
									<span class="cm">/* Seems to be a 4238 ?? */</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4238&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_42xB</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="mh">0x09</span>:
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4238B&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_42xB</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="mh">0x0b</span>:
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4236B&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4236</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="mh">0x10</span>:
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4237B&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_42xB</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="mh">0x1d</span>:
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4235&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4235</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="k">case</span> <span class="mh">0x1e</span>:
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4239&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4239</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
								<span class="nl">default:</span>
									<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Chip ident is %X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xid</span><span class="o">&amp;</span><span class="mh">0x1F</span><span class="p">);</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS42xx&quot;</span><span class="p">;</span>
									<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4232</span><span class="p">;</span>
									<span class="k">break</span><span class="p">;</span>
							<span class="p">}</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* CS4232/CS4232A */</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4232&quot;</span><span class="p">;</span>
						<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4232</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
				
					<span class="k">case</span> <span class="mi">0</span>:
						<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xa0</span><span class="p">)</span>
						<span class="p">{</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4231A&quot;</span><span class="p">;</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4231A</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4321&quot;</span><span class="p">;</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4231</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="nl">default:</span> <span class="cm">/* maybe */</span>
						<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848: I25 = %02x/%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe7</span><span class="p">));</span>
                                                <span class="k">if</span> <span class="p">(</span><span class="n">optiC930</span><span class="p">)</span>
                                                <span class="p">{</span>
                                                        <span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;82C930&quot;</span><span class="p">;</span>
                                                        <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_C930</span><span class="p">;</span>
                                                <span class="p">}</span>
						<span class="k">else</span>
						<span class="p">{</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;CS4231&quot;</span><span class="p">;</span>
							<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_4231</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>	<span class="cm">/* Restore bits */</span>

			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step K</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Is it perhaps a SoundPro CMI8330?</span>
<span class="cm">		 * If so, then we should be able to change indirect registers</span>
<span class="cm">		 * greater than I15 after activating MODE2, even though reading</span>
<span class="cm">		 * back I12 does not show it.</span>
<span class="cm">		 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Let&#39;s try comparing register values</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp1</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tmp2</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848 detect step H(%d/%x/%x) - SoundPro chip?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">));</span>
				<span class="n">soundpro</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;SoundPro CMI 8330&quot;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - step L</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ad_flags</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1848</span><span class="p">)</span>
			  <span class="o">*</span><span class="n">ad_flags</span> <span class="o">|=</span> <span class="n">AD_F_CS4231</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ad1848_detect() - Detected OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1848</span> <span class="o">&amp;&amp;</span> <span class="n">ad1847_flag</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;AD1847&quot;</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">sscape_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">MD_1845_SSCAPE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ad1848_init</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ports</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_playback</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">dma_capture</span><span class="p">,</span> <span class="kt">int</span> <span class="n">share_dma</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">osp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! If irq &lt; 0, there is another driver which has allocated the IRQ</span>
<span class="cm">	 *   so that this driver doesn&#39;t need to allocate/deallocate it.</span>
<span class="cm">	 *   The actually used IRQ is ABS(irq).</span>
<span class="cm">	 */</span>

	<span class="kt">int</span> <span class="n">my_dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">dev_name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">;</span>

	<span class="n">ad1848_info</span>  <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev_info</span><span class="p">[</span><span class="n">nr_ad1848_devs</span><span class="p">];</span>

	<span class="n">ad1848_port_info</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">irq</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma1</span> <span class="o">=</span> <span class="n">dma_playback</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">=</span> <span class="n">dma_capture</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">subtype</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">.</span><span class="n">card_subtype</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">=</span> <span class="n">DMA_AUTOMODE</span><span class="p">;</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">playback_dev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">record_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span>
			<span class="s">&quot;%s (%s)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span>
			<span class="s">&quot;Generic audio codec (%s)&quot;</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">);</span>

	<span class="n">rename_region</span><span class="p">(</span><span class="n">ports</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">conf_printf2</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dma_playback</span><span class="p">,</span> <span class="n">dma_capture</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1848</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_C930</span><span class="p">)</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">|=</span> <span class="n">DMA_HARDSTOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&gt;</span> <span class="n">MD_1848</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma1</span> <span class="o">==</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dma1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_DUPLEX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span> <span class="o">|=</span> <span class="n">DMA_DUPLEX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">portc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ad1848_port_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">portc</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">my_dev</span> <span class="o">=</span> <span class="n">sound_install_audiodrv</span><span class="p">(</span><span class="n">AUDIO_DRIVER_VERSION</span><span class="p">,</span>
					     <span class="n">dev_name</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">ad1848_audio_driver</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">audio_driver</span><span class="p">),</span>
					     <span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_flags</span><span class="p">,</span>
					     <span class="n">ad_format_mask</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">],</span>
					     <span class="n">devc</span><span class="p">,</span>
					     <span class="n">dma_playback</span><span class="p">,</span>
					     <span class="n">dma_capture</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">my_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span> <span class="o">=</span> <span class="n">portc</span><span class="p">;</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">my_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">)</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">my_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">portc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">portc</span><span class="p">));</span>

	<span class="n">nr_ad1848_devs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ad1848_init_hw</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">=</span> <span class="n">my_dev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adintr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">my_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848: Unable to allocate IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Don&#39;t free it either then.. */</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capabilities</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CAP_F_TIMER</span><span class="p">)</span>
		<span class="p">{</span>
<span class="cp">#ifndef CONFIG_SMP</span>
			<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
<span class="cp">#endif			</span>

			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* Timer MSB */</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>	<span class="cm">/* Timer LSB */</span>
<span class="cp">#ifndef CONFIG_SMP</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Enable timer */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">100000</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">);</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Disable timer */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848: Interrupt test failed (IRQ%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
			<span class="k">else</span>
			<span class="p">{</span>
				<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Interrupt test OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif			</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Couldn&#39;t test. assume it&#39;s OK */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">irq2dev</span><span class="p">[</span><span class="o">-</span><span class="n">irq</span><span class="p">]</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span> <span class="o">=</span> <span class="n">my_dev</span><span class="p">;</span>

<span class="cp">#ifndef EXCLUDE_TIMERS</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">capabilities</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CAP_F_TIMER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq_ok</span><span class="p">)</span>
		<span class="n">ad1848_tmr_install</span><span class="p">(</span><span class="n">my_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">share_dma</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">(</span><span class="n">dma_playback</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848.c: Can&#39;t allocate DMA%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_playback</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_capture</span> <span class="o">!=</span> <span class="n">dma_playback</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sound_alloc_dma</span><span class="p">(</span><span class="n">dma_capture</span><span class="p">,</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848.c: Can&#39;t allocate DMA%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_capture</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">e</span> <span class="o">=</span> <span class="n">sound_install_mixer</span><span class="p">(</span><span class="n">MIXER_DRIVER_VERSION</span><span class="p">,</span>
				     <span class="n">dev_name</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ad1848_mixer_operations</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixer_operations</span><span class="p">),</span>
				     <span class="n">devc</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">my_dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">)</span>
			<span class="n">mixer_devs</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">my_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ad1848_control</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_ad1848_devs</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev_info</span><span class="p">[</span><span class="n">nr_ad1848_devs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">AD1848_SET_XTAL</span>:	<span class="cm">/* Change clock frequency of AD1845 (only ) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ad_enter_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
			<span class="n">ad_leave_MCE</span><span class="p">(</span><span class="n">devc</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">AD1848_MIXER_REROUTE</span>:
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">o</span> <span class="o">=</span> <span class="p">(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">o</span> <span class="o">&gt;=</span> <span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">SOUND_MIXER_NONE</span><span class="p">)</span>
			<span class="p">{</span>	<span class="cm">/* Just hide this control */</span>
				<span class="n">ad1848_mixer_set</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Shut up it */</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">);</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Make the mixer control identified by o to appear as n */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">mixer_reroute</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>	<span class="cm">/* Rename the control */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">))</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">))</span>
				<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">);</span>

			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_devices</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">);</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">supported_rec_devices</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ad1848_unload</span><span class="p">(</span><span class="kt">int</span> <span class="n">io_base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_playback</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma_capture</span><span class="p">,</span> <span class="kt">int</span> <span class="n">share_dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">mixer</span><span class="p">,</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">devc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ad1848_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adev_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">base</span> <span class="o">==</span> <span class="n">io_base</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">devc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adev_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">portc</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">share_dma</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* There is no point in freeing irq, if it wasn&#39;t allocated */</span>
				<span class="n">free_irq</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span><span class="p">);</span>

			<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">dma_playback</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dma_playback</span> <span class="o">!=</span> <span class="n">dma_capture</span><span class="p">)</span>
				<span class="n">sound_free_dma</span><span class="p">(</span><span class="n">dma_capture</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="n">mixer</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">dev_no</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mixer_dev</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">mixer</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span>
			<span class="n">sound_unload_mixerdev</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>

		<span class="n">nr_ad1848_devs</span><span class="o">--</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ad1848_devs</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">adev_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adev_info</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ad1848: Can&#39;t find device to be unloaded. Base=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">io_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">adintr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">ad1848_info</span> <span class="o">*</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alt_stat</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c930_stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

<span class="nl">interrupt_again:</span>		<span class="cm">/* Jump back here if int status doesn&#39;t reset */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;adintr: Why?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1848</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">));</span>	<span class="cm">/* Clear interrupt status */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_C930</span><span class="p">)</span>
		<span class="p">{</span>		<span class="cm">/* 82C930 has interrupt status register in MAD16 register MC11 */</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="cm">/* 0xe0e is C930 address port</span>
<span class="cm">			 * 0xe0f is C930 data port</span>
<span class="cm">			 */</span>
			<span class="n">outb</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mh">0xe0e</span><span class="p">);</span>
			<span class="n">c930_stat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xe0f</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">((</span><span class="o">~</span><span class="n">c930_stat</span><span class="p">),</span> <span class="mh">0xe0f</span><span class="p">);</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">alt_stat</span> <span class="o">=</span> <span class="p">(</span><span class="n">c930_stat</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1848</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">alt_stat</span> <span class="o">=</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">alt_stat</span><span class="p">);</span>	<span class="cm">/* Selective ack */</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">alt_stat</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">DMAbuf_inputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">record_dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">alt_stat</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">DMAbuf_outputintr</span><span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">playback_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">MD_1848</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">alt_stat</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>	<span class="cm">/* Timer interrupt */</span>
		<span class="p">{</span>
			<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_ticks</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifndef EXCLUDE_TIMERS</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer_installed</span> <span class="o">==</span> <span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span><span class="p">)</span>
				<span class="n">sound_timer_interrupt</span><span class="p">();</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Sometimes playback or capture interrupts occur while a timer interrupt</span>
<span class="cm"> * is being handled. The interrupt will not be retriggered if we don&#39;t</span>
<span class="cm"> * handle it now. Check if an interrupt is still pending and restart</span>
<span class="cm"> * the handler in this case.</span>
<span class="cm"> */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">io_Status</span><span class="p">(</span><span class="n">devc</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="k">goto</span> <span class="n">interrupt_again</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Experimental initialization sequence for the integrated sound system</span>
<span class="cm"> *	of the Compaq Deskpro M.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_deskpro_m</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;init_deskpro_m: Dead port 0xc44</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc44</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xc45</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc46</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xc47</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xc44</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xc45</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc46</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0xc47</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc44</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Experimental initialization sequence for the integrated sound system</span>
<span class="cm"> *	of Compaq Deskpro XL.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_deskpro</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;init_deskpro: Dead port 0xc44</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank 1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x04</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;init_deskpro: Invalid bank1 signature in port 0xc44</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * OK. It looks like a Deskpro so let&#39;s proceed.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * I/O port 0xc44 Audio configuration register.</span>
<span class="cm">	 *</span>
<span class="cm">	 * bits 0xc0:   Audio revision bits</span>
<span class="cm">	 *              0x00 = Compaq Business Audio</span>
<span class="cm">	 *              0x40 = MS Sound System Compatible (reset default)</span>
<span class="cm">	 *              0x80 = Reserved</span>
<span class="cm">	 *              0xc0 = Reserved</span>
<span class="cm">	 * bit 0x20:    No Wait State Enable</span>
<span class="cm">	 *              0x00 = Disabled (reset default, DMA mode)</span>
<span class="cm">	 *              0x20 = Enabled (programmed I/O mode)</span>
<span class="cm">	 * bit 0x10:    MS Sound System Decode Enable</span>
<span class="cm">	 *              0x00 = Decoding disabled (reset default)</span>
<span class="cm">	 *              0x10 = Decoding enabled</span>
<span class="cm">	 * bit 0x08:    FM Synthesis Decode Enable</span>
<span class="cm">	 *              0x00 = Decoding Disabled (reset default)</span>
<span class="cm">	 *              0x08 = Decoding enabled</span>
<span class="cm">	 * bit 0x04     Bank select</span>
<span class="cm">	 *              0x00 = Bank 0</span>
<span class="cm">	 *              0x04 = Bank 1</span>
<span class="cm">	 * bits 0x03    MSS Base address</span>
<span class="cm">	 *              0x00 = 0x530 (reset default)</span>
<span class="cm">	 *              0x01 = 0x604</span>
<span class="cm">	 *              0x02 = 0xf40</span>
<span class="cm">	 *              0x03 = 0xe80</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc44 (before): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set bank 1 of the register */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x58</span><span class="p">;</span>		<span class="cm">/* MSS Mode, MSS&amp;FM decode enabled */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x530</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x604</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xf40</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0xe80</span>:
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;init_deskpro: Invalid MSS port %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Write to bank=0 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc44 (after): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc44</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * I/O port 0xc45 FM Address Decode/MSS ID Register.</span>
<span class="cm">	 *</span>
<span class="cm">	 * bank=0, bits 0xfe:   FM synthesis Decode Compare bits 7:1 (default=0x88)</span>
<span class="cm">	 * bank=0, bit 0x01:    SBIC Power Control Bit</span>
<span class="cm">	 *                      0x00 = Powered up</span>
<span class="cm">	 *                      0x01 = Powered down</span>
<span class="cm">	 * bank=1, bits 0xfc:   MSS ID (default=0x40)</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc45 (before): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc45</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc45</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x88</span><span class="p">),</span> <span class="mh">0xc45</span><span class="p">);</span>	<span class="cm">/* FM base 7:0 = 0x88 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x10</span><span class="p">),</span> <span class="mh">0xc45</span><span class="p">);</span>	<span class="cm">/* MSS ID = 0x10 (MSS port returns 0x04) */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc45 (after): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc45</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc45</span><span class="p">));</span>
<span class="cp">#endif</span>


	<span class="cm">/*</span>
<span class="cm">	 * I/O port 0xc46 FM Address Decode/Address ASIC Revision Register.</span>
<span class="cm">	 *</span>
<span class="cm">	 * bank=0, bits 0xff:   FM synthesis Decode Compare bits 15:8 (default=0x03)</span>
<span class="cm">	 * bank=1, bits 0xff:   Audio addressing ASIC id</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc46 (before): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc46</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc46</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x03</span><span class="p">),</span> <span class="mh">0xc46</span><span class="p">);</span>	<span class="cm">/* FM base 15:8 = 0x03 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x11</span><span class="p">),</span> <span class="mh">0xc46</span><span class="p">);</span>	<span class="cm">/* ASIC ID = 0x11 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc46 (after): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc46</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc46</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * I/O port 0xc47 FM Address Decode Register.</span>
<span class="cm">	 *</span>
<span class="cm">	 * bank=0, bits 0xff:   Decode enable selection for various FM address bits</span>
<span class="cm">	 * bank=1, bits 0xff:   Reserved</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc47 (before): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc47</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc47</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x7c</span><span class="p">),</span> <span class="mh">0xc47</span><span class="p">);</span>	<span class="cm">/* FM decode enable bits = 0x7c */</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">outb</span><span class="p">((</span><span class="mh">0x00</span><span class="p">),</span> <span class="mh">0xc47</span><span class="p">);</span>	<span class="cm">/* Reserved bank1 = 0x00 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="cm">/* Debug printing */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc47 (after): &quot;</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=0 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc47</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x04</span><span class="p">),</span> <span class="mh">0xc44</span><span class="p">);</span>	<span class="cm">/* Select bank=1 */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc47</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * I/O port 0xc6f = Audio Disable Function Register</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc6f (before) = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc6f</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">outb</span><span class="p">((</span><span class="mh">0x80</span><span class="p">),</span> <span class="mh">0xc6f</span><span class="p">);</span>

<span class="cp">#ifdef DEBUGXL</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Port 0xc6f (after) = %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="mh">0xc6f</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">probe_ms_sound</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ports</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">tmp</span><span class="p">;</span>

	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Entered probe_ms_sound(%x, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* Has no IRQ/DMA registers */</span>
	<span class="p">{</span>
		<span class="cm">/* check_opl3(0x388, hw_config); */</span>
		<span class="k">return</span> <span class="n">ad1848_detect</span><span class="p">(</span><span class="n">ports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">osp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deskpro_xl</span> <span class="o">&amp;&amp;</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>	<span class="cm">/* Compaq Deskpro XL */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_deskpro</span><span class="p">(</span><span class="n">hw_config</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deskpro_m</span><span class="p">)</span>	<span class="cm">/* Compaq Deskpro M */</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init_deskpro_m</span><span class="p">(</span><span class="n">hw_config</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   * Check if the IO port returns valid signature. The original MS Sound</span>
<span class="cm">	   * system returns 0x04 while some cards (AudioTrix Pro for example)</span>
<span class="cm">	   * return 0x00 or 0x0f.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>	<span class="cm">/* Bus float */</span>
	<span class="p">{</span>
		  <span class="kt">int</span>             <span class="n">ret</span><span class="p">;</span>

		  <span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;I/O address is inactive (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">));</span>
		  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ad1848_detect</span><span class="p">(</span><span class="n">ports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">osp</span><span class="p">)))</span>
			  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;MSS signature = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0f</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">MDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No MSS signature detected on port 0x%x (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">inb</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)));</span>
		<span class="n">DDB</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Trying to detect codec anyway but IRQ/DMA may not work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ad1848_detect</span><span class="p">(</span><span class="n">ports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">osp</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSS: Bad IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
	<span class="p">{</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSS: Bad DMA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
		  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check that DMA0 is not in use with a 8 bit board.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSS: Can&#39;t use DMA0 with a 8 bit card/slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="mi">9</span> <span class="o">&amp;&amp;</span> <span class="n">inb</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSS: Can&#39;t use IRQ%d with a 8 bit card/slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ad1848_detect</span><span class="p">(</span><span class="n">ports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">osp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">attach_ms_sound</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ports</span><span class="p">,</span> <span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">signed</span> <span class="kt">char</span> <span class="n">interrupt_bits</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x20</span>
	<span class="p">};</span>
	<span class="kt">signed</span> <span class="kt">char</span>     <span class="n">bits</span><span class="p">;</span>
	<span class="kt">char</span>            <span class="n">dma2_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">static</span> <span class="kt">char</span>     <span class="n">dma_bits</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span>
	<span class="p">};</span>

	<span class="kt">int</span> <span class="n">config_port</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version_port</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma2</span> <span class="o">=</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* Has no IRQ/DMA registers */</span>
	<span class="p">{</span>
		<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad1848_init</span><span class="p">(</span><span class="s">&quot;MS Sound System&quot;</span><span class="p">,</span> <span class="n">ports</span><span class="p">,</span>
						    <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
						    <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
						    <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
						    <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">osp</span><span class="p">,</span>
						    <span class="n">owner</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the IRQ and DMA addresses.</span>
<span class="cm">	 */</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">interrupt_bits</span><span class="p">[</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSS: Bad IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">ports</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">((</span><span class="n">bits</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">),</span> <span class="n">config_port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">version_port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;[MSS: IRQ Conflict?]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the capture DMA channel</span>
<span class="cm"> */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">!=</span> <span class="n">dma</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="p">{</span>	<span class="cm">/* Unsupported combination. Try to swap channels */</span>
			<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>

			<span class="n">dma</span> <span class="o">=</span> <span class="n">dma2</span><span class="p">;</span>
			<span class="n">dma2</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">dma</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">dma2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">dma2_bit</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>	<span class="cm">/* Enable capture DMA */</span>
		<span class="p">}</span>
		<span class="k">else</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;MSS: Invalid capture DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dma2</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">dma2</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">=</span> <span class="n">dma2</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">((</span><span class="n">bits</span> <span class="o">|</span> <span class="n">dma_bits</span><span class="p">[</span><span class="n">dma</span><span class="p">]</span> <span class="o">|</span> <span class="n">dma2_bit</span><span class="p">),</span> <span class="n">config_port</span><span class="p">);</span>	<span class="cm">/* Write IRQ+DMA setup */</span>

	<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ad1848_init</span><span class="p">(</span><span class="s">&quot;MS Sound System&quot;</span><span class="p">,</span> <span class="n">ports</span><span class="p">,</span>
					  <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
					  <span class="n">dma</span><span class="p">,</span> <span class="n">dma2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">osp</span><span class="p">,</span>
					  <span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">unload_ms_sound</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ad1848_unload</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
		      <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		      <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
		      <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sound_unload_audiodev</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef EXCLUDE_TIMERS</span>

<span class="cm">/*</span>
<span class="cm"> * Timer stuff (for /dev/music).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_interval</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ad1848_tmr_start</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">xtal_nsecs</span><span class="p">;</span>	<span class="cm">/* nanoseconds per xtal oscillator tick */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">divider</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Length of the timer interval (in nanoseconds) depends on the</span>
<span class="cm">	 * selected crystal oscillator. Check this from bit 0x01 of I8.</span>
<span class="cm">	 *</span>
<span class="cm">	 * AD1845 has just one oscillator which has cycle time of 10.050 us</span>
<span class="cm">	 * (when a 24.576 MHz xtal oscillator is used).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Convert requested interval to nanoseconds before computing</span>
<span class="cm">	 * the timer divider.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845</span> <span class="o">||</span> <span class="n">devc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">MD_1845_SSCAPE</span><span class="p">)</span>
		<span class="n">xtal_nsecs</span> <span class="o">=</span> <span class="mi">10050</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">xtal_nsecs</span> <span class="o">=</span> <span class="mi">9920</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">xtal_nsecs</span> <span class="o">=</span> <span class="mi">9969</span><span class="p">;</span>

	<span class="n">divider</span> <span class="o">=</span> <span class="p">(</span><span class="n">usecs</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">xtal_nsecs</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">xtal_nsecs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>	<span class="cm">/* Don&#39;t allow shorter intervals than about 1ms */</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>	<span class="cm">/* Overflow check */</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Set upper bits */</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">divider</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>	<span class="cm">/* Set lower bits */</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Start the timer */</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">current_interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">divider</span> <span class="o">*</span> <span class="n">xtal_nsecs</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_tmr_reprogram</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 *    Audio driver has changed sampling rate so that a different xtal</span>
<span class="cm">	 *      oscillator was selected. We have to reprogram the timer rate.</span>
<span class="cm">	 */</span>

	<span class="n">ad1848_tmr_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">current_interval</span><span class="p">);</span>
	<span class="n">sound_timer_syncinterval</span><span class="p">(</span><span class="n">current_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_tmr_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ad1848_tmr_restart</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">flags</span><span class="p">;</span>
	<span class="n">ad1848_info</span>    <span class="o">*</span><span class="n">devc</span> <span class="o">=</span> <span class="p">(</span><span class="n">ad1848_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ad_write</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ad_read</span><span class="p">(</span><span class="n">devc</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">devc</span><span class="o">-&gt;</span><span class="n">timer_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sound_lowlev_timer</span> <span class="n">ad1848_tmr</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span>
	<span class="n">ad1848_tmr_start</span><span class="p">,</span>
	<span class="n">ad1848_tmr_disable</span><span class="p">,</span>
	<span class="n">ad1848_tmr_restart</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ad1848_tmr_install</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_installed</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Don&#39;t install another timer */</span>

	<span class="n">timer_installed</span> <span class="o">=</span> <span class="n">ad1848_tmr</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">sound_timer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ad1848_tmr</span><span class="p">,</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* EXCLUDE_TIMERS */</span><span class="cp"></span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad1848_detect</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad1848_init</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad1848_unload</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ad1848_control</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">probe_ms_sound</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">attach_ms_sound</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">unload_ms_sound</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">io</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">dma2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__initdata</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* I/O for a raw AD1848 card */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* IRQ to use */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* First DMA channel */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dma2</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* Second DMA channel */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* Card type */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">deskpro_xl</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Special magic for Deskpro XL boxen */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">deskpro_m</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* Special magic for Deskpro M box */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">soundpro</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* More special magic for SoundPro chips */</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">isapnpjump</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span>	<span class="s">&quot;When set to 0, Plug &amp; Play support will be disabled&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">isapnpjump</span><span class="p">,</span>	<span class="s">&quot;Jumps to a specific slot in the driver&#39;s PnP table. Use the source, Luke.&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reverse</span><span class="p">,</span>	<span class="s">&quot;When set to 1, will reverse ISAPnP search order&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_dev</span>	<span class="o">*</span><span class="n">ad1848_dev</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* Please add new entries at the end of the table */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	<span class="n">card_vendor</span><span class="p">,</span> <span class="n">card_device</span><span class="p">,</span>
			<span class="n">vendor</span><span class="p">,</span> <span class="n">function</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">mss_io</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">dma2</span><span class="p">;</span>   <span class="cm">/* index into isapnp table */</span>
        <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ad1848_isapnp_list</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;CMI 8330 SoundPRO&quot;</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;M&#39;</span><span class="p">,</span><span class="sc">&#39;I&#39;</span><span class="p">),</span> <span class="n">ISAPNP_DEVICE</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;@&#39;</span><span class="p">,</span><span class="sc">&#39;@&#39;</span><span class="p">,</span><span class="sc">&#39;@&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;CS4232 based card&quot;</span><span class="p">,</span>
                <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;C&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;CS4232 based card&quot;</span><span class="p">,</span>
                <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;C&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
        <span class="p">{</span><span class="s">&quot;OPL3-SA2 WSS mode&quot;</span><span class="p">,</span>
        	<span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;Y&#39;</span><span class="p">,</span><span class="sc">&#39;M&#39;</span><span class="p">,</span><span class="sc">&#39;H&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0021</span><span class="p">),</span>
                <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;Advanced Gravis InterWave Audio&quot;</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="sc">&#39;V&#39;</span><span class="p">),</span> <span class="n">ISAPNP_DEVICE</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="sc">&#39;V&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">),</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;M&#39;</span><span class="p">,</span><span class="sc">&#39;I&#39;</span><span class="p">),</span> <span class="n">ISAPNP_DEVICE</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;@&#39;</span><span class="p">,</span><span class="sc">&#39;@&#39;</span><span class="p">,</span><span class="sc">&#39;@&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span>       <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;C&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
        <span class="p">{</span>       <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span><span class="sc">&#39;S&#39;</span><span class="p">,</span><span class="sc">&#39;C&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0100</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* The main driver for this card is opl3sa2</span>
<span class="cm">        {       ISAPNP_ANY_ID, ISAPNP_ANY_ID,</span>
<span class="cm">		ISAPNP_VENDOR(&#39;Y&#39;,&#39;M&#39;,&#39;H&#39;), ISAPNP_FUNCTION(0x0021), 0 },</span>
<span class="cm">	*/</span>
	<span class="p">{</span>	<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="sc">&#39;V&#39;</span><span class="p">),</span> <span class="n">ISAPNP_DEVICE</span><span class="p">(</span><span class="mh">0x0001</span><span class="p">),</span>
		<span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;G&#39;</span><span class="p">,</span><span class="sc">&#39;R&#39;</span><span class="p">,</span><span class="sc">&#39;V&#39;</span><span class="p">),</span> <span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="nf">activate_dev</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">resname</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ad1848: %s %s config failed (out of resources?)[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devname</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">audio_activated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="n">__init</span> <span class="o">*</span><span class="nf">ad1848_init_generic</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>

	<span class="cm">/* Configure Audio device */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ad1848_dev</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">vendor</span><span class="p">,</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">((</span><span class="n">ad1848_dev</span> <span class="o">=</span> <span class="n">activate_dev</span><span class="p">(</span><span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ad1848&quot;</span><span class="p">,</span> <span class="n">ad1848_dev</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span> 	<span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">,</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">mss_io</span><span class="p">);</span>
			<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span> 		<span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">,</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">irq</span><span class="p">);</span>
			<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span> 		<span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">,</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">dma</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">dma2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">,</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">dma2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                        <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">type</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ad1848_isapnp_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pnp_card</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">busname</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

	<span class="cm">/* Initialize this baby. */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">ad1848_init_generic</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">hw_config</span><span class="p">,</span> <span class="n">slot</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We got it. */</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ad1848: PnP reports &#39;%s&#39; at i/o %#x, irq %d, dma %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">busname</span><span class="p">,</span>
		       <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
		       <span class="n">hw_config</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ad1848_isapnp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">address_info</span> <span class="o">*</span><span class="n">hw_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Count entries in sb_isapnp_list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_vendor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="n">i</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Check and adjust isapnpjump */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">isapnpjump</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">isapnpjump</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isapnpjump</span> <span class="o">=</span> <span class="n">reverse</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ad1848: Valid range for isapnpjump is 0-%d. Adjusted to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">isapnpjump</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">first</span> <span class="o">||</span> <span class="o">!</span><span class="n">reverse</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">isapnpjump</span><span class="p">;</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_vendor</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">bus</span> <span class="o">=</span> <span class="n">pnp_find_card</span><span class="p">(</span>
				<span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_vendor</span><span class="p">,</span>
				<span class="n">ad1848_isapnp_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_device</span><span class="p">,</span>
				<span class="n">bus</span><span class="p">)))</span> <span class="p">{</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ad1848_isapnp_init</span><span class="p">(</span><span class="n">hw_config</span><span class="p">,</span> <span class="n">bus</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">isapnpjump</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* start next search from here */</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">reverse</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ad1848</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ad1848/cs4248 codec driver Copyright (C) by Hannu Savolainen 1993-1996</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span><span class="p">(</span><span class="n">isapnp</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ad1848_isapnp_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;ad1848: No ISAPnP cards found, trying standard ones...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">isapnp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span><span class="p">(</span><span class="n">io</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">ports</span><span class="p">;</span>
	        <span class="k">if</span><span class="p">(</span> <span class="n">isapnp</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
	        <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">dma</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ad1848: must give I/O , IRQ and DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cfg</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">io</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">dma2</span> <span class="o">=</span> <span class="n">dma2</span><span class="p">;</span>
			<span class="n">cfg</span><span class="p">.</span><span class="n">card_subtype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	        <span class="p">}</span>

		<span class="n">ports</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ad1848&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ports</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;WSS config&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_ms_sound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ports</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">io</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">attach_ms_sound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="n">ports</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">);</span>
		<span class="n">loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cleanup_ad1848</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">loaded</span><span class="p">)</span>
		<span class="n">unload_ms_sound</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">){</span>
		<span class="k">if</span><span class="p">(</span><span class="n">audio_activated</span><span class="p">)</span>
			<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">ad1848_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_ad1848</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_ad1848</span><span class="p">);</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_ad1848</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* io, irq, dma, dma2, type */</span>
	<span class="kt">int</span> <span class="n">ints</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	
	<span class="n">str</span> <span class="o">=</span> <span class="n">get_options</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ints</span><span class="p">),</span> <span class="n">ints</span><span class="p">);</span>

	<span class="n">io</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">irq</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dma</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">dma2</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">type</span>	<span class="o">=</span> <span class="n">ints</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;ad1848=&quot;</span><span class="p">,</span> <span class="n">setup_ad1848</span><span class="p">);</span>	
<span class="cp">#endif</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
