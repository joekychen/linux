<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › swarm_cs4297a.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>swarm_cs4297a.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************************</span>
<span class="cm">*</span>
<span class="cm">*      &quot;swarm_cs4297a.c&quot; --  Cirrus Logic-Crystal CS4297a linux audio driver.</span>
<span class="cm">*</span>
<span class="cm">*      Copyright (C) 2001  Broadcom Corporation.</span>
<span class="cm">*      Copyright (C) 2000,2001  Cirrus Logic Corp.  </span>
<span class="cm">*            -- adapted from drivers by Thomas Sailer, </span>
<span class="cm">*            -- but don&#39;t bug him; Problems should go to:</span>
<span class="cm">*            -- tom woller (twoller@crystal.cirrus.com) or</span>
<span class="cm">*               (audio@crystal.cirrus.com).</span>
<span class="cm">*            -- adapted from cs4281 PCI driver for cs4297a on</span>
<span class="cm">*               BCM1250 Synchronous Serial interface</span>
<span class="cm">*               (Kip Walker, Broadcom Corp.)</span>
<span class="cm">*      Copyright (C) 2004  Maciej W. Rozycki</span>
<span class="cm">*      Copyright (C) 2005 Ralf Baechle (ralf@linux-mips.org)</span>
<span class="cm">*</span>
<span class="cm">*      This program is free software; you can redistribute it and/or modify</span>
<span class="cm">*      it under the terms of the GNU General Public License as published by</span>
<span class="cm">*      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">*      (at your option) any later version.</span>
<span class="cm">*</span>
<span class="cm">*      This program is distributed in the hope that it will be useful,</span>
<span class="cm">*      but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">*      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">*      GNU General Public License for more details.</span>
<span class="cm">*</span>
<span class="cm">*      You should have received a copy of the GNU General Public License</span>
<span class="cm">*      along with this program; if not, write to the Free Software</span>
<span class="cm">*      Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*</span>
<span class="cm">* Module command line parameters:</span>
<span class="cm">*   none</span>
<span class="cm">*</span>
<span class="cm">*  Supported devices:</span>
<span class="cm">*  /dev/dsp    standard /dev/dsp device, (mostly) OSS compatible</span>
<span class="cm">*  /dev/mixer  standard /dev/mixer device, (mostly) OSS compatible</span>
<span class="cm">*  /dev/midi   simple MIDI UART interface, no ioctl</span>
<span class="cm">*</span>
<span class="cm">* Modification History</span>
<span class="cm">* 08/20/00 trw - silence and no stopping DAC until release</span>
<span class="cm">* 08/23/00 trw - added CS_DBG statements, fix interrupt hang issue on DAC stop.</span>
<span class="cm">* 09/18/00 trw - added 16bit only record with conversion </span>
<span class="cm">* 09/24/00 trw - added Enhanced Full duplex (separate simultaneous </span>
<span class="cm">*                capture/playback rates)</span>
<span class="cm">* 10/03/00 trw - fixed mmap (fixed GRECORD and the XMMS mmap test plugin  </span>
<span class="cm">*                libOSSm.so)</span>
<span class="cm">* 10/11/00 trw - modified for 2.4.0-test9 kernel enhancements (NR_MAP removal)</span>
<span class="cm">* 11/03/00 trw - fixed interrupt loss/stutter, added debug.</span>
<span class="cm">* 11/10/00 bkz - added __devinit to cs4297a_hw_init()</span>
<span class="cm">* 11/10/00 trw - fixed SMP and capture spinlock hang.</span>
<span class="cm">* 12/04/00 trw - cleaned up CSDEBUG flags and added &quot;defaultorder&quot; moduleparm.</span>
<span class="cm">* 12/05/00 trw - fixed polling (myth2), and added underrun swptr fix.</span>
<span class="cm">* 12/08/00 trw - added PM support. </span>
<span class="cm">* 12/14/00 trw - added wrapper code, builds under 2.4.0, 2.2.17-20, 2.2.17-8 </span>
<span class="cm">*		 (RH/Dell base), 2.2.18, 2.2.12.  cleaned up code mods by ident.</span>
<span class="cm">* 12/19/00 trw - added PM support for 2.2 base (apm_callback). other PM cleanup.</span>
<span class="cm">* 12/21/00 trw - added fractional &quot;defaultorder&quot; inputs. if &gt;100 then use </span>
<span class="cm">*		 defaultorder-100 as power of 2 for the buffer size. example:</span>
<span class="cm">*		 106 = 2^(106-100) = 2^6 = 64 bytes for the buffer size.</span>
<span class="cm">*</span>
<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sound.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/soundcard.h&gt;</span>
<span class="cp">#include &lt;linux/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;asm/sibyte/sb1250_regs.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_int.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_dma.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_scd.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_syncser.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250_mac.h&gt;</span>
<span class="cp">#include &lt;asm/sibyte/sb1250.h&gt;</span>

<span class="k">struct</span> <span class="n">cs4297a_state</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">stop_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">stop_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="cp">#undef OSS_DOCUMENTED_MIXER_SEMANTICS</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="cp">#define CS4297a_MAGIC           0xf00beef1</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>buffer order determines the size of the dma buffer for the driver.
under Linux, a smaller buffer allows more responsiveness from many of the 
applications (e.g. games).  A larger buffer allows some of the apps (esound) 
to not underrun the dma buffer as easily.  As default, use 32k (order=3)
rather than 64k as some of the games work more responsively.
log base 2( buff sz = 32k).</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Turn on/off debugging compilation by commenting out "#define CSDEBUG"</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define CSDEBUG 0</span>
<span class="cp">#if CSDEBUG</span>
<span class="cp">#define CSDEBUG_INTERFACE 1</span>
<span class="cp">#else</span>
<span class="cp">#undef CSDEBUG_INTERFACE</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>cs_debugmask areas</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define CS_INIT	 	0x00000001	</span><span class="c1">// initialization and probe functions</span>
<span class="cp">#define CS_ERROR 	0x00000002	</span><span class="c1">// tmp debugging bit placeholder</span>
<span class="cp">#define CS_INTERRUPT	0x00000004	</span><span class="c1">// interrupt handler (separate from all other)</span>
<span class="cp">#define CS_FUNCTION 	0x00000008	</span><span class="c1">// enter/leave functions</span>
<span class="cp">#define CS_WAVE_WRITE 	0x00000010	</span><span class="c1">// write information for wave</span>
<span class="cp">#define CS_WAVE_READ 	0x00000020	</span><span class="c1">// read information for wave</span>
<span class="cp">#define CS_AC97         0x00000040      </span><span class="c1">// AC97 register access</span>
<span class="cp">#define CS_DESCR        0x00000080      </span><span class="c1">// descriptor management</span>
<span class="cp">#define CS_OPEN		0x00000400	</span><span class="c1">// all open functions in the driver</span>
<span class="cp">#define CS_RELEASE	0x00000800	</span><span class="c1">// all release functions in the driver</span>
<span class="cp">#define CS_PARMS	0x00001000	</span><span class="c1">// functional and operational parameters</span>
<span class="cp">#define CS_IOCTL	0x00002000	</span><span class="c1">// ioctl (non-mixer)</span>
<span class="cp">#define CS_TMP		0x10000000	</span><span class="c1">// tmp debug mask bit</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>CSDEBUG is usual mode is set to 1, then use the
cs<em>debuglevel and cs</em>debugmask to turn on or off debugging.
Debug level of 1 has been defined to be kernel errors and info
that should be printed on any released driver.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#if CSDEBUG</span>
<span class="cp">#define CS_DBGOUT(mask,level,x) if((cs_debuglevel &gt;= (level)) &amp;&amp; ((mask) &amp; cs_debugmask) ) {x;}</span>
<span class="cp">#else</span>
<span class="cp">#define CS_DBGOUT(mask,level,x)</span>
<span class="cp">#endif</span>

<span class="cp">#if CSDEBUG</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cs_debuglevel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="c1">// levels range from 1-9</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cs_debugmask</span> <span class="o">=</span> <span class="n">CS_INIT</span> <span class="cm">/*| CS_IOCTL*/</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cs_debuglevel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cs_debugmask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#define CS_TRUE 	1</span>
<span class="cp">#define CS_FALSE 	0</span>

<span class="cp">#define CS_TYPE_ADC 0</span>
<span class="cp">#define CS_TYPE_DAC 1</span>

<span class="cp">#define SER_BASE    (A_SER_BASE_1 + KSEG1)</span>
<span class="cp">#define SS_CSR(t)   (SER_BASE+t)</span>
<span class="cp">#define SS_TXTBL(t) (SER_BASE+R_SER_TX_TABLE_BASE+(t*8))</span>
<span class="cp">#define SS_RXTBL(t) (SER_BASE+R_SER_RX_TABLE_BASE+(t*8))</span>

<span class="cp">#define FRAME_BYTES            32</span>
<span class="cp">#define FRAME_SAMPLE_BYTES      4</span>

<span class="cm">/* Should this be variable? */</span>
<span class="cp">#define SAMPLE_BUF_SIZE        (16*1024)</span>
<span class="cp">#define SAMPLE_FRAME_COUNT     (SAMPLE_BUF_SIZE / FRAME_SAMPLE_BYTES)</span>
<span class="cm">/* The driver can explode/shrink the frames to/from a smaller sample</span>
<span class="cm">   buffer */</span>
<span class="cp">#define DMA_BLOAT_FACTOR       1</span>
<span class="cp">#define DMA_DESCR              (SAMPLE_FRAME_COUNT / DMA_BLOAT_FACTOR)</span>
<span class="cp">#define DMA_BUF_SIZE           (DMA_DESCR * FRAME_BYTES)</span>

<span class="cm">/* Use the maxmium count (255 == 5.1 ms between interrupts) */</span>
<span class="cp">#define DMA_INT_CNT            ((1 &lt;&lt; S_DMA_INT_PKTCNT) - 1)</span>

<span class="cm">/* Figure this out: how many TX DMAs ahead to schedule a reg access */</span>
<span class="cp">#define REG_LATENCY            150</span>

<span class="cp">#define FRAME_TX_US             20</span>

<span class="cp">#define SERDMA_NEXTBUF(d,f) (((d)-&gt;f+1) % (d)-&gt;ringsz)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">invalid_magic</span><span class="p">[]</span> <span class="o">=</span>
    <span class="n">KERN_CRIT</span> <span class="s">&quot;cs4297a: invalid magic value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#define VALIDATE_STATE(s)                          \</span>
<span class="cp">({                                                 \</span>
<span class="cp">        if (!(s) || (s)-&gt;magic != CS4297a_MAGIC) { \</span>
<span class="cp">                printk(invalid_magic);             \</span>
<span class="cp">                return -ENXIO;                     \</span>
<span class="cp">        }                                          \</span>
<span class="cp">})</span>

<span class="k">struct</span> <span class="n">list_head</span> <span class="n">cs4297a_devs</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">cs4297a_devs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs4297a_devs</span> <span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">serdma_descr_s</span> <span class="p">{</span>
        <span class="n">u64</span> <span class="n">descr_a</span><span class="p">;</span>
        <span class="n">u64</span> <span class="n">descr_b</span><span class="p">;</span>
<span class="p">}</span> <span class="n">serdma_descr_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">paddr_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">serdma_s</span> <span class="p">{</span>
        <span class="kt">unsigned</span>         <span class="n">ringsz</span><span class="p">;</span>
        <span class="n">serdma_descr_t</span>  <span class="o">*</span><span class="n">descrtab</span><span class="p">;</span>
        <span class="n">serdma_descr_t</span>  <span class="o">*</span><span class="n">descrtab_end</span><span class="p">;</span>
        <span class="n">paddr_t</span>          <span class="n">descrtab_phys</span><span class="p">;</span>
        
        <span class="n">serdma_descr_t</span>  <span class="o">*</span><span class="n">descr_add</span><span class="p">;</span>
        <span class="n">serdma_descr_t</span>  <span class="o">*</span><span class="n">descr_rem</span><span class="p">;</span>
        
        <span class="n">u64</span>  <span class="o">*</span><span class="n">dma_buf</span><span class="p">;</span>           <span class="c1">// buffer for DMA contents (frames)</span>
        <span class="n">paddr_t</span>          <span class="n">dma_buf_phys</span><span class="p">;</span>
        <span class="n">u16</span>  <span class="o">*</span><span class="n">sample_buf</span><span class="p">;</span>		<span class="c1">// tmp buffer for sample conversions</span>
        <span class="n">u16</span>  <span class="o">*</span><span class="n">sb_swptr</span><span class="p">;</span>
        <span class="n">u16</span>  <span class="o">*</span><span class="n">sb_hwptr</span><span class="p">;</span>
        <span class="n">u16</span>  <span class="o">*</span><span class="n">sb_end</span><span class="p">;</span>

        <span class="n">dma_addr_t</span> <span class="n">dmaaddr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><pre><code>   unsigned buforder;    // Log base 2 of 'dma_buf' size in bytes..
</code></pre></td><td class="code"><div class="highlight"><pre>        <span class="kt">unsigned</span> <span class="n">numfrag</span><span class="p">;</span>	<span class="c1">// # of &#39;fragments&#39; in the buffer.</span>
        <span class="kt">unsigned</span> <span class="n">fragshift</span><span class="p">;</span>	<span class="c1">// Log base 2 of fragment size.</span>
        <span class="kt">unsigned</span> <span class="n">hwptr</span><span class="p">,</span> <span class="n">swptr</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="n">total_bytes</span><span class="p">;</span>	<span class="c1">// # bytes process since open.</span>
        <span class="kt">unsigned</span> <span class="n">blocks</span><span class="p">;</span>	<span class="c1">// last returned blocks value GETOPTR</span>
        <span class="kt">unsigned</span> <span class="n">wakeup</span><span class="p">;</span>	<span class="c1">// interrupt occurred on block </span>
        <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="n">underrun</span><span class="p">;</span>	<span class="c1">// underrun flag</span>
        <span class="kt">unsigned</span> <span class="n">error</span><span class="p">;</span>	<span class="c1">// over/underrun </span>
        <span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
        <span class="n">wait_queue_head_t</span> <span class="n">reg_wait</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>redundant, but makes calculations easier </p></td><td class="code"><div class="highlight"><pre>        <span class="kt">unsigned</span> <span class="n">fragsize</span><span class="p">;</span>	<span class="c1">// 2**fragshift..</span>
        <span class="kt">unsigned</span> <span class="n">sbufsz</span><span class="p">;</span>	<span class="c1">// 2**buforder.</span>
        <span class="kt">unsigned</span> <span class="n">fragsamples</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>OSS stuff </p></td><td class="code"><div class="highlight"><pre>        <span class="kt">unsigned</span> <span class="n">mapped</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="c1">// Buffer mapped in cs4297a_mmap()?</span>
        <span class="kt">unsigned</span> <span class="n">ready</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="c1">// prog_dmabuf_dac()/adc() successful?</span>
        <span class="kt">unsigned</span> <span class="n">endcleared</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="n">type</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="c1">// adc or dac buffer (CS_TYPE_XXX)</span>
        <span class="kt">unsigned</span> <span class="n">ossfragshift</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">ossmaxfrags</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="n">subdivision</span><span class="p">;</span>
<span class="p">}</span> <span class="n">serdma_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>magic </p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>soundcore stuff </p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">dev_audio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_mixer</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>hardware resources </p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

        <span class="k">struct</span> <span class="p">{</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_ovrrn</span><span class="p">;</span> <span class="cm">/* FIFO */</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_overflow</span><span class="p">;</span> <span class="cm">/* staging buffer */</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_underrun</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_bad</span><span class="p">;</span>
                <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_good</span><span class="p">;</span>
        <span class="p">}</span> <span class="n">stats</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>mixer registers </p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">vol</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">recsrc</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">modcnt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">micpreamp</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">mix</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>wave stuff   </p></td><td class="code"><div class="highlight"><pre>	<span class="k">struct</span> <span class="n">properties</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">fmt_original</span><span class="p">;</span>	<span class="c1">// original requested format</span>
		<span class="kt">unsigned</span> <span class="n">channels</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">prop_dac</span><span class="p">,</span> <span class="n">prop_adc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">conversion</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="c1">// conversion from 16 to 8 bit in progress</span>
	<span class="kt">unsigned</span> <span class="n">ena</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">open_mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">open_sem_adc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">open_sem_dac</span><span class="p">;</span>
	<span class="n">fmode_t</span> <span class="n">open_mode</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">open_wait</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">open_wait_adc</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">open_wait_dac</span><span class="p">;</span>

	<span class="n">dma_addr_t</span> <span class="n">dmaaddr_sample_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">buforder_sample_buf</span><span class="p">;</span>	<span class="c1">// Log base 2 of &#39;dma_buf&#39; size in bytes..</span>

        <span class="n">serdma_t</span> <span class="n">dma_dac</span><span class="p">,</span> <span class="n">dma_adc</span><span class="p">;</span>

        <span class="k">volatile</span> <span class="n">u16</span> <span class="n">read_value</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="n">u16</span> <span class="n">read_reg</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="n">u64</span> <span class="n">reg_request</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#if 1</span>
<span class="cp">#define prog_codec(a,b)</span>
<span class="cp">#define dealloc_dmabuf(a,b);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prog_dmabuf_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prog_dmabuf_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_advance</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bptr</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bptr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">bsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">x</span> <span class="o">=</span> <span class="n">bsize</span> <span class="o">-</span> <span class="n">bptr</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">bptr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">bptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;cs4297a: clear_advance(): memset %d at 0x%.8x for %d size </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">bptr</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="n">bptr</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if CSDEBUG</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>DEBUG ROUTINES</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define SOUND_MIXER_CS_GETDBGLEVEL 	_SIOWR(&#39;M&#39;,120, int)</span>
<span class="cp">#define SOUND_MIXER_CS_SETDBGLEVEL 	_SIOWR(&#39;M&#39;,121, int)</span>
<span class="cp">#define SOUND_MIXER_CS_GETDBGMASK 	_SIOWR(&#39;M&#39;,122, int)</span>
<span class="cp">#define SOUND_MIXER_CS_SETDBGMASK 	_SIOWR(&#39;M&#39;,123, int)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_printioctl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vidx</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Index of mixtable1[] member is Device ID 
and must be &lt;= SOUND<em>MIXER</em>NRDEVICES.
Value of array member is index into s->mix.vol[]</p></td><td class="code"><div class="highlight"><pre>	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixtable1</span><span class="p">[</span><span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">SOUND_MIXER_PCM</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="c1">// voice </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="c1">// AUX</span>
		<span class="p">[</span><span class="n">SOUND_MIXER_CD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="c1">// CD </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_LINE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="c1">// Line </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="c1">// FM</span>
		<span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="c1">// Mic </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="c1">// Speaker </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="c1">// Recording level </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>	<span class="c1">// Master Volume </span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_CS_GETDBGMASK</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_CS_GETDBGMASK:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_CS_GETDBGLEVEL</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_CS_GETDBGLEVEL:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_CS_SETDBGMASK</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_CS_SETDBGMASK:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_CS_SETDBGLEVEL</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_CS_SETDBGLEVEL:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OSS_GETVERSION</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;OSS_GETVERSION:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SYNC</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SYNC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETDUPLEX</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SETDUPLEX:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETCAPS</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETCAPS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_RESET</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_RESET:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SPEED</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SPEED:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_STEREO</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_STEREO:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_CHANNELS</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_CHANNELS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETFMTS</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETFMTS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFMT</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SETFMT:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_POST</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_POST:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETTRIGGER</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETTRIGGER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETTRIGGER</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SETTRIGGER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOSPACE</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETOSPACE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETISPACE</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETISPACE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_NONBLOCK</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_NONBLOCK:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETODELAY</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETODELAY:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETIPTR</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETIPTR:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOPTR</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETOPTR:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETBLKSIZE</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_GETBLKSIZE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFRAGMENT</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SETFRAGMENT:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SUBDIVIDE</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SUBDIVIDE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_RATE</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_PCM_READ_RATE:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_CHANNELS</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_PCM_READ_CHANNELS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_BITS</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_PCM_READ_BITS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_WRITE_FILTER</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_PCM_WRITE_FILTER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETSYNCRO</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SNDCTL_DSP_SETSYNCRO:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_FILTER</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_PCM_READ_FILTER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE1</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_PRIVATE1:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE2</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_PRIVATE2:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE3</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_PRIVATE3:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE4</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_PRIVATE4:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_PRIVATE5</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_PRIVATE5:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_MIXER_INFO</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_INFO:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SOUND_OLD_MIXER_INFO</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_OLD_MIXER_INFO:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_VOLUME</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_VOLUME:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_SPEAKER</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_SPEAKER:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_RECLEV</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_RECLEV:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_MIC</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_MIC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_SYNTH</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_SYNTH:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_RECSRC:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_DEVMASK</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_DEVMASK:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_RECMASK</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_RECMASK:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_STEREODEVS</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_STEREODEVS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_CAPS</span>:
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;SOUND_MIXER_CAPS:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">SOUND_MIXER_NRDEVICES</span>
			    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">vidx</span> <span class="o">=</span> <span class="n">mixtable1</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span>
					<span class="p">(</span><span class="s">&quot;UNKNOWN IOCTL: 0x%.8x NR=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span>
					<span class="p">(</span><span class="s">&quot;SOUND_MIXER_IOCTL AC9x: 0x%.8x NR=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ser_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> 
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: Setting up serial parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_CMD_RX_RESET</span> <span class="o">|</span> <span class="n">M_SYNCSER_CMD_TX_RESET</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_CMD</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_MSB_FIRST</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_MODE</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_MINFRM_SZ</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_MAXFRM_SZ</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_TX_RD_THRSH</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_TX_WR_THRSH</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_RX_RD_THRSH</span><span class="p">));</span>

        <span class="cm">/* This looks good from experimentation */</span>
        <span class="n">__raw_writeq</span><span class="p">((</span><span class="n">M_SYNCSER_TXSYNC_INT</span> <span class="o">|</span> <span class="n">V_SYNCSER_TXSYNC_DLY</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_TXCLK_EXT</span> <span class="o">|</span>
               <span class="n">M_SYNCSER_RXSYNC_INT</span> <span class="o">|</span> <span class="n">V_SYNCSER_RXSYNC_DLY</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_RXCLK_EXT</span> <span class="o">|</span> <span class="n">M_SYNCSER_RXSYNC_EDGE</span><span class="p">),</span>
              <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_LINE_MODE</span><span class="p">));</span>

        <span class="cm">/* This looks good from experimentation */</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_STROBE</span><span class="p">,</span>
              <span class="n">SS_TXTBL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_BYTE</span><span class="p">,</span>
              <span class="n">SS_TXTBL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_BYTE</span><span class="p">,</span>
              <span class="n">SS_TXTBL</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span>
              <span class="n">M_SYNCSER_SEQ_STROBE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_LAST</span><span class="p">,</span> <span class="n">SS_TXTBL</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_STROBE</span><span class="p">,</span>
              <span class="n">SS_RXTBL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_BYTE</span><span class="p">,</span>
              <span class="n">SS_RXTBL</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_BYTE</span><span class="p">,</span>
              <span class="n">SS_RXTBL</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_SYNCSER_SEQ_COUNT</span><span class="p">(</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_ENABLE</span> <span class="o">|</span> <span class="n">M_SYNCSER_SEQ_STROBE</span> <span class="o">|</span>
              <span class="n">M_SYNCSER_SEQ_LAST</span><span class="p">,</span> <span class="n">SS_RXTBL</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Just in case... */</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_SEQ_LAST</span><span class="p">,</span> <span class="n">SS_TXTBL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_SEQ_LAST</span><span class="p">,</span> <span class="n">SS_RXTBL</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_serdma</span><span class="p">(</span><span class="n">serdma_t</span> <span class="o">*</span><span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: desc - %d sbufsize - %d dbufsize - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                         <span class="n">DMA_DESCR</span><span class="p">,</span> <span class="n">SAMPLE_BUF_SIZE</span><span class="p">,</span> <span class="n">DMA_BUF_SIZE</span><span class="p">));</span>

        <span class="cm">/* Descriptors */</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">ringsz</span> <span class="o">=</span> <span class="n">DMA_DESCR</span><span class="p">;</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">ringsz</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: kzalloc descrtab failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab_end</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span> <span class="o">+</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
	<span class="cm">/* XXX bloddy mess, use proper DMA API here ...  */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab_phys</span> <span class="o">=</span> <span class="n">CPHYSADDR</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">);</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">descr_add</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">descr_rem</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">;</span>

        <span class="cm">/* Frame buffer area */</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">DMA_BUF_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: kzalloc dma_buf failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_buf_phys</span> <span class="o">=</span> <span class="n">CPHYSADDR</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">);</span>

        <span class="cm">/* Samples buffer area */</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sbufsz</span> <span class="o">=</span> <span class="n">SAMPLE_BUF_SIZE</span><span class="p">;</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sample_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sample_buf</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: kmalloc sample_buf failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">);</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sb_swptr</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sb_hwptr</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sample_buf</span><span class="p">;</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sb_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sample_buf</span> <span class="o">+</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="p">);</span>
        <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sbufsz</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> 
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: descrtab - %08x dma_buf - %x sample_buf - %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                         <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">,</span> 
                         <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sample_buf</span><span class="p">));</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> 
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: Setting up DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">init_serdma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">)</span> <span class="o">||</span>
            <span class="n">init_serdma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_RX</span><span class="p">))</span><span class="o">||</span>
            <span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_TX</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">panic</span><span class="p">(</span><span class="s">&quot;DMA state corrupted?!&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Initialize now - the descr/buffer pairings will never</span>
<span class="cm">           change... */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">DMA_DESCR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">descrtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr_a</span> <span class="o">=</span> <span class="n">M_DMA_SERRX_SOP</span> <span class="o">|</span> <span class="n">V_DMA_DSCRA_A_SIZE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> 
                        <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">dma_buf_phys</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">FRAME_BYTES</span><span class="p">);</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">descrtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr_b</span> <span class="o">=</span> <span class="n">V_DMA_DSCRB_PKT_SIZE</span><span class="p">(</span><span class="n">FRAME_BYTES</span><span class="p">);</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">descrtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr_a</span> <span class="o">=</span> <span class="n">V_DMA_DSCRA_A_SIZE</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">dma_buf_phys</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">FRAME_BYTES</span><span class="p">);</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">descrtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">__raw_writeq</span><span class="p">((</span><span class="n">M_DMA_EOP_INT_EN</span> <span class="o">|</span> <span class="n">V_DMA_INT_PKTCNT</span><span class="p">(</span><span class="n">DMA_INT_CNT</span><span class="p">)</span> <span class="o">|</span>
               <span class="n">V_DMA_RINGSZ</span><span class="p">(</span><span class="n">DMA_DESCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">M_DMA_TDX_EN</span><span class="p">),</span>
              <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CONFIG0_RX</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_DMA_L2CA</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CONFIG1_RX</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">descrtab_phys</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_BASE_RX</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">V_DMA_RINGSZ</span><span class="p">(</span><span class="n">DMA_DESCR</span><span class="p">),</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CONFIG0_TX</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_DMA_L2CA</span> <span class="o">|</span> <span class="n">M_DMA_NO_DSCR_UPDT</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CONFIG1_TX</span><span class="p">));</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">descrtab_phys</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_BASE_TX</span><span class="p">));</span>

        <span class="cm">/* Prep the receive DMA descriptor ring */</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">DMA_DESCR</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_RX</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_DMA_RX_EN</span> <span class="o">|</span> <span class="n">M_SYNCSER_DMA_TX_EN</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_ENABLE</span><span class="p">));</span>

        <span class="n">__raw_writeq</span><span class="p">((</span><span class="n">M_SYNCSER_RX_SYNC_ERR</span> <span class="o">|</span> <span class="n">M_SYNCSER_RX_OVERRUN</span> <span class="o">|</span> <span class="n">M_SYNCSER_RX_EOP_COUNT</span><span class="p">),</span>
              <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_INT_MASK</span><span class="p">));</span>

        <span class="cm">/* Enable the rx/tx; let the codec warm up to the sync and</span>
<span class="cm">           start sending good frames before the receive FIFO is</span>
<span class="cm">           enabled */</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_CMD_TX_EN</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_CMD</span><span class="p">));</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">M_SYNCSER_CMD_RX_EN</span> <span class="o">|</span> <span class="n">M_SYNCSER_CMD_TX_EN</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_CMD</span><span class="p">));</span>

        <span class="cm">/* XXXKW is this magic? (the &quot;1&quot; part) */</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">;</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> 
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: status: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                         <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">)));</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">serdma_reg_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u64</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">serdma_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">;</span>
        <span class="n">u64</span> <span class="o">*</span><span class="n">data_p</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="n">swptr</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="n">serdma_descr_t</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">reg_request</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: attempt to issue multiple reg_access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/* Since a writer has the DSP open, we have to mux the</span>
<span class="cm">                   request in */</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">reg_request</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
                <span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">reg_wait</span><span class="p">);</span>
                <span class="cm">/* XXXKW how can I deal with the starvation case where</span>
<span class="cm">                   the opener isn&#39;t writing? */</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* Be safe when changing ring pointers */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: reg access found bookkeeping error (hw/sw = %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">);</span>
                        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">swptr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">;</span>
                <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

                <span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">[</span><span class="n">swptr</span><span class="p">];</span>
                <span class="n">data_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">[</span><span class="n">swptr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
		<span class="o">*</span><span class="n">data_p</span> <span class="o">=</span> <span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_TX</span><span class="p">));</span>
                <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_DESCR</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
                          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: add_tx  %p (%x -&gt; %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                 <span class="n">data_p</span><span class="p">,</span> <span class="n">swptr</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: serdma_reg_access()-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
        
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><hr />

<p>"cs4297a<em>read</em>ac97" -- Reads an AC97 register</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_read_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_AC97</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: read reg %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">serdma_reg_access</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xCLL</span> <span class="o">&lt;&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">47</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">reg_wait</span><span class="p">);</span>
        <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_value</span><span class="p">;</span>
        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_AC97</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: rdr reg %x -&gt; %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_reg</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_value</span><span class="p">));</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><hr />

<p>"cs4297a<em>write</em>ac97()"-- writes an AC97 register</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_write_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_AC97</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: write reg %2x -&gt; %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">serdma_reg_access</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="mh">0xELL</span> <span class="o">&lt;&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: stop_dac():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        /* XXXKW what do I really want here?  My theory for now is</span>
<span class="c">           that I just flip the &quot;ena&quot; bit, and the interrupt handler</span>
<span class="c">           will stop processing the xmit channel */</span>
<span class="c">        __raw_writeq((s-&gt;ena &amp; FMODE_READ) ? M_SYNCSER_DMA_RX_EN : 0,</span>
<span class="c">              SS_CSR(R_SER_DMA_ENABLE));</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: start_dac()+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
	    				<span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">|=</span> <span class="n">FMODE_WRITE</span><span class="p">;</span>
                <span class="cm">/* XXXKW what do I really want here?  My theory for</span>
<span class="cm">                   now is that I just flip the &quot;ena&quot; bit, and the</span>
<span class="cm">                   interrupt handler will start processing the xmit</span>
<span class="cm">                   channel */</span>

		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: start_dac(): start dma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: start_dac()-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: stop_adc()+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_READ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt_original</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="cm">/* Nothing to do really, I need to keep the DMA going</span>
<span class="cm">           XXXKW when do I get here, and is there more I should do? */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: stop_adc()-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: start_adc()+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">mapped</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;=</span>
	     <span class="p">(</span><span class="kt">signed</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sbufsz</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">AFMT_S8</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">AFMT_U8</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>now only use 16 bit capture, due to truncation issue
in the chip, noticeable distortion occurs.
allocate buffer and then convert from 16 bit to 
8 bit for the user buffer.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt_original</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">AFMT_S8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AFMT_S8</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">|=</span> <span class="n">AFMT_S16_LE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;</span> <span class="n">AFMT_U8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AFMT_U8</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">|=</span> <span class="n">AFMT_U16_LE</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>prog<em>dmabuf</em>adc performs a stop_adc() but that is
ok since we really haven't started the DMA yet.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">prog_codec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">CS_TYPE_ADC</span><span class="p">);</span>

                        <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">|=</span> <span class="n">FMODE_READ</span><span class="p">;</span>
                <span class="cm">/* Nothing to do really, I am probably already</span>
<span class="cm">                   DMAing...  XXXKW when do I get here, and is there</span>
<span class="cm">                   more I should do? */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: start_adc(): start adc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: start_adc()-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>call with spinlock held! </p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">cs4297a_update_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">good_diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff2</span><span class="p">;</span>
        <span class="n">u64</span> <span class="o">*</span><span class="n">data_p</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">u32</span> <span class="o">*</span><span class="n">s_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">hwptr</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
        <span class="n">serdma_t</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
        <span class="n">serdma_descr_t</span> <span class="o">*</span><span class="n">descr</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>update ADC pointer </p></td><td class="code"><div class="highlight"><pre>        <span class="n">status</span> <span class="o">=</span> <span class="n">intflag</span> <span class="o">?</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_STATUS</span><span class="p">))</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M_SYNCSER_RX_EOP_COUNT</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">;</span>
                <span class="n">hwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_RX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                                     <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> 
                                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: upd_rcv sw-&gt;hw-&gt;hw %x/%x/%x (int-%d)n&quot;</span><span class="p">,</span>
                                         <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">,</span> <span class="n">hwptr</span><span class="p">,</span> <span class="n">intflag</span><span class="p">));</span>
                        <span class="cm">/* Number of DMA buffers available for software: */</span>
                        <span class="n">diff2</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span> <span class="o">+</span> <span class="n">hwptr</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">)</span> <span class="o">%</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>
                        <span class="n">good_diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">s_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="o">*</span><span class="mi">4</span><span class="p">]);</span>
                        <span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">];</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">diff2</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u64</span> <span class="n">data</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">s_ptr</span><span class="p">);</span>
                                <span class="n">u64</span> <span class="n">descr_a</span><span class="p">;</span>
                                <span class="n">u16</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
                                <span class="n">descr_a</span> <span class="o">=</span> <span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_a</span><span class="p">;</span>
                                <span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M_DMA_SERRX_SOP</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">descr_a</span> <span class="o">&amp;</span> <span class="n">M_DMA_DSCRA_A_ADDR</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CPHYSADDR</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">s_ptr</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: RX Bad address (read)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x9800000000000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x9800000000000000</span><span class="p">)</span> <span class="o">||</span>
                                    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">descr_a</span> <span class="o">&amp;</span> <span class="n">M_DMA_SERRX_SOP</span><span class="p">))</span> <span class="o">||</span>
                                    <span class="p">(</span><span class="n">G_DMA_DSCRB_PKT_SIZE</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FRAME_BYTES</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bad</span><span class="o">++</span><span class="p">;</span>
                                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cs4297a: RX Bad attributes (read)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                        <span class="k">continue</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_good</span><span class="o">++</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">61</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
                                        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">reg_wait</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_hwptr</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_swptr</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_overflow</span><span class="o">++</span><span class="p">;</span>
                                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cs4297a: RX overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                        <span class="k">continue</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">good_diff</span><span class="o">++</span><span class="p">;</span>
				<span class="n">left</span> <span class="o">=</span> <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">s_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				       <span class="p">((</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">s_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
				<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">s_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_hwptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
				<span class="o">*</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_hwptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_hwptr</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_end</span><span class="p">)</span>
                                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">sb_hwptr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sample_buf</span><span class="p">;</span>
                                <span class="n">descr</span><span class="o">++</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab_end</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">descr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">;</span>
                                        <span class="n">s_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">dma_buf</span><span class="p">;</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="n">s_ptr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">good_diff</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">good_diff</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: bogus receive overflow!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">+</span> <span class="n">diff</span><span class="p">)</span> <span class="o">%</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
                        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_RX</span><span class="p">));</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span>
                                        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
                                                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                                         <span class="s">&quot;cs4297a: update count -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
                                        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="cm">/* Receive is going even if no one is</span>
<span class="cm">                           listening (for register accesses and to</span>
<span class="cm">                           avoid FIFO overrun) */</span>
                        <span class="n">diff2</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">hwptr</span> <span class="o">+</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">)</span> <span class="o">%</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">diff</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: RX full or empty?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="p">}</span>
                        
                        <span class="n">descr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">];</span>
                        <span class="n">data_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">[</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="o">*</span><span class="mi">4</span><span class="p">];</span>

                        <span class="cm">/* Force this to happen at least once; I got</span>
<span class="cm">                           here because of an interrupt, so there must</span>
<span class="cm">                           be a buffer to process. */</span>
                        <span class="k">do</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">data_p</span><span class="p">);</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_a</span> <span class="o">&amp;</span> <span class="n">M_DMA_DSCRA_A_ADDR</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CPHYSADDR</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">data_p</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: RX Bad address %d (%llx %lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">,</span>
                                               <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_a</span> <span class="o">&amp;</span> <span class="n">M_DMA_DSCRA_A_ADDR</span><span class="p">),</span>
                                               <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">CPHYSADDR</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">data_p</span><span class="p">));</span>
                                <span class="p">}</span>
                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">))</span> <span class="o">||</span>
                                    <span class="o">!</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_a</span> <span class="o">&amp;</span> <span class="n">M_DMA_SERRX_SOP</span><span class="p">)</span> <span class="o">||</span>
                                    <span class="p">(</span><span class="n">G_DMA_DSCRB_PKT_SIZE</span><span class="p">(</span><span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_b</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FRAME_BYTES</span><span class="p">))</span> <span class="p">{</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bad</span><span class="o">++</span><span class="p">;</span>
                                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;cs4297a: RX Bad attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_good</span><span class="o">++</span><span class="p">;</span>
                                        <span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">61</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
                                                <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
                                                <span class="n">s</span><span class="o">-&gt;</span><span class="n">read_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">40</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
                                                <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">reg_wait</span><span class="p">);</span>
                                        <span class="p">}</span>
                                <span class="p">}</span>
                                <span class="n">descr</span><span class="o">-&gt;</span><span class="n">descr_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M_DMA_SERRX_SOP</span><span class="p">;</span>
                                <span class="n">descr</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="o">++</span><span class="p">;</span>
                                <span class="n">data_p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">==</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab_end</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="n">descr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab</span><span class="p">;</span>
                                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                        <span class="n">data_p</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">;</span>
                                <span class="p">}</span>
                                <span class="n">__raw_writeq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_RX</span><span class="p">));</span>
                        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">diff</span><span class="p">);</span>
                        <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>

                        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_DESCR</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> 
                                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: hw/sw %x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">));</span>
                <span class="p">}</span>

		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: cs4297a_update_ptr(): s=0x%.8x hwptr=%d total_bytes=%d count=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">,</span> 
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
	<span class="p">}</span>

        <span class="cm">/* XXXKW worry about s-&gt;reg_request -- there is a starvation</span>
<span class="cm">           case if s-&gt;ena has FMODE_WRITE on, but the client isn&#39;t</span>
<span class="cm">           doing writes */</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>update DAC pointer </p>

<p>check for end of buffer, means that we are going to wait for another interrupt
to allow silence to fill the fifos on the part, to keep pops down to a minimum.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">serdma_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">;</span>
                <span class="n">hwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_TX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                                     <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span> <span class="o">+</span> <span class="n">hwptr</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">)</span> <span class="o">%</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
                <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                                   <span class="s">&quot;cs4297a: cs4297a_update_ptr(): hw/hw/sw %x/%x/%x diff %d count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                   <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">,</span> <span class="n">hwptr</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
                <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>
                <span class="cm">/* XXXKW stereo? conversion? Just assume 2 16-bit samples for now */</span>
                <span class="n">d</span><span class="o">-&gt;</span><span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="p">)</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&amp;=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-=</span> <span class="n">diff</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>fill with silence, and do not shut down the DAC.
Continue to play silence until the _release.</p></td><td class="code"><div class="highlight"><pre>				<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					<span class="s">&quot;cs4297a: cs4297a_update_ptr(): memset %d at 0x%.8x for %d size </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span> <span class="o">&amp;</span> 
						<span class="p">(</span><span class="n">AFMT_U8</span> <span class="o">|</span> <span class="n">AFMT_U16_LE</span><span class="p">))</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> 
						<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">,</span> 
						<span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">));</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span> <span class="o">*</span> <span class="n">FRAME_BYTES</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_underrun</span><span class="o">++</span><span class="p">;</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					 <span class="s">&quot;cs4297a: cs4297a_update_ptr(): underrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;=</span>
				   <span class="p">(</span><span class="kt">signed</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">fragsize</span>
				   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">endcleared</span><span class="p">)</span> <span class="p">{</span>
                          <span class="cm">/* XXXKW what is this for? */</span>
				<span class="n">clear_advance</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span><span class="p">,</span>
					      <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="p">,</span>
					      <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">,</span>
					      <span class="n">d</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">,</span>
					      <span class="mi">0</span><span class="p">);</span>
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">endcleared</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="n">intflag</span><span class="p">)</span>
			<span class="p">{</span>
                                <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
                                          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                                 <span class="s">&quot;cs4297a: update count -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: cs4297a_update_ptr(): s=0x%.8x hwptr=%d total_bytes=%d count=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">,</span> 
				<span class="n">d</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">,</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Index to mixer_src[] is value of AC97 Input Mux Select Reg.
Value of array member is recording source Device ID Mask.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mixer_src</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SOUND_MASK_MIC</span><span class="p">,</span> <span class="n">SOUND_MASK_CD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SOUND_MASK_LINE1</span><span class="p">,</span>
		<span class="n">SOUND_MASK_LINE</span><span class="p">,</span> <span class="n">SOUND_MASK_VOLUME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="p">};</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Index of mixtable1[] member is Device ID 
and must be &lt;= SOUND<em>MIXER</em>NRDEVICES.
Value of array member is index into s->mix.vol[]</p></td><td class="code"><div class="highlight"><pre>	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixtable1</span><span class="p">[</span><span class="n">SOUND_MIXER_NRDEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">SOUND_MIXER_PCM</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>	<span class="c1">// voice </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_LINE1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>	<span class="c1">// AUX</span>
		<span class="p">[</span><span class="n">SOUND_MIXER_CD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>	<span class="c1">// CD </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_LINE</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="c1">// Line </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_SYNTH</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>	<span class="c1">// FM</span>
		<span class="p">[</span><span class="n">SOUND_MIXER_MIC</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>	<span class="c1">// Mic </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_SPEAKER</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>	<span class="c1">// Speaker </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_RECLEV</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="c1">// Recording level </span>
		<span class="p">[</span><span class="n">SOUND_MIXER_VOLUME</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>	<span class="c1">// Master Volume </span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">mixreg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AC97_PCMOUT_VOL</span><span class="p">,</span>
		<span class="n">AC97_AUX_VOL</span><span class="p">,</span>
		<span class="n">AC97_CD_VOL</span><span class="p">,</span>
		<span class="n">AC97_LINEIN_VOL</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">vidx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">attentbl</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span>
	    <span class="p">{</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="n">temp1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		 <span class="s">&quot;cs4297a: mixer_ioctl(): s=0x%.8x cmd=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>
<span class="cp">#if CSDEBUG</span>
	<span class="n">cs_printioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#if CSDEBUG_INTERFACE</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_CS_GETDBGMASK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_CS_SETDBGMASK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_CS_GETDBGLEVEL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_CS_SETDBGLEVEL</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_CS_GETDBGMASK</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">cs_debugmask</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_CS_GETDBGLEVEL</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">cs_debuglevel</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_CS_SETDBGMASK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">cs_debugmask</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_CS_SETDBGLEVEL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">cs_debuglevel</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				<span class="s">&quot;cs4297a: mixer_ioctl(): ERROR unknown debug cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_PRIVATE1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_PRIVATE2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>enable/disable/query spatializer </p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>
			<span class="n">cs4297a_read_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">temp1</span><span class="p">);</span>
			<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_GENERAL_PURPOSE</span><span class="p">,</span>
					  <span class="n">temp1</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cs4297a_read_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_3D_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp1</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">((</span><span class="n">temp1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_MIXER_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mixer_info</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;CS4297a&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Crystal CS4297a&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
		<span class="n">info</span><span class="p">.</span><span class="n">modify_counter</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">modcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SOUND_OLD_MIXER_INFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_old_mixer_info</span> <span class="n">info</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;CS4297a&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Crystal CS4297a&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">OSS_GETVERSION</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SOUND_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;M&#39;</span> <span class="o">||</span> <span class="n">_SIOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>If ioctl has only the SIOC_READ bit(bit 31)
on, process the only-read commands. </p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">_SIOC_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:	<span class="c1">// Arg contains a bit for each recording source </span>
			<span class="n">cs4297a_read_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_RECORD_SELECT</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">temp1</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">mixer_src</span><span class="p">[</span><span class="n">temp1</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_DEVMASK</span>:	<span class="c1">// Arg contains a bit for each supported device </span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SOUND_MASK_PCM</span> <span class="o">|</span> <span class="n">SOUND_MASK_LINE</span> <span class="o">|</span>
					<span class="n">SOUND_MASK_VOLUME</span> <span class="o">|</span> <span class="n">SOUND_MASK_RECLEV</span><span class="p">,</span>
                                        <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_RECMASK</span>:	<span class="c1">// Arg contains a bit for each supported recording source </span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SOUND_MASK_LINE</span> <span class="o">|</span> <span class="n">SOUND_MASK_VOLUME</span><span class="p">,</span>
                                        <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_STEREODEVS</span>:	<span class="c1">// Mixer channels supporting stereo </span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SOUND_MASK_PCM</span> <span class="o">|</span> <span class="n">SOUND_MASK_LINE</span> <span class="o">|</span>
					<span class="n">SOUND_MASK_VOLUME</span> <span class="o">|</span> <span class="n">SOUND_MASK_RECLEV</span><span class="p">,</span>
                                        <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SOUND_MIXER_CAPS</span>:
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SOUND_CAP_EXCL_INPUT</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

		<span class="nl">default:</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">SOUND_MIXER_NRDEVICES</span>
			    <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">vidx</span> <span class="o">=</span> <span class="n">mixtable1</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="n">vidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>If ioctl doesn't have both the SIOC<em>READ and 
the SIOC</em>WRITE bit set, return invalid.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">_SIOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">_SIOC_READ</span> <span class="o">|</span> <span class="n">_SIOC_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Increment the count of volume writes.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">modcnt</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Isolate the command; it must be a write.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_RECSRC</span>:	<span class="c1">// Arg contains a bit for each recording source </span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>	<span class="c1">// i = # bits on in val.</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>	<span class="c1">// One &amp; only 1 bit must be on.</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer_src</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">mixer_src</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">temp1</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
						  <span class="n">AC97_RECORD_SELECT</span><span class="p">,</span>
						  <span class="n">temp1</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="c1">// Max soundcard.h vol is 100.</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="n">attentbl</span><span class="p">[(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">];</span>	<span class="c1">// Convert 0-100 vol to 63-0 atten.</span>

		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="c1">// Max right volume is 100, too</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rr</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rr</span> <span class="o">=</span> <span class="n">attentbl</span><span class="p">[(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">];</span>	<span class="c1">// Convert volume to attenuation.</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rl</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">))</span>	<span class="c1">// If both l &amp; r are &#39;low&#39;,          </span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>	<span class="c1">//  turn on the mute bit.</span>
		<span class="k">else</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">temp1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rr</span><span class="p">;</span>

		<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_MASTER_VOL_STEREO</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>
		<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_PHONE_VOL</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>

<span class="cp">#ifdef OSS_DOCUMENTED_MIXER_SEMANTICS</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_SPEAKER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">13</span><span class="p">;</span>	<span class="c1">// Convert 0-100 range to 0-15.</span>
			<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">rl</span> <span class="o">*</span> <span class="mi">13</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rl</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">-</span> <span class="n">rl</span><span class="p">;</span>	<span class="c1">// Convert volume to attenuation.</span>
		<span class="n">temp1</span> <span class="o">|=</span> <span class="n">rl</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_PCBEEP_VOL</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>

<span class="cp">#ifdef OSS_DOCUMENTED_MIXER_SEMANTICS</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_RECLEV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">rl</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">13</span><span class="p">;</span>	<span class="c1">// Convert 0-100 scale to 0-15.</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">rr</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">temp1</span> <span class="o">=</span> <span class="n">temp1</span> <span class="o">|</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rr</span><span class="p">;</span>
		<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_RECORD_GAIN</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>

<span class="cp">#ifdef OSS_DOCUMENTED_MIXER_SEMANTICS</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SOUND_MIXER_MIC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">l</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>	<span class="c1">// Convert 0-100 range to 0-31.</span>
			<span class="n">l</span> <span class="o">=</span> <span class="p">(</span><span class="n">rl</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs4297a_read_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_MIC_VOL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp1</span><span class="p">);</span>
		<span class="n">temp1</span> <span class="o">&amp;=</span> <span class="mh">0x40</span><span class="p">;</span>	<span class="c1">// Isolate 20db gain bit.</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">temp1</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rl</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">rl</span><span class="p">;</span>	<span class="c1">// Convert volume to attenuation.</span>
		<span class="n">temp1</span> <span class="o">|=</span> <span class="n">rl</span><span class="p">;</span>
		<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_MIC_VOL</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>

<span class="cp">#ifdef OSS_DOCUMENTED_MIXER_SEMANTICS</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>


	<span class="k">case</span> <span class="n">SOUND_MIXER_SYNTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">rl</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>	<span class="c1">// Convert 0-100 range to 0-63.</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>	<span class="c1">// If l is low, turn on</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">;</span>	<span class="c1">//  the mute bit.</span>
		<span class="k">else</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rl</span> <span class="o">=</span> <span class="mi">63</span> <span class="o">-</span> <span class="n">rl</span><span class="p">;</span>	<span class="c1">// Convert vol to attenuation.</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><pre><code>writel(temp1 | rl, s-&gt;pBA0 + FMLVC);
</code></pre></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>	<span class="c1">//  If rr is low, turn on</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">;</span>	<span class="c1">//   the mute bit.</span>
		<span class="k">else</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rr</span> <span class="o">=</span> <span class="mi">63</span> <span class="o">-</span> <span class="n">rr</span><span class="p">;</span>	<span class="c1">// Convert vol to attenuation.</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><pre><code>writel(temp1 | rr, s-&gt;pBA0 + FMRVC);
</code></pre></td><td class="code"><div class="highlight"><pre><span class="cp">#ifdef OSS_DOCUMENTED_MIXER_SEMANTICS</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>


	<span class="nl">default:</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: mixer_ioctl(): default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">SOUND_MIXER_NRDEVICES</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">vidx</span> <span class="o">=</span> <span class="n">mixtable1</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="p">(</span><span class="n">attentbl</span><span class="p">[(</span><span class="n">l</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rr</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rr</span> <span class="o">=</span> <span class="p">(</span><span class="n">attentbl</span><span class="p">[(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rl</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rr</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">))</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">temp1</span> <span class="o">=</span> <span class="n">temp1</span> <span class="o">|</span> <span class="p">(</span><span class="n">rl</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rr</span><span class="p">;</span>
		<span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mixreg</span><span class="p">[</span><span class="n">vidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">temp1</span><span class="p">);</span>

<span class="cp">#ifdef OSS_DOCUMENTED_MIXER_SEMANTICS</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="n">vidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="n">vidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mix</span><span class="p">.</span><span class="n">vol</span><span class="p">[</span><span class="n">vidx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_open_mixdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_open_mixdev()+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs4297a_devs</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cs4297a_state</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev_mixer</span> <span class="o">==</span> <span class="n">minor</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_open_mixdev()- -ENODEV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_open_mixdev()- 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_release_mixdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_ioctl_mixdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mixer_ioctl</span><span class="p">((</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			   <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><hr />

<p>Mixer file operations struct.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cs4297a_mixer_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">cs4297a_ioctl_mixdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">cs4297a_open_mixdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">cs4297a_release_mixdev</span><span class="p">,</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">drain_adc</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* This routine serves no purpose currently - any samples</span>
<span class="cm">           sitting in the receive queue will just be processed by the</span>
<span class="cm">           background consumer.  This would be different if DMA</span>
<span class="cm">           actually stopped when there were no clients. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">drain_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nonblock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">tmo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nonblock</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_TX</span><span class="p">)))</span> <span class="o">||</span>
               <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
                        <span class="cm">/* XXXKW is this calculation working? */</span>
                        <span class="n">tmo</span> <span class="o">=</span> <span class="p">((</span><span class="n">count</span> <span class="o">*</span> <span class="n">FRAME_TX_US</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
                        <span class="n">schedule_timeout</span><span class="p">(</span><span class="n">tmo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="cm">/* XXXKW do I care if there is a signal pending? */</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="cm">/* Reset the bookkeeping */</span>
        <span class="n">hwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_TX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                       <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>
        <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_RUNNING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cs4297a_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			   <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">count_fr</span><span class="p">,</span> <span class="n">cnt_by</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">copied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_read()+ %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>

	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>"count" is the amount of bytes to read (from app), is decremented each loop
     by the amount of bytes that have been returned to the user buffer.
"cnt" is the running total of each read from the buffer (changes each loop)
"buffer" points to the app's buffer
"ret" keeps a running total of the amount of bytes that have been copied
     to the user buffer.
"copied" is the total bytes copied into the user buffer for each loop.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;_read() count&gt;0 count=%d .count=%d .swptr=%d .hwptr=%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">count</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">swptr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">hwptr</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

                <span class="cm">/* cnt will be the number of available samples (16-bit</span>
<span class="cm">                   stereo); it starts out as the maxmimum consequetive</span>
<span class="cm">                   samples */</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_end</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_swptr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
                <span class="n">count_fr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">/</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>dma_adc.count is the current total bytes that have not been read.
if the amount of unread bytes from the current sw pointer to the
end of the buffer is greater than the current total bytes that
have not been read, then set the "cnt" (unread bytes) to the
amount of unread bytes.  </p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">count_fr</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">count_fr</span><span class="p">;</span>
                <span class="n">cnt_by</span> <span class="o">=</span> <span class="n">cnt</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>if we are converting from 8/16 then we need to copy
twice the number of 16 bit bytes then 8 bit bytes.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt_by</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
                                <span class="n">cnt_by</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
                        <span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt_by</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span> <span class="o">/</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">;</span>
                                <span class="n">cnt_by</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
                        <span class="p">}</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>"cnt" NOW is the smaller of the amount that will be read,
and the amount that is requested in this read (or partial).
if there are no bytes in the buffer to read, then start the
ADC and wait for the interrupt handler to wake us up.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>start up the dma engine and then continue back to the top of
the loop when wake up occurs.</p></td><td class="code"><div class="highlight"><pre>			<span class="n">start_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>there are bytes in the buffer to read.
copy from the hw buffer over to the user buffer.
user buffer is designated by "buffer"
virtual address to copy from is dma_buf+swptr
the "cnt" is the number of bytes to read.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;_read() copy_to cnt=%d count=%d &quot;</span><span class="p">,</span> <span class="n">cnt_by</span><span class="p">,</span> <span class="n">count</span><span class="p">));</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot; .sbufsz=%d .count=%d buffer=0x%.8x ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sbufsz</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_swptr</span><span class="p">),</span> <span class="n">cnt_by</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
                <span class="n">copied</span> <span class="o">=</span> <span class="n">cnt_by</span><span class="p">;</span>

                <span class="cm">/* Return the descriptors */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> 
                          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: upd_rcv sw-&gt;hw %x/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">swptr</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">hwptr</span><span class="p">));</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">-=</span> <span class="n">cnt_by</span><span class="p">;</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_swptr</span> <span class="o">+=</span> <span class="n">cnt</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_swptr</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_end</span><span class="p">)</span>
                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_swptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sample_buf</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">copied</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">copied</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">copied</span><span class="p">;</span>
		<span class="n">start_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_read()- %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cs4297a_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">swptr</span><span class="p">,</span> <span class="n">hwptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_write()+ count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">count</span><span class="p">));</span>
	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">serdma_t</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">copy_cnt</span><span class="p">;</span>
                <span class="n">u32</span> <span class="o">*</span><span class="n">s_tmpl</span><span class="p">;</span>
                <span class="n">u32</span> <span class="o">*</span><span class="n">t_tmpl</span><span class="p">;</span>
                <span class="n">u32</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">swap</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">AFMT_S16_LE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">AFMT_U16_LE</span><span class="p">);</span>
                
                <span class="cm">/* XXXXXX this is broken for BLOAT_FACTOR */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">underrun</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">hwptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_TX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                                             <span class="n">d</span><span class="o">-&gt;</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>
			<span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">hwptr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">swptr</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span> <span class="o">-</span> <span class="p">(</span><span class="n">swptr</span> <span class="o">*</span> <span class="n">FRAME_SAMPLE_BYTES</span><span class="p">);</span>
                <span class="cm">/* Will this write fill up the buffer? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">sbufsz</span> <span class="o">-</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sample_buf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">cnt</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

                <span class="n">copy_cnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
                <span class="n">s_tmpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">sample_buf</span><span class="p">;</span>
                <span class="n">t_tmpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">swptr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

                <span class="cm">/* XXXKW assuming 16-bit stereo! */</span>
                <span class="k">do</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">t_tmpl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0x98000000</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">s_tmpl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">swap</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">left</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">left</span><span class="p">);</span>
				<span class="n">right</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">t_tmpl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">left</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">t_tmpl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(((</span><span class="n">left</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">right</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

                        <span class="n">s_tmpl</span><span class="o">++</span><span class="p">;</span>
                        <span class="n">t_tmpl</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
                        <span class="n">copy_cnt</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">copy_cnt</span><span class="p">);</span>

                <span class="cm">/* Mux in any pending read/write accesses */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">reg_request</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">dma_buf</span> <span class="o">+</span> <span class="p">(</span><span class="n">swptr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">|=</span>
				<span class="n">cpu_to_be64</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">reg_request</span><span class="p">);</span>
                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">reg_request</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">reg_wait</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
                          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                                 <span class="s">&quot;cs4297a: copy in %d to swptr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">swptr</span><span class="p">));</span>

		<span class="n">swptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">swptr</span> <span class="o">+</span> <span class="p">(</span><span class="n">cnt</span><span class="o">/</span><span class="n">FRAME_SAMPLE_BYTES</span><span class="p">))</span> <span class="o">%</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">ringsz</span><span class="p">;</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">cnt</span><span class="o">/</span><span class="n">FRAME_SAMPLE_BYTES</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_TX</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">swptr</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">endcleared</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">cnt</span><span class="p">;</span>
		<span class="n">start_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_WRITE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_write()- %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">cs4297a_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_WRITE</span> <span class="o">|</span> <span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_poll()+</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_WRITE</span> <span class="o">|</span> <span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				 <span class="s">&quot;cs4297a: cs4297a_poll() wait on FMODE_WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_WRITE</span> <span class="o">|</span> <span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
				 <span class="s">&quot;cs4297a: cs4297a_poll() wait on FMODE_READ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_FALSE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;=</span>
			    <span class="p">(</span><span class="kt">signed</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragsize</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wakeup</span><span class="p">)</span>
					<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="kt">signed</span><span class="p">)</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">sbufsz</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLOUT</span> <span class="o">|</span> <span class="n">POLLWRNORM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">signed</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span><span class="p">)</span> 
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_WAVE_WRITE</span> <span class="o">|</span> <span class="n">CS_WAVE_READ</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_poll()- 0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">mask</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* XXXKW currently no mmap support */</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">audio_buf_info</span> <span class="n">abinfo</span><span class="p">;</span>
	<span class="n">count_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">mapped</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span><span class="o">|</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		 <span class="s">&quot;cs4297a: cs4297a_ioctl(): file=0x%.8x cmd=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>
<span class="cp">#if CSDEBUG</span>
	<span class="n">cs_printioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">mapped</span> <span class="o">=</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">mapped</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OSS_GETVERSION</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: cs4297a_ioctl(): SOUND_VERSION=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">SOUND_VERSION</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">SOUND_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SYNC</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_SYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">drain_dac</span><span class="p">(</span><span class="n">s</span><span class="p">,</span>
					 <span class="mi">0</span> <span class="cm">/*file-&gt;f_flags &amp; O_NONBLOCK */</span>
					 <span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETDUPLEX</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETCAPS</span>:
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">DSP_CAP_DUPLEX</span> <span class="o">|</span> <span class="n">DSP_CAP_REALTIME</span> <span class="o">|</span>
				<span class="n">DSP_CAP_TRIGGER</span> <span class="o">|</span> <span class="n">DSP_CAP_MMAP</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_RESET</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span>
                                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">hwptr</span> <span class="o">=</span>
                                <span class="p">(</span><span class="kt">int</span><span class="p">)(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_TX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                                       <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">total_bytes</span> <span class="o">=</span>
                                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">hwptr</span> <span class="o">=</span>
                                <span class="p">(</span><span class="kt">int</span><span class="p">)(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_RX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                                       <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SPEED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_SPEED val=%d -&gt; 48000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">));</span>
                <span class="n">val</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_STEREO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_STEREO val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stop_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_CHANNELS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_CHANNELS val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">val</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">channels</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETFMTS</span>:	<span class="c1">// Returns a mask </span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_GETFMT val=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_U16_LE</span> <span class="o">|</span> <span class="n">AFMT_S8</span> <span class="o">|</span>
				 <span class="n">AFMT_U8</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">AFMT_S16_LE</span> <span class="o">|</span> <span class="n">AFMT_U16_LE</span> <span class="o">|</span> <span class="n">AFMT_S8</span> <span class="o">|</span>
				<span class="n">AFMT_U8</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFMT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_SETFMT val=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">val</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_QUERY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_S16_LE</span>
				    <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_U16_LE</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_S8</span>
				    <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_U8</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt_original</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">stop_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_S16_LE</span>
				    <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_U16_LE</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_S8</span>
				    <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">AFMT_U8</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt_original</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt_original</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt_original</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		  <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_SETFMT return val=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			<span class="n">val</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_POST</span>:
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_IOCTL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_ioctl(): DSP_POST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETTRIGGER</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETTRIGGER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
				<span class="n">start_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">stop_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">=</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
				<span class="n">start_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">stop_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOSPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_FALSE</span><span class="p">);</span>
		<span class="n">abinfo</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">sbufsz</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span>
			    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">sbufsz</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
		<span class="n">abinfo</span><span class="p">.</span><span class="n">fragstotal</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">numfrag</span><span class="p">;</span>
		<span class="n">abinfo</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragshift</span><span class="p">;</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_PARMS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: cs4297a_ioctl(): GETOSPACE .fragsize=%d .bytes=%d .fragstotal=%d .fragments=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">abinfo</span><span class="p">.</span><span class="n">fragsize</span><span class="p">,</span><span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span><span class="n">abinfo</span><span class="p">.</span><span class="n">fragstotal</span><span class="p">,</span>
				<span class="n">abinfo</span><span class="p">.</span><span class="n">fragments</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abinfo</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">abinfo</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETISPACE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_FALSE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">fragstotal</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">numfrag</span><span class="p">;</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span>
			    <span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragshift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span><span class="p">;</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">fragstotal</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">numfrag</span><span class="p">;</span>
			<span class="n">abinfo</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span>
			    <span class="n">abinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragshift</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">abinfo</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">abinfo</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_NONBLOCK</span>:
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_lock</span><span class="p">);</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETODELAY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_FALSE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETIPTR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_FALSE</span><span class="p">);</span>
		<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragshift</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
			    <span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragshift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
				    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">/</span>
				    <span class="mi">2</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragshift</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
				    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span>
				    <span class="n">fragshift</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span><span class="p">)</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">hwptr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">hwptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">&amp;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOPTR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ready</span> <span class="o">&amp;&amp;</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_FALSE</span><span class="p">);</span>
		<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">total_bytes</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragshift</span><span class="p">)</span> <span class="o">-</span>
			    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
			    <span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragshift</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span>
			    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragshift</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">hwptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">mapped</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">count</span> <span class="o">&amp;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cinfo</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_GETBLKSIZE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">fragsize</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">fragsize</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFRAGMENT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">// Say OK, but do nothing.</span>

	<span class="k">case</span> <span class="n">SNDCTL_DSP_SUBDIVIDE</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">subdivision</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span>
			<span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">subdivision</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SOUND_PCM_READ_RATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SOUND_PCM_READ_CHANNELS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SOUND_PCM_READ_BITS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span>
			<span class="k">return</span>
			    <span class="n">put_user</span><span class="p">(</span>
				     <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span>
				      <span class="n">fmt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AFMT_S8</span> <span class="o">|</span> <span class="n">AFMT_U8</span><span class="p">))</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span>
			<span class="k">return</span>
			    <span class="n">put_user</span><span class="p">(</span>
				     <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span>
				      <span class="n">fmt</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AFMT_S8</span> <span class="o">|</span> <span class="n">AFMT_U8</span><span class="p">))</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SOUND_PCM_WRITE_FILTER</span>:
	<span class="k">case</span> <span class="n">SNDCTL_DSP_SETSYNCRO</span>:
	<span class="k">case</span> <span class="n">SOUND_PCM_READ_FILTER</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">mixer_ioctl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">cs4297a_unlocked_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cs4297a_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_RELEASE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		 <span class="s">&quot;cs4297a: cs4297a_release(): inode=0x%.8x file=0x%.8x f_mode=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">inode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">file</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">));</span>
	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drain_dac</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
		<span class="n">stop_dac</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">dealloc_dmabuf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait_dac</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drain_adc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
		<span class="n">stop_adc</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">dealloc_dmabuf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">);</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_READ</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait_adc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_locked_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;cs4297a: cs4297a_open(): inode=0x%.8x file=0x%.8x f_mode=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">inode</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">file</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="p">));</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                <span class="s">&quot;cs4297a: status = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_STATUS_DEBUG</span><span class="p">))));</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs4297a_devs</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cs4297a_state</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev_audio</span> <span class="o">^</span> <span class="n">minor</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">cs4297a_devs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			<span class="s">&quot;cs4297a: cs4297a_open(): Error - unable to find audio state struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">VALIDATE_STATE</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>wait for device to become free </p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_WRITE</span> <span class="o">|</span> <span class="n">FMODE_READ</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			 <span class="s">&quot;cs4297a: cs4297a_open(): Error - must open READ and/or WRITE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_TX</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: TX pipe needs to drain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_TX</span><span class="p">)))</span>
                                <span class="p">;</span>
                <span class="p">}</span>
          
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait_dac</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;open - sig pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
                        <span class="p">}</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
			<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait_adc</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;open - sig pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
                        <span class="p">}</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">|=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FMODE_READ</span> <span class="o">|</span> <span class="n">FMODE_WRITE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">AFMT_S16_BE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt_original</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">fmt</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_adc</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_READ</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ossfragshift</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">ossmaxfrags</span> <span class="o">=</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prog_dmabuf_adc</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_OPEN</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;cs4297a: adc Program dmabufs failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">cs4297a_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">AFMT_S16_BE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt_original</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">fmt</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">prop_dac</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">conversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ena</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FMODE_WRITE</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ossfragshift</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">ossmaxfrags</span> <span class="o">=</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">subdivision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prog_dmabuf_dac</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_OPEN</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;cs4297a: dac Program dmabufs failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
			<span class="n">cs4297a_release</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_FUNCTION</span> <span class="o">|</span> <span class="n">CS_OPEN</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_open()- 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4297a_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cs4297a_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">swarm_cs4297a_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><hr />

<p>Wave (audio) file operations struct.</p>

<hr /></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">cs4297a_audio_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">cs4297a_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">cs4297a_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">cs4297a_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">cs4297a_unlocked_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">cs4297a_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">cs4297a_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">cs4297a_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs4297a_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_STATUS_DEBUG</span><span class="p">));</span>

        <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INTERRUPT</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
                 <span class="s">&quot;cs4297a: cs4297a_interrupt() HISR=0x%.8x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        /* XXXKW what check *should* be done here? */</span>
<span class="c">        if (!(status &amp; (M_SYNCSER_RX_EOP_COUNT | M_SYNCSER_RX_OVERRUN | M_SYNCSER_RX_SYNC_ERR))) {</span>
<span class="c">                status = __raw_readq(SS_CSR(R_SER_STATUS));</span>
<span class="c">                printk(KERN_ERR &quot;cs4297a: unexpected interrupt (status %08x)\n&quot;, status);</span>
<span class="c">                return;</span>
<span class="c">        }</span>
<span class="cp">#endif</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_SYNCSER_RX_SYNC_ERR</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_STATUS</span><span class="p">));</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: rx sync error (status %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">M_SYNCSER_RX_OVERRUN</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">newptr</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_ovrrn</span><span class="o">++</span><span class="p">;</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: receive FIFO overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

                <span class="cm">/* Fix things up: get the receive descriptor pool</span>
<span class="cm">                   clean and give them back to the hardware */</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_RX</span><span class="p">)))</span>
                        <span class="p">;</span>
                <span class="n">newptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(((</span><span class="n">__raw_readq</span><span class="p">(</span><span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_CUR_DSCR_ADDR_RX</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_DMA_CURDSCR_ADDR</span><span class="p">)</span> <span class="o">-</span>
                                     <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">descrtab_phys</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serdma_descr_t</span><span class="p">));</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">DMA_DESCR</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">descrtab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr_a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M_DMA_SERRX_SOP</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">swptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">hwptr</span> <span class="o">=</span> <span class="n">newptr</span><span class="p">;</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_swptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sb_hwptr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">sample_buf</span><span class="p">;</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">DMA_DESCR</span><span class="p">,</span> <span class="n">SS_CSR</span><span class="p">(</span><span class="n">R_SER_DMA_DSCR_COUNT_RX</span><span class="p">));</span>
        <span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cs4297a_update_ptr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">CS_TRUE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INTERRUPT</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		  <span class="s">&quot;cs4297a: cs4297a_interrupt()-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static struct initvol {</span>
<span class="c">	int mixch;</span>
<span class="c">	int vol;</span>
<span class="c">} initvol[] __initdata = {</span>

<span class="c">  	{SOUND_MIXER_WRITE_VOLUME, 0x4040},</span>
<span class="c">        {SOUND_MIXER_WRITE_PCM, 0x4040},</span>
<span class="c">        {SOUND_MIXER_WRITE_SYNTH, 0x4040},</span>
<span class="c">	{SOUND_MIXER_WRITE_CD, 0x4040},</span>
<span class="c">	{SOUND_MIXER_WRITE_LINE, 0x4040},</span>
<span class="c">	{SOUND_MIXER_WRITE_LINE1, 0x4040},</span>
<span class="c">	{SOUND_MIXER_WRITE_RECLEV, 0x0000},</span>
<span class="c">	{SOUND_MIXER_WRITE_SPEAKER, 0x4040},</span>
<span class="c">	{SOUND_MIXER_WRITE_MIC, 0x0000}</span>
<span class="c">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cs4297a_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cs4297a_state</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pwr</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
<span class="cp">#ifndef CONFIG_BCM_CS4297A_CSWARM</span>
	<span class="n">u64</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mdio_val</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> 
		<span class="s">&quot;cs4297a: cs4297a_init_module()+ </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>

<span class="cp">#ifndef CONFIG_BCM_CS4297A_CSWARM</span>
        <span class="n">mdio_val</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">KSEG1</span> <span class="o">+</span> <span class="n">A_MAC_REGISTER</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">R_MAC_MDIO</span><span class="p">))</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">M_MAC_MDIO_DIR</span><span class="o">|</span><span class="n">M_MAC_MDIO_OUT</span><span class="p">);</span>

        <span class="cm">/* Check syscfg for synchronous serial on port 1 */</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">KSEG1</span> <span class="o">+</span> <span class="n">A_SCD_SYSTEM_CFG</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">M_SYS_SER1_ENABLE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">cfg</span> <span class="o">|</span> <span class="n">M_SYS_SER1_ENABLE</span><span class="p">,</span> <span class="n">KSEG1</span><span class="o">+</span><span class="n">A_SCD_SYSTEM_CFG</span><span class="p">);</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">__raw_readq</span><span class="p">(</span><span class="n">KSEG1</span> <span class="o">+</span> <span class="n">A_SCD_SYSTEM_CFG</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cfg</span> <span class="o">&amp;</span> <span class="n">M_SYS_SER1_ENABLE</span><span class="p">))</span> <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: serial port 1 not configured for synchronous operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                  <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: serial port 1 switching to synchronous operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                
                <span class="cm">/* Force the codec (on SWARM) to reset by clearing</span>
<span class="cm">                   GENO, preserving MDIO (no effect on CSWARM) */</span>
                <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">mdio_val</span><span class="p">,</span> <span class="n">KSEG1</span><span class="o">+</span><span class="n">A_MAC_REGISTER</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">R_MAC_MDIO</span><span class="p">));</span>
                <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Now set GENO */</span>
        <span class="n">__raw_writeq</span><span class="p">(</span><span class="n">mdio_val</span> <span class="o">|</span> <span class="n">M_MAC_GENC</span><span class="p">,</span> <span class="n">KSEG1</span><span class="o">+</span><span class="n">A_MAC_REGISTER</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">R_MAC_MDIO</span><span class="p">));</span>
        <span class="cm">/* Give the codec some time to finish resetting (start the bit clock) */</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4297a_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		      <span class="s">&quot;cs4297a: probe() no memory for state struct.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="n">s</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">CS4297a_MAGIC</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_adc</span><span class="p">.</span><span class="n">reg_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_dac</span><span class="p">.</span><span class="n">reg_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait_adc</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_wait_dac</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_adc</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">open_sem_dac</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">K_INT_SER_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span>
	    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">cs4297a_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Crystal CS4297a&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cs4297a: irq %u in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev_audio</span> <span class="o">=</span> <span class="n">register_sound_dsp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs4297a_audio_fops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			 <span class="s">&quot;cs4297a: probe() register_sound_dsp() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_dev1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev_mixer</span> <span class="o">=</span> <span class="n">register_sound_mixer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs4297a_mixer_fops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			 <span class="s">&quot;cs4297a: probe() register_sound_mixer() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_dev2</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ser_init</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">||</span> <span class="n">dma_init</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			 <span class="s">&quot;cs4297a: ser_init failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err_dev3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">do</span> <span class="p">{</span>
                <span class="n">udelay</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
                <span class="n">rval</span> <span class="o">=</span> <span class="n">cs4297a_read_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_POWER_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwr</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pwr</span> <span class="o">!=</span> <span class="mh">0xf</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sb1250_duart_present</span><span class="p">;</span>

                <span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
                <span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">                val = SOUND_MASK_LINE;</span>
<span class="c">                mixer_ioctl(s, SOUND_MIXER_WRITE_RECSRC, (unsigned long) &amp;val);</span>
<span class="c">                for (i = 0; i &lt; ARRAY_SIZE(initvol); i++) {</span>
<span class="c">                        val = initvol[i].vol;</span>
<span class="c">                        mixer_ioctl(s, initvol[i].mixch, (unsigned long) &amp;val);</span>
<span class="c">                }</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><pre><code>           cs4297a_write_ac97(s, 0x18, 0x0808);
</code></pre></td><td class="code"><div class="highlight"><pre><span class="cp">#else</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><pre><code>           cs4297a_write_ac97(s, 0x5e, 0x180);
</code></pre></td><td class="code"><div class="highlight"><pre>                <span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
                <span class="n">cs4297a_write_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
<span class="cp">#endif</span>
                <span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>

                <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs4297a_devs</span><span class="p">);</span>

                <span class="n">cs4297a_read_ac97</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">AC97_VENDOR_ID1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>

		<span class="n">sb1250_duart_present</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">sb1250_duart_present</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb1250_duart_present</span><span class="p">)</span>
			<span class="n">sb1250_duart_present</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: initialized (vendor id = %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

                <span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                          <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cs4297a_init_module()-</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
                
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

 <span class="nl">err_dev3:</span>
	<span class="n">unregister_sound_mixer</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev_mixer</span><span class="p">);</span>
 <span class="nl">err_dev2:</span>
	<span class="n">unregister_sound_dsp</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev_audio</span><span class="p">);</span>
 <span class="nl">err_dev1:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
 <span class="nl">err_irq:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">cs4297a_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/*</span>
<span class="cm">          XXXKW </span>
<span class="cm">           disable_irq, free_irq</span>
<span class="cm">           drain DMA queue</span>
<span class="cm">           disable DMA</span>
<span class="cm">           disable TX/RX</span>
<span class="cm">           free memory</span>
<span class="cm">        */</span>
	<span class="n">CS_DBGOUT</span><span class="p">(</span><span class="n">CS_INIT</span> <span class="o">|</span> <span class="n">CS_FUNCTION</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;cs4297a: cleanup_cs4297a() finished</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kip Walker, Broadcom Corp.&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Cirrus Logic CS4297a Driver for Broadcom SWARM board&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><hr /></td><td class="code"><div class="highlight"><pre><span class="n">module_init</span><span class="p">(</span><span class="n">cs4297a_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cs4297a_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
