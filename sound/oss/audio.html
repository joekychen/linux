<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › oss › audio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>audio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * sound/oss/audio.c</span>
<span class="cm"> *</span>
<span class="cm"> * Device file manager for /dev/audio</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Copyright (C) by Hannu Savolainen 1993-1997</span>
<span class="cm"> *</span>
<span class="cm"> * OSS/Free for Linux is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Thomas Sailer   : ioctl code reworked (vmalloc/vfree removed)</span>
<span class="cm"> * Thomas Sailer   : moved several static variables into struct audio_operations</span>
<span class="cm"> *                   (which is grossly misnamed btw.) because they have the same</span>
<span class="cm"> *                   lifetime as the rest in there and dynamic allocation saves</span>
<span class="cm"> *                   12k or so</span>
<span class="cm"> * Thomas Sailer   : use more logical O_NONBLOCK semantics</span>
<span class="cm"> * Daniel Rodriksson: reworked the use of the device specific copy_user</span>
<span class="cm"> *                    still generic</span>
<span class="cm"> * Horst von Brand:  Add missing #include &lt;linux/string.h&gt;</span>
<span class="cm"> * Chris Rankin    : Update the module-usage counter for the coprocessor,</span>
<span class="cm"> *                   and decrement the counters again if we cannot open</span>
<span class="cm"> *                   the audio device.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/stddef.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &quot;sound_config.h&quot;</span>
<span class="cp">#include &quot;ulaw.h&quot;</span>
<span class="cp">#include &quot;coproc.h&quot;</span>

<span class="cp">#define NEUTRAL8	0x80</span>
<span class="cp">#define NEUTRAL16	0x00</span>


<span class="k">static</span> <span class="kt">int</span>             <span class="n">dma_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_format</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">!=</span> <span class="n">AFMT_QUERY</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">format_mask</span> <span class="o">&amp;</span> <span class="n">fmt</span><span class="p">))</span>	<span class="cm">/* Not supported */</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="n">AFMT_MU_LAW</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">fmt</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>
				<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span> <span class="o">=</span> <span class="n">CNV_MU_LAW</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span>
				<span class="n">fmt</span> <span class="o">=</span> <span class="n">AFMT_U8</span><span class="p">;</span>	<span class="cm">/* This is always supported */</span>
		<span class="p">}</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_format</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span><span class="p">;</span>
	<span class="k">else</span> 
		<span class="k">return</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_format</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">audio_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_type</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">audio_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">coproc_operations</span> <span class="o">*</span><span class="n">coprocessor</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SND_DEV_DSP16</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">num_audiodevs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">DMAbuf_open</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">coprocessor</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">error_2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">,</span> <span class="n">COPR_PCM</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Sound: Can&#39;t access coprocessor device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">SND_DEV_AUDIO</span><span class="p">)</span>
		<span class="n">set_format</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">AFMT_MU_LAW</span><span class="p">);</span>
	<span class="k">else</span> 
		<span class="n">set_format</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>

	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="n">AM_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clean-up stack: this is what needs (un)doing if</span>
<span class="cm">	 * we can&#39;t open the audio device ...</span>
<span class="cm">	 */</span>
	<span class="nl">error_3:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="nl">error_2:</span>
	<span class="n">DMAbuf_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="nl">error_1:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sync_output</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">p</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">l</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_POST</span><span class="p">;</span>

	<span class="cm">/* Align the write pointer with fragment boundaries */</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">l</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offs</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">-</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">+</span> <span class="n">offs</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">DMAbuf_move_wrpointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * Clean all unused buffer fragments.</span>
<span class="cm">	 */</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qtail</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_POST</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span> <span class="o">&gt;</span>
			<span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">+</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audio: Buffer error 2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">+</span> <span class="n">p</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_DIRTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">audio_release</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">coproc_operations</span> <span class="o">*</span><span class="n">coprocessor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">translate_mode</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We do this in DMAbuf_release(). Why are we doing it</span>
<span class="cm">	 * here? Why don&#39;t we test the file mode before setting</span>
<span class="cm">	 * both flags? DMAbuf_release() does.</span>
<span class="cm">	 * ...pester...pester...pester...</span>
<span class="cm">	 */</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to make sure we allocated the dmap_out buffer</span>
<span class="cm">	 * before we go mucking around with it in sync_output().</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
		<span class="n">sync_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">coprocessor</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">(</span><span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">,</span> <span class="n">COPR_PCM</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">coprocessor</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DMAbuf_release</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">module_put</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">translate_bytes</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>   <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">audio_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">used</span><span class="p">,</span> <span class="n">returned</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">dma_buf</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">AM_WRITE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="n">AM_WRITE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>		<span class="cm">/* Flush output */</span>
	<span class="p">{</span>
		  <span class="n">sync_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">DMAbuf_getwrbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_size</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			    <span class="cm">/* Handle nonblocking mode */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">p</span><span class="o">?</span> <span class="n">p</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>	<span class="cm">/* No more space. Return # of accepted bytes */</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">buf_size</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">buf_size</span><span class="p">;</span>

		<span class="n">returned</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">copy_user</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dma_buf</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span>
				<span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span> <span class="o">+</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audio: Buffer error 3 (%lx,%d), (%lx, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dma_buf</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_buf</span> <span class="o">&lt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audio: Buffer error 13 (%lx&lt;%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">dma_buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EDOM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dma_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">)[</span><span class="n">p</span><span class="p">],</span> <span class="n">l</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span> 
		<span class="k">else</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">copy_user</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">dma_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
						<span class="n">c</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">used</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">returned</span><span class="p">,</span>
						<span class="n">l</span><span class="p">);</span>
		<span class="n">l</span> <span class="o">=</span> <span class="n">returned</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span> <span class="o">&amp;</span> <span class="n">CNV_MU_LAW</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">translate_bytes</span><span class="p">(</span><span class="n">ulaw_dsp</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">dma_buf</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">c</span> <span class="o">-=</span> <span class="n">used</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">used</span><span class="p">;</span>
		<span class="n">DMAbuf_move_wrpointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">audio_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">char</span>           <span class="o">*</span><span class="n">dmabuf</span><span class="p">;</span>
	<span class="kt">int</span>             <span class="n">buf_no</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">AM_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">))</span>
		<span class="n">sync_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">|=</span> <span class="n">AM_READ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="n">AM_READ</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">buf_no</span> <span class="o">=</span> <span class="n">DMAbuf_getrdbuffer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dmabuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *	Nonblocking mode handling. Return current # of bytes</span>
<span class="cm">			 */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 		<span class="cm">/* Avoid throwing away data */</span>
				<span class="k">return</span> <span class="n">p</span><span class="p">;</span>	<span class="cm">/* Return it instead */</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">buf_no</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">buf_no</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">)</span>
			<span class="n">l</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Insert any local processing here.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">local_conversion</span> <span class="o">&amp;</span> <span class="n">CNV_MU_LAW</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">translate_bytes</span><span class="p">(</span><span class="n">dsp_ulaw</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">dmabuf</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>
		<span class="p">}</span>
		
		<span class="p">{</span>
			<span class="kt">char</span>           <span class="o">*</span><span class="n">fixit</span> <span class="o">=</span> <span class="n">dmabuf</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">buf</span><span class="p">)[</span><span class="n">p</span><span class="p">],</span> <span class="n">fixit</span><span class="p">,</span> <span class="n">l</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">};</span>

		<span class="n">DMAbuf_rmchars</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf_no</span><span class="p">,</span> <span class="n">l</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">l</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">-=</span> <span class="n">l</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">audio_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="p">)</span>	<span class="cm">/* Coprocessor ioctl */</span>
			<span class="k">return</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="o">-&gt;</span><span class="n">devc</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* else</span>
<span class="cm">		        printk(KERN_DEBUG&quot;/dev/dsp%d: No coprocessor for this device\n&quot;, dev); */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SNDCTL_DSP_SYNC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sync_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">DMAbuf_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">DMAbuf_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_POST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_POST</span> <span class="o">|</span> <span class="n">DMA_DIRTY</span><span class="p">;</span>
			<span class="n">sync_output</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dma_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SNDCTL_DSP_POST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_RESET</span>:
			<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">=</span> <span class="n">AM_NONE</span><span class="p">;</span>
			<span class="n">DMAbuf_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETFMTS</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">format_mask</span> <span class="o">|</span> <span class="n">AFMT_MU_LAW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	
		<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFMT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">set_format</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETISPACE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  			<span class="k">if</span> <span class="p">((</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">AM_WRITE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">))</span>
  				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">dma_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOSPACE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
  			<span class="k">if</span> <span class="p">((</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">audio_mode</span> <span class="o">&amp;</span> <span class="n">AM_READ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">))</span>
  				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">dma_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		
		<span class="k">case</span> <span class="n">SNDCTL_DSP_NONBLOCK</span>:
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_lock</span><span class="p">);</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETCAPS</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">|</span> <span class="n">DSP_CAP_MMAP</span><span class="p">;</span>	<span class="cm">/* Revision level of this ioctl() */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span> <span class="o">&amp;&amp;</span>
					<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READWRITE</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="n">DSP_CAP_DUPLEX</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">coproc</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="n">DSP_CAP_COPROC</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">)</span>	<span class="cm">/* Device has hidden buffers */</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="n">DSP_CAP_BATCH</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>	<span class="cm">/* Supports SETTRIGGER */</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="n">DSP_CAP_TRIGGER</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="n">SOUND_PCM_WRITE_RATE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_PCM_READ_RATE</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
			
		<span class="k">case</span> <span class="n">SNDCTL_DSP_STEREO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_PCM_WRITE_CHANNELS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SOUND_PCM_READ_CHANNELS</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		
		<span class="k">case</span> <span class="n">SOUND_PCM_READ_BITS</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_SETDUPLEX</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">!=</span> <span class="n">OPEN_READWRITE</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_PROFILE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
				<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">applic_profile</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">)</span>
				<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">applic_profile</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		
		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETODELAY</span>:
			<span class="n">dmap</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ALLOC_DONE</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">val</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* Compute number of bytes that have been played */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">DMAbuf_get_buffer_pointer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="n">DMODE_OUTPUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&amp;&amp;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>	<span class="cm">/* Pointer wrap not handled yet */</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
		
			<span class="cm">/* Subtract current count from the number of bytes written by app */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">dma_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">audio_init_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE! This routine could be called several times during boot.</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reorganize_buffers</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">recording</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This routine breaks the physical device buffers to logical ones.</span>
<span class="cm">	 */</span>

	<span class="k">struct</span> <span class="n">audio_operations</span> <span class="o">*</span><span class="n">dsp_dev</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">sr</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">sz</span><span class="p">,</span> <span class="n">bsz</span><span class="p">;</span>

	<span class="n">sr</span> <span class="o">=</span> <span class="n">dsp_dev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">nc</span> <span class="o">=</span> <span class="n">dsp_dev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_channels</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sz</span> <span class="o">=</span> <span class="n">dsp_dev</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">set_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span> <span class="o">=</span> <span class="n">NEUTRAL8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span> <span class="o">=</span> <span class="n">NEUTRAL16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">nc</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">sz</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
	<span class="p">{</span>
<span class="cm">/*		printk(KERN_DEBUG &quot;Warning: Invalid PCM parameters[%d] sr=%d, nc=%d, sz=%d\n&quot;, dev, sr, nc, sz);*/</span>
		<span class="n">sr</span> <span class="o">=</span> <span class="n">DSP_DEFAULT_SPEED</span><span class="p">;</span>
		<span class="n">nc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sz</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">sz</span> <span class="o">=</span> <span class="n">sr</span> <span class="o">*</span> <span class="n">nc</span> <span class="o">*</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">/=</span> <span class="mi">8</span><span class="p">;</span>		<span class="cm">/* #bits -&gt; #bytes */</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">needs_reorg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>	
		<span class="cm">/* Compute the fragment size using the default algorithm */</span>

		<span class="cm">/*</span>
<span class="cm">		 * Compute a buffer size for time not exceeding 1 second.</span>
<span class="cm">		 * Usually this algorithm gives a buffer size for 0.5 to 1.0 seconds</span>
<span class="cm">		 * of sound (using the current speed, sample size and #channels).</span>
<span class="cm">		 */</span>

		<span class="n">bsz</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bsz</span> <span class="o">&gt;</span> <span class="n">sz</span><span class="p">)</span>
			<span class="n">bsz</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bsz</span> <span class="o">==</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">)</span>
			<span class="n">bsz</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Needs at least 2 buffers */</span>

		<span class="cm">/*</span>
<span class="cm">		 *    Split the computed fragment to smaller parts. After 3.5a9</span>
<span class="cm">		 *      the default subdivision is 4 which should give better</span>
<span class="cm">		 *      results when recording.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Not already set */</span>
		<span class="p">{</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Init to the default value */</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">bsz</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">bsz</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">)</span>
				<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bsz</span> <span class="o">/=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bsz</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">bsz</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Just a sanity check */</span>

		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="n">bsz</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The process has specified the buffer size with SNDCTL_DSP_SETFRAGMENT or</span>
<span class="cm">		 * the buffer size computation has already been done.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">bsz</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bsz</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span><span class="p">))</span>
			<span class="n">bsz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_fragment</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bsz</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_fragment</span><span class="p">))</span>
			<span class="n">bsz</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_fragment</span><span class="p">;</span>
	<span class="n">bsz</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">;</span>		<span class="cm">/* Force size which is multiple of 8 bytes */</span>
<span class="cp">#ifdef OS_DMA_ALIGN_CHECK</span>
	<span class="n">OS_DMA_ALIGN_CHECK</span><span class="p">(</span><span class="n">bsz</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">/</span> <span class="n">bsz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">MAX_SUB_BUFFERS</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">MAX_SUB_BUFFERS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_fragments</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_fragments</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">bsz</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">bsz</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="n">bsz</span><span class="p">;</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_byte_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>	<span class="cm">/* Approximately one hour */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">raw_buf</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">neutral_byte</span><span class="p">,</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">DMA_ALLOC_DONE</span> <span class="o">|</span> <span class="n">DMA_EMPTY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_subdivide</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fact</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fact</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="n">fact</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fact</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fact</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">fact</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span>	<span class="cm">/* Too late to change */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fact</span> <span class="o">&gt;</span> <span class="n">MAX_REALTIME_FACTOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fact</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">fact</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">fact</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">fact</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">fact</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">=</span> <span class="n">fact</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fact</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_set_fragment</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fact</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bytes</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fact</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">)</span>	<span class="cm">/* Too late to change */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bytes</span> <span class="o">=</span> <span class="n">fact</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">fact</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">MAX_SUB_BUFFERS</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">MAX_SUB_BUFFERS</span><span class="p">)</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">17</span><span class="p">)</span>	<span class="cm">/* &lt;16 || &gt; 512k */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span><span class="p">)</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">min_fragment</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_fragment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_fragment</span><span class="p">)</span>
			<span class="n">bytes</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">max_fragment</span><span class="p">;</span>

<span class="cp">#ifdef OS_DMA_MINBITS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">OS_DMA_MINBITS</span><span class="p">)</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">OS_DMA_MINBITS</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bytes</span><span class="p">);</span>
	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">max_fragments</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&gt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">)</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">==</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">buffsize</span> <span class="o">&amp;&amp;</span>
	    <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_AUTOMODE</span><span class="p">)</span>
		<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Needs at least 2 buffers */</span>

	<span class="n">dmap</span><span class="o">-&gt;</span><span class="n">subdivision</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Disable SNDCTL_DSP_SUBDIVIDE */</span>
	<span class="k">return</span> <span class="n">bytes</span> <span class="o">|</span> <span class="p">((</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dma_ioctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap_out</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap_in</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dma_buffparms</span> <span class="o">*</span><span class="n">dmap</span><span class="p">;</span>
	<span class="n">audio_buf_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">count_info</span> <span class="n">cinfo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fact</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">bits</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> 
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SNDCTL_DSP_SUBDIVIDE</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">fact</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_subdivide</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">,</span> <span class="n">fact</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">!=</span> <span class="n">OPEN_WRITE</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span> <span class="o">&amp;&amp;</span>
					<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_subdivide</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">,</span> <span class="n">fact</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETISPACE</span>:
		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOSPACE</span>:
			<span class="n">dmap</span> <span class="o">=</span> <span class="n">dmap_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETISPACE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETOSPACE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETISPACE</span> <span class="o">&amp;&amp;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span>
				<span class="n">dmap</span> <span class="o">=</span> <span class="n">dmap_in</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ALLOC_DONE</span><span class="p">))</span>
				<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap</span><span class="p">,</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETISPACE</span><span class="p">));</span>
			<span class="n">info</span><span class="p">.</span><span class="n">fragstotal</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETISPACE</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">;</span>
			<span class="k">else</span> 
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">DMAbuf_space_in_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
					<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">DMAbuf_space_in_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">)</span> 
					<span class="p">{</span>
						<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">local_qlen</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="n">info</span><span class="p">.</span><span class="n">fragments</span><span class="p">)</span>
							<span class="n">tmp</span><span class="o">--</span><span class="p">;</span>	<span class="cm">/*</span>
<span class="cm">								 * This buffer has been counted twice</span>
<span class="cm">								 */</span>
						<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">&gt;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">;</span>

			<span class="n">info</span><span class="p">.</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">*</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDCTL_DSP_GETISPACE</span> <span class="o">&amp;&amp;</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">];</span>
			<span class="k">else</span> 
			<span class="p">{</span>
				<span class="n">info</span><span class="p">.</span><span class="n">fragments</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">/</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
				<span class="n">info</span><span class="p">.</span><span class="n">bytes</span> <span class="o">-=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">%</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_SETTRIGGER</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">bits</span> <span class="o">&amp;=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">^</span> <span class="n">bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">)</span> 
				<span class="p">{</span>
					<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">prepare_for_input</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						     <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">,</span> <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">nbufs</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_INPUT</span><span class="p">;</span>
					<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
					<span class="n">DMAbuf_activate_recording</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_INPUT</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">^</span> <span class="n">bits</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span> <span class="o">||</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">go</span><span class="p">)</span> 
				<span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ALLOC_DONE</span><span class="p">))</span>
						<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">dma_mode</span> <span class="o">=</span> <span class="n">DMODE_OUTPUT</span><span class="p">;</span>
					<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">|=</span> <span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
					<span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qhead</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
					<span class="n">DMAbuf_launch_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCM_ENABLE_OUTPUT</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			if (changed &amp;&amp; audio_devs[dev]-&gt;d-&gt;trigger)</span>
<span class="c">				audio_devs[dev]-&gt;d-&gt;trigger(dev, bits * audio_devs[dev]-&gt;go);</span>
<span class="cp">#endif				</span>
			<span class="cm">/* Falls through... */</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETTRIGGER</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">enable_bits</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_SETSYNCRO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">go</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETIPTR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">DMAbuf_get_buffer_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">,</span> <span class="n">DMODE_INPUT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&amp;&amp;</span> <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">qtail</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>	<span class="cm">/* Pointer wrap not handled yet */</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">;</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span>
				<span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Reset interrupt counter */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_in</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETOPTR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">DMAbuf_get_buffer_pointer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">,</span> <span class="n">DMODE_OUTPUT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&amp;&amp;</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>	<span class="cm">/* Pointer wrap not handled yet */</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span><span class="p">;</span>
			<span class="n">cinfo</span><span class="p">.</span><span class="n">bytes</span> <span class="o">+=</span> <span class="n">cinfo</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">mapping_flags</span> <span class="o">&amp;</span> <span class="n">DMA_MAP_MAPPED</span><span class="p">)</span>
				<span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Reset interrupt counter */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cinfo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cinfo</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETODELAY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ALLOC_DONE</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="n">ret</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="cm">/* Compute number of bytes that have been played */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">DMAbuf_get_buffer_pointer</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">,</span> <span class="n">DMODE_OUTPUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">fragment_size</span> <span class="o">&amp;&amp;</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qhead</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">+=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">bytes_in_use</span><span class="p">;</span>	<span class="cm">/* Pointer wrap not handled yet */</span>
			<span class="n">count</span> <span class="o">+=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">byte_counter</span><span class="p">;</span>
			<span class="cm">/* Subtract current count from the number of bytes written by app */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">user_counter</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_POST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">qlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_ACTIVE</span><span class="p">))</span>
					<span class="n">DMAbuf_launch_output</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">dmap_out</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_GETBLKSIZE</span>:
			<span class="n">dmap</span> <span class="o">=</span> <span class="n">dmap_out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
				<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">,</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span> <span class="o">&amp;&amp;</span>
			     <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
				<span class="n">reorganize_buffers</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">,</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span><span class="p">)</span>
				<span class="n">dmap</span> <span class="o">=</span> <span class="n">dmap_in</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">dmap</span><span class="o">-&gt;</span><span class="n">fragment_size</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SNDCTL_DSP_SETFRAGMENT</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">fact</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_WRITE</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_set_fragment</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_out</span><span class="p">,</span> <span class="n">fact</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">==</span> <span class="n">OPEN_READ</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DMA_DUPLEX</span> <span class="o">&amp;&amp;</span>
			     <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">open_mode</span> <span class="o">&amp;</span> <span class="n">OPEN_READ</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">dma_set_fragment</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmap_in</span><span class="p">,</span> <span class="n">fact</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span> <span class="cm">/* don&#39;t know what this is good for, but preserve old semantics */</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">audio_devs</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
