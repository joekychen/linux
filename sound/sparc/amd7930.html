<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › sparc › amd7930.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>amd7930.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for AMD7930 sound chips found on Sparcs.</span>
<span class="cm"> * Copyright (C) 2002, 2008 David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based entirely upon drivers/sbus/audio/amd7930.c which is:</span>
<span class="cm"> * Copyright (C) 1996,1997 Thomas K. Dyas (tdyas@eden.rutgers.edu)</span>
<span class="cm"> *</span>
<span class="cm"> * --- Notes from Thomas&#39;s original driver ---</span>
<span class="cm"> * This is the lowlevel driver for the AMD7930 audio chip found on all</span>
<span class="cm"> * sun4c machines and some sun4m machines.</span>
<span class="cm"> *</span>
<span class="cm"> * The amd7930 is actually an ISDN chip which has a very simple</span>
<span class="cm"> * integrated audio encoder/decoder. When Sun decided on what chip to</span>
<span class="cm"> * use for audio, they had the brilliant idea of using the amd7930 and</span>
<span class="cm"> * only connecting the audio encoder/decoder pins.</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to the AMD engineer who was able to get us the AMD79C30</span>
<span class="cm"> * databook which has all the programming information and gain tables.</span>
<span class="cm"> *</span>
<span class="cm"> * Advanced Micro Devices&#39; Am79C30A is an ISDN/audio chip used in the</span>
<span class="cm"> * SparcStation 1+.  The chip provides microphone and speaker interfaces</span>
<span class="cm"> * which provide mono-channel audio at 8K samples per second via either</span>
<span class="cm"> * 8-bit A-law or 8-bit mu-law encoding.  Also, the chip features an</span>
<span class="cm"> * ISDN BRI Line Interface Unit (LIU), I.430 S/T physical interface,</span>
<span class="cm"> * which performs basic D channel LAPD processing and provides raw</span>
<span class="cm"> * B channel data.  The digital audio channel, the two ISDN B channels,</span>
<span class="cm"> * and two 64 Kbps channels to the microprocessor are all interconnected</span>
<span class="cm"> * via a multiplexer.</span>
<span class="cm"> * --- End of notes from Thoamas&#39;s original driver ---</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Sun AMD7930 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Sun AMD7930 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Sun AMD7930 soundcard.&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Thomas K. Dyas and David S. Miller&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun AMD7930&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Sun,AMD7930}}&quot;</span><span class="p">);</span>

<span class="cm">/* Device register layout.  */</span>

<span class="cm">/* Register interface presented to the CPU by the amd7930. */</span>
<span class="cp">#define AMD7930_CR	0x00UL		</span><span class="cm">/* Command Register (W) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_IR	AMD7930_CR	</span><span class="cm">/* Interrupt Register (R) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_DR	0x01UL		</span><span class="cm">/* Data Register (R/W) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_DSR1	0x02UL		</span><span class="cm">/* D-channel Status Register 1 (R) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_DER	0x03UL		</span><span class="cm">/* D-channel Error Register (R) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_DCTB	0x04UL		</span><span class="cm">/* D-channel Transmit Buffer (W) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_DCRB	AMD7930_DCTB	</span><span class="cm">/* D-channel Receive Buffer (R) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_BBTB	0x05UL		</span><span class="cm">/* Bb-channel Transmit Buffer (W) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_BBRB	AMD7930_BBTB	</span><span class="cm">/* Bb-channel Receive Buffer (R) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_BCTB	0x06UL		</span><span class="cm">/* Bc-channel Transmit Buffer (W) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_BCRB	AMD7930_BCTB	</span><span class="cm">/* Bc-channel Receive Buffer (R) */</span><span class="cp"></span>
<span class="cp">#define AMD7930_DSR2	0x07UL		</span><span class="cm">/* D-channel Status Register 2 (R) */</span><span class="cp"></span>

<span class="cm">/* Indirect registers in the Main Audio Processor. */</span>
<span class="k">struct</span> <span class="n">amd7930_map</span> <span class="p">{</span>
	<span class="n">__u16</span>	<span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u16</span>	<span class="n">r</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__u16</span>	<span class="n">gx</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">gr</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">ger</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">stgr</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">ftgr</span><span class="p">;</span>
	<span class="n">__u16</span>	<span class="n">atgr</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">mmr1</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">mmr2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* After an amd7930 interrupt, reading the Interrupt Register (ir)</span>
<span class="cm"> * clears the interrupt and returns a bitmask indicating which</span>
<span class="cm"> * interrupt source(s) require service.</span>
<span class="cm"> */</span>

<span class="cp">#define AMR_IR_DTTHRSH			0x01 </span><span class="cm">/* D-channel xmit threshold */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_DRTHRSH			0x02 </span><span class="cm">/* D-channel recv threshold */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_DSRI			0x04 </span><span class="cm">/* D-channel packet status */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_DERI			0x08 </span><span class="cm">/* D-channel error */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_BBUF			0x10 </span><span class="cm">/* B-channel data xfer */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_LSRI			0x20 </span><span class="cm">/* LIU status */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_DSR2I			0x40 </span><span class="cm">/* D-channel buffer status */</span><span class="cp"></span>
<span class="cp">#define AMR_IR_MLTFRMI			0x80 </span><span class="cm">/* multiframe or PP */</span><span class="cp"></span>

<span class="cm">/* The amd7930 has &quot;indirect registers&quot; which are accessed by writing</span>
<span class="cm"> * the register number into the Command Register and then reading or</span>
<span class="cm"> * writing values from the Data Register as appropriate. We define the</span>
<span class="cm"> * AMR_* macros to be the indirect register numbers and AM_* macros to</span>
<span class="cm"> * be bits in whatever register is referred to.</span>
<span class="cm"> */</span>

<span class="cm">/* Initialization */</span>
<span class="cp">#define	AMR_INIT			0x21</span>
<span class="cp">#define		AM_INIT_ACTIVE			0x01</span>
<span class="cp">#define		AM_INIT_DATAONLY		0x02</span>
<span class="cp">#define		AM_INIT_POWERDOWN		0x03</span>
<span class="cp">#define		AM_INIT_DISABLE_INTS		0x04</span>
<span class="cp">#define AMR_INIT2			0x20</span>
<span class="cp">#define		AM_INIT2_ENABLE_POWERDOWN	0x20</span>
<span class="cp">#define		AM_INIT2_ENABLE_MULTIFRAME	0x10</span>

<span class="cm">/* Line Interface Unit */</span>
<span class="cp">#define	AMR_LIU_LSR			0xA1</span>
<span class="cp">#define		AM_LIU_LSR_STATE		0x07</span>
<span class="cp">#define		AM_LIU_LSR_F3			0x08</span>
<span class="cp">#define		AM_LIU_LSR_F7			0x10</span>
<span class="cp">#define		AM_LIU_LSR_F8			0x20</span>
<span class="cp">#define		AM_LIU_LSR_HSW			0x40</span>
<span class="cp">#define		AM_LIU_LSR_HSW_CHG		0x80</span>
<span class="cp">#define	AMR_LIU_LPR			0xA2</span>
<span class="cp">#define	AMR_LIU_LMR1			0xA3</span>
<span class="cp">#define		AM_LIU_LMR1_B1_ENABL		0x01</span>
<span class="cp">#define		AM_LIU_LMR1_B2_ENABL		0x02</span>
<span class="cp">#define		AM_LIU_LMR1_F_DISABL		0x04</span>
<span class="cp">#define		AM_LIU_LMR1_FA_DISABL		0x08</span>
<span class="cp">#define		AM_LIU_LMR1_REQ_ACTIV		0x10</span>
<span class="cp">#define		AM_LIU_LMR1_F8_F3		0x20</span>
<span class="cp">#define		AM_LIU_LMR1_LIU_ENABL		0x40</span>
<span class="cp">#define	AMR_LIU_LMR2			0xA4</span>
<span class="cp">#define		AM_LIU_LMR2_DECHO		0x01</span>
<span class="cp">#define		AM_LIU_LMR2_DLOOP		0x02</span>
<span class="cp">#define		AM_LIU_LMR2_DBACKOFF		0x04</span>
<span class="cp">#define		AM_LIU_LMR2_EN_F3_INT		0x08</span>
<span class="cp">#define		AM_LIU_LMR2_EN_F8_INT		0x10</span>
<span class="cp">#define		AM_LIU_LMR2_EN_HSW_INT		0x20</span>
<span class="cp">#define		AM_LIU_LMR2_EN_F7_INT		0x40</span>
<span class="cp">#define	AMR_LIU_2_4			0xA5</span>
<span class="cp">#define	AMR_LIU_MF			0xA6</span>
<span class="cp">#define	AMR_LIU_MFSB			0xA7</span>
<span class="cp">#define	AMR_LIU_MFQB			0xA8</span>

<span class="cm">/* Multiplexor */</span>
<span class="cp">#define	AMR_MUX_MCR1			0x41</span>
<span class="cp">#define	AMR_MUX_MCR2			0x42</span>
<span class="cp">#define	AMR_MUX_MCR3			0x43</span>
<span class="cp">#define		AM_MUX_CHANNEL_B1		0x01</span>
<span class="cp">#define		AM_MUX_CHANNEL_B2		0x02</span>
<span class="cp">#define		AM_MUX_CHANNEL_Ba		0x03</span>
<span class="cp">#define		AM_MUX_CHANNEL_Bb		0x04</span>
<span class="cp">#define		AM_MUX_CHANNEL_Bc		0x05</span>
<span class="cp">#define		AM_MUX_CHANNEL_Bd		0x06</span>
<span class="cp">#define		AM_MUX_CHANNEL_Be		0x07</span>
<span class="cp">#define		AM_MUX_CHANNEL_Bf		0x08</span>
<span class="cp">#define	AMR_MUX_MCR4			0x44</span>
<span class="cp">#define		AM_MUX_MCR4_ENABLE_INTS		0x08</span>
<span class="cp">#define		AM_MUX_MCR4_REVERSE_Bb		0x10</span>
<span class="cp">#define		AM_MUX_MCR4_REVERSE_Bc		0x20</span>
<span class="cp">#define	AMR_MUX_1_4			0x45</span>

<span class="cm">/* Main Audio Processor */</span>
<span class="cp">#define	AMR_MAP_X			0x61</span>
<span class="cp">#define	AMR_MAP_R			0x62</span>
<span class="cp">#define	AMR_MAP_GX			0x63</span>
<span class="cp">#define	AMR_MAP_GR			0x64</span>
<span class="cp">#define	AMR_MAP_GER			0x65</span>
<span class="cp">#define	AMR_MAP_STGR			0x66</span>
<span class="cp">#define	AMR_MAP_FTGR_1_2		0x67</span>
<span class="cp">#define	AMR_MAP_ATGR_1_2		0x68</span>
<span class="cp">#define	AMR_MAP_MMR1			0x69</span>
<span class="cp">#define		AM_MAP_MMR1_ALAW		0x01</span>
<span class="cp">#define		AM_MAP_MMR1_GX			0x02</span>
<span class="cp">#define		AM_MAP_MMR1_GR			0x04</span>
<span class="cp">#define		AM_MAP_MMR1_GER			0x08</span>
<span class="cp">#define		AM_MAP_MMR1_X			0x10</span>
<span class="cp">#define		AM_MAP_MMR1_R			0x20</span>
<span class="cp">#define		AM_MAP_MMR1_STG			0x40</span>
<span class="cp">#define		AM_MAP_MMR1_LOOPBACK		0x80</span>
<span class="cp">#define	AMR_MAP_MMR2			0x6A</span>
<span class="cp">#define		AM_MAP_MMR2_AINB		0x01</span>
<span class="cp">#define		AM_MAP_MMR2_LS			0x02</span>
<span class="cp">#define		AM_MAP_MMR2_ENABLE_DTMF		0x04</span>
<span class="cp">#define		AM_MAP_MMR2_ENABLE_TONEGEN	0x08</span>
<span class="cp">#define		AM_MAP_MMR2_ENABLE_TONERING	0x10</span>
<span class="cp">#define		AM_MAP_MMR2_DISABLE_HIGHPASS	0x20</span>
<span class="cp">#define		AM_MAP_MMR2_DISABLE_AUTOZERO	0x40</span>
<span class="cp">#define	AMR_MAP_1_10			0x6B</span>
<span class="cp">#define	AMR_MAP_MMR3			0x6C</span>
<span class="cp">#define	AMR_MAP_STRA			0x6D</span>
<span class="cp">#define	AMR_MAP_STRF			0x6E</span>
<span class="cp">#define	AMR_MAP_PEAKX			0x70</span>
<span class="cp">#define	AMR_MAP_PEAKR			0x71</span>
<span class="cp">#define	AMR_MAP_15_16			0x72</span>

<span class="cm">/* Data Link Controller */</span>
<span class="cp">#define	AMR_DLC_FRAR_1_2_3		0x81</span>
<span class="cp">#define	AMR_DLC_SRAR_1_2_3		0x82</span>
<span class="cp">#define	AMR_DLC_TAR			0x83</span>
<span class="cp">#define	AMR_DLC_DRLR			0x84</span>
<span class="cp">#define	AMR_DLC_DTCR			0x85</span>
<span class="cp">#define	AMR_DLC_DMR1			0x86</span>
<span class="cp">#define		AMR_DLC_DMR1_DTTHRSH_INT	0x01</span>
<span class="cp">#define		AMR_DLC_DMR1_DRTHRSH_INT	0x02</span>
<span class="cp">#define		AMR_DLC_DMR1_TAR_ENABL		0x04</span>
<span class="cp">#define		AMR_DLC_DMR1_EORP_INT		0x08</span>
<span class="cp">#define		AMR_DLC_DMR1_EN_ADDR1		0x10</span>
<span class="cp">#define		AMR_DLC_DMR1_EN_ADDR2		0x20</span>
<span class="cp">#define		AMR_DLC_DMR1_EN_ADDR3		0x40</span>
<span class="cp">#define		AMR_DLC_DMR1_EN_ADDR4		0x80</span>
<span class="cp">#define		AMR_DLC_DMR1_EN_ADDRS		0xf0</span>
<span class="cp">#define	AMR_DLC_DMR2			0x87</span>
<span class="cp">#define		AMR_DLC_DMR2_RABRT_INT		0x01</span>
<span class="cp">#define		AMR_DLC_DMR2_RESID_INT		0x02</span>
<span class="cp">#define		AMR_DLC_DMR2_COLL_INT		0x04</span>
<span class="cp">#define		AMR_DLC_DMR2_FCS_INT		0x08</span>
<span class="cp">#define		AMR_DLC_DMR2_OVFL_INT		0x10</span>
<span class="cp">#define		AMR_DLC_DMR2_UNFL_INT		0x20</span>
<span class="cp">#define		AMR_DLC_DMR2_OVRN_INT		0x40</span>
<span class="cp">#define		AMR_DLC_DMR2_UNRN_INT		0x80</span>
<span class="cp">#define	AMR_DLC_1_7			0x88</span>
<span class="cp">#define	AMR_DLC_DRCR			0x89</span>
<span class="cp">#define	AMR_DLC_RNGR1			0x8A</span>
<span class="cp">#define	AMR_DLC_RNGR2			0x8B</span>
<span class="cp">#define	AMR_DLC_FRAR4			0x8C</span>
<span class="cp">#define	AMR_DLC_SRAR4			0x8D</span>
<span class="cp">#define	AMR_DLC_DMR3			0x8E</span>
<span class="cp">#define		AMR_DLC_DMR3_VA_INT		0x01</span>
<span class="cp">#define		AMR_DLC_DMR3_EOTP_INT		0x02</span>
<span class="cp">#define		AMR_DLC_DMR3_LBRP_INT		0x04</span>
<span class="cp">#define		AMR_DLC_DMR3_RBA_INT		0x08</span>
<span class="cp">#define		AMR_DLC_DMR3_LBT_INT		0x10</span>
<span class="cp">#define		AMR_DLC_DMR3_TBE_INT		0x20</span>
<span class="cp">#define		AMR_DLC_DMR3_RPLOST_INT		0x40</span>
<span class="cp">#define		AMR_DLC_DMR3_KEEP_FCS		0x80</span>
<span class="cp">#define	AMR_DLC_DMR4			0x8F</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_1		0x00</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_2		0x01</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_4		0x02</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_8		0x03</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_16		0x01</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_24		0x02</span>
<span class="cp">#define		AMR_DLC_DMR4_RCV_30		0x03</span>
<span class="cp">#define		AMR_DLC_DMR4_XMT_1		0x00</span>
<span class="cp">#define		AMR_DLC_DMR4_XMT_2		0x04</span>
<span class="cp">#define		AMR_DLC_DMR4_XMT_4		0x08</span>
<span class="cp">#define		AMR_DLC_DMR4_XMT_8		0x0c</span>
<span class="cp">#define		AMR_DLC_DMR4_XMT_10		0x08</span>
<span class="cp">#define		AMR_DLC_DMR4_XMT_14		0x0c</span>
<span class="cp">#define		AMR_DLC_DMR4_IDLE_MARK		0x00</span>
<span class="cp">#define		AMR_DLC_DMR4_IDLE_FLAG		0x10</span>
<span class="cp">#define		AMR_DLC_DMR4_ADDR_BOTH		0x00</span>
<span class="cp">#define		AMR_DLC_DMR4_ADDR_1ST		0x20</span>
<span class="cp">#define		AMR_DLC_DMR4_ADDR_2ND		0xa0</span>
<span class="cp">#define		AMR_DLC_DMR4_CR_ENABLE		0x40</span>
<span class="cp">#define	AMR_DLC_12_15			0x90</span>
<span class="cp">#define	AMR_DLC_ASR			0x91</span>
<span class="cp">#define	AMR_DLC_EFCR			0x92</span>
<span class="cp">#define		AMR_DLC_EFCR_EXTEND_FIFO	0x01</span>
<span class="cp">#define		AMR_DLC_EFCR_SEC_PKT_INT	0x02</span>

<span class="cp">#define AMR_DSR1_VADDR			0x01</span>
<span class="cp">#define AMR_DSR1_EORP			0x02</span>
<span class="cp">#define AMR_DSR1_PKT_IP			0x04</span>
<span class="cp">#define AMR_DSR1_DECHO_ON		0x08</span>
<span class="cp">#define AMR_DSR1_DLOOP_ON		0x10</span>
<span class="cp">#define AMR_DSR1_DBACK_OFF		0x20</span>
<span class="cp">#define AMR_DSR1_EOTP			0x40</span>
<span class="cp">#define AMR_DSR1_CXMT_ABRT		0x80</span>

<span class="cp">#define AMR_DSR2_LBRP			0x01</span>
<span class="cp">#define AMR_DSR2_RBA			0x02</span>
<span class="cp">#define AMR_DSR2_RPLOST			0x04</span>
<span class="cp">#define AMR_DSR2_LAST_BYTE		0x08</span>
<span class="cp">#define AMR_DSR2_TBE			0x10</span>
<span class="cp">#define AMR_DSR2_MARK_IDLE		0x20</span>
<span class="cp">#define AMR_DSR2_FLAG_IDLE		0x40</span>
<span class="cp">#define AMR_DSR2_SECOND_PKT		0x80</span>

<span class="cp">#define AMR_DER_RABRT			0x01</span>
<span class="cp">#define AMR_DER_RFRAME			0x02</span>
<span class="cp">#define AMR_DER_COLLISION		0x04</span>
<span class="cp">#define AMR_DER_FCS			0x08</span>
<span class="cp">#define AMR_DER_OVFL			0x10</span>
<span class="cp">#define AMR_DER_UNFL			0x20</span>
<span class="cp">#define AMR_DER_OVRN			0x40</span>
<span class="cp">#define AMR_DER_UNRN			0x80</span>

<span class="cm">/* Peripheral Port */</span>
<span class="cp">#define	AMR_PP_PPCR1			0xC0</span>
<span class="cp">#define	AMR_PP_PPSR			0xC1</span>
<span class="cp">#define	AMR_PP_PPIER			0xC2</span>
<span class="cp">#define	AMR_PP_MTDR			0xC3</span>
<span class="cp">#define	AMR_PP_MRDR			0xC3</span>
<span class="cp">#define	AMR_PP_CITDR0			0xC4</span>
<span class="cp">#define	AMR_PP_CIRDR0			0xC4</span>
<span class="cp">#define	AMR_PP_CITDR1			0xC5</span>
<span class="cp">#define	AMR_PP_CIRDR1			0xC5</span>
<span class="cp">#define	AMR_PP_PPCR2			0xC8</span>
<span class="cp">#define	AMR_PP_PPCR3			0xC9</span>

<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">u32</span>			<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define AMD7930_FLAG_PLAYBACK	0x00000001</span>
<span class="cp">#define AMD7930_FLAG_CAPTURE	0x00000002</span>

	<span class="k">struct</span> <span class="n">amd7930_map</span>	<span class="n">map</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_card</span>		<span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span>		<span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span>	<span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span>	<span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>

	<span class="cm">/* Playback/Capture buffer state. */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">p_orig</span><span class="p">,</span> <span class="o">*</span><span class="n">p_cur</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">p_left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">c_orig</span><span class="p">,</span> <span class="o">*</span><span class="n">c_cur</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">c_left</span><span class="p">;</span>

	<span class="kt">int</span>			<span class="n">rgain</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">pgain</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">mgain</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd7930_list</span><span class="p">;</span>

<span class="cm">/* Idle the AMD7930 chip.  The amd-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">amd7930_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_INIT</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable chip interrupts.  The amd-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">amd7930_enable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_INIT</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AM_INIT_ACTIVE</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disable chip interrupts.  The amd-&gt;lock is not held.  */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span> <span class="nf">amd7930_disable_ints</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_INIT</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AM_INIT_ACTIVE</span> <span class="o">|</span> <span class="n">AM_INIT_DISABLE_INTS</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Commit amd7930_map settings to the hardware.</span>
<span class="cm"> * The amd-&gt;lock is held and local interrupts are disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__amd7930_write_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd7930_map</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>

	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MAP_GX</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">gx</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">gx</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>

	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MAP_GR</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>

	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MAP_STGR</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stgr</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stgr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>

	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MAP_GER</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">ger</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">ger</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">),</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>

	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MAP_MMR1</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mmr1</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>

	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MAP_MMR2</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mmr2</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* gx, gr &amp; stg gains.  this table must contain 256 elements with</span>
<span class="cm"> * the 0th being &quot;infinity&quot; (the magic value 9008).  The remaining</span>
<span class="cm"> * elements match sun&#39;s gain curve (but with higher resolution):</span>
<span class="cm"> * -18 to 0dB in .16dB steps then 0 to 12dB in .08dB steps.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__const__</span> <span class="n">__u16</span> <span class="n">gx_coeff</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x9008</span><span class="p">,</span> <span class="mh">0x8b7c</span><span class="p">,</span> <span class="mh">0x8b51</span><span class="p">,</span> <span class="mh">0x8b45</span><span class="p">,</span> <span class="mh">0x8b42</span><span class="p">,</span> <span class="mh">0x8b3b</span><span class="p">,</span> <span class="mh">0x8b36</span><span class="p">,</span> <span class="mh">0x8b33</span><span class="p">,</span>
	<span class="mh">0x8b32</span><span class="p">,</span> <span class="mh">0x8b2a</span><span class="p">,</span> <span class="mh">0x8b2b</span><span class="p">,</span> <span class="mh">0x8b2c</span><span class="p">,</span> <span class="mh">0x8b25</span><span class="p">,</span> <span class="mh">0x8b23</span><span class="p">,</span> <span class="mh">0x8b22</span><span class="p">,</span> <span class="mh">0x8b22</span><span class="p">,</span>
	<span class="mh">0x9122</span><span class="p">,</span> <span class="mh">0x8b1a</span><span class="p">,</span> <span class="mh">0x8aa3</span><span class="p">,</span> <span class="mh">0x8aa3</span><span class="p">,</span> <span class="mh">0x8b1c</span><span class="p">,</span> <span class="mh">0x8aa6</span><span class="p">,</span> <span class="mh">0x912d</span><span class="p">,</span> <span class="mh">0x912b</span><span class="p">,</span>
	<span class="mh">0x8aab</span><span class="p">,</span> <span class="mh">0x8b12</span><span class="p">,</span> <span class="mh">0x8aaa</span><span class="p">,</span> <span class="mh">0x8ab2</span><span class="p">,</span> <span class="mh">0x9132</span><span class="p">,</span> <span class="mh">0x8ab4</span><span class="p">,</span> <span class="mh">0x913c</span><span class="p">,</span> <span class="mh">0x8abb</span><span class="p">,</span>
	<span class="mh">0x9142</span><span class="p">,</span> <span class="mh">0x9144</span><span class="p">,</span> <span class="mh">0x9151</span><span class="p">,</span> <span class="mh">0x8ad5</span><span class="p">,</span> <span class="mh">0x8aeb</span><span class="p">,</span> <span class="mh">0x8a79</span><span class="p">,</span> <span class="mh">0x8a5a</span><span class="p">,</span> <span class="mh">0x8a4a</span><span class="p">,</span>
	<span class="mh">0x8b03</span><span class="p">,</span> <span class="mh">0x91c2</span><span class="p">,</span> <span class="mh">0x91bb</span><span class="p">,</span> <span class="mh">0x8a3f</span><span class="p">,</span> <span class="mh">0x8a33</span><span class="p">,</span> <span class="mh">0x91b2</span><span class="p">,</span> <span class="mh">0x9212</span><span class="p">,</span> <span class="mh">0x9213</span><span class="p">,</span>
	<span class="mh">0x8a2c</span><span class="p">,</span> <span class="mh">0x921d</span><span class="p">,</span> <span class="mh">0x8a23</span><span class="p">,</span> <span class="mh">0x921a</span><span class="p">,</span> <span class="mh">0x9222</span><span class="p">,</span> <span class="mh">0x9223</span><span class="p">,</span> <span class="mh">0x922d</span><span class="p">,</span> <span class="mh">0x9231</span><span class="p">,</span>
	<span class="mh">0x9234</span><span class="p">,</span> <span class="mh">0x9242</span><span class="p">,</span> <span class="mh">0x925b</span><span class="p">,</span> <span class="mh">0x92dd</span><span class="p">,</span> <span class="mh">0x92c1</span><span class="p">,</span> <span class="mh">0x92b3</span><span class="p">,</span> <span class="mh">0x92ab</span><span class="p">,</span> <span class="mh">0x92a4</span><span class="p">,</span>
	<span class="mh">0x92a2</span><span class="p">,</span> <span class="mh">0x932b</span><span class="p">,</span> <span class="mh">0x9341</span><span class="p">,</span> <span class="mh">0x93d3</span><span class="p">,</span> <span class="mh">0x93b2</span><span class="p">,</span> <span class="mh">0x93a2</span><span class="p">,</span> <span class="mh">0x943c</span><span class="p">,</span> <span class="mh">0x94b2</span><span class="p">,</span>
	<span class="mh">0x953a</span><span class="p">,</span> <span class="mh">0x9653</span><span class="p">,</span> <span class="mh">0x9782</span><span class="p">,</span> <span class="mh">0x9e21</span><span class="p">,</span> <span class="mh">0x9d23</span><span class="p">,</span> <span class="mh">0x9cd2</span><span class="p">,</span> <span class="mh">0x9c23</span><span class="p">,</span> <span class="mh">0x9baa</span><span class="p">,</span>
	<span class="mh">0x9bde</span><span class="p">,</span> <span class="mh">0x9b33</span><span class="p">,</span> <span class="mh">0x9b22</span><span class="p">,</span> <span class="mh">0x9b1d</span><span class="p">,</span> <span class="mh">0x9ab2</span><span class="p">,</span> <span class="mh">0xa142</span><span class="p">,</span> <span class="mh">0xa1e5</span><span class="p">,</span> <span class="mh">0x9a3b</span><span class="p">,</span>
	<span class="mh">0xa213</span><span class="p">,</span> <span class="mh">0xa1a2</span><span class="p">,</span> <span class="mh">0xa231</span><span class="p">,</span> <span class="mh">0xa2eb</span><span class="p">,</span> <span class="mh">0xa313</span><span class="p">,</span> <span class="mh">0xa334</span><span class="p">,</span> <span class="mh">0xa421</span><span class="p">,</span> <span class="mh">0xa54b</span><span class="p">,</span>
	<span class="mh">0xada4</span><span class="p">,</span> <span class="mh">0xac23</span><span class="p">,</span> <span class="mh">0xab3b</span><span class="p">,</span> <span class="mh">0xaaab</span><span class="p">,</span> <span class="mh">0xaa5c</span><span class="p">,</span> <span class="mh">0xb1a3</span><span class="p">,</span> <span class="mh">0xb2ca</span><span class="p">,</span> <span class="mh">0xb3bd</span><span class="p">,</span>
	<span class="mh">0xbe24</span><span class="p">,</span> <span class="mh">0xbb2b</span><span class="p">,</span> <span class="mh">0xba33</span><span class="p">,</span> <span class="mh">0xc32b</span><span class="p">,</span> <span class="mh">0xcb5a</span><span class="p">,</span> <span class="mh">0xd2a2</span><span class="p">,</span> <span class="mh">0xe31d</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">,</span>
	<span class="mh">0x72ba</span><span class="p">,</span> <span class="mh">0x62c2</span><span class="p">,</span> <span class="mh">0x5c32</span><span class="p">,</span> <span class="mh">0x52db</span><span class="p">,</span> <span class="mh">0x513e</span><span class="p">,</span> <span class="mh">0x4cce</span><span class="p">,</span> <span class="mh">0x43b2</span><span class="p">,</span> <span class="mh">0x4243</span><span class="p">,</span>
	<span class="mh">0x41b4</span><span class="p">,</span> <span class="mh">0x3b12</span><span class="p">,</span> <span class="mh">0x3bc3</span><span class="p">,</span> <span class="mh">0x3df2</span><span class="p">,</span> <span class="mh">0x34bd</span><span class="p">,</span> <span class="mh">0x3334</span><span class="p">,</span> <span class="mh">0x32c2</span><span class="p">,</span> <span class="mh">0x3224</span><span class="p">,</span>
	<span class="mh">0x31aa</span><span class="p">,</span> <span class="mh">0x2a7b</span><span class="p">,</span> <span class="mh">0x2aaa</span><span class="p">,</span> <span class="mh">0x2b23</span><span class="p">,</span> <span class="mh">0x2bba</span><span class="p">,</span> <span class="mh">0x2c42</span><span class="p">,</span> <span class="mh">0x2e23</span><span class="p">,</span> <span class="mh">0x25bb</span><span class="p">,</span>
	<span class="mh">0x242b</span><span class="p">,</span> <span class="mh">0x240f</span><span class="p">,</span> <span class="mh">0x231a</span><span class="p">,</span> <span class="mh">0x22bb</span><span class="p">,</span> <span class="mh">0x2241</span><span class="p">,</span> <span class="mh">0x2223</span><span class="p">,</span> <span class="mh">0x221f</span><span class="p">,</span> <span class="mh">0x1a33</span><span class="p">,</span>
	<span class="mh">0x1a4a</span><span class="p">,</span> <span class="mh">0x1acd</span><span class="p">,</span> <span class="mh">0x2132</span><span class="p">,</span> <span class="mh">0x1b1b</span><span class="p">,</span> <span class="mh">0x1b2c</span><span class="p">,</span> <span class="mh">0x1b62</span><span class="p">,</span> <span class="mh">0x1c12</span><span class="p">,</span> <span class="mh">0x1c32</span><span class="p">,</span>
	<span class="mh">0x1d1b</span><span class="p">,</span> <span class="mh">0x1e71</span><span class="p">,</span> <span class="mh">0x16b1</span><span class="p">,</span> <span class="mh">0x1522</span><span class="p">,</span> <span class="mh">0x1434</span><span class="p">,</span> <span class="mh">0x1412</span><span class="p">,</span> <span class="mh">0x1352</span><span class="p">,</span> <span class="mh">0x1323</span><span class="p">,</span>
	<span class="mh">0x1315</span><span class="p">,</span> <span class="mh">0x12bc</span><span class="p">,</span> <span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x1235</span><span class="p">,</span> <span class="mh">0x1226</span><span class="p">,</span> <span class="mh">0x11a2</span><span class="p">,</span> <span class="mh">0x1216</span><span class="p">,</span> <span class="mh">0x0a2a</span><span class="p">,</span>
	<span class="mh">0x11bc</span><span class="p">,</span> <span class="mh">0x11d1</span><span class="p">,</span> <span class="mh">0x1163</span><span class="p">,</span> <span class="mh">0x0ac2</span><span class="p">,</span> <span class="mh">0x0ab2</span><span class="p">,</span> <span class="mh">0x0aab</span><span class="p">,</span> <span class="mh">0x0b1b</span><span class="p">,</span> <span class="mh">0x0b23</span><span class="p">,</span>
	<span class="mh">0x0b33</span><span class="p">,</span> <span class="mh">0x0c0f</span><span class="p">,</span> <span class="mh">0x0bb3</span><span class="p">,</span> <span class="mh">0x0c1b</span><span class="p">,</span> <span class="mh">0x0c3e</span><span class="p">,</span> <span class="mh">0x0cb1</span><span class="p">,</span> <span class="mh">0x0d4c</span><span class="p">,</span> <span class="mh">0x0ec1</span><span class="p">,</span>
	<span class="mh">0x079a</span><span class="p">,</span> <span class="mh">0x0614</span><span class="p">,</span> <span class="mh">0x0521</span><span class="p">,</span> <span class="mh">0x047c</span><span class="p">,</span> <span class="mh">0x0422</span><span class="p">,</span> <span class="mh">0x03b1</span><span class="p">,</span> <span class="mh">0x03e3</span><span class="p">,</span> <span class="mh">0x0333</span><span class="p">,</span>
	<span class="mh">0x0322</span><span class="p">,</span> <span class="mh">0x031c</span><span class="p">,</span> <span class="mh">0x02aa</span><span class="p">,</span> <span class="mh">0x02ba</span><span class="p">,</span> <span class="mh">0x02f2</span><span class="p">,</span> <span class="mh">0x0242</span><span class="p">,</span> <span class="mh">0x0232</span><span class="p">,</span> <span class="mh">0x0227</span><span class="p">,</span>
	<span class="mh">0x0222</span><span class="p">,</span> <span class="mh">0x021b</span><span class="p">,</span> <span class="mh">0x01ad</span><span class="p">,</span> <span class="mh">0x0212</span><span class="p">,</span> <span class="mh">0x01b2</span><span class="p">,</span> <span class="mh">0x01bb</span><span class="p">,</span> <span class="mh">0x01cb</span><span class="p">,</span> <span class="mh">0x01f6</span><span class="p">,</span>
	<span class="mh">0x0152</span><span class="p">,</span> <span class="mh">0x013a</span><span class="p">,</span> <span class="mh">0x0133</span><span class="p">,</span> <span class="mh">0x0131</span><span class="p">,</span> <span class="mh">0x012c</span><span class="p">,</span> <span class="mh">0x0123</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">,</span> <span class="mh">0x00a2</span><span class="p">,</span>
	<span class="mh">0x011b</span><span class="p">,</span> <span class="mh">0x011e</span><span class="p">,</span> <span class="mh">0x0114</span><span class="p">,</span> <span class="mh">0x00b1</span><span class="p">,</span> <span class="mh">0x00aa</span><span class="p">,</span> <span class="mh">0x00b3</span><span class="p">,</span> <span class="mh">0x00bd</span><span class="p">,</span> <span class="mh">0x00ba</span><span class="p">,</span>
	<span class="mh">0x00c5</span><span class="p">,</span> <span class="mh">0x00d3</span><span class="p">,</span> <span class="mh">0x00f3</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0042</span><span class="p">,</span> <span class="mh">0x003b</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span>
	<span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x002a</span><span class="p">,</span> <span class="mh">0x002c</span><span class="p">,</span> <span class="mh">0x0025</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x001a</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span>
	<span class="mh">0x001b</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">,</span> <span class="mh">0x001d</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span>
	<span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__const__</span> <span class="n">__u16</span> <span class="n">ger_coeff</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x431f</span><span class="p">,</span> <span class="cm">/* 5. dB */</span>
	<span class="mh">0x331f</span><span class="p">,</span> <span class="cm">/* 5.5 dB */</span>
	<span class="mh">0x40dd</span><span class="p">,</span> <span class="cm">/* 6. dB */</span>
	<span class="mh">0x11dd</span><span class="p">,</span> <span class="cm">/* 6.5 dB */</span>
	<span class="mh">0x440f</span><span class="p">,</span> <span class="cm">/* 7. dB */</span>
	<span class="mh">0x411f</span><span class="p">,</span> <span class="cm">/* 7.5 dB */</span>
	<span class="mh">0x311f</span><span class="p">,</span> <span class="cm">/* 8. dB */</span>
	<span class="mh">0x5520</span><span class="p">,</span> <span class="cm">/* 8.5 dB */</span>
	<span class="mh">0x10dd</span><span class="p">,</span> <span class="cm">/* 9. dB */</span>
	<span class="mh">0x4211</span><span class="p">,</span> <span class="cm">/* 9.5 dB */</span>
	<span class="mh">0x410f</span><span class="p">,</span> <span class="cm">/* 10. dB */</span>
	<span class="mh">0x111f</span><span class="p">,</span> <span class="cm">/* 10.5 dB */</span>
	<span class="mh">0x600b</span><span class="p">,</span> <span class="cm">/* 11. dB */</span>
	<span class="mh">0x00dd</span><span class="p">,</span> <span class="cm">/* 11.5 dB */</span>
	<span class="mh">0x4210</span><span class="p">,</span> <span class="cm">/* 12. dB */</span>
	<span class="mh">0x110f</span><span class="p">,</span> <span class="cm">/* 13. dB */</span>
	<span class="mh">0x7200</span><span class="p">,</span> <span class="cm">/* 14. dB */</span>
	<span class="mh">0x2110</span><span class="p">,</span> <span class="cm">/* 15. dB */</span>
	<span class="mh">0x2200</span><span class="p">,</span> <span class="cm">/* 15.9 dB */</span>
	<span class="mh">0x000b</span><span class="p">,</span> <span class="cm">/* 16.9 dB */</span>
	<span class="mh">0x000f</span>  <span class="cm">/* 18. dB */</span>
<span class="p">};</span>

<span class="cm">/* Update amd7930_map settings and program them into the hardware.</span>
<span class="cm"> * The amd-&gt;lock is held and local interrupts are disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__amd7930_update_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amd7930_map</span> <span class="o">*</span><span class="n">map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">gx</span> <span class="o">=</span> <span class="n">gx_coeff</span><span class="p">[</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">rgain</span><span class="p">];</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">stgr</span> <span class="o">=</span> <span class="n">gx_coeff</span><span class="p">[</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">mgain</span><span class="p">];</span>
	<span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">pgain</span> <span class="o">*</span> <span class="p">(</span><span class="mi">256</span> <span class="o">+</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ger_coeff</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">ger</span> <span class="o">=</span> <span class="n">ger_coeff</span><span class="p">[</span><span class="n">level</span> <span class="o">-</span> <span class="mi">256</span><span class="p">];</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">=</span> <span class="n">gx_coeff</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">ger</span> <span class="o">=</span> <span class="n">ger_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">=</span> <span class="n">gx_coeff</span><span class="p">[</span><span class="n">level</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">__amd7930_write_map</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_amd7930_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">elapsed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ir</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_IR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span> <span class="o">&amp;</span> <span class="n">AMR_IR_BBUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AMD7930_FLAG_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">byte</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_cur</span><span class="o">++</span><span class="p">);</span>
				<span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_left</span><span class="o">--</span><span class="p">;</span>
				<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_BBTB</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">elapsed</span> <span class="o">|=</span> <span class="n">AMD7930_FLAG_PLAYBACK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_BBTB</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AMD7930_FLAG_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">byte</span> <span class="o">=</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_BBRB</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_cur</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
				<span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_left</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_left</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">elapsed</span> <span class="o">|=</span> <span class="n">AMD7930_FLAG_CAPTURE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&amp;</span> <span class="n">AMD7930_FLAG_PLAYBACK</span><span class="p">)</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>

			<span class="cm">/* Enable B channel interrupts.  */</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MUX_MCR4</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AM_MUX_MCR4_ENABLE_INTS</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flag</span><span class="p">;</span>

			<span class="cm">/* Disable B channel interrupts.  */</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MUX_MCR4</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
			<span class="n">sbus_writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_amd7930_trigger</span><span class="p">(</span><span class="n">amd</span><span class="p">,</span> <span class="n">AMD7930_FLAG_PLAYBACK</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_amd7930_trigger</span><span class="p">(</span><span class="n">amd</span><span class="p">,</span> <span class="n">AMD7930_FLAG_CAPTURE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_mmr1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AMD7930_FLAG_PLAYBACK</span><span class="p">;</span>

	<span class="cm">/* Setup the pseudo-dma transfer pointers.  */</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_orig</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_cur</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_left</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Put the chip into the correct encoding format.  */</span>
	<span class="n">new_mmr1</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span><span class="p">)</span>
		<span class="n">new_mmr1</span> <span class="o">|=</span> <span class="n">AM_MAP_MMR1_ALAW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_mmr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AM_MAP_MMR1_ALAW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mmr1</span> <span class="o">!=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span> <span class="o">=</span> <span class="n">new_mmr1</span><span class="p">;</span>
		<span class="n">__amd7930_update_map</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_mmr1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">AMD7930_FLAG_CAPTURE</span><span class="p">;</span>

	<span class="cm">/* Setup the pseudo-dma transfer pointers.  */</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_orig</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_cur</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_left</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Put the chip into the correct encoding format.  */</span>
	<span class="n">new_mmr1</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span><span class="p">)</span>
		<span class="n">new_mmr1</span> <span class="o">|=</span> <span class="n">AM_MAP_MMR1_ALAW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_mmr1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AM_MAP_MMR1_ALAW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_mmr1</span> <span class="o">!=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span> <span class="o">=</span> <span class="n">new_mmr1</span><span class="p">;</span>
		<span class="n">__amd7930_update_map</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_amd7930_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AMD7930_FLAG_PLAYBACK</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_cur</span> <span class="o">-</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">p_orig</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_amd7930_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AMD7930_FLAG_CAPTURE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_cur</span> <span class="o">-</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">c_orig</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Playback and capture have identical properties.  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_amd7930_pcm_hw</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				   <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				   <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				   <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				   <span class="n">SNDRV_PCM_INFO_HALF_DUPLEX</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span>		<span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>		<span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>		<span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span>	<span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_amd7930_pcm_hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_amd7930_pcm_hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_amd7930_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">snd_amd7930_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span>	<span class="n">snd_amd7930_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span>	<span class="n">snd_amd7930_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span>	<span class="n">snd_amd7930_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span>	<span class="n">snd_amd7930_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span>	<span class="n">snd_amd7930_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span>	<span class="n">snd_amd7930_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_amd7930_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">snd_amd7930_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span>	<span class="n">snd_amd7930_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span>	<span class="n">snd_amd7930_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span>	<span class="n">snd_amd7930_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span>	<span class="n">snd_amd7930_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span>	<span class="n">snd_amd7930_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span>	<span class="n">snd_amd7930_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_amd7930_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
			       <span class="cm">/* ID */</span>             <span class="s">&quot;sun_amd7930&quot;</span><span class="p">,</span>
			       <span class="cm">/* device */</span>         <span class="mi">0</span><span class="p">,</span>
			       <span class="cm">/* playback count */</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/* capture count */</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_amd7930_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_amd7930_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">amd</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_CONTINUOUS</span><span class="p">,</span>
					      <span class="n">snd_dma_continuous_data</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define VOLUME_MONITOR	0</span>
<span class="cp">#define VOLUME_CAPTURE	1</span>
<span class="cp">#define VOLUME_PLAYBACK	2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_info_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctl</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">swval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VOLUME_MONITOR</span>:
		<span class="n">swval</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">mgain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VOLUME_CAPTURE</span>:
		<span class="n">swval</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">rgain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VOLUME_PLAYBACK</span>:
	<span class="nl">default:</span>
		<span class="n">swval</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">pgain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">swval</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_put_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctl</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">swval</span><span class="p">,</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VOLUME_MONITOR</span>:
		<span class="n">swval</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">mgain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VOLUME_CAPTURE</span>:
		<span class="n">swval</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">rgain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VOLUME_PLAYBACK</span>:
	<span class="nl">default:</span>
		<span class="n">swval</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">pgain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">swval</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">swval</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">__amd7930_update_map</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">amd7930_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>		<span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span>	<span class="s">&quot;Monitor Volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>		<span class="o">=</span>	<span class="n">snd_amd7930_info_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>		<span class="o">=</span>	<span class="n">snd_amd7930_get_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>		<span class="o">=</span>	<span class="n">snd_amd7930_put_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span>	<span class="o">=</span>	<span class="n">VOLUME_MONITOR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>		<span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span>	<span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>		<span class="o">=</span>	<span class="n">snd_amd7930_info_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>		<span class="o">=</span>	<span class="n">snd_amd7930_get_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>		<span class="o">=</span>	<span class="n">snd_amd7930_put_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span>	<span class="o">=</span>	<span class="n">VOLUME_CAPTURE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span>		<span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span>	<span class="s">&quot;Playback Volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span>		<span class="o">=</span>	<span class="n">snd_amd7930_info_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>		<span class="o">=</span>	<span class="n">snd_amd7930_get_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span>		<span class="o">=</span>	<span class="n">snd_amd7930_put_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span>	<span class="o">=</span>	<span class="n">VOLUME_PLAYBACK</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_amd7930_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">amd</span> <span class="o">||</span> <span class="o">!</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">amd7930_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				       <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd7930_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">amd</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>

	<span class="n">amd7930_idle</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">amd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span>
			   <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_amd7930_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_amd7930_free</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">snd_amd7930_dev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev_free</span>	<span class="o">=</span>	<span class="n">snd_amd7930_dev_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_amd7930_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">**</span><span class="n">ramd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ramd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">amd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">amd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s">&quot;amd7930&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;amd7930-%d: Unable to map chip registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">amd7930_idle</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_amd7930_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;amd7930&quot;</span><span class="p">,</span> <span class="n">amd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;amd7930-%d: Unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">dev</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_amd7930_free</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">amd7930_enable_ints</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">rgain</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">pgain</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">mgain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">));</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">AM_MAP_MMR1_GX</span> <span class="o">|</span> <span class="n">AM_MAP_MMR1_GER</span> <span class="o">|</span>
			 <span class="n">AM_MAP_MMR1_GR</span> <span class="o">|</span> <span class="n">AM_MAP_MMR1_STG</span><span class="p">);</span>
	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">.</span><span class="n">mmr2</span> <span class="o">=</span> <span class="p">(</span><span class="n">AM_MAP_MMR2_LS</span> <span class="o">|</span> <span class="n">AM_MAP_MMR2_AINB</span><span class="p">);</span>

	<span class="n">__amd7930_update_map</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>

	<span class="cm">/* Always MUX audio (Ba) to channel Bb. */</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AMR_MUX_MCR1</span><span class="p">,</span> <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_CR</span><span class="p">);</span>
	<span class="n">sbus_writeb</span><span class="p">(</span><span class="n">AM_MUX_CHANNEL_Ba</span> <span class="o">|</span> <span class="p">(</span><span class="n">AM_MUX_CHANNEL_Bb</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
		    <span class="n">amd</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">AMD7930_DR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span>
				  <span class="n">amd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_amd7930_dev_ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_amd7930_free</span><span class="p">(</span><span class="n">amd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ramd</span> <span class="o">=</span> <span class="n">amd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">amd7930_sbus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">amd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_num</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev_num</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_num</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev_num</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev_num</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;AMD7930&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Sun AMD7930&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%02lx:0x%08Lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffL</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		<span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_amd7930_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span>
				      <span class="n">irq</span><span class="p">,</span> <span class="n">dev_num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_amd7930_pcm</span><span class="p">(</span><span class="n">amd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_amd7930_mixer</span><span class="p">(</span><span class="n">amd</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">amd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">amd7930_list</span><span class="p">;</span>
	<span class="n">amd7930_list</span> <span class="o">=</span> <span class="n">amd</span><span class="p">;</span>

	<span class="n">dev_num</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">amd7930_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;audio&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">amd7930_sbus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">amd7930_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">amd7930_sbus_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amd7930_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd7930_sbus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amd7930_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">amd7930_list</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_amd7930</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">amd7930_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amd7930_sbus_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amd7930_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">amd7930_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
