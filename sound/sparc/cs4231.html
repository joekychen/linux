<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › sparc › cs4231.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cs4231.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for CS4231 sound chips found on Sparcs.</span>
<span class="cm"> * Copyright (C) 2002, 2008 David S. Miller &lt;davem@davemloft.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based entirely upon drivers/sbus/audio/cs4231.c which is:</span>
<span class="cm"> * Copyright (C) 1996, 1997, 1998 Derrick J Brashear (shadow@andrew.cmu.edu)</span>
<span class="cm"> * and also sound/isa/cs423x/cs4231_lib.c which is:</span>
<span class="cm"> * Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/timer.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="cp">#define SBUS_SUPPORT</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_PCI) &amp;&amp; defined(CONFIG_SPARC64)</span>
<span class="cp">#define EBUS_SUPPORT</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/ebus_dma.h&gt;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Sun CS4231 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Sun CS4231 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Sun CS4231 soundcard.&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela, Derrick J. Brashear and David S. Miller&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun CS4231&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Sun,CS4231}}&quot;</span><span class="p">);</span>

<span class="cp">#ifdef SBUS_SUPPORT</span>
<span class="k">struct</span> <span class="n">sbus_dma_info</span> <span class="p">{</span>
       <span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>	<span class="cm">/* DMA access lock */</span>
       <span class="kt">int</span>		<span class="n">dir</span><span class="p">;</span>
       <span class="kt">void</span> <span class="n">__iomem</span>	<span class="o">*</span><span class="n">regs</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">snd_cs4231</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="p">{</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">prepare</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">dir</span><span class="p">);</span>
	<span class="kt">void</span>		<span class="p">(</span><span class="o">*</span><span class="n">enable</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">);</span>
	<span class="kt">int</span>		<span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span>
				   <span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="p">(</span><span class="o">*</span><span class="n">address</span><span class="p">)(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">);</span>
<span class="cp">#ifdef EBUS_SUPPORT</span>
	<span class="k">struct</span>		<span class="n">ebus_dma_info</span>	<span class="n">ebus_info</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SBUS_SUPPORT</span>
	<span class="k">struct</span>		<span class="n">sbus_dma_info</span>	<span class="n">sbus_info</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>		<span class="n">lock</span><span class="p">;</span>	<span class="cm">/* registers access lock */</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cs4231_dma_control</span>	<span class="n">p_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cs4231_dma_control</span>	<span class="n">c_dma</span><span class="p">;</span>

	<span class="n">u32</span>			<span class="n">flags</span><span class="p">;</span>
<span class="cp">#define CS4231_FLAG_EBUS	0x00000001</span>
<span class="cp">#define CS4231_FLAG_PLAYBACK	0x00000002</span>
<span class="cp">#define CS4231_FLAG_CAPTURE	0x00000004</span>

	<span class="k">struct</span> <span class="n">snd_card</span>		<span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span>		<span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span>	<span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">p_periods_sent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span>	<span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">c_periods_sent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_timer</span>	<span class="o">*</span><span class="n">timer</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mode</span><span class="p">;</span>
<span class="cp">#define CS4231_MODE_NONE	0x0000</span>
<span class="cp">#define CS4231_MODE_PLAY	0x0001</span>
<span class="cp">#define CS4231_MODE_RECORD	0x0002</span>
<span class="cp">#define CS4231_MODE_TIMER	0x0004</span>
<span class="cp">#define CS4231_MODE_OPEN	(CS4231_MODE_PLAY | CS4231_MODE_RECORD | \</span>
<span class="cp">				 CS4231_MODE_TIMER)</span>

	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">image</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>	<span class="cm">/* registers image */</span>
	<span class="kt">int</span>			<span class="n">mce_bit</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">calibrate_mute</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">mce_mutex</span><span class="p">;</span>	<span class="cm">/* mutex for mce register */</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">open_mutex</span><span class="p">;</span>	<span class="cm">/* mutex for ALSA open/close */</span>

	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">op</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">regs_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Eventually we can use sound/isa/cs423x/cs4231_lib.c directly, but for</span>
<span class="cm"> * now....  -DaveM</span>
<span class="cm"> */</span>

<span class="cm">/* IO ports */</span>
<span class="cp">#include &lt;sound/cs4231-regs.h&gt;</span>

<span class="cm">/* XXX offsets are different than PC ISA chips... */</span>
<span class="cp">#define CS4231U(chip, x)	((chip)-&gt;port + ((c_d_c_CS4231##x) &lt;&lt; 2))</span>

<span class="cm">/* SBUS DMA register defines.  */</span>

<span class="cp">#define APCCSR	0x10UL	</span><span class="cm">/* APC DMA CSR */</span><span class="cp"></span>
<span class="cp">#define APCCVA	0x20UL	</span><span class="cm">/* APC Capture DMA Address */</span><span class="cp"></span>
<span class="cp">#define APCCC	0x24UL	</span><span class="cm">/* APC Capture Count */</span><span class="cp"></span>
<span class="cp">#define APCCNVA	0x28UL	</span><span class="cm">/* APC Capture DMA Next Address */</span><span class="cp"></span>
<span class="cp">#define APCCNC	0x2cUL	</span><span class="cm">/* APC Capture Next Count */</span><span class="cp"></span>
<span class="cp">#define APCPVA	0x30UL	</span><span class="cm">/* APC Play DMA Address */</span><span class="cp"></span>
<span class="cp">#define APCPC	0x34UL	</span><span class="cm">/* APC Play Count */</span><span class="cp"></span>
<span class="cp">#define APCPNVA	0x38UL	</span><span class="cm">/* APC Play DMA Next Address */</span><span class="cp"></span>
<span class="cp">#define APCPNC	0x3cUL	</span><span class="cm">/* APC Play Next Count */</span><span class="cp"></span>

<span class="cm">/* Defines for SBUS DMA-routines */</span>

<span class="cp">#define APCVA  0x0UL	</span><span class="cm">/* APC DMA Address */</span><span class="cp"></span>
<span class="cp">#define APCC   0x4UL	</span><span class="cm">/* APC Count */</span><span class="cp"></span>
<span class="cp">#define APCNVA 0x8UL	</span><span class="cm">/* APC DMA Next Address */</span><span class="cp"></span>
<span class="cp">#define APCNC  0xcUL	</span><span class="cm">/* APC Next Count */</span><span class="cp"></span>
<span class="cp">#define APC_PLAY 0x30UL	</span><span class="cm">/* Play registers start at 0x30 */</span><span class="cp"></span>
<span class="cp">#define APC_RECORD 0x20UL </span><span class="cm">/* Record registers start at 0x20 */</span><span class="cp"></span>

<span class="cm">/* APCCSR bits */</span>

<span class="cp">#define APC_INT_PENDING 0x800000 </span><span class="cm">/* Interrupt Pending */</span><span class="cp"></span>
<span class="cp">#define APC_PLAY_INT    0x400000 </span><span class="cm">/* Playback interrupt */</span><span class="cp"></span>
<span class="cp">#define APC_CAPT_INT    0x200000 </span><span class="cm">/* Capture interrupt */</span><span class="cp"></span>
<span class="cp">#define APC_GENL_INT    0x100000 </span><span class="cm">/* General interrupt */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_ENA    0x80000  </span><span class="cm">/* General ext int. enable */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_PLAY   0x40000  </span><span class="cm">/* Playback ext intr */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_CAPT   0x20000  </span><span class="cm">/* Capture ext intr */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_GENL   0x10000  </span><span class="cm">/* Error ext intr */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_EMPT   0x8000   </span><span class="cm">/* Pipe empty interrupt (0 write to pva) */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_PEMP   0x4000   </span><span class="cm">/* Play pipe empty (pva and pnva not set) */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_PNVA   0x2000   </span><span class="cm">/* Playback NVA dirty */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_PENA   0x1000   </span><span class="cm">/* play pipe empty Int enable */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_COVF   0x800    </span><span class="cm">/* Cap data dropped on floor */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_CNVA   0x400    </span><span class="cm">/* Capture NVA dirty */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_CEMP   0x200    </span><span class="cm">/* Capture pipe empty (cva and cnva not set) */</span><span class="cp"></span>
<span class="cp">#define APC_XINT_CENA   0x100    </span><span class="cm">/* Cap. pipe empty int enable */</span><span class="cp"></span>
<span class="cp">#define APC_PPAUSE      0x80     </span><span class="cm">/* Pause the play DMA */</span><span class="cp"></span>
<span class="cp">#define APC_CPAUSE      0x40     </span><span class="cm">/* Pause the capture DMA */</span><span class="cp"></span>
<span class="cp">#define APC_CDC_RESET   0x20     </span><span class="cm">/* CODEC RESET */</span><span class="cp"></span>
<span class="cp">#define APC_PDMA_READY  0x08     </span><span class="cm">/* Play DMA Go */</span><span class="cp"></span>
<span class="cp">#define APC_CDMA_READY  0x04     </span><span class="cm">/* Capture DMA Go */</span><span class="cp"></span>
<span class="cp">#define APC_CHIP_RESET  0x01     </span><span class="cm">/* Reset the chip */</span><span class="cp"></span>

<span class="cm">/* EBUS DMA register offsets  */</span>

<span class="cp">#define EBDMA_CSR	0x00UL	</span><span class="cm">/* Control/Status */</span><span class="cp"></span>
<span class="cp">#define EBDMA_ADDR	0x04UL	</span><span class="cm">/* DMA Address */</span><span class="cp"></span>
<span class="cp">#define EBDMA_COUNT	0x08UL	</span><span class="cm">/* DMA Count */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> *  Some variables</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">freq_bits</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 5510 */</span>	<span class="mh">0x00</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 6620 */</span>	<span class="mh">0x0E</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 8000 */</span>	<span class="mh">0x00</span> <span class="o">|</span> <span class="n">CS4231_XTAL1</span><span class="p">,</span>
	<span class="cm">/* 9600 */</span>	<span class="mh">0x0E</span> <span class="o">|</span> <span class="n">CS4231_XTAL1</span><span class="p">,</span>
	<span class="cm">/* 11025 */</span>	<span class="mh">0x02</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 16000 */</span>	<span class="mh">0x02</span> <span class="o">|</span> <span class="n">CS4231_XTAL1</span><span class="p">,</span>
	<span class="cm">/* 18900 */</span>	<span class="mh">0x04</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 22050 */</span>	<span class="mh">0x06</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 27042 */</span>	<span class="mh">0x04</span> <span class="o">|</span> <span class="n">CS4231_XTAL1</span><span class="p">,</span>
	<span class="cm">/* 32000 */</span>	<span class="mh">0x06</span> <span class="o">|</span> <span class="n">CS4231_XTAL1</span><span class="p">,</span>
	<span class="cm">/* 33075 */</span>	<span class="mh">0x0C</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 37800 */</span>	<span class="mh">0x08</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 44100 */</span>	<span class="mh">0x0A</span> <span class="o">|</span> <span class="n">CS4231_XTAL2</span><span class="p">,</span>
	<span class="cm">/* 48000 */</span>	<span class="mh">0x0C</span> <span class="o">|</span> <span class="n">CS4231_XTAL1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rates</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">5510</span><span class="p">,</span> <span class="mi">6620</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">11025</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">18900</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span>
	<span class="mi">27042</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">33075</span><span class="p">,</span> <span class="mi">37800</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_rates</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span>	<span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_xrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">hw_constraints_rates</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">snd_cs4231_original_image</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 00/00 - lic */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 01/01 - ric */</span>
	<span class="mh">0x9f</span><span class="p">,</span>			<span class="cm">/* 02/02 - la1ic */</span>
	<span class="mh">0x9f</span><span class="p">,</span>			<span class="cm">/* 03/03 - ra1ic */</span>
	<span class="mh">0x9f</span><span class="p">,</span>			<span class="cm">/* 04/04 - la2ic */</span>
	<span class="mh">0x9f</span><span class="p">,</span>			<span class="cm">/* 05/05 - ra2ic */</span>
	<span class="mh">0xbf</span><span class="p">,</span>			<span class="cm">/* 06/06 - loc */</span>
	<span class="mh">0xbf</span><span class="p">,</span>			<span class="cm">/* 07/07 - roc */</span>
	<span class="mh">0x20</span><span class="p">,</span>			<span class="cm">/* 08/08 - pdfr */</span>
	<span class="n">CS4231_AUTOCALIB</span><span class="p">,</span>	<span class="cm">/* 09/09 - ic */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 0a/10 - pc */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 0b/11 - ti */</span>
	<span class="n">CS4231_MODE2</span><span class="p">,</span>		<span class="cm">/* 0c/12 - mi */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 0d/13 - lbc */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 0e/14 - pbru */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 0f/15 - pbrl */</span>
	<span class="mh">0x80</span><span class="p">,</span>			<span class="cm">/* 10/16 - afei */</span>
	<span class="mh">0x01</span><span class="p">,</span>			<span class="cm">/* 11/17 - afeii */</span>
	<span class="mh">0x9f</span><span class="p">,</span>			<span class="cm">/* 12/18 - llic */</span>
	<span class="mh">0x9f</span><span class="p">,</span>			<span class="cm">/* 13/19 - rlic */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 14/20 - tlb */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 15/21 - thb */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 16/22 - la3mic/reserved */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 17/23 - ra3mic/reserved */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 18/24 - afs */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 19/25 - lamoc/version */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 1a/26 - mioc */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 1b/27 - ramoc/reserved */</span>
	<span class="mh">0x20</span><span class="p">,</span>			<span class="cm">/* 1c/28 - cdfr */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 1d/29 - res4 */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 1e/30 - cbru */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* 1f/31 - cbrl */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">__cs4231_readb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CS4231_FLAG_EBUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sbus_readb</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__cs4231_writeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">cp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CS4231_FLAG_EBUS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sbus_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Basic I/O functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_dout</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_cs4231_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;out: auto calibration time out - reg = 0x%x, &quot;</span>
			    <span class="s">&quot;value = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_bit</span> <span class="o">|</span> <span class="n">reg</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG</span><span class="p">));</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_cs4231_outm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">calibrate_mute</span><span class="p">)</span>
		<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_cs4231_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_cs4231_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;in: auto calibration time out - reg = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">reg</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_bit</span> <span class="o">|</span> <span class="n">reg</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  CS4231 detection / MCE routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_busy_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="cm">/* looks like this sequence is proper for CS4231A chip (GUS MAX) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span>
		<span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>

	<span class="cm">/* end of cleanup sequence */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_mce_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;mce_up - auto calibration time out (0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_bit</span> <span class="o">|=</span> <span class="n">CS4231_MCE</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;mce_up [%p]: serious init problem - &quot;</span>
			    <span class="s">&quot;codec still busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;</span> <span class="n">CS4231_MCE</span><span class="p">))</span>
		<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_bit</span> <span class="o">|</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">),</span>
				<span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_mce_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">snd_cs4231_busy_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;mce_down [%p] - auto calibration time out (0)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_bit</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS4231_MCE</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_bit</span> <span class="o">|</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">),</span>
			<span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;mce_down [%p]: serious init problem &quot;</span>
			    <span class="s">&quot;- codec still busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">CS4231_MCE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for auto-calibration (AC) process to finish, i.e. ACI to go low.</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_cs4231_in</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_TEST_INIT</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="n">CS4231_CALIB_IN_PROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;mce_down - auto calibration time out (2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_advance_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">periods_sent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">period_size</span> <span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">periods_sent</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">period_size</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span>
				      <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">period_size</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">periods_sent</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="n">periods_sent</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">periods</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs4231_dma_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">what</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">&amp;</span> <span class="n">CS4231_PLAYBACK_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">snd_cs4231_advance_dma</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_periods_sent</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">what</span> <span class="o">&amp;</span> <span class="n">CS4231_RECORD_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">prepare</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">snd_cs4231_advance_dma</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_periods_sent</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">what</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">CS4231_PLAYBACK_ENABLE</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">what</span> <span class="o">|=</span> <span class="n">CS4231_RECORD_ENABLE</span><span class="p">;</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cs4231_dma_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">what</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cs4231_dma_trigger</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">what</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IFACE_CTRL</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  CODEC I/O</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_cs4231_get_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">freq_bits</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">freq_bits</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_cs4231_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rformat</span><span class="p">;</span>

	<span class="n">rformat</span> <span class="o">=</span> <span class="n">CS4231_LINEAR_8</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_MU_LAW</span>:
		<span class="n">rformat</span> <span class="o">=</span> <span class="n">CS4231_ULAW_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span>:
		<span class="n">rformat</span> <span class="o">=</span> <span class="n">CS4231_ALAW_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">rformat</span> <span class="o">=</span> <span class="n">CS4231_LINEAR_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:
		<span class="n">rformat</span> <span class="o">=</span> <span class="n">CS4231_LINEAR_16_BIG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_IMA_ADPCM</span>:
		<span class="n">rformat</span> <span class="o">=</span> <span class="n">CS4231_ADPCM_16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rformat</span> <span class="o">|=</span> <span class="n">CS4231_STEREO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rformat</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">calibrate_mute</span> <span class="o">==</span> <span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_LEFT_INPUT</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LEFT_INPUT</span><span class="p">]);</span>
		<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_RIGHT_INPUT</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_RIGHT_INPUT</span><span class="p">]);</span>
		<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_LOOPBACK</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LOOPBACK</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_AUX1_LEFT_INPUT</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_AUX1_LEFT_INPUT</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_AUX1_RIGHT_INPUT</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_AUX1_RIGHT_INPUT</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_AUX2_LEFT_INPUT</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_AUX2_LEFT_INPUT</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_AUX2_RIGHT_INPUT</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_AUX2_RIGHT_INPUT</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_LEFT_OUTPUT</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LEFT_OUTPUT</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_RIGHT_OUTPUT</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_RIGHT_OUTPUT</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_LEFT_LINE_IN</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LEFT_LINE_IN</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_RIGHT_LINE_IN</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_RIGHT_LINE_IN</span><span class="p">]);</span>
	<span class="n">snd_cs4231_dout</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MONO_CTRL</span><span class="p">,</span>
			<span class="n">mute</span> <span class="o">?</span> <span class="mh">0xc0</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_MONO_CTRL</span><span class="p">]);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">calibrate_mute</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_playback_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pdfr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_mutex</span><span class="p">);</span>
	<span class="n">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_PLAYBK_FORMAT</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_RECORD_ENABLE</span><span class="p">)</span> <span class="o">?</span>
		       <span class="p">(</span><span class="n">pdfr</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_REC_FORMAT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">:</span>
		       <span class="n">pdfr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_capture_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cdfr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_mutex</span><span class="p">);</span>
	<span class="n">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_PLAYBACK_ENABLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_PLAYBK_FORMAT</span><span class="p">,</span>
			       <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_PLAYBK_FORMAT</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">cdfr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_REC_FORMAT</span><span class="p">,</span> <span class="n">cdfr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Timer interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">snd_cs4231_timer_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_PLAYBK_FORMAT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">9969</span> <span class="o">:</span> <span class="mi">9920</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ticks</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">sticks</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_TIMER_ENABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">ticks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_TIMER_HIGH</span><span class="p">]</span> <span class="o">||</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">ticks</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_TIMER_LOW</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_TIMER_HIGH</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_TIMER_HIGH</span><span class="p">]</span> <span class="o">=</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="p">(</span><span class="n">ticks</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_TIMER_LOW</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_TIMER_LOW</span><span class="p">]</span> <span class="o">=</span>
			       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">ticks</span><span class="p">);</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_ALT_FEATURE_1</span><span class="p">,</span>
			       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]</span> <span class="o">|</span>
					<span class="n">CS4231_TIMER_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_timer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS4231_TIMER_ENABLE</span><span class="p">;</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_ALT_FEATURE_1</span><span class="p">,</span>
		       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_DEBUG_MCE</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;init: (1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CS4231_PLAYBACK_ENABLE</span> <span class="o">|</span>
					    <span class="n">CS4231_PLAYBACK_PIO</span> <span class="o">|</span>
					    <span class="n">CS4231_RECORD_ENABLE</span> <span class="o">|</span>
					    <span class="n">CS4231_RECORD_PIO</span> <span class="o">|</span>
					    <span class="n">CS4231_CALIB_MODE</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS4231_AUTOCALIB</span><span class="p">;</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IFACE_CTRL</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_DEBUG_MCE</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;init: (2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_ALT_FEATURE_1</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_DEBUG_MCE</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;init: (3) - afei = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_ALT_FEATURE_2</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_2</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_PLAYBK_FORMAT</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_PLAYBK_FORMAT</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_DEBUG_MCE</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;init: (4)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_REC_FORMAT</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_REC_FORMAT</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_DEBUG_MCE</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;init: (5)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">CS4231_MODE_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ok. now enable and ack CODEC IRQ */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="n">CS4231_PLAYBACK_IRQ</span> <span class="o">|</span>
		       <span class="n">CS4231_RECORD_IRQ</span> <span class="o">|</span>
		       <span class="n">CS4231_TIMER_IRQ</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>	<span class="cm">/* clear IRQ */</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>	<span class="cm">/* clear IRQ */</span>

	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="n">CS4231_PLAYBACK_IRQ</span> <span class="o">|</span>
		       <span class="n">CS4231_RECORD_IRQ</span> <span class="o">|</span>
		       <span class="n">CS4231_TIMER_IRQ</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">CS4231_MODE_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* disable IRQ */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>	<span class="cm">/* clear IRQ */</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>	<span class="cm">/* clear IRQ */</span>

	<span class="cm">/* now disable record &amp; playback */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">CS4231_PLAYBACK_ENABLE</span> <span class="o">|</span> <span class="n">CS4231_PLAYBACK_PIO</span> <span class="o">|</span>
	     <span class="n">CS4231_RECORD_ENABLE</span> <span class="o">|</span> <span class="n">CS4231_RECORD_PIO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">CS4231_PLAYBACK_ENABLE</span> <span class="o">|</span> <span class="n">CS4231_PLAYBACK_PIO</span> <span class="o">|</span>
			  <span class="n">CS4231_RECORD_ENABLE</span> <span class="o">|</span> <span class="n">CS4231_RECORD_PIO</span><span class="p">);</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IFACE_CTRL</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* clear IRQ again */</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>	<span class="cm">/* clear IRQ */</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>	<span class="cm">/* clear IRQ */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_cs4231_calibrate_mute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  timer open/close</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_timer_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">snd_cs4231_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MODE_TIMER</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_timer_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">snd_cs4231_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MODE_TIMER</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_timer_hardware</span> <span class="n">snd_cs4231_timer_table</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span>	<span class="n">SNDRV_TIMER_HW_AUTO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resolution</span>	<span class="o">=</span>	<span class="mi">9945</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ticks</span>		<span class="o">=</span>	<span class="mi">65535</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">snd_cs4231_timer_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span>	<span class="n">snd_cs4231_timer_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">c_resolution</span>	<span class="o">=</span>	<span class="n">snd_cs4231_timer_resolution</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>		<span class="o">=</span>	<span class="n">snd_cs4231_timer_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>		<span class="o">=</span>	<span class="n">snd_cs4231_timer_stop</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ok.. exported functions..</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_playback_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_pdfr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">new_pdfr</span> <span class="o">=</span> <span class="n">snd_cs4231_get_format</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">params_format</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
					 <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">snd_cs4231_get_rate</span><span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="n">snd_cs4231_playback_format</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">,</span> <span class="n">new_pdfr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CS4231_PLAYBACK_ENABLE</span> <span class="o">|</span>
					    <span class="n">CS4231_PLAYBACK_PIO</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">&gt;</span> <span class="mh">0xffff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_periods_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_capture_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_cdfr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">new_cdfr</span> <span class="o">=</span> <span class="n">snd_cs4231_get_format</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">params_format</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
					 <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">snd_cs4231_get_rate</span><span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="n">snd_cs4231_capture_format</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">hw_params</span><span class="p">,</span> <span class="n">new_cdfr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CS4231_RECORD_ENABLE</span> <span class="o">|</span>
					    <span class="n">CS4231_RECORD_PIO</span><span class="p">);</span>


	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_periods_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_overrange</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">snd_cs4231_in</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_TEST_INIT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* detect overrange only above 0dB; may be user selectable? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x08</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">overrange</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_play_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_PLAYBACK_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">);</span>
		<span class="n">snd_cs4231_advance_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_periods_sent</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_capture_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_RECORD_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">);</span>
		<span class="n">snd_cs4231_advance_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_periods_sent</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs4231_playback_pointer</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_PLAYBACK_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">-=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_cs4231_capture_pointer</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_RECORD_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">(</span><span class="n">dma_cont</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">-=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REGSEL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS4231_INIT</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MISC_INFO</span><span class="p">,</span> <span class="n">CS4231_MODE2</span><span class="p">);</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">snd_cs4231_in</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MISC_INFO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">vers</span> <span class="o">=</span> <span class="n">snd_cs4231_in</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_VERSION</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x0a</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* this is valid value */</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231: port = %p, id = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x0a</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>	<span class="cm">/* no valid device found */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear any pendings IRQ */</span>
	<span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	<span class="n">__cs4231_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">));</span>
	<span class="n">mb</span><span class="p">();</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_MISC_INFO</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4231_MODE2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_IFACE_CTRL</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CS4231_SINGLE_DMA</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vers</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_ALT_FEATURE_2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">;</span>

	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* ok.. fill all CS4231 registers */</span>
		<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="o">++</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_cs4231_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* all things are ok.. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_cs4231_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span>		<span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_IMA_ADPCM</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>		<span class="o">=</span> <span class="mi">5510</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>		<span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span>	<span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span>	<span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_cs4231_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span>		<span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_IMA_ADPCM</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span>			<span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span>
				  <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>		<span class="o">=</span> <span class="mi">5510</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>		<span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span>	<span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span>	<span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span>	<span class="o">=</span> <span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs4231_playback</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MODE_PLAY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_free_pages</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_periods_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_cs4231_xrate</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs4231_capture</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MODE_RECORD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_free_pages</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_periods_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_cs4231_xrate</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">snd_cs4231_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MODE_PLAY</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">snd_cs4231_close</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_MODE_RECORD</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* XXX We can do some power-management, in particular on EBUS using</span>
<span class="cm"> * XXX the audio AUXIO register...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs4231_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">snd_cs4231_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span>	<span class="n">snd_cs4231_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span>	<span class="n">snd_cs4231_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span>	<span class="n">snd_pcm_lib_free_pages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span>	<span class="n">snd_cs4231_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span>	<span class="n">snd_cs4231_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span>	<span class="n">snd_cs4231_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_cs4231_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span>	<span class="n">snd_cs4231_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span>	<span class="n">snd_cs4231_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span>	<span class="o">=</span>	<span class="n">snd_cs4231_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>	<span class="o">=</span>	<span class="n">snd_pcm_lib_free_pages</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>	<span class="o">=</span>	<span class="n">snd_cs4231_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>	<span class="o">=</span>	<span class="n">snd_cs4231_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>	<span class="o">=</span>	<span class="n">snd_cs4231_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS4231&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_cs4231_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_cs4231_capture_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS4231&quot;</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_timer_id</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Timer initialization */</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">SNDRV_TIMER_CLASS_CARD</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">dev_sclass</span> <span class="o">=</span> <span class="n">SNDRV_TIMER_SCLASS_NONE</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_timer_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;CS4231&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CS4231&quot;</span><span class="p">);</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_cs4231_timer_table</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  MIXER part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_info_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Line&quot;</span><span class="p">,</span> <span class="s">&quot;CD&quot;</span><span class="p">,</span> <span class="s">&quot;Mic&quot;</span><span class="p">,</span> <span class="s">&quot;Mix&quot;</span>
	<span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_get_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LEFT_INPUT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_MIXS_ALL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_RIGHT_INPUT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CS4231_MIXS_ALL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_put_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LEFT_INPUT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CS4231_MIXS_ALL</span><span class="p">)</span> <span class="o">|</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_RIGHT_INPUT</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CS4231_MIXS_ALL</span><span class="p">)</span> <span class="o">|</span> <span class="n">right</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_LEFT_INPUT</span><span class="p">]</span> <span class="o">||</span>
		 <span class="n">right</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">CS4231_RIGHT_INPUT</span><span class="p">];</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_LEFT_INPUT</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_RIGHT_INPUT</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_info_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_get_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_put_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">reg</span><span class="p">];</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_info_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span>
		<span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_get_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">left_reg</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift_left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">right_reg</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift_right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_put_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left_reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">right_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift_right</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">;</span>

	<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val1</span><span class="p">;</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val1</span> <span class="o">&lt;&lt;=</span> <span class="n">shift_left</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">&lt;&lt;=</span> <span class="n">shift_right</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">val1</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">left_reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift_left</span><span class="p">))</span> <span class="o">|</span> <span class="n">val1</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">right_reg</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift_right</span><span class="p">))</span> <span class="o">|</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">left_reg</span><span class="p">];</span>
	<span class="n">change</span> <span class="o">|=</span> <span class="n">val2</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">[</span><span class="n">right_reg</span><span class="p">];</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">left_reg</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="n">snd_cs4231_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">right_reg</span><span class="p">,</span> <span class="n">val2</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CS4231_SINGLE(xname, xindex, reg, shift, mask, invert) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = (xname), .index = (xindex), \</span>
<span class="cp">  .info = snd_cs4231_info_single,	\</span>
<span class="cp">  .get = snd_cs4231_get_single, .put = snd_cs4231_put_single,	\</span>
<span class="cp">  .private_value = (reg) | ((shift) &lt;&lt; 8) | ((mask) &lt;&lt; 16) | ((invert) &lt;&lt; 24) }</span>

<span class="cp">#define CS4231_DOUBLE(xname, xindex, left_reg, right_reg, shift_left, \</span>
<span class="cp">			shift_right, mask, invert) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = (xname), .index = (xindex), \</span>
<span class="cp">  .info = snd_cs4231_info_double,	\</span>
<span class="cp">  .get = snd_cs4231_get_double, .put = snd_cs4231_put_double,	\</span>
<span class="cp">  .private_value = (left_reg) | ((right_reg) &lt;&lt; 8) | ((shift_left) &lt;&lt; 16) | \</span>
<span class="cp">		   ((shift_right) &lt;&lt; 19) | ((mask) &lt;&lt; 24) | ((invert) &lt;&lt; 22) }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_cs4231_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LEFT_OUTPUT</span><span class="p">,</span>
		<span class="n">CS4231_RIGHT_OUTPUT</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LEFT_OUTPUT</span><span class="p">,</span>
		<span class="n">CS4231_RIGHT_OUTPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LEFT_LINE_IN</span><span class="p">,</span>
		<span class="n">CS4231_RIGHT_LINE_IN</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LEFT_LINE_IN</span><span class="p">,</span>
		<span class="n">CS4231_RIGHT_LINE_IN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Aux Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_AUX1_LEFT_INPUT</span><span class="p">,</span>
		<span class="n">CS4231_AUX1_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Aux Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_AUX1_LEFT_INPUT</span><span class="p">,</span>
		<span class="n">CS4231_AUX1_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Aux Playback Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CS4231_AUX2_LEFT_INPUT</span><span class="p">,</span>
		<span class="n">CS4231_AUX2_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Aux Playback Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CS4231_AUX2_LEFT_INPUT</span><span class="p">,</span>
		<span class="n">CS4231_AUX2_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_MONO_CTRL</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_MONO_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Output Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_MONO_CTRL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Mono Output Playback Bypass&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_MONO_CTRL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LEFT_INPUT</span><span class="p">,</span> <span class="n">CS4231_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span>	<span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Capture Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span>	<span class="o">=</span> <span class="n">snd_cs4231_info_mux</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span>	<span class="o">=</span> <span class="n">snd_cs4231_get_mux</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span>	<span class="o">=</span> <span class="n">snd_cs4231_put_mux</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">CS4231_DOUBLE</span><span class="p">(</span><span class="s">&quot;Mic Boost&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LEFT_INPUT</span><span class="p">,</span> <span class="n">CS4231_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Loopback Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LOOPBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Loopback Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_LOOPBACK</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="cm">/* SPARC specific uses of XCTL{0,1} general purpose outputs.  */</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Line Out Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_PIN_CTRL</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">CS4231_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone Out Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CS4231_PIN_CTRL</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_cs4231_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				 <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cs4231_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">chip</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cs4231_attach_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">**</span><span class="n">rcard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rcard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;CS4231&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Sun CS4231&quot;</span><span class="p">);</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rcard</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cs4231_attach_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_mixer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_timer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SBUS_SUPPORT</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_cs4231_sbus_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="cm">/*This is IRQ is not raised by the cs4231*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">__cs4231_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231U</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">CS4231_GLOBALIRQ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* ACK the APC interrupt. */</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>

	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_PDMA_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_PLAY_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_XINT_PNVA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_XINT_EMPT</span><span class="p">))</span>
			<span class="n">snd_cs4231_play_callback</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_CDMA_READY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_CAPT_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_XINT_CNVA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_XINT_EMPT</span><span class="p">))</span>
			<span class="n">snd_cs4231_capture_callback</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">snd_cs4231_in</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CS4231_TIMER_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span>
			<span class="n">snd_timer_interrupt</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">sticks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CS4231_RECORD_IRQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">APC_CDMA_READY</span><span class="p">))</span>
		<span class="n">snd_cs4231_overrange</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* ACK the CS4231 interrupt. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_cs4231_outm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CS4231_IRQ_STATUS</span><span class="p">,</span> <span class="o">~</span><span class="n">CS4231_ALL_IRQS</span> <span class="o">|</span> <span class="o">~</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SBUS DMA routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sbus_dma_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span>
			    <span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">test</span><span class="p">,</span> <span class="n">csr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbus_dma_info</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">sbus_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">test</span> <span class="o">=</span> <span class="n">APC_CDMA_READY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">APC_PLAY</span><span class="p">)</span>
		<span class="n">test</span> <span class="o">=</span> <span class="n">APC_PDMA_READY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">test</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">test</span> <span class="o">=</span> <span class="n">APC_XINT_CNVA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">APC_PLAY</span><span class="p">)</span>
		<span class="n">test</span> <span class="o">=</span> <span class="n">APC_XINT_PNVA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csr</span> <span class="o">&amp;</span> <span class="n">test</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">bus_addr</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCNVA</span><span class="p">);</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCNC</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbus_dma_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">,</span> <span class="n">test</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbus_dma_info</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">sbus_info</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>
	<span class="n">test</span> <span class="o">=</span>  <span class="n">APC_GENL_INT</span> <span class="o">|</span> <span class="n">APC_PLAY_INT</span> <span class="o">|</span> <span class="n">APC_XINT_ENA</span> <span class="o">|</span>
		<span class="n">APC_XINT_PLAY</span> <span class="o">|</span> <span class="n">APC_XINT_PEMP</span> <span class="o">|</span> <span class="n">APC_XINT_GENL</span> <span class="o">|</span>
		 <span class="n">APC_XINT_PENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">APC_RECORD</span><span class="p">)</span>
		<span class="n">test</span> <span class="o">=</span> <span class="n">APC_GENL_INT</span> <span class="o">|</span> <span class="n">APC_CAPT_INT</span> <span class="o">|</span> <span class="n">APC_XINT_ENA</span> <span class="o">|</span>
			<span class="n">APC_XINT_CAPT</span> <span class="o">|</span> <span class="n">APC_XINT_CEMP</span> <span class="o">|</span> <span class="n">APC_XINT_GENL</span><span class="p">;</span>
	<span class="n">csr</span> <span class="o">|=</span> <span class="n">test</span><span class="p">;</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sbus_dma_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csr</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sbus_dma_info</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">sbus_info</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCNC</span><span class="p">);</span>
		<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCNVA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">APC_PLAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCC</span><span class="p">);</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCVA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">csr</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">==</span> <span class="n">APC_PLAY</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">APC_CPAUSE</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">APC_CPAUSE</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">csr</span> <span class="o">|=</span> <span class="p">(</span><span class="n">APC_CDMA_READY</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">csr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">APC_CDMA_READY</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">csr</span><span class="p">,</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">APCCSR</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sbus_dma_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sbus_dma_info</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">sbus_info</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">base</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">+</span> <span class="n">APCVA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Init and exit routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_sbus_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_sbus_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_cs4231_sbus_free</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">snd_cs4231_sbus_dev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev_free</span>	<span class="o">=</span>	<span class="n">snd_cs4231_sbus_dev_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_sbus_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">sbus_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">sbus_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4231_original_image</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">snd_cs4231_original_image</span><span class="p">));</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">,</span> <span class="s">&quot;cs4231&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to map chip registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">sbus_info</span><span class="p">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">sbus_info</span><span class="p">.</span><span class="n">regs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">sbus_info</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">APC_RECORD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">sbus_info</span><span class="p">.</span><span class="n">dir</span> <span class="o">=</span> <span class="n">APC_PLAY</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">sbus_dma_prepare</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">sbus_dma_enable</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">sbus_dma_request</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">sbus_dma_addr</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">sbus_dma_prepare</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">sbus_dma_enable</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">sbus_dma_request</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">sbus_dma_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">snd_cs4231_sbus_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;cs4231&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to grab SBUS IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">snd_cs4231_sbus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs4231_probe</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4231_sbus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_cs4231_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span>
				  <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4231_sbus_dev_ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4231_sbus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cs4231_sbus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cs4231_attach_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%02lx:0x%016Lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffL</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_sbus_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cs4231_attach_finish</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef EBUS_SUPPORT</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_ebus_play_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ebus_dma_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">snd_cs4231_play_callback</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_cs4231_ebus_capture_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ebus_dma_info</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="n">snd_cs4231_capture_callback</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * EBUS DMA wrappers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_ebus_dma_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span>
			     <span class="n">dma_addr_t</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ebus_dma_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">ebus_info</span><span class="p">,</span> <span class="n">bus_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ebus_dma_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ebus_dma_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">ebus_info</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_ebus_dma_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ebus_dma_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">ebus_info</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">_ebus_dma_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4231_dma_control</span> <span class="o">*</span><span class="n">dma_cont</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ebus_dma_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma_cont</span><span class="o">-&gt;</span><span class="n">ebus_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Init and exit routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_ebus_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ebus_dma_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">);</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ebus_dma_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">);</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4231_ebus_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">cp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">snd_cs4231_ebus_dev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev_free</span>	<span class="o">=</span>	<span class="n">snd_cs4231_ebus_dev_free</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cs4231_ebus_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mce_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CS4231_FLAG_EBUS</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4231_original_image</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">snd_cs4231_original_image</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cs4231(capture)&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">EBUS_DMA_FLAG_USE_EBDMA_HANDLER</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">snd_cs4231_ebus_capture_callback</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">client_cookie</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cs4231(play)&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">EBUS_DMA_FLAG_USE_EBDMA_HANDLER</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">snd_cs4231_ebus_play_callback</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">client_cookie</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">_ebus_dma_prepare</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">_ebus_dma_enable</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">_ebus_dma_request</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">_ebus_dma_addr</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">_ebus_dma_prepare</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">_ebus_dma_enable</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">_ebus_dma_request</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">_ebus_dma_addr</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;cs4231&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span> <span class="o">=</span>
		<span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;cs4231_pdma&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span> <span class="o">=</span>
		<span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;cs4231_cdma&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">||</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">.</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to map chip registers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ebus_dma_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to register EBUS capture DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ebus_dma_irq_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">c_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to enable EBUS capture IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ebus_dma_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to register EBUS play DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ebus_dma_irq_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">p_dma</span><span class="p">.</span><span class="n">ebus_info</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;cs4231-%d: Unable to enable EBUS play IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_cs4231_probe</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_cs4231_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span>
				  <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_cs4231_ebus_dev_ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_cs4231_ebus_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cs4231_ebus_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cs4231_attach_begin</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%llx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		<span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cs4231_ebus_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cs4231_attach_finish</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cs4231_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef EBUS_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ebus&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cs4231_ebus_probe</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef SBUS_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sbus&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sbi&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cs4231_sbus_probe</span><span class="p">(</span><span class="n">op</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">cs4231_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cs4231</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">cs4231_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,CS4231&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;SUNW,CS4231&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">cs4231_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">cs4231_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;audio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">cs4231_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">cs4231_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">cs4231_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">cs4231_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
