<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › sparc › dbri.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dbri.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for DBRI sound chip found on Sparcs.</span>
<span class="cm"> * Copyright (C) 2004, 2005 Martin Habets (mhabets@users.sourceforge.net)</span>
<span class="cm"> *</span>
<span class="cm"> * Converted to ring buffered version by Krzysztof Helt (krzysztof.h1@wp.pl)</span>
<span class="cm"> *</span>
<span class="cm"> * Based entirely upon drivers/sbus/audio/dbri.c which is:</span>
<span class="cm"> * Copyright (C) 1997 Rudolf Koenig (rfkoenig@immd4.informatik.uni-erlangen.de)</span>
<span class="cm"> * Copyright (C) 1998, 1999 Brent Baccala (baccala@freesoft.org)</span>
<span class="cm"> *</span>
<span class="cm"> * This is the low level driver for the DBRI &amp; MMCODEC duo used for ISDN &amp; AUDIO</span>
<span class="cm"> * on Sun SPARCStation 10, 20, LX and Voyager models.</span>
<span class="cm"> *</span>
<span class="cm"> * - DBRI: AT&amp;T T5900FX Dual Basic Rates ISDN Interface. It is a 32 channel</span>
<span class="cm"> *   data time multiplexer with ISDN support (aka T7259)</span>
<span class="cm"> *   Interfaces: SBus,ISDN NT &amp; TE, CHI, 4 bits parallel.</span>
<span class="cm"> *   CHI: (spelled ki) Concentration Highway Interface (AT&amp;T or Intel bus ?).</span>
<span class="cm"> *   Documentation:</span>
<span class="cm"> *   - &quot;STP 4000SBus Dual Basic Rate ISDN (DBRI) Transceiver&quot; from</span>
<span class="cm"> *     Sparc Technology Business (courtesy of Sun Support)</span>
<span class="cm"> *   - Data sheet of the T7903, a newer but very similar ISA bus equivalent</span>
<span class="cm"> *     available from the Lucent (formerly AT&amp;T microelectronics) home</span>
<span class="cm"> *     page.</span>
<span class="cm"> *   - http://www.freesoft.org/Linux/DBRI/</span>
<span class="cm"> * - MMCODEC: Crystal Semiconductor CS4215 16 bit Multimedia Audio Codec</span>
<span class="cm"> *   Interfaces: CHI, Audio In &amp; Out, 2 bits parallel</span>
<span class="cm"> *   Documentation: from the Crystal Semiconductor home page.</span>
<span class="cm"> *</span>
<span class="cm"> * The DBRI is a 32 pipe machine, each pipe can transfer some bits between</span>
<span class="cm"> * memory and a serial device (long pipes, no. 0-15) or between two serial</span>
<span class="cm"> * devices (short pipes, no. 16-31), or simply send a fixed data to a serial</span>
<span class="cm"> * device (short pipes).</span>
<span class="cm"> * A timeslot defines the bit-offset and no. of bits read from a serial device.</span>
<span class="cm"> * The timeslots are linked to 6 circular lists, one for each direction for</span>
<span class="cm"> * each serial device (NT,TE,CHI). A timeslot is associated to 1 or 2 pipes</span>
<span class="cm"> * (the second one is a monitor/tee pipe, valid only for serial input).</span>
<span class="cm"> *</span>
<span class="cm"> * The mmcodec is connected via the CHI bus and needs the data &amp; some</span>
<span class="cm"> * parameters (volume, output selection) time multiplexed in 8 byte</span>
<span class="cm"> * chunks. It also has a control mode, which serves for audio format setting.</span>
<span class="cm"> *</span>
<span class="cm"> * Looking at the CS4215 data sheet it is easy to set up 2 or 4 codecs on</span>
<span class="cm"> * the same CHI bus, so I thought perhaps it is possible to use the on-board</span>
<span class="cm"> * &amp; the speakerbox codec simultaneously, giving 2 (not very independent :-)</span>
<span class="cm"> * audio devices. But the SUN HW group decided against it, at least on my</span>
<span class="cm"> * LX the speakerbox connector has at least 1 pin missing and 1 wrongly</span>
<span class="cm"> * connected.</span>
<span class="cm"> *</span>
<span class="cm"> * I&#39;ve tried to stick to the following function naming conventions:</span>
<span class="cm"> * snd_*	ALSA stuff</span>
<span class="cm"> * cs4215_*	CS4215 codec specific stuff</span>
<span class="cm"> * dbri_*	DBRI high-level stuff</span>
<span class="cm"> * other	DBRI low-level stuff</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rudolf Koenig, Brent Baccala and Martin Habets&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sun DBRI&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Sun,DBRI}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Sun DBRI soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Sun DBRI soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Sun DBRI soundcard.&quot;</span><span class="p">);</span>

<span class="cp">#undef DBRI_DEBUG</span>

<span class="cp">#define D_INT	(1&lt;&lt;0)</span>
<span class="cp">#define D_GEN	(1&lt;&lt;1)</span>
<span class="cp">#define D_CMD	(1&lt;&lt;2)</span>
<span class="cp">#define D_MM	(1&lt;&lt;3)</span>
<span class="cp">#define D_USR	(1&lt;&lt;4)</span>
<span class="cp">#define D_DESC	(1&lt;&lt;5)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dbri_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbri_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbri_debug</span><span class="p">,</span> <span class="s">&quot;Debug value for Sun DBRI soundcard.&quot;</span><span class="p">);</span>

<span class="cp">#ifdef DBRI_DEBUG</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;WAIT&quot;</span><span class="p">,</span> <span class="s">&quot;PAUSE&quot;</span><span class="p">,</span> <span class="s">&quot;JUMP&quot;</span><span class="p">,</span> <span class="s">&quot;IIQ&quot;</span><span class="p">,</span> <span class="s">&quot;REX&quot;</span><span class="p">,</span> <span class="s">&quot;SDP&quot;</span><span class="p">,</span> <span class="s">&quot;CDP&quot;</span><span class="p">,</span> <span class="s">&quot;DTS&quot;</span><span class="p">,</span>
	<span class="s">&quot;SSP&quot;</span><span class="p">,</span> <span class="s">&quot;CHI&quot;</span><span class="p">,</span> <span class="s">&quot;NT&quot;</span><span class="p">,</span> <span class="s">&quot;TE&quot;</span><span class="p">,</span> <span class="s">&quot;CDEC&quot;</span><span class="p">,</span> <span class="s">&quot;TEST&quot;</span><span class="p">,</span> <span class="s">&quot;CDM&quot;</span><span class="p">,</span> <span class="s">&quot;RESRV&quot;</span>
<span class="p">};</span>

<span class="cp">#define dprintk(a, x...) if (dbri_debug &amp; a) printk(KERN_DEBUG x)</span>

<span class="cp">#else</span>
<span class="cp">#define dprintk(a, x...) do { } while (0)</span>

<span class="cp">#endif				</span><span class="cm">/* DBRI_DEBUG */</span><span class="cp"></span>

<span class="cp">#define DBRI_CMD(cmd, intr, value) ((cmd &lt;&lt; 28) |	\</span>
<span class="cp">				    (intr &lt;&lt; 27) |	\</span>
<span class="cp">				    value)</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">	CS4215 specific definitions and structures</span>
<span class="cm">****************************************************************************/</span>

<span class="k">struct</span> <span class="n">cs4215</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		<span class="cm">/* Data mode: Time slots 5-8 */</span>
	<span class="n">__u8</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		<span class="cm">/* Ctrl mode: Time slots 1-4 */</span>
	<span class="n">__u8</span> <span class="n">onboard</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">offset</span><span class="p">;</span>		<span class="cm">/* Bit offset from frame sync to time slot 1 */</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">precision</span><span class="p">;</span>		<span class="cm">/* In bits, either 8 or 16 */</span>
	<span class="n">__u8</span> <span class="n">channels</span><span class="p">;</span>		<span class="cm">/* 1 or 2 */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Control mode first</span>
<span class="cm"> */</span>

<span class="cm">/* Time Slot 1, Status register */</span>
<span class="cp">#define CS4215_CLB	(1&lt;&lt;2)	</span><span class="cm">/* Control Latch Bit */</span><span class="cp"></span>
<span class="cp">#define CS4215_OLB	(1&lt;&lt;3)	</span><span class="cm">/* 1: line: 2.0V, speaker 4V */</span><span class="cp"></span>
				<span class="cm">/* 0: line: 2.8V, speaker 8V */</span>
<span class="cp">#define CS4215_MLB	(1&lt;&lt;4)	</span><span class="cm">/* 1: Microphone: 20dB gain disabled */</span><span class="cp"></span>
<span class="cp">#define CS4215_RSRVD_1  (1&lt;&lt;5)</span>

<span class="cm">/* Time Slot 2, Data Format Register */</span>
<span class="cp">#define CS4215_DFR_LINEAR16	0</span>
<span class="cp">#define CS4215_DFR_ULAW		1</span>
<span class="cp">#define CS4215_DFR_ALAW		2</span>
<span class="cp">#define CS4215_DFR_LINEAR8	3</span>
<span class="cp">#define CS4215_DFR_STEREO	(1&lt;&lt;2)</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtal</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">csval</span><span class="p">;</span>
<span class="p">}</span> <span class="n">CS4215_FREQ</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>  <span class="mi">8000</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">16000</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">27429</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* Actually 24428.57 */</span>
	<span class="p">{</span> <span class="mi">32000</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
     <span class="cm">/* {    NA, (1 &lt;&lt; 4), (4 &lt;&lt; 3) }, */</span>
     <span class="cm">/* {    NA, (1 &lt;&lt; 4), (5 &lt;&lt; 3) }, */</span>
	<span class="p">{</span> <span class="mi">48000</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">9600</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">5512</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* Actually 5512.5 */</span>
	<span class="p">{</span> <span class="mi">11025</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">18900</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">22050</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">37800</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">44100</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">33075</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">6615</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define CS4215_HPF	(1&lt;&lt;7)	</span><span class="cm">/* High Pass Filter, 1: Enabled */</span><span class="cp"></span>

<span class="cp">#define CS4215_12_MASK	0xfcbf	</span><span class="cm">/* Mask off reserved bits in slot 1 &amp; 2 */</span><span class="cp"></span>

<span class="cm">/* Time Slot 3, Serial Port Control register */</span>
<span class="cp">#define CS4215_XEN	(1&lt;&lt;0)	</span><span class="cm">/* 0: Enable serial output */</span><span class="cp"></span>
<span class="cp">#define CS4215_XCLK	(1&lt;&lt;1)	</span><span class="cm">/* 1: Master mode: Generate SCLK */</span><span class="cp"></span>
<span class="cp">#define CS4215_BSEL_64	(0&lt;&lt;2)	</span><span class="cm">/* Bitrate: 64 bits per frame */</span><span class="cp"></span>
<span class="cp">#define CS4215_BSEL_128	(1&lt;&lt;2)</span>
<span class="cp">#define CS4215_BSEL_256	(2&lt;&lt;2)</span>
<span class="cp">#define CS4215_MCK_MAST (0&lt;&lt;4)	</span><span class="cm">/* Master clock */</span><span class="cp"></span>
<span class="cp">#define CS4215_MCK_XTL1 (1&lt;&lt;4)	</span><span class="cm">/* 24.576 MHz clock source */</span><span class="cp"></span>
<span class="cp">#define CS4215_MCK_XTL2 (2&lt;&lt;4)	</span><span class="cm">/* 16.9344 MHz clock source */</span><span class="cp"></span>
<span class="cp">#define CS4215_MCK_CLK1 (3&lt;&lt;4)	</span><span class="cm">/* Clockin, 256 x Fs */</span><span class="cp"></span>
<span class="cp">#define CS4215_MCK_CLK2 (4&lt;&lt;4)	</span><span class="cm">/* Clockin, see DFR */</span><span class="cp"></span>

<span class="cm">/* Time Slot 4, Test Register */</span>
<span class="cp">#define CS4215_DAD	(1&lt;&lt;0)	</span><span class="cm">/* 0:Digital-Dig loop, 1:Dig-Analog-Dig loop */</span><span class="cp"></span>
<span class="cp">#define CS4215_ENL	(1&lt;&lt;1)	</span><span class="cm">/* Enable Loopback Testing */</span><span class="cp"></span>

<span class="cm">/* Time Slot 5, Parallel Port Register */</span>
<span class="cm">/* Read only here and the same as the in data mode */</span>

<span class="cm">/* Time Slot 6, Reserved  */</span>

<span class="cm">/* Time Slot 7, Version Register  */</span>
<span class="cp">#define CS4215_VERSION_MASK 0xf	</span><span class="cm">/* Known versions 0/C, 1/D, 2/E */</span><span class="cp"></span>

<span class="cm">/* Time Slot 8, Reserved  */</span>

<span class="cm">/*</span>
<span class="cm"> * Data mode</span>
<span class="cm"> */</span>
<span class="cm">/* Time Slot 1-2: Left Channel Data, 2-3: Right Channel Data  */</span>

<span class="cm">/* Time Slot 5, Output Setting  */</span>
<span class="cp">#define CS4215_LO(v)	v	</span><span class="cm">/* Left Output Attenuation 0x3f: -94.5 dB */</span><span class="cp"></span>
<span class="cp">#define CS4215_LE	(1&lt;&lt;6)	</span><span class="cm">/* Line Out Enable */</span><span class="cp"></span>
<span class="cp">#define CS4215_HE	(1&lt;&lt;7)	</span><span class="cm">/* Headphone Enable */</span><span class="cp"></span>

<span class="cm">/* Time Slot 6, Output Setting  */</span>
<span class="cp">#define CS4215_RO(v)	v	</span><span class="cm">/* Right Output Attenuation 0x3f: -94.5 dB */</span><span class="cp"></span>
<span class="cp">#define CS4215_SE	(1&lt;&lt;6)	</span><span class="cm">/* Speaker Enable */</span><span class="cp"></span>
<span class="cp">#define CS4215_ADI	(1&lt;&lt;7)	</span><span class="cm">/* A/D Data Invalid: Busy in calibration */</span><span class="cp"></span>

<span class="cm">/* Time Slot 7, Input Setting */</span>
<span class="cp">#define CS4215_LG(v)	v	</span><span class="cm">/* Left Gain Setting 0xf: 22.5 dB */</span><span class="cp"></span>
<span class="cp">#define CS4215_IS	(1&lt;&lt;4)	</span><span class="cm">/* Input Select: 1=Microphone, 0=Line */</span><span class="cp"></span>
<span class="cp">#define CS4215_OVR	(1&lt;&lt;5)	</span><span class="cm">/* 1: Over range condition occurred */</span><span class="cp"></span>
<span class="cp">#define CS4215_PIO0	(1&lt;&lt;6)	</span><span class="cm">/* Parallel I/O 0 */</span><span class="cp"></span>
<span class="cp">#define CS4215_PIO1	(1&lt;&lt;7)</span>

<span class="cm">/* Time Slot 8, Input Setting */</span>
<span class="cp">#define CS4215_RG(v)	v	</span><span class="cm">/* Right Gain Setting 0xf: 22.5 dB */</span><span class="cp"></span>
<span class="cp">#define CS4215_MA(v)	(v&lt;&lt;4)	</span><span class="cm">/* Monitor Path Attenuation 0xf: mute */</span><span class="cp"></span>

<span class="cm">/***************************************************************************</span>
<span class="cm">		DBRI specific definitions and structures</span>
<span class="cm">****************************************************************************/</span>

<span class="cm">/* DBRI main registers */</span>
<span class="cp">#define REG0	0x00		</span><span class="cm">/* Status and Control */</span><span class="cp"></span>
<span class="cp">#define REG1	0x04		</span><span class="cm">/* Mode and Interrupt */</span><span class="cp"></span>
<span class="cp">#define REG2	0x08		</span><span class="cm">/* Parallel IO */</span><span class="cp"></span>
<span class="cp">#define REG3	0x0c		</span><span class="cm">/* Test */</span><span class="cp"></span>
<span class="cp">#define REG8	0x20		</span><span class="cm">/* Command Queue Pointer */</span><span class="cp"></span>
<span class="cp">#define REG9	0x24		</span><span class="cm">/* Interrupt Queue Pointer */</span><span class="cp"></span>

<span class="cp">#define DBRI_NO_CMDS	64</span>
<span class="cp">#define DBRI_INT_BLK	64</span>
<span class="cp">#define DBRI_NO_DESCS	64</span>
<span class="cp">#define DBRI_NO_PIPES	32</span>
<span class="cp">#define DBRI_MAX_PIPE	(DBRI_NO_PIPES - 1)</span>

<span class="cp">#define DBRI_REC	0</span>
<span class="cp">#define DBRI_PLAY	1</span>
<span class="cp">#define DBRI_NO_STREAMS	2</span>

<span class="cm">/* One transmit/receive descriptor */</span>
<span class="cm">/* When ba != 0 descriptor is used */</span>
<span class="k">struct</span> <span class="n">dbri_mem</span> <span class="p">{</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">word1</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">ba</span><span class="p">;</span>	<span class="cm">/* Transmit/Receive Buffer Address */</span>
	<span class="n">__u32</span> <span class="n">nda</span><span class="p">;</span>	<span class="cm">/* Next Descriptor Address */</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="n">word4</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* This structure is in a DMA region where it can accessed by both</span>
<span class="cm"> * the CPU and the DBRI</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbri_dma</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">cmd</span><span class="p">[</span><span class="n">DBRI_NO_CMDS</span><span class="p">];</span>			<span class="cm">/* Place for commands */</span>
	<span class="k">volatile</span> <span class="n">s32</span> <span class="n">intr</span><span class="p">[</span><span class="n">DBRI_INT_BLK</span><span class="p">];</span>	<span class="cm">/* Interrupt field  */</span>
	<span class="k">struct</span> <span class="n">dbri_mem</span> <span class="n">desc</span><span class="p">[</span><span class="n">DBRI_NO_DESCS</span><span class="p">];</span>	<span class="cm">/* Xmit/receive descriptors */</span>
<span class="p">};</span>

<span class="cp">#define dbri_dma_off(member, elem)	\</span>
<span class="cp">	((u32)(unsigned long)		\</span>
<span class="cp">	 (&amp;(((struct dbri_dma *)0)-&gt;member[elem])))</span>

<span class="k">enum</span> <span class="n">in_or_out</span> <span class="p">{</span> <span class="n">PIPEinput</span><span class="p">,</span> <span class="n">PIPEoutput</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">dbri_pipe</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">sdp</span><span class="p">;</span>		<span class="cm">/* SDP command word */</span>
	<span class="kt">int</span> <span class="n">nextpipe</span><span class="p">;</span>		<span class="cm">/* Next pipe in linked list */</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>		<span class="cm">/* Length of timeslot (bits) */</span>
	<span class="kt">int</span> <span class="n">first_desc</span><span class="p">;</span>		<span class="cm">/* Index of first descriptor */</span>
	<span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>		<span class="cm">/* Index of active descriptor */</span>
	<span class="k">volatile</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">recv_fixed_ptr</span><span class="p">;</span>	<span class="cm">/* Ptr to receive fixed data */</span>
<span class="p">};</span>

<span class="cm">/* Per stream (playback or record) information */</span>
<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dvma_buffer</span><span class="p">;</span>	<span class="cm">/* Device view of ALSA DMA buffer */</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>		<span class="cm">/* Size of DMA buffer             */</span>
	<span class="kt">size_t</span> <span class="n">offset</span><span class="p">;</span>		<span class="cm">/* offset in user buffer          */</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>		<span class="cm">/* Data pipe used                 */</span>
	<span class="kt">int</span> <span class="n">left_gain</span><span class="p">;</span>		<span class="cm">/* mixer elements                 */</span>
	<span class="kt">int</span> <span class="n">right_gain</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* This structure holds the information for both chips (DBRI &amp; CS4215) */</span>
<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">regs_size</span><span class="p">,</span> <span class="n">irq</span><span class="p">;</span>	<span class="cm">/* Needed for unload */</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">;</span>	<span class="cm">/* OF device info */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">dbri_dma</span> <span class="o">*</span><span class="n">dma</span><span class="p">;</span>	<span class="cm">/* Pointer to our DMA block */</span>
	<span class="n">u32</span> <span class="n">dma_dvma</span><span class="p">;</span>		<span class="cm">/* DBRI visible DMA address */</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>	<span class="cm">/* dbri HW regs */</span>
	<span class="kt">int</span> <span class="n">dbri_irqp</span><span class="p">;</span>		<span class="cm">/* intr queue pointer */</span>

	<span class="k">struct</span> <span class="n">dbri_pipe</span> <span class="n">pipes</span><span class="p">[</span><span class="n">DBRI_NO_PIPES</span><span class="p">];</span>	<span class="cm">/* DBRI&#39;s 32 data pipes */</span>
	<span class="kt">int</span> <span class="n">next_desc</span><span class="p">[</span><span class="n">DBRI_NO_DESCS</span><span class="p">];</span>		<span class="cm">/* Index of next desc, or -1 */</span>
	<span class="n">spinlock_t</span> <span class="n">cmdlock</span><span class="p">;</span>	<span class="cm">/* Protects cmd queue accesses */</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmdptr</span><span class="p">;</span>		<span class="cm">/* Pointer to the last queued cmd */</span>

	<span class="kt">int</span> <span class="n">chi_bpf</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cs4215</span> <span class="n">mm</span><span class="p">;</span>	<span class="cm">/* mmcodec special info */</span>
				<span class="cm">/* per stream (playback/record) info */</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_NO_STREAMS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define DBRI_MAX_VOLUME		63	</span><span class="cm">/* Output volume */</span><span class="cp"></span>
<span class="cp">#define DBRI_MAX_GAIN		15	</span><span class="cm">/* Input gain */</span><span class="cp"></span>

<span class="cm">/* DBRI Reg0 - Status Control Register - defines. (Page 17) */</span>
<span class="cp">#define D_P		(1&lt;&lt;15)	</span><span class="cm">/* Program command &amp; queue pointer valid */</span><span class="cp"></span>
<span class="cp">#define D_G		(1&lt;&lt;14)	</span><span class="cm">/* Allow 4-Word SBus Burst */</span><span class="cp"></span>
<span class="cp">#define D_S		(1&lt;&lt;13)	</span><span class="cm">/* Allow 16-Word SBus Burst */</span><span class="cp"></span>
<span class="cp">#define D_E		(1&lt;&lt;12)	</span><span class="cm">/* Allow 8-Word SBus Burst */</span><span class="cp"></span>
<span class="cp">#define D_X		(1&lt;&lt;7)	</span><span class="cm">/* Sanity Timer Disable */</span><span class="cp"></span>
<span class="cp">#define D_T		(1&lt;&lt;6)	</span><span class="cm">/* Permit activation of the TE interface */</span><span class="cp"></span>
<span class="cp">#define D_N		(1&lt;&lt;5)	</span><span class="cm">/* Permit activation of the NT interface */</span><span class="cp"></span>
<span class="cp">#define D_C		(1&lt;&lt;4)	</span><span class="cm">/* Permit activation of the CHI interface */</span><span class="cp"></span>
<span class="cp">#define D_F		(1&lt;&lt;3)	</span><span class="cm">/* Force Sanity Timer Time-Out */</span><span class="cp"></span>
<span class="cp">#define D_D		(1&lt;&lt;2)	</span><span class="cm">/* Disable Master Mode */</span><span class="cp"></span>
<span class="cp">#define D_H		(1&lt;&lt;1)	</span><span class="cm">/* Halt for Analysis */</span><span class="cp"></span>
<span class="cp">#define D_R		(1&lt;&lt;0)	</span><span class="cm">/* Soft Reset */</span><span class="cp"></span>

<span class="cm">/* DBRI Reg1 - Mode and Interrupt Register - defines. (Page 18) */</span>
<span class="cp">#define D_LITTLE_END	(1&lt;&lt;8)	</span><span class="cm">/* Byte Order */</span><span class="cp"></span>
<span class="cp">#define D_BIG_END	(0&lt;&lt;8)	</span><span class="cm">/* Byte Order */</span><span class="cp"></span>
<span class="cp">#define D_MRR		(1&lt;&lt;4)	</span><span class="cm">/* Multiple Error Ack on SBus (read only) */</span><span class="cp"></span>
<span class="cp">#define D_MLE		(1&lt;&lt;3)	</span><span class="cm">/* Multiple Late Error on SBus (read only) */</span><span class="cp"></span>
<span class="cp">#define D_LBG		(1&lt;&lt;2)	</span><span class="cm">/* Lost Bus Grant on SBus (read only) */</span><span class="cp"></span>
<span class="cp">#define D_MBE		(1&lt;&lt;1)	</span><span class="cm">/* Burst Error on SBus (read only) */</span><span class="cp"></span>
<span class="cp">#define D_IR		(1&lt;&lt;0)	</span><span class="cm">/* Interrupt Indicator (read only) */</span><span class="cp"></span>

<span class="cm">/* DBRI Reg2 - Parallel IO Register - defines. (Page 18) */</span>
<span class="cp">#define D_ENPIO3	(1&lt;&lt;7)	</span><span class="cm">/* Enable Pin 3 */</span><span class="cp"></span>
<span class="cp">#define D_ENPIO2	(1&lt;&lt;6)	</span><span class="cm">/* Enable Pin 2 */</span><span class="cp"></span>
<span class="cp">#define D_ENPIO1	(1&lt;&lt;5)	</span><span class="cm">/* Enable Pin 1 */</span><span class="cp"></span>
<span class="cp">#define D_ENPIO0	(1&lt;&lt;4)	</span><span class="cm">/* Enable Pin 0 */</span><span class="cp"></span>
<span class="cp">#define D_ENPIO		(0xf0)	</span><span class="cm">/* Enable all the pins */</span><span class="cp"></span>
<span class="cp">#define D_PIO3		(1&lt;&lt;3)	</span><span class="cm">/* Pin 3: 1: Data mode, 0: Ctrl mode */</span><span class="cp"></span>
<span class="cp">#define D_PIO2		(1&lt;&lt;2)	</span><span class="cm">/* Pin 2: 1: Onboard PDN */</span><span class="cp"></span>
<span class="cp">#define D_PIO1		(1&lt;&lt;1)	</span><span class="cm">/* Pin 1: 0: Reset */</span><span class="cp"></span>
<span class="cp">#define D_PIO0		(1&lt;&lt;0)	</span><span class="cm">/* Pin 0: 1: Speakerbox PDN */</span><span class="cp"></span>

<span class="cm">/* DBRI Commands (Page 20) */</span>
<span class="cp">#define D_WAIT		0x0	</span><span class="cm">/* Stop execution */</span><span class="cp"></span>
<span class="cp">#define D_PAUSE		0x1	</span><span class="cm">/* Flush long pipes */</span><span class="cp"></span>
<span class="cp">#define D_JUMP		0x2	</span><span class="cm">/* New command queue */</span><span class="cp"></span>
<span class="cp">#define D_IIQ		0x3	</span><span class="cm">/* Initialize Interrupt Queue */</span><span class="cp"></span>
<span class="cp">#define D_REX		0x4	</span><span class="cm">/* Report command execution via interrupt */</span><span class="cp"></span>
<span class="cp">#define D_SDP		0x5	</span><span class="cm">/* Setup Data Pipe */</span><span class="cp"></span>
<span class="cp">#define D_CDP		0x6	</span><span class="cm">/* Continue Data Pipe (reread NULL Pointer) */</span><span class="cp"></span>
<span class="cp">#define D_DTS		0x7	</span><span class="cm">/* Define Time Slot */</span><span class="cp"></span>
<span class="cp">#define D_SSP		0x8	</span><span class="cm">/* Set short Data Pipe */</span><span class="cp"></span>
<span class="cp">#define D_CHI		0x9	</span><span class="cm">/* Set CHI Global Mode */</span><span class="cp"></span>
<span class="cp">#define D_NT		0xa	</span><span class="cm">/* NT Command */</span><span class="cp"></span>
<span class="cp">#define D_TE		0xb	</span><span class="cm">/* TE Command */</span><span class="cp"></span>
<span class="cp">#define D_CDEC		0xc	</span><span class="cm">/* Codec setup */</span><span class="cp"></span>
<span class="cp">#define D_TEST		0xd	</span><span class="cm">/* No comment */</span><span class="cp"></span>
<span class="cp">#define D_CDM		0xe	</span><span class="cm">/* CHI Data mode command */</span><span class="cp"></span>

<span class="cm">/* Special bits for some commands */</span>
<span class="cp">#define D_PIPE(v)      ((v)&lt;&lt;0)	</span><span class="cm">/* Pipe No.: 0-15 long, 16-21 short */</span><span class="cp"></span>

<span class="cm">/* Setup Data Pipe */</span>
<span class="cm">/* IRM */</span>
<span class="cp">#define D_SDP_2SAME	(1&lt;&lt;18)	</span><span class="cm">/* Report 2nd time in a row value received */</span><span class="cp"></span>
<span class="cp">#define D_SDP_CHANGE	(2&lt;&lt;18)	</span><span class="cm">/* Report any changes */</span><span class="cp"></span>
<span class="cp">#define D_SDP_EVERY	(3&lt;&lt;18)	</span><span class="cm">/* Report any changes */</span><span class="cp"></span>
<span class="cp">#define D_SDP_EOL	(1&lt;&lt;17)	</span><span class="cm">/* EOL interrupt enable */</span><span class="cp"></span>
<span class="cp">#define D_SDP_IDLE	(1&lt;&lt;16)	</span><span class="cm">/* HDLC idle interrupt enable */</span><span class="cp"></span>

<span class="cm">/* Pipe data MODE */</span>
<span class="cp">#define D_SDP_MEM	(0&lt;&lt;13)	</span><span class="cm">/* To/from memory */</span><span class="cp"></span>
<span class="cp">#define D_SDP_HDLC	(2&lt;&lt;13)</span>
<span class="cp">#define D_SDP_HDLC_D	(3&lt;&lt;13)	</span><span class="cm">/* D Channel (prio control) */</span><span class="cp"></span>
<span class="cp">#define D_SDP_SER	(4&lt;&lt;13)	</span><span class="cm">/* Serial to serial */</span><span class="cp"></span>
<span class="cp">#define D_SDP_FIXED	(6&lt;&lt;13)	</span><span class="cm">/* Short only */</span><span class="cp"></span>
<span class="cp">#define D_SDP_MODE(v)	((v)&amp;(7&lt;&lt;13))</span>

<span class="cp">#define D_SDP_TO_SER	(1&lt;&lt;12)	</span><span class="cm">/* Direction */</span><span class="cp"></span>
<span class="cp">#define D_SDP_FROM_SER	(0&lt;&lt;12)	</span><span class="cm">/* Direction */</span><span class="cp"></span>
<span class="cp">#define D_SDP_MSB	(1&lt;&lt;11)	</span><span class="cm">/* Bit order within Byte */</span><span class="cp"></span>
<span class="cp">#define D_SDP_LSB	(0&lt;&lt;11)	</span><span class="cm">/* Bit order within Byte */</span><span class="cp"></span>
<span class="cp">#define D_SDP_P		(1&lt;&lt;10)	</span><span class="cm">/* Pointer Valid */</span><span class="cp"></span>
<span class="cp">#define D_SDP_A		(1&lt;&lt;8)	</span><span class="cm">/* Abort */</span><span class="cp"></span>
<span class="cp">#define D_SDP_C		(1&lt;&lt;7)	</span><span class="cm">/* Clear */</span><span class="cp"></span>

<span class="cm">/* Define Time Slot */</span>
<span class="cp">#define D_DTS_VI	(1&lt;&lt;17)	</span><span class="cm">/* Valid Input Time-Slot Descriptor */</span><span class="cp"></span>
<span class="cp">#define D_DTS_VO	(1&lt;&lt;16)	</span><span class="cm">/* Valid Output Time-Slot Descriptor */</span><span class="cp"></span>
<span class="cp">#define D_DTS_INS	(1&lt;&lt;15)	</span><span class="cm">/* Insert Time Slot */</span><span class="cp"></span>
<span class="cp">#define D_DTS_DEL	(0&lt;&lt;15)	</span><span class="cm">/* Delete Time Slot */</span><span class="cp"></span>
<span class="cp">#define D_DTS_PRVIN(v) ((v)&lt;&lt;10)	</span><span class="cm">/* Previous In Pipe */</span><span class="cp"></span>
<span class="cp">#define D_DTS_PRVOUT(v)        ((v)&lt;&lt;5)	</span><span class="cm">/* Previous Out Pipe */</span><span class="cp"></span>

<span class="cm">/* Time Slot defines */</span>
<span class="cp">#define D_TS_LEN(v)	((v)&lt;&lt;24)	</span><span class="cm">/* Number of bits in this time slot */</span><span class="cp"></span>
<span class="cp">#define D_TS_CYCLE(v)	((v)&lt;&lt;14)	</span><span class="cm">/* Bit Count at start of TS */</span><span class="cp"></span>
<span class="cp">#define D_TS_DI		(1&lt;&lt;13)	</span><span class="cm">/* Data Invert */</span><span class="cp"></span>
<span class="cp">#define D_TS_1CHANNEL	(0&lt;&lt;10)	</span><span class="cm">/* Single Channel / Normal mode */</span><span class="cp"></span>
<span class="cp">#define D_TS_MONITOR	(2&lt;&lt;10)	</span><span class="cm">/* Monitor pipe */</span><span class="cp"></span>
<span class="cp">#define D_TS_NONCONTIG	(3&lt;&lt;10)	</span><span class="cm">/* Non contiguous mode */</span><span class="cp"></span>
<span class="cp">#define D_TS_ANCHOR	(7&lt;&lt;10)	</span><span class="cm">/* Starting short pipes */</span><span class="cp"></span>
<span class="cp">#define D_TS_MON(v)    ((v)&lt;&lt;5)	</span><span class="cm">/* Monitor Pipe */</span><span class="cp"></span>
<span class="cp">#define D_TS_NEXT(v)   ((v)&lt;&lt;0)	</span><span class="cm">/* Pipe no.: 0-15 long, 16-21 short */</span><span class="cp"></span>

<span class="cm">/* Concentration Highway Interface Modes */</span>
<span class="cp">#define D_CHI_CHICM(v)	((v)&lt;&lt;16)	</span><span class="cm">/* Clock mode */</span><span class="cp"></span>
<span class="cp">#define D_CHI_IR	(1&lt;&lt;15)	</span><span class="cm">/* Immediate Interrupt Report */</span><span class="cp"></span>
<span class="cp">#define D_CHI_EN	(1&lt;&lt;14)	</span><span class="cm">/* CHIL Interrupt enabled */</span><span class="cp"></span>
<span class="cp">#define D_CHI_OD	(1&lt;&lt;13)	</span><span class="cm">/* Open Drain Enable */</span><span class="cp"></span>
<span class="cp">#define D_CHI_FE	(1&lt;&lt;12)	</span><span class="cm">/* Sample CHIFS on Rising Frame Edge */</span><span class="cp"></span>
<span class="cp">#define D_CHI_FD	(1&lt;&lt;11)	</span><span class="cm">/* Frame Drive */</span><span class="cp"></span>
<span class="cp">#define D_CHI_BPF(v)	((v)&lt;&lt;0)	</span><span class="cm">/* Bits per Frame */</span><span class="cp"></span>

<span class="cm">/* NT: These are here for completeness */</span>
<span class="cp">#define D_NT_FBIT	(1&lt;&lt;17)	</span><span class="cm">/* Frame Bit */</span><span class="cp"></span>
<span class="cp">#define D_NT_NBF	(1&lt;&lt;16)	</span><span class="cm">/* Number of bad frames to loose framing */</span><span class="cp"></span>
<span class="cp">#define D_NT_IRM_IMM	(1&lt;&lt;15)	</span><span class="cm">/* Interrupt Report &amp; Mask: Immediate */</span><span class="cp"></span>
<span class="cp">#define D_NT_IRM_EN	(1&lt;&lt;14)	</span><span class="cm">/* Interrupt Report &amp; Mask: Enable */</span><span class="cp"></span>
<span class="cp">#define D_NT_ISNT	(1&lt;&lt;13)	</span><span class="cm">/* Configure interface as NT */</span><span class="cp"></span>
<span class="cp">#define D_NT_FT		(1&lt;&lt;12)	</span><span class="cm">/* Fixed Timing */</span><span class="cp"></span>
<span class="cp">#define D_NT_EZ		(1&lt;&lt;11)	</span><span class="cm">/* Echo Channel is Zeros */</span><span class="cp"></span>
<span class="cp">#define D_NT_IFA	(1&lt;&lt;10)	</span><span class="cm">/* Inhibit Final Activation */</span><span class="cp"></span>
<span class="cp">#define D_NT_ACT	(1&lt;&lt;9)	</span><span class="cm">/* Activate Interface */</span><span class="cp"></span>
<span class="cp">#define D_NT_MFE	(1&lt;&lt;8)	</span><span class="cm">/* Multiframe Enable */</span><span class="cp"></span>
<span class="cp">#define D_NT_RLB(v)	((v)&lt;&lt;5)	</span><span class="cm">/* Remote Loopback */</span><span class="cp"></span>
<span class="cp">#define D_NT_LLB(v)	((v)&lt;&lt;2)	</span><span class="cm">/* Local Loopback */</span><span class="cp"></span>
<span class="cp">#define D_NT_FACT	(1&lt;&lt;1)	</span><span class="cm">/* Force Activation */</span><span class="cp"></span>
<span class="cp">#define D_NT_ABV	(1&lt;&lt;0)	</span><span class="cm">/* Activate Bipolar Violation */</span><span class="cp"></span>

<span class="cm">/* Codec Setup */</span>
<span class="cp">#define D_CDEC_CK(v)	((v)&lt;&lt;24)	</span><span class="cm">/* Clock Select */</span><span class="cp"></span>
<span class="cp">#define D_CDEC_FED(v)	((v)&lt;&lt;12)	</span><span class="cm">/* FSCOD Falling Edge Delay */</span><span class="cp"></span>
<span class="cp">#define D_CDEC_RED(v)	((v)&lt;&lt;0)	</span><span class="cm">/* FSCOD Rising Edge Delay */</span><span class="cp"></span>

<span class="cm">/* Test */</span>
<span class="cp">#define D_TEST_RAM(v)	((v)&lt;&lt;16)	</span><span class="cm">/* RAM Pointer */</span><span class="cp"></span>
<span class="cp">#define D_TEST_SIZE(v)	((v)&lt;&lt;11)	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_TEST_ROMONOFF	0x5	</span><span class="cm">/* Toggle ROM opcode monitor on/off */</span><span class="cp"></span>
<span class="cp">#define D_TEST_PROC	0x6	</span><span class="cm">/* Microprocessor test */</span><span class="cp"></span>
<span class="cp">#define D_TEST_SER	0x7	</span><span class="cm">/* Serial-Controller test */</span><span class="cp"></span>
<span class="cp">#define D_TEST_RAMREAD	0x8	</span><span class="cm">/* Copy from Ram to system memory */</span><span class="cp"></span>
<span class="cp">#define D_TEST_RAMWRITE	0x9	</span><span class="cm">/* Copy into Ram from system memory */</span><span class="cp"></span>
<span class="cp">#define D_TEST_RAMBIST	0xa	</span><span class="cm">/* RAM Built-In Self Test */</span><span class="cp"></span>
<span class="cp">#define D_TEST_MCBIST	0xb	</span><span class="cm">/* Microcontroller Built-In Self Test */</span><span class="cp"></span>
<span class="cp">#define D_TEST_DUMP	0xe	</span><span class="cm">/* ROM Dump */</span><span class="cp"></span>

<span class="cm">/* CHI Data Mode */</span>
<span class="cp">#define D_CDM_THI	(1 &lt;&lt; 8)	</span><span class="cm">/* Transmit Data on CHIDR Pin */</span><span class="cp"></span>
<span class="cp">#define D_CDM_RHI	(1 &lt;&lt; 7)	</span><span class="cm">/* Receive Data on CHIDX Pin */</span><span class="cp"></span>
<span class="cp">#define D_CDM_RCE	(1 &lt;&lt; 6)	</span><span class="cm">/* Receive on Rising Edge of CHICK */</span><span class="cp"></span>
<span class="cp">#define D_CDM_XCE	(1 &lt;&lt; 2) </span><span class="cm">/* Transmit Data on Rising Edge of CHICK */</span><span class="cp"></span>
<span class="cp">#define D_CDM_XEN	(1 &lt;&lt; 1)	</span><span class="cm">/* Transmit Highway Enable */</span><span class="cp"></span>
<span class="cp">#define D_CDM_REN	(1 &lt;&lt; 0)	</span><span class="cm">/* Receive Highway Enable */</span><span class="cp"></span>

<span class="cm">/* The Interrupts */</span>
<span class="cp">#define D_INTR_BRDY	1	</span><span class="cm">/* Buffer Ready for processing */</span><span class="cp"></span>
<span class="cp">#define D_INTR_MINT	2	</span><span class="cm">/* Marked Interrupt in RD/TD */</span><span class="cp"></span>
<span class="cp">#define D_INTR_IBEG	3	</span><span class="cm">/* Flag to idle transition detected (HDLC) */</span><span class="cp"></span>
<span class="cp">#define D_INTR_IEND	4	</span><span class="cm">/* Idle to flag transition detected (HDLC) */</span><span class="cp"></span>
<span class="cp">#define D_INTR_EOL	5	</span><span class="cm">/* End of List */</span><span class="cp"></span>
<span class="cp">#define D_INTR_CMDI	6	</span><span class="cm">/* Command has bean read */</span><span class="cp"></span>
<span class="cp">#define D_INTR_XCMP	8	</span><span class="cm">/* Transmission of frame complete */</span><span class="cp"></span>
<span class="cp">#define D_INTR_SBRI	9	</span><span class="cm">/* BRI status change info */</span><span class="cp"></span>
<span class="cp">#define D_INTR_FXDT	10	</span><span class="cm">/* Fixed data change */</span><span class="cp"></span>
<span class="cp">#define D_INTR_CHIL	11	</span><span class="cm">/* CHI lost frame sync (channel 36 only) */</span><span class="cp"></span>
<span class="cp">#define D_INTR_COLL	11	</span><span class="cm">/* Unrecoverable D-Channel collision */</span><span class="cp"></span>
<span class="cp">#define D_INTR_DBYT	12	</span><span class="cm">/* Dropped by frame slip */</span><span class="cp"></span>
<span class="cp">#define D_INTR_RBYT	13	</span><span class="cm">/* Repeated by frame slip */</span><span class="cp"></span>
<span class="cp">#define D_INTR_LINT	14	</span><span class="cm">/* Lost Interrupt */</span><span class="cp"></span>
<span class="cp">#define D_INTR_UNDR	15	</span><span class="cm">/* DMA underrun */</span><span class="cp"></span>

<span class="cp">#define D_INTR_TE	32</span>
<span class="cp">#define D_INTR_NT	34</span>
<span class="cp">#define D_INTR_CHI	36</span>
<span class="cp">#define D_INTR_CMD	38</span>

<span class="cp">#define D_INTR_GETCHAN(v)	(((v) &gt;&gt; 24) &amp; 0x3f)</span>
<span class="cp">#define D_INTR_GETCODE(v)	(((v) &gt;&gt; 20) &amp; 0xf)</span>
<span class="cp">#define D_INTR_GETCMD(v)	(((v) &gt;&gt; 16) &amp; 0xf)</span>
<span class="cp">#define D_INTR_GETVAL(v)	((v) &amp; 0xffff)</span>
<span class="cp">#define D_INTR_GETRVAL(v)	((v) &amp; 0xfffff)</span>

<span class="cp">#define D_P_0		0	</span><span class="cm">/* TE receive anchor */</span><span class="cp"></span>
<span class="cp">#define D_P_1		1	</span><span class="cm">/* TE transmit anchor */</span><span class="cp"></span>
<span class="cp">#define D_P_2		2	</span><span class="cm">/* NT transmit anchor */</span><span class="cp"></span>
<span class="cp">#define D_P_3		3	</span><span class="cm">/* NT receive anchor */</span><span class="cp"></span>
<span class="cp">#define D_P_4		4	</span><span class="cm">/* CHI send data */</span><span class="cp"></span>
<span class="cp">#define D_P_5		5	</span><span class="cm">/* CHI receive data */</span><span class="cp"></span>
<span class="cp">#define D_P_6		6	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_7		7	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_8		8	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_9		9	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_10		10	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_11		11	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_12		12	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_13		13	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_14		14	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_15		15	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_16		16	</span><span class="cm">/* CHI anchor pipe */</span><span class="cp"></span>
<span class="cp">#define D_P_17		17	</span><span class="cm">/* CHI send */</span><span class="cp"></span>
<span class="cp">#define D_P_18		18	</span><span class="cm">/* CHI receive */</span><span class="cp"></span>
<span class="cp">#define D_P_19		19	</span><span class="cm">/* CHI receive */</span><span class="cp"></span>
<span class="cp">#define D_P_20		20	</span><span class="cm">/* CHI receive */</span><span class="cp"></span>
<span class="cp">#define D_P_21		21	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_22		22	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_23		23	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_24		24	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_25		25	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_26		26	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_27		27	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_28		28	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_29		29	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_30		30	</span><span class="cm">/* */</span><span class="cp"></span>
<span class="cp">#define D_P_31		31	</span><span class="cm">/* */</span><span class="cp"></span>

<span class="cm">/* Transmit descriptor defines */</span>
<span class="cp">#define DBRI_TD_F	(1 &lt;&lt; 31)	</span><span class="cm">/* End of Frame */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_D	(1 &lt;&lt; 30)	</span><span class="cm">/* Do not append CRC */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_CNT(v)	((v) &lt;&lt; 16) </span><span class="cm">/* Number of valid bytes in the buffer */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_B	(1 &lt;&lt; 15)	</span><span class="cm">/* Final interrupt */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_M	(1 &lt;&lt; 14)	</span><span class="cm">/* Marker interrupt */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_I	(1 &lt;&lt; 13)	</span><span class="cm">/* Transmit Idle Characters */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_FCNT(v)	(v)		</span><span class="cm">/* Flag Count */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_UNR	(1 &lt;&lt; 3) </span><span class="cm">/* Underrun: transmitter is out of data */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_ABT	(1 &lt;&lt; 2)	</span><span class="cm">/* Abort: frame aborted */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_TBC	(1 &lt;&lt; 0)	</span><span class="cm">/* Transmit buffer Complete */</span><span class="cp"></span>
<span class="cp">#define DBRI_TD_STATUS(v)       ((v) &amp; 0xff)	</span><span class="cm">/* Transmit status */</span><span class="cp"></span>
			<span class="cm">/* Maximum buffer size per TD: almost 8KB */</span>
<span class="cp">#define DBRI_TD_MAXCNT	((1 &lt;&lt; 13) - 4)</span>

<span class="cm">/* Receive descriptor defines */</span>
<span class="cp">#define DBRI_RD_F	(1 &lt;&lt; 31)	</span><span class="cm">/* End of Frame */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_C	(1 &lt;&lt; 30)	</span><span class="cm">/* Completed buffer */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_B	(1 &lt;&lt; 15)	</span><span class="cm">/* Final interrupt */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_M	(1 &lt;&lt; 14)	</span><span class="cm">/* Marker interrupt */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_BCNT(v)	(v)		</span><span class="cm">/* Buffer size */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_CRC	(1 &lt;&lt; 7)	</span><span class="cm">/* 0: CRC is correct */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_BBC	(1 &lt;&lt; 6)	</span><span class="cm">/* 1: Bad Byte received */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_ABT	(1 &lt;&lt; 5)	</span><span class="cm">/* Abort: frame aborted */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_OVRN	(1 &lt;&lt; 3)	</span><span class="cm">/* Overrun: data lost */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_STATUS(v)      ((v) &amp; 0xff)	</span><span class="cm">/* Receive status */</span><span class="cp"></span>
<span class="cp">#define DBRI_RD_CNT(v) (((v) &gt;&gt; 16) &amp; 0x1fff)	</span><span class="cm">/* Valid bytes in the buffer */</span><span class="cp"></span>

<span class="cm">/* stream_info[] access */</span>
<span class="cm">/* Translate the ALSA direction into the array index */</span>
<span class="cp">#define DBRI_STREAMNO(substream)				\</span>
<span class="cp">		(substream-&gt;stream ==				\</span>
<span class="cp">		 SNDRV_PCM_STREAM_PLAYBACK ? DBRI_PLAY: DBRI_REC)</span>

<span class="cm">/* Return a pointer to dbri_streaminfo */</span>
<span class="cp">#define DBRI_STREAM(dbri, substream)	\</span>
<span class="cp">		&amp;dbri-&gt;stream_info[DBRI_STREAMNO(substream)]</span>

<span class="cm">/*</span>
<span class="cm"> * Short data pipes transmit LSB first. The CS4215 receives MSB first. Grrr.</span>
<span class="cm"> * So we have to reverse the bits. Note: not all bit lengths are supported</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__u32</span> <span class="nf">reverse_bytes</span><span class="p">(</span><span class="n">__u32</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xff00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x00ff00ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xf0f0f0f0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0f0f0f0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xcccccccc</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x33333333</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">b</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xaaaaaaaa</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x55555555</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI reverse_bytes: unsupported length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">************** DBRI initialization and command synchronization *************</span>
<span class="cm">****************************************************************************</span>

<span class="cm">Commands are sent to the DBRI by building a list of them in memory,</span>
<span class="cm">then writing the address of the first list item to DBRI register 8.</span>
<span class="cm">The list is terminated with a WAIT command, which generates a</span>
<span class="cm">CPU interrupt to signal completion.</span>

<span class="cm">Since the DBRI can run in parallel with the CPU, several means of</span>
<span class="cm">synchronization present themselves. The method implemented here uses</span>
<span class="cm">the dbri_cmdwait() to wait for execution of batch of sent commands.</span>

<span class="cm">A circular command buffer is used here. A new command is being added</span>
<span class="cm">while another can be executed. The scheme works by adding two WAIT commands</span>
<span class="cm">after each sent batch of commands. When the next batch is prepared it is</span>
<span class="cm">added after the WAIT commands then the WAITs are replaced with single JUMP</span>
<span class="cm">command to the new batch. The the DBRI is forced to reread the last WAIT</span>
<span class="cm">command (replaced by the JUMP by then). If the DBRI is still executing</span>
<span class="cm">previous commands the request to reread the WAIT command is ignored.</span>

<span class="cm">Every time a routine wants to write commands to the DBRI, it must</span>
<span class="cm">first call dbri_cmdlock() and get pointer to a free space in</span>
<span class="cm">dbri-&gt;dma-&gt;cmd buffer. After this, the commands can be written to</span>
<span class="cm">the buffer, and dbri_cmdsend() is called with the final pointer value</span>
<span class="cm">to send them to the DBRI.</span>

<span class="cm">*/</span>

<span class="cp">#define MAXLOOPS 20</span>
<span class="cm">/*</span>
<span class="cm"> * Wait for the current command string to execute</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_cmdwait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maxloops</span> <span class="o">=</span> <span class="n">MAXLOOPS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Delay if previous commands are still being processed */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="o">--</span><span class="n">maxloops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D_P</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maxloops</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: Chip never completed command buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_CMD</span><span class="p">,</span> <span class="s">&quot;Chip completed command buffer (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MAXLOOPS</span> <span class="o">-</span> <span class="n">maxloops</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Lock the command queue and return pointer to space for len cmd words</span>
<span class="cm"> * It locks the cmdlock spinlock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="o">*</span><span class="nf">dbri_cmdlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Space for 2 WAIT cmds (replaced later by 1 JUMP cmd) */</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">-</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">DBRI_NO_CMDS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG8</span><span class="p">)</span> <span class="o">-</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: no space for commands.&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send prepared cmd string. It works by writing a JUMP cmd into</span>
<span class="cm"> * the last WAIT cmd and force DBRI to reread the cmd.</span>
<span class="cm"> * The JUMP cmd points to the new cmd string.</span>
<span class="cm"> * It also releases the cmdlock spinlock.</span>
<span class="cm"> *</span>
<span class="cm"> * Lock must be held before calling this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_cmdsend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">wait_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wait_id</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wait_id</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>	<span class="cm">/* restrict it to a 16 bit counter. */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_WAIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wait_id</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_WAIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wait_id</span><span class="p">);</span>

	<span class="cm">/* Replace the last command with JUMP */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">-</span> <span class="n">len</span> <span class="o">-</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_JUMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef DBRI_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&gt;</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">D_CMD</span><span class="p">,</span> <span class="s">&quot;cmd: %lx:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_CMD</span><span class="p">,</span> <span class="s">&quot;cmd: %lx:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_CMD</span><span class="p">,</span> <span class="s">&quot;cmd: %lx:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">D_CMD</span><span class="p">,</span> <span class="s">&quot;cmd: %lx:%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Reread the last command */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">D_P</span><span class="p">;</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Lock must be held when calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_GEN</span><span class="p">,</span> <span class="s">&quot;reset 0:%x 2:%x 8:%x 9:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">),</span>
		<span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">),</span>
		<span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG8</span><span class="p">),</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG9</span><span class="p">));</span>

	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">D_R</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>	<span class="cm">/* Soft Reset */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">D_R</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* A brute approach - DBRI falls back to working burst size by itself</span>
<span class="cm">	 * On SS20 D_S does not work, so do not try so high. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">D_G</span> <span class="o">|</span> <span class="n">D_E</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">D_S</span><span class="p">;</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Lock must not be held before calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">dbri_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbri_reset</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>

	<span class="cm">/* Initialize pipes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">DBRI_NO_PIPES</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">first_desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize the interrupt ring buffer.</span>
<span class="cm">	 */</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span> <span class="n">dbri_dma_off</span><span class="p">(</span><span class="n">intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dbri_irqp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set up the interrupt queue</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_IIQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdptr</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_WAIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_WAIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span> <span class="n">dbri_dma_off</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG8</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dbri_cmdwait</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">************************** DBRI data pipe management ***********************</span>
<span class="cm">****************************************************************************</span>

<span class="cm">While DBRI control functions use the command and interrupt buffers, the</span>
<span class="cm">main data path takes the form of data pipes, which can be short (command</span>
<span class="cm">and interrupt driven), or long (attached to DMA buffers).  These functions</span>
<span class="cm">provide a rudimentary means of setting up and managing the DBRI&#39;s pipes,</span>
<span class="cm">but the calling functions have to make sure they respect the pipes&#39; linked</span>
<span class="cm">list ordering, among other things.  The transmit and receive functions</span>
<span class="cm">here interface closely with the transmit and receive interrupt code.</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pipe_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">pipe</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* reset_pipe(dbri, pipe)</span>
<span class="cm"> *</span>
<span class="cm"> * Called on an in-use pipe to clear anything being transmitted or received</span>
<span class="cm"> * Lock must be held before calling this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sdp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: reset_pipe called with &quot;</span>
			<span class="s">&quot;illegal pipe number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdp</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: reset_pipe called &quot;</span>
			<span class="s">&quot;on uninitialized pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_SDP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sdp</span> <span class="o">|</span> <span class="n">D_SDP_C</span> <span class="o">|</span> <span class="n">D_SDP_P</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">ba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">nda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">desc</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">desc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">desc</span> <span class="o">!=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span><span class="p">);</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lock must be held before calling this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sdp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_pipe called &quot;</span>
			<span class="s">&quot;with illegal pipe number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sdp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_pipe called &quot;</span>
			<span class="s">&quot;with strange SDP value</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* sdp &amp;= 0xf800; */</span>
	<span class="p">}</span>

	<span class="cm">/* If this is a fixed receive pipe, arrange for an interrupt</span>
<span class="cm">	 * every time its data changes</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">D_SDP_MODE</span><span class="p">(</span><span class="n">sdp</span><span class="p">)</span> <span class="o">==</span> <span class="n">D_SDP_FIXED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">))</span>
		<span class="n">sdp</span> <span class="o">|=</span> <span class="n">D_SDP_CHANGE</span><span class="p">;</span>

	<span class="n">sdp</span> <span class="o">|=</span> <span class="n">D_PIPE</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">=</span> <span class="n">sdp</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">reset_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Lock must be held before calling this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_time_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">prevpipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nextpipe</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cycle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span>
			<span class="o">||</span> <span class="n">prevpipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">prevpipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span>
			<span class="o">||</span> <span class="n">nextpipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">nextpipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		    <span class="s">&quot;DBRI: link_time_slot called with illegal pipe number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">prevpipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">nextpipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: link_time_slot called &quot;</span>
			<span class="s">&quot;on uninitialized pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">prevpipe</span><span class="p">].</span><span class="n">nextpipe</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">nextpipe</span> <span class="o">=</span> <span class="n">nextpipe</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Deal with CHI special case:</span>
<span class="cm">		 * &quot;If transmission on edges 0 or 1 is desired, then cycle n</span>
<span class="cm">		 *  (where n = # of bit times per frame...) must be used.&quot;</span>
<span class="cm">		 *                  - DBRI data sheet, page 11</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prevpipe</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">cycle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cycle</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">chi_bpf</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">D_DTS_VO</span> <span class="o">|</span> <span class="n">D_DTS_INS</span> <span class="o">|</span> <span class="n">D_DTS_PRVOUT</span><span class="p">(</span><span class="n">prevpipe</span><span class="p">)</span> <span class="o">|</span> <span class="n">pipe</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_DTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span>
		    <span class="n">D_TS_LEN</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_TS_CYCLE</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_TS_NEXT</span><span class="p">(</span><span class="n">nextpipe</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">D_DTS_VI</span> <span class="o">|</span> <span class="n">D_DTS_INS</span> <span class="o">|</span> <span class="n">D_DTS_PRVIN</span><span class="p">(</span><span class="n">prevpipe</span><span class="p">)</span> <span class="o">|</span> <span class="n">pipe</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_DTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span>
		    <span class="n">D_TS_LEN</span><span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_TS_CYCLE</span><span class="p">(</span><span class="n">cycle</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_TS_NEXT</span><span class="p">(</span><span class="n">nextpipe</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> * Lock must be held before calling this.</span>
<span class="c"> */</span>
<span class="c">static void unlink_time_slot(struct snd_dbri *dbri, int pipe,</span>
<span class="c">			     enum in_or_out direction, int prevpipe,</span>
<span class="c">			     int nextpipe)</span>
<span class="c">{</span>
<span class="c">	s32 *cmd;</span>
<span class="c">	int val;</span>

<span class="c">	if (pipe &lt; 0 || pipe &gt; DBRI_MAX_PIPE</span>
<span class="c">			|| prevpipe &lt; 0 || prevpipe &gt; DBRI_MAX_PIPE</span>
<span class="c">			|| nextpipe &lt; 0 || nextpipe &gt; DBRI_MAX_PIPE) {</span>
<span class="c">		printk(KERN_ERR</span>
<span class="c">		    &quot;DBRI: unlink_time_slot called with illegal pipe number\n&quot;);</span>
<span class="c">		return;</span>
<span class="c">	}</span>

<span class="c">	cmd = dbri_cmdlock(dbri, 4);</span>

<span class="c">	if (direction == PIPEinput) {</span>
<span class="c">		val = D_DTS_VI | D_DTS_DEL | D_DTS_PRVIN(prevpipe) | pipe;</span>
<span class="c">		*(cmd++) = DBRI_CMD(D_DTS, 0, val);</span>
<span class="c">		*(cmd++) = D_TS_NEXT(nextpipe);</span>
<span class="c">		*(cmd++) = 0;</span>
<span class="c">	} else {</span>
<span class="c">		val = D_DTS_VO | D_DTS_DEL | D_DTS_PRVOUT(prevpipe) | pipe;</span>
<span class="c">		*(cmd++) = DBRI_CMD(D_DTS, 0, val);</span>
<span class="c">		*(cmd++) = 0;</span>
<span class="c">		*(cmd++) = D_TS_NEXT(nextpipe);</span>
<span class="c">	}</span>
<span class="c">	*(cmd++) = DBRI_CMD(D_PAUSE, 0, 0);</span>

<span class="c">	dbri_cmdsend(dbri, cmd, 4);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* xmit_fixed() / recv_fixed()</span>
<span class="cm"> *</span>
<span class="cm"> * Transmit/receive data on a &quot;fixed&quot; pipe - i.e, one whose contents are not</span>
<span class="cm"> * expected to change much, and which we don&#39;t need to buffer.</span>
<span class="cm"> * The DBRI only interrupts us when the data changes (receive pipes),</span>
<span class="cm"> * or only changes the data when this function is called (transmit pipes).</span>
<span class="cm"> * Only short pipes (numbers 16-31) can be used in fixed data mode.</span>
<span class="cm"> *</span>
<span class="cm"> * These function operate on a 32-bit field, no matter how large</span>
<span class="cm"> * the actual time slot is.  The interrupt handler takes care of bit</span>
<span class="cm"> * ordering and alignment.  An 8-bit time slot will always end up</span>
<span class="cm"> * in the low-order 8 bits, filled either MSB-first or LSB-first,</span>
<span class="cm"> * depending on the settings passed to setup_pipe().</span>
<span class="cm"> *</span>
<span class="cm"> * Lock must not be held before calling it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmit_fixed</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: xmit_fixed: Illegal pipe number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D_SDP_MODE</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: xmit_fixed: &quot;</span>
			<span class="s">&quot;Uninitialized pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D_SDP_MODE</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">D_SDP_FIXED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: xmit_fixed: Non-fixed pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: xmit_fixed: Called on receive pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DBRI short pipes always transmit LSB first */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_MSB</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">reverse_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_SSP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">dbri_cmdwait</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recv_fixed</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">__u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">||</span> <span class="n">pipe</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_PIPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: recv_fixed called with &quot;</span>
			<span class="s">&quot;illegal pipe number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">D_SDP_MODE</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">D_SDP_FIXED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: recv_fixed called on &quot;</span>
			<span class="s">&quot;non-fixed pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: recv_fixed called on &quot;</span>
			<span class="s">&quot;transmit pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">recv_fixed_ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup_descs()</span>
<span class="cm"> *</span>
<span class="cm"> * Setup transmit/receive data on a &quot;long&quot; pipe - i.e, one associated</span>
<span class="cm"> * with a DMA buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Only pipe numbers 0-15 can be used in this mode.</span>
<span class="cm"> *</span>
<span class="cm"> * This function takes a stream number pointing to a data buffer,</span>
<span class="cm"> * and work by building chains of descriptors which identify the</span>
<span class="cm"> * data buffers.  Buffers too large for a single descriptor will</span>
<span class="cm"> * be spread across multiple descriptors.</span>
<span class="cm"> *</span>
<span class="cm"> * All descriptors create a ring buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * Lock must be held before calling this.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_descs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">streamno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">streamno</span><span class="p">];</span>
	<span class="n">__u32</span> <span class="n">dvma_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_descs: Illegal pipe number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_descs: Uninitialized pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dvma_buffer</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">streamno</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_descs: &quot;</span>
				<span class="s">&quot;Called on receive pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			    <span class="s">&quot;DBRI: setup_descs: Called on transmit pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Should be able to queue multiple buffers</span>
<span class="cm">		 * to receive on a pipe</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_active</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: recv_on_pipe: &quot;</span>
				<span class="s">&quot;Called on active pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure buffer size is multiple of four */</span>
		<span class="n">len</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free descriptors if pipe has any */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">ba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">nda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">desc</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">desc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
			 <span class="n">desc</span> <span class="o">!=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span><span class="p">);</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mylen</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">desc</span> <span class="o">&lt;</span> <span class="n">DBRI_NO_DESCS</span><span class="p">;</span> <span class="n">desc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">ba</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="n">DBRI_NO_DESCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_descs: No descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">DBRI_TD_MAXCNT</span><span class="p">)</span>
			<span class="n">mylen</span> <span class="o">=</span> <span class="n">DBRI_TD_MAXCNT</span><span class="p">;</span>	<span class="cm">/* 8KB - 4 */</span>
		<span class="k">else</span>
			<span class="n">mylen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mylen</span> <span class="o">&gt;</span> <span class="n">period</span><span class="p">)</span>
			<span class="n">mylen</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>

		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">desc</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">ba</span> <span class="o">=</span> <span class="n">dvma_buffer</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">nda</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">streamno</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word1</span> <span class="o">=</span> <span class="n">DBRI_TD_CNT</span><span class="p">(</span><span class="n">mylen</span><span class="p">);</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word1</span> <span class="o">|=</span> <span class="n">DBRI_TD_F</span> <span class="o">|</span> <span class="n">DBRI_TD_B</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word4</span> <span class="o">=</span>
			    <span class="n">DBRI_RD_B</span> <span class="o">|</span> <span class="n">DBRI_RD_BCNT</span><span class="p">(</span><span class="n">mylen</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">first_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">last_desc</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">last_desc</span><span class="p">].</span><span class="n">nda</span> <span class="o">=</span>
			    <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span> <span class="n">dbri_dma_off</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">last_desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">dvma_buffer</span> <span class="o">+=</span> <span class="n">mylen</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">mylen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">last_desc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: setup_descs: &quot;</span>
			<span class="s">&quot; Not enough descriptors available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">last_desc</span><span class="p">].</span><span class="n">nda</span> <span class="o">=</span>
	    <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span> <span class="n">dbri_dma_off</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">first_desc</span><span class="p">);</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">last_desc</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_desc</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span> <span class="o">=</span> <span class="n">first_desc</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">first_desc</span><span class="p">;</span>

<span class="cp">#ifdef DBRI_DEBUG</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">desc</span> <span class="o">=</span> <span class="n">first_desc</span><span class="p">;</span> <span class="n">desc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_DESC</span><span class="p">,</span> <span class="s">&quot;DESC %d: %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">desc</span><span class="p">,</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word1</span><span class="p">,</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">ba</span><span class="p">,</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">nda</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">desc</span><span class="p">].</span><span class="n">word4</span><span class="p">);</span>
			<span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">desc</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="n">first_desc</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">************************** DBRI - CHI interface ****************************</span>
<span class="cm">****************************************************************************</span>

<span class="cm">The CHI is a four-wire (clock, frame sync, data in, data out) time-division</span>
<span class="cm">multiplexed serial interface which the DBRI can operate in either master</span>
<span class="cm">(give clock/frame sync) or slave (take clock/frame sync) mode.</span>

<span class="cm">*/</span>

<span class="k">enum</span> <span class="n">master_or_slave</span> <span class="p">{</span> <span class="n">CHImaster</span><span class="p">,</span> <span class="n">CHIslave</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Lock must not be held before calling it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_chi</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span>
		      <span class="k">enum</span> <span class="n">master_or_slave</span> <span class="n">master_or_slave</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">bits_per_frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Set CHI Anchor: Pipe 16 */</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">D_DTS_VO</span> <span class="o">|</span> <span class="n">D_DTS_VI</span> <span class="o">|</span> <span class="n">D_DTS_INS</span>
		<span class="o">|</span> <span class="n">D_DTS_PRVIN</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_PIPE</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_DTS_PRVOUT</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_DTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">D_TS_ANCHOR</span> <span class="o">|</span> <span class="n">D_TS_NEXT</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">D_TS_ANCHOR</span> <span class="o">|</span> <span class="n">D_TS_NEXT</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="mi">16</span><span class="p">].</span><span class="n">sdp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="mi">16</span><span class="p">].</span><span class="n">nextpipe</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master_or_slave</span> <span class="o">==</span> <span class="n">CHIslave</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup DBRI for CHI Slave - receive clock, frame sync (FS)</span>
<span class="cm">		 *</span>
<span class="cm">		 * CHICM  = 0 (slave mode, 8 kHz frame rate)</span>
<span class="cm">		 * IR     = give immediate CHI status interrupt</span>
<span class="cm">		 * EN     = give CHI status interrupt upon change</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_CHI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D_CHI_CHICM</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Setup DBRI for CHI Master - generate clock, FS</span>
<span class="cm">		 *</span>
<span class="cm">		 * BPF				=  bits per 8 kHz frame</span>
<span class="cm">		 * 12.288 MHz / CHICM_divisor	= clock rate</span>
<span class="cm">		 * FD = 1 - drive CHIFS on rising edge of CHICK</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">clockrate</span> <span class="o">=</span> <span class="n">bits_per_frame</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">divisor</span> <span class="o">=</span> <span class="mi">12288</span> <span class="o">/</span> <span class="n">clockrate</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;</span> <span class="mi">255</span> <span class="o">||</span> <span class="n">divisor</span> <span class="o">*</span> <span class="n">clockrate</span> <span class="o">!=</span> <span class="mi">12288</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: illegal bits_per_frame &quot;</span>
				<span class="s">&quot;in setup_chi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_CHI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D_CHI_CHICM</span><span class="p">(</span><span class="n">divisor</span><span class="p">)</span> <span class="o">|</span> <span class="n">D_CHI_FD</span>
				    <span class="o">|</span> <span class="n">D_CHI_BPF</span><span class="p">(</span><span class="n">bits_per_frame</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">chi_bpf</span> <span class="o">=</span> <span class="n">bits_per_frame</span><span class="p">;</span>

	<span class="cm">/* CHI Data Mode</span>
<span class="cm">	 *</span>
<span class="cm">	 * RCE   =  0 - receive on falling edge of CHICK</span>
<span class="cm">	 * XCE   =  1 - transmit on rising edge of CHICK</span>
<span class="cm">	 * XEN   =  1 - enable transmitter</span>
<span class="cm">	 * REN   =  1 - enable receiver</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_CDM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">D_CDM_XCE</span> <span class="o">|</span> <span class="n">D_CDM_XEN</span> <span class="o">|</span> <span class="n">D_CDM_REN</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_PAUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">*********************** CS4215 audio codec management **********************</span>
<span class="cm">****************************************************************************</span>

<span class="cm">In the standard SPARC audio configuration, the CS4215 codec is attached</span>
<span class="cm">to the DBRI via the CHI interface and few of the DBRI&#39;s PIO pins.</span>

<span class="cm"> * Lock must not be held before calling it.</span>

<span class="cm">*/</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">void</span> <span class="nf">cs4215_setup_pipes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Data mode:</span>
<span class="cm">	 * Pipe  4: Send timeslots 1-4 (audio data)</span>
<span class="cm">	 * Pipe 20: Send timeslots 5-8 (part of ctrl data)</span>
<span class="cm">	 * Pipe  6: Receive timeslots 1-4 (audio data)</span>
<span class="cm">	 * Pipe 21: Receive timeslots 6-7. We can only receive 20 bits via</span>
<span class="cm">	 *          interrupt, and the rest of the data (slot 5 and 8) is</span>
<span class="cm">	 *          not relevant for us (only for doublechecking).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Control mode:</span>
<span class="cm">	 * Pipe 17: Send timeslots 1-4 (slots 5-8 are read only)</span>
<span class="cm">	 * Pipe 18: Receive timeslot 1 (clb).</span>
<span class="cm">	 * Pipe 19: Receive timeslot 7 (version).</span>
<span class="cm">	 */</span>

	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">D_SDP_MEM</span> <span class="o">|</span> <span class="n">D_SDP_TO_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>
	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">D_SDP_FIXED</span> <span class="o">|</span> <span class="n">D_SDP_TO_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>
	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">D_SDP_MEM</span> <span class="o">|</span> <span class="n">D_SDP_FROM_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>
	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">D_SDP_FIXED</span> <span class="o">|</span> <span class="n">D_SDP_FROM_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>

	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">D_SDP_FIXED</span> <span class="o">|</span> <span class="n">D_SDP_TO_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>
	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="n">D_SDP_FIXED</span> <span class="o">|</span> <span class="n">D_SDP_FROM_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>
	<span class="n">setup_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="n">D_SDP_FIXED</span> <span class="o">|</span> <span class="n">D_SDP_FROM_SER</span> <span class="o">|</span> <span class="n">D_SDP_MSB</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dbri_cmdwait</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">cs4215_init_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">cs4215</span> <span class="o">*</span><span class="n">mm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * No action, memory resetting only.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Data Time Slot 5-8</span>
<span class="cm">	 * Speaker,Line and Headphone enable. Gain set to the half.</span>
<span class="cm">	 * Input is mike.</span>
<span class="cm">	 */</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_LO</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> <span class="n">CS4215_HE</span> <span class="o">|</span> <span class="n">CS4215_LE</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_RO</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> <span class="n">CS4215_SE</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_LG</span><span class="p">(</span><span class="mh">0x8</span><span class="p">)</span> <span class="o">|</span> <span class="n">CS4215_IS</span> <span class="o">|</span> <span class="n">CS4215_PIO0</span> <span class="o">|</span> <span class="n">CS4215_PIO1</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_RG</span><span class="p">(</span><span class="mh">0x8</span><span class="p">)</span> <span class="o">|</span> <span class="n">CS4215_MA</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Control Time Slot 1-4</span>
<span class="cm">	 * 0: Default I/O voltage scale</span>
<span class="cm">	 * 1: 8 bit ulaw, 8kHz, mono, high pass filter disabled</span>
<span class="cm">	 * 2: Serial enable, CHI master, 128 bits per frame, clock 1</span>
<span class="cm">	 * 3: Tests disabled</span>
<span class="cm">	 */</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_RSRVD_1</span> <span class="o">|</span> <span class="n">CS4215_MLB</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_DFR_ULAW</span> <span class="o">|</span> <span class="n">CS4215_FREQ</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">csval</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_XCLK</span> <span class="o">|</span> <span class="n">CS4215_BSEL_128</span> <span class="o">|</span> <span class="n">CS4215_FREQ</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">xtal</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* For ULAW */</span>
	<span class="n">mm</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs4215_setdata</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">muted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">muted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">63</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Start by setting the playback attenuation. */</span>
		<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_PLAY</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">left_gain</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">left_gain</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">right_gain</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">right_gain</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">;</span>	<span class="cm">/* Reset the volume bits */</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DBRI_MAX_VOLUME</span> <span class="o">-</span> <span class="n">left_gain</span><span class="p">);</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">DBRI_MAX_VOLUME</span> <span class="o">-</span> <span class="n">right_gain</span><span class="p">);</span>

		<span class="cm">/* Now set the recording gain. */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_REC</span><span class="p">];</span>
		<span class="n">left_gain</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">left_gain</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">right_gain</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">right_gain</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS4215_LG</span><span class="p">(</span><span class="n">left_gain</span><span class="p">);</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS4215_RG</span><span class="p">(</span><span class="n">right_gain</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xmit_fixed</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the CS4215 to data mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs4215_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;cs4215_open: %d channels, %d bits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">precision</span><span class="p">);</span>

	<span class="cm">/* Temporarily mute outputs, and wait 1/8000 sec (125 us)</span>
<span class="cm">	 * to make sure this takes.  This avoids clicking noises.</span>
<span class="cm">	 */</span>

	<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Data mode:</span>
<span class="cm">	 * Pipe  4: Send timeslots 1-4 (audio data)</span>
<span class="cm">	 * Pipe 20: Send timeslots 5-8 (part of ctrl data)</span>
<span class="cm">	 * Pipe  6: Receive timeslots 1-4 (audio data)</span>
<span class="cm">	 * Pipe 21: Receive timeslots 6-7. We can only receive 20 bits via</span>
<span class="cm">	 *          interrupt, and the rest of the data (slot 5 and 8) is</span>
<span class="cm">	 *          not relevant for us (only for doublechecking).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Just like in control mode, the time slots are all offset by eight</span>
<span class="cm">	 * bits.  The CS4215, it seems, observes TSIN (the delayed signal)</span>
<span class="cm">	 * even if it&#39;s the CHI master.  Don&#39;t ask me...</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">D_C</span><span class="p">);</span>		<span class="cm">/* Disable CHI */</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>

	<span class="cm">/* Switch CS4215 to data mode - set PIO3 to 1 */</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">D_ENPIO</span> <span class="o">|</span> <span class="n">D_PIO1</span> <span class="o">|</span> <span class="n">D_PIO3</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">onboard</span> <span class="o">?</span> <span class="n">D_PIO0</span> <span class="o">:</span> <span class="n">D_PIO2</span><span class="p">),</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>

	<span class="n">reset_chi</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">CHIslave</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

	<span class="cm">/* Note: this next doesn&#39;t work for 8-bit stereo, because the two</span>
<span class="cm">	 * channels would be on timeslots 1 and 3, with 2 and 4 idle.</span>
<span class="cm">	 * (See CS4215 datasheet Fig 15)</span>
<span class="cm">	 *</span>
<span class="cm">	 * DBRI non-contiguous mode would be required to make this work.</span>
<span class="cm">	 */</span>
	<span class="n">data_width</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">channels</span> <span class="o">*</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">precision</span><span class="p">;</span>

	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">data_width</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">data_width</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">40</span><span class="p">);</span>

	<span class="cm">/* FIXME: enable CHI after _setdata? */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">D_C</span><span class="p">;</span>		<span class="cm">/* Enable CHI */</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send the control information (i.e. audio format)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4215_setctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* FIXME - let the CPU do something useful during these delays */</span>

	<span class="cm">/* Temporarily mute outputs, and wait 1/8000 sec (125 us)</span>
<span class="cm">	 * to make sure this takes.  This avoids clicking noises.</span>
<span class="cm">	 */</span>
	<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable Control mode: Set DBRI&#39;s PIO3 (4215&#39;s D/~C) to 0, then wait</span>
<span class="cm">	 * 12 cycles &lt;= 12/(5512.5*64) sec = 34.01 usec</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">D_ENPIO</span> <span class="o">|</span> <span class="n">D_PIO1</span> <span class="o">|</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">onboard</span> <span class="o">?</span> <span class="n">D_PIO0</span> <span class="o">:</span> <span class="n">D_PIO2</span><span class="p">);</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;cs4215_setctrl: reg2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">34</span><span class="p">);</span>

	<span class="cm">/* In Control mode, the CS4215 is a slave device, so the DBRI must</span>
<span class="cm">	 * operate as CHI master, supplying clocking and frame synchronization.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In Data mode, however, the CS4215 must be CHI master to insure</span>
<span class="cm">	 * that its data stream is synchronous with its codec.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The upshot of all this?  We start by putting the DBRI into master</span>
<span class="cm">	 * mode, program the CS4215 in Control mode, then switch the CS4215</span>
<span class="cm">	 * into Data mode and put the DBRI into slave mode.  Various timing</span>
<span class="cm">	 * requirements must be observed along the way.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Oh, and one more thing, on a SPARCStation 20 (and maybe</span>
<span class="cm">	 * others?), the addressing of the CS4215&#39;s time slots is</span>
<span class="cm">	 * offset by eight bits, so we add eight to all the &quot;cycle&quot;</span>
<span class="cm">	 * values in the Define Time Slot (DTS) commands.  This is</span>
<span class="cm">	 * done in hardware by a TI 248 that delays the DBRI-&gt;4215</span>
<span class="cm">	 * frame sync signal by eight clock cycles.  Anybody know why?</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">D_C</span><span class="p">;</span>		<span class="cm">/* Disable CHI */</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>

	<span class="n">reset_chi</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">CHImaster</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Control mode:</span>
<span class="cm">	 * Pipe 17: Send timeslots 1-4 (slots 5-8 are read only)</span>
<span class="cm">	 * Pipe 18: Receive timeslot 1 (clb).</span>
<span class="cm">	 * Pipe 19: Receive timeslot 7 (version).</span>
<span class="cm">	 */</span>

	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">link_time_slot</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Wait for the chip to echo back CLB (Control Latch Bit) as zero */</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CS4215_CLB</span><span class="p">;</span>
	<span class="n">xmit_fixed</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">D_C</span><span class="p">;</span>		<span class="cm">/* Enable CHI */</span>
	<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="p">((</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xe4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">);</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;CS4215 didn&#39;t respond to CLB (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable changes to our copy of the version number, as we are about</span>
<span class="cm">	 * to leave control mode.</span>
<span class="cm">	 */</span>
	<span class="n">recv_fixed</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Terminate CS4215 control mode - data sheet says</span>
<span class="cm">	 * &quot;Set CLB=1 and send two more frames of valid control info&quot;</span>
<span class="cm">	 */</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS4215_CLB</span><span class="p">;</span>
	<span class="n">xmit_fixed</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Two frames of control info @ 8kHz frame rate = 250 us delay */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

	<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the codec with the sampling rate, audio format and number of</span>
<span class="cm"> * channels.</span>
<span class="cm"> * As part of the process we resend the settings for the data</span>
<span class="cm"> * timeslots as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cs4215_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
			  <span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">freq_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Lookup index for this rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">freq_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">CS4215_FREQ</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">freq_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CS4215_FREQ</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">].</span><span class="n">freq</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CS4215_FREQ</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DBRI: Unsupported rate %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_MU_LAW</span>:
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_DFR_ULAW</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span>:
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_DFR_ALAW</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U8</span>:
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_DFR_LINEAR8</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_DFR_LINEAR16</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;DBRI: Unsupported format %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Add rate parameters */</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS4215_FREQ</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">].</span><span class="n">csval</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CS4215_XCLK</span> <span class="o">|</span>
	    <span class="n">CS4215_BSEL_128</span> <span class="o">|</span> <span class="n">CS4215_FREQ</span><span class="p">[</span><span class="n">freq_idx</span><span class="p">].</span><span class="n">xtal</span><span class="p">;</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CS4215_DFR_STEREO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cs4215_setctrl</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cs4215_open</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>	<span class="cm">/* set codec to data mode */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">int</span> <span class="nf">cs4215_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;cs4215_init: reg2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg2</span><span class="p">);</span>

	<span class="cm">/* Look for the cs4215 chips */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="n">D_PIO2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;Onboard CS4215 detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">onboard</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="n">D_PIO0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;Speakerbox detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">onboard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="n">D_PIO2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;DBRI: Using speakerbox / &quot;</span>
			       <span class="s">&quot;ignoring onboard mmcodec.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="n">D_ENPIO2</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">D_PIO0</span> <span class="o">|</span> <span class="n">D_PIO2</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: no mmcodec found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cs4215_setup_pipes</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
	<span class="n">cs4215_init_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">);</span>

	<span class="cm">/* Enable capture of the status &amp; version timeslots. */</span>
	<span class="n">recv_fixed</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">recv_fixed</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">onboard</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs4215_setctrl</span><span class="p">(</span><span class="n">dbri</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">version</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;CS4215 failed probe at offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_MM</span><span class="p">,</span> <span class="s">&quot;Found CS4215 at offset %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">*************************** DBRI interrupt handler *************************</span>
<span class="cm">****************************************************************************</span>

<span class="cm">The DBRI communicates with the CPU mainly via a circular interrupt</span>
<span class="cm">buffer.  When an interrupt is signaled, the CPU walks through the</span>
<span class="cm">buffer and calls dbri_process_one_interrupt() for each interrupt word.</span>
<span class="cm">Complicated interrupts are handled by dedicated functions (which</span>
<span class="cm">appear first in this file).  Any pending interrupts can be serviced by</span>
<span class="cm">calling dbri_process_interrupt_buffer(), which works even if the CPU&#39;s</span>
<span class="cm">interrupts are disabled.</span>

<span class="cm">*/</span>

<span class="cm">/* xmit_descs()</span>
<span class="cm"> *</span>
<span class="cm"> * Starts transmitting the current TD&#39;s for recording/playing.</span>
<span class="cm"> * For playback, ALSA has filled the DMA memory with new data (we hope).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xmit_descs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_td</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* Disabled */</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_REC</span><span class="p">];</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_td</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_DESC</span><span class="p">,</span> <span class="s">&quot;xmit_descs rec @ TD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">first_td</span><span class="p">);</span>

		<span class="cm">/* Stream could be closed by the time we run. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_td</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_SDP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span>
					    <span class="o">|</span> <span class="n">D_SDP_P</span> <span class="o">|</span> <span class="n">D_SDP_EVERY</span> <span class="o">|</span> <span class="n">D_SDP_C</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span>
				   <span class="n">dbri_dma_off</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">first_td</span><span class="p">);</span>
			<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* Reset our admin of the pipe. */</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">first_td</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_PLAY</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_td</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">first_desc</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_DESC</span><span class="p">,</span> <span class="s">&quot;xmit_descs play @ TD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">first_td</span><span class="p">);</span>

		<span class="cm">/* Stream could be closed by the time we run. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first_td</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">dbri_cmdlock</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">DBRI_CMD</span><span class="p">(</span><span class="n">D_SDP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">sdp</span>
					    <span class="o">|</span> <span class="n">D_SDP_P</span> <span class="o">|</span> <span class="n">D_SDP_EVERY</span> <span class="o">|</span> <span class="n">D_SDP_C</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">cmd</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span> <span class="o">+</span>
				   <span class="n">dbri_dma_off</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">first_td</span><span class="p">);</span>
			<span class="n">dbri_cmdsend</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="cm">/* Reset our admin of the pipe. */</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">first_td</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* transmission_complete_intr()</span>
<span class="cm"> *</span>
<span class="cm"> * Called by main interrupt handler when DBRI signals transmission complete</span>
<span class="cm"> * on a pipe (interrupt triggered by the B bit in a transmit descriptor).</span>
<span class="cm"> *</span>
<span class="cm"> * Walks through the pipe&#39;s list of transmit buffer descriptors and marks</span>
<span class="cm"> * them as available. Stops when the first descriptor is found without</span>
<span class="cm"> * TBC (Transmit Buffer Complete) set, or we&#39;ve run through them all.</span>
<span class="cm"> *</span>
<span class="cm"> * The DMA buffers are not released. They form a ring buffer and</span>
<span class="cm"> * they are filled by ALSA while others are transmitted by DMA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">transmission_complete_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_PLAY</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">td</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">td</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">td</span> <span class="o">&gt;=</span> <span class="n">DBRI_NO_DESCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: invalid td on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">DBRI_TD_STATUS</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">td</span><span class="p">].</span><span class="n">word4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DBRI_TD_TBC</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_INT</span><span class="p">,</span> <span class="s">&quot;TD %d, status 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">td</span><span class="p">].</span><span class="n">word4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Reset it for next time. */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">DBRI_RD_CNT</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">td</span><span class="p">].</span><span class="n">word1</span><span class="p">);</span>

		<span class="n">td</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">td</span><span class="p">];</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Notify ALSA */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reception_complete_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rd</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rd</span> <span class="o">&gt;=</span> <span class="n">DBRI_NO_DESCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: invalid rd on pipe %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">].</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">next_desc</span><span class="p">[</span><span class="n">rd</span><span class="p">];</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">rd</span><span class="p">].</span><span class="n">word1</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">[</span><span class="n">rd</span><span class="p">].</span><span class="n">word1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Reset it for next time. */</span>

	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">DBRI_REC</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+=</span> <span class="n">DBRI_RD_CNT</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* FIXME: Check status */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_INT</span><span class="p">,</span> <span class="s">&quot;Recv RD %d, status 0x%02x, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rd</span><span class="p">,</span> <span class="n">DBRI_RD_STATUS</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">DBRI_RD_CNT</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/* Notify ALSA */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_process_one_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">D_INTR_GETVAL</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">D_INTR_GETCHAN</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">command</span> <span class="o">=</span> <span class="n">D_INTR_GETCMD</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">code</span> <span class="o">=</span> <span class="n">D_INTR_GETCODE</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="cp">#ifdef DBRI_DEBUG</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">D_INTR_GETRVAL</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">D_INTR_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_CMD</span><span class="p">,</span> <span class="s">&quot;INTR: Command: %-5s  Value:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmds</span><span class="p">[</span><span class="n">command</span><span class="p">],</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_INT</span><span class="p">,</span> <span class="s">&quot;INTR: Chan:%d Code:%d Val:%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">rval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">D_INTR_CMDI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">!=</span> <span class="n">D_WAIT</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: Command read interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">D_INTR_BRDY</span>:
		<span class="n">reception_complete_intr</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">D_INTR_XCMP</span>:
	<span class="k">case</span> <span class="n">D_INTR_MINT</span>:
		<span class="n">transmission_complete_intr</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">D_INTR_UNDR</span>:
		<span class="cm">/* UNDR - Transmission underrun</span>
<span class="cm">		 * resend SDP command with clear pipe bit (C) set</span>
<span class="cm">		 */</span>
		<span class="p">{</span>
	<span class="cm">/* FIXME: do something useful in case of underrun */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: Underrun error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			s32 *cmd;</span>
<span class="c">			int pipe = channel;</span>
<span class="c">			int td = dbri-&gt;pipes[pipe].desc;</span>

<span class="c">			dbri-&gt;dma-&gt;desc[td].word4 = 0;</span>
<span class="c">			cmd = dbri_cmdlock(dbri, NoGetLock);</span>
<span class="c">			*(cmd++) = DBRI_CMD(D_SDP, 0,</span>
<span class="c">					    dbri-&gt;pipes[pipe].sdp</span>
<span class="c">					    | D_SDP_P | D_SDP_C | D_SDP_2SAME);</span>
<span class="c">			*(cmd++) = dbri-&gt;dma_dvma + dbri_dma_off(desc, td);</span>
<span class="c">			dbri_cmdsend(dbri, cmd);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">D_INTR_FXDT</span>:
		<span class="cm">/* FXDT - Fixed data change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_MSB</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">reverse_bytes</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">recv_fixed_ptr</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">channel</span><span class="p">].</span><span class="n">recv_fixed_ptr</span><span class="p">)</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">D_INTR_CMD</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;DBRI: Ignored Interrupt: %d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* dbri_process_interrupt_buffer advances through the DBRI&#39;s interrupt</span>
<span class="cm"> * buffer until it finds a zero word (indicating nothing more to do</span>
<span class="cm"> * right now).  Non-zero words require processing and are handed off</span>
<span class="cm"> * to dbri_process_one_interrupt AFTER advancing the pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_process_interrupt_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dbri_irqp</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">[</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dbri_irqp</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dbri_irqp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dbri_irqp</span> <span class="o">==</span> <span class="n">DBRI_INT_BLK</span><span class="p">)</span>
			<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dbri_irqp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">dbri_process_one_interrupt</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_dbri_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">errcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read it, so the interrupt goes away.</span>
<span class="cm">	 */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">D_MRR</span> <span class="o">|</span> <span class="n">D_MLE</span> <span class="o">|</span> <span class="n">D_LBG</span> <span class="o">|</span> <span class="n">D_MBE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">D_MRR</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;DBRI: Multiple Error Ack on SBus reg1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">x</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">D_MLE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;DBRI: Multiple Late Error on SBus reg1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">x</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">D_LBG</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;DBRI: Lost Bus Grant on SBus reg1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">D_MBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;DBRI: Burst Error on SBus reg1=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

		<span class="cm">/* Some of these SBus errors cause the chip&#39;s SBus circuitry</span>
<span class="cm">		 * to be disabled, so just re-enable and try to keep going.</span>
<span class="cm">		 *</span>
<span class="cm">		 * The only one I&#39;ve seen is MRR, which will be triggered</span>
<span class="cm">		 * if you let a transmit pipe underrun, then try to CDP it.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If these things persist, we reset the chip.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">errcnt</span><span class="p">)</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">D_INT</span><span class="p">,</span> <span class="s">&quot;Interrupt errors exceeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dbri_reset</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">D_D</span><span class="p">);</span>
			<span class="n">sbus_writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbri_process_interrupt_buffer</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">		PCM Interface</span>
<span class="cm">****************************************************************************/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_dbri_pcm_hw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>		<span class="o">=</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_INFO_BATCH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">formats</span>	<span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
			  <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span>		<span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_5512</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>		<span class="o">=</span> <span class="mi">5512</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>		<span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span>	<span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span>	<span class="o">=</span> <span class="n">DBRI_TD_MAXCNT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>		<span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hw_rule_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_mask</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_mask</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="n">snd_mask_any</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="p">.</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_mask_refine</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hw_rule_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_mask</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">hw_param_mask</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">snd_interval_any</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_dbri_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;open audio output.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_dbri_pcm_hw</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			    <span class="n">snd_hw_rule_format</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">,</span>
			    <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_FORMAT</span><span class="p">,</span>
			    <span class="n">snd_hw_rule_channels</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			    <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">cs4215_open</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_dbri_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;close audio output.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_dbri_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set sampling rate, audio format and number of channels */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cs4215_prepare</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
			     <span class="n">params_format</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
			     <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
				<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;malloc_pages failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hw_params can get called multiple times. Only map the DMA once.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DBRI_STREAMNO</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span> <span class="o">=</span>
			<span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span>
				       <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
				       <span class="n">direction</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">direction</span> <span class="o">=</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;hw_params: %d bytes, dvma=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">direction</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_dbri_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;hw_free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* hw_free can get called multiple times. Only unmap the DMA once.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">DBRI_STREAMNO</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">direction</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span><span class="p">,</span>
				 <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">dvma_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_dbri_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">DBRI_STREAMNO</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Send pipe */</span>
	<span class="k">else</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Receive pipe */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Setup the all the transmit/receive descriptors to cover the</span>
<span class="cm">	 * whole DMA buffer.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_descs</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">DBRI_STREAMNO</span><span class="p">(</span><span class="n">substream</span><span class="p">),</span>
			  <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">));</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;prepare audio output. %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_dbri_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;start audio, period is %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">));</span>
		<span class="cm">/* Re-submit the TDs. */</span>
		<span class="n">xmit_descs</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;stop audio.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">reset_pipe</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_dbri_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">DBRI_STREAM</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span>
		<span class="o">%</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_USR</span><span class="p">,</span> <span class="s">&quot;I/O pointer: %ld frames of %ld.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_dbri_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_dbri_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_dbri_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_dbri_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_dbri_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_dbri_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_dbri_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_dbri_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_dbri_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			       <span class="cm">/* ID */</span>		    <span class="s">&quot;sun_dbri&quot;</span><span class="p">,</span>
			       <span class="cm">/* device */</span>	    <span class="mi">0</span><span class="p">,</span>
			       <span class="cm">/* playback count */</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/* capture count */</span>  <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_dbri_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_dbri_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span>
			<span class="n">SNDRV_DMA_TYPE_CONTINUOUS</span><span class="p">,</span>
			<span class="n">snd_dma_continuous_data</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">),</span>
			<span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm">			Mixer interface</span>
<span class="cm">*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4215_info_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">DBRI_MAX_VOLUME</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">DBRI_MAX_GAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4215_get_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dbri</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">];</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">left_gain</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">right_gain</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4215_put_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dbri_streaminfo</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vol</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">==</span> <span class="n">DBRI_PLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_VOLUME</span> <span class="o">||</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_VOLUME</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_GAIN</span> <span class="o">||</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">DBRI_MAX_GAIN</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">left_gain</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">left_gain</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">right_gain</span> <span class="o">!=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">right_gain</span> <span class="o">=</span> <span class="n">vol</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First mute outputs, and wait 1/8000 sec (125 us)</span>
<span class="cm">		 * to make sure this takes.  This avoids clicking noises.</span>
<span class="cm">		 */</span>
		<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
		<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4215_info_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span> <span class="o">:</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4215_get_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dbri</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="n">elem</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">mask</span> <span class="o">-</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cs4215_put_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dbri</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">-</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">elem</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">&amp;</span>
				       <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">elem</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="n">elem</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="n">elem</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span>
					   <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">ctrl</span><span class="p">[</span><span class="n">elem</span> <span class="o">-</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_GEN</span><span class="p">,</span> <span class="s">&quot;put_single: mask=0x%x, changed=%d, &quot;</span>
		<span class="s">&quot;mixer-value=%ld, mm-value=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mask</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">elem</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First mute outputs, and wait 1/8000 sec (125 us)</span>
<span class="cm">		 * to make sure this takes.  This avoids clicking noises.</span>
<span class="cm">		 */</span>
		<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">125</span><span class="p">);</span>
		<span class="n">cs4215_setdata</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Entries 0-3 map to the 4 data timeslots, entries 4-7 map to the 4 control</span>
<span class="cm">   timeslots. Shift is the bit offset in the timeslot, mask defines the</span>
<span class="cm">   number of bits. invert is a boolean for use with attenuation.</span>
<span class="cm"> */</span>
<span class="cp">#define CS4215_SINGLE(xname, entry, shift, mask, invert)	\</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = (xname),		\</span>
<span class="cp">  .info = snd_cs4215_info_single,				\</span>
<span class="cp">  .get = snd_cs4215_get_single, .put = snd_cs4215_put_single,	\</span>
<span class="cp">  .private_value = (entry) | ((shift) &lt;&lt; 8) | ((mask) &lt;&lt; 16) |	\</span>
<span class="cp">			((invert) &lt;&lt; 24) },</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">dbri_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Playback Volume&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">info</span>  <span class="o">=</span> <span class="n">snd_cs4215_info_volume</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">get</span>   <span class="o">=</span> <span class="n">snd_cs4215_get_volume</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">put</span>   <span class="o">=</span> <span class="n">snd_cs4215_put_volume</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">DBRI_PLAY</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;Headphone switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;Line out switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;Speaker switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;Capture Volume&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">info</span>  <span class="o">=</span> <span class="n">snd_cs4215_info_volume</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">get</span>   <span class="o">=</span> <span class="n">snd_cs4215_get_volume</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">put</span>   <span class="o">=</span> <span class="n">snd_cs4215_put_volume</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">DBRI_REC</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="cm">/* FIXME: mic/line switch */</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;Line in switch&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;High Pass Filter switch&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;Monitor Volume&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="n">CS4215_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic boost&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_dbri_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dbri</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dbri_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">dbri</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">DBRI_REC</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">DBRI_NO_STREAMS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">left_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">stream_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">right_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm">			/proc interface</span>
<span class="cm">****************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_regs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;REG0: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG0</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;REG2: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG2</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;REG8: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG8</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;REG9: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">REG9</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifdef DBRI_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbri_debug_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;debug=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dbri_debug</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pipe</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">pipe</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe_active</span><span class="p">(</span><span class="n">dbri</span><span class="p">,</span> <span class="n">pipe</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">dbri_pipe</span> <span class="o">*</span><span class="n">pptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">pipes</span><span class="p">[</span><span class="n">pipe</span><span class="p">];</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
				    <span class="s">&quot;Pipe %d: %s SDP=0x%x desc=%d, &quot;</span>
				    <span class="s">&quot;len=%d next %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pipe</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">pptr</span><span class="o">-&gt;</span><span class="n">sdp</span> <span class="o">&amp;</span> <span class="n">D_SDP_TO_SER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;output&quot;</span> <span class="o">:</span>
								 <span class="s">&quot;input&quot;</span><span class="p">,</span>
				    <span class="n">pptr</span><span class="o">-&gt;</span><span class="n">sdp</span><span class="p">,</span> <span class="n">pptr</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span>
				    <span class="n">pptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">pptr</span><span class="o">-&gt;</span><span class="n">nextpipe</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_dbri_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;regs&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">dbri</span><span class="p">,</span> <span class="n">dbri_regs_read</span><span class="p">);</span>

<span class="cp">#ifdef DBRI_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;debug&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">dbri</span><span class="p">,</span> <span class="n">dbri_debug_read</span><span class="p">);</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">;</span>	<span class="cm">/* Readable only. */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">****************************************************************************</span>
<span class="cm">**************************** Initialization ********************************</span>
<span class="cm">****************************************************************************</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_dbri_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_dbri_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbri_dma</span><span class="p">),</span>
				       <span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbri_dma</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_GEN</span><span class="p">,</span> <span class="s">&quot;DMA Cmd Block 0x%p (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span><span class="p">);</span>

	<span class="cm">/* Map the registers into memory. */</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs_size</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">,</span> <span class="s">&quot;DBRI Registers&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: could not allocate registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbri_dma</span><span class="p">),</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_dbri_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			  <span class="s">&quot;DBRI audio&quot;</span><span class="p">,</span> <span class="n">dbri</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI: Can&#39;t get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbri_dma</span><span class="p">),</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do low level initialization of the DBRI and CS4215 chips */</span>
	<span class="n">dbri_initialize</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cs4215_init</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dbri_free</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_dbri_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">D_GEN</span><span class="p">,</span> <span class="s">&quot;snd_dbri_free</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dbri_reset</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dbri</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">)</span>
		<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbri_dma</span><span class="p">),</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">dma_dvma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dbri_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_dbri</span> <span class="o">*</span><span class="n">dbri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DBRI-%d: No IRQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dbri</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;DBRI&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Sun DBRI&quot;</span><span class="p">);</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%02lx:0x%016Lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">rp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffL</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rp</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_dbri_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbri</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_dbri_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_dbri_mixer</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_err</span><span class="p">;</span>

	<span class="cm">/* /proc file handling */</span>
	<span class="n">snd_dbri_proc</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;audio%d at %p (irq %d) is DBRI(%c)+CS4215(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="p">,</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">,</span>
	       <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">dbri</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_err:</span>
	<span class="n">snd_dbri_free</span><span class="p">(</span><span class="n">dbri</span><span class="p">);</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">dbri_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">snd_dbri_free</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">dbri_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,DBRIe&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;SUNW,DBRIf&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">dbri_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">dbri_sbus_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dbri&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">dbri_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">dbri_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dbri_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">dbri_sbus_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
