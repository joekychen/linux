<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › isa › cmi8330.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>cmi8330.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for C-Media&#39;s CMI8330 and CMI8329 soundcards.</span>
<span class="cm"> *  Copyright (c) by George Talusan &lt;gstalusan@uwaterloo.ca&gt;</span>
<span class="cm"> *    http://www.undergrad.math.uwaterloo.ca/~gstalusa</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * NOTES</span>
<span class="cm"> *</span>
<span class="cm"> *  The extended registers contain mixer settings which are largely</span>
<span class="cm"> *  untapped for the time being.</span>
<span class="cm"> *</span>
<span class="cm"> *  MPU401 and SPDIF are not supported yet.  I don&#39;t have the hardware</span>
<span class="cm"> *  to aid in coding and testing, so I won&#39;t bother.</span>
<span class="cm"> *</span>
<span class="cm"> *  To quickly load the module,</span>
<span class="cm"> *</span>
<span class="cm"> *  modprobe -a snd-cmi8330 sbport=0x220 sbirq=5 sbdma8=1</span>
<span class="cm"> *    sbdma16=5 wssport=0x530 wssirq=11 wssdma=0 fmport=0x388</span>
<span class="cm"> *</span>
<span class="cm"> *  This card has two mixers and two PCM devices.  I&#39;ve cheesed it such</span>
<span class="cm"> *  that recording and playback can be done through the same device.</span>
<span class="cm"> *  The driver &quot;magically&quot; routes the capturing to the AD1848 codec,</span>
<span class="cm"> *  and playback to the SB16 codec.  This allows for full-duplex mode</span>
<span class="cm"> *  to some extent.</span>
<span class="cm"> *  The utilities in alsa-utils are aware of both devices, so passing</span>
<span class="cm"> *  the appropriate parameters to amixer and alsactl will give you</span>
<span class="cm"> *  full control over both mixers.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/isa.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/wss.h&gt;</span>
<span class="cp">#include &lt;sound/opl3.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/sb.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="cm">/* #define ENABLE_SB_MIXER */</span>
<span class="cp">#define PLAYBACK_ON_SB</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;George Talusan &lt;gstalusan@uwaterloo.ca&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;C-Media CMI8330/CMI8329&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{C-Media,CMI8330,isapnp:{CMI0001,@@@0001,@X@0001}}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_ISAPNP</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">isapnp</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">sbport</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sbirq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sbdma8</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_DMA</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sbdma16</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_DMA</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">wssport</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wssirq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wssdma</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_DMA</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">fmport</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">mpuport</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpuirq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for CMI8330/CMI8329 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string  for CMI8330/CMI8329 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable CMI8330/CMI8329 soundcard.&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="s">&quot;PnP detection for specified soundcard.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">sbport</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sbport</span><span class="p">,</span> <span class="s">&quot;Port # for CMI8330/CMI8329 SB driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">sbirq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sbirq</span><span class="p">,</span> <span class="s">&quot;IRQ # for CMI8330/CMI8329 SB driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">sbdma8</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sbdma8</span><span class="p">,</span> <span class="s">&quot;DMA8 for CMI8330/CMI8329 SB driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">sbdma16</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sbdma16</span><span class="p">,</span> <span class="s">&quot;DMA16 for CMI8330/CMI8329 SB driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">wssport</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wssport</span><span class="p">,</span> <span class="s">&quot;Port # for CMI8330/CMI8329 WSS driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">wssirq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wssirq</span><span class="p">,</span> <span class="s">&quot;IRQ # for CMI8330/CMI8329 WSS driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">wssdma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wssdma</span><span class="p">,</span> <span class="s">&quot;DMA for CMI8330/CMI8329 WSS driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">fmport</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fmport</span><span class="p">,</span> <span class="s">&quot;FM port # for CMI8330/CMI8329 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mpuport</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpuport</span><span class="p">,</span> <span class="s">&quot;MPU-401 port # for CMI8330/CMI8329 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mpuirq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpuirq</span><span class="p">,</span> <span class="s">&quot;IRQ # for CMI8330/CMI8329 MPU-401 port.&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isa_registered</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pnp_registered</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define CMI8330_RMUX3D    16</span>
<span class="cp">#define CMI8330_MUTEMUX   17</span>
<span class="cp">#define CMI8330_OUTPUTVOL 18</span>
<span class="cp">#define CMI8330_MASTVOL   19</span>
<span class="cp">#define CMI8330_LINVOL    20</span>
<span class="cp">#define CMI8330_CDINVOL   21</span>
<span class="cp">#define CMI8330_WAVVOL    22</span>
<span class="cp">#define CMI8330_RECMUX    23</span>
<span class="cp">#define CMI8330_WAVGAIN   24</span>
<span class="cp">#define CMI8330_LINGAIN   25</span>
<span class="cp">#define CMI8330_CDINGAIN  26</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">snd_cmi8330_image</span><span class="p">[((</span><span class="n">CMI8330_CDINGAIN</span><span class="p">)</span><span class="o">-</span><span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mh">0x40</span><span class="p">,</span>			<span class="cm">/* 16 - recording mux (SB-mixer-enabled) */</span>
<span class="cp">#ifdef ENABLE_SB_MIXER</span>
	<span class="mh">0x40</span><span class="p">,</span>			<span class="cm">/* 17 - mute mux (Mode2) */</span>
<span class="cp">#else</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 17 - mute mux */</span>
<span class="cp">#endif</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 18 - vol */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 19 - master volume */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 20 - line-in volume */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 21 - cd-in volume */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 22 - wave volume */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 23 - mute/rec mux */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 24 - wave rec gain */</span>
	<span class="mh">0x0</span><span class="p">,</span>			<span class="cm">/* 25 - line-in rec gain */</span>
	<span class="mh">0x0</span>			<span class="cm">/* 26 - cd-in rec gain */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">snd_pcm_open_callback_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">card_type</span> <span class="p">{</span>
	<span class="n">CMI8330</span><span class="p">,</span>
	<span class="n">CMI8329</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">play</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">mpu</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">wss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sb</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330_stream</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">ops</span><span class="p">;</span>
		<span class="n">snd_pcm_open_callback_t</span> <span class="n">open</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">;</span> <span class="cm">/* sb or wss */</span>
	<span class="p">}</span> <span class="n">streams</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">enum</span> <span class="n">card_type</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PNP</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="n">snd_cmi8330_pnpids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;CMI0001&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">devs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;@X@0001&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s">&quot;@@@0001&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s">&quot;@H@0001&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s">&quot;A@@0001&quot;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;CMI0001&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">devs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;@@@0001&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s">&quot;@X@0001&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="s">&quot;@H@0001&quot;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp_card</span><span class="p">,</span> <span class="n">snd_cmi8330_pnpids</span><span class="p">);</span>

<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_cmi8330_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_MASTVOL</span><span class="p">,</span> <span class="n">CMI8330_MASTVOL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;Loud Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CS4231_LEFT_OUTPUT</span><span class="p">,</span> <span class="n">CS4231_RIGHT_OUTPUT</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CS4231_LEFT_OUTPUT</span><span class="p">,</span> <span class="n">CS4231_RIGHT_OUTPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_LINVOL</span><span class="p">,</span> <span class="n">CMI8330_LINVOL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Line Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_LINGAIN</span><span class="p">,</span> <span class="n">CMI8330_LINGAIN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;CD Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;CD Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;CD Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_CDINVOL</span><span class="p">,</span> <span class="n">CMI8330_CDINVOL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;CD Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_CDINGAIN</span><span class="p">,</span> <span class="n">CMI8330_CDINGAIN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_OUTPUTVOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;Mic Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_OUTPUTVOL</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Wavetable Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RECMUX</span><span class="p">,</span> <span class="n">CMI8330_RECMUX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Wavetable Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_WAVVOL</span><span class="p">,</span> <span class="n">CMI8330_WAVVOL</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Wavetable Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RECMUX</span><span class="p">,</span> <span class="n">CMI8330_RECMUX</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;Wavetable Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_WAVGAIN</span><span class="p">,</span> <span class="n">CMI8330_WAVGAIN</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;3D Control - Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="s">&quot;Beep Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_OUTPUTVOL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;FM Playback Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CS4231_AUX2_LEFT_INPUT</span><span class="p">,</span> <span class="n">CS4231_AUX2_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_DOUBLE</span><span class="p">(</span><span class="s">&quot;FM Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CS4231_AUX2_LEFT_INPUT</span><span class="p">,</span> <span class="n">CS4231_AUX2_RIGHT_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Input &quot;</span><span class="p">,</span> <span class="n">CAPTURE</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_RMUX3D</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">WSS_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Input &quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">CMI8330_MUTEMUX</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#ifdef ENABLE_SB_MIXER</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sbmix_elem</span> <span class="n">cmi8330_sb_mixers</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB Master Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_MASTER_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_MASTER_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;Tone Control - Bass&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_BASS_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_BASS_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;Tone Control - Treble&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_TREBLE_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_TREBLE_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB PCM Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_PCM_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_PCM_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB Synth Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_SYNTH_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_SYNTH_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB CD Playback Switch&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_OUTPUT_SW</span><span class="p">,</span> <span class="n">SB_DSP4_OUTPUT_SW</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB CD Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_CD_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_CD_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB Line Playback Switch&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_OUTPUT_SW</span><span class="p">,</span> <span class="n">SB_DSP4_OUTPUT_SW</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB Line Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_LINE_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_LINE_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="n">SB_SINGLE</span><span class="p">(</span><span class="s">&quot;SB Mic Playback Switch&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_OUTPUT_SW</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="n">SB_SINGLE</span><span class="p">(</span><span class="s">&quot;SB Mic Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_MIC_DEV</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span>
<span class="n">SB_SINGLE</span><span class="p">(</span><span class="s">&quot;SB Beep Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_SPEAKER_DEV</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB Capture Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_IGAIN_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_IGAIN_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="n">SB_DOUBLE</span><span class="p">(</span><span class="s">&quot;SB Playback Volume&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_OGAIN_DEV</span><span class="p">,</span> <span class="p">(</span><span class="n">SB_DSP4_OGAIN_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<span class="n">SB_SINGLE</span><span class="p">(</span><span class="s">&quot;SB Mic Auto Gain&quot;</span><span class="p">,</span> <span class="n">SB_DSP4_MIC_AGC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmi8330_sb_init_values</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SB_DSP4_MASTER_DEV</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_MASTER_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_PCM_DEV</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_PCM_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_SYNTH_DEV</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_SYNTH_DEV</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_INPUT_LEFT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_INPUT_RIGHT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_OUTPUT_SW</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">SB_DSP4_SPEAKER_DEV</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">cmi8330_add_sb_mixers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sb</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_sbmixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>		<span class="cm">/* mixer reset */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* mute and zero volume channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmi8330_sb_init_values</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">snd_sbmixer_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cmi8330_sb_init_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">cmi8330_sb_init_values</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmi8330_sb_mixers</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_sbmixer_add_ctl_elem</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmi8330_sb_mixers</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">acard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMI8329</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CMI8329&quot;</span> <span class="o">:</span> <span class="s">&quot;CMI8330/C3D&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_cmi8330_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cmi8330_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
					     <span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef ENABLE_SB_MIXER</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">cmi8330_add_sb_mixers</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_pnp</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">acard</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* CMI8329 has a device with ID A@@0001, CMI8330 does not */</span>
	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="n">CMI8329</span> <span class="o">:</span> <span class="n">CMI8330</span><span class="p">;</span>

	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">pnp_request_card_device</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">play</span> <span class="o">=</span> <span class="n">pnp_request_card_device</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">play</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">mpu</span> <span class="o">=</span> <span class="n">pnp_request_card_device</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">mpu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">acard</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AD1848 PnP configure failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wssport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wssdma</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wssirq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* allocate SB16 resources */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">acard</span><span class="o">-&gt;</span><span class="n">play</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;SB16 PnP configure failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sbport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sbdma8</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sbdma16</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">sbirq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* On CMI8239, the OPL3 port might be present in SB16 PnP resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x388</span><span class="p">;</span>	<span class="cm">/* Or hardwired */</span>
	<span class="p">}</span>

	<span class="cm">/* allocate MPU-401 resources */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">acard</span><span class="o">-&gt;</span><span class="n">mpu</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MPU-401 PnP configure failure: will be disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mpuport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mpuirq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * PCM interface</span>
<span class="cm"> *</span>
<span class="cm"> * since we call the different chip interfaces for playback and capture</span>
<span class="cm"> * directions, we need a trick.</span>
<span class="cm"> *</span>
<span class="cm"> * - copy the ops for each direction into a local record.</span>
<span class="cm"> * - replace the open callback with the new one, which replaces the</span>
<span class="cm"> *   substream-&gt;private_data with the corresponding chip instance</span>
<span class="cm"> *   and calls again the original open callback of the chip.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#ifdef PLAYBACK_ON_SB</span>
<span class="cp">#define CMI_SB_STREAM	SNDRV_PCM_STREAM_PLAYBACK</span>
<span class="cp">#define CMI_AD_STREAM	SNDRV_PCM_STREAM_CAPTURE</span>
<span class="cp">#else</span>
<span class="cp">#define CMI_SB_STREAM	SNDRV_PCM_STREAM_CAPTURE</span>
<span class="cp">#define CMI_AD_STREAM	SNDRV_PCM_STREAM_PLAYBACK</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* replace the private_data and call the original open callback */</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">open</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* replace the private_data and call the original open callback */</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">open</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">snd_pcm_open_callback_t</span> <span class="n">cmi_open_callbacks</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">snd_cmi8330_playback_open</span><span class="p">,</span>
		<span class="n">snd_cmi8330_capture_open</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMI8329</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CMI8329&quot;</span> <span class="o">:</span> <span class="s">&quot;CMI8330&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMI8329</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CMI8329&quot;</span> <span class="o">:</span> <span class="s">&quot;CMI8330&quot;</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	
	<span class="cm">/* SB16 */</span>
	<span class="n">ops</span> <span class="o">=</span> <span class="n">snd_sb16dsp_get_pcm_ops</span><span class="p">(</span><span class="n">CMI_SB_STREAM</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_SB_STREAM</span><span class="p">].</span><span class="n">ops</span> <span class="o">=</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_SB_STREAM</span><span class="p">].</span><span class="n">open</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_SB_STREAM</span><span class="p">].</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cmi_open_callbacks</span><span class="p">[</span><span class="n">CMI_SB_STREAM</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_SB_STREAM</span><span class="p">].</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">;</span>

	<span class="cm">/* AD1848 */</span>
	<span class="n">ops</span> <span class="o">=</span> <span class="n">snd_wss_get_pcm_ops</span><span class="p">(</span><span class="n">CMI_AD_STREAM</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_AD_STREAM</span><span class="p">].</span><span class="n">ops</span> <span class="o">=</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_AD_STREAM</span><span class="p">].</span><span class="n">open</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_AD_STREAM</span><span class="p">].</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">cmi_open_callbacks</span><span class="p">[</span><span class="n">CMI_AD_STREAM</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">CMI_AD_STREAM</span><span class="p">].</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">ops</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_isa_data</span><span class="p">(),</span>
					      <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">acard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">);</span>
	<span class="n">snd_sbmixer_suspend</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">acard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_sbdsp_reset</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">snd_sbmixer_suspend</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">);</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="cp">#define is_isapnp_selected(dev)		isapnp[dev]</span>
<span class="cp">#else</span>
<span class="cp">#define is_isapnp_selected(dev)		0</span>
<span class="cp">#endif</span>

<span class="cp">#define PFX	&quot;cmi8330: &quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_card_new</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">**</span><span class="n">cardp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">acard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_cmi8330</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;could not get a new card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">acard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">acard</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cardp</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_cmi8330</span> <span class="o">*</span><span class="n">acard</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">;</span>

	<span class="n">acard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">wssport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">wssirq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
			     <span class="n">wssdma</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">WSS_HW_DETECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;AD1848 device busy??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">!=</span> <span class="n">WSS_HW_CMI8330</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;AD1848 not found during probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_sbdsp_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sbport</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				    <span class="n">sbirq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				    <span class="n">snd_sb16dsp_interrupt</span><span class="p">,</span>
				    <span class="n">sbdma8</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				    <span class="n">sbdma16</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				    <span class="n">SB_HW_AUTO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">sb</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;SB16 device busy??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">sb</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">!=</span> <span class="n">SB_HW_16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;SB16 not found during probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_wss_out</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">,</span> <span class="n">CS4231_MISC_INFO</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span> <span class="cm">/* switch on MODE2 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">CMI8330_RMUX3D</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">CMI8330_CDINGAIN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_wss_out</span><span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			    <span class="n">snd_cmi8330_image</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">CMI8330_RMUX3D</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cmi8330_mixer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">acard</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to create mixers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cmi8330_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">acard</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;failed to create pcms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_opl3_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				    <span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				    <span class="n">OPL3_HW_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opl3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
				   <span class="s">&quot;no OPL device at 0x%lx-0x%lx ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">fmport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_hwdep_new</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpuport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPU401_HW_MPU401</span><span class="p">,</span>
					<span class="n">mpuport</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mpuirq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
					<span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;no MPU-401 device at 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mpuport</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMI8329</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CMI8329&quot;</span> <span class="o">:</span> <span class="s">&quot;CMI8330/C3D&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="p">(</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMI8329</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;C-Media CMI8329&quot;</span> <span class="o">:</span> <span class="s">&quot;C-Media CMI8330/C3D&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d, dma %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">acard</span><span class="o">-&gt;</span><span class="n">wss</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
		<span class="n">wssirq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
		<span class="n">wssdma</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_isa_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">||</span> <span class="n">is_isapnp_selected</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wssport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;specify wssport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sbport</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;specify sbport</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_isa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_cmi8330_card_new</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_cmi8330_probe</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">snd_cmi8330_isa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">));</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_isa_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span>
				   <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_cmi8330_suspend</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_isa_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_cmi8330_resume</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#define DEV_NAME	&quot;cmi8330&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isa_driver</span> <span class="n">snd_cmi8330_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">snd_cmi8330_isa_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">snd_cmi8330_isa_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_cmi8330_isa_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">snd_cmi8330_isa_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">snd_cmi8330_isa_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DEV_NAME</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_cmi8330_pnp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span><span class="n">pcard</span><span class="p">,</span>
					    <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="o">*</span><span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">dev</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">dev</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">isapnp</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			       
	<span class="n">res</span> <span class="o">=</span> <span class="n">snd_cmi8330_card_new</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">snd_cmi8330_pnp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">pcard</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;PnP detection failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcard</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">snd_cmi8330_probe</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pnp_set_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_cmi8330_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span> <span class="n">pcard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pnp_get_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">));</span>
	<span class="n">pnp_set_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_pnp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span><span class="n">pcard</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_cmi8330_suspend</span><span class="p">(</span><span class="n">pnp_get_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_cmi8330_pnp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span><span class="n">pcard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_cmi8330_resume</span><span class="p">(</span><span class="n">pnp_get_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card_driver</span> <span class="n">cmi8330_pnpc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">PNP_DRIVER_RES_DISABLE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmi8330&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_cmi8330_pnpids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_cmi8330_pnp_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_cmi8330_pnp_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">snd_cmi8330_pnp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">snd_cmi8330_pnp_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alsa_card_cmi8330_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">isa_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cmi8330_driver</span><span class="p">,</span> <span class="n">SNDRV_CARDS</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">isa_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_register_card_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi8330_pnpc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pnp_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isa_registered</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">alsa_card_cmi8330_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_registered</span><span class="p">)</span>
		<span class="n">pnp_unregister_card_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmi8330_pnpc_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isa_registered</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">isa_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_cmi8330_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">alsa_card_cmi8330_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">alsa_card_cmi8330_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
