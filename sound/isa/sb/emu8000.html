<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › isa › sb › emu8000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>emu8000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *     and (c) 1999 Steve Ratcliffe &lt;steve@parabola.demon.co.uk&gt;</span>
<span class="cm"> *  Copyright (C) 1999-2000 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Routines for control of EMU8000 chip</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/emu8000.h&gt;</span>
<span class="cp">#include &lt;sound/emu8000_reg.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * emu8000 register controls</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The following routines read and write registers on the emu8000.  They</span>
<span class="cm"> * should always be called via the EMU8000*READ/WRITE macros and never</span>
<span class="cm"> * directly.  The macros handle the port number and command word.</span>
<span class="cm"> */</span>
<span class="cm">/* Write a word */</span>
<span class="kt">void</span> <span class="nf">snd_emu8000_poke</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">reg</span><span class="p">,</span> <span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">));</span> <span class="cm">/* Set register */</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span> <span class="cm">/* Send data */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read a word */</span>
<span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_emu8000_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">reg</span><span class="p">,</span> <span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">));</span> <span class="cm">/* Set register */</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>	<span class="cm">/* Read data */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write a double word */</span>
<span class="kt">void</span> <span class="nf">snd_emu8000_poke_dw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">reg</span><span class="p">,</span> <span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">));</span> <span class="cm">/* Set register */</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span> <span class="cm">/* Send low word of data */</span>
	<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">val</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">),</span> <span class="n">port</span><span class="o">+</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* Send high word of data */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read a double word */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_emu8000_peek_dw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">low</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">reg</span><span class="p">,</span> <span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">));</span> <span class="cm">/* Set register */</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>	<span class="cm">/* Read low word of data */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">low</span> <span class="o">+</span> <span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">port</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up / close a channel to be used for DMA.</span>
<span class="cm"> */</span>
<span class="cm">/*exported*/</span> <span class="kt">void</span>
<span class="nf">snd_emu8000_dma_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">right_bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">EMU8000_RAM_RIGHT</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x01000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="n">EMU8000_RAM_MODE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EMU8000_RAM_CLOSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EMU8000_CCCA_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_DCYSUSV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x807F</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">EMU8000_DCYSUSV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">EMU8000_VTFT_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_CVCF_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_PTRX_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">);</span>
	<span class="n">EMU8000_CPF_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x40000000</span><span class="p">);</span>
	<span class="n">EMU8000_PSST_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_CSL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">EMU8000_RAM_WRITE</span><span class="p">)</span> <span class="cm">/* DMA write */</span>
		<span class="n">EMU8000_CCCA_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x06000000</span> <span class="o">|</span> <span class="n">right_bit</span><span class="p">);</span>
	<span class="k">else</span>	   <span class="cm">/* DMA read */</span>
		<span class="n">EMU8000_CCCA_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x04000000</span> <span class="o">|</span> <span class="n">right_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu8000_read_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">EMU8000_SMALR_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu8000_write_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">EMU8000_SMALW_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * detect a card at the given port</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_emu8000_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Initialise */</span>
	<span class="n">EMU8000_HWCF1_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF2_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="cm">/* Check for a recognisable emu8000 */</span>
	<span class="cm">/*</span>
<span class="cm">	if ((EMU8000_U1_READ(emu) &amp; 0x000f) != 0x000c)</span>
<span class="cm">		return -ENODEV;</span>
<span class="cm">		*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">EMU8000_HWCF1_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x007e</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0058</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">EMU8000_HWCF2_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0003</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;EMU8000 [0x%lx]: Synth chip found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">emu</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * intiailize audio channels</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">init_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="cm">/* turn off envelope engines */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">EMU8000_CHANNELS</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="n">EMU8000_DCYSUSV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
  
	<span class="cm">/* reset all other parameters to zero */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">EMU8000_CHANNELS</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EMU8000_ENVVOL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_ENVVAL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_DCYSUS_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_ATKHLDV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_LFO1VAL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_ATKHLD_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_LFO2VAL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_IP_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_IFATN_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_PEFE_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_FMMOD_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_TREMFRQ_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_FM2FRQ2_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_PTRX_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_VTFT_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_PSST_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_CSL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_CCCA_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">EMU8000_CHANNELS</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EMU8000_CPF_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">EMU8000_CVCF_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * initialize DMA address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">EMU8000_SMALR_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_SMARR_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_SMALW_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_SMARW_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialization arrays; from ADIP</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">init1</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="cm">/*__devinitdata*/</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x03ff</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span>  <span class="mh">0x07ff</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">,</span> <span class="mh">0x0bff</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">,</span>  <span class="mh">0x0fff</span><span class="p">,</span> <span class="mh">0x0330</span><span class="p">,</span>
	<span class="mh">0x13ff</span><span class="p">,</span> <span class="mh">0x0430</span><span class="p">,</span>  <span class="mh">0x17ff</span><span class="p">,</span> <span class="mh">0x0530</span><span class="p">,</span> <span class="mh">0x1bff</span><span class="p">,</span> <span class="mh">0x0630</span><span class="p">,</span>  <span class="mh">0x1fff</span><span class="p">,</span> <span class="mh">0x0730</span><span class="p">,</span>
	<span class="mh">0x23ff</span><span class="p">,</span> <span class="mh">0x0830</span><span class="p">,</span>  <span class="mh">0x27ff</span><span class="p">,</span> <span class="mh">0x0930</span><span class="p">,</span> <span class="mh">0x2bff</span><span class="p">,</span> <span class="mh">0x0a30</span><span class="p">,</span>  <span class="mh">0x2fff</span><span class="p">,</span> <span class="mh">0x0b30</span><span class="p">,</span>
	<span class="mh">0x33ff</span><span class="p">,</span> <span class="mh">0x0c30</span><span class="p">,</span>  <span class="mh">0x37ff</span><span class="p">,</span> <span class="mh">0x0d30</span><span class="p">,</span> <span class="mh">0x3bff</span><span class="p">,</span> <span class="mh">0x0e30</span><span class="p">,</span>  <span class="mh">0x3fff</span><span class="p">,</span> <span class="mh">0x0f30</span><span class="p">,</span>

	<span class="mh">0x43ff</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span>  <span class="mh">0x47ff</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">,</span> <span class="mh">0x4bff</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">,</span>  <span class="mh">0x4fff</span><span class="p">,</span> <span class="mh">0x0330</span><span class="p">,</span>
	<span class="mh">0x53ff</span><span class="p">,</span> <span class="mh">0x0430</span><span class="p">,</span>  <span class="mh">0x57ff</span><span class="p">,</span> <span class="mh">0x0530</span><span class="p">,</span> <span class="mh">0x5bff</span><span class="p">,</span> <span class="mh">0x0630</span><span class="p">,</span>  <span class="mh">0x5fff</span><span class="p">,</span> <span class="mh">0x0730</span><span class="p">,</span>
	<span class="mh">0x63ff</span><span class="p">,</span> <span class="mh">0x0830</span><span class="p">,</span>  <span class="mh">0x67ff</span><span class="p">,</span> <span class="mh">0x0930</span><span class="p">,</span> <span class="mh">0x6bff</span><span class="p">,</span> <span class="mh">0x0a30</span><span class="p">,</span>  <span class="mh">0x6fff</span><span class="p">,</span> <span class="mh">0x0b30</span><span class="p">,</span>
	<span class="mh">0x73ff</span><span class="p">,</span> <span class="mh">0x0c30</span><span class="p">,</span>  <span class="mh">0x77ff</span><span class="p">,</span> <span class="mh">0x0d30</span><span class="p">,</span> <span class="mh">0x7bff</span><span class="p">,</span> <span class="mh">0x0e30</span><span class="p">,</span>  <span class="mh">0x7fff</span><span class="p">,</span> <span class="mh">0x0f30</span><span class="p">,</span>

	<span class="mh">0x83ff</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span>  <span class="mh">0x87ff</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">,</span> <span class="mh">0x8bff</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">,</span>  <span class="mh">0x8fff</span><span class="p">,</span> <span class="mh">0x0330</span><span class="p">,</span>
	<span class="mh">0x93ff</span><span class="p">,</span> <span class="mh">0x0430</span><span class="p">,</span>  <span class="mh">0x97ff</span><span class="p">,</span> <span class="mh">0x0530</span><span class="p">,</span> <span class="mh">0x9bff</span><span class="p">,</span> <span class="mh">0x0630</span><span class="p">,</span>  <span class="mh">0x9fff</span><span class="p">,</span> <span class="mh">0x0730</span><span class="p">,</span>
	<span class="mh">0xa3ff</span><span class="p">,</span> <span class="mh">0x0830</span><span class="p">,</span>  <span class="mh">0xa7ff</span><span class="p">,</span> <span class="mh">0x0930</span><span class="p">,</span> <span class="mh">0xabff</span><span class="p">,</span> <span class="mh">0x0a30</span><span class="p">,</span>  <span class="mh">0xafff</span><span class="p">,</span> <span class="mh">0x0b30</span><span class="p">,</span>
	<span class="mh">0xb3ff</span><span class="p">,</span> <span class="mh">0x0c30</span><span class="p">,</span>  <span class="mh">0xb7ff</span><span class="p">,</span> <span class="mh">0x0d30</span><span class="p">,</span> <span class="mh">0xbbff</span><span class="p">,</span> <span class="mh">0x0e30</span><span class="p">,</span>  <span class="mh">0xbfff</span><span class="p">,</span> <span class="mh">0x0f30</span><span class="p">,</span>

	<span class="mh">0xc3ff</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span>  <span class="mh">0xc7ff</span><span class="p">,</span> <span class="mh">0x0130</span><span class="p">,</span> <span class="mh">0xcbff</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">,</span>  <span class="mh">0xcfff</span><span class="p">,</span> <span class="mh">0x0330</span><span class="p">,</span>
	<span class="mh">0xd3ff</span><span class="p">,</span> <span class="mh">0x0430</span><span class="p">,</span>  <span class="mh">0xd7ff</span><span class="p">,</span> <span class="mh">0x0530</span><span class="p">,</span> <span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x0630</span><span class="p">,</span>  <span class="mh">0xdfff</span><span class="p">,</span> <span class="mh">0x0730</span><span class="p">,</span>
	<span class="mh">0xe3ff</span><span class="p">,</span> <span class="mh">0x0830</span><span class="p">,</span>  <span class="mh">0xe7ff</span><span class="p">,</span> <span class="mh">0x0930</span><span class="p">,</span> <span class="mh">0xebff</span><span class="p">,</span> <span class="mh">0x0a30</span><span class="p">,</span>  <span class="mh">0xefff</span><span class="p">,</span> <span class="mh">0x0b30</span><span class="p">,</span>
	<span class="mh">0xf3ff</span><span class="p">,</span> <span class="mh">0x0c30</span><span class="p">,</span>  <span class="mh">0xf7ff</span><span class="p">,</span> <span class="mh">0x0d30</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">,</span> <span class="mh">0x0e30</span><span class="p">,</span>  <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x0f30</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">init2</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="cm">/*__devinitdata*/</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x03ff</span><span class="p">,</span> <span class="mh">0x8030</span><span class="p">,</span> <span class="mh">0x07ff</span><span class="p">,</span> <span class="mh">0x8130</span><span class="p">,</span> <span class="mh">0x0bff</span><span class="p">,</span> <span class="mh">0x8230</span><span class="p">,</span> <span class="mh">0x0fff</span><span class="p">,</span> <span class="mh">0x8330</span><span class="p">,</span>
	<span class="mh">0x13ff</span><span class="p">,</span> <span class="mh">0x8430</span><span class="p">,</span> <span class="mh">0x17ff</span><span class="p">,</span> <span class="mh">0x8530</span><span class="p">,</span> <span class="mh">0x1bff</span><span class="p">,</span> <span class="mh">0x8630</span><span class="p">,</span> <span class="mh">0x1fff</span><span class="p">,</span> <span class="mh">0x8730</span><span class="p">,</span>
	<span class="mh">0x23ff</span><span class="p">,</span> <span class="mh">0x8830</span><span class="p">,</span> <span class="mh">0x27ff</span><span class="p">,</span> <span class="mh">0x8930</span><span class="p">,</span> <span class="mh">0x2bff</span><span class="p">,</span> <span class="mh">0x8a30</span><span class="p">,</span> <span class="mh">0x2fff</span><span class="p">,</span> <span class="mh">0x8b30</span><span class="p">,</span>
	<span class="mh">0x33ff</span><span class="p">,</span> <span class="mh">0x8c30</span><span class="p">,</span> <span class="mh">0x37ff</span><span class="p">,</span> <span class="mh">0x8d30</span><span class="p">,</span> <span class="mh">0x3bff</span><span class="p">,</span> <span class="mh">0x8e30</span><span class="p">,</span> <span class="mh">0x3fff</span><span class="p">,</span> <span class="mh">0x8f30</span><span class="p">,</span>

	<span class="mh">0x43ff</span><span class="p">,</span> <span class="mh">0x8030</span><span class="p">,</span> <span class="mh">0x47ff</span><span class="p">,</span> <span class="mh">0x8130</span><span class="p">,</span> <span class="mh">0x4bff</span><span class="p">,</span> <span class="mh">0x8230</span><span class="p">,</span> <span class="mh">0x4fff</span><span class="p">,</span> <span class="mh">0x8330</span><span class="p">,</span>
	<span class="mh">0x53ff</span><span class="p">,</span> <span class="mh">0x8430</span><span class="p">,</span> <span class="mh">0x57ff</span><span class="p">,</span> <span class="mh">0x8530</span><span class="p">,</span> <span class="mh">0x5bff</span><span class="p">,</span> <span class="mh">0x8630</span><span class="p">,</span> <span class="mh">0x5fff</span><span class="p">,</span> <span class="mh">0x8730</span><span class="p">,</span>
	<span class="mh">0x63ff</span><span class="p">,</span> <span class="mh">0x8830</span><span class="p">,</span> <span class="mh">0x67ff</span><span class="p">,</span> <span class="mh">0x8930</span><span class="p">,</span> <span class="mh">0x6bff</span><span class="p">,</span> <span class="mh">0x8a30</span><span class="p">,</span> <span class="mh">0x6fff</span><span class="p">,</span> <span class="mh">0x8b30</span><span class="p">,</span>
	<span class="mh">0x73ff</span><span class="p">,</span> <span class="mh">0x8c30</span><span class="p">,</span> <span class="mh">0x77ff</span><span class="p">,</span> <span class="mh">0x8d30</span><span class="p">,</span> <span class="mh">0x7bff</span><span class="p">,</span> <span class="mh">0x8e30</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span> <span class="mh">0x8f30</span><span class="p">,</span>

	<span class="mh">0x83ff</span><span class="p">,</span> <span class="mh">0x8030</span><span class="p">,</span> <span class="mh">0x87ff</span><span class="p">,</span> <span class="mh">0x8130</span><span class="p">,</span> <span class="mh">0x8bff</span><span class="p">,</span> <span class="mh">0x8230</span><span class="p">,</span> <span class="mh">0x8fff</span><span class="p">,</span> <span class="mh">0x8330</span><span class="p">,</span>
	<span class="mh">0x93ff</span><span class="p">,</span> <span class="mh">0x8430</span><span class="p">,</span> <span class="mh">0x97ff</span><span class="p">,</span> <span class="mh">0x8530</span><span class="p">,</span> <span class="mh">0x9bff</span><span class="p">,</span> <span class="mh">0x8630</span><span class="p">,</span> <span class="mh">0x9fff</span><span class="p">,</span> <span class="mh">0x8730</span><span class="p">,</span>
	<span class="mh">0xa3ff</span><span class="p">,</span> <span class="mh">0x8830</span><span class="p">,</span> <span class="mh">0xa7ff</span><span class="p">,</span> <span class="mh">0x8930</span><span class="p">,</span> <span class="mh">0xabff</span><span class="p">,</span> <span class="mh">0x8a30</span><span class="p">,</span> <span class="mh">0xafff</span><span class="p">,</span> <span class="mh">0x8b30</span><span class="p">,</span>
	<span class="mh">0xb3ff</span><span class="p">,</span> <span class="mh">0x8c30</span><span class="p">,</span> <span class="mh">0xb7ff</span><span class="p">,</span> <span class="mh">0x8d30</span><span class="p">,</span> <span class="mh">0xbbff</span><span class="p">,</span> <span class="mh">0x8e30</span><span class="p">,</span> <span class="mh">0xbfff</span><span class="p">,</span> <span class="mh">0x8f30</span><span class="p">,</span>

	<span class="mh">0xc3ff</span><span class="p">,</span> <span class="mh">0x8030</span><span class="p">,</span> <span class="mh">0xc7ff</span><span class="p">,</span> <span class="mh">0x8130</span><span class="p">,</span> <span class="mh">0xcbff</span><span class="p">,</span> <span class="mh">0x8230</span><span class="p">,</span> <span class="mh">0xcfff</span><span class="p">,</span> <span class="mh">0x8330</span><span class="p">,</span>
	<span class="mh">0xd3ff</span><span class="p">,</span> <span class="mh">0x8430</span><span class="p">,</span> <span class="mh">0xd7ff</span><span class="p">,</span> <span class="mh">0x8530</span><span class="p">,</span> <span class="mh">0xdbff</span><span class="p">,</span> <span class="mh">0x8630</span><span class="p">,</span> <span class="mh">0xdfff</span><span class="p">,</span> <span class="mh">0x8730</span><span class="p">,</span>
	<span class="mh">0xe3ff</span><span class="p">,</span> <span class="mh">0x8830</span><span class="p">,</span> <span class="mh">0xe7ff</span><span class="p">,</span> <span class="mh">0x8930</span><span class="p">,</span> <span class="mh">0xebff</span><span class="p">,</span> <span class="mh">0x8a30</span><span class="p">,</span> <span class="mh">0xefff</span><span class="p">,</span> <span class="mh">0x8b30</span><span class="p">,</span>
	<span class="mh">0xf3ff</span><span class="p">,</span> <span class="mh">0x8c30</span><span class="p">,</span> <span class="mh">0xf7ff</span><span class="p">,</span> <span class="mh">0x8d30</span><span class="p">,</span> <span class="mh">0xfbff</span><span class="p">,</span> <span class="mh">0x8e30</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mh">0x8f30</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">init3</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="cm">/*__devinitdata*/</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0C10</span><span class="p">,</span> <span class="mh">0x8470</span><span class="p">,</span> <span class="mh">0x14FE</span><span class="p">,</span> <span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0x167F</span><span class="p">,</span> <span class="mh">0xA470</span><span class="p">,</span> <span class="mh">0x18E7</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span>
	<span class="mh">0x1B6E</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x1F1D</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x0DA3</span><span class="p">,</span> <span class="mh">0x8F7C</span><span class="p">,</span> <span class="mh">0x167E</span><span class="p">,</span> <span class="mh">0xF254</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x18E6</span><span class="p">,</span> <span class="mh">0x8BAA</span><span class="p">,</span> <span class="mh">0x1B6D</span><span class="p">,</span> <span class="mh">0xF234</span><span class="p">,</span>
	<span class="mh">0x229F</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x2746</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x1F1C</span><span class="p">,</span> <span class="mh">0x86E7</span><span class="p">,</span> <span class="mh">0x229E</span><span class="p">,</span> <span class="mh">0xF224</span><span class="p">,</span>

	<span class="mh">0x0DA4</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x2C29</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x2745</span><span class="p">,</span> <span class="mh">0x87F6</span><span class="p">,</span> <span class="mh">0x2C28</span><span class="p">,</span> <span class="mh">0xF254</span><span class="p">,</span>
	<span class="mh">0x383B</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x320F</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x320E</span><span class="p">,</span> <span class="mh">0x8F02</span><span class="p">,</span> <span class="mh">0x1341</span><span class="p">,</span> <span class="mh">0xF264</span><span class="p">,</span>
	<span class="mh">0x3EB6</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x3EB9</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x8FA9</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0xF294</span><span class="p">,</span>
	<span class="mh">0x3EB7</span><span class="p">,</span> <span class="mh">0x8474</span><span class="p">,</span> <span class="mh">0x3EBA</span><span class="p">,</span> <span class="mh">0x8575</span><span class="p">,</span> <span class="mh">0x3EB8</span><span class="p">,</span> <span class="mh">0xC4C3</span><span class="p">,</span> <span class="mh">0x3EBB</span><span class="p">,</span> <span class="mh">0xC5C3</span><span class="p">,</span>

	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xA404</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0xA504</span><span class="p">,</span> <span class="mh">0x141F</span><span class="p">,</span> <span class="mh">0x8671</span><span class="p">,</span> <span class="mh">0x14FD</span><span class="p">,</span> <span class="mh">0x8287</span><span class="p">,</span>
	<span class="mh">0x3EBC</span><span class="p">,</span> <span class="mh">0xE610</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0x8C7B</span><span class="p">,</span> <span class="mh">0x031A</span><span class="p">,</span> <span class="mh">0x87E6</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0x86F7</span><span class="p">,</span>
	<span class="mh">0x3EC0</span><span class="p">,</span> <span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0x3EBE</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x3EBD</span><span class="p">,</span> <span class="mh">0x821F</span><span class="p">,</span> <span class="mh">0x3ECA</span><span class="p">,</span> <span class="mh">0x8386</span><span class="p">,</span>
	<span class="mh">0x3EC1</span><span class="p">,</span> <span class="mh">0x8C03</span><span class="p">,</span> <span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0x3ECA</span><span class="p">,</span> <span class="mh">0x8C4C</span><span class="p">,</span> <span class="mh">0x3EBF</span><span class="p">,</span> <span class="mh">0x8C55</span><span class="p">,</span>

	<span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0xC208</span><span class="p">,</span> <span class="mh">0x3EC4</span><span class="p">,</span> <span class="mh">0xBC84</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0x8EAD</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span>
	<span class="mh">0x3EC2</span><span class="p">,</span> <span class="mh">0x8F7E</span><span class="p">,</span> <span class="mh">0x3ECB</span><span class="p">,</span> <span class="mh">0x8219</span><span class="p">,</span> <span class="mh">0x3ECB</span><span class="p">,</span> <span class="mh">0xD26E</span><span class="p">,</span> <span class="mh">0x3EC5</span><span class="p">,</span> <span class="mh">0x831F</span><span class="p">,</span>
	<span class="mh">0x3EC6</span><span class="p">,</span> <span class="mh">0xC308</span><span class="p">,</span> <span class="mh">0x3EC3</span><span class="p">,</span> <span class="mh">0xB2FF</span><span class="p">,</span> <span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0x8265</span><span class="p">,</span> <span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0x8319</span><span class="p">,</span>
	<span class="mh">0x1342</span><span class="p">,</span> <span class="mh">0xD36E</span><span class="p">,</span> <span class="mh">0x3EC7</span><span class="p">,</span> <span class="mh">0xB3FF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8365</span><span class="p">,</span> <span class="mh">0x1420</span><span class="p">,</span> <span class="mh">0x9570</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">init4</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="cm">/*__devinitdata*/</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0C10</span><span class="p">,</span> <span class="mh">0x8470</span><span class="p">,</span> <span class="mh">0x14FE</span><span class="p">,</span> <span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0x167F</span><span class="p">,</span> <span class="mh">0xA470</span><span class="p">,</span> <span class="mh">0x18E7</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span>
	<span class="mh">0x1B6E</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x1F1D</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x0DA3</span><span class="p">,</span> <span class="mh">0x0F7C</span><span class="p">,</span> <span class="mh">0x167E</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span>
	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x18E6</span><span class="p">,</span> <span class="mh">0x0BAA</span><span class="p">,</span> <span class="mh">0x1B6D</span><span class="p">,</span> <span class="mh">0x7234</span><span class="p">,</span>
	<span class="mh">0x229F</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x2746</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x1F1C</span><span class="p">,</span> <span class="mh">0x06E7</span><span class="p">,</span> <span class="mh">0x229E</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span>

	<span class="mh">0x0DA4</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x2C29</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x2745</span><span class="p">,</span> <span class="mh">0x07F6</span><span class="p">,</span> <span class="mh">0x2C28</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span>
	<span class="mh">0x383B</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x320F</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x320E</span><span class="p">,</span> <span class="mh">0x0F02</span><span class="p">,</span> <span class="mh">0x1341</span><span class="p">,</span> <span class="mh">0x7264</span><span class="p">,</span>
	<span class="mh">0x3EB6</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x3EB9</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x0FA9</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x7294</span><span class="p">,</span>
	<span class="mh">0x3EB7</span><span class="p">,</span> <span class="mh">0x8474</span><span class="p">,</span> <span class="mh">0x3EBA</span><span class="p">,</span> <span class="mh">0x8575</span><span class="p">,</span> <span class="mh">0x3EB8</span><span class="p">,</span> <span class="mh">0x44C3</span><span class="p">,</span> <span class="mh">0x3EBB</span><span class="p">,</span> <span class="mh">0x45C3</span><span class="p">,</span>

	<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0xA404</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0xA504</span><span class="p">,</span> <span class="mh">0x141F</span><span class="p">,</span> <span class="mh">0x0671</span><span class="p">,</span> <span class="mh">0x14FD</span><span class="p">,</span> <span class="mh">0x0287</span><span class="p">,</span>
	<span class="mh">0x3EBC</span><span class="p">,</span> <span class="mh">0xE610</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0x0C7B</span><span class="p">,</span> <span class="mh">0x031A</span><span class="p">,</span> <span class="mh">0x07E6</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0x86F7</span><span class="p">,</span>
	<span class="mh">0x3EC0</span><span class="p">,</span> <span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0x3EBE</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x3EBD</span><span class="p">,</span> <span class="mh">0x021F</span><span class="p">,</span> <span class="mh">0x3ECA</span><span class="p">,</span> <span class="mh">0x0386</span><span class="p">,</span>
	<span class="mh">0x3EC1</span><span class="p">,</span> <span class="mh">0x0C03</span><span class="p">,</span> <span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0x3ECA</span><span class="p">,</span> <span class="mh">0x8C4C</span><span class="p">,</span> <span class="mh">0x3EBF</span><span class="p">,</span> <span class="mh">0x0C55</span><span class="p">,</span>

	<span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0xC208</span><span class="p">,</span> <span class="mh">0x3EC4</span><span class="p">,</span> <span class="mh">0xBC84</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0x0EAD</span><span class="p">,</span> <span class="mh">0x3EC8</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span>
	<span class="mh">0x3EC2</span><span class="p">,</span> <span class="mh">0x8F7E</span><span class="p">,</span> <span class="mh">0x3ECB</span><span class="p">,</span> <span class="mh">0x0219</span><span class="p">,</span> <span class="mh">0x3ECB</span><span class="p">,</span> <span class="mh">0xD26E</span><span class="p">,</span> <span class="mh">0x3EC5</span><span class="p">,</span> <span class="mh">0x031F</span><span class="p">,</span>
	<span class="mh">0x3EC6</span><span class="p">,</span> <span class="mh">0xC308</span><span class="p">,</span> <span class="mh">0x3EC3</span><span class="p">,</span> <span class="mh">0x32FF</span><span class="p">,</span> <span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0x0265</span><span class="p">,</span> <span class="mh">0x3EC9</span><span class="p">,</span> <span class="mh">0x8319</span><span class="p">,</span>
	<span class="mh">0x1342</span><span class="p">,</span> <span class="mh">0xD36E</span><span class="p">,</span> <span class="mh">0x3EC7</span><span class="p">,</span> <span class="mh">0x33FF</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x8365</span><span class="p">,</span> <span class="mh">0x1420</span><span class="p">,</span> <span class="mh">0x9570</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* send an initialization array</span>
<span class="cm"> * Taken from the oss driver, not obvious from the doc how this</span>
<span class="cm"> * is meant to work</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">send_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">EMU8000_INIT1_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">EMU8000_INIT2_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">EMU8000_INIT3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Send initialization arrays to start up, this just follows the</span>
<span class="cm"> * initialisation sequence in the adip.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">init_arrays</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">send_array</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">init1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init1</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">((</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">44100</span><span class="p">);</span> <span class="cm">/* wait for 1024 clocks */</span>
	<span class="n">send_array</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">init2</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init2</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">send_array</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">init3</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init3</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>

	<span class="n">EMU8000_HWCF4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF5_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF6_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="n">send_array</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">init4</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">init4</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define UNIQUE_ID1	0xa5b9</span>
<span class="cp">#define UNIQUE_ID2	0x9d53</span>

<span class="cm">/*</span>
<span class="cm"> * Size the onboard memory.</span>
<span class="cm"> * This is written so as not to need arbitrary delays after the write. It</span>
<span class="cm"> * seems that the only way to do this is to use the one channel and keep</span>
<span class="cm"> * reallocating between read and write.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">size_dram</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">detected_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">dram_checked</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">detected_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* write out a magic number */</span>
	<span class="n">snd_emu8000_dma_chan</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EMU8000_RAM_WRITE</span><span class="p">);</span>
	<span class="n">snd_emu8000_dma_chan</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EMU8000_RAM_READ</span><span class="p">);</span>
	<span class="n">EMU8000_SMALW_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">EMU8000_DRAM_OFFSET</span><span class="p">);</span>
	<span class="n">EMU8000_SMLD_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">UNIQUE_ID1</span><span class="p">);</span>
	<span class="n">snd_emu8000_init_fm</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span> <span class="cm">/* This must really be here and not 2 lines back even */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">EMU8000_MAX_DRAM</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">size</span> <span class="o">+=</span> <span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>  <span class="cm">/* increment 512kbytes */</span>

		<span class="cm">/* Write a unique data on the test address.</span>
<span class="cm">		 * if the address is out of range, the data is written on</span>
<span class="cm">		 * 0x200000(=EMU8000_DRAM_OFFSET).  Then the id word is</span>
<span class="cm">		 * changed by this data.</span>
<span class="cm">		 */</span>
		<span class="cm">/*snd_emu8000_dma_chan(emu, 0, EMU8000_RAM_WRITE);*/</span>
		<span class="n">EMU8000_SMALW_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">EMU8000_DRAM_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
		<span class="n">EMU8000_SMLD_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">UNIQUE_ID2</span><span class="p">);</span>
		<span class="n">snd_emu8000_write_wait</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * read the data on the just written DRAM address</span>
<span class="cm">		 * if not the same then we have reached the end of ram.</span>
<span class="cm">		 */</span>
		<span class="cm">/*snd_emu8000_dma_chan(emu, 0, EMU8000_RAM_READ);*/</span>
		<span class="n">EMU8000_SMALR_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">EMU8000_DRAM_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">));</span>
		<span class="cm">/*snd_emu8000_read_wait(emu);*/</span>
		<span class="n">EMU8000_SMLD_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span> <span class="cm">/* discard stale data  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EMU8000_SMLD_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNIQUE_ID2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* no memory at this address */</span>

		<span class="n">detected_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

		<span class="n">snd_emu8000_read_wait</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If it is the same it could be that the address just</span>
<span class="cm">		 * wraps back to the beginning; so check to see if the</span>
<span class="cm">		 * initial value has been overwritten.</span>
<span class="cm">		 */</span>
		<span class="n">EMU8000_SMALR_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">EMU8000_DRAM_OFFSET</span><span class="p">);</span>
		<span class="n">EMU8000_SMLD_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span> <span class="cm">/* discard stale data  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">EMU8000_SMLD_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UNIQUE_ID1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* we must have wrapped around */</span>
		<span class="n">snd_emu8000_read_wait</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait until FULL bit in SMAxW register is false */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">EMU8000_SMALW_READ</span><span class="p">(</span><span class="n">emu</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_emu8000_dma_chan</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EMU8000_RAM_CLOSE</span><span class="p">);</span>
	<span class="n">snd_emu8000_dma_chan</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">EMU8000_RAM_CLOSE</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;EMU8000 [0x%lx]: %d Kb on-board memory detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">emu</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">,</span> <span class="n">detected_size</span><span class="o">/</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">mem_size</span> <span class="o">=</span> <span class="n">detected_size</span><span class="p">;</span>
	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">dram_checked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Initiailise the FM section.  You have to do this to use sample RAM</span>
<span class="cm"> * and therefore lose 2 voices.</span>
<span class="cm"> */</span>
<span class="cm">/*exported*/</span> <span class="kt">void</span>
<span class="nf">snd_emu8000_init_fm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Initialize the last two channels for DRAM refresh and producing</span>
<span class="cm">	   the reverb and chorus effects for Yamaha OPL-3 synthesizer */</span>

	<span class="cm">/* 31: FM left channel, 0xffffe0-0xffffe8 */</span>
	<span class="n">EMU8000_DCYSUSV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">EMU8000_PSST_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0xFFFFFFE0</span><span class="p">);</span> <span class="cm">/* full left */</span>
	<span class="n">EMU8000_CSL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x00FFFFE8</span> <span class="o">|</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_chorus_depth</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">EMU8000_PTRX_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_reverb_depth</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">EMU8000_CPF_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">EMU8000_CCCA_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x00FFFFE3</span><span class="p">);</span>

	<span class="cm">/* 32: FM right channel, 0xfffff0-0xfffff8 */</span>
	<span class="n">EMU8000_DCYSUSV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">EMU8000_PSST_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00FFFFF0</span><span class="p">);</span> <span class="cm">/* full right */</span>
	<span class="n">EMU8000_CSL_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00FFFFF8</span> <span class="o">|</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_chorus_depth</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">EMU8000_PTRX_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_reverb_depth</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">EMU8000_CPF_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">EMU8000_CCCA_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00FFFFF3</span><span class="p">);</span>

	<span class="n">snd_emu8000_poke</span><span class="p">((</span><span class="n">emu</span><span class="p">),</span> <span class="n">EMU8000_DATA0</span><span class="p">(</span><span class="n">emu</span><span class="p">),</span> <span class="n">EMU8000_CMD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">30</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">))</span>
		<span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">inw</span><span class="p">(</span><span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">))</span>
		<span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_emu8000_poke</span><span class="p">((</span><span class="n">emu</span><span class="p">),</span> <span class="n">EMU8000_DATA0</span><span class="p">(</span><span class="n">emu</span><span class="p">),</span> <span class="n">EMU8000_CMD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">30</span><span class="p">)),</span> <span class="mh">0x4828</span><span class="p">);</span>
	<span class="cm">/* this is really odd part.. */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x3C</span><span class="p">,</span> <span class="n">EMU8000_PTR</span><span class="p">(</span><span class="n">emu</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">EMU8000_DATA1</span><span class="p">(</span><span class="n">emu</span><span class="p">));</span>

	<span class="cm">/* skew volume &amp; cutoff */</span>
	<span class="n">EMU8000_VTFT_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x8000FFFF</span><span class="p">);</span>
	<span class="n">EMU8000_VTFT_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x8000FFFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * The main initialization routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">snd_emu8000_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">emu</span><span class="o">-&gt;</span><span class="n">last_reg</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="cm">/* reset the last register index */</span>

	<span class="cm">/* initialize hardware configuration */</span>
	<span class="n">EMU8000_HWCF1_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF2_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>

	<span class="cm">/* disable audio; this seems to reduce a clicking noise a bit.. */</span>
	<span class="n">EMU8000_HWCF3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* initialize audio channels */</span>
	<span class="n">init_audio</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

	<span class="cm">/* initialize DMA */</span>
	<span class="n">init_dma</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

	<span class="cm">/* initialize init arrays */</span>
	<span class="n">init_arrays</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the FM section of the AWE32, this is needed</span>
<span class="cm">	 * for DRAM refresh as well</span>
<span class="cm">	 */</span>
	<span class="n">snd_emu8000_init_fm</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

	<span class="cm">/* terminate all voices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMU8000_DRAM_VOICES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">EMU8000_DCYSUSV_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x807F</span><span class="p">);</span>
	
	<span class="cm">/* check DRAM memory size */</span>
	<span class="n">size_dram</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>

	<span class="cm">/* enable audio */</span>
	<span class="n">EMU8000_HWCF3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>

	<span class="cm">/* set equzlier, chorus and reverb modes */</span>
	<span class="n">snd_emu8000_update_equalizer</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="n">snd_emu8000_update_chorus_mode</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="n">snd_emu8000_update_reverb_mode</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm"> * Bass/Treble Equalizer</span>
<span class="cm"> *----------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">bass_parm</span><span class="p">[</span><span class="mi">12</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0xD26A</span><span class="p">,</span> <span class="mh">0xD36A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/* -12 dB */</span>
	<span class="p">{</span><span class="mh">0xD25B</span><span class="p">,</span> <span class="mh">0xD35B</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/*  -8 */</span>
	<span class="p">{</span><span class="mh">0xD24C</span><span class="p">,</span> <span class="mh">0xD34C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/*  -6 */</span>
	<span class="p">{</span><span class="mh">0xD23D</span><span class="p">,</span> <span class="mh">0xD33D</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/*  -4 */</span>
	<span class="p">{</span><span class="mh">0xD21F</span><span class="p">,</span> <span class="mh">0xD31F</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">},</span> <span class="cm">/*  -2 */</span>
	<span class="p">{</span><span class="mh">0xC208</span><span class="p">,</span> <span class="mh">0xC308</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/*   0 (HW default) */</span>
	<span class="p">{</span><span class="mh">0xC219</span><span class="p">,</span> <span class="mh">0xC319</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/*  +2 */</span>
	<span class="p">{</span><span class="mh">0xC22A</span><span class="p">,</span> <span class="mh">0xC32A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/*  +4 */</span>
	<span class="p">{</span><span class="mh">0xC24C</span><span class="p">,</span> <span class="mh">0xC34C</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/*  +6 */</span>
	<span class="p">{</span><span class="mh">0xC26E</span><span class="p">,</span> <span class="mh">0xC36E</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/*  +8 */</span>
	<span class="p">{</span><span class="mh">0xC248</span><span class="p">,</span> <span class="mh">0xC384</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span> <span class="cm">/* +10 */</span>
	<span class="p">{</span><span class="mh">0xC26A</span><span class="p">,</span> <span class="mh">0xC36A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span> <span class="cm">/* +12 dB */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">treble_parm</span><span class="p">[</span><span class="mi">12</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xC26A</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xC36A</span><span class="p">,</span> <span class="mh">0x021E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span> <span class="cm">/* -12 dB */</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xC25B</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xC35B</span><span class="p">,</span> <span class="mh">0x021E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xC24C</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xC34C</span><span class="p">,</span> <span class="mh">0x021E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xC23D</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xC33D</span><span class="p">,</span> <span class="mh">0x021E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xC21F</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xC31F</span><span class="p">,</span> <span class="mh">0x021E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x021E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x831E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x021D</span><span class="p">,</span> <span class="mh">0xD219</span><span class="p">,</span> <span class="mh">0x831D</span><span class="p">,</span> <span class="mh">0xD319</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x021C</span><span class="p">,</span> <span class="mh">0xD22A</span><span class="p">,</span> <span class="mh">0x831C</span><span class="p">,</span> <span class="mh">0xD32A</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x021A</span><span class="p">,</span> <span class="mh">0xD24C</span><span class="p">,</span> <span class="mh">0x831A</span><span class="p">,</span> <span class="mh">0xD34C</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821E</span><span class="p">,</span> <span class="mh">0xD208</span><span class="p">,</span> <span class="mh">0x031E</span><span class="p">,</span> <span class="mh">0xD308</span><span class="p">,</span> <span class="mh">0x0219</span><span class="p">,</span> <span class="mh">0xD26E</span><span class="p">,</span> <span class="mh">0x8319</span><span class="p">,</span> <span class="mh">0xD36E</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span> <span class="cm">/* +8 (HW default) */</span>
	<span class="p">{</span><span class="mh">0x821D</span><span class="p">,</span> <span class="mh">0xD219</span><span class="p">,</span> <span class="mh">0x031D</span><span class="p">,</span> <span class="mh">0xD319</span><span class="p">,</span> <span class="mh">0x0219</span><span class="p">,</span> <span class="mh">0xD26E</span><span class="p">,</span> <span class="mh">0x8319</span><span class="p">,</span> <span class="mh">0xD36E</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
	<span class="p">{</span><span class="mh">0x821C</span><span class="p">,</span> <span class="mh">0xD22A</span><span class="p">,</span> <span class="mh">0x031C</span><span class="p">,</span> <span class="mh">0xD32A</span><span class="p">,</span> <span class="mh">0x0219</span><span class="p">,</span> <span class="mh">0xD26E</span><span class="p">,</span> <span class="mh">0x8319</span><span class="p">,</span> <span class="mh">0xD36E</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">}</span>  <span class="cm">/* +12 dB */</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * set Emu8000 digital equalizer; from 0 to 11 [-12dB - 12dB]</span>
<span class="cm"> */</span>
<span class="cm">/*exported*/</span> <span class="kt">void</span>
<span class="nf">snd_emu8000_update_equalizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">w</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bass</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">bass_level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">treble</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">treble_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bass</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bass</span> <span class="o">&gt;</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">treble</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">treble</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">bass_parm</span><span class="p">[</span><span class="n">bass</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">bass_parm</span><span class="p">[</span><span class="n">bass</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">bass_parm</span><span class="p">[</span><span class="n">bass</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">treble_parm</span><span class="p">[</span><span class="n">treble</span><span class="p">][</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">w</span> <span class="o">+</span> <span class="mh">0x0262</span><span class="p">));</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)(</span><span class="n">w</span> <span class="o">+</span> <span class="mh">0x8362</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm"> * Chorus mode control</span>
<span class="cm"> *----------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * chorus mode parameters</span>
<span class="cm"> */</span>
<span class="cp">#define SNDRV_EMU8000_CHORUS_1		0</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_2		1</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_3		2</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_4		3</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_FEEDBACK	4</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_FLANGER	5</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_SHORTDELAY	6</span>
<span class="cp">#define	SNDRV_EMU8000_CHORUS_SHORTDELAY2	7</span>
<span class="cp">#define SNDRV_EMU8000_CHORUS_PREDEFINED	8</span>
<span class="cm">/* user can define chorus modes up to 32 */</span>
<span class="cp">#define SNDRV_EMU8000_CHORUS_NUMBERS	32</span>

<span class="k">struct</span> <span class="n">soundfont_chorus_fx</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">feedback</span><span class="p">;</span>	<span class="cm">/* feedback level (0xE600-0xE6FF) */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">delay_offset</span><span class="p">;</span>	<span class="cm">/* delay (0-0x0DA3) [1/44100 sec] */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">lfo_depth</span><span class="p">;</span>	<span class="cm">/* LFO depth (0xBC00-0xBCFF) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">;</span>	<span class="cm">/* right delay (0-0xFFFFFFFF) [1/256/44100 sec] */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lfo_freq</span><span class="p">;</span>		<span class="cm">/* LFO freq LFO freq (0-0xFFFFFFFF) */</span>
<span class="p">};</span>

<span class="cm">/* 5 parameters for each chorus mode; 3 x 16bit, 2 x 32bit */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">chorus_defined</span><span class="p">[</span><span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">soundfont_chorus_fx</span> <span class="n">chorus_parm</span><span class="p">[</span><span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mh">0xE600</span><span class="p">,</span> <span class="mh">0x03F6</span><span class="p">,</span> <span class="mh">0xBC2C</span> <span class="p">,</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000006D</span><span class="p">},</span> <span class="cm">/* chorus 1 */</span>
	<span class="p">{</span><span class="mh">0xE608</span><span class="p">,</span> <span class="mh">0x031A</span><span class="p">,</span> <span class="mh">0xBC6E</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000017C</span><span class="p">},</span> <span class="cm">/* chorus 2 */</span>
	<span class="p">{</span><span class="mh">0xE610</span><span class="p">,</span> <span class="mh">0x031A</span><span class="p">,</span> <span class="mh">0xBC84</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000083</span><span class="p">},</span> <span class="cm">/* chorus 3 */</span>
	<span class="p">{</span><span class="mh">0xE620</span><span class="p">,</span> <span class="mh">0x0269</span><span class="p">,</span> <span class="mh">0xBC6E</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000017C</span><span class="p">},</span> <span class="cm">/* chorus 4 */</span>
	<span class="p">{</span><span class="mh">0xE680</span><span class="p">,</span> <span class="mh">0x04D3</span><span class="p">,</span> <span class="mh">0xBCA6</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x0000005B</span><span class="p">},</span> <span class="cm">/* feedback */</span>
	<span class="p">{</span><span class="mh">0xE6E0</span><span class="p">,</span> <span class="mh">0x044E</span><span class="p">,</span> <span class="mh">0xBC37</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="mh">0x00000026</span><span class="p">},</span> <span class="cm">/* flanger */</span>
	<span class="p">{</span><span class="mh">0xE600</span><span class="p">,</span> <span class="mh">0x0B06</span><span class="p">,</span> <span class="mh">0xBC00</span><span class="p">,</span> <span class="mh">0x0006E000</span><span class="p">,</span> <span class="mh">0x00000083</span><span class="p">},</span> <span class="cm">/* short delay */</span>
	<span class="p">{</span><span class="mh">0xE6C0</span><span class="p">,</span> <span class="mh">0x0B06</span><span class="p">,</span> <span class="mh">0xBC00</span><span class="p">,</span> <span class="mh">0x0006E000</span><span class="p">,</span> <span class="mh">0x00000083</span><span class="p">},</span> <span class="cm">/* short delay + feedback */</span>
<span class="p">};</span>

<span class="cm">/*exported*/</span> <span class="kt">int</span>
<span class="nf">snd_emu8000_load_chorus_fx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundfont_chorus_fx</span> <span class="n">rec</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">SNDRV_EMU8000_CHORUS_PREDEFINED</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;invalid chorus mode %d for uploading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">chorus_parm</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
	<span class="n">chorus_defined</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*exported*/</span> <span class="kt">void</span>
<span class="nf">snd_emu8000_update_chorus_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">effect</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">chorus_mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">effect</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">effect</span> <span class="o">&gt;=</span> <span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">effect</span> <span class="o">&gt;=</span> <span class="n">SNDRV_EMU8000_CHORUS_PREDEFINED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chorus_defined</span><span class="p">[</span><span class="n">effect</span><span class="p">]))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">EMU8000_INIT3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">chorus_parm</span><span class="p">[</span><span class="n">effect</span><span class="p">].</span><span class="n">feedback</span><span class="p">);</span>
	<span class="n">EMU8000_INIT3_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">chorus_parm</span><span class="p">[</span><span class="n">effect</span><span class="p">].</span><span class="n">delay_offset</span><span class="p">);</span>
	<span class="n">EMU8000_INIT4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">chorus_parm</span><span class="p">[</span><span class="n">effect</span><span class="p">].</span><span class="n">lfo_depth</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF4_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">chorus_parm</span><span class="p">[</span><span class="n">effect</span><span class="p">].</span><span class="n">delay</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF5_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">chorus_parm</span><span class="p">[</span><span class="n">effect</span><span class="p">].</span><span class="n">lfo_freq</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF6_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">EMU8000_HWCF7_WRITE</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm"> * Reverb mode control</span>
<span class="cm"> *----------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * reverb mode parameters</span>
<span class="cm"> */</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_ROOM1	0</span>
<span class="cp">#define SNDRV_EMU8000_REVERB_ROOM2	1</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_ROOM3	2</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_HALL1	3</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_HALL2	4</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_PLATE	5</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_DELAY	6</span>
<span class="cp">#define	SNDRV_EMU8000_REVERB_PANNINGDELAY 7</span>
<span class="cp">#define SNDRV_EMU8000_REVERB_PREDEFINED	8</span>
<span class="cm">/* user can define reverb modes up to 32 */</span>
<span class="cp">#define SNDRV_EMU8000_REVERB_NUMBERS	32</span>

<span class="k">struct</span> <span class="n">soundfont_reverb_fx</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parms</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* reverb mode settings; write the following 28 data of 16 bit length</span>
<span class="cm"> *   on the corresponding ports in the reverb_cmds array</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">reverb_defined</span><span class="p">[</span><span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">soundfont_reverb_fx</span> <span class="n">reverb_parm</span><span class="p">[</span><span class="n">SNDRV_EMU8000_REVERB_NUMBERS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{{</span>  <span class="cm">/* room 1 */</span>
	<span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0xA450</span><span class="p">,</span> <span class="mh">0x9550</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x72F4</span><span class="p">,</span>
	<span class="mh">0x72A4</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x4416</span><span class="p">,</span> <span class="mh">0x4516</span><span class="p">,</span>
	<span class="mh">0xA490</span><span class="p">,</span> <span class="mh">0xA590</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span>
	<span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* room 2 */</span>
	<span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0xA458</span><span class="p">,</span> <span class="mh">0x9558</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span>
	<span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span> <span class="mh">0x4448</span><span class="p">,</span> <span class="mh">0x4548</span><span class="p">,</span>
	<span class="mh">0xA440</span><span class="p">,</span> <span class="mh">0xA540</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span>
	<span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* room 3 */</span>
	<span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0xA460</span><span class="p">,</span> <span class="mh">0x9560</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span>
	<span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span> <span class="mh">0x4416</span><span class="p">,</span> <span class="mh">0x4516</span><span class="p">,</span>
	<span class="mh">0xA490</span><span class="p">,</span> <span class="mh">0xA590</span><span class="p">,</span> <span class="mh">0x842C</span><span class="p">,</span> <span class="mh">0x852C</span><span class="p">,</span> <span class="mh">0x842C</span><span class="p">,</span> <span class="mh">0x852C</span><span class="p">,</span> <span class="mh">0x842B</span><span class="p">,</span>
	<span class="mh">0x852B</span><span class="p">,</span> <span class="mh">0x842B</span><span class="p">,</span> <span class="mh">0x852B</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* hall 1 */</span>
	<span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0xA470</span><span class="p">,</span> <span class="mh">0x9570</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span>
	<span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7284</span><span class="p">,</span> <span class="mh">0x4448</span><span class="p">,</span> <span class="mh">0x4548</span><span class="p">,</span>
	<span class="mh">0xA440</span><span class="p">,</span> <span class="mh">0xA540</span><span class="p">,</span> <span class="mh">0x842B</span><span class="p">,</span> <span class="mh">0x852B</span><span class="p">,</span> <span class="mh">0x842B</span><span class="p">,</span> <span class="mh">0x852B</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span>
	<span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* hall 2 */</span>
	<span class="mh">0xB488</span><span class="p">,</span> <span class="mh">0xA470</span><span class="p">,</span> <span class="mh">0x9570</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span>
	<span class="mh">0x7234</span><span class="p">,</span> <span class="mh">0x7224</span><span class="p">,</span> <span class="mh">0x7254</span><span class="p">,</span> <span class="mh">0x7264</span><span class="p">,</span> <span class="mh">0x7294</span><span class="p">,</span> <span class="mh">0x44C3</span><span class="p">,</span> <span class="mh">0x45C3</span><span class="p">,</span>
	<span class="mh">0xA404</span><span class="p">,</span> <span class="mh">0xA504</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span>
	<span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* plate */</span>
	<span class="mh">0xB4FF</span><span class="p">,</span> <span class="mh">0xA470</span><span class="p">,</span> <span class="mh">0x9570</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x383A</span><span class="p">,</span> <span class="mh">0x3EB5</span><span class="p">,</span> <span class="mh">0x7234</span><span class="p">,</span>
	<span class="mh">0x7234</span><span class="p">,</span> <span class="mh">0x7234</span><span class="p">,</span> <span class="mh">0x7234</span><span class="p">,</span> <span class="mh">0x7234</span><span class="p">,</span> <span class="mh">0x7234</span><span class="p">,</span> <span class="mh">0x4448</span><span class="p">,</span> <span class="mh">0x4548</span><span class="p">,</span>
	<span class="mh">0xA440</span><span class="p">,</span> <span class="mh">0xA540</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x842A</span><span class="p">,</span> <span class="mh">0x852A</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span>
	<span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8429</span><span class="p">,</span> <span class="mh">0x8529</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span> <span class="mh">0x8428</span><span class="p">,</span> <span class="mh">0x8528</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* delay */</span>
	<span class="mh">0xB4FF</span><span class="p">,</span> <span class="mh">0xA470</span><span class="p">,</span> <span class="mh">0x9500</span><span class="p">,</span> <span class="mh">0x84B5</span><span class="p">,</span> <span class="mh">0x333A</span><span class="p">,</span> <span class="mh">0x39B5</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span>
	<span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x72F4</span><span class="p">,</span> <span class="mh">0x4400</span><span class="p">,</span> <span class="mh">0x4500</span><span class="p">,</span>
	<span class="mh">0xA4FF</span><span class="p">,</span> <span class="mh">0xA5FF</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span>
	<span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">{{</span>  <span class="cm">/* panning delay */</span>
	<span class="mh">0xB4FF</span><span class="p">,</span> <span class="mh">0xA490</span><span class="p">,</span> <span class="mh">0x9590</span><span class="p">,</span> <span class="mh">0x8474</span><span class="p">,</span> <span class="mh">0x333A</span><span class="p">,</span> <span class="mh">0x39B5</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span>
	<span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x7204</span><span class="p">,</span> <span class="mh">0x72F4</span><span class="p">,</span> <span class="mh">0x4400</span><span class="p">,</span> <span class="mh">0x4500</span><span class="p">,</span>
	<span class="mh">0xA4FF</span><span class="p">,</span> <span class="mh">0xA5FF</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span>
	<span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span> <span class="mh">0x8420</span><span class="p">,</span> <span class="mh">0x8520</span><span class="p">,</span>
<span class="p">}},</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">DATA1</span><span class="p">,</span> <span class="n">DATA2</span> <span class="p">};</span>
<span class="cp">#define AWE_INIT1(c)	EMU8000_CMD(2,c), DATA1</span>
<span class="cp">#define AWE_INIT2(c)	EMU8000_CMD(2,c), DATA2</span>
<span class="cp">#define AWE_INIT3(c)	EMU8000_CMD(3,c), DATA1</span>
<span class="cp">#define AWE_INIT4(c)	EMU8000_CMD(3,c), DATA2</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reverb_cmd_pair</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">port</span><span class="p">;</span>
<span class="p">}</span> <span class="n">reverb_cmds</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x05</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT4</span><span class="p">(</span><span class="mh">0x1F</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x07</span><span class="p">)},</span>
  <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x14</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x16</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)},</span>
  <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x1F</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x07</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x0F</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x17</span><span class="p">)},</span>
  <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x1D</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x1F</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT3</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT3</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)},</span>
  <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x09</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x11</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x13</span><span class="p">)},</span>
  <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x19</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT1</span><span class="p">(</span><span class="mh">0x1B</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x03</span><span class="p">)},</span>
  <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x09</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x0B</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x11</span><span class="p">)},</span> <span class="p">{</span><span class="n">AWE_INIT2</span><span class="p">(</span><span class="mh">0x13</span><span class="p">)},</span>
<span class="p">};</span>

<span class="cm">/*exported*/</span> <span class="kt">int</span>
<span class="nf">snd_emu8000_load_reverb_fx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundfont_reverb_fx</span> <span class="n">rec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">SNDRV_EMU8000_REVERB_PREDEFINED</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&gt;=</span> <span class="n">SNDRV_EMU8000_REVERB_NUMBERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;invalid reverb mode %d for uploading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="o">||</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">reverb_parm</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">rec</span><span class="p">;</span>
	<span class="n">reverb_defined</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*exported*/</span> <span class="kt">void</span>
<span class="nf">snd_emu8000_update_reverb_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">effect</span> <span class="o">=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">reverb_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">effect</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">effect</span> <span class="o">&gt;=</span> <span class="n">SNDRV_EMU8000_REVERB_NUMBERS</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">effect</span> <span class="o">&gt;=</span> <span class="n">SNDRV_EMU8000_REVERB_PREDEFINED</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reverb_defined</span><span class="p">[</span><span class="n">effect</span><span class="p">]))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reverb_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">port</span> <span class="o">==</span> <span class="n">DATA1</span><span class="p">)</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">EMU8000_DATA1</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">port</span> <span class="o">=</span> <span class="n">EMU8000_DATA2</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
		<span class="n">snd_emu8000_poke</span><span class="p">(</span><span class="n">emu</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">reverb_cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">,</span> <span class="n">reverb_parm</span><span class="p">[</span><span class="n">effect</span><span class="p">].</span><span class="n">parms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm"> * mixer interface</span>
<span class="cm"> *----------------------------------------------------------------*/</span>

<span class="cm">/*</span>
<span class="cm"> * bass/treble</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_bass_treble_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_bass_treble_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">?</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">treble_level</span> <span class="o">:</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">bass_level</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_bass_treble_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val1</span><span class="p">;</span>
	
	<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">treble_level</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">treble_level</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">bass_level</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">bass_level</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_emu8000_update_equalizer</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mixer_bass_control</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Synth Tone Control - Bass&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">mixer_bass_treble_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">mixer_bass_treble_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">mixer_bass_treble_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mixer_treble_control</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Synth Tone Control - Treble&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">mixer_bass_treble_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">mixer_bass_treble_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">mixer_bass_treble_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * chorus/reverb mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_chorus_reverb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">?</span> <span class="p">(</span><span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">SNDRV_EMU8000_REVERB_NUMBERS</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_chorus_reverb_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">?</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">chorus_mode</span> <span class="o">:</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">reverb_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_chorus_reverb_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val1</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">SNDRV_EMU8000_CHORUS_NUMBERS</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">chorus_mode</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">chorus_mode</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">SNDRV_EMU8000_REVERB_NUMBERS</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">reverb_mode</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">reverb_mode</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span>
			<span class="n">snd_emu8000_update_chorus_mode</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_emu8000_update_reverb_mode</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mixer_chorus_mode_control</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Chorus Mode&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">mixer_chorus_reverb_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">mixer_chorus_reverb_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">mixer_chorus_reverb_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mixer_reverb_mode_control</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Reverb Mode&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">mixer_chorus_reverb_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">mixer_chorus_reverb_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">mixer_chorus_reverb_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * FM OPL3 chorus/reverb depth</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_fm_depth_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_fm_depth_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">?</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_chorus_depth</span> <span class="o">:</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_reverb_depth</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixer_fm_depth_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val1</span><span class="p">;</span>
	
	<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_chorus_depth</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_chorus_depth</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_reverb_depth</span><span class="p">;</span>
		<span class="n">emu</span><span class="o">-&gt;</span><span class="n">fm_reverb_depth</span> <span class="o">=</span> <span class="n">val1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">snd_emu8000_init_fm</span><span class="p">(</span><span class="n">emu</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mixer_fm_chorus_depth_control</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;FM Chorus Depth&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">mixer_fm_depth_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">mixer_fm_depth_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">mixer_fm_depth_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">mixer_fm_reverb_depth_control</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;FM Reverb Depth&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">mixer_fm_depth_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">mixer_fm_depth_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">mixer_fm_depth_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">mixer_defs</span><span class="p">[</span><span class="n">EMU8000_NUM_CONTROLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">mixer_bass_control</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mixer_treble_control</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mixer_chorus_mode_control</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mixer_reverb_mode_control</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mixer_fm_chorus_depth_control</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">mixer_fm_reverb_depth_control</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * create and attach mixer elements for WaveTable treble/bass controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_emu8000_create_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">emu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">emu</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">control_lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMU8000_NUM_CONTROLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="n">mixer_defs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">emu</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">__error:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EMU8000_NUM_CONTROLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">emu</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">snd_ctl_remove</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">emu</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">controls_rwsem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * free resources</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu8000_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">res_port1</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">res_port2</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">res_port3</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_emu8000_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_emu8000_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize and register emu8000 synth device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_emu8000_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq_ports</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_seq_device</span> <span class="o">**</span><span class="n">awe_ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_seq_device</span> <span class="o">*</span><span class="n">awe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_emu8000_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">awe_ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">awe_ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">seq_ports</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">port1</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">port2</span> <span class="o">=</span> <span class="n">port</span> <span class="o">+</span> <span class="mh">0x400</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">port3</span> <span class="o">=</span> <span class="n">port</span> <span class="o">+</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">res_port1</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Emu8000-1&quot;</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">res_port2</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">port2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Emu8000-2&quot;</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">res_port3</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">port3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Emu8000-3&quot;</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sbawe: can&#39;t grab ports 0x%lx, 0x%lx, 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">port1</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">port2</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">port3</span><span class="p">);</span>
		<span class="n">snd_emu8000_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">seq_ports</span> <span class="o">=</span> <span class="n">seq_ports</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">bass_level</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">treble_level</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">chorus_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">reverb_mode</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fm_chorus_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fm_reverb_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_emu8000_detect</span><span class="p">(</span><span class="n">hw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_emu8000_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_emu8000_init_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_emu8000_create_mixer</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hw</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_emu8000_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_CODEC</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_emu8000_free</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if defined(CONFIG_SND_SEQUENCER) || (defined(MODULE) &amp;&amp; defined(CONFIG_SND_SEQUENCER_MODULE))</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_seq_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">SNDRV_SEQ_DEV_ID_EMU8000</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span><span class="o">*</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">awe</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">awe</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;EMU-8000&quot;</span><span class="p">);</span>
		<span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_emu8000</span> <span class="o">**</span><span class="p">)</span><span class="n">SNDRV_SEQ_DEVICE_ARGPTR</span><span class="p">(</span><span class="n">awe</span><span class="p">)</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">awe</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">awe_ret</span><span class="p">)</span>
		<span class="o">*</span><span class="n">awe_ret</span> <span class="o">=</span> <span class="n">awe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * exported stuff</span>
<span class="cm"> */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_poke</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_peek</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_poke_dw</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_peek_dw</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_dma_chan</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_init_fm</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_load_chorus_fx</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_load_reverb_fx</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_update_chorus_mode</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_update_reverb_mode</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_emu8000_update_equalizer</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
