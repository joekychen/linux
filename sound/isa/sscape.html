<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › isa › sscape.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sscape.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Low-level ALSA driver for the ENSONIQ SoundScape</span>
<span class="cm"> *   Copyright (c) by Chris Rankin</span>
<span class="cm"> *</span>
<span class="cm"> *   This driver was written in part using information obtained from</span>
<span class="cm"> *   the OSS/Free SoundScape driver, written by Hannu Savolainen.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/isa.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/wss.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Chris Rankin&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ENSONIQ SoundScape driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;sndscape.co0&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;sndscape.co1&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;sndscape.co2&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;sndscape.co3&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;sndscape.co4&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;scope.cod&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span><span class="o">*</span> <span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">wss_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_DMA</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma2</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_DMA</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">joystick</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index number for SoundScape soundcard&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Description for SoundScape card&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;Port # for SoundScape driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">wss_port</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wss_port</span><span class="p">,</span> <span class="s">&quot;WSS Port # for SoundScape driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ # for SoundScape driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">,</span> <span class="s">&quot;MPU401 IRQ # for SoundScape driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;DMA # for SoundScape driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">dma2</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma2</span><span class="p">,</span> <span class="s">&quot;DMA2 # for SoundScape driver.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="s">&quot;Enable gameport.&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isa_registered</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pnp_registered</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="n">sscape_pnpids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;ENS3081&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">devs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;ENS0000&quot;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span> <span class="cm">/* Soundscape PnP */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;ENS4081&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">devs</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;ENS1011&quot;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>	<span class="cm">/* VIVO90 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="p">}</span>	<span class="cm">/* end */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp_card</span><span class="p">,</span> <span class="n">sscape_pnpids</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cp">#define HOST_CTRL_IO(i)  ((i) + 2)</span>
<span class="cp">#define HOST_DATA_IO(i)  ((i) + 3)</span>
<span class="cp">#define ODIE_ADDR_IO(i)  ((i) + 4)</span>
<span class="cp">#define ODIE_DATA_IO(i)  ((i) + 5)</span>
<span class="cp">#define CODEC_IO(i)      ((i) + 8)</span>

<span class="cp">#define IC_ODIE  1</span>
<span class="cp">#define IC_OPUS  2</span>

<span class="cp">#define RX_READY 0x01</span>
<span class="cp">#define TX_READY 0x02</span>

<span class="cp">#define CMD_ACK			0x80</span>
<span class="cp">#define CMD_SET_MIDI_VOL	0x84</span>
<span class="cp">#define CMD_GET_MIDI_VOL	0x85</span>
<span class="cp">#define CMD_XXX_MIDI_VOL	0x86</span>
<span class="cp">#define CMD_SET_EXTMIDI		0x8a</span>
<span class="cp">#define CMD_GET_EXTMIDI		0x8b</span>
<span class="cp">#define CMD_SET_MT32		0x8c</span>
<span class="cp">#define CMD_GET_MT32		0x8d</span>

<span class="k">enum</span> <span class="n">GA_REG</span> <span class="p">{</span>
	<span class="n">GA_INTSTAT_REG</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">GA_INTENA_REG</span><span class="p">,</span>
	<span class="n">GA_DMAA_REG</span><span class="p">,</span>
	<span class="n">GA_DMAB_REG</span><span class="p">,</span>
	<span class="n">GA_INTCFG_REG</span><span class="p">,</span>
	<span class="n">GA_DMACFG_REG</span><span class="p">,</span>
	<span class="n">GA_CDCFG_REG</span><span class="p">,</span>
	<span class="n">GA_SMCFGA_REG</span><span class="p">,</span>
	<span class="n">GA_SMCFGB_REG</span><span class="p">,</span>
	<span class="n">GA_HMCTL_REG</span>
<span class="p">};</span>

<span class="cp">#define DMA_8BIT  0x80</span>


<span class="k">enum</span> <span class="n">card_type</span> <span class="p">{</span>
	<span class="n">MEDIA_FX</span><span class="p">,</span>	<span class="cm">/* Sequoia S-1000 */</span>
	<span class="n">SSCAPE</span><span class="p">,</span>		<span class="cm">/* Sequoia S-2000 */</span>
	<span class="n">SSCAPE_PNP</span><span class="p">,</span>
	<span class="n">SSCAPE_VIVO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">soundscape</span> <span class="p">{</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ic_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">card_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">io_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">wss_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">midi_vol</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define INVALID_IRQ  ((unsigned)-1)</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="nf">get_card_soundscape</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocates some kernel memory that we can use for DMA.</span>
<span class="cm"> * I think this means that the memory has to map to</span>
<span class="cm"> * contiguous pages of physical memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="nf">get_dmabuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages_fallback</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
						 <span class="n">snd_dma_isa_data</span><span class="p">(),</span>
						 <span class="n">size</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Failed to allocate &quot;</span>
					    <span class="s">&quot;%lu bytes for DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release the DMA-able kernel memory ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_dmabuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function writes to the SoundScape&#39;s control registers,</span>
<span class="cm"> * but doesn&#39;t do any locking. It&#39;s up to the caller to do that.</span>
<span class="cm"> * This is why this function is &quot;unsafe&quot; ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sscape_write_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span> <span class="k">enum</span> <span class="n">GA_REG</span> <span class="n">reg</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ODIE_DATA_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write to the SoundScape&#39;s control registers, and do the</span>
<span class="cm"> * necessary locking ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sscape_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">enum</span> <span class="n">GA_REG</span> <span class="n">reg</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read from the SoundScape&#39;s control registers, but leave any</span>
<span class="cm"> * locking to the caller. This is why the function is &quot;unsafe&quot; ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sscape_read_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span>
					       <span class="k">enum</span> <span class="n">GA_REG</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">ODIE_DATA_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Puts the SoundScape into &quot;host&quot; mode, as compared to &quot;MIDI&quot; mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_host_mode_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">HOST_CTRL_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Puts the SoundScape into &quot;MIDI&quot; mode, as compared to &quot;host&quot; mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_midi_mode_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">HOST_CTRL_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the SoundScape&#39;s host-mode control register, but leave</span>
<span class="cm"> * any locking issues to the caller ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">host_read_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">HOST_CTRL_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">RX_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">HOST_DATA_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read the SoundScape&#39;s host-mode control register, performing</span>
<span class="cm"> * a limited amount of busy-waiting if the register isn&#39;t ready.</span>
<span class="cm"> * Also leaves all locking-issues to the caller ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">host_read_ctrl_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(((</span><span class="n">data</span> <span class="o">=</span> <span class="n">host_read_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="o">--</span><span class="n">timeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* while */</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write to the SoundScape&#39;s host-mode control registers, but</span>
<span class="cm"> * leave any locking issues to the caller ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">host_write_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">HOST_CTRL_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TX_READY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">HOST_DATA_IO</span><span class="p">(</span><span class="n">io_base</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write to the SoundScape&#39;s host-mode control registers, performing</span>
<span class="cm"> * a limited amount of busy-waiting if the register isn&#39;t ready.</span>
<span class="cm"> * Also leaves all locking-issues to the caller ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">host_write_ctrl_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">host_write_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="o">--</span><span class="n">timeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* while */</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Check that the MIDI subsystem is operational. If it isn&#39;t,</span>
<span class="cm"> * then we will hang the computer if we try to use it ...</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This check is based upon observation, not documentation.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">verify_mpu401</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">snd_mpu401</span> <span class="o">*</span><span class="n">mpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">MPU401C</span><span class="p">(</span><span class="n">mpu</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is apparently the standard way to initailise an MPU-401</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">initialise_mpu401</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">snd_mpu401</span> <span class="o">*</span><span class="n">mpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MPU401D</span><span class="p">(</span><span class="n">mpu</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tell the SoundScape to activate the AD1845 chip (I think).</span>
<span class="cm"> * The AD1845 detection fails if we *don&#39;t* do this, so I</span>
<span class="cm"> * think that this is a good idea ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">activate_ad1845_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xcf</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_CDCFG_REG</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do the necessary ALSA-level cleanup to deallocate our driver ...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">soundscape_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_res</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">wss_res</span><span class="p">);</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tell the SoundScape to begin a DMA tranfer using the given channel.</span>
<span class="cm"> * All locking issues are left to the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sscape_start_dma_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span> <span class="k">enum</span> <span class="n">GA_REG</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for a DMA transfer to complete. This is a &quot;limited busy-wait&quot;,</span>
<span class="cm"> * and all locking issues are left to the caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sscape_wait_dma_unsafe</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">io_base</span><span class="p">,</span> <span class="k">enum</span> <span class="n">GA_REG</span> <span class="n">reg</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="o">--</span><span class="n">timeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* while */</span>

	<span class="k">return</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the On-Board Processor to return its start-up</span>
<span class="cm"> * acknowledgement sequence. This wait is too long for</span>
<span class="cm"> * us to perform &quot;busy-waiting&quot;, and so we must sleep.</span>
<span class="cm"> * This in turn means that we must not be holding any</span>
<span class="cm"> * spinlocks when we call this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">obp_startup_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">host_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mh">0xfe</span> <span class="o">||</span> <span class="n">x</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the host to return its start-up acknowledgement</span>
<span class="cm"> * sequence. This wait is too long for us to perform</span>
<span class="cm"> * &quot;busy-waiting&quot;, and so we must sleep. This in turn means</span>
<span class="cm"> * that we must not be holding any spinlocks when we call</span>
<span class="cm"> * this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">host_startup_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">host_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mh">0xfe</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Upload a byte-stream into the SoundScape using DMA channel A.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">upload_dma_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="p">,</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the board ...</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable the DMA channels and configure them ...</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">DMA_8BIT</span><span class="p">;</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMAA_REG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMAB_REG</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take the board out of reset ...</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Upload the firmware to the SoundScape</span>
<span class="cm">	 * board through the DMA channel ...</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dma</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dma</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">snd_dma_program</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1</span><span class="p">,</span> <span class="n">dma</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">DMA_MODE_WRITE</span><span class="p">);</span>
		<span class="n">sscape_start_dma_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMAA_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sscape_wait_dma_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMAA_REG</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t forget to release this spinlock we&#39;re holding</span>
<span class="cm">			 */</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;sscape: DMA upload has timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">_release_dma</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* while */</span>

	<span class="n">set_host_mode_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Boot the board ... (I think)</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If all has gone well, then the board should acknowledge</span>
<span class="cm">	 * the new upload and tell us that it has rebooted OK. We</span>
<span class="cm">	 * give it 5 seconds (max) ...</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obp_startup_ack</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: No response &quot;</span>
				    <span class="s">&quot;from on-board processor after upload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host_startup_ack</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;sscape: SoundScape failed to initialise</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">_release_dma:</span>
	<span class="cm">/*</span>
<span class="cm">	 * NOTE!!! We are NOT holding any spinlocks at this point !!!</span>
<span class="cm">	 */</span>
	<span class="n">sscape_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GA_DMAA_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ic_type</span> <span class="o">==</span> <span class="n">IC_OPUS</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x70</span><span class="p">));</span>
	<span class="n">free_dmabuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Upload the bootblock(?) into the SoundScape. The only</span>
<span class="cm"> * purpose of this block of code seems to be to tell</span>
<span class="cm"> * us which version of the microcode we should be using.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sscape_upload_bootblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">init_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_fw</span><span class="p">,</span> <span class="s">&quot;scope.cod&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Error loading scope.cod&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">upload_dma_data</span><span class="p">(</span><span class="n">sscape</span><span class="p">,</span> <span class="n">init_fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">init_fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">init_fw</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">host_read_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_SMCFGA_REG</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;sscape: timeout reading firmware version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">data</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Upload the microcode into the SoundScape.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sscape_upload_microcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">init_fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;sndscape.co%d&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_fw</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Error loading sndscape.co%d&quot;</span><span class="p">,</span>
				<span class="n">version</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">upload_dma_data</span><span class="p">(</span><span class="n">sscape</span><span class="p">,</span> <span class="n">init_fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">init_fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sscape: MIDI firmware loaded %d KBs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">init_fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">init_fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mixer control for the SoundScape&#39;s MIDI device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sscape_midi_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sscape_midi_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">midi_vol</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sscape_midi_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">uctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kctl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">new_val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">new_val</span> <span class="o">=</span> <span class="n">uctl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">127</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to put the board into HOST mode before we</span>
<span class="cm">	 * can send any volume-changing HOST commands ...</span>
<span class="cm">	 */</span>
	<span class="n">set_host_mode_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * To successfully change the MIDI volume setting, you seem to</span>
<span class="cm">	 * have to write a volume command, write the new volume value,</span>
<span class="cm">	 * and then perform another volume-related command. Perhaps the</span>
<span class="cm">	 * first command is an &quot;open&quot; and the second command is a &quot;close&quot;?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">midi_vol</span> <span class="o">==</span> <span class="n">new_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__skip_change</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">CMD_SET_MIDI_VOL</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">CMD_XXX_MIDI_VOL</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
		 <span class="o">&amp;&amp;</span> <span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">midi_vol</span> <span class="o">=</span> <span class="n">new_val</span><span class="p">;</span>
<span class="nl">__skip_change:</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take the board out of HOST mode and back into MIDI mode ...</span>
<span class="cm">	 */</span>
	<span class="n">set_midi_mode_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">midi_mixer_ctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MIDI&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">sscape_midi_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">sscape_midi_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">sscape_midi_put</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The SoundScape can use two IRQs from a possible set of four.</span>
<span class="cm"> * These IRQs are encoded as bit patterns so that they can be</span>
<span class="cm"> * written to the control registers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">__devinit</span> <span class="nf">get_irq_config</span><span class="p">(</span><span class="kt">int</span> <span class="n">sscape_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">valid_irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">old_irq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">15</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscape_type</span> <span class="o">==</span> <span class="n">MEDIA_FX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cfg</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">old_irq</span><span class="p">);</span> <span class="o">++</span><span class="n">cfg</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">old_irq</span><span class="p">[</span><span class="n">cfg</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cfg</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_irq</span><span class="p">);</span> <span class="o">++</span><span class="n">cfg</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">valid_irq</span><span class="p">[</span><span class="n">cfg</span><span class="p">])</span>
				<span class="k">return</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">INVALID_IRQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Perform certain arcane port-checks to see whether there</span>
<span class="cm"> * is a SoundScape board lurking behind the given ports.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">detect_sscape</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">long</span> <span class="n">wss_io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The following code is lifted from the original OSS driver,</span>
<span class="cm">	 * and as I don&#39;t have a datasheet I cannot really comment</span>
<span class="cm">	 * on what it is doing...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">HOST_CTRL_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x78</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ic_type</span> <span class="o">=</span> <span class="n">IC_ODIE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">ic_type</span> <span class="o">=</span> <span class="n">IC_OPUS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xfa</span><span class="p">,</span> <span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x9f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0a</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x9f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0e</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="n">ODIE_ADDR_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ODIE_DATA_IO</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SSCAPE_VIVO</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="mh">0x9f</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x0e</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ic_type</span> <span class="o">==</span> <span class="n">IC_OPUS</span><span class="p">)</span>
		<span class="n">activate_ad1845_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SSCAPE_VIVO</span><span class="p">)</span>
		<span class="n">wss_io</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">d</span>  <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">d</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">);</span>

	<span class="cm">/* wait for WSS codec */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">wss_io</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">wss_io</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">wss_io</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_done</span><span class="p">;</span>

	<span class="n">d</span>  <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">wss_io</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEDIA_FX</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">d</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="cm">/* wait for WSS codec */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">;</span> <span class="n">d</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">wss_io</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * SoundScape successfully detected!</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">_done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA callback function, called when attempting to open the MIDI device.</span>
<span class="cm"> * Check that the MIDI firmware has been loaded, because we don&#39;t want</span>
<span class="cm"> * to crash the machine. Also check that someone isn&#39;t using the hardware</span>
<span class="cm"> * IOCTL device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpu401_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mpu401</span> <span class="o">*</span><span class="n">mpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verify_mpu401</span><span class="p">(</span><span class="n">mpu</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: MIDI disabled, &quot;</span>
				    <span class="s">&quot;please load firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialse an MPU-401 subdevice for MIDI support on the SoundScape.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">create_mpu401</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devnum</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rawmidi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">devnum</span><span class="p">,</span> <span class="n">MPU401_HW_MPU401</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
				  <span class="n">MPU401_INFO_INTEGRATED</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rawmidi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mpu401</span> <span class="o">*</span><span class="n">mpu</span> <span class="o">=</span> <span class="n">rawmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="n">mpu</span><span class="o">-&gt;</span><span class="n">open_input</span> <span class="o">=</span> <span class="n">mpu401_open</span><span class="p">;</span>
		<span class="n">mpu</span><span class="o">-&gt;</span><span class="n">open_output</span> <span class="o">=</span> <span class="n">mpu401_open</span><span class="p">;</span>
		<span class="n">mpu</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sscape</span><span class="p">;</span>

		<span class="n">initialise_mpu401</span><span class="p">(</span><span class="n">mpu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Create an AD1845 PCM subdevice on the SoundScape. The AD1845</span>
<span class="cm"> * is very much like a CS4231, with a few extra bits. We will</span>
<span class="cm"> * try to support at least some of the extra bits by overriding</span>
<span class="cm"> * some of the CS4231 callback.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">create_ad1845</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">port</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">codec_type</span> <span class="o">=</span> <span class="n">WSS_HW_DETECT</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEDIA_FX</span>:
	<span class="k">case</span> <span class="n">SSCAPE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * There are some freak examples of early Soundscape cards</span>
<span class="cm">		 * with CS4231 instead of AD1848/CS4248. Unfortunately, the</span>
<span class="cm">		 * CS4231 works only in CS4248 compatibility mode on</span>
<span class="cm">		 * these cards so force it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">ic_type</span> <span class="o">!=</span> <span class="n">IC_OPUS</span><span class="p">)</span>
			<span class="n">codec_type</span> <span class="o">=</span> <span class="n">WSS_HW_AD1848</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SSCAPE_VIVO</span>:
		<span class="n">port</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">dma1</span><span class="p">,</span> <span class="n">dma2</span><span class="p">,</span>
			     <span class="n">codec_type</span><span class="p">,</span> <span class="n">WSS_HWSHARE_DMA1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SSCAPE_VIVO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The input clock frequency on the SoundScape must</span>
<span class="cm">			 * be 14.31818 MHz, because we must set this register</span>
<span class="cm">			 * to get the playback to sound correct ...</span>
<span class="cm">			 */</span>
			<span class="n">snd_wss_mce_up</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">snd_wss_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AD1845_CLOCK</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">snd_wss_mce_down</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: No PCM device &quot;</span>
					    <span class="s">&quot;for AD1845 chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: No mixer device &quot;</span>
					    <span class="s">&quot;for AD1845 chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hardware</span> <span class="o">!=</span> <span class="n">WSS_HW_AD1848</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_timer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: No timer device &quot;</span>
						    <span class="s">&quot;for AD1845 chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SSCAPE_VIVO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
					  <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">midi_mixer_ctl</span><span class="p">,</span> <span class="n">chip</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Could not create &quot;</span>
						    <span class="s">&quot;MIDI mixer control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">_error</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">_error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Create an ALSA soundcard entry for the SoundScape, using</span>
<span class="cm"> * the given list of port, IRQ and DMA resources.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">create_sscape</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">dma_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">irq_cfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">mpu_irq_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">io_res</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">wss_res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab IO ports that we will need to probe so that we</span>
<span class="cm">	 * can detect and control this hardware ...</span>
<span class="cm">	 */</span>
	<span class="n">io_res</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;SoundScape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;sscape: can&#39;t grab port 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wss_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SSCAPE_VIVO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wss_res</span> <span class="o">=</span> <span class="n">request_region</span><span class="p">(</span><span class="n">wss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;SoundScape&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wss_res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: can&#39;t grab port 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">wss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">_release_region</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab one DMA channel ...</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="s">&quot;SoundScape&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: can&#39;t grab DMA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">_release_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_res</span> <span class="o">=</span> <span class="n">io_res</span><span class="p">;</span>
	<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">wss_res</span> <span class="o">=</span> <span class="n">wss_res</span><span class="p">;</span>
	<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">detect_sscape</span><span class="p">(</span><span class="n">sscape</span><span class="p">,</span> <span class="n">wss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: hardware not detected at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_release_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MEDIA_FX</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MediaFX/SoundFX&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSCAPE</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Soundscape&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSCAPE_PNP</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Soundscape PnP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SSCAPE_VIVO</span>:
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Soundscape VIVO&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;unknown Soundscape&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sscape: %s card detected at 0x%x, using IRQ %d, DMA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">name</span><span class="p">,</span> <span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that the user didn&#39;t pass us garbage data ...</span>
<span class="cm">	 */</span>
	<span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">get_irq_config</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_cfg</span> <span class="o">==</span> <span class="n">INVALID_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Invalid IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_release_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mpu_irq_cfg</span> <span class="o">=</span> <span class="n">get_irq_config</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_irq_cfg</span> <span class="o">==</span> <span class="n">INVALID_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Invalid IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_release_dma</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the on-board devices where their resources are (I think -</span>
<span class="cm">	 * I can&#39;t be sure without a datasheet ... So many magic values!)</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_SMCFGA_REG</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_SMCFGB_REG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable and configure the DMA channels ...</span>
<span class="cm">	 */</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMACFG_REG</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">dma_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">ic_type</span> <span class="o">==</span> <span class="n">IC_OPUS</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x70</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMAA_REG</span><span class="p">,</span> <span class="n">dma_cfg</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_DMAB_REG</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">mpu_irq_cfg</span> <span class="o">|=</span> <span class="n">mpu_irq_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sscape_read_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">joystick</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_HMCTL_REG</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_INTCFG_REG</span><span class="p">,</span> <span class="mh">0xf0</span> <span class="o">|</span> <span class="n">mpu_irq_cfg</span><span class="p">);</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
			    <span class="n">GA_CDCFG_REG</span><span class="p">,</span> <span class="mh">0x09</span> <span class="o">|</span> <span class="n">DMA_8BIT</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq_cfg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="cm">/*</span>
<span class="cm">	 * Enable the master IRQ ...</span>
<span class="cm">	 */</span>
	<span class="n">sscape_write_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">GA_INTENA_REG</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have now enabled the codec chip, and so we should</span>
<span class="cm">	 * detect the AD1845 device ...</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">create_ad1845</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">wss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
			    <span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">dma2</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;sscape: No AD1845 device at 0x%lx, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">wss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">_release_dma</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;SoundScape&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s at 0x%lx, IRQ %d, DMA1 %d, DMA2 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">name</span><span class="p">,</span> <span class="n">sscape</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">sscape</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		 <span class="n">sscape</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma1</span><span class="p">,</span> <span class="n">sscape</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma2</span><span class="p">);</span>

<span class="cp">#define MIDI_DEVNUM  0</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SSCAPE_VIVO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sscape_upload_bootblock</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">sscape_upload_microcode</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">create_mpu401</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">MIDI_DEVNUM</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
					    <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Failed to create &quot;</span>
						<span class="s">&quot;MPU-401 device at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
				<span class="k">goto</span> <span class="n">_release_dma</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Initialize mixer</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">midi_vol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
						<span class="n">CMD_SET_MIDI_VOL</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
						<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">midi_vol</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
						<span class="n">CMD_XXX_MIDI_VOL</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
						<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">midi_vol</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
						<span class="n">CMD_SET_EXTMIDI</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">host_write_ctrl_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span> <span class="n">CMD_ACK</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

			<span class="n">set_midi_mode_unsafe</span><span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now that we have successfully created this sound card,</span>
<span class="cm">	 * it is safe to store the pointer.</span>
<span class="cm">	 * NOTE: we only register the sound card&#39;s &quot;destructor&quot;</span>
<span class="cm">	 *       function now that our &quot;constructor&quot; has completed.</span>
<span class="cm">	 */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">soundscape_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_release_dma:</span>
	<span class="n">free_dma</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>

<span class="nl">_release_region:</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">wss_res</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">io_res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_sscape_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure we were given ALL of the other parameters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_IRQ</span> <span class="o">||</span>
	    <span class="n">mpu_irq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_IRQ</span> <span class="o">||</span>
	    <span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;sscape: insufficient parameters, &quot;</span>
		       <span class="s">&quot;need IO, IRQ, MPU-IRQ and DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_sscape_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SSCAPE</span><span class="p">;</span>

	<span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">create_sscape</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_release_card</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Failed to register sound card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_release_card</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_release_card:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">snd_sscape_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">));</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DEV_NAME &quot;sscape&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isa_driver</span> <span class="n">snd_sscape_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">snd_sscape_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">snd_sscape_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_sscape_remove</span><span class="p">),</span>
	<span class="cm">/* FIXME: suspend/resume */</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DEV_NAME</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_next_autoindex</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span> <span class="o">&amp;&amp;</span> <span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sscape_pnp_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span><span class="n">pcard</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_card_device_id</span> <span class="o">*</span><span class="n">pid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundscape</span> <span class="o">*</span><span class="n">sscape</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow this function to fail *quietly* if all the ISA PnP</span>
<span class="cm">	 * devices were configured using module parameters instead.</span>
<span class="cm">	 */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">get_next_autoindex</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check that we still have room for another sound card ...</span>
<span class="cm">	 */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_request_card_device</span><span class="p">(</span><span class="n">pcard</span><span class="p">,</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_is_active</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;sscape: device is inactive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create a new ALSA sound card entry, in anticipation</span>
<span class="cm">	 * of detecting our hardware ...</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundscape</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sscape</span> <span class="o">=</span> <span class="n">get_card_soundscape</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify card model ...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;ENS4081&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
		<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SSCAPE_VIVO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SSCAPE_PNP</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read the correct parameters off the ISA PnP bus ...</span>
<span class="cm">	 */</span>
	<span class="n">port</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mpu_irq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dma</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscape</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SSCAPE_PNP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">wss_port</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">CODEC_IO</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wss_port</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dma2</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_dma</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcard</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">create_sscape</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">_release_card</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sscape: Failed to register sound card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">_release_card</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pnp_set_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="o">++</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">_release_card:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sscape_pnp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_card_link</span> <span class="o">*</span> <span class="n">pcard</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pnp_get_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">));</span>
	<span class="n">pnp_set_card_drvdata</span><span class="p">(</span><span class="n">pcard</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_card_driver</span> <span class="n">sscape_pnpc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">PNP_DRIVER_RES_DO_NOT_CHANGE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sscape&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">sscape_pnpids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sscape_pnp_detect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sscape_pnp_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PNP */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sscape_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">isa_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_sscape_driver</span><span class="p">,</span> <span class="n">SNDRV_CARDS</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">isa_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pnp_register_card_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape_pnpc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">pnp_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isa_registered</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sscape_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PNP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_registered</span><span class="p">)</span>
		<span class="n">pnp_unregister_card_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sscape_pnpc_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isa_registered</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">isa_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_sscape_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sscape_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sscape_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
