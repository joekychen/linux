<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › isa › wavefront › wavefront_synth.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wavefront_synth.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Copyright (C) by Paul Barton-Davis 1998-1999</span>
<span class="cm"> *</span>
<span class="cm"> * Some portions of this file are taken from work that is</span>
<span class="cm"> * copyright (C) by Hannu Savolainen 1993-1996</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed under the GNU GENERAL PUBLIC LICENSE (GPL)</span>
<span class="cm"> * Version 2 (June 1991). See the &quot;COPYING&quot; file distributed with this software</span>
<span class="cm"> * for more info.  </span>
<span class="cm"> */</span>

<span class="cm">/*  </span>
<span class="cm"> * An ALSA lowlevel driver for Turtle Beach ICS2115 wavetable synth</span>
<span class="cm"> *                                             (Maui, Tropez, Tropez Plus)</span>
<span class="cm"> *</span>
<span class="cm"> * This driver supports the onboard wavetable synthesizer (an ICS2115),</span>
<span class="cm"> * including patch, sample and program loading and unloading, conversion</span>
<span class="cm"> * of GUS patches during loading, and full user-level access to all</span>
<span class="cm"> * WaveFront commands. It tries to provide semi-intelligent patch and</span>
<span class="cm"> * sample management as well.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/snd_wavefront.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wf_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* we normally check for &quot;raw state&quot; to firmware</span>
<span class="cm">			  loading. if non-zero, then during driver loading, the</span>
<span class="cm">			  state of the board is ignored, and we reset the</span>
<span class="cm">			  board and load the firmware anyway.</span>
<span class="cm">		       */</span>
		   
<span class="k">static</span> <span class="kt">int</span> <span class="n">fx_raw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* if this is zero, we&#39;ll leave the FX processor in</span>
<span class="cm">			  whatever state it is when the driver is loaded.</span>
<span class="cm">			  The default is to download the microprogram and</span>
<span class="cm">			  associated coefficients to set it up for &quot;default&quot;</span>
<span class="cm">			  operation, whatever that means.</span>
<span class="cm">		       */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_default</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* you can set this to control debugging</span>
<span class="cm">				  during driver loading. it takes any combination</span>
<span class="cm">				  of the WF_DEBUG_* flags defined in</span>
<span class="cm">				  wavefront.h</span>
<span class="cm">			       */</span>

<span class="cm">/* XXX this needs to be made firmware and hardware version dependent */</span>

<span class="cp">#define DEFAULT_OSPATH	&quot;wavefront.os&quot;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ospath</span> <span class="o">=</span> <span class="n">DEFAULT_OSPATH</span><span class="p">;</span> <span class="cm">/* the firmware file name */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wait_usecs</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span> <span class="cm">/* This magic number seems to give pretty optimal</span>
<span class="cm">				throughput based on my limited experimentation.</span>
<span class="cm">				If you want to play around with it and find a better</span>
<span class="cm">				value, be my guest. Remember, the idea is to</span>
<span class="cm">				get a number that causes us to just busy wait</span>
<span class="cm">				for as many WaveFront commands as possible, without</span>
<span class="cm">				coming up with a number so large that we hog the</span>
<span class="cm">				whole CPU.</span>

<span class="cm">				Specifically, with this number, out of about 134,000</span>
<span class="cm">				status waits, only about 250 result in a sleep.</span>
<span class="cm">			    */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sleep_interval</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>   <span class="cm">/* HZ/sleep_interval seconds per sleep */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sleep_tries</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>       <span class="cm">/* number of times we&#39;ll try to sleep */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">reset_time</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>        <span class="cm">/* hundreths of a second we wait after a HW</span>
<span class="cm">				     reset for the expected interrupt.</span>
<span class="cm">				  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ramcheck_time</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>    <span class="cm">/* time in seconds to wait while ROM code</span>
<span class="cm">				     checks on-board RAM.</span>
<span class="cm">				  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">osrun_time</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>       <span class="cm">/* time in seconds we wait for the OS to</span>
<span class="cm">				     start running.</span>
<span class="cm">				  */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wf_raw</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wf_raw</span><span class="p">,</span> <span class="s">&quot;if non-zero, assume that we need to boot the OS&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fx_raw</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fx_raw</span><span class="p">,</span> <span class="s">&quot;if non-zero, assume that the FX process needs help&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_default</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_default</span><span class="p">,</span> <span class="s">&quot;debug parameters for card initialization&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wait_usecs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wait_usecs</span><span class="p">,</span> <span class="s">&quot;how long to wait without sleeping, usecs&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sleep_interval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sleep_interval</span><span class="p">,</span> <span class="s">&quot;how long to sleep when waiting for reply&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sleep_tries</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sleep_tries</span><span class="p">,</span> <span class="s">&quot;how many times to try sleeping during a wait&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ospath</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ospath</span><span class="p">,</span> <span class="s">&quot;pathname to processed ICS2115 OS firmware&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reset_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset_time</span><span class="p">,</span> <span class="s">&quot;how long to wait for a reset to take effect&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ramcheck_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ramcheck_time</span><span class="p">,</span> <span class="s">&quot;how many seconds to wait for the RAM test&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osrun_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osrun_time</span><span class="p">,</span> <span class="s">&quot;how many seconds to wait for the ICS2115 OS&quot;</span><span class="p">);</span>

<span class="cm">/* if WF_DEBUG not defined, no run-time debugging messages will</span>
<span class="cm">   be available via the debug flag setting. Given the current</span>
<span class="cm">   beta state of the driver, this will remain set until a future </span>
<span class="cm">   version.</span>
<span class="cm">*/</span>

<span class="cp">#define WF_DEBUG 1</span>

<span class="cp">#ifdef WF_DEBUG</span>

<span class="cp">#define DPRINT(cond, ...) \</span>
<span class="cp">       if ((dev-&gt;debug &amp; (cond)) == (cond)) { \</span>
<span class="cp">	     snd_printk (__VA_ARGS__); \</span>
<span class="cp">       }</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINT(cond, args...)</span>
<span class="cp">#endif </span><span class="cm">/* WF_DEBUG */</span><span class="cp"></span>

<span class="cp">#define LOGNAME &quot;WaveFront: &quot;</span>

<span class="cm">/* bitmasks for WaveFront status port value */</span>

<span class="cp">#define STAT_RINTR_ENABLED	0x01</span>
<span class="cp">#define STAT_CAN_READ		0x02</span>
<span class="cp">#define STAT_INTR_READ		0x04</span>
<span class="cp">#define STAT_WINTR_ENABLED	0x10</span>
<span class="cp">#define STAT_CAN_WRITE		0x20</span>
<span class="cp">#define STAT_INTR_WRITE		0x40</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wavefront_delete_sample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sampnum</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wavefront_find_free_sample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">wavefront_command</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">action</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_cnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_ack</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">wavefront_errors</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="s">&quot;Bad sample number&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="s">&quot;Out of sample memory&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x03</span><span class="p">,</span> <span class="s">&quot;Bad patch number&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="s">&quot;Error in number of voices&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="s">&quot;Sample load already in progress&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="s">&quot;No sample load request pending&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="s">&quot;Bad MIDI channel number&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;Download Record Error&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x80</span><span class="p">,</span> <span class="s">&quot;Success&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define NEEDS_ACK 1</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wavefront_command</span> <span class="n">wavefront_commands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">WFC_SET_SYNTHVOL</span><span class="p">,</span> <span class="s">&quot;set synthesizer volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_GET_SYNTHVOL</span><span class="p">,</span> <span class="s">&quot;get synthesizer volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_SET_NVOICES</span><span class="p">,</span> <span class="s">&quot;set number of voices&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_GET_NVOICES</span><span class="p">,</span> <span class="s">&quot;get number of voices&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_SET_TUNING</span><span class="p">,</span> <span class="s">&quot;set synthesizer tuning&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_GET_TUNING</span><span class="p">,</span> <span class="s">&quot;get synthesizer tuning&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DISABLE_CHANNEL</span><span class="p">,</span> <span class="s">&quot;disable synth channel&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_ENABLE_CHANNEL</span><span class="p">,</span> <span class="s">&quot;enable synth channel&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_GET_CHANNEL_STATUS</span><span class="p">,</span> <span class="s">&quot;get synth channel status&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_MISYNTH_OFF</span><span class="p">,</span> <span class="s">&quot;disable midi-in to synth&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_MISYNTH_ON</span><span class="p">,</span> <span class="s">&quot;enable midi-in to synth&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_VMIDI_ON</span><span class="p">,</span> <span class="s">&quot;enable virtual midi mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_VMIDI_OFF</span><span class="p">,</span> <span class="s">&quot;disable virtual midi mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_MIDI_STATUS</span><span class="p">,</span> <span class="s">&quot;report midi status&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_FIRMWARE_VERSION</span><span class="p">,</span> <span class="s">&quot;report firmware version&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_HARDWARE_VERSION</span><span class="p">,</span> <span class="s">&quot;report hardware version&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_GET_NSAMPLES</span><span class="p">,</span> <span class="s">&quot;report number of samples&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_INSTOUT_LEVELS</span><span class="p">,</span> <span class="s">&quot;report instantaneous output levels&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_PEAKOUT_LEVELS</span><span class="p">,</span> <span class="s">&quot;report peak output levels&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_SAMPLE</span><span class="p">,</span> <span class="s">&quot;download sample&quot;</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">WF_SAMPLE_BYTES</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_BLOCK</span><span class="p">,</span> <span class="s">&quot;download block&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_SAMPLE_HEADER</span><span class="p">,</span> <span class="s">&quot;download sample header&quot;</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">WF_SAMPLE_HDR_BYTES</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_UPLOAD_SAMPLE_HEADER</span><span class="p">,</span> <span class="s">&quot;upload sample header&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>

	<span class="cm">/* This command requires a variable number of bytes to be written.</span>
<span class="cm">	   There is a hack in snd_wavefront_cmd() to support this. The actual</span>
<span class="cm">	   count is passed in as the read buffer ptr, cast appropriately.</span>
<span class="cm">	   Ugh.</span>
<span class="cm">	*/</span>

	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_MULTISAMPLE</span><span class="p">,</span> <span class="s">&quot;download multisample&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>

	<span class="cm">/* This one is a hack as well. We just read the first byte of the</span>
<span class="cm">	   response, don&#39;t fetch an ACK, and leave the rest to the </span>
<span class="cm">	   calling function. Ugly, ugly, ugly.</span>
<span class="cm">	*/</span>

	<span class="p">{</span> <span class="n">WFC_UPLOAD_MULTISAMPLE</span><span class="p">,</span> <span class="s">&quot;upload multisample&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_SAMPLE_ALIAS</span><span class="p">,</span> <span class="s">&quot;download sample alias&quot;</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">WF_ALIAS_BYTES</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_UPLOAD_SAMPLE_ALIAS</span><span class="p">,</span> <span class="s">&quot;upload sample alias&quot;</span><span class="p">,</span> <span class="n">WF_ALIAS_BYTES</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DELETE_SAMPLE</span><span class="p">,</span> <span class="s">&quot;delete sample&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_IDENTIFY_SAMPLE_TYPE</span><span class="p">,</span> <span class="s">&quot;identify sample type&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_UPLOAD_SAMPLE_PARAMS</span><span class="p">,</span> <span class="s">&quot;upload sample parameters&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_REPORT_FREE_MEMORY</span><span class="p">,</span> <span class="s">&quot;report free memory&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;download patch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_UPLOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;upload patch&quot;</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_PROGRAM</span><span class="p">,</span> <span class="s">&quot;download program&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_UPLOAD_PROGRAM</span><span class="p">,</span> <span class="s">&quot;upload program&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DOWNLOAD_EDRUM_PROGRAM</span><span class="p">,</span> <span class="s">&quot;download enhanced drum program&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	  <span class="n">NEEDS_ACK</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_UPLOAD_EDRUM_PROGRAM</span><span class="p">,</span> <span class="s">&quot;upload enhanced drum program&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_SET_EDRUM_CHANNEL</span><span class="p">,</span> <span class="s">&quot;set enhanced drum program channel&quot;</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_DISABLE_DRUM_PROGRAM</span><span class="p">,</span> <span class="s">&quot;disable drum program&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_REPORT_CHANNEL_PROGRAMS</span><span class="p">,</span> <span class="s">&quot;report channel program numbers&quot;</span><span class="p">,</span>
	  <span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">WFC_NOOP</span><span class="p">,</span> <span class="s">&quot;the no-op command&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NEEDS_ACK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">wavefront_errorstr</span> <span class="p">(</span><span class="kt">int</span> <span class="n">errnum</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wavefront_errors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errstr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_errors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errnum</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">wavefront_errors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errstr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;Unknown WaveFront error&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wavefront_command</span> <span class="o">*</span>
<span class="nf">wavefront_get_command</span> <span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span> 

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wavefront_commands</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">wavefront_commands</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">wavefront_commands</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">wavefront_status</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> 

<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">status_port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_sleep</span> <span class="p">(</span><span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">limit</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_wait</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span>             <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Spin for a short period of time, because &gt;99% of all</span>
<span class="cm">	   requests to the WaveFront can be serviced inline like this.</span>
<span class="cm">	*/</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wait_usecs</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_status</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sleep_tries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_status</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_sleep</span> <span class="p">(</span><span class="n">HZ</span><span class="o">/</span><span class="n">sleep_interval</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_read</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_wait</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">STAT_CAN_READ</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">inb</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">);</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;read timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_write</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_wait</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">STAT_CAN_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outb</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;write timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> 
		   <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rbuf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wbuf</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ack</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wavefront_command</span> <span class="o">*</span><span class="n">wfcmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wfcmd</span> <span class="o">=</span> <span class="n">wavefront_get_command</span> <span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;command 0x%x not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hack to handle the one variable-size write command. See</span>
<span class="cm">	   wavefront_send_multisample() for the other half of this</span>
<span class="cm">	   gross and ugly strategy.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">WFC_DOWNLOAD_MULTISAMPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rbuf</span><span class="p">;</span>
		<span class="n">rbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;0x%x [%s] (%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">,</span>
			       <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">need_ack</span><span class="p">);</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">))</span> <span class="p">{</span> 
		<span class="n">DPRINT</span> <span class="p">((</span><span class="n">WF_DEBUG_IO</span><span class="o">|</span><span class="n">WF_DEBUG_CMD</span><span class="p">),</span> <span class="s">&quot;cannot request &quot;</span>
						     <span class="s">&quot;0x%x [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						     <span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;writing %d bytes &quot;</span>
					<span class="s">&quot;for 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_IO</span><span class="p">,</span> <span class="s">&quot;bad write for byte &quot;</span>
						      <span class="s">&quot;%d of 0x%x [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;write[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;reading %d ints &quot;</span>
					<span class="s">&quot;for 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_IO</span><span class="p">,</span> <span class="s">&quot;bad read for byte &quot;</span>
						      <span class="s">&quot;%d of 0x%x [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Now handle errors. Lots of special cases here */</span>
	    
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span> 
				<span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_IO</span><span class="p">,</span> <span class="s">&quot;bad read for &quot;</span>
							      <span class="s">&quot;error byte at &quot;</span>
							      <span class="s">&quot;read byte %d &quot;</span>
							      <span class="s">&quot;of 0x%x [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							      <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
							      <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* Can you believe this madness ? */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
				    <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">WFC_IDENTIFY_SAMPLE_TYPE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WF_ST_EMPTY</span><span class="p">;</span>
					<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
					   <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">WFC_UPLOAD_PATCH</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
					   <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">WFC_UPLOAD_PROGRAM</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

					<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_IO</span><span class="p">,</span> <span class="s">&quot;error %d (%s) &quot;</span>
							      <span class="s">&quot;during &quot;</span>
							      <span class="s">&quot;read for byte &quot;</span>
							      <span class="s">&quot;%d of 0x%x &quot;</span>
							      <span class="s">&quot;[%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							      <span class="n">c</span><span class="p">,</span>
							      <span class="n">wavefront_errorstr</span> <span class="p">(</span><span class="n">c</span><span class="p">),</span>
							      <span class="n">i</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
							      <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

				<span class="p">}</span>
		
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;read[%d] = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">read_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">need_ack</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;reading ACK for 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* Some commands need an ACK, but return zero instead</span>
<span class="cm">		   of the standard value.</span>
<span class="cm">		*/</span>
	    
		<span class="k">if</span> <span class="p">((</span><span class="n">ack</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ack</span> <span class="o">=</span> <span class="n">WF_ACK</span><span class="p">;</span>
		<span class="p">}</span>
	
		<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">!=</span> <span class="n">WF_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_IO</span><span class="p">,</span> <span class="s">&quot;cannot read ack for &quot;</span>
						      <span class="s">&quot;0x%x [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						      <span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* something unknown */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* explicit error */</span>
		    
					<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span>
							<span class="s">&quot;cannot read err &quot;</span>
							<span class="s">&quot;for 0x%x [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				
				<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_IO</span><span class="p">,</span> <span class="s">&quot;0x%x [%s] &quot;</span>
					<span class="s">&quot;failed (0x%x, 0x%x, %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
					<span class="n">wavefront_errorstr</span> <span class="p">(</span><span class="n">err</span><span class="p">));</span>
				
				<span class="k">return</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		
		<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;ack received &quot;</span>
					<span class="s">&quot;for 0x%x [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;0x%x [%s] does not need &quot;</span>
				       <span class="s">&quot;ACK (%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">cmd</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">read_cnt</span><span class="p">,</span>
				       <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">write_cnt</span><span class="p">,</span> <span class="n">wfcmd</span><span class="o">-&gt;</span><span class="n">need_ack</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm">WaveFront data munging   </span>

<span class="cm">Things here are weird. All data written to the board cannot </span>
<span class="cm">have its most significant bit set. Any data item with values </span>
<span class="cm">potentially &gt; 0x7F (127) must be split across multiple bytes.</span>

<span class="cm">Sometimes, we need to munge numeric values that are represented on</span>
<span class="cm">the x86 side as 8-32 bit values. Sometimes, we need to munge data</span>
<span class="cm">that is represented on the x86 side as an array of bytes. The most</span>
<span class="cm">efficient approach to handling both cases seems to be to use 2</span>
<span class="cm">different functions for munging and 2 for de-munging. This avoids</span>
<span class="cm">weird casting and worrying about bit-level offsets.</span>

<span class="cm">**********************************************************************/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">munge_int32</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dst_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">;</span>  <span class="cm">/* Mask high bit of LSB */</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>     <span class="cm">/* Rotate Right 7 bits  */</span>
	                            <span class="cm">/* Note: we leave the upper bits in place */</span> 

		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
 	<span class="p">};</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">demunge_int32</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">src_size</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
 	<span class="kt">int</span> <span class="n">outval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
 	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">src_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outval</span><span class="o">=</span><span class="p">(</span><span class="n">outval</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">outval</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> 
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">munge_buf</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_size</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">dst_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst</span><span class="o">++</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> 
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">demunge_buf</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_bytes</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">src_bytes</span><span class="p">;</span>
    
	<span class="n">end</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="n">src_bytes</span><span class="p">;</span>

	<span class="cm">/* NOTE: src and dst *CAN* point to the same address */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">src</span> <span class="o">!=</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm">WaveFront: sample, patch and program management.</span>
<span class="cm">***********************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_delete_sample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample_num</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_num</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_num</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DELETE_SAMPLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">sample_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">WF_ST_EMPTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_get_sample_status</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">assume_rom</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">wbuf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">sc_real</span><span class="p">,</span> <span class="n">sc_alias</span><span class="p">,</span> <span class="n">sc_multi</span><span class="p">;</span>

	<span class="cm">/* check sample status */</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_GET_NSAMPLES</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;cannot request sample count.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> 
    
	<span class="n">sc_real</span> <span class="o">=</span> <span class="n">sc_alias</span> <span class="o">=</span> <span class="n">sc_multi</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">samples_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_MAX_SAMPLE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	
		<span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_IDENTIFY_SAMPLE_TYPE</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;cannot identify sample &quot;</span>
				   <span class="s">&quot;type of slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WF_ST_EMPTY</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">WF_SLOT_FILLED</span><span class="o">|</span><span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">assume_rom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">WF_SLOT_ROM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WF_ST_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WF_ST_SAMPLE</span>:
			<span class="n">sc_real</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WF_ST_MULTISAMPLE</span>:
			<span class="n">sc_multi</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WF_ST_ALIAS</span>:
			<span class="n">sc_alias</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WF_ST_EMPTY</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;unknown sample type for &quot;</span>
				    <span class="s">&quot;slot %d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				    <span class="n">i</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">WF_ST_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">samples_used</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> 
	<span class="p">}</span>

	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;%d samples used (%d real, %d aliases, %d multi), &quot;</span>
		    <span class="s">&quot;%d empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">samples_used</span><span class="p">,</span> <span class="n">sc_real</span><span class="p">,</span> <span class="n">sc_alias</span><span class="p">,</span> <span class="n">sc_multi</span><span class="p">,</span>
		    <span class="n">WF_MAX_SAMPLE</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">samples_used</span><span class="p">);</span>


	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_get_patch_status</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">patchbuf</span><span class="p">[</span><span class="n">WF_PATCH_BYTES</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">patchnum</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">wavefront_patch</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">cnt2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_MAX_PATCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">patchnum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">patchnum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_UPLOAD_PATCH</span><span class="p">,</span> <span class="n">patchbuf</span><span class="p">,</span>
					<span class="n">patchnum</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">WF_SLOT_FILLED</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">wavefront_patch</span> <span class="o">*</span><span class="p">)</span> <span class="n">patchbuf</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span>
				<span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sample_number</span><span class="o">|</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sample_msb</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)]</span> <span class="o">|=</span>
				<span class="n">WF_SLOT_USED</span><span class="p">;</span>
	    
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Bad patch number */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload patch &quot;</span>
				    <span class="s">&quot;error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* program status has already filled in slot_used bits */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_MAX_PATCH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WF_SLOT_FILLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WF_SLOT_USED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt2</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	
	<span class="p">}</span>
	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;%d patch slots filled, %d in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">cnt2</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_get_program_status</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">progbuf</span><span class="p">[</span><span class="n">WF_PROGRAM_BYTES</span><span class="p">];</span>
	<span class="n">wavefront_program</span> <span class="n">prog</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">prognum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_MAX_PROGRAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prognum</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_UPLOAD_PROGRAM</span><span class="p">,</span> <span class="n">progbuf</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">prognum</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">prog_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">WF_SLOT_USED</span><span class="p">;</span>

			<span class="n">demunge_buf</span> <span class="p">(</span><span class="n">progbuf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">prog</span><span class="p">,</span>
				     <span class="n">WF_PROGRAM_BYTES</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">WF_NUM_LAYERS</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">prog</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span>
						<span class="p">[</span><span class="n">prog</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">l</span><span class="p">].</span><span class="n">patch_number</span><span class="p">]</span> <span class="o">|=</span>
						<span class="n">WF_SLOT_USED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Bad program number */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">prog_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload program &quot;</span>
				    <span class="s">&quot;error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">prog_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_MAX_PROGRAM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prog_status</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;%d programs slots in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_send_patch</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">WF_PATCH_BYTES</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bptr</span><span class="p">;</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;downloading patch %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">WF_SLOT_FILLED</span><span class="p">;</span>

	<span class="n">bptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">bptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">munge_buf</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">p</span><span class="p">,</span> <span class="n">bptr</span><span class="p">,</span> <span class="n">WF_PATCH_BYTES</span><span class="p">);</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_PATCH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;download patch failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_send_program</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">WF_PROGRAM_BYTES</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;downloading program %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">prog_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">WF_SLOT_USED</span><span class="p">;</span>

	<span class="cm">/* XXX need to zero existing SLOT_USED bit for program_status[i]</span>
<span class="cm">	   where `i&#39; is the program that&#39;s being (potentially) overwritten.</span>
<span class="cm">	*/</span>
    
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_NUM_LAYERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pr</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">patch_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pr</span><span class="p">.</span><span class="n">layer</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">patch_number</span><span class="p">]</span> <span class="o">|=</span>
				<span class="n">WF_SLOT_USED</span><span class="p">;</span>

			<span class="cm">/* XXX need to mark SLOT_USED for sample used by</span>
<span class="cm">			   patch_number, but this means we have to load it. Ick.</span>
<span class="cm">			*/</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">munge_buf</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">WF_PROGRAM_BYTES</span><span class="p">);</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_PROGRAM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;download patch failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>	
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_freemem</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">char</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_REPORT_FREE_MEMORY</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;can&#39;t get memory stats.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">rbuf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_send_sample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> 
		       <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dataptr</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">data_is_unsigned</span><span class="p">)</span>

<span class="p">{</span>
	<span class="cm">/* samples are downloaded via a 16-bit wide i/o port</span>
<span class="cm">	   (you could think of it as 2 adjacent 8-bit wide ports</span>
<span class="cm">	   but its less efficient that way). therefore, all</span>
<span class="cm">	   the blocksizes and so forth listed in the documentation,</span>
<span class="cm">	   and used conventionally to refer to sample sizes,</span>
<span class="cm">	   which are given in 8-bit units (bytes), need to be</span>
<span class="cm">	   divided by 2.</span>
<span class="cm">        */</span>

	<span class="n">u16</span> <span class="n">sample_short</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data_end</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_blksize</span> <span class="o">=</span> <span class="mi">4096</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">written</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">blocksize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_ack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blocknum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sample_hdr</span><span class="p">[</span><span class="n">WF_SAMPLE_HDR_BYTES</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;sample %sdownload for slot %d, &quot;</span>
				      <span class="s">&quot;type %d, %d bytes from 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;header &quot;</span><span class="p">,</span> 
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">subkey</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">dataptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">WAVEFRONT_FIND_FREE_SAMPLE_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="n">wavefront_find_free_sample</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;unspecified sample =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* XXX it&#39;s a debatable point whether or not RDONLY semantics</span>
<span class="cm">		   on the ROM samples should cover just the sample data or</span>
<span class="cm">		   the sample header. For now, it only covers the sample data,</span>
<span class="cm">		   so anyone is free at all times to rewrite sample headers.</span>

<span class="cm">		   My reason for this is that we have the sample headers</span>
<span class="cm">		   available in the WFB file for General MIDI, and so these</span>
<span class="cm">		   can always be reset if needed. The sample data, however,</span>
<span class="cm">		   cannot be recovered without a complete reset and firmware</span>
<span class="cm">		   reload of the ICS2115, which is a very expensive operation.</span>

<span class="cm">		   So, doing things this way allows us to honor the notion of</span>
<span class="cm">		   &quot;RESETSAMPLES&quot; reasonably cheaply. Note however, that this</span>
<span class="cm">		   is done purely at user level: there is no WFB parser in</span>
<span class="cm">		   this driver, and so a complete reset (back to General MIDI,</span>
<span class="cm">		   or theoretically some other configuration) is the</span>
<span class="cm">		   responsibility of the user level library. </span>

<span class="cm">		   To try to do this in the kernel would be a little</span>
<span class="cm">		   crazy: we&#39;d need 158K of kernel space just to hold</span>
<span class="cm">		   a copy of the patch/program/sample header data.</span>
<span class="cm">		*/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rom_samples_rdonly</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WF_SLOT_ROM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;sample slot %d &quot;</span>
					    <span class="s">&quot;write protected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">wavefront_delete_sample</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">freemem</span> <span class="o">=</span> <span class="n">wavefront_freemem</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">freemem</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;insufficient memory to &quot;</span>
				    <span class="s">&quot;load %d byte sample.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	
	<span class="p">}</span>

	<span class="n">skip</span> <span class="o">=</span> <span class="n">WF_GET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">SampleResolution</span> <span class="o">!=</span> <span class="n">LINEAR_16BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;channel selection only &quot;</span>
			    <span class="s">&quot;possible on 16-bit samples&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EINVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">initial_skip</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;channel selection: %d =&gt; &quot;</span>
				      <span class="s">&quot;initial skip = %d, skip = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">WF_GET_CHANNEL</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">),</span>
				      <span class="n">initial_skip</span><span class="p">,</span> <span class="n">skip</span><span class="p">);</span>
    
	<span class="cm">/* Be safe, and zero the &quot;Unused&quot; bits ... */</span>

	<span class="n">WF_SET_CHANNEL</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* adjust size for 16 bit samples by dividing by two.  We always</span>
<span class="cm">	   send 16 bits per write, even for 8 bit samples, so the length</span>
<span class="cm">	   is always half the size of the sample data in bytes.</span>
<span class="cm">	*/</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* the data we&#39;re sent has not been munged, and in fact, the</span>
<span class="cm">	   header we have to send isn&#39;t just a munged copy either.</span>
<span class="cm">	   so, build the sample header right here.</span>
<span class="cm">	*/</span>

	<span class="n">shptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sample_hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">shptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">shptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Yes, a 4 byte result doesn&#39;t contain all of the offset bits,</span>
<span class="cm">	   but the offset only uses 24 bits.</span>
<span class="cm">	*/</span>

	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">sampleStartOffset</span><span class="p">),</span>
			     <span class="n">shptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">loopStartOffset</span><span class="p">),</span>
			     <span class="n">shptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">loopEndOffset</span><span class="p">),</span>
			     <span class="n">shptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">sampleEndOffset</span><span class="p">),</span>
			     <span class="n">shptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	
	<span class="cm">/* This one is truly weird. What kind of weirdo decided that in</span>
<span class="cm">	   a system dominated by 16 and 32 bit integers, they would use</span>
<span class="cm">	   a just 12 bits ?</span>
<span class="cm">	*/</span>
	
	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">FrequencyBias</span><span class="p">,</span> <span class="n">shptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	
	<span class="cm">/* Why is this nybblified, when the MSB is *always* zero ? </span>
<span class="cm">	   Anyway, we can&#39;t take address of bitfield, so make a</span>
<span class="cm">	   good-faith guess at where it starts.</span>
<span class="cm">	*/</span>
	
	<span class="n">shptr</span> <span class="o">=</span> <span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">FrequencyBias</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
			     <span class="n">shptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> 
			   <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">?</span>
			   <span class="n">WFC_DOWNLOAD_SAMPLE</span> <span class="o">:</span> <span class="n">WFC_DOWNLOAD_SAMPLE_HEADER</span><span class="p">,</span>
			   <span class="nb">NULL</span><span class="p">,</span> <span class="n">sample_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;sample %sdownload refused.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;header &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">sent</span><span class="p">;</span> <span class="cm">/* Sorry. Just had to have one somewhere */</span>
	<span class="p">}</span>
    
	<span class="n">data_end</span> <span class="o">=</span> <span class="n">dataptr</span> <span class="o">+</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* Do any initial skip over an unused channel&#39;s data */</span>

	<span class="n">dataptr</span> <span class="o">+=</span> <span class="n">initial_skip</span><span class="p">;</span>
    
	<span class="k">for</span> <span class="p">(</span><span class="n">written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">blocknum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">written</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">written</span> <span class="o">+=</span> <span class="n">max_blksize</span><span class="p">,</span> <span class="n">blocknum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	
		<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">-</span> <span class="n">written</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_blksize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">blocksize</span> <span class="o">=</span> <span class="n">max_blksize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* round to nearest 16-byte value */</span>
			<span class="n">blocksize</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">written</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_BLOCK</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;download block &quot;</span>
				    <span class="s">&quot;request refused.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocksize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dataptr</span> <span class="o">&lt;</span> <span class="n">data_end</span><span class="p">)</span> <span class="p">{</span>
		
				<span class="n">__get_user</span> <span class="p">(</span><span class="n">sample_short</span><span class="p">,</span> <span class="n">dataptr</span><span class="p">);</span>
				<span class="n">dataptr</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
		
				<span class="k">if</span> <span class="p">(</span><span class="n">data_is_unsigned</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* GUS ? */</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">WF_SAMPLE_IS_8BIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			
						<span class="cm">/* 8 bit sample</span>
<span class="cm">						 resolution, sign</span>
<span class="cm">						 extend both bytes.</span>
<span class="cm">						*/</span>
			
						<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span>
						 <span class="o">&amp;</span><span class="n">sample_short</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mh">0x7f</span><span class="p">;</span>
						<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span>
						 <span class="o">&amp;</span><span class="n">sample_short</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mh">0x7f</span><span class="p">;</span>
			
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			
						<span class="cm">/* 16 bit sample</span>
<span class="cm">						 resolution, sign</span>
<span class="cm">						 extend the MSB.</span>
<span class="cm">						*/</span>
			
						<span class="n">sample_short</span> <span class="o">+=</span> <span class="mh">0x7fff</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="cm">/* In padding section of final block:</span>

<span class="cm">				   Don&#39;t fetch unsupplied data from</span>
<span class="cm">				   user space, just continue with</span>
<span class="cm">				   whatever the final value was.</span>
<span class="cm">				*/</span>
			<span class="p">}</span>
	    
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">blocksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outw</span> <span class="p">(</span><span class="n">sample_short</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">block_port</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">outw</span> <span class="p">(</span><span class="n">sample_short</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_block_port</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Get &quot;DMA page acknowledge&quot;, even though its really</span>
<span class="cm">		   nothing to do with DMA at all.</span>
<span class="cm">		*/</span>
	
		<span class="k">if</span> <span class="p">((</span><span class="n">dma_ack</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="n">WF_DMA_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dma_ack</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload sample &quot;</span>
					    <span class="s">&quot;DMA ack timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload sample &quot;</span>
					    <span class="s">&quot;DMA ack error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">dma_ack</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">WF_SLOT_FILLED</span><span class="o">|</span><span class="n">WF_ST_SAMPLE</span><span class="p">);</span>

	<span class="cm">/* Note, label is here because sending the sample header shouldn&#39;t</span>
<span class="cm">	   alter the sample_status info at all.</span>
<span class="cm">	*/</span>

 <span class="nl">sent:</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_send_alias</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">alias_hdr</span><span class="p">[</span><span class="n">WF_ALIAS_BYTES</span><span class="p">];</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;download alias, %d is &quot;</span>
				      <span class="s">&quot;alias for %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">OriginalSample</span><span class="p">);</span>
    
	<span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">OriginalSample</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">sampleStartOffset</span><span class="p">),</span>
		     <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">loopStartOffset</span><span class="p">),</span>
		     <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">loopEndOffset</span><span class="p">),</span>
		     <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">sampleEndOffset</span><span class="p">),</span>
		     <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">FrequencyBias</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">.</span><span class="n">FrequencyBias</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">alias_hdr</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_SAMPLE_ALIAS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">alias_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;download alias failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">WF_SLOT_FILLED</span><span class="o">|</span><span class="n">WF_ST_ALIAS</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_send_multisample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_samples</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msample_hdr</span><span class="p">;</span>

	<span class="n">msample_hdr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">WF_MSAMPLE_BYTES</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">msample_hdr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msample_hdr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* You&#39;ll recall at this point that the &quot;number of samples&quot; value</span>
<span class="cm">	   in a wavefront_multisample struct is actually the log2 of the</span>
<span class="cm">	   real number of samples.</span>
<span class="cm">	*/</span>

	<span class="n">num_samples</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">NumberOfSamples</span><span class="o">&amp;</span><span class="mi">7</span><span class="p">));</span>
	<span class="n">msample_hdr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">NumberOfSamples</span><span class="p">;</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;multi %d with %d=%d samples</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">NumberOfSamples</span><span class="p">,</span>
				      <span class="n">num_samples</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINT</span><span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="o">|</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;sample[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">SampleNumber</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">SampleNumber</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
		     <span class="o">&amp;</span><span class="n">msample_hdr</span><span class="p">[</span><span class="mi">3</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
    
	<span class="cm">/* Need a hack here to pass in the number of bytes</span>
<span class="cm">	   to be written to the synth. This is ugly, and perhaps</span>
<span class="cm">	   one day, I&#39;ll fix it.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_MULTISAMPLE</span><span class="p">,</span> 
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="p">((</span><span class="n">num_samples</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
			   <span class="n">msample_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;download of multisample failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">msample_hdr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">WF_SLOT_FILLED</span><span class="o">|</span><span class="n">WF_ST_MULTISAMPLE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">msample_hdr</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_fetch_multisample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> 
			     <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">log_ns</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">number</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_samples</span><span class="p">;</span>

	<span class="n">munge_int32</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_UPLOAD_MULTISAMPLE</span><span class="p">,</span> <span class="n">log_ns</span><span class="p">,</span> <span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload multisample failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>
    
	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;msample %d has %d samples</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">log_ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">NumberOfSamples</span> <span class="o">=</span> <span class="n">log_ns</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* get the number of samples ... */</span>

	<span class="n">num_samples</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">log_ns</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_samples</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload multisample failed &quot;</span>
				    <span class="s">&quot;during sample loop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;upload multisample failed &quot;</span>
				    <span class="s">&quot;during sample loop.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">SampleNumber</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">demunge_int32</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">d</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	
		<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_DATA</span><span class="p">,</span> <span class="s">&quot;msample sample[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ms</span><span class="p">.</span><span class="n">SampleNumber</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_send_drum</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">drumbuf</span><span class="p">[</span><span class="n">WF_DRUM_BYTES</span><span class="p">];</span>
	<span class="n">wavefront_drum</span> <span class="o">*</span><span class="n">drum</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;downloading edrum for MIDI &quot;</span>
		<span class="s">&quot;note %d, patch = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">drum</span><span class="o">-&gt;</span><span class="n">PatchNumber</span><span class="p">);</span>

	<span class="n">drumbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">munge_int32</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">drum</span><span class="p">)[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">drumbuf</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_EDRUM_PROGRAM</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">drumbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;download drum failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">EIO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">wavefront_find_free_sample</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_MAX_SAMPLE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">WF_SLOT_FILLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;no free sample slots!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int </span>
<span class="c">wavefront_find_free_patch (snd_wavefront_t *dev)</span>

<span class="c">{</span>
<span class="c">	int i;</span>

<span class="c">	for (i = 0; i &lt; WF_MAX_PATCH; i++) {</span>
<span class="c">		if (!(dev-&gt;patch_status[i] &amp; WF_SLOT_FILLED)) {</span>
<span class="c">			return i;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="c">	snd_printk (&quot;no free patch slots!\n&quot;);</span>
<span class="c">	return -1;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_load_patch</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="n">header</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">header</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">header</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wavefront_patch_info</span><span class="p">)</span> <span class="o">-</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">wavefront_any</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;bad address for load patch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_LOAD_PATCH</span><span class="p">,</span> <span class="s">&quot;download &quot;</span>
				      <span class="s">&quot;Sample type: %d &quot;</span>
				      <span class="s">&quot;Sample number: %d &quot;</span>
				      <span class="s">&quot;Sample size: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">subkey</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				      <span class="n">header</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">subkey</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WF_ST_SAMPLE</span>:  <span class="cm">/* sample or sample_header, based on patch-&gt;size */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdrptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_sample</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_send_sample</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">dataptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WF_ST_MULTISAMPLE</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">s</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdrptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_multisample</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_send_multisample</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WF_ST_ALIAS</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">a</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdrptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_alias</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_send_alias</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WF_ST_DRUM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">d</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdrptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_drum</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_send_drum</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WF_ST_PATCH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">p</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdrptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_patch</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_send_patch</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WF_ST_PROGRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">pr</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">hdrptr</span><span class="p">,</span>
				    <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_program</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">wavefront_send_program</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;unknown patch type %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">header</span><span class="o">-&gt;</span><span class="n">subkey</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">__error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm">WaveFront: hardware-dependent interface</span>
<span class="cm">***********************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">process_sample_hdr</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">wavefront_sample</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* The board doesn&#39;t send us an exact copy of a &quot;wavefront_sample&quot;</span>
<span class="cm">	   in response to an Upload Sample Header command. Instead, we </span>
<span class="cm">	   have to convert the data format back into our data structure,</span>
<span class="cm">	   just as in the Download Sample command, where we have to do</span>
<span class="cm">	   something very similar in the reverse direction.</span>
<span class="cm">	*/</span>

	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">sampleStartOffset</span><span class="p">)</span> <span class="o">=</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">loopStartOffset</span><span class="p">)</span> <span class="o">=</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">loopEndOffset</span><span class="p">)</span> <span class="o">=</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">sampleEndOffset</span><span class="p">)</span> <span class="o">=</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">.</span><span class="n">FrequencyBias</span><span class="p">)</span> <span class="o">=</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">s</span><span class="p">.</span><span class="n">SampleResolution</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">s</span><span class="p">.</span><span class="n">Loop</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="n">s</span><span class="p">.</span><span class="n">Bidirectional</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">s</span><span class="p">.</span><span class="n">Reverse</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="cm">/* Now copy it back to where it came from */</span>

	<span class="n">memcpy</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">wavefront_sample</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wavefront_synth_control</span> <span class="p">(</span><span class="n">snd_wavefront_card_t</span> <span class="o">*</span><span class="n">acard</span><span class="p">,</span> 
			 <span class="n">wavefront_control</span> <span class="o">*</span><span class="n">wc</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wavefront</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">patchnumbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINT</span> <span class="p">(</span><span class="n">WF_DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;synth control with &quot;</span>
		<span class="s">&quot;cmd 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Pre-handling of or for various commands */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		
	<span class="k">case</span> <span class="n">WFC_DISABLE_INTERRUPTS</span>:
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;interrupts disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">outb</span> <span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupts_are_midi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_ENABLE_INTERRUPTS</span>:
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;interrupts enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">outb</span> <span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="mh">0x40</span><span class="o">|</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupts_are_midi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_INTERRUPT_STATUS</span>:
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupts_are_midi</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_ROMSAMPLES_RDONLY</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rom_samples_rdonly</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_IDENTIFY_SLOT_TYPE</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span><span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">WF_MAX_SAMPLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;invalid slot ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">);</span>
			<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sample_status</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_DEBUG_DRIVER</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;debug = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_UPLOAD_PATCH</span>:
		<span class="n">munge_int32</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">),</span> <span class="n">patchnumbuf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">memcpy</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">,</span> <span class="n">patchnumbuf</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_UPLOAD_MULTISAMPLE</span>:
		<span class="cm">/* multisamples have to be handled differently, and</span>
<span class="cm">		   cannot be dealt with properly by snd_wavefront_cmd() alone.</span>
<span class="cm">		*/</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">wavefront_fetch_multisample</span>
			<span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">wavefront_patch_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFC_UPLOAD_SAMPLE_ALIAS</span>:
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;support for sample alias upload &quot;</span>
			<span class="s">&quot;being considered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">wbuf</span><span class="p">);</span>

	<span class="cm">/* Post-handling of certain commands.</span>

<span class="cm">	   In particular, if the command was an upload, demunge the data</span>
<span class="cm">	   so that the user-level doesn&#39;t have to think about it.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* intercept any freemem requests so that we know</span>
<span class="cm">			   we are always current with the user-level view</span>
<span class="cm">			   of things.</span>
<span class="cm">			*/</span>

		<span class="k">case</span> <span class="n">WFC_REPORT_FREE_MEMORY</span>:
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">freemem</span> <span class="o">=</span> <span class="n">demunge_int32</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_UPLOAD_PATCH</span>:
			<span class="n">demunge_buf</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">WF_PATCH_BYTES</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_UPLOAD_PROGRAM</span>:
			<span class="n">demunge_buf</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">WF_PROGRAM_BYTES</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_UPLOAD_EDRUM_PROGRAM</span>:
			<span class="n">demunge_buf</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">,</span> <span class="n">WF_DRUM_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_UPLOAD_SAMPLE_HEADER</span>:
			<span class="n">process_sample_hdr</span> <span class="p">(</span><span class="n">wc</span><span class="o">-&gt;</span><span class="n">rbuf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_UPLOAD_SAMPLE_ALIAS</span>:
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;support for &quot;</span>
				    <span class="s">&quot;sample aliases still &quot;</span>
				    <span class="s">&quot;being considered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_VMIDI_OFF</span>:
			<span class="n">snd_wavefront_midi_disable_virtual</span> <span class="p">(</span><span class="n">acard</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WFC_VMIDI_ON</span>:
			<span class="n">snd_wavefront_midi_enable_virtual</span> <span class="p">(</span><span class="n">acard</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> 
<span class="nf">snd_wavefront_synth_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> 
<span class="nf">snd_wavefront_synth_release</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">module</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">snd_wavefront_synth_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">snd_wavefront_card_t</span> <span class="o">*</span><span class="n">acard</span><span class="p">;</span>
	<span class="n">wavefront_control</span> <span class="o">*</span><span class="n">wc</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">acard</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">acard</span><span class="o">-&gt;</span><span class="n">wavefront</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WFCTL_LOAD_SPP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_load_patch</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">argp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WFCTL_WFCMD</span>:
		<span class="n">wc</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wc</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">wc</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_synth_control</span> <span class="p">(</span><span class="n">acard</span><span class="p">,</span> <span class="n">wc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span> <span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">wc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">wc</span><span class="p">)))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***********************************************************************/</span>
<span class="cm">/*  WaveFront: interface for card-level wavefront module               */</span>
<span class="cm">/***********************************************************************/</span>

<span class="kt">void</span>
<span class="nf">snd_wavefront_internal_interrupt</span> <span class="p">(</span><span class="n">snd_wavefront_card_t</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wavefront</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	   Some comments on interrupts. I attempted a version of this</span>
<span class="cm">	   driver that used interrupts throughout the code instead of</span>
<span class="cm">	   doing busy and/or sleep-waiting. Alas, it appears that once</span>
<span class="cm">	   the Motorola firmware is downloaded, the card *never*</span>
<span class="cm">	   generates an RX interrupt. These are successfully generated</span>
<span class="cm">	   during firmware loading, and after that wavefront_status()</span>
<span class="cm">	   reports that an interrupt is pending on the card from time</span>
<span class="cm">	   to time, but it never seems to be delivered to this</span>
<span class="cm">	   driver. Note also that wavefront_status() continues to</span>
<span class="cm">	   report that RX interrupts are enabled, suggesting that I</span>
<span class="cm">	   didn&#39;t goof up and disable them by mistake.</span>

<span class="cm">	   Thus, I stepped back to a prior version of</span>
<span class="cm">	   wavefront_wait(), the only place where this really</span>
<span class="cm">	   matters. Its sad, but I&#39;ve looked through the code to check</span>
<span class="cm">	   on things, and I really feel certain that the Motorola</span>
<span class="cm">	   firmware prevents RX-ready interrupts.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wavefront_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_INTR_READ</span><span class="o">|</span><span class="n">STAT_INTR_WRITE</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupt_sleeper</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* STATUS REGISTER </span>

<span class="cm">0 Host Rx Interrupt Enable (1=Enabled)</span>
<span class="cm">1 Host Rx Register Full (1=Full)</span>
<span class="cm">2 Host Rx Interrupt Pending (1=Interrupt)</span>
<span class="cm">3 Unused</span>
<span class="cm">4 Host Tx Interrupt (1=Enabled)</span>
<span class="cm">5 Host Tx Register empty (1=Empty)</span>
<span class="cm">6 Host Tx Interrupt Pending (1=Interrupt)</span>
<span class="cm">7 Unused</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_wavefront_interrupt_bits</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">15</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	
	<span class="nl">default:</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;invalid IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">wavefront_should_cause_interrupt</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> 
				  <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>

<span class="p">{</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>

	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupt_sleeper</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">outb</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">port</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span> <span class="o">&amp;&amp;</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">wavefront_reset_to_cleanliness</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hwv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* IRQ already checked */</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">snd_wavefront_interrupt_bits</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* try reset of port */</span>

	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">);</span> 
  
	<span class="cm">/* At this point, the board is in reset, and the H/W initialization</span>
<span class="cm">	   register is accessed at the same address as the data port.</span>
<span class="cm">     </span>
<span class="cm">	   Bit 7 - Enable IRQ Driver	</span>
<span class="cm">	   0 - Tri-state the Wave-Board drivers for the PC Bus IRQs</span>
<span class="cm">	   1 - Enable IRQ selected by bits 5:3 to be driven onto the PC Bus.</span>
<span class="cm">     </span>
<span class="cm">	   Bit 6 - MIDI Interface Select</span>

<span class="cm">	   0 - Use the MIDI Input from the 26-pin WaveBlaster</span>
<span class="cm">	   compatible header as the serial MIDI source</span>
<span class="cm">	   1 - Use the MIDI Input from the 9-pin D connector as the</span>
<span class="cm">	   serial MIDI source.</span>
<span class="cm">     </span>
<span class="cm">	   Bits 5:3 - IRQ Selection</span>
<span class="cm">	   0 0 0 - IRQ 2/9</span>
<span class="cm">	   0 0 1 - IRQ 5</span>
<span class="cm">	   0 1 0 - IRQ 12</span>
<span class="cm">	   0 1 1 - IRQ 15</span>
<span class="cm">	   1 0 0 - Reserved</span>
<span class="cm">	   1 0 1 - Reserved</span>
<span class="cm">	   1 1 0 - Reserved</span>
<span class="cm">	   1 1 1 - Reserved</span>
<span class="cm">     </span>
<span class="cm">	   Bits 2:1 - Reserved</span>
<span class="cm">	   Bit 0 - Disable Boot ROM</span>
<span class="cm">	   0 - memory accesses to 03FC30-03FFFFH utilize the internal Boot ROM</span>
<span class="cm">	   1 - memory accesses to 03FC30-03FFFFH are directed to external </span>
<span class="cm">	   storage.</span>
<span class="cm">     </span>
<span class="cm">	*/</span>

	<span class="cm">/* configure hardware: IRQ, enable interrupts, </span>
<span class="cm">	   plus external 9-pin MIDI interface selected</span>
<span class="cm">	*/</span>

	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">|</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">bits</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">);</span>	
  
	<span class="cm">/* CONTROL REGISTER</span>

<span class="cm">	   0 Host Rx Interrupt Enable (1=Enabled)      0x1</span>
<span class="cm">	   1 Unused                                    0x2</span>
<span class="cm">	   2 Unused                                    0x4</span>
<span class="cm">	   3 Unused                                    0x8</span>
<span class="cm">	   4 Host Tx Interrupt Enable                 0x10</span>
<span class="cm">	   5 Mute (0=Mute; 1=Play)                    0x20</span>
<span class="cm">	   6 Master Interrupt Enable (1=Enabled)      0x40</span>
<span class="cm">	   7 Master Reset (0=Reset; 1=Run)            0x80</span>

<span class="cm">	   Take us out of reset, mute output, master + TX + RX interrupts on.</span>
<span class="cm">	   </span>
<span class="cm">	   We&#39;ll get an interrupt presumably to tell us that the TX</span>
<span class="cm">	   register is clear.</span>
<span class="cm">	*/</span>

	<span class="n">wavefront_should_cause_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x80</span><span class="o">|</span><span class="mh">0x40</span><span class="o">|</span><span class="mh">0x10</span><span class="o">|</span><span class="mh">0x1</span><span class="p">,</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">reset_time</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* Note: data port is now the data port, not the h/w initialization</span>
<span class="cm">	   port.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;intr not received after h/w un-reset.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="cm">/* Note: data port is now the data port, not the h/w initialization</span>
<span class="cm">	   port.</span>

<span class="cm">	   At this point, only &quot;HW VERSION&quot; or &quot;DOWNLOAD OS&quot; commands</span>
<span class="cm">	   will work. So, issue one of them, and wait for TX</span>
<span class="cm">	   interrupt. This can take a *long* time after a cold boot,</span>
<span class="cm">	   while the ISC ROM does its RAM test. The SDK says up to 4</span>
<span class="cm">	   seconds - with 12MB of RAM on a Tropez+, it takes a lot</span>
<span class="cm">	   longer than that (~16secs). Note that the card understands</span>
<span class="cm">	   the difference between a warm and a cold boot, so</span>
<span class="cm">	   subsequent ISC2115 reboots (say, caused by module</span>
<span class="cm">	   reloading) will get through this much faster.</span>

<span class="cm">	   XXX Interesting question: why is no RX interrupt received first ?</span>
<span class="cm">	*/</span>

	<span class="n">wavefront_should_cause_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_HARDWARE_VERSION</span><span class="p">,</span> 
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">,</span> <span class="n">ramcheck_time</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;post-RAM-check interrupt not received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wavefront_wait</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">STAT_CAN_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;no response to HW version cmd.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">hwv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;board not responding correctly.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hwv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* NAK */</span>

		<span class="cm">/* Board&#39;s RAM test failed. Try to read error code,</span>
<span class="cm">		   and tell us about it either way.</span>
<span class="cm">		*/</span>
		
		<span class="k">if</span> <span class="p">((</span><span class="n">hwv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;on-board RAM test failed &quot;</span>
				    <span class="s">&quot;(bad error code).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;on-board RAM test failed &quot;</span>
				    <span class="s">&quot;(error code: 0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hwv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;re OK, just get the next byte of the HW version response */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hwv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;incorrect h/w response.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;hardware version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hwv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hwv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>


     <span class="nl">gone_bad:</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">wavefront_download_firmware</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">section_cnt_downloaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">firmware</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firmware</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware (%s) download failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">section_length</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">section_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">section_length</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">section_length</span> <span class="o">&gt;</span> <span class="n">WF_SECTION_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;invalid firmware section length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">section_length</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="n">section_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware section read error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Send command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_DOWNLOAD_OS</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
	
		<span class="k">for</span> <span class="p">(;</span> <span class="n">section_length</span><span class="p">;</span> <span class="n">section_length</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	
		<span class="cm">/* get ACK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wavefront_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">STAT_CAN_READ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;time out for firmware ACK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">WF_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;download of section #%d not &quot;</span>
				   <span class="s">&quot;acknowledged, ack = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">section_cnt_downloaded</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failure</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">section_cnt_downloaded</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">firmware</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">failure:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">firmware</span><span class="p">);</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware download failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">wavefront_do_reset</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">char</span> <span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_reset_to_cleanliness</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;hw reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_download_firmware</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ospath</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Wait for the OS to get running. The protocol for</span>
<span class="cm">		   this is non-obvious, and was determined by</span>
<span class="cm">		   using port-IO tracing in DOSemu and some</span>
<span class="cm">		   experimentation here.</span>
<span class="cm">		   </span>
<span class="cm">		   Rather than using timed waits, use interrupts creatively.</span>
<span class="cm">		*/</span>

		<span class="n">wavefront_should_cause_interrupt</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_NOOP</span><span class="p">,</span>
						  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">,</span>
						  <span class="p">(</span><span class="n">osrun_time</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;no post-OS interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
		<span class="p">}</span>
		
		<span class="cm">/* Now, do it again ! */</span>
		
		<span class="n">wavefront_should_cause_interrupt</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_NOOP</span><span class="p">,</span>
						  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">data_port</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">));</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;no post-OS interrupt(2).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* OK, no (RX/TX) interrupts any more, but leave mute</span>
<span class="cm">		   in effect. </span>
<span class="cm">		*/</span>
		
		<span class="n">outb</span> <span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">);</span> 
	<span class="p">}</span>

	<span class="cm">/* SETUPSND.EXE asks for sample memory config here, but since i</span>
<span class="cm">	   have no idea how to interpret the result, we&#39;ll forget</span>
<span class="cm">	   about it.</span>
<span class="cm">	*/</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">freemem</span> <span class="o">=</span> <span class="n">wavefront_freemem</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;available DRAM %dk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">freemem</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">wavefront_write</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wavefront_read</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;MPU emulation mode not set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_SET_NVOICES</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">voices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;cannot set number of voices to 32.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">gone_bad</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">gone_bad:</span>
	<span class="cm">/* reset that sucker so that it doesn&#39;t bother us. */</span>

	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupts_are_midi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_wavefront_start</span> <span class="p">(</span><span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">samples_are_from_rom</span><span class="p">;</span>

	<span class="cm">/* IMPORTANT: assumes that snd_wavefront_detect() and/or</span>
<span class="cm">	   wavefront_reset_to_cleanliness() has already been called </span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">samples_are_from_rom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* XXX is this always true ? */</span>
		<span class="n">samples_are_from_rom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span> <span class="o">||</span> <span class="n">fx_raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wavefront_do_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Check for FX device, present only on Tropez+ */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_fx</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_wavefront_fx_detect</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_fx</span> <span class="o">&amp;&amp;</span> <span class="n">fx_raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_wavefront_fx_start</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wavefront_get_sample_status</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">samples_are_from_rom</span><span class="p">);</span>
	<span class="n">wavefront_get_program_status</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wavefront_get_patch_status</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Start normal operation: unreset, master interrupt enabled, no mute</span>
<span class="cm">	*/</span>

	<span class="n">outb</span> <span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="mh">0x40</span><span class="o">|</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">control_port</span><span class="p">);</span> 

	<span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_wavefront_detect</span> <span class="p">(</span><span class="n">snd_wavefront_card_t</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">rbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">wbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">snd_wavefront_t</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wavefront</span><span class="p">;</span>
	
	<span class="cm">/* returns zero if a WaveFront card is successfully detected.</span>
<span class="cm">	   negative otherwise.</span>
<span class="cm">	*/</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_fx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug_default</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">interrupts_are_midi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rom_samples_rdonly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_FIRMWARE_VERSION</span><span class="p">,</span> <span class="n">rbuf</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;firmware %d.%d already loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="cm">/* check that a command actually works */</span>
      
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_wavefront_cmd</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WFC_HARDWARE_VERSION</span><span class="p">,</span>
				       <span class="n">rbuf</span><span class="p">,</span> <span class="n">wbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;not raw, but no &quot;</span>
				    <span class="s">&quot;hardware version!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wf_raw</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;reloading firmware as you requested.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">israw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;no response to firmware probe, assume raw.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">DEFAULT_OSPATH</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
