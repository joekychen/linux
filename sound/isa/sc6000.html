<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › isa › sc6000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sc6000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for Gallant SC-6000 soundcard. This card is also known as</span>
<span class="cm"> *  Audio Excel DSP 16 or Zoltrix AV302.</span>
<span class="cm"> *  These cards use CompuMedia ASC-9308 chip + AD1848 codec.</span>
<span class="cm"> *  SC-6600 and SC-7000 cards are also supported. They are based on</span>
<span class="cm"> *  CompuMedia ASC-9408 chip and CS4231 codec.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007 Krzysztof Helt &lt;krzysztof.h1@wp.pl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  I don&#39;t have documentation for this card. I used the driver</span>
<span class="cm"> *  for OSS/Free included in the kernel source as reference.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/isa.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/wss.h&gt;</span>
<span class="cp">#include &lt;sound/opl3.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#define SNDRV_LEGACY_FIND_FREE_IRQ</span>
<span class="cp">#define SNDRV_LEGACY_FIND_FREE_DMA</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Krzysztof Helt&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Gallant SC-6000&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Gallant, SC-6000},&quot;</span>
			<span class="s">&quot;{AudioExcel, Audio Excel DSP 16},&quot;</span>
			<span class="s">&quot;{Zoltrix, AV302}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>	<span class="cm">/* 0x220, 0x240 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>	<span class="cm">/* 5, 7, 9, 10, 11 */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">mss_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>	<span class="cm">/* 0x530, 0xe80 */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="n">mpu_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_PORT</span><span class="p">;</span>
						<span class="cm">/* 0x300, 0x310, 0x320, 0x330 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IRQ</span><span class="p">;</span>	<span class="cm">/* 5, 7, 9, 10, 0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_DMA</span><span class="p">;</span>	<span class="cm">/* 0, 1, 3 */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">joystick</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">false</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for sc-6000 based soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for sc-6000 based soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable sc-6000 based soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="s">&quot;Port # for sc-6000 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mss_port</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mss_port</span><span class="p">,</span> <span class="s">&quot;MSS Port # for sc-6000 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="kt">long</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="s">&quot;MPU-401 port # for sc-6000 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="s">&quot;IRQ # for sc-6000 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">,</span> <span class="s">&quot;MPU-401 IRQ # for sc-6000 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dma</span><span class="p">,</span> <span class="s">&quot;DMA # for sc-6000 driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="s">&quot;Enable gameport.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Commands of SC6000&#39;s DSP (SBPRO+special).</span>
<span class="cm"> * Some of them are COMMAND_xx, in the future they may change.</span>
<span class="cm"> */</span>
<span class="cp">#define WRITE_MDIRQ_CFG	0x50	</span><span class="cm">/* Set M&amp;I&amp;DRQ mask (the real config)	*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_52	0x52	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define READ_HARD_CFG	0x58	</span><span class="cm">/* Read Hardware Config (I/O base etc)	*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_5C	0x5c	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_60	0x60	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_66	0x66	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_6C	0x6c	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_6E	0x6e	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_88	0x88	</span><span class="cm">/* Unknown command 			*/</span><span class="cp"></span>
<span class="cp">#define DSP_INIT_MSS	0x8c	</span><span class="cm">/* Enable Microsoft Sound System mode	*/</span><span class="cp"></span>
<span class="cp">#define COMMAND_C5	0xc5	</span><span class="cm">/*					*/</span><span class="cp"></span>
<span class="cp">#define GET_DSP_VERSION	0xe1	</span><span class="cm">/* Get DSP Version			*/</span><span class="cp"></span>
<span class="cp">#define GET_DSP_COPYRIGHT 0xe3	</span><span class="cm">/* Get DSP Copyright			*/</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Offsets of SC6000 DSP I/O ports. The offset is added to base I/O port</span>
<span class="cm"> * to have the actual I/O port.</span>
<span class="cm"> * Register permissions are:</span>
<span class="cm"> * (wo) == Write Only</span>
<span class="cm"> * (ro) == Read  Only</span>
<span class="cm"> * (w-) == Write</span>
<span class="cm"> * (r-) == Read</span>
<span class="cm"> */</span>
<span class="cp">#define DSP_RESET	0x06	</span><span class="cm">/* offset of DSP RESET		(wo) */</span><span class="cp"></span>
<span class="cp">#define DSP_READ	0x0a	</span><span class="cm">/* offset of DSP READ		(ro) */</span><span class="cp"></span>
<span class="cp">#define DSP_WRITE	0x0c	</span><span class="cm">/* offset of DSP WRITE		(w-) */</span><span class="cp"></span>
<span class="cp">#define DSP_COMMAND	0x0c	</span><span class="cm">/* offset of DSP COMMAND	(w-) */</span><span class="cp"></span>
<span class="cp">#define DSP_STATUS	0x0c	</span><span class="cm">/* offset of DSP STATUS		(r-) */</span><span class="cp"></span>
<span class="cp">#define DSP_DATAVAIL	0x0e	</span><span class="cm">/* offset of DSP DATA AVAILABLE	(ro) */</span><span class="cp"></span>

<span class="cp">#define PFX &quot;sc6000: &quot;</span>
<span class="cp">#define DRV_NAME &quot;SC-6000&quot;</span>

<span class="cm">/* hardware dependent functions */</span>

<span class="cm">/*</span>
<span class="cm"> * sc6000_irq_to_softcfg - Decode irq number into cfg code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sc6000_irq_to_softcfg</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x28</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sc6000_dma_to_softcfg - Decode dma number into cfg code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sc6000_dma_to_softcfg</span><span class="p">(</span><span class="kt">int</span> <span class="n">dma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sc6000_mpu_irq_to_softcfg - Decode MPU-401 irq number into cfg code.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__devinit</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">sc6000_mpu_irq_to_softcfg</span><span class="p">(</span><span class="kt">int</span> <span class="n">mpu_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mpu_irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0xc4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sc6000_wait_data</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">vport</span> <span class="o">+</span> <span class="n">DSP_DATAVAIL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="o">--</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sc6000_read</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_wait_data</span><span class="p">(</span><span class="n">vport</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">vport</span> <span class="o">+</span> <span class="n">DSP_READ</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sc6000_write</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">vport</span> <span class="o">+</span> <span class="n">DSP_STATUS</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * DSP ready to receive data if bit 7 of val == 0</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iowrite8</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vport</span> <span class="o">+</span> <span class="n">DSP_COMMAND</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cpu_relax</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="o">--</span><span class="p">);</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DSP Command (0x%x) timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sc6000_dsp_get_answer</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">command</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">sc6000_read</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If no more data available, return to the caller, no error if len&gt;0.</span>
<span class="cm">	 * We have no other way to know when the string is finished.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">len</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sc6000_dsp_reset</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">vport</span> <span class="o">+</span> <span class="n">DSP_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vport</span> <span class="o">+</span> <span class="n">DSP_RESET</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_read</span><span class="p">(</span><span class="n">vport</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* detection and initialization */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sc6000_hw_cfg_write</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">COMMAND_6C</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_6C</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DATA 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">COMMAND_C5</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">COMMAND_C5</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sc6000_cfg_write</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">softcfg</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">WRITE_MDIRQ_CFG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">WRITE_MDIRQ_CFG</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">softcfg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_cfg_write: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sc6000_setup_board</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">COMMAND_88</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CMD 0x%x: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">COMMAND_88</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">sc6000_wait_data</span><span class="p">(</span><span class="n">vport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">loop</span><span class="o">--</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_read</span><span class="p">(</span><span class="n">vport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_read after CMD 0x%x: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">COMMAND_88</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_cfg_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sc6000_init_mss</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="n">config</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vmss_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mss_config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">DSP_INIT_MSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_init_mss [0x%x]: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">DSP_INIT_MSS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_cfg_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">iowrite8</span><span class="p">(</span><span class="n">mss_config</span><span class="p">,</span> <span class="n">vmss_port</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">sc6000_hw_cfg_encode</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span>
					   <span class="kt">long</span> <span class="n">xport</span><span class="p">,</span> <span class="kt">long</span> <span class="n">xmpu</span><span class="p">,</span>
					   <span class="kt">long</span> <span class="n">xmss_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">joystick</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xport</span> <span class="o">==</span> <span class="mh">0x240</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xmpu</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">xmpu</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xmss_port</span> <span class="o">==</span> <span class="mh">0xe80</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>		<span class="cm">/* always set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">joystick</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>		<span class="cm">/* enable WSS system */</span>
	<span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>	<span class="cm">/* disable IDE */</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;hw cfg %x, %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sc6000_init_board</span><span class="p">(</span><span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vport</span><span class="p">,</span>
					<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vmss_port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">answer</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">mss_config</span> <span class="o">=</span> <span class="n">sc6000_irq_to_softcfg</span><span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="o">|</span>
			 <span class="n">sc6000_dma_to_softcfg</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">config</span> <span class="o">=</span> <span class="n">mss_config</span> <span class="o">|</span>
		     <span class="n">sc6000_mpu_irq_to_softcfg</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sc6000_dsp_reset</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_dsp_reset: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">answer</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sc6000_dsp_get_answer</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">GET_DSP_COPYRIGHT</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_dsp_copyright: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * My SC-6000 card return &quot;SC-6000&quot; in DSPCopyright, so</span>
<span class="cm">	 * if we have something different, we have to be warned.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;SC-6000&quot;</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning: non SC-6000 audio card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_dsp_get_answer</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">GET_DSP_VERSION</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_dsp_version: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">PFX</span> <span class="s">&quot;Detected model: %s, DSP version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">answer</span><span class="p">,</span> <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* set configuration */</span>
	<span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">COMMAND_5C</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_read</span><span class="p">(</span><span class="n">vport</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cfg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">sc6000_hw_cfg_encode</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
				     <span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">joystick</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_hw_cfg_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_hw_cfg_write: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sc6000_setup_board</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_setup_board: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sc6000_dsp_reset</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">COMMAND_60</span><span class="p">);</span>
		<span class="n">sc6000_write</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">sc6000_dsp_reset</span><span class="p">(</span><span class="n">vport</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sc6000_setup_board</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sc6000_setup_board: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sc6000_init_mss</span><span class="p">(</span><span class="n">vport</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">vmss_port</span><span class="p">,</span> <span class="n">mss_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Cannot initialize &quot;</span>
			   <span class="s">&quot;Microsoft Sound System mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_sc6000_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id1</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">id2</span><span class="p">));</span>
	<span class="n">id1</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="n">id2</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="cm">/* reassign AUX0 to FM */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Aux Playback Switch&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;FM Playback Switch&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_rename_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Aux Playback Volume&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;FM Playback Volume&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_rename_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* reassign AUX1 to CD */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Aux Playback Switch&quot;</span><span class="p">);</span> <span class="n">id1</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CD Playback Switch&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_rename_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Aux Playback Volume&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">id2</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CD Playback Volume&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_rename_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_sc6000_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;specify IO port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;specify MSS port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x220</span> <span class="o">&amp;&amp;</span> <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x240</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;Port must be 0x220 or 0x240</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x530</span> <span class="o">&amp;&amp;</span> <span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xe80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;MSS port must be 0x530 or 0xe80</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_IRQ</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sc6000_irq_to_softcfg</span><span class="p">(</span><span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;invalid IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_DMA</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sc6000_dma_to_softcfg</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;invalid DMA %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30L</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x300</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;invalid MPU-401 port %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_IRQ</span> <span class="o">&amp;&amp;</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">sc6000_mpu_irq_to_softcfg</span><span class="p">(</span><span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;invalid MPU-401 IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_sc6000_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">possible_irqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">possible_dmas</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">xirq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">xdma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_wss</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">**</span><span class="n">vport</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vmss_port</span><span class="p">;</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vport</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">vport</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xirq</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xirq</span> <span class="o">=</span> <span class="n">snd_legacy_find_free_irq</span><span class="p">(</span><span class="n">possible_irqs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xirq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to find a free IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xdma</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xdma</span> <span class="o">=</span> <span class="n">snd_legacy_find_free_dma</span><span class="p">(</span><span class="n">possible_dmas</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xdma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;unable to find a free DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			   <span class="s">&quot;I/O port region is already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">vport</span> <span class="o">=</span> <span class="n">devm_ioport_map</span><span class="p">(</span><span class="n">devptr</span><span class="p">,</span> <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">vport</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			   <span class="s">&quot;I/O port cannot be iomaped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* to make it marked as used */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			   <span class="s">&quot;SC-6000 port I/O port region is already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vmss_port</span> <span class="o">=</span> <span class="n">devm_ioport_map</span><span class="p">(</span><span class="n">devptr</span><span class="p">,</span> <span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vmss_port</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			   <span class="s">&quot;MSS port I/O cannot be iomaped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;Initializing BASE[0x%lx] IRQ[%d] DMA[%d] MIRQ[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">xirq</span><span class="p">,</span> <span class="n">xdma</span><span class="p">,</span>
		   <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_IRQ</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sc6000_init_board</span><span class="p">(</span><span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="n">vmss_port</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>  <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xirq</span><span class="p">,</span> <span class="n">xdma</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			     <span class="n">WSS_HW_DETECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span>
			   <span class="s">&quot;error creating new WSS PCM device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_wss_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;error creating new WSS mixer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_sc6000_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;the mixer rewrite failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_opl3_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
			    <span class="mh">0x388</span><span class="p">,</span> <span class="mh">0x388</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			    <span class="n">OPL3_HW_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opl3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">PFX</span> <span class="s">&quot;no OPL device at 0x%x-0x%x ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="mh">0x388</span><span class="p">,</span> <span class="mh">0x388</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_hwdep_new</span><span class="p">(</span><span class="n">opl3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SNDRV_AUTO_PORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">==</span> <span class="n">SNDRV_AUTO_IRQ</span><span class="p">)</span>
			<span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">MPU401_HW_MPU401</span><span class="p">,</span>
					<span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">mpu_irq</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;no MPU-401 device at 0x%lx ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;SC-6000&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;Gallant SC-6000 at 0x%lx, irq %d, dma %d&quot;</span><span class="p">,</span>
		<span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">xirq</span><span class="p">,</span> <span class="n">xdma</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">devptr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap2</span><span class="p">;</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unmap2:</span>
	<span class="n">sc6000_setup_board</span><span class="p">(</span><span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
<span class="nl">err_unmap1:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">);</span>
<span class="nl">err_exit:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">snd_sc6000_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">devptr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">**</span><span class="n">vport</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc6000_setup_board</span><span class="p">(</span><span class="o">*</span><span class="n">vport</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;sc6000_setup_board failed on exit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">release_region</span><span class="p">(</span><span class="n">port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">mss_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">devptr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">isa_driver</span> <span class="n">snd_sc6000_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match</span>		<span class="o">=</span> <span class="n">snd_sc6000_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">snd_sc6000_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_sc6000_remove</span><span class="p">),</span>
	<span class="cm">/* FIXME: suspend/resume */</span>
	<span class="p">.</span><span class="n">driver</span>		<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alsa_card_sc6000_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">isa_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_sc6000_driver</span><span class="p">,</span> <span class="n">SNDRV_CARDS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">alsa_card_sc6000_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isa_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_sc6000_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">alsa_card_sc6000_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">alsa_card_sc6000_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
