<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › synth › emux › soundfont.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>soundfont.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Soundfont generic routines.</span>
<span class="cm"> *	It is intended that these should be used by any driver that is willing</span>
<span class="cm"> *	to accept soundfont patches.</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 1999 Steve Ratcliffe</span>
<span class="cm"> *  Copyright (c) 1999-2000 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * Deal with reading in of a soundfont.  Code follows the OSS way</span>
<span class="cm"> * of doing things so that the old sfxload utility can be used.</span>
<span class="cm"> * Everything may change when there is an alsa way of doing things.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/soundfont.h&gt;</span>
<span class="cp">#include &lt;sound/seq_oss_legacy.h&gt;</span>

<span class="cm">/* Prototypes for static functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">open_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">newsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">is_identical_font</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">close_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">probe_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_zone_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">sf_zone_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_sample_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sf_sample_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sf_sample_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">load_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">load_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">remove_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_voice_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundfont_voice_info</span> <span class="o">*</span><span class="n">avp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_voice_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundfont_voice_parm</span> <span class="o">*</span><span class="n">pp</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">set_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">soundfont_voice_info</span> <span class="o">*</span><span class="n">avp</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">find_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">load_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rebuild_presets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">cur</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">delete_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">search_first_zone</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">preset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">search_zones</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">notep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vel</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">preset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">**</span><span class="n">table</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">max_layers</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_sf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_sf_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * lock access to sflist</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">lock_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets_locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * remove lock</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">unlock_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets_mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * close the patch if the patch was opened by this client.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">snd_soundfont_close_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">open_client</span> <span class="o">==</span> <span class="n">client</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">close_patch</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Deal with a soundfont patch.  Any driver could use these routines</span>
<span class="cm"> * although it was designed for the AWE64.</span>
<span class="cm"> *</span>
<span class="cm"> * The sample_write and callargs pararameters allow a callback into</span>
<span class="cm"> * the actual driver to write sample data to the board or whatever</span>
<span class="cm"> * it wants to do with it.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">snd_soundfont_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		   <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundfont_patch_info</span> <span class="n">patch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;patch record too small %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">patch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">SNDRV_OSS_SOUNDFONT_PATCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;The wrong kind of patch %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">patch</span><span class="p">.</span><span class="n">key</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">patch</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Patch too short %ld, need %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">count</span><span class="p">,</span> <span class="n">patch</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;poor length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">patch</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SFNT_OPEN_PATCH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* grab sflist to open */</span>
		<span class="n">lock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">open_patch</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="n">unlock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if other client already opened patch */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">open_client</span> <span class="o">!=</span> <span class="n">client</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_LOAD_INFO</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">load_info</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_LOAD_DATA</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_CLOSE_PATCH</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">close_patch</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_REPLACE_DATA</span>:
		<span class="cm">/*rc = replace_data(&amp;patch, data, count);*/</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_MAP_PRESET</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">load_map</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_PROBE_DATA</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">probe_data</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">patch</span><span class="p">.</span><span class="n">optarg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_REMOVE_INFO</span>:
		<span class="cm">/* patch must be opened */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;soundfont: remove_info: &quot;</span>
				   <span class="s">&quot;patch not opened</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="n">instr</span><span class="p">;</span>
			<span class="n">bank</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">patch</span><span class="p">.</span><span class="n">optarg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="n">instr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">patch</span><span class="p">.</span><span class="n">optarg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">remove_info</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">instr</span><span class="p">))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">unlock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* check if specified type is special font (GUS or preset-alias) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">is_special_type</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">type</span> <span class="o">&amp;=</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SFNT_PAT_TYPE_GUS</span> <span class="o">||</span>
		<span class="n">type</span> <span class="o">==</span> <span class="n">SNDRV_SFNT_PAT_TYPE_MAP</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* open patch; create sf list */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	   <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soundfont_open_parm</span> <span class="n">parm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">open_client</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parm</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">parm</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_special_type</span><span class="p">(</span><span class="n">parm</span><span class="p">.</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">parm</span><span class="p">.</span><span class="n">type</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_PAT_SHARED</span><span class="p">;</span>
		<span class="n">sf</span> <span class="o">=</span> <span class="n">newsf</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">parm</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> 
		<span class="n">sf</span> <span class="o">=</span> <span class="n">newsf</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">parm</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">parm</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">open_client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span> <span class="o">=</span> <span class="n">sf</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a new soundfont structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span>
<span class="nf">newsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>

	<span class="cm">/* check the shared fonts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_PAT_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sf</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span><span class="p">;</span> <span class="n">sf</span><span class="p">;</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_identical_font</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">sf</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* not found -- create a new one */</span>
	<span class="n">sf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts_size</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts_size</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* prepend this record */</span>
	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span> <span class="o">=</span> <span class="n">sf</span><span class="p">;</span>

	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">SNDRV_SFNT_PATCH_NAME_LEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check if the given name matches to the existing list */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">is_identical_font</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_PAT_SHARED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		 <span class="n">memcmp</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">SNDRV_SFNT_PATCH_NAME_LEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Close the current patch.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">close_patch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">open_client</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rebuild_presets</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* probe sample in the current list -- nothing to be loaded */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">probe_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* patch must be opened */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* search the specified sample by optarg */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">find_sample</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * increment zone counter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_zone_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_PAT_LOCKED</span><span class="p">)</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_locked</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate a new zone record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span>
<span class="nf">sf_zone_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">zp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">zp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span>
	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span> <span class="o">=</span> <span class="n">zp</span><span class="p">;</span>

	<span class="n">init_voice_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">);</span>

	<span class="n">set_zone_counter</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">zp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">zp</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * increment sample counter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_sample_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_PAT_LOCKED</span><span class="p">)</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_locked</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * allocate a new sample list record</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span>
<span class="nf">sf_sample_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span>
	<span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span> <span class="o">=</span> <span class="n">sp</span><span class="p">;</span>

	<span class="n">set_sample_counter</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * delete sample list -- this is an exceptional job.</span>
<span class="cm"> * only the last allocated sample can be deleted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sf_sample_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only last sample is accepted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* load voice map */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">load_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">,</span> <span class="o">*</span><span class="n">prevp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundfont_voice_map</span> <span class="n">map</span><span class="p">;</span>

	<span class="cm">/* get the link info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">map</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">map_instr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">map</span><span class="p">.</span><span class="n">map_instr</span> <span class="o">&gt;=</span> <span class="n">SF_MAX_INSTRUMENTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	
	<span class="n">sf</span> <span class="o">=</span> <span class="n">newsf</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">SNDRV_SFNT_PAT_TYPE_MAP</span><span class="o">|</span><span class="n">SNDRV_SFNT_PAT_SHARED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">prevp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">zp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span> <span class="n">zp</span><span class="p">;</span> <span class="n">prevp</span> <span class="o">=</span> <span class="n">zp</span><span class="p">,</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zp</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">map_instr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zp</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">map_bank</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">map_key</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">start</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">src_instr</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">end</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">src_bank</span> <span class="o">&amp;&amp;</span>
		    <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">fixkey</span> <span class="o">==</span> <span class="n">map</span><span class="p">.</span><span class="n">src_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the same mapping is already present */</span>
			<span class="cm">/* relink this record to the link head */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prevp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prevp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">zp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span>
				<span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span> <span class="o">=</span> <span class="n">zp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* update the counter */</span>
			<span class="n">set_zone_counter</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">zp</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* create a new zone */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">zp</span> <span class="o">=</span> <span class="n">sf_zone_new</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">map_bank</span><span class="p">;</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">map_instr</span><span class="p">;</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">map_key</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">map_key</span><span class="p">;</span>
		<span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">map_key</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">src_instr</span><span class="p">;</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">src_bank</span><span class="p">;</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">fixkey</span> <span class="o">=</span> <span class="n">map</span><span class="p">.</span><span class="n">src_key</span><span class="p">;</span>
	<span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">add_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">zp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* remove the present instrument layers */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">remove_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span>
	    <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">&amp;&amp;</span>
		    <span class="n">p</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">==</span> <span class="n">bank</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">==</span> <span class="n">instr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* remove this layer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
				<span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
			<span class="n">removed</span><span class="o">++</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">removed</span><span class="p">)</span>
		<span class="n">rebuild_presets</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">removed</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read an info record from the user buffer and save it on the current</span>
<span class="cm"> * open soundfont.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">load_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundfont_voice_rec_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* patch must be opened */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sf</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_special_type</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Soundfont error: invalid patch zone length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	
	<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">nvoices</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdr</span><span class="p">.</span><span class="n">nvoices</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Soundfont error: Illegal voice number %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hdr</span><span class="p">.</span><span class="n">nvoices</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundfont_voice_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">hdr</span><span class="p">.</span><span class="n">nvoices</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Soundfont Error: &quot;</span>
		       <span class="s">&quot;patch length(%ld) is smaller than nvoices(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">count</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">nvoices</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">write_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_WR_EXCLUSIVE</span>:
		<span class="cm">/* exclusive mode - if the instrument already exists,</span>
<span class="cm">		   return error */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">zone</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span> <span class="n">zone</span><span class="p">;</span> <span class="n">zone</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">&amp;&amp;</span>
			    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">==</span> <span class="n">hdr</span><span class="p">.</span><span class="n">bank</span> <span class="o">&amp;&amp;</span>
			    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">==</span> <span class="n">hdr</span><span class="p">.</span><span class="n">instr</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_SFNT_WR_REPLACE</span>:
		<span class="cm">/* replace mode - remove the instrument if it already exists */</span>
		<span class="n">remove_info</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">bank</span><span class="p">,</span> <span class="n">hdr</span><span class="p">.</span><span class="n">instr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdr</span><span class="p">.</span><span class="n">nvoices</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="n">tmpzone</span><span class="p">;</span>

		<span class="cm">/* copy awe_voice_info parameters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">);</span>

		<span class="n">tmpzone</span><span class="p">.</span><span class="n">bank</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">bank</span><span class="p">;</span>
		<span class="n">tmpzone</span><span class="p">.</span><span class="n">instr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">instr</span><span class="p">;</span>
		<span class="n">tmpzone</span><span class="p">.</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_MODE_INIT_PARM</span><span class="p">)</span>
			<span class="n">init_voice_parm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">);</span>

		<span class="cm">/* create a new zone */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">zone</span> <span class="o">=</span> <span class="n">sf_zone_new</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* copy the temporary data */</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="n">tmpzone</span><span class="p">.</span><span class="n">bank</span><span class="p">;</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">=</span> <span class="n">tmpzone</span><span class="p">.</span><span class="n">instr</span><span class="p">;</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span> <span class="o">=</span> <span class="n">tmpzone</span><span class="p">.</span><span class="n">v</span><span class="p">;</span>

		<span class="cm">/* look up the sample */</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">=</span> <span class="n">set_sample</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* initialize voice_info record */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_voice_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundfont_voice_info</span> <span class="o">*</span><span class="n">avp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">avp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">avp</span><span class="p">));</span>

	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">velhigh</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">fixkey</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">fixvel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">fixpan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">pan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">amplitude</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">scaleTuning</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">init_voice_parm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* initialize voice_parm record:</span>
<span class="cm"> * Env1/2: delay=0, attack=0, hold=0, sustain=0, decay=0, release=0.</span>
<span class="cm"> * Vibrato and Tremolo effects are zero.</span>
<span class="cm"> * Cutoff is maximum.</span>
<span class="cm"> * Chorus and Reverb effects are zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_voice_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">soundfont_voice_parm</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">));</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">moddelay</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">modatkhld</span> <span class="o">=</span> <span class="mh">0x7f7f</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">moddcysus</span> <span class="o">=</span> <span class="mh">0x7f7f</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">modrelease</span> <span class="o">=</span> <span class="mh">0x807f</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">voldelay</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">volatkhld</span> <span class="o">=</span> <span class="mh">0x7f7f</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">voldcysus</span> <span class="o">=</span> <span class="mh">0x7f7f</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">volrelease</span> <span class="o">=</span> <span class="mh">0x807f</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">lfo1delay</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">lfo2delay</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="n">pp</span><span class="o">-&gt;</span><span class="n">cutoff</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>	

<span class="cm">/* search the specified sample */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span>
<span class="nf">set_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soundfont_voice_info</span> <span class="o">*</span><span class="n">avp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sample</span><span class="p">;</span>

	<span class="n">sample</span> <span class="o">=</span> <span class="n">find_sample</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">sample</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sample</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* add in the actual sample offsets:</span>
<span class="cm">	 * The voice_info addresses define only the relative offset</span>
<span class="cm">	 * from sample pointers.  Here we calculate the actual DRAM</span>
<span class="cm">	 * offset from sample pointers.</span>
<span class="cm">	 */</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">+=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">loopstart</span> <span class="o">+=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">loopstart</span><span class="p">;</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">loopend</span> <span class="o">+=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">loopend</span><span class="p">;</span>

	<span class="cm">/* copy mode flags */</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">sample_mode</span> <span class="o">=</span> <span class="n">sample</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sample</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* find the sample pointer with the given id in the soundfont */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span>
<span class="nf">find_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sample_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sample</span> <span class="o">==</span> <span class="n">sample_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Load sample information, this can include data to be loaded onto</span>
<span class="cm"> * the soundcard.  It can also just be a pointer into soundcard ROM.</span>
<span class="cm"> * If there is data it will be written to the soundcard via the callback</span>
<span class="cm"> * routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">load_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soundfont_sample_info</span> <span class="n">sample_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">off</span><span class="p">;</span>

	<span class="cm">/* patch must be opened */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sf</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_special_type</span><span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sample_info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sample_info</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sample_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sample_info</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="n">count</span><span class="o">-</span><span class="n">off</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Check for dup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_sample</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="n">sample_info</span><span class="p">.</span><span class="n">sample</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* if shared sample, skip this data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_PAT_SHARED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a new sample structure */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sf_sample_new</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span> <span class="o">=</span> <span class="n">sample_info</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is wave data then load it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>  <span class="n">rc</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_new</span>
			<span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">memhdr</span><span class="p">,</span>
			 <span class="n">data</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sf_sample_delete</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">mem_used</span> <span class="o">+=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">truesize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* log2_tbl[i] = log2(i+128) * 0x10000 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">log_tbl</span><span class="p">[</span><span class="mi">129</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x70000</span><span class="p">,</span> <span class="mh">0x702df</span><span class="p">,</span> <span class="mh">0x705b9</span><span class="p">,</span> <span class="mh">0x7088e</span><span class="p">,</span> <span class="mh">0x70b5d</span><span class="p">,</span> <span class="mh">0x70e26</span><span class="p">,</span> <span class="mh">0x710eb</span><span class="p">,</span> <span class="mh">0x713aa</span><span class="p">,</span>
	<span class="mh">0x71663</span><span class="p">,</span> <span class="mh">0x71918</span><span class="p">,</span> <span class="mh">0x71bc8</span><span class="p">,</span> <span class="mh">0x71e72</span><span class="p">,</span> <span class="mh">0x72118</span><span class="p">,</span> <span class="mh">0x723b9</span><span class="p">,</span> <span class="mh">0x72655</span><span class="p">,</span> <span class="mh">0x728ed</span><span class="p">,</span>
	<span class="mh">0x72b80</span><span class="p">,</span> <span class="mh">0x72e0e</span><span class="p">,</span> <span class="mh">0x73098</span><span class="p">,</span> <span class="mh">0x7331d</span><span class="p">,</span> <span class="mh">0x7359e</span><span class="p">,</span> <span class="mh">0x7381b</span><span class="p">,</span> <span class="mh">0x73a93</span><span class="p">,</span> <span class="mh">0x73d08</span><span class="p">,</span>
	<span class="mh">0x73f78</span><span class="p">,</span> <span class="mh">0x741e4</span><span class="p">,</span> <span class="mh">0x7444c</span><span class="p">,</span> <span class="mh">0x746b0</span><span class="p">,</span> <span class="mh">0x74910</span><span class="p">,</span> <span class="mh">0x74b6c</span><span class="p">,</span> <span class="mh">0x74dc4</span><span class="p">,</span> <span class="mh">0x75019</span><span class="p">,</span>
	<span class="mh">0x75269</span><span class="p">,</span> <span class="mh">0x754b6</span><span class="p">,</span> <span class="mh">0x75700</span><span class="p">,</span> <span class="mh">0x75946</span><span class="p">,</span> <span class="mh">0x75b88</span><span class="p">,</span> <span class="mh">0x75dc7</span><span class="p">,</span> <span class="mh">0x76002</span><span class="p">,</span> <span class="mh">0x7623a</span><span class="p">,</span>
	<span class="mh">0x7646e</span><span class="p">,</span> <span class="mh">0x766a0</span><span class="p">,</span> <span class="mh">0x768cd</span><span class="p">,</span> <span class="mh">0x76af8</span><span class="p">,</span> <span class="mh">0x76d1f</span><span class="p">,</span> <span class="mh">0x76f43</span><span class="p">,</span> <span class="mh">0x77164</span><span class="p">,</span> <span class="mh">0x77382</span><span class="p">,</span>
	<span class="mh">0x7759d</span><span class="p">,</span> <span class="mh">0x777b4</span><span class="p">,</span> <span class="mh">0x779c9</span><span class="p">,</span> <span class="mh">0x77bdb</span><span class="p">,</span> <span class="mh">0x77dea</span><span class="p">,</span> <span class="mh">0x77ff5</span><span class="p">,</span> <span class="mh">0x781fe</span><span class="p">,</span> <span class="mh">0x78404</span><span class="p">,</span>
	<span class="mh">0x78608</span><span class="p">,</span> <span class="mh">0x78808</span><span class="p">,</span> <span class="mh">0x78a06</span><span class="p">,</span> <span class="mh">0x78c01</span><span class="p">,</span> <span class="mh">0x78df9</span><span class="p">,</span> <span class="mh">0x78fef</span><span class="p">,</span> <span class="mh">0x791e2</span><span class="p">,</span> <span class="mh">0x793d2</span><span class="p">,</span>
	<span class="mh">0x795c0</span><span class="p">,</span> <span class="mh">0x797ab</span><span class="p">,</span> <span class="mh">0x79993</span><span class="p">,</span> <span class="mh">0x79b79</span><span class="p">,</span> <span class="mh">0x79d5d</span><span class="p">,</span> <span class="mh">0x79f3e</span><span class="p">,</span> <span class="mh">0x7a11d</span><span class="p">,</span> <span class="mh">0x7a2f9</span><span class="p">,</span>
	<span class="mh">0x7a4d3</span><span class="p">,</span> <span class="mh">0x7a6ab</span><span class="p">,</span> <span class="mh">0x7a880</span><span class="p">,</span> <span class="mh">0x7aa53</span><span class="p">,</span> <span class="mh">0x7ac24</span><span class="p">,</span> <span class="mh">0x7adf2</span><span class="p">,</span> <span class="mh">0x7afbe</span><span class="p">,</span> <span class="mh">0x7b188</span><span class="p">,</span>
	<span class="mh">0x7b350</span><span class="p">,</span> <span class="mh">0x7b515</span><span class="p">,</span> <span class="mh">0x7b6d8</span><span class="p">,</span> <span class="mh">0x7b899</span><span class="p">,</span> <span class="mh">0x7ba58</span><span class="p">,</span> <span class="mh">0x7bc15</span><span class="p">,</span> <span class="mh">0x7bdd0</span><span class="p">,</span> <span class="mh">0x7bf89</span><span class="p">,</span>
	<span class="mh">0x7c140</span><span class="p">,</span> <span class="mh">0x7c2f5</span><span class="p">,</span> <span class="mh">0x7c4a7</span><span class="p">,</span> <span class="mh">0x7c658</span><span class="p">,</span> <span class="mh">0x7c807</span><span class="p">,</span> <span class="mh">0x7c9b3</span><span class="p">,</span> <span class="mh">0x7cb5e</span><span class="p">,</span> <span class="mh">0x7cd07</span><span class="p">,</span>
	<span class="mh">0x7ceae</span><span class="p">,</span> <span class="mh">0x7d053</span><span class="p">,</span> <span class="mh">0x7d1f7</span><span class="p">,</span> <span class="mh">0x7d398</span><span class="p">,</span> <span class="mh">0x7d538</span><span class="p">,</span> <span class="mh">0x7d6d6</span><span class="p">,</span> <span class="mh">0x7d872</span><span class="p">,</span> <span class="mh">0x7da0c</span><span class="p">,</span>
	<span class="mh">0x7dba4</span><span class="p">,</span> <span class="mh">0x7dd3b</span><span class="p">,</span> <span class="mh">0x7ded0</span><span class="p">,</span> <span class="mh">0x7e063</span><span class="p">,</span> <span class="mh">0x7e1f4</span><span class="p">,</span> <span class="mh">0x7e384</span><span class="p">,</span> <span class="mh">0x7e512</span><span class="p">,</span> <span class="mh">0x7e69f</span><span class="p">,</span>
	<span class="mh">0x7e829</span><span class="p">,</span> <span class="mh">0x7e9b3</span><span class="p">,</span> <span class="mh">0x7eb3a</span><span class="p">,</span> <span class="mh">0x7ecc0</span><span class="p">,</span> <span class="mh">0x7ee44</span><span class="p">,</span> <span class="mh">0x7efc7</span><span class="p">,</span> <span class="mh">0x7f148</span><span class="p">,</span> <span class="mh">0x7f2c8</span><span class="p">,</span>
	<span class="mh">0x7f446</span><span class="p">,</span> <span class="mh">0x7f5c2</span><span class="p">,</span> <span class="mh">0x7f73d</span><span class="p">,</span> <span class="mh">0x7f8b7</span><span class="p">,</span> <span class="mh">0x7fa2f</span><span class="p">,</span> <span class="mh">0x7fba5</span><span class="p">,</span> <span class="mh">0x7fd1a</span><span class="p">,</span> <span class="mh">0x7fe8d</span><span class="p">,</span>
	<span class="mh">0x80000</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* convert from linear to log value</span>
<span class="cm"> *</span>
<span class="cm"> * conversion: value = log2(amount / base) * ratio</span>
<span class="cm"> *</span>
<span class="cm"> * argument:</span>
<span class="cm"> *   amount = linear value (unsigned, 32bit max)</span>
<span class="cm"> *   offset = base offset (:= log2(base) * 0x10000)</span>
<span class="cm"> *   ratio = division ratio</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">snd_sf_linear_to_log</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">amount</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&amp;</span> <span class="mh">0x80000000L</span><span class="p">);</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span>
		<span class="n">amount</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="cm">/* linear approxmimation by lower 8 bit */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_tbl</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">low</span> <span class="o">+</span> <span class="n">log_tbl</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">-</span> <span class="n">low</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">24</span> <span class="o">-</span> <span class="n">bit</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">snd_sf_linear_to_log</span><span class="p">);</span>


<span class="cp">#define OFFSET_MSEC		653117		</span><span class="cm">/* base = 1000 */</span><span class="cp"></span>
<span class="cp">#define OFFSET_ABSCENT		851781		</span><span class="cm">/* base = 8176 */</span><span class="cp"></span>
<span class="cp">#define OFFSET_SAMPLERATE	1011119		</span><span class="cm">/* base = 44100 */</span><span class="cp"></span>

<span class="cp">#define ABSCENT_RATIO		1200</span>
<span class="cp">#define TIMECENT_RATIO		1200</span>
<span class="cp">#define SAMPLERATE_RATIO	4096</span>

<span class="cm">/*</span>
<span class="cm"> * mHz to abscent</span>
<span class="cm"> * conversion: abscent = log2(MHz / 8176) * 1200</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">freq_to_note</span><span class="p">(</span><span class="kt">int</span> <span class="n">mhz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_sf_linear_to_log</span><span class="p">(</span><span class="n">mhz</span><span class="p">,</span> <span class="n">OFFSET_ABSCENT</span><span class="p">,</span> <span class="n">ABSCENT_RATIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* convert Hz to AWE32 rate offset:</span>
<span class="cm"> * sample pitch offset for the specified sample rate</span>
<span class="cm"> * rate=44100 is no offset, each 4096 is 1 octave (twice).</span>
<span class="cm"> * eg, when rate is 22050, this offset becomes -4096.</span>
<span class="cm"> *</span>
<span class="cm"> * conversion: offset = log2(Hz / 44100) * 4096</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">calc_rate_offset</span><span class="p">(</span><span class="kt">int</span> <span class="n">hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_sf_linear_to_log</span><span class="p">(</span><span class="n">hz</span><span class="p">,</span> <span class="n">OFFSET_SAMPLERATE</span><span class="p">,</span> <span class="n">SAMPLERATE_RATIO</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* calculate GUS envelope time */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">calc_gus_envelope_time</span><span class="p">(</span><span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">-</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">t</span> <span class="o">=</span> <span class="o">-</span><span class="n">t</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">13</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">)</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">13</span> <span class="o">-</span> <span class="n">r</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">r</span> <span class="o">-</span> <span class="mi">13</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="mi">441</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* convert envelope time parameter to soundfont parameters */</span>

<span class="cm">/* attack &amp; decay/release time table (msec) */</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">attack_time_tbl</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">32767</span><span class="p">,</span> <span class="mi">32767</span><span class="p">,</span> <span class="mi">5989</span><span class="p">,</span> <span class="mi">4235</span><span class="p">,</span> <span class="mi">2994</span><span class="p">,</span> <span class="mi">2518</span><span class="p">,</span> <span class="mi">2117</span><span class="p">,</span> <span class="mi">1780</span><span class="p">,</span> <span class="mi">1497</span><span class="p">,</span> <span class="mi">1373</span><span class="p">,</span> <span class="mi">1259</span><span class="p">,</span> <span class="mi">1154</span><span class="p">,</span> <span class="mi">1058</span><span class="p">,</span> <span class="mi">970</span><span class="p">,</span> <span class="mi">890</span><span class="p">,</span> <span class="mi">816</span><span class="p">,</span>
<span class="mi">707</span><span class="p">,</span> <span class="mi">691</span><span class="p">,</span> <span class="mi">662</span><span class="p">,</span> <span class="mi">634</span><span class="p">,</span> <span class="mi">607</span><span class="p">,</span> <span class="mi">581</span><span class="p">,</span> <span class="mi">557</span><span class="p">,</span> <span class="mi">533</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">489</span><span class="p">,</span> <span class="mi">468</span><span class="p">,</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">429</span><span class="p">,</span> <span class="mi">411</span><span class="p">,</span> <span class="mi">393</span><span class="p">,</span> <span class="mi">377</span><span class="p">,</span>
<span class="mi">361</span><span class="p">,</span> <span class="mi">345</span><span class="p">,</span> <span class="mi">331</span><span class="p">,</span> <span class="mi">317</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">278</span><span class="p">,</span> <span class="mi">266</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span>
<span class="mi">180</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span>
<span class="mi">90</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
<span class="mi">45</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
<span class="mi">22</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>
<span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">short</span> <span class="n">decay_time_tbl</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="mi">32767</span><span class="p">,</span> <span class="mi">32767</span><span class="p">,</span> <span class="mi">22614</span><span class="p">,</span> <span class="mi">15990</span><span class="p">,</span> <span class="mi">11307</span><span class="p">,</span> <span class="mi">9508</span><span class="p">,</span> <span class="mi">7995</span><span class="p">,</span> <span class="mi">6723</span><span class="p">,</span> <span class="mi">5653</span><span class="p">,</span> <span class="mi">5184</span><span class="p">,</span> <span class="mi">4754</span><span class="p">,</span> <span class="mi">4359</span><span class="p">,</span> <span class="mi">3997</span><span class="p">,</span> <span class="mi">3665</span><span class="p">,</span> <span class="mi">3361</span><span class="p">,</span> <span class="mi">3082</span><span class="p">,</span>
<span class="mi">2828</span><span class="p">,</span> <span class="mi">2765</span><span class="p">,</span> <span class="mi">2648</span><span class="p">,</span> <span class="mi">2535</span><span class="p">,</span> <span class="mi">2428</span><span class="p">,</span> <span class="mi">2325</span><span class="p">,</span> <span class="mi">2226</span><span class="p">,</span> <span class="mi">2132</span><span class="p">,</span> <span class="mi">2042</span><span class="p">,</span> <span class="mi">1955</span><span class="p">,</span> <span class="mi">1872</span><span class="p">,</span> <span class="mi">1793</span><span class="p">,</span> <span class="mi">1717</span><span class="p">,</span> <span class="mi">1644</span><span class="p">,</span> <span class="mi">1574</span><span class="p">,</span> <span class="mi">1507</span><span class="p">,</span>
<span class="mi">1443</span><span class="p">,</span> <span class="mi">1382</span><span class="p">,</span> <span class="mi">1324</span><span class="p">,</span> <span class="mi">1267</span><span class="p">,</span> <span class="mi">1214</span><span class="p">,</span> <span class="mi">1162</span><span class="p">,</span> <span class="mi">1113</span><span class="p">,</span> <span class="mi">1066</span><span class="p">,</span> <span class="mi">978</span><span class="p">,</span> <span class="mi">936</span><span class="p">,</span> <span class="mi">897</span><span class="p">,</span> <span class="mi">859</span><span class="p">,</span> <span class="mi">822</span><span class="p">,</span> <span class="mi">787</span><span class="p">,</span> <span class="mi">754</span><span class="p">,</span> <span class="mi">722</span><span class="p">,</span>
<span class="mi">691</span><span class="p">,</span> <span class="mi">662</span><span class="p">,</span> <span class="mi">634</span><span class="p">,</span> <span class="mi">607</span><span class="p">,</span> <span class="mi">581</span><span class="p">,</span> <span class="mi">557</span><span class="p">,</span> <span class="mi">533</span><span class="p">,</span> <span class="mi">510</span><span class="p">,</span> <span class="mi">489</span><span class="p">,</span> <span class="mi">468</span><span class="p">,</span> <span class="mi">448</span><span class="p">,</span> <span class="mi">429</span><span class="p">,</span> <span class="mi">411</span><span class="p">,</span> <span class="mi">393</span><span class="p">,</span> <span class="mi">377</span><span class="p">,</span> <span class="mi">361</span><span class="p">,</span>
<span class="mi">345</span><span class="p">,</span> <span class="mi">331</span><span class="p">,</span> <span class="mi">317</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">290</span><span class="p">,</span> <span class="mi">278</span><span class="p">,</span> <span class="mi">266</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span>
<span class="mi">172</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span>
<span class="mi">86</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span>
<span class="mi">43</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* delay time = 0x8000 - msec/92 */</span>
<span class="kt">int</span>
<span class="nf">snd_sf_calc_parm_hold</span><span class="p">(</span><span class="kt">int</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7f</span> <span class="o">*</span> <span class="mi">92</span> <span class="o">-</span> <span class="n">msec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">92</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="mi">126</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">126</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* search an index for specified time from given time table */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">calc_parm_search</span><span class="p">(</span><span class="kt">int</span> <span class="n">msec</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mi">127</span><span class="p">,</span> <span class="n">mid</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msec</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">table</span><span class="p">[</span><span class="n">mid</span><span class="p">])</span>
			<span class="n">left</span> <span class="o">=</span> <span class="n">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">right</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">left</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* attack time: search from time table */</span>
<span class="kt">int</span>
<span class="nf">snd_sf_calc_parm_attack</span><span class="p">(</span><span class="kt">int</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">calc_parm_search</span><span class="p">(</span><span class="n">msec</span><span class="p">,</span> <span class="n">attack_time_tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* decay/release time: search from time table */</span>
<span class="kt">int</span>
<span class="nf">snd_sf_calc_parm_decay</span><span class="p">(</span><span class="kt">int</span> <span class="n">msec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">calc_parm_search</span><span class="p">(</span><span class="n">msec</span><span class="p">,</span> <span class="n">decay_time_tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">snd_sf_vol_table</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">255</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">86</span><span class="p">,</span><span class="mi">79</span><span class="p">,</span><span class="mi">74</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">66</span><span class="p">,</span><span class="mi">63</span><span class="p">,</span><span class="mi">61</span><span class="p">,</span><span class="mi">58</span><span class="p">,</span><span class="mi">56</span><span class="p">,</span><span class="mi">54</span><span class="p">,</span><span class="mi">52</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">49</span><span class="p">,</span>
	<span class="mi">47</span><span class="p">,</span><span class="mi">46</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">43</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">41</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="mi">38</span><span class="p">,</span><span class="mi">37</span><span class="p">,</span><span class="mi">36</span><span class="p">,</span><span class="mi">35</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">33</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span>
	<span class="mi">31</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">27</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">26</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">23</span><span class="p">,</span><span class="mi">22</span><span class="p">,</span>
	<span class="mi">22</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">19</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">17</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span>
	<span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span>
	<span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span>
	<span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
	<span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#define calc_gus_sustain(val)  (0x7f - snd_sf_vol_table[(val)/2])</span>
<span class="cp">#define calc_gus_attenuation(val)	snd_sf_vol_table[(val)/2]</span>

<span class="cm">/* load GUS patch */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">load_guspatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
	      <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">patch_info</span> <span class="n">patch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">smp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">note</span><span class="p">,</span> <span class="n">sample_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;patch record too small %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">patch</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	
	<span class="n">count</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">patch</span><span class="p">);</span>

	<span class="n">sf</span> <span class="o">=</span> <span class="n">newsf</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">SNDRV_SFNT_PAT_TYPE_GUS</span><span class="o">|</span><span class="n">SNDRV_SFNT_PAT_SHARED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">smp</span> <span class="o">=</span> <span class="n">sf_sample_new</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sample_id</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_counter</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">sample_id</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">loopstart</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">loop_start</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">loopend</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">loop_end</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* set up mode flags */</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_16_BITS</span><span class="p">))</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_SAMPLE_8BITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_UNSIGNED</span><span class="p">)</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_SAMPLE_UNSIGNED</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_SAMPLE_NO_BLANK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WAVE_LOOPING</span><span class="o">|</span><span class="n">WAVE_BIDIR_LOOP</span><span class="o">|</span><span class="n">WAVE_LOOP_BACK</span><span class="p">)))</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_SAMPLE_SINGLESHOT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_BIDIR_LOOP</span><span class="p">)</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_SAMPLE_BIDIR_LOOP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_LOOP_BACK</span><span class="p">)</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">|=</span> <span class="n">SNDRV_SFNT_SAMPLE_REVERSE_LOOP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_16_BITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* convert to word offsets */</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">end</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">loopstart</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">loopend</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*smp-&gt;v.loopend++;*/</span>

	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">dummy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">truesize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* set up voice info */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">zone</span> <span class="o">=</span> <span class="n">sf_zone_new</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sf_sample_delete</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">smp</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * load wave data</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_new</span>
			<span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">,</span> <span class="n">smp</span><span class="p">,</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">memhdr</span><span class="p">,</span>
			 <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sf_sample_delete</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">sf</span><span class="p">,</span> <span class="n">smp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* memory offset is updated after */</span>
	<span class="p">}</span>

	<span class="cm">/* update the memory offset here */</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">mem_used</span> <span class="o">+=</span> <span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">truesize</span><span class="p">;</span>

	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sample</span> <span class="o">=</span> <span class="n">sample_id</span><span class="p">;</span> <span class="cm">/* the last sample */</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">rate_offset</span> <span class="o">=</span> <span class="n">calc_rate_offset</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">base_freq</span><span class="p">);</span>
	<span class="n">note</span> <span class="o">=</span> <span class="n">freq_to_note</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">base_note</span><span class="p">);</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">note</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">tune</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">note</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_to_note</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">low_note</span><span class="p">)</span> <span class="o">+</span> <span class="mi">99</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">freq_to_note</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">high_note</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="cm">/* panning position; -128 - 127 =&gt; 0-127 */</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">pan</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">panning</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	snd_printk(KERN_DEBUG</span>
<span class="c">		   &quot;gus: basefrq=%d (ofs=%d) root=%d,tune=%d, range:%d-%d\n&quot;,</span>
<span class="c">		   (int)patch.base_freq, zone-&gt;v.rate_offset,</span>
<span class="c">		   zone-&gt;v.root, zone-&gt;v.tune, zone-&gt;v.low, zone-&gt;v.high);</span>
<span class="cp">#endif</span>

	<span class="cm">/* detuning is ignored */</span>
	<span class="cm">/* 6points volume envelope */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_ENVELOPES</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">attack</span><span class="p">,</span> <span class="n">hold</span><span class="p">,</span> <span class="n">decay</span><span class="p">,</span> <span class="n">release</span><span class="p">;</span>
		<span class="n">attack</span> <span class="o">=</span> <span class="n">calc_gus_envelope_time</span>
			<span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_rate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">hold</span> <span class="o">=</span> <span class="n">calc_gus_envelope_time</span>
			<span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_rate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			 <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">decay</span> <span class="o">=</span> <span class="n">calc_gus_envelope_time</span>
			<span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_rate</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			 <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">release</span> <span class="o">=</span> <span class="n">calc_gus_envelope_time</span>
			<span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_rate</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			 <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">release</span> <span class="o">+=</span> <span class="n">calc_gus_envelope_time</span>
			<span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_rate</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			 <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">release</span> <span class="o">+=</span> <span class="n">calc_gus_envelope_time</span>
			<span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_rate</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			 <span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">volatkhld</span> <span class="o">=</span> 
			<span class="p">(</span><span class="n">snd_sf_calc_parm_hold</span><span class="p">(</span><span class="n">hold</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">snd_sf_calc_parm_attack</span><span class="p">(</span><span class="n">attack</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">voldcysus</span> <span class="o">=</span> <span class="p">(</span><span class="n">calc_gus_sustain</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">snd_sf_calc_parm_decay</span><span class="p">(</span><span class="n">decay</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">volrelease</span> <span class="o">=</span> <span class="mh">0x8000</span> <span class="o">|</span> <span class="n">snd_sf_calc_parm_decay</span><span class="p">(</span><span class="n">release</span><span class="p">);</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">attenuation</span> <span class="o">=</span> <span class="n">calc_gus_attenuation</span><span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">env_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		snd_printk(KERN_DEBUG</span>
<span class="c">			   &quot;gus: atkhld=%x, dcysus=%x, volrel=%x, att=%d\n&quot;,</span>
<span class="c">			   zone-&gt;v.parm.volatkhld,</span>
<span class="c">			   zone-&gt;v.parm.voldcysus,</span>
<span class="c">			   zone-&gt;v.parm.volrelease,</span>
<span class="c">			   zone-&gt;v.attenuation);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* fast release */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_FAST_RELEASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">volrelease</span> <span class="o">=</span> <span class="mh">0x807f</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* tremolo effect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_TREMOLO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">tremolo_rate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">38</span><span class="p">)</span> <span class="o">/</span> <span class="mi">42</span><span class="p">;</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">tremfrq</span> <span class="o">=</span> <span class="p">((</span><span class="n">patch</span><span class="p">.</span><span class="n">tremolo_depth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* vibrato effect */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">WAVE_VIBRATO</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch</span><span class="p">.</span><span class="n">vibrato_rate</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="mi">38</span><span class="p">)</span> <span class="o">/</span> <span class="mi">42</span><span class="p">;</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">parm</span><span class="p">.</span><span class="n">fm2frq2</span> <span class="o">=</span> <span class="p">((</span><span class="n">patch</span><span class="p">.</span><span class="n">vibrato_depth</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/* scale_freq, scale_factor, volume, and fractions not implemented */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">smp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode_flags</span> <span class="o">&amp;</span> <span class="n">SNDRV_SFNT_SAMPLE_SINGLESHOT</span><span class="p">))</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">SNDRV_SFNT_MODE_LOOPING</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* append to the tail of the list */</span>
	<span class="cm">/*zone-&gt;bank = ctrls[AWE_MD_GUS_BANK];*/</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">=</span> <span class="n">patch</span><span class="p">.</span><span class="n">instr_no</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">zone</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">=</span> <span class="n">set_sample</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">);</span>

	<span class="cm">/* rebuild preset now */</span>
	<span class="n">add_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">zone</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* load GUS patch */</span>
<span class="kt">int</span>
<span class="nf">snd_soundfont_load_guspatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			    <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">lock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">load_guspatch</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
	<span class="n">unlock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Rebuild the preset table.  This is like a hash table in that it allows</span>
<span class="cm"> * quick access to the zone information.  For each preset there are zone</span>
<span class="cm"> * structures linked by next_instr and by next_zone.  Former is the whole</span>
<span class="cm"> * link for this preset, and latter is the link for zone (i.e. instrument/</span>
<span class="cm"> * bank/key combination).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">rebuild_presets</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">cur</span><span class="p">;</span>

	<span class="cm">/* clear preset table */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">));</span>

	<span class="cm">/* search all fonts and insert each font */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">sf</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span><span class="p">;</span> <span class="n">sf</span><span class="p">;</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span> <span class="n">cur</span><span class="p">;</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">mapped</span> <span class="o">&amp;&amp;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* try again to search the corresponding sample */</span>
				<span class="n">cur</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">=</span> <span class="n">set_sample</span><span class="p">(</span><span class="n">sf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">sample</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">add_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">cur</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * add the given zone to preset table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">add_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">cur</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">zone</span> <span class="o">=</span> <span class="n">search_first_zone</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">&amp;&amp;</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span> <span class="o">!=</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">sf_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* different instrument was already defined */</span>
		<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="cm">/* compare the allocated time */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next_zone</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">)</span>
				<span class="cm">/* the current is older.. skipped */</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* remove old zones */</span>
		<span class="n">delete_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">zone</span><span class="p">);</span>
		<span class="n">zone</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* do not forget to clear this! */</span>
	<span class="p">}</span>

	<span class="cm">/* prepend this zone */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">,</span> <span class="n">cur</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_zone</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span> <span class="cm">/* zone link */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">next_instr</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="cm">/* preset table link */</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * delete the given zones from preset_table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">delete_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">instr</span><span class="p">,</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next_instr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">next_instr</span> <span class="o">==</span> <span class="n">zp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">next_instr</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next_instr</span><span class="p">;</span>
			<span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next_zone</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Search matching zones from preset table.</span>
<span class="cm"> * The note can be rewritten by preset mapping (alias).</span>
<span class="cm"> * The found zones are stored on &#39;table&#39; array.  max_layers defines</span>
<span class="cm"> * the maximum number of elements in this array.</span>
<span class="cm"> * This function returns the number of found zones.  0 if not found.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">snd_soundfont_search_zone</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">notep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vel</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">preset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">def_preset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">def_bank</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">**</span><span class="n">table</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_layers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nvoices</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* this function is supposed to be called atomically,</span>
<span class="cm">	 * so we check the lock.  if it&#39;s busy, just returns 0 to</span>
<span class="cm">	 * tell the caller the busy state</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nvoices</span> <span class="o">=</span> <span class="n">search_zones</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">notep</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span> <span class="n">preset</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span>
			       <span class="n">table</span><span class="p">,</span> <span class="n">max_layers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">nvoices</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">preset</span> <span class="o">!=</span> <span class="n">def_preset</span> <span class="o">||</span> <span class="n">bank</span> <span class="o">!=</span> <span class="n">def_bank</span><span class="p">)</span>
			<span class="n">nvoices</span> <span class="o">=</span> <span class="n">search_zones</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">notep</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span>
					       <span class="n">def_preset</span><span class="p">,</span> <span class="n">def_bank</span><span class="p">,</span>
					       <span class="n">table</span><span class="p">,</span> <span class="n">max_layers</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">nvoices</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * search the first matching zone</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span>
<span class="nf">search_first_zone</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">preset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">=</span> <span class="n">get_index</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="n">preset</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">zp</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="n">zp</span><span class="p">;</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next_instr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">instr</span> <span class="o">==</span> <span class="n">preset</span> <span class="o">&amp;&amp;</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">bank</span> <span class="o">==</span> <span class="n">bank</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">zp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * search matching zones from sflist.  can be called recursively.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">search_zones</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">notep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vel</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">preset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">**</span><span class="n">table</span><span class="p">,</span>
	     <span class="kt">int</span> <span class="n">max_layers</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nvoices</span><span class="p">;</span>

	<span class="n">zp</span> <span class="o">=</span> <span class="n">search_first_zone</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">preset</span><span class="p">,</span> <span class="o">*</span><span class="n">notep</span><span class="p">);</span>
	<span class="n">nvoices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">zp</span><span class="p">;</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next_zone</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">notep</span> <span class="o">&gt;=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">low</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">notep</span> <span class="o">&lt;=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">high</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vel</span> <span class="o">&gt;=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">vellow</span> <span class="o">&amp;&amp;</span> <span class="n">vel</span> <span class="o">&lt;=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">velhigh</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* search preset mapping (aliasing) */</span>
				<span class="kt">int</span> <span class="n">key</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">fixkey</span><span class="p">;</span>
				<span class="n">preset</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
				<span class="n">bank</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="cm">/* too deep alias level */</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">key</span> <span class="o">=</span> <span class="o">*</span><span class="n">notep</span><span class="p">;</span>
				<span class="n">nvoices</span> <span class="o">=</span> <span class="n">search_zones</span><span class="p">(</span><span class="n">sflist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">vel</span><span class="p">,</span>
						       <span class="n">preset</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span>
						       <span class="n">max_layers</span><span class="p">,</span> <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">nvoices</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">*</span><span class="n">notep</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">table</span><span class="p">[</span><span class="n">nvoices</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">zp</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nvoices</span> <span class="o">&gt;=</span> <span class="n">max_layers</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nvoices</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* calculate the index of preset table:</span>
<span class="cm"> * drums are mapped from 128 to 255 according to its note key.</span>
<span class="cm"> * other instruments are mapped from 0 to 127.</span>
<span class="cm"> * if the index is out of range, return -1.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">get_index</span><span class="p">(</span><span class="kt">int</span> <span class="n">bank</span><span class="p">,</span> <span class="kt">int</span> <span class="n">instr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SF_IS_DRUM_BANK</span><span class="p">(</span><span class="n">bank</span><span class="p">))</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="n">SF_MAX_INSTRUMENTS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">instr</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">%</span> <span class="n">SF_MAX_PRESETS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the sflist structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_sf_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">));</span>

	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">mem_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">currsf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">open_client</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Release all list records</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_sf_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">,</span> <span class="o">*</span><span class="n">nextsf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">,</span> <span class="o">*</span><span class="n">nextzp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">nextsp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sf</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span><span class="p">;</span> <span class="n">sf</span><span class="p">;</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">nextsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nextsf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">zp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span> <span class="n">zp</span><span class="p">;</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">nextzp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nextzp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">zp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span> <span class="n">sp</span><span class="p">;</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">nextsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nextsp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_free</span><span class="p">)</span>
				<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_free</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">,</span>
							     <span class="n">sp</span><span class="p">,</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">memhdr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_sf_init</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Create a new sflist structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span>
<span class="nf">snd_sf_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_callback</span> <span class="o">*</span><span class="n">callback</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_util_memhdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sflist</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sflist</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">memhdr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="o">*</span><span class="n">callback</span><span class="p">;</span>

	<span class="n">snd_sf_init</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sflist</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Free everything allocated off the sflist structure.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">snd_sf_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	
	<span class="n">lock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_reset</span><span class="p">)</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_reset</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">snd_sf_clear</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">unlock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove all samples</span>
<span class="cm"> * The soundcard should be silet before calling this function.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">snd_soundfont_remove_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_reset</span><span class="p">)</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_reset</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">snd_sf_clear</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="n">unlock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove unlocked samples.</span>
<span class="cm"> * The soundcard should be silent before calling this function.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">snd_soundfont_remove_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_sf_list</span> <span class="o">*</span><span class="n">sflist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_soundfont</span> <span class="o">*</span><span class="n">sf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_zone</span> <span class="o">*</span><span class="n">zp</span><span class="p">,</span> <span class="o">*</span><span class="n">nextzp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_sf_sample</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">nextsp</span><span class="p">;</span>

	<span class="n">lock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_reset</span><span class="p">)</span>
		<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_reset</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">);</span>

	<span class="cm">/* to be sure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">sf</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">fonts</span><span class="p">;</span> <span class="n">sf</span><span class="p">;</span> <span class="n">sf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">zp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span><span class="p">;</span> <span class="n">zp</span><span class="p">;</span> <span class="n">zp</span> <span class="o">=</span> <span class="n">nextzp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zp</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&lt;</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_locked</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nextzp</span> <span class="o">=</span> <span class="n">zp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">sf</span><span class="o">-&gt;</span><span class="n">zones</span> <span class="o">=</span> <span class="n">nextzp</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">zp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">sp</span> <span class="o">=</span> <span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span><span class="p">;</span> <span class="n">sp</span><span class="p">;</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">nextsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&lt;</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_locked</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">nextsp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">sf</span><span class="o">-&gt;</span><span class="n">samples</span> <span class="o">=</span> <span class="n">nextsp</span><span class="p">;</span>
			<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">mem_used</span> <span class="o">-=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">.</span><span class="n">truesize</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_free</span><span class="p">)</span>
				<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">sample_free</span><span class="p">(</span><span class="n">sflist</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">.</span><span class="n">private_data</span><span class="p">,</span>
							     <span class="n">sp</span><span class="p">,</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">memhdr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_counter</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">zone_locked</span><span class="p">;</span>
	<span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_counter</span> <span class="o">=</span> <span class="n">sflist</span><span class="o">-&gt;</span><span class="n">sample_locked</span><span class="p">;</span>

	<span class="n">rebuild_presets</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>

	<span class="n">unlock_preset</span><span class="p">(</span><span class="n">sflist</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
