<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › via82xx_modem.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>via82xx_modem.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA modem driver for VIA VT82xx (South Bridge)</span>
<span class="cm"> *</span>
<span class="cm"> *   VT82C686A/B/C, VT8233A/C, VT8235</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2000 Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *	                   Tjeerd.Mulder &lt;Tjeerd.Mulder@fujitsu-siemens.com&gt;</span>
<span class="cm"> *                    2002 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *</span>
<span class="cm"> * Sep. 2,  2004  Sasha Khapyorsky &lt;sashak@alsa-project.org&gt;</span>
<span class="cm"> *      Modified from original audio driver &#39;via82xx.c&#39; to support AC97</span>
<span class="cm"> *      modems.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define POINTER_DEBUG</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIA VT82xx modem&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{VIA,VT82C686A/B/C modem,pci}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span> <span class="cm">/* Exclude the first card */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR1</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ac97_clock</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for VIA 82xx bridge.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for VIA 82xx bridge.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codec clock (default 48000Hz).&quot;</span><span class="p">);</span>

<span class="cm">/* just for backward compatibility */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> *  Direct registers</span>
<span class="cm"> */</span>

<span class="cp">#define VIAREG(via, x) ((via)-&gt;port + VIA_REG_##x)</span>
<span class="cp">#define VIADEV_REG(viadev, x) ((viadev)-&gt;port + VIA_REG_##x)</span>

<span class="cm">/* common offsets */</span>
<span class="cp">#define VIA_REG_OFFSET_STATUS		0x00	</span><span class="cm">/* byte - channel status */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_ACTIVE		0x80	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_PAUSED		0x40	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_TRIGGER_QUEUED	0x08	</span><span class="cm">/* RO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_STOPPED		0x04	</span><span class="cm">/* RWC */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_EOL		0x02	</span><span class="cm">/* RWC */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_STAT_FLAG		0x01	</span><span class="cm">/* RWC */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CONTROL		0x01	</span><span class="cm">/* byte - channel control */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_START		0x80	</span><span class="cm">/* WO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_TERMINATE	0x40	</span><span class="cm">/* WO */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_AUTOSTART	0x20</span>
<span class="cp">#define   VIA_REG_CTRL_PAUSE		0x08	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_INT_STOP		0x04		</span>
<span class="cp">#define   VIA_REG_CTRL_INT_EOL		0x02</span>
<span class="cp">#define   VIA_REG_CTRL_INT_FLAG		0x01</span>
<span class="cp">#define   VIA_REG_CTRL_RESET		0x01	</span><span class="cm">/* RW - probably reset? undocumented */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_CTRL_INT (VIA_REG_CTRL_INT_FLAG | VIA_REG_CTRL_INT_EOL | VIA_REG_CTRL_AUTOSTART)</span>
<span class="cp">#define VIA_REG_OFFSET_TYPE		0x02	</span><span class="cm">/* byte - channel type (686 only) */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_AUTOSTART	0x80	</span><span class="cm">/* RW - autostart at EOL */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_16BIT		0x20	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_STEREO		0x10	</span><span class="cm">/* RW */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_TYPE_INT_LLINE	0x00</span>
<span class="cp">#define   VIA_REG_TYPE_INT_LSAMPLE	0x04</span>
<span class="cp">#define   VIA_REG_TYPE_INT_LESSONE	0x08</span>
<span class="cp">#define   VIA_REG_TYPE_INT_MASK		0x0c</span>
<span class="cp">#define   VIA_REG_TYPE_INT_EOL		0x02</span>
<span class="cp">#define   VIA_REG_TYPE_INT_FLAG		0x01</span>
<span class="cp">#define VIA_REG_OFFSET_TABLE_PTR	0x04	</span><span class="cm">/* dword - channel table pointer */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CURR_PTR		0x04	</span><span class="cm">/* dword - channel current pointer */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_STOP_IDX		0x08	</span><span class="cm">/* dword - stop index, channel type, sample rate */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CURR_COUNT	0x0c	</span><span class="cm">/* dword - channel current count (24 bit) */</span><span class="cp"></span>
<span class="cp">#define VIA_REG_OFFSET_CURR_INDEX	0x0f	</span><span class="cm">/* byte - channel current index (for via8233 only) */</span><span class="cp"></span>

<span class="cp">#define DEFINE_VIA_REGSET(name,val) \</span>
<span class="cp">enum {\</span>
<span class="cp">	VIA_REG_##name##_STATUS		= (val),\</span>
<span class="cp">	VIA_REG_##name##_CONTROL	= (val) + 0x01,\</span>
<span class="cp">	VIA_REG_##name##_TYPE		= (val) + 0x02,\</span>
<span class="cp">	VIA_REG_##name##_TABLE_PTR	= (val) + 0x04,\</span>
<span class="cp">	VIA_REG_##name##_CURR_PTR	= (val) + 0x04,\</span>
<span class="cp">	VIA_REG_##name##_STOP_IDX	= (val) + 0x08,\</span>
<span class="cp">	VIA_REG_##name##_CURR_COUNT	= (val) + 0x0c,\</span>
<span class="cp">}</span>

<span class="cm">/* modem block */</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">MO</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="n">DEFINE_VIA_REGSET</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>

<span class="cm">/* AC&#39;97 */</span>
<span class="cp">#define VIA_REG_AC97			0x80	</span><span class="cm">/* dword */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_MASK	(3&lt;&lt;30)</span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_SHIFT	30</span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_PRIMARY	0x00</span>
<span class="cp">#define   VIA_REG_AC97_CODEC_ID_SECONDARY 0x01</span>
<span class="cp">#define   VIA_REG_AC97_SECONDARY_VALID	(1&lt;&lt;27)</span>
<span class="cp">#define   VIA_REG_AC97_PRIMARY_VALID	(1&lt;&lt;25)</span>
<span class="cp">#define   VIA_REG_AC97_BUSY		(1&lt;&lt;24)</span>
<span class="cp">#define   VIA_REG_AC97_READ		(1&lt;&lt;23)</span>
<span class="cp">#define   VIA_REG_AC97_CMD_SHIFT	16</span>
<span class="cp">#define   VIA_REG_AC97_CMD_MASK		0x7e</span>
<span class="cp">#define   VIA_REG_AC97_DATA_SHIFT	0</span>
<span class="cp">#define   VIA_REG_AC97_DATA_MASK	0xffff</span>

<span class="cp">#define VIA_REG_SGD_SHADOW		0x84	</span><span class="cm">/* dword */</span><span class="cp"></span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_FLAG	(1&lt;&lt;0)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_FLAG	(1&lt;&lt;1)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_FLAG	(1&lt;&lt;2)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_EOL	(1&lt;&lt;4)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_EOL	(1&lt;&lt;5)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_EOL	(1&lt;&lt;6)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_STOP	(1&lt;&lt;8)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_STOP	(1&lt;&lt;9)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_STOP	(1&lt;&lt;10)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_PB_ACTIVE	(1&lt;&lt;12)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_CP_ACTIVE	(1&lt;&lt;13)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_FM_ACTIVE	(1&lt;&lt;14)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MR_FLAG      (1&lt;&lt;16)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MW_FLAG      (1&lt;&lt;17)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MR_EOL       (1&lt;&lt;20)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MW_EOL       (1&lt;&lt;21)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MR_STOP      (1&lt;&lt;24)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MW_STOP      (1&lt;&lt;25)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MR_ACTIVE    (1&lt;&lt;28)</span>
<span class="cp">#define   VIA_REG_SGD_STAT_MW_ACTIVE    (1&lt;&lt;29)</span>

<span class="cp">#define VIA_REG_GPI_STATUS		0x88</span>
<span class="cp">#define VIA_REG_GPI_INTR		0x8c</span>

<span class="cp">#define VIA_TBL_BIT_FLAG	0x40000000</span>
<span class="cp">#define VIA_TBL_BIT_EOL		0x80000000</span>

<span class="cm">/* pci space */</span>
<span class="cp">#define VIA_ACLINK_STAT		0x40</span>
<span class="cp">#define  VIA_ACLINK_C11_READY	0x20</span>
<span class="cp">#define  VIA_ACLINK_C10_READY	0x10</span>
<span class="cp">#define  VIA_ACLINK_C01_READY	0x04 </span><span class="cm">/* secondary codec ready */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_LOWPOWER	0x02 </span><span class="cm">/* low-power state */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_C00_READY	0x01 </span><span class="cm">/* primary codec ready */</span><span class="cp"></span>
<span class="cp">#define VIA_ACLINK_CTRL		0x41</span>
<span class="cp">#define  VIA_ACLINK_CTRL_ENABLE	0x80 </span><span class="cm">/* 0: disable, 1: enable */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_RESET	0x40 </span><span class="cm">/* 0: assert, 1: de-assert */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_SYNC	0x20 </span><span class="cm">/* 0: release SYNC, 1: force SYNC hi */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_SDO	0x10 </span><span class="cm">/* 0: release SDO, 1: force SDO hi */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_VRA	0x08 </span><span class="cm">/* 0: disable VRA, 1: enable VRA */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_PCM	0x04 </span><span class="cm">/* 0: disable PCM, 1: enable PCM */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_FM	0x02 </span><span class="cm">/* via686 only */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_SB	0x01 </span><span class="cm">/* via686 only */</span><span class="cp"></span>
<span class="cp">#define  VIA_ACLINK_CTRL_INIT	(VIA_ACLINK_CTRL_ENABLE|\</span>
<span class="cp">				 VIA_ACLINK_CTRL_RESET|\</span>
<span class="cp">				 VIA_ACLINK_CTRL_PCM)</span>
<span class="cp">#define VIA_FUNC_ENABLE		0x42</span>
<span class="cp">#define  VIA_FUNC_MIDI_PNP	0x80 </span><span class="cm">/* FIXME: it&#39;s 0x40 in the datasheet! */</span><span class="cp"></span>
<span class="cp">#define  VIA_FUNC_MIDI_IRQMASK	0x40 </span><span class="cm">/* FIXME: not documented! */</span><span class="cp"></span>
<span class="cp">#define  VIA_FUNC_RX2C_WRITE	0x20</span>
<span class="cp">#define  VIA_FUNC_SB_FIFO_EMPTY	0x10</span>
<span class="cp">#define  VIA_FUNC_ENABLE_GAME	0x08</span>
<span class="cp">#define  VIA_FUNC_ENABLE_FM	0x04</span>
<span class="cp">#define  VIA_FUNC_ENABLE_MIDI	0x02</span>
<span class="cp">#define  VIA_FUNC_ENABLE_SB	0x01</span>
<span class="cp">#define VIA_PNP_CONTROL		0x43</span>
<span class="cp">#define VIA_MC97_CTRL		0x44</span>
<span class="cp">#define  VIA_MC97_CTRL_ENABLE   0x80</span>
<span class="cp">#define  VIA_MC97_CTRL_SECONDARY 0x40</span>
<span class="cp">#define  VIA_MC97_CTRL_INIT     (VIA_MC97_CTRL_ENABLE|\</span>
<span class="cp">                                 VIA_MC97_CTRL_SECONDARY)</span>


<span class="cm">/*</span>
<span class="cm"> * pcm stream</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">snd_via_sg_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span> <span class="p">;</span>

<span class="cp">#define VIA_TABLE_SIZE	255</span>

<span class="k">struct</span> <span class="n">viadev</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">direction</span><span class="p">;</span>	<span class="cm">/* playback = 0, capture = 1 */</span>
        <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tbl_entries</span><span class="p">;</span> <span class="cm">/* # descriptors */</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_via_sg_table</span> <span class="o">*</span><span class="n">idx_table</span><span class="p">;</span>
	<span class="cm">/* for recovery from the unexpected pointer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lastpos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsize2</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">TYPE_CARD_VIA82XX_MODEM</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>

<span class="cp">#define VIA_MAX_MODEM_DEVS	2</span>

<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intr_mask</span><span class="p">;</span> <span class="cm">/* SGD_SHADOW mask to check interrupts */</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_devs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">playback_devno</span><span class="p">,</span> <span class="n">capture_devno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="n">devs</span><span class="p">[</span><span class="n">VIA_MAX_MODEM_DEVS</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcms</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_secondary</span><span class="p">;</span>	<span class="cm">/* secondary AC&#39;97 codec is present */</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">proc_entry</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_via82xx_modem_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">VIA</span><span class="p">,</span> <span class="mh">0x3068</span><span class="p">),</span> <span class="n">TYPE_CARD_VIA82XX_MODEM</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_via82xx_modem_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * allocate and initialize the descriptor buffers</span>
<span class="cm"> * periods = number of periods</span>
<span class="cm"> * fragsize = period size in bytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_via_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">periods</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">rest</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the start of each lists must be aligned to 8 bytes,</span>
<span class="cm">		 * but the kernel pages are much bigger, so we don&#39;t care</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					<span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">VIA_TABLE_SIZE</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">)</span> <span class="o">*</span> <span class="n">VIA_TABLE_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill the entries */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">periods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rest</span> <span class="o">=</span> <span class="n">fragsize</span><span class="p">;</span>
		<span class="cm">/* fill descriptors for a period.</span>
<span class="cm">		 * a period can be split to several descriptors if it&#39;s</span>
<span class="cm">		 * over page boundary.</span>
<span class="cm">		 */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">VIA_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via82xx: too much table size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ofs</span><span class="p">);</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span><span class="p">)[</span><span class="n">idx</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="p">(</span><span class="n">ofs</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&lt;</span> <span class="n">r</span><span class="p">)</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">rest</span><span class="p">;</span>
			<span class="n">rest</span> <span class="o">-=</span> <span class="n">r</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">rest</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">VIA_TBL_BIT_EOL</span><span class="p">;</span> <span class="cm">/* buffer boundary */</span>
				<span class="k">else</span>
					<span class="n">flag</span> <span class="o">=</span> <span class="n">VIA_TBL_BIT_FLAG</span><span class="p">;</span> <span class="cm">/* period boundary */</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* period continues to the next */</span>
			<span class="cm">/*</span>
<span class="cm">			printk(KERN_DEBUG &quot;via: tbl %d: at %d  size %d &quot;</span>
<span class="cm">			       &quot;(rest %d)\n&quot;, idx, ofs, r, rest);</span>
<span class="cm">			*/</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span><span class="p">)[(</span><span class="n">idx</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">r</span> <span class="o">|</span> <span class="n">flag</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">ofs</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">ofs</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">periods</span> <span class="o">*</span> <span class="n">fragsize</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bufsize2</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">clean_via_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">idx_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Basic I/O</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_via82xx_codec_xread</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">AC97</span><span class="p">));</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_codec_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1ms */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_AC97_BUSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_ready: codec %i is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">secondary</span><span class="p">,</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_codec_valid</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* 1ms */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">val1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="o">!</span><span class="n">secondary</span> <span class="o">?</span> <span class="n">VIA_REG_AC97_PRIMARY_VALID</span> <span class="o">:</span>
					 <span class="n">VIA_REG_AC97_SECONDARY_VALID</span><span class="p">;</span>
	
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VIA_REG_AC97_BUSY</span> <span class="o">|</span> <span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">==</span> <span class="n">stat</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_codec_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
	<span class="cm">/* here we need to wait fairly for long time.. */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xval</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AC97_GPIO_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GPI_STATUS</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>	
	<span class="n">xval</span> <span class="o">=</span> <span class="o">!</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">?</span> <span class="n">VIA_REG_AC97_CODEC_ID_PRIMARY</span> <span class="o">:</span> <span class="n">VIA_REG_AC97_CODEC_ID_SECONDARY</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">&lt;&lt;=</span> <span class="n">VIA_REG_AC97_CODEC_ID_SHIFT</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CMD_SHIFT</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_DATA_SHIFT</span><span class="p">;</span>
	<span class="n">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">xval</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_via82xx_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xval</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">again</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">xval</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CODEC_ID_SHIFT</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">?</span> <span class="n">VIA_REG_AC97_SECONDARY_VALID</span> <span class="o">:</span> <span class="n">VIA_REG_AC97_PRIMARY_VALID</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="n">VIA_REG_AC97_READ</span><span class="p">;</span>
	<span class="n">xval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CMD_SHIFT</span><span class="p">;</span>
      	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      		<span class="k">if</span> <span class="p">(</span><span class="n">again</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_read: codec %i is not valid [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
		      	<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">xval</span><span class="p">);</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_via82xx_codec_valid</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_channel_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VIA_REG_CTRL_PAUSE</span> <span class="o">|</span> <span class="n">VIA_REG_CTRL_TERMINATE</span> <span class="o">|</span> <span class="n">VIA_REG_CTRL_RESET</span><span class="p">,</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="cm">/* clear interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_TYPE</span><span class="p">));</span> <span class="cm">/* for via686 */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>outl(0, VIADEV<em>REG(viadev, OFFSET</em>CURR_PTR));</p></td><td class="code"><div class="highlight"><pre>	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_via82xx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SGD_SHADOW</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p><em>skip</em>sgd:</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* check status for each stream */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c_status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span>
		<span class="n">c_status</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">VIA_REG_STAT_EOL</span><span class="o">|</span><span class="n">VIA_REG_STAT_FLAG</span><span class="o">|</span><span class="n">VIA_REG_STAT_STOPPED</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">c_status</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">c_status</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">));</span> <span class="cm">/* ack */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM callbacks</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * trigger callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VIA_REG_CTRL_START</span><span class="p">;</span>
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">VIA_REG_CTRL_TERMINATE</span><span class="p">;</span>
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VIA_REG_CTRL_PAUSE</span><span class="p">;</span>
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CONTROL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pointer callbacks</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * calculate the linear position at the given sg-buffer index and the rest count</span>
<span class="cm"> */</span>

<span class="cp">#define check_invalid_pos(viadev,pos) \</span>
<span class="cp">	((pos) &lt; viadev-&gt;lastpos &amp;&amp; ((pos) &gt;= viadev-&gt;bufsize2 ||\</span>
<span class="cp">				     viadev-&gt;lastpos &lt; viadev-&gt;bufsize2))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">calc_linear_pos</span><span class="p">(</span><span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* check the validity of the calculated position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid via82xx_cur_ptr (size = %d, count = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">check_invalid_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef POINTER_DEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;fail: idx = %i/%i, lastpos = 0x%x, &quot;</span>
		       <span class="s">&quot;bufsize2 = 0x%x, offsize = 0x%x, size = 0x%x, &quot;</span>
		       <span class="s">&quot;count = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">,</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">,</span>
		       <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize2</span><span class="p">,</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span><span class="p">,</span>
		       <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid via82xx_cur_ptr, &quot;</span>
				   <span class="s">&quot;using last valid pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">count</span><span class="p">)</span>
				<span class="cm">/* bogus count 0 on the DMA boundary? */</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* count register returns full size</span>
<span class="cm">				 * when end of buffer is reached</span>
<span class="cm">				 */</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">idx_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">offset</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">check_invalid_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid via82xx_cur_ptr (2), &quot;</span>
					   <span class="s">&quot;using last valid pointer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">lastpos</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span> <span class="cm">/* remember the last position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">-=</span> <span class="n">viadev</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get the current pointer on via686</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_via686_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_STATUS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_STAT_ACTIVE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CURR_COUNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="cm">/* The via686a does not have the current index register,</span>
<span class="cm">	 * so we need to calculate the index from CURR_PTR.</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_CURR_PTR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="cm">/* CURR_PTR holds the address + 8 */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">ptr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
			<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">tbl_entries</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">calc_linear_pos</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hw_params callback:</span>
<span class="cm"> * allocate the buffer and build up the buffer description table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">build_via_table</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>
			      <span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
			      <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE1_RATE</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="n">snd_ac97_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_LINE1_LEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * hw_free callback:</span>
<span class="cm"> * clean up the buffer description table and release the buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">clean_via_table</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * set up the table pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">viadev</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_TABLE_PTR</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * prepare callback for playback and capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="cm">/* this must be set after channel_reset */</span>
	<span class="n">snd_via82xx_set_table_ptr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VIA_REG_TYPE_AUTOSTART</span><span class="o">|</span><span class="n">VIA_REG_TYPE_INT_EOL</span><span class="o">|</span><span class="n">VIA_REG_TYPE_INT_FLAG</span><span class="p">,</span>
	     <span class="n">VIADEV_REG</span><span class="p">(</span><span class="n">viadev</span><span class="p">,</span> <span class="n">OFFSET_TYPE</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pcm hardware definition, identical for both playback and capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_via82xx_hw</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="cm">/* SNDRV_PCM_INFO_RESUME | */</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_8000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_16000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">16000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="n">VIA_TABLE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * open callback skeleton</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_modem_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8000</span><span class="p">,</span>  <span class="mi">9600</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">16000</span> <span class="p">};</span>
        <span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_rates</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
                <span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
                <span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">};</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_via82xx_hw</span><span class="p">;</span>
	
        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">hw_constraints_rates</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* we may remove following constaint when we modify table entries</span>
<span class="cm">	   in interrupt */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">viadev</span><span class="p">;</span>
	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * open callback for playback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">+</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">snd_via82xx_modem_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * open callback for capture</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">+</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">snd_via82xx_modem_pcm_open</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">viadev</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * close callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">viadev</span> <span class="o">*</span><span class="n">viadev</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">viadev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* via686 playback callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via686_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via82xx_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via686_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* via686 capture callbacks */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_via686_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_via82xx_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_via82xx_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_via686_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>		<span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_viadev</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_offset</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">reg_offset</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">port</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * create a pcm instance for via686a/b</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via686_pcm_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_devno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_devno</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intr_mask</span> <span class="o">=</span> <span class="mh">0x330000</span><span class="p">;</span> <span class="cm">/* FLAGS | EOL for MR, MW */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via686_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_via686_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">SNDRV_PCM_CLASS_MODEM</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VIA_REG_MO_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_viadev</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">VIA_REG_MI_STATUS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
							 <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
							 <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Mixer part</span>
<span class="cm"> */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_mixer_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wait</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_wait</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_via82xx_mixer_free_ac97_bus</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_clock</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_via82xx_mixer_free_ac97</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_SKIP_AUDIO</span> <span class="o">|</span> <span class="n">AC97_SCAP_POWER_SAVE</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * proc interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_via82xx_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0xa0</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%02x: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;via82xx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_via82xx_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pval</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_MC97_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_MC97_CTRL_INIT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VIA_MC97_CTRL_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">pval</span><span class="o">|</span><span class="n">VIA_MC97_CTRL_INIT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_ACLINK_C00_READY</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* codec not ready? */</span>
		<span class="cm">/* deassert ACLink reset, force SYNC */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span>
				      <span class="n">VIA_ACLINK_CTRL_ENABLE</span> <span class="o">|</span>
				      <span class="n">VIA_ACLINK_CTRL_RESET</span> <span class="o">|</span>
				      <span class="n">VIA_ACLINK_CTRL_SYNC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="cp">#if 1 </span><span class="cm">/* FIXME: should we do full reset here for all chip models? */</span><span class="cp"></span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="cm">/* deassert ACLink reset, force SYNC (warm AC&#39;97 reset) */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span>
				      <span class="n">VIA_ACLINK_CTRL_RESET</span><span class="o">|</span><span class="n">VIA_ACLINK_CTRL_SYNC</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="cm">/* ACLink on, deassert ACLink reset, VSR, SGD data out */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ACLink on, deassert ACLink reset, VSR, SGD data out */</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL</span><span class="p">,</span> <span class="n">VIA_ACLINK_CTRL_INIT</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait until codec ready */</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">VIA_ACLINK_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pval</span> <span class="o">&amp;</span> <span class="n">VIA_ACLINK_C00_READY</span><span class="p">)</span> <span class="cm">/* primary codec ready */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_AC97_BUSY</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 codec is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">VIA_REG_AC97_READ</span> <span class="o">|</span>
				 <span class="n">VIA_REG_AC97_SECONDARY_VALID</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">VIA_REG_AC97_CODEC_ID_SECONDARY</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CODEC_ID_SHIFT</span><span class="p">));</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="n">snd_via82xx_codec_xwrite</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">VIA_REG_AC97_READ</span> <span class="o">|</span>
				 <span class="n">VIA_REG_AC97_SECONDARY_VALID</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">VIA_REG_AC97_CODEC_ID_SECONDARY</span> <span class="o">&lt;&lt;</span> <span class="n">VIA_REG_AC97_CODEC_ID_SHIFT</span><span class="p">));</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">snd_via82xx_codec_xread</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VIA_REG_AC97_SECONDARY_VALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_secondary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__ac97_ok2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>
	<span class="cm">/* This is ok, the most of motherboards have only one codec */</span>

      <span class="nl">__ac97_ok2:</span>

	<span class="cm">/* route FM trap to IRQ, disable FM trap */</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>pci<em>write</em>config<em>byte(chip->pci, VIA</em>FM<em>NMI</em>CTRL, 0);</p></td><td class="code"><div class="highlight"><pre>	<span class="cm">/* disable all GPI interrupts */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VIAREG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GPI_INTR</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * power management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via82xx-modem: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_via82xx_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end_hw</span><span class="p">;</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

      <span class="nl">__end_hw:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_via82xx_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">chip_type</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">revision</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">**</span> <span class="n">r_via</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
        <span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_via82xx_dev_free</span><span class="p">,</span>
        <span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_via82xx_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_clock</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">&amp;&amp;</span> <span class="n">ac97_clock</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_clock</span> <span class="o">=</span> <span class="n">ac97_clock</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_via82xx_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The 8233 ac97 controller does not implement the master bit</span>
<span class="cm">	 * in the pci command register. IMHO this is a violation of the PCI spec.</span>
<span class="cm">	 * We call pci_set_master here because it does not hurt. */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">r_via</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_via82xx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">via82xx_modem</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">card_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">card_type</span> <span class="o">=</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">card_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TYPE_CARD_VIA82XX_MODEM</span>:
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;VIA82XX-MODEM&quot;</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;VIA 82XX modem&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;invalid card type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card_type</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">chip_type</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
				      <span class="n">ac97_clock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via82xx_mixer_new</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_via686_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">num_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_via82xx_channel_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">devs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">snd_via82xx_proc_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">__error:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_via82xx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">via82xx_modem_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_via82xx_modem_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_via82xx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_via82xx_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">snd_via82xx_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">snd_via82xx_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">via82xx_modem_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
