<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › korg1212 › korg1212.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>korg1212.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Driver for the Korg 1212 IO PCI card</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2001 Haroldo Gamal &lt;gamal@alternex.com.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><hr />

<h2>Debug Stuff</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define K1212_DEBUG_LEVEL		0</span>
<span class="cp">#if K1212_DEBUG_LEVEL &gt; 0</span>
<span class="cp">#define K1212_DEBUG_PRINTK(fmt,args...)	printk(KERN_DEBUG fmt,##args)</span>
<span class="cp">#else</span>
<span class="cp">#define K1212_DEBUG_PRINTK(fmt,...)</span>
<span class="cp">#endif</span>
<span class="cp">#if K1212_DEBUG_LEVEL &gt; 1</span>
<span class="cp">#define K1212_DEBUG_PRINTK_VERBOSE(fmt,args...)	printk(KERN_DEBUG fmt,##args)</span>
<span class="cp">#else</span>
<span class="cp">#define K1212_DEBUG_PRINTK_VERBOSE(fmt,...)</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><hr />

<p>Record/Play Buffer Allocation Method. If K1212_LARGEALLOC is defined all </p>

<h2>buffers are alocated as a large piece inside KorgSharedBuffer.</h2>

<h1>define K1212_LARGEALLOC        1</h1></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><hr />

<h2>Valid states of the Korg 1212 I/O card.</h2></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="n">CardState</span> <span class="p">{</span>
   <span class="n">K1212_STATE_NONEXISTENT</span><span class="p">,</span>		<span class="c1">// there is no card here</span>
   <span class="n">K1212_STATE_UNINITIALIZED</span><span class="p">,</span>		<span class="c1">// the card is awaiting DSP download</span>
   <span class="n">K1212_STATE_DSP_IN_PROCESS</span><span class="p">,</span>		<span class="c1">// the card is currently downloading its DSP code</span>
   <span class="n">K1212_STATE_DSP_COMPLETE</span><span class="p">,</span>		<span class="c1">// the card has finished the DSP download</span>
   <span class="n">K1212_STATE_READY</span><span class="p">,</span>			<span class="c1">// the card can be opened by an application.  Any application</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>requests prior to this state should fail.  Only an open
   request can be made at this state.</p></td><td class="code"><div class="highlight"><pre>   <span class="n">K1212_STATE_OPEN</span><span class="p">,</span>			<span class="c1">// an application has opened the card</span>
   <span class="n">K1212_STATE_SETUP</span><span class="p">,</span>			<span class="c1">// the card has been setup for play</span>
   <span class="n">K1212_STATE_PLAYING</span><span class="p">,</span>			<span class="c1">// the card is playing</span>
   <span class="n">K1212_STATE_MONITOR</span><span class="p">,</span>			<span class="c1">// the card is in the monitor mode</span>
   <span class="n">K1212_STATE_CALIBRATING</span><span class="p">,</span>		<span class="c1">// the card is currently calibrating</span>
   <span class="n">K1212_STATE_ERRORSTOP</span><span class="p">,</span>		<span class="c1">// the card has stopped itself because of an error and we</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>are in the process of cleaning things up.</p></td><td class="code"><div class="highlight"><pre>   <span class="n">K1212_STATE_MAX_STATE</span>		<span class="c1">// state values of this and beyond are invalid</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><hr />

<p>The following enumeration defines the constants written to the card's</p>

<h2>host-to-card doorbell to initiate a command.</h2></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="n">korg1212_dbcnst</span> <span class="p">{</span>
   <span class="n">K1212_DB_RequestForData</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1">// sent by the card to request a buffer fill.</span>
   <span class="n">K1212_DB_TriggerPlay</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>    <span class="c1">// starts playback/record on the card.</span>
   <span class="n">K1212_DB_SelectPlayMode</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>    <span class="c1">// select monitor, playback setup, or stop.</span>
   <span class="n">K1212_DB_ConfigureBufferMemory</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>    <span class="c1">// tells card where the host audio buffers are.</span>
   <span class="n">K1212_DB_RequestAdatTimecode</span>   <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>    <span class="c1">// asks the card for the latest ADAT timecode value.</span>
   <span class="n">K1212_DB_SetClockSourceRate</span>    <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>    <span class="c1">// sets the clock source and rate for the card.</span>
   <span class="n">K1212_DB_ConfigureMiscMemory</span>   <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>    <span class="c1">// tells card where other buffers are.</span>
   <span class="n">K1212_DB_TriggerFromAdat</span>       <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>    <span class="c1">// tells card to trigger from Adat at a specific</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>timecode value.</p></td><td class="code"><div class="highlight"><pre>   <span class="n">K1212_DB_DMAERROR</span>              <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="c1">// DMA Error - the PCI bus is congestioned.</span>
   <span class="n">K1212_DB_CARDSTOPPED</span>           <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span> <span class="c1">// Card has stopped by user request.</span>
   <span class="n">K1212_DB_RebootCard</span>            <span class="o">=</span> <span class="mh">0xA0</span><span class="p">,</span> <span class="c1">// instructs the card to reboot.</span>
   <span class="n">K1212_DB_BootFromDSPPage4</span>      <span class="o">=</span> <span class="mh">0xA4</span><span class="p">,</span> <span class="c1">// instructs the card to boot from the DSP microcode</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>on page 4 (local page to card).</p></td><td class="code"><div class="highlight"><pre>   <span class="n">K1212_DB_DSPDownloadDone</span>       <span class="o">=</span> <span class="mh">0xAE</span><span class="p">,</span> <span class="c1">// sent by the card to indicate the download has</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>completed.</p></td><td class="code"><div class="highlight"><pre>   <span class="n">K1212_DB_StartDSPDownload</span>      <span class="o">=</span> <span class="mh">0xAF</span>  <span class="c1">// tells the card to download its DSP firmware.</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><hr />

<p>The following enumeration defines return codes </p>

<h2>to the Korg 1212 I/O driver.</h2></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="n">snd_korg1212rc</span> <span class="p">{</span>
   <span class="n">K1212_CMDRET_Success</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>   <span class="c1">// command was successfully placed</span>
   <span class="n">K1212_CMDRET_DIOCFailure</span><span class="p">,</span>           <span class="c1">// the DeviceIoControl call failed</span>
   <span class="n">K1212_CMDRET_PMFailure</span><span class="p">,</span>             <span class="c1">// the protected mode call failed</span>
   <span class="n">K1212_CMDRET_FailUnspecified</span><span class="p">,</span>       <span class="c1">// unspecified failure</span>
   <span class="n">K1212_CMDRET_FailBadState</span><span class="p">,</span>          <span class="c1">// the specified command can not be given in</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>the card's current state. (or the wave device's
   state)</p></td><td class="code"><div class="highlight"><pre>   <span class="n">K1212_CMDRET_CardUninitialized</span><span class="p">,</span>     <span class="c1">// the card is uninitialized and cannot be used</span>
   <span class="n">K1212_CMDRET_BadIndex</span><span class="p">,</span>              <span class="c1">// an out of range card index was specified</span>
   <span class="n">K1212_CMDRET_BadHandle</span><span class="p">,</span>             <span class="c1">// an invalid card handle was specified</span>
   <span class="n">K1212_CMDRET_NoFillRoutine</span><span class="p">,</span>         <span class="c1">// a play request has been made before a fill routine set</span>
   <span class="n">K1212_CMDRET_FillRoutineInUse</span><span class="p">,</span>      <span class="c1">// can&#39;t set a new fill routine while one is in use</span>
   <span class="n">K1212_CMDRET_NoAckFromCard</span><span class="p">,</span>         <span class="c1">// the card never acknowledged a command</span>
   <span class="n">K1212_CMDRET_BadParams</span><span class="p">,</span>             <span class="c1">// bad parameters were provided by the caller</span>

   <span class="n">K1212_CMDRET_BadDevice</span><span class="p">,</span>             <span class="c1">// the specified wave device was out of range</span>
   <span class="n">K1212_CMDRET_BadFormat</span>              <span class="c1">// the specified wave format is unsupported</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><hr />

<p>The following enumeration defines the constants used to select the play</p>

<h2>mode for the card in the SelectPlayMode command.</h2></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="n">PlayModeSelector</span> <span class="p">{</span>
   <span class="n">K1212_MODE_SetupPlay</span>  <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span>     <span class="c1">// provides card with pre-play information</span>
   <span class="n">K1212_MODE_MonitorOn</span>  <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span>     <span class="c1">// tells card to turn on monitor mode</span>
   <span class="n">K1212_MODE_MonitorOff</span> <span class="o">=</span> <span class="mh">0x00000004</span><span class="p">,</span>     <span class="c1">// tells card to turn off monitor mode</span>
   <span class="n">K1212_MODE_StopPlay</span>   <span class="o">=</span> <span class="mh">0x00000008</span>      <span class="c1">// stops playback on the card</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><hr />

<p>The following enumeration defines the constants used to select the monitor</p>

<h2>mode for the card in the SetMonitorMode command.</h2></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="n">MonitorModeSelector</span> <span class="p">{</span>
   <span class="n">K1212_MONMODE_Off</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>     <span class="c1">// tells card to turn off monitor mode</span>
   <span class="n">K1212_MONMODE_On</span>            <span class="c1">// tells card to turn on monitor mode</span>
<span class="p">};</span>

<span class="cp">#define MAILBOX0_OFFSET      0x40	</span><span class="c1">// location of mailbox 0 relative to base address</span>
<span class="cp">#define MAILBOX1_OFFSET      0x44	</span><span class="c1">// location of mailbox 1 relative to base address</span>
<span class="cp">#define MAILBOX2_OFFSET      0x48	</span><span class="c1">// location of mailbox 2 relative to base address</span>
<span class="cp">#define MAILBOX3_OFFSET      0x4c	</span><span class="c1">// location of mailbox 3 relative to base address</span>
<span class="cp">#define OUT_DOORBELL_OFFSET  0x60	</span><span class="c1">// location of PCI to local doorbell</span>
<span class="cp">#define IN_DOORBELL_OFFSET   0x64	</span><span class="c1">// location of local to PCI doorbell</span>
<span class="cp">#define STATUS_REG_OFFSET    0x68	</span><span class="c1">// location of interrupt control/status register</span>
<span class="cp">#define PCI_CONTROL_OFFSET   0x6c	</span><span class="c1">// location of the EEPROM, PCI, User I/O, init control</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>register</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define SENS_CONTROL_OFFSET  0x6e	</span><span class="c1">// location of the input sensitivity setting register.</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>this is the upper word of the PCI control reg.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DEV_VEND_ID_OFFSET   0x70	</span><span class="c1">// location of the device and vendor ID register</span>

<span class="cp">#define MAX_COMMAND_RETRIES  5         </span><span class="c1">// maximum number of times the driver will attempt</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>to send a command before giving up.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define COMMAND_ACK_MASK     0x8000    </span><span class="c1">// the MSB is set in the command acknowledgment from</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>the card.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define DOORBELL_VAL_MASK    0x00FF    </span><span class="c1">// the doorbell value is one byte</span>

<span class="cp">#define CARD_BOOT_DELAY_IN_MS  10</span>
<span class="cp">#define CARD_BOOT_TIMEOUT      10</span>
<span class="cp">#define DSP_BOOT_DELAY_IN_MS   200</span>

<span class="cp">#define kNumBuffers		8</span>
<span class="cp">#define k1212MaxCards		4</span>
<span class="cp">#define k1212NumWaveDevices	6</span>
<span class="cp">#define k16BitChannels		10</span>
<span class="cp">#define k32BitChannels		2</span>
<span class="cp">#define kAudioChannels		(k16BitChannels + k32BitChannels)</span>
<span class="cp">#define kPlayBufferFrames	1024</span>

<span class="cp">#define K1212_ANALOG_CHANNELS	2</span>
<span class="cp">#define K1212_SPDIF_CHANNELS	2</span>
<span class="cp">#define K1212_ADAT_CHANNELS	8</span>
<span class="cp">#define K1212_CHANNELS		(K1212_ADAT_CHANNELS + K1212_ANALOG_CHANNELS)</span>
<span class="cp">#define K1212_MIN_CHANNELS	1</span>
<span class="cp">#define K1212_MAX_CHANNELS	K1212_CHANNELS</span>
<span class="cp">#define K1212_FRAME_SIZE        (sizeof(struct KorgAudioFrame))</span>
<span class="cp">#define K1212_MAX_SAMPLES	(kPlayBufferFrames*kNumBuffers)</span>
<span class="cp">#define K1212_PERIODS		(kNumBuffers)</span>
<span class="cp">#define K1212_PERIOD_BYTES	(K1212_FRAME_SIZE*kPlayBufferFrames)</span>
<span class="cp">#define K1212_BUF_SIZE          (K1212_PERIOD_BYTES*kNumBuffers)</span>
<span class="cp">#define K1212_ANALOG_BUF_SIZE	(K1212_ANALOG_CHANNELS * 2 * kPlayBufferFrames * kNumBuffers)</span>
<span class="cp">#define K1212_SPDIF_BUF_SIZE	(K1212_SPDIF_CHANNELS * 3 * kPlayBufferFrames * kNumBuffers)</span>
<span class="cp">#define K1212_ADAT_BUF_SIZE	(K1212_ADAT_CHANNELS * 2 * kPlayBufferFrames * kNumBuffers)</span>
<span class="cp">#define K1212_MAX_BUF_SIZE	(K1212_ANALOG_BUF_SIZE + K1212_ADAT_BUF_SIZE)</span>

<span class="cp">#define k1212MinADCSens     0x7f</span>
<span class="cp">#define k1212MaxADCSens     0x00</span>
<span class="cp">#define k1212MaxVolume      0x7fff</span>
<span class="cp">#define k1212MaxWaveVolume  0xffff</span>
<span class="cp">#define k1212MinVolume      0x0000</span>
<span class="cp">#define k1212MaxVolInverted 0x8000</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><hr />

<p>the following bits are used for controlling interrupts in the</p>

<h2>interrupt control/status reg</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define  PCI_INT_ENABLE_BIT               0x00000100</span>
<span class="cp">#define  PCI_DOORBELL_INT_ENABLE_BIT      0x00000200</span>
<span class="cp">#define  LOCAL_INT_ENABLE_BIT             0x00010000</span>
<span class="cp">#define  LOCAL_DOORBELL_INT_ENABLE_BIT    0x00020000</span>
<span class="cp">#define  LOCAL_DMA1_INT_ENABLE_BIT        0x00080000</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><hr />

<h2>the following bits are defined for the PCI command register</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define  PCI_CMD_MEM_SPACE_ENABLE_BIT     0x0002</span>
<span class="cp">#define  PCI_CMD_IO_SPACE_ENABLE_BIT      0x0001</span>
<span class="cp">#define  PCI_CMD_BUS_MASTER_ENABLE_BIT    0x0004</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><hr />

<h2>the following bits are defined for the PCI status register</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define  PCI_STAT_PARITY_ERROR_BIT        0x8000</span>
<span class="cp">#define  PCI_STAT_SYSTEM_ERROR_BIT        0x4000</span>
<span class="cp">#define  PCI_STAT_MASTER_ABORT_RCVD_BIT   0x2000</span>
<span class="cp">#define  PCI_STAT_TARGET_ABORT_RCVD_BIT   0x1000</span>
<span class="cp">#define  PCI_STAT_TARGET_ABORT_SENT_BIT   0x0800</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><hr />

<p>the following constants are used in setting the 1212 I/O card's input</p>

<h2>sensitivity.</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define  SET_SENS_LOCALINIT_BITPOS        15</span>
<span class="cp">#define  SET_SENS_DATA_BITPOS             10</span>
<span class="cp">#define  SET_SENS_CLOCK_BITPOS            8</span>
<span class="cp">#define  SET_SENS_LOADSHIFT_BITPOS        0</span>

<span class="cp">#define  SET_SENS_LEFTCHANID              0x00</span>
<span class="cp">#define  SET_SENS_RIGHTCHANID             0x01</span>

<span class="cp">#define  K1212SENSUPDATE_DELAY_IN_MS      50</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><hr />

<p>WaitRTCTicks</p>

<p>This function waits the specified number of real time clock ticks.
   According to the DDK, each tick is ~0.8 microseconds.
   The defines following the function declaration can be used for the</p>

<h2>   numTicksToWait parameter.</h2></td><td class="code"><div class="highlight"><pre><span class="cp">#define ONE_RTC_TICK         1</span>
<span class="cp">#define SENSCLKPULSE_WIDTH   4</span>
<span class="cp">#define LOADSHIFT_DELAY      4</span>
<span class="cp">#define INTERCOMMAND_DELAY  40</span>
<span class="cp">#define STOPCARD_DELAY      300        </span><span class="c1">// max # RTC ticks for the card to stop once we write</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>the command register.  (could be up to 180 us)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define COMMAND_ACK_DELAY   13         </span><span class="c1">// number of RTC ticks to wait for an acknowledgement</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>from the card after sending a command.</p></td><td class="code"><div class="highlight"><pre><span class="k">enum</span> <span class="n">ClockSourceIndex</span> <span class="p">{</span>
   <span class="n">K1212_CLKIDX_AdatAt44_1K</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1">// selects source as ADAT at 44.1 kHz</span>
   <span class="n">K1212_CLKIDX_AdatAt48K</span><span class="p">,</span>          <span class="c1">// selects source as ADAT at 48 kHz</span>
   <span class="n">K1212_CLKIDX_WordAt44_1K</span><span class="p">,</span>        <span class="c1">// selects source as S/PDIF at 44.1 kHz</span>
   <span class="n">K1212_CLKIDX_WordAt48K</span><span class="p">,</span>          <span class="c1">// selects source as S/PDIF at 48 kHz</span>
   <span class="n">K1212_CLKIDX_LocalAt44_1K</span><span class="p">,</span>       <span class="c1">// selects source as local clock at 44.1 kHz</span>
   <span class="n">K1212_CLKIDX_LocalAt48K</span><span class="p">,</span>         <span class="c1">// selects source as local clock at 48 kHz</span>
   <span class="n">K1212_CLKIDX_Invalid</span>             <span class="c1">// used to check validity of the index</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ClockSourceType</span> <span class="p">{</span>
   <span class="n">K1212_CLKIDX_Adat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1">// selects source as ADAT</span>
   <span class="n">K1212_CLKIDX_Word</span><span class="p">,</span>        <span class="c1">// selects source as S/PDIF</span>
   <span class="n">K1212_CLKIDX_Local</span>        <span class="c1">// selects source as local clock</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">KorgAudioFrame</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">frameData16</span><span class="p">[</span><span class="n">k16BitChannels</span><span class="p">];</span> <span class="cm">/* channels 0-9 use 16 bit samples */</span>
	<span class="n">u32</span> <span class="n">frameData32</span><span class="p">[</span><span class="n">k32BitChannels</span><span class="p">];</span> <span class="cm">/* channels 10-11 use 32 bits - only 20 are sent across S/PDIF */</span>
	<span class="n">u32</span> <span class="n">timeCodeVal</span><span class="p">;</span> <span class="cm">/* holds the ADAT timecode value */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">KorgAudioBuffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">KorgAudioFrame</span>  <span class="n">bufferData</span><span class="p">[</span><span class="n">kPlayBufferFrames</span><span class="p">];</span>     <span class="cm">/* buffer definition */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">KorgSharedBuffer</span> <span class="p">{</span>
<span class="cp">#ifdef K1212_LARGEALLOC</span>
   <span class="k">struct</span> <span class="n">KorgAudioBuffer</span>   <span class="n">playDataBufs</span><span class="p">[</span><span class="n">kNumBuffers</span><span class="p">];</span>
   <span class="k">struct</span> <span class="n">KorgAudioBuffer</span>   <span class="n">recordDataBufs</span><span class="p">[</span><span class="n">kNumBuffers</span><span class="p">];</span>
<span class="cp">#endif</span>
   <span class="kt">short</span>             <span class="n">volumeData</span><span class="p">[</span><span class="n">kAudioChannels</span><span class="p">];</span>
   <span class="n">u32</span>               <span class="n">cardCommand</span><span class="p">;</span>
   <span class="n">u16</span>               <span class="n">routeData</span> <span class="p">[</span><span class="n">kAudioChannels</span><span class="p">];</span>
   <span class="n">u32</span>               <span class="n">AdatTimeCode</span><span class="p">;</span>                 <span class="c1">// ADAT timecode value</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">SensBits</span> <span class="p">{</span>
   <span class="k">union</span> <span class="p">{</span>
      <span class="k">struct</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leftChanVal</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leftChanId</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span> <span class="n">v</span><span class="p">;</span>
      <span class="n">u16</span>  <span class="n">leftSensBits</span><span class="p">;</span>
   <span class="p">}</span> <span class="n">l</span><span class="p">;</span>
   <span class="k">union</span> <span class="p">{</span>
      <span class="k">struct</span> <span class="p">{</span>
         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rightChanVal</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
         <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rightChanId</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
      <span class="p">}</span> <span class="n">v</span><span class="p">;</span>
      <span class="n">u16</span>  <span class="n">rightSensBits</span><span class="p">;</span>
   <span class="p">}</span> <span class="n">r</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

        <span class="n">spinlock_t</span>    <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">open_mutex</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* timer callback for checking ack of stop request */</span>
	<span class="kt">int</span> <span class="n">stop_pending_cnt</span><span class="p">;</span>		<span class="cm">/* counter for stop pending check */</span>

        <span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iomem</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ioport</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iomem2</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqcount</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">inIRQ</span><span class="p">;</span>
        <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma_dsp</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma_play</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma_rec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">dma_shared</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">DataBufsSize</span><span class="p">;</span>

        <span class="k">struct</span> <span class="n">KorgAudioBuffer</span>  <span class="o">*</span> <span class="n">playDataBufsPtr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">KorgAudioBuffer</span>  <span class="o">*</span> <span class="n">recordDataBufsPtr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">KorgSharedBuffer</span> <span class="o">*</span> <span class="n">sharedBufferPtr</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">RecDataPhy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">PlayDataPhy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sharedBufferPhy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">VolumeTablePhy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">RoutingTablePhy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">AdatTimeCodePhy</span><span class="p">;</span>

        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">statusRegPtr</span><span class="p">;</span>	     <span class="c1">// address of the interrupt status/control register</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">outDoorbellPtr</span><span class="p">;</span>	     <span class="c1">// address of the host-&gt;card doorbell register</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">inDoorbellPtr</span><span class="p">;</span>	     <span class="c1">// address of the card-&gt;host doorbell register</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">mailbox0Ptr</span><span class="p">;</span>	     <span class="c1">// address of mailbox 0 on the card</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">mailbox1Ptr</span><span class="p">;</span>	     <span class="c1">// address of mailbox 1 on the card</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">mailbox2Ptr</span><span class="p">;</span>	     <span class="c1">// address of mailbox 2 on the card</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">mailbox3Ptr</span><span class="p">;</span>	     <span class="c1">// address of mailbox 3 on the card</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">controlRegPtr</span><span class="p">;</span>	     <span class="c1">// address of the EEPROM, PCI, I/O, Init ctrl reg</span>
        <span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">sensRegPtr</span><span class="p">;</span>	     <span class="c1">// address of the sensitivity setting register</span>
        <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">idRegPtr</span><span class="p">;</span>		     <span class="c1">// address of the device and vendor ID registers</span>

        <span class="kt">size_t</span> <span class="n">periodsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">currentBuffer</span><span class="p">;</span>

        <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>

	<span class="n">pid_t</span> <span class="n">capture_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">playback_pid</span><span class="p">;</span>

 	<span class="k">enum</span> <span class="n">CardState</span> <span class="n">cardState</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">running</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">idleMonitorOn</span><span class="p">;</span>           <span class="c1">// indicates whether the card is in idle monitor mode.</span>
        <span class="n">u32</span> <span class="n">cmdRetryCount</span><span class="p">;</span>           <span class="c1">// tracks how many times we have retried sending to the card.</span>

        <span class="k">enum</span> <span class="n">ClockSourceIndex</span> <span class="n">clkSrcRate</span><span class="p">;</span> <span class="c1">// sample rate and clock source</span>

        <span class="k">enum</span> <span class="n">ClockSourceType</span> <span class="n">clkSource</span><span class="p">;</span>   <span class="c1">// clock source</span>
        <span class="kt">int</span> <span class="n">clkRate</span><span class="p">;</span>                 <span class="c1">// clock rate</span>

        <span class="kt">int</span> <span class="n">volumePhase</span><span class="p">[</span><span class="n">kAudioChannels</span><span class="p">];</span>

        <span class="n">u16</span> <span class="n">leftADCInSens</span><span class="p">;</span>           <span class="c1">// ADC left channel input sensitivity</span>
        <span class="n">u16</span> <span class="n">rightADCInSens</span><span class="p">;</span>          <span class="c1">// ADC right channel input sensitivity</span>

	<span class="kt">int</span> <span class="n">opencnt</span><span class="p">;</span>		     <span class="c1">// Open/Close count</span>
	<span class="kt">int</span> <span class="n">setcnt</span><span class="p">;</span>		     <span class="c1">// SetupForPlay count</span>
	<span class="kt">int</span> <span class="n">playcnt</span><span class="p">;</span>		     <span class="c1">// TriggerPlay count</span>
	<span class="kt">int</span> <span class="n">errorcnt</span><span class="p">;</span>		     <span class="c1">// Error Count</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">totalerrorcnt</span><span class="p">;</span> <span class="c1">// Total Error Count</span>

	<span class="kt">int</span> <span class="n">dsp_is_loaded</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsp_stop_is_processed</span><span class="p">;</span>

<span class="p">};</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;korg1212&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{KORG,korg1212}}&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;korg/k1212.dsp&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>     <span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	   <span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE</span><span class="p">;</span> <span class="cm">/* Enable this card */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Korg 1212 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Korg 1212 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Korg 1212 soundcard.&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Haroldo Gamal &lt;gamal@alternex.com.br&gt;&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_korg1212_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span>	   <span class="o">=</span> <span class="mh">0x10b5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>	   <span class="o">=</span> <span class="mh">0x906d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_korg1212_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stateName</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Non-existent&quot;</span><span class="p">,</span>
	<span class="s">&quot;Uninitialized&quot;</span><span class="p">,</span>
	<span class="s">&quot;DSP download in process&quot;</span><span class="p">,</span>
	<span class="s">&quot;DSP download complete&quot;</span><span class="p">,</span>
	<span class="s">&quot;Ready&quot;</span><span class="p">,</span>
	<span class="s">&quot;Open&quot;</span><span class="p">,</span>
	<span class="s">&quot;Setup for play&quot;</span><span class="p">,</span>
	<span class="s">&quot;Playing&quot;</span><span class="p">,</span>
	<span class="s">&quot;Monitor mode on&quot;</span><span class="p">,</span>
	<span class="s">&quot;Calibrating&quot;</span><span class="p">,</span>
	<span class="s">&quot;Invalid&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clockSourceTypeName</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;ADAT&quot;</span><span class="p">,</span> <span class="s">&quot;S/PDIF&quot;</span><span class="p">,</span> <span class="s">&quot;local&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">clockSourceName</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADAT at 44.1 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT at 48 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;S/PDIF at 44.1 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;S/PDIF at 48 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;local clock at 44.1 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;local clock at 48 kHz&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">channelName</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADAT-1&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-2&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-3&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-4&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-5&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-6&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-7&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT-8&quot;</span><span class="p">,</span>
	<span class="s">&quot;Analog-L&quot;</span><span class="p">,</span>
	<span class="s">&quot;Analog-R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF-L&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF-R&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">ClockSourceSelector</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x8000</span><span class="p">,</span>   <span class="c1">// selects source as ADAT at 44.1 kHz</span>
	<span class="mh">0x0000</span><span class="p">,</span>   <span class="c1">// selects source as ADAT at 48 kHz</span>
	<span class="mh">0x8001</span><span class="p">,</span>   <span class="c1">// selects source as S/PDIF at 44.1 kHz</span>
	<span class="mh">0x0001</span><span class="p">,</span>   <span class="c1">// selects source as S/PDIF at 48 kHz</span>
	<span class="mh">0x8002</span><span class="p">,</span>   <span class="c1">// selects source as local clock at 44.1 kHz</span>
	<span class="mh">0x0002</span>    <span class="c1">// selects source as local clock at 48 kHz</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">swap_u32</span> <span class="p">{</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="n">u32</span> <span class="n">i</span><span class="p">;</span> <span class="p">};</span>

<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">u32</span> <span class="n">swappee</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">UpperWordSwap</span><span class="p">(</span><span class="n">u32</span> <span class="n">swappee</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
   <span class="k">union</span> <span class="n">swap_u32</span> <span class="n">retVal</span><span class="p">,</span> <span class="n">swapper</span><span class="p">;</span>

   <span class="n">swapper</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">swappee</span><span class="p">;</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

   <span class="k">return</span> <span class="n">retVal</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">UpperWordSwap</span><span class="p">(</span><span class="n">u32</span> <span class="n">swappee</span><span class="p">)</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">u32</span> <span class="n">swappee</span><span class="p">)</span>
<span class="cp">#endif</span>
<span class="p">{</span>
   <span class="k">union</span> <span class="n">swap_u32</span> <span class="n">retVal</span><span class="p">,</span> <span class="n">swapper</span><span class="p">;</span>

   <span class="n">swapper</span><span class="p">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">swappee</span><span class="p">;</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
   <span class="n">retVal</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">swapper</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

   <span class="k">return</span> <span class="n">retVal</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SetBitInWord(theWord,bitPosition)       (*theWord) |= (0x0001 &lt;&lt; bitPosition)</span>
<span class="cp">#define SetBitInDWord(theWord,bitPosition)      (*theWord) |= (0x00000001 &lt;&lt; bitPosition)</span>
<span class="cp">#define ClearBitInWord(theWord,bitPosition)     (*theWord) &amp;= ~(0x0001 &lt;&lt; bitPosition)</span>
<span class="cp">#define ClearBitInDWord(theWord,bitPosition)    (*theWord) &amp;= ~(0x00000001 &lt;&lt; bitPosition)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">korg1212_dbcnst</span> <span class="n">doorbellVal</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">mailBox0Val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mailBox1Val</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">mailBox2Val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mailBox3Val</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">u32</span> <span class="n">retryCount</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">mailBox3Lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">K1212_CMDRET_Success</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">outDoorbellPtr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: CardUninitialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">K1212_CMDRET_CardUninitialized</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Card &lt;- 0x%08x 0x%08x [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">doorbellVal</span><span class="p">,</span> <span class="n">mailBox0Val</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">retryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">retryCount</span> <span class="o">&lt;</span> <span class="n">MAX_COMMAND_RETRIES</span><span class="p">;</span> <span class="n">retryCount</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mailBox3Val</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox3Ptr</span><span class="p">);</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">mailBox2Val</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox2Ptr</span><span class="p">);</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">mailBox1Val</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox1Ptr</span><span class="p">);</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">mailBox0Val</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox0Ptr</span><span class="p">);</span>
                <span class="n">writel</span><span class="p">(</span><span class="n">doorbellVal</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">outDoorbellPtr</span><span class="p">);</span>  <span class="c1">// interrupt the card</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><hr />

<h2>the reboot command will not give an acknowledgement.</h2></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="p">(</span> <span class="n">doorbellVal</span> <span class="o">==</span> <span class="n">K1212_DB_RebootCard</span> <span class="o">||</span>
                	<span class="n">doorbellVal</span> <span class="o">==</span> <span class="n">K1212_DB_BootFromDSPPage4</span> <span class="o">||</span>
                        <span class="n">doorbellVal</span> <span class="o">==</span> <span class="n">K1212_DB_StartDSPDownload</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="n">K1212_CMDRET_Success</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><hr />

<p>See if the card acknowledged the command.  Wait a bit, then
read in the low word of mailbox3.  If the MSB is set and the</p>

<h2>low byte is equal to the doorbell value, then it ack'd.</h2></td><td class="code"><div class="highlight"><pre>                <span class="n">udelay</span><span class="p">(</span><span class="n">COMMAND_ACK_DELAY</span><span class="p">);</span>
                <span class="n">mailBox3Lo</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox3Ptr</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mailBox3Lo</span> <span class="o">&amp;</span> <span class="n">COMMAND_ACK_MASK</span><span class="p">)</span> <span class="p">{</span>
                	<span class="k">if</span> <span class="p">((</span><span class="n">mailBox3Lo</span> <span class="o">&amp;</span> <span class="n">DOORBELL_VAL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">doorbellVal</span> <span class="o">&amp;</span> <span class="n">DOORBELL_VAL_MASK</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Card &lt;- Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                                <span class="n">rc</span> <span class="o">=</span> <span class="n">K1212_CMDRET_Success</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
	<span class="p">}</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cmdRetryCount</span> <span class="o">+=</span> <span class="n">retryCount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retryCount</span> <span class="o">&gt;=</span> <span class="n">MAX_COMMAND_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Card &lt;- NoAckFromCard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        	<span class="n">rc</span> <span class="o">=</span> <span class="n">K1212_CMDRET_NoAckFromCard</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* spinlock already held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_SendStop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">stop_pending_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">cardCommand</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
		<span class="cm">/* program the timer */</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">stop_pending_cnt</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_SendStopAndWait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_stop_is_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_korg1212_SendStop</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_stop_is_processed</span><span class="p">,</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* timer callback for checking the ack of stop request */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_timer_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">cardCommand</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ack&#39;ed */</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">stop_pending_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_stop_is_processed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Stop ack&#39;ed [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">stop_pending_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reprogram timer */</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;korg1212_timer_func timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">cardCommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_stop_is_processed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Stop timeout [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_TurnOnIdleMonitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

        <span class="n">udelay</span><span class="p">(</span><span class="n">INTERCOMMAND_DELAY</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_SelectPlayMode</span><span class="p">,</span>
					  <span class="n">K1212_MODE_MonitorOn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_TurnOffIdleMonitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_korg1212_SendStopAndWait</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">,</span> <span class="k">enum</span> <span class="n">CardState</span> <span class="n">csState</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">=</span> <span class="n">csState</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_OpenCard</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: OpenCard [%s] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">opencnt</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">opencnt</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_korg1212_TurnOffIdleMonitor</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
		<span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_OPEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_CloseCard</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: CloseCard [%s] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">opencnt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">opencnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">==</span> <span class="n">K1212_STATE_SETUP</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_SelectPlayMode</span><span class="p">,</span>
                                <span class="n">K1212_MODE_StopPlay</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: CloseCard - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">K1212_CMDRET_Success</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
                        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">&gt;</span> <span class="n">K1212_STATE_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_korg1212_SendStopAndWait</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">&gt;</span> <span class="n">K1212_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_korg1212_TurnOnIdleMonitor</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_READY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* spinlock already held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_SetupForPlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: SetupForPlay [%s] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">setcnt</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">setcnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_SETUP</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_SelectPlayMode</span><span class="p">,</span>
                                        <span class="n">K1212_MODE_SetupPlay</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: SetupForPlay - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">K1212_CMDRET_Success</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* spinlock already held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_TriggerPlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: TriggerPlay [%s] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playcnt</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playcnt</span><span class="o">++</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_PLAYING</span><span class="p">);</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_TriggerPlay</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: TriggerPlay - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">K1212_CMDRET_Success</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* spinlock already held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_StopPlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: StopPlay [%s] %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playcnt</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playcnt</span><span class="p">))</span> 
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">setcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">!=</span> <span class="n">K1212_STATE_ERRORSTOP</span><span class="p">)</span>
		<span class="n">snd_korg1212_SendStop</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

	<span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_OPEN</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_EnableCardInterrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PCI_INT_ENABLE_BIT</span>            <span class="o">|</span>
	       <span class="n">PCI_DOORBELL_INT_ENABLE_BIT</span>   <span class="o">|</span>
	       <span class="n">LOCAL_INT_ENABLE_BIT</span>          <span class="o">|</span>
	       <span class="n">LOCAL_DOORBELL_INT_ENABLE_BIT</span> <span class="o">|</span>
	       <span class="n">LOCAL_DMA1_INT_ENABLE_BIT</span><span class="p">,</span>
	       <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">statusRegPtr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* not used */</span>

<span class="c">static int snd_korg1212_SetMonitorMode(struct snd_korg1212 *korg1212,</span>
<span class="c">				       enum MonitorModeSelector mode)</span>
<span class="c">{</span>
<span class="c">	K1212_DEBUG_PRINTK(&quot;K1212_DEBUG: SetMonitorMode [%s]\n&quot;,</span>
<span class="c">			   stateName[korg1212-&gt;cardState]);</span>

<span class="c">        switch (mode) {</span>
<span class="c">	case K1212_MONMODE_Off:</span>
<span class="c">		if (korg1212-&gt;cardState != K1212_STATE_MONITOR)</span>
<span class="c">			return 0;</span>
<span class="c">		else {</span>
<span class="c">			snd_korg1212_SendStopAndWait(korg1212);</span>
<span class="c">			snd_korg1212_setCardState(korg1212, K1212_STATE_OPEN);</span>
<span class="c">		}</span>
<span class="c">		break;</span>

<span class="c">	case K1212_MONMODE_On:</span>
<span class="c">		if (korg1212-&gt;cardState != K1212_STATE_OPEN)</span>
<span class="c">			return 0;</span>
<span class="c">		else {</span>
<span class="c">			int rc;</span>
<span class="c">			snd_korg1212_setCardState(korg1212, K1212_STATE_MONITOR);</span>
<span class="c">			rc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SelectPlayMode,</span>
<span class="c">							  K1212_MODE_MonitorOn, 0, 0, 0);</span>
<span class="c">			if (rc != K1212_CMDRET_Success)</span>
<span class="c">				return 0;</span>
<span class="c">		}</span>
<span class="c">		break;</span>

<span class="c">	default:</span>
<span class="c">		return 0;</span>
<span class="c">        }</span>

<span class="c">        return 1;</span>
<span class="c">}</span>

<span class="cp">#endif /* not used */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">snd_korg1212_use_is_exclusive</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">!=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&amp;&amp;</span>
	    <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_SetRate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">static</span> <span class="k">enum</span> <span class="n">ClockSourceIndex</span> <span class="n">s44</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">K1212_CLKIDX_AdatAt44_1K</span><span class="p">,</span>
		<span class="n">K1212_CLKIDX_WordAt44_1K</span><span class="p">,</span>
		<span class="n">K1212_CLKIDX_LocalAt44_1K</span>
	<span class="p">};</span>
        <span class="k">static</span> <span class="k">enum</span> <span class="n">ClockSourceIndex</span> <span class="n">s48</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">K1212_CLKIDX_AdatAt48K</span><span class="p">,</span>
		<span class="n">K1212_CLKIDX_WordAt48K</span><span class="p">,</span>
		<span class="n">K1212_CLKIDX_LocalAt48K</span>
	<span class="p">};</span>
        <span class="kt">int</span> <span class="n">parm</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_korg1212_use_is_exclusive</span> <span class="p">(</span><span class="n">korg1212</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">parm</span> <span class="o">=</span> <span class="n">s44</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSource</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">parm</span> <span class="o">=</span> <span class="n">s48</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSource</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSrcRate</span> <span class="o">=</span> <span class="n">parm</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkRate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">INTERCOMMAND_DELAY</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_SetClockSourceRate</span><span class="p">,</span>
					  <span class="n">ClockSourceSelector</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSrcRate</span><span class="p">],</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Set Clock Source Selector - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_SetClockSource</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">,</span> <span class="kt">int</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">source</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSource</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>

        <span class="n">snd_korg1212_SetRate</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkRate</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_DisableCardInterrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">statusRegPtr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_WriteADCSensitivity</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">SensBits</span>  <span class="n">sensVals</span><span class="p">;</span>
        <span class="kt">int</span>       <span class="n">bitPosition</span><span class="p">;</span>
        <span class="kt">int</span>       <span class="n">channel</span><span class="p">;</span>
        <span class="kt">int</span>       <span class="n">clkIs48K</span><span class="p">;</span>
        <span class="kt">int</span>       <span class="n">monModeSet</span><span class="p">;</span>
        <span class="n">u16</span>       <span class="n">controlValue</span><span class="p">;</span>    <span class="c1">// this keeps the current value to be written to</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>the card's eeprom control register.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">u16</span>       <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: WriteADCSensivity [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><hr />

<p>initialize things.  The local init bit is always set when writing to the</p>

<h2>card's control register.</h2></td><td class="code"><div class="highlight"><pre>        <span class="n">controlValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_LOCALINIT_BITPOS</span><span class="p">);</span>    <span class="c1">// init the control value</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><hr />

<h2>make sure the card is not in monitor mode when we do this update.</h2></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">==</span> <span class="n">K1212_STATE_MONITOR</span> <span class="o">||</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">monModeSet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">snd_korg1212_SendStopAndWait</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>
                <span class="n">monModeSet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><hr />

<p>we are about to send new values to the card, so clear the new values queued</p>

<h2>flag.  Also, clear out mailbox 3, so we don't lockup.</h2></td><td class="code"><div class="highlight"><pre>        <span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox3Ptr</span><span class="p">);</span>
        <span class="n">udelay</span><span class="p">(</span><span class="n">LOADSHIFT_DELAY</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><hr />

<p>determine whether we are running a 48K or 44.1K clock.  This info is used</p>

<h2>later when setting the SPDIF FF after the volume has been shifted in.</h2></td><td class="code"><div class="highlight"><pre>        <span class="k">switch</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSrcRate</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">K1212_CLKIDX_AdatAt44_1K</span>:
                <span class="k">case</span> <span class="n">K1212_CLKIDX_WordAt44_1K</span>:
                <span class="k">case</span> <span class="n">K1212_CLKIDX_LocalAt44_1K</span>:
                        <span class="n">clkIs48K</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="n">K1212_CLKIDX_WordAt48K</span>:
                <span class="k">case</span> <span class="n">K1212_CLKIDX_AdatAt48K</span>:
                <span class="k">case</span> <span class="n">K1212_CLKIDX_LocalAt48K</span>:
                <span class="nl">default:</span>
                        <span class="n">clkIs48K</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><hr />

<h2>start the update.  Setup the bit structure and then shift the bits.</h2></td><td class="code"><div class="highlight"><pre>        <span class="n">sensVals</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">leftChanId</span>   <span class="o">=</span> <span class="n">SET_SENS_LEFTCHANID</span><span class="p">;</span>
        <span class="n">sensVals</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">rightChanId</span>  <span class="o">=</span> <span class="n">SET_SENS_RIGHTCHANID</span><span class="p">;</span>
        <span class="n">sensVals</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">leftChanVal</span>  <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">leftADCInSens</span><span class="p">;</span>
        <span class="n">sensVals</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">v</span><span class="p">.</span><span class="n">rightChanVal</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">rightADCInSens</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><hr />

<h2>now start shifting the bits in.  Start with the left channel then the right.</h2></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><hr />

<p>Bring the load/shift line low, then wait - the spec says >150ns from load/</p>

<h2>shift low to the first rising edge of the clock.</h2></td><td class="code"><div class="highlight"><pre>                <span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_LOADSHIFT_BITPOS</span><span class="p">);</span>
                <span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>
                <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                          <span class="c1">// load/shift goes low</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">LOADSHIFT_DELAY</span><span class="p">);</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">bitPosition</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">bitPosition</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bitPosition</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>       <span class="c1">// for all the bits</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sensVals</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">leftSensBits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0001</span> <span class="o">&lt;&lt;</span> <span class="n">bitPosition</span><span class="p">))</span>
                                        <span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>     <span class="c1">// data bit set high</span>
				<span class="k">else</span>
					<span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>   <span class="c1">// data bit set low</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">sensVals</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">rightSensBits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0001</span> <span class="o">&lt;&lt;</span> <span class="n">bitPosition</span><span class="p">))</span>
					<span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>     <span class="c1">// data bit set high</span>
				<span class="k">else</span>
					<span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>   <span class="c1">// data bit set low</span>
			<span class="p">}</span>

                        <span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_CLOCK_BITPOS</span><span class="p">);</span>
                        <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                       <span class="c1">// clock goes low</span>
                        <span class="n">udelay</span><span class="p">(</span><span class="n">SENSCLKPULSE_WIDTH</span><span class="p">);</span>
                        <span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_CLOCK_BITPOS</span><span class="p">);</span>
                        <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                       <span class="c1">// clock goes high</span>
                        <span class="n">udelay</span><span class="p">(</span><span class="n">SENSCLKPULSE_WIDTH</span><span class="p">);</span>
                <span class="p">}</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><hr />

<p>finish up SPDIF for left.  Bring the load/shift line high, then write a one</p>

<h2>bit if the clock rate is 48K otherwise write 0.</h2></td><td class="code"><div class="highlight"><pre>                <span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>
                <span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_CLOCK_BITPOS</span><span class="p">);</span>
                <span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_LOADSHIFT_BITPOS</span><span class="p">);</span>
                <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                   <span class="c1">// load shift goes high - clk low</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">SENSCLKPULSE_WIDTH</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">clkIs48K</span><span class="p">)</span>
                        <span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_DATA_BITPOS</span><span class="p">);</span>

                <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                   <span class="c1">// set/clear data bit</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">ONE_RTC_TICK</span><span class="p">);</span>
                <span class="n">SetBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_CLOCK_BITPOS</span><span class="p">);</span>
                <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                   <span class="c1">// clock goes high</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">SENSCLKPULSE_WIDTH</span><span class="p">);</span>
                <span class="n">ClearBitInWord</span><span class="p">(</span><span class="o">&amp;</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">SET_SENS_CLOCK_BITPOS</span><span class="p">);</span>
                <span class="n">writew</span><span class="p">(</span><span class="n">controlValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">);</span>                   <span class="c1">// clock goes low</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">SENSCLKPULSE_WIDTH</span><span class="p">);</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><hr />

<p>The update is complete.  Set a timeout.  This is the inter-update delay.</p>

<h2>Also, if the card was in monitor mode, restore it.</h2></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
                <span class="n">udelay</span><span class="p">(</span><span class="n">SENSCLKPULSE_WIDTH</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">monModeSet</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_SelectPlayMode</span><span class="p">,</span>
                                <span class="n">K1212_MODE_MonitorOn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: WriteADCSensivity - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
        <span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_korg1212_OnDSPDownloadComplete</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: DSP download is complete. [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><hr />

<h2>tell the card to boot</h2></td><td class="code"><div class="highlight"><pre>        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_BootFromDSPPage4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Boot from Page 4 - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">DSP_BOOT_DELAY_IN_MS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><hr />

<h2>Let the card know where all the buffers are.</h2></td><td class="code"><div class="highlight"><pre>        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span>
                        <span class="n">K1212_DB_ConfigureBufferMemory</span><span class="p">,</span>
                        <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">PlayDataPhy</span><span class="p">),</span>
                        <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RecDataPhy</span><span class="p">),</span>
                        <span class="p">((</span><span class="n">kNumBuffers</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>   <span class="c1">// size given to the card</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>is based on 2 buffers</p></td><td class="code"><div class="highlight"><pre>                        <span class="mi">0</span>
        <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Configure Buffer Memory - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="n">udelay</span><span class="p">(</span><span class="n">INTERCOMMAND_DELAY</span><span class="p">);</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span>
                        <span class="n">K1212_DB_ConfigureMiscMemory</span><span class="p">,</span>
                        <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">VolumeTablePhy</span><span class="p">),</span>
                        <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RoutingTablePhy</span><span class="p">),</span>
                        <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">AdatTimeCodePhy</span><span class="p">),</span>
                        <span class="mi">0</span>
        <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Configure Misc Memory - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><hr />

<h2>Initialize the routing and volume tables, then update the card's state.</h2></td><td class="code"><div class="highlight"><pre>        <span class="n">udelay</span><span class="p">(</span><span class="n">INTERCOMMAND_DELAY</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">channel</span> <span class="o">&lt;</span> <span class="n">kAudioChannels</span><span class="p">;</span> <span class="n">channel</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">k1212MaxVolume</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>korg1212->sharedBufferPtr->routeData[channel] = channel;</p></td><td class="code"><div class="highlight"><pre>                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">routeData</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">snd_korg1212_WriteADCSensitivity</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">INTERCOMMAND_DELAY</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_SetClockSourceRate</span><span class="p">,</span>
					  <span class="n">ClockSourceSelector</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSrcRate</span><span class="p">],</span>
					  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Set Clock Source Selector - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_TurnOnIdleMonitor</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
	<span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_READY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Set Monitor On - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_DSP_COMPLETE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">snd_korg1212_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">u32</span> <span class="n">doorbellValue</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

        <span class="n">doorbellValue</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inDoorbellPtr</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">doorbellValue</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">doorbellValue</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inDoorbellPtr</span><span class="p">);</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irqcount</span><span class="o">++</span><span class="p">;</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inIRQ</span><span class="o">++</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">doorbellValue</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">K1212_DB_DSPDownloadDone</span>:
                        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: IRQ DNLD count - %ld, %x, [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irqcount</span><span class="p">,</span> <span class="n">doorbellValue</span><span class="p">,</span>
					   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">==</span> <span class="n">K1212_STATE_DSP_IN_PROCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_is_loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><hr />

<h2>an error occurred - stop the card</h2></td><td class="code"><div class="highlight"><pre>                <span class="k">case</span> <span class="n">K1212_DB_DMAERROR</span>:
			<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: IRQ DMAE count - %ld, %x, [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irqcount</span><span class="p">,</span> <span class="n">doorbellValue</span><span class="p">,</span>
						   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: DMA Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">errorcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">totalerrorcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">cardCommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_ERRORSTOP</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><hr />

<p>the card has stopped by our request.  Clear the command word and signal</p>

<h2>the semaphore in case someone is waiting for this.</h2></td><td class="code"><div class="highlight"><pre>                <span class="k">case</span> <span class="n">K1212_DB_CARDSTOPPED</span>:
                        <span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: IRQ CSTP count - %ld, %x, [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irqcount</span><span class="p">,</span> <span class="n">doorbellValue</span><span class="p">,</span>
						   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">cardCommand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="nl">default:</span>
			<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: IRQ DFLT count - %ld, %x, cpos=%d [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irqcount</span><span class="p">,</span> <span class="n">doorbellValue</span><span class="p">,</span> 
			       <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">&gt;</span> <span class="n">K1212_STATE_SETUP</span><span class="p">)</span> <span class="o">||</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span><span class="o">++</span><span class="p">;</span>

                                <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span> <span class="o">&gt;=</span> <span class="n">kNumBuffers</span><span class="p">)</span>
                                        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
                                        <span class="k">break</span><span class="p">;</span>

                                <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                                        <span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                                <span class="p">}</span>

                                <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                                        <span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inIRQ</span><span class="o">--</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_korg1212_downloadDSPCode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: DSP download is starting... [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><hr />

<h2>verify the state of the card before proceeding.</h2></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span> <span class="o">&gt;=</span> <span class="n">K1212_STATE_DSP_IN_PROCESS</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

        <span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_DSP_IN_PROCESS</span><span class="p">);</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_StartDSPDownload</span><span class="p">,</span>
                                     <span class="n">UpperWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">addr</span><span class="p">),</span>
                                     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Start DSP Download RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_is_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_is_loaded</span><span class="p">,</span> <span class="n">HZ</span> <span class="o">*</span> <span class="n">CARD_BOOT_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dsp_is_loaded</span> <span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* timeout */</span>

	<span class="n">snd_korg1212_OnDSPDownloadComplete</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_korg1212_playback_info</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>              <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
                              <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_BATCH</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>	      <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rates</span> <span class="o">=</span>              <span class="p">(</span><span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
                              <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">),</span>
        <span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>           <span class="mi">44100</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>           <span class="mi">48000</span><span class="p">,</span>
        <span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>       <span class="n">K1212_MIN_CHANNELS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>       <span class="n">K1212_MAX_CHANNELS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>   <span class="n">K1212_MAX_BUF_SIZE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>   <span class="n">K1212_MIN_CHANNELS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">,</span>
        <span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>   <span class="n">K1212_MAX_CHANNELS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">,</span>
        <span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>        <span class="n">K1212_PERIODS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>        <span class="n">K1212_PERIODS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>          <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_korg1212_capture_info</span> <span class="o">=</span>
<span class="p">{</span>
        <span class="p">.</span><span class="n">info</span> <span class="o">=</span>              <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
                              <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_BATCH</span><span class="p">),</span>
        <span class="p">.</span><span class="n">formats</span> <span class="o">=</span>	      <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rates</span> <span class="o">=</span>	      <span class="p">(</span><span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
                              <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">),</span>
        <span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>           <span class="mi">44100</span><span class="p">,</span>
        <span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>           <span class="mi">48000</span><span class="p">,</span>
        <span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>       <span class="n">K1212_MIN_CHANNELS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>       <span class="n">K1212_MAX_CHANNELS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>   <span class="n">K1212_MAX_BUF_SIZE</span><span class="p">,</span>
        <span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>   <span class="n">K1212_MIN_CHANNELS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">,</span>
        <span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>   <span class="n">K1212_MAX_CHANNELS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">,</span>
        <span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>        <span class="n">K1212_PERIODS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>        <span class="n">K1212_PERIODS</span><span class="p">,</span>
        <span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>          <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_silence</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">KorgAudioFrame</span> <span class="o">*</span> <span class="n">dst</span> <span class="o">=</span>  <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bufferData</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_silence pos=%d offset=%d size=%d count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">K1212_MAX_SAMPLES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if K1212_DEBUG_LEVEL &gt; 0</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span> <span class="o">||</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">bufferData</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;K1212_DEBUG: snd_korg1212_silence KERNEL EFAULT dst=%p iter=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_copy_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">KorgAudioFrame</span> <span class="o">*</span> <span class="n">src</span> <span class="o">=</span>  <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">recordDataBufsPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bufferData</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_copy_to pos=%d offset=%d size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">K1212_MAX_SAMPLES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if K1212_DEBUG_LEVEL &gt; 0</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">recordDataBufsPtr</span> <span class="o">||</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">recordDataBufsPtr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">bufferData</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;K1212_DEBUG: snd_korg1212_copy_to KERNEL EFAULT, src=%p dst=%p iter=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">dst</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_copy_to USER EFAULT src=%p dst=%p iter=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_copy_from</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">KorgAudioFrame</span> <span class="o">*</span> <span class="n">dst</span> <span class="o">=</span>  <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bufferData</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_copy_from pos=%d offset=%d size=%d count=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pos</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">K1212_MAX_SAMPLES</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if K1212_DEBUG_LEVEL &gt; 0</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span> <span class="o">||</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">bufferData</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;K1212_DEBUG: snd_korg1212_copy_from KERNEL EFAULT, src=%p dst=%p iter=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">((</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_copy_from USER EFAULT src=%p dst=%p iter=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_korg1212_free_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_free_pcm [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_playback_open [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">snd_korg1212_OpenCard</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

        <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_korg1212_playback_info</span><span class="p">;</span>
	<span class="n">snd_pcm_set_runtime_buffer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">periodsize</span> <span class="o">=</span> <span class="n">K1212_PERIODS</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">K1212_CHANNELS</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">errorcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="n">kPlayBufferFrames</span><span class="p">,</span> <span class="n">kPlayBufferFrames</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
        <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_capture_open [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">snd_korg1212_OpenCard</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

        <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_korg1212_capture_info</span><span class="p">;</span>
	<span class="n">snd_pcm_set_runtime_buffer</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">periodsize</span> <span class="o">=</span> <span class="n">K1212_PERIODS</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">K1212_CHANNELS</span><span class="p">;</span>

        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span>
				     <span class="n">kPlayBufferFrames</span><span class="p">,</span> <span class="n">kPlayBufferFrames</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_playback_close [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">snd_korg1212_silence</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">K1212_MAX_SAMPLES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">periodsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_korg1212_CloseCard</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_capture_close [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">periodsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">snd_korg1212_CloseCard</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_ioctl: cmd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_IOCTL1_CHANNEL_INFO</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_channel_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
        	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        	<span class="n">info</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
        	<span class="n">info</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: channel_info %d:, offset=%ld, first=%d, step=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="k">return</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
                             <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">this_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">other_pid</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_hw_params [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">other_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_pid</span> <span class="o">!=</span> <span class="n">other_pid</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* The other stream is open, and not by the same</span>
<span class="cm">		   task as this one. Make sure that the parameters</span>
<span class="cm">		   that matter are the same.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkRate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

        	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_korg1212_SetRate</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">periodsize</span> <span class="o">=</span> <span class="n">K1212_PERIOD_BYTES</span><span class="p">;</span>

        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_prepare [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* FIXME: we should wait for ack! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">stop_pending_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_prepare - Stop is pending... [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
        	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		korg1212-&gt;sharedBufferPtr-&gt;cardCommand = 0;</span>
<span class="cm">		del_timer(&amp;korg1212-&gt;timer);</span>
<span class="cm">		korg1212-&gt;stop_pending_cnt = 0;</span>
<span class="cm">		*/</span>
	<span class="p">}</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_SetupForPlay</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
                           <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_trigger [%s] cmd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
<span class="cm">/*</span>
<span class="cm">			if (korg1212-&gt;running) {</span>
<span class="cm">				K1212_DEBUG_PRINTK_VERBOSE(&quot;K1212_DEBUG: snd_korg1212_trigger: Already running?\n&quot;);</span>
<span class="cm">				break;</span>
<span class="cm">			}</span>
<span class="cm">*/</span>
                        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">running</span><span class="o">++</span><span class="p">;</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_TriggerPlay</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
<span class="cm">/*</span>
<span class="cm">			if (!korg1212-&gt;running) {</span>
<span class="cm">				K1212_DEBUG_PRINTK_VERBOSE(&quot;K1212_DEBUG: snd_korg1212_trigger: Already stopped?\n&quot;);</span>
<span class="cm">				break;</span>
<span class="cm">			}</span>
<span class="cm">*/</span>
                        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">running</span><span class="o">--</span><span class="p">;</span>
                        <span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_StopPlay</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>

                <span class="nl">default:</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_korg1212_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
        <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_playback_pointer [%s] %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">pos</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_korg1212_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
        <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">currentBuffer</span> <span class="o">*</span> <span class="n">kPlayBufferFrames</span><span class="p">;</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_capture_pointer [%s] %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">pos</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_playback_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
                        <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="cm">/* not used (interleaved data) */</span>
                        <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span>
                        <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
                        <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_playback_copy [%s] %ld %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
 
	<span class="k">return</span> <span class="n">snd_korg1212_copy_from</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_playback_silence</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
                           <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="cm">/* not used (interleaved data) */</span>
                           <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span>
                           <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_playback_silence [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">snd_korg1212_silence</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_capture_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
                        <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="cm">/* not used (interleaved data) */</span>
                        <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span>
                        <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
                        <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">K1212_DEBUG_PRINTK_VERBOSE</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: snd_korg1212_capture_copy [%s] %ld %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">],</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_korg1212_copy_to</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_korg1212_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_korg1212_playback_open</span><span class="p">,</span>
        <span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_korg1212_playback_close</span><span class="p">,</span>
        <span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_korg1212_ioctl</span><span class="p">,</span>
        <span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_korg1212_hw_params</span><span class="p">,</span>
        <span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_korg1212_prepare</span><span class="p">,</span>
        <span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_korg1212_trigger</span><span class="p">,</span>
        <span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_korg1212_playback_pointer</span><span class="p">,</span>
        <span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_korg1212_playback_copy</span><span class="p">,</span>
        <span class="p">.</span><span class="n">silence</span> <span class="o">=</span>	<span class="n">snd_korg1212_playback_silence</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_korg1212_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_korg1212_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_korg1212_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_korg1212_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_korg1212_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_korg1212_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_korg1212_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_korg1212_capture_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_korg1212_capture_copy</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Control Interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_phase_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_phase_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
        	<span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_phase_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">k1212MinVolume</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">k1212MaxVolume</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_volume_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
        <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> 
                <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>

        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_volume_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k1212MinVolume</span> <span class="o">&amp;&amp;</span> 
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k1212MaxVolume</span> <span class="o">&amp;&amp;</span>
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span>
	    <span class="n">abs</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">*=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k1212MinVolume</span> <span class="o">&amp;&amp;</span> 
		    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k1212MaxVolume</span> <span class="o">&amp;&amp;</span>
		    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="n">abs</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">*=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_route_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">kAudioChannels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="n">kAudioChannels</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">kAudioChannels</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">channelName</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_route_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">routeData</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> 
		<span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">routeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_route_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">kAudioChannels</span> <span class="o">&amp;&amp;</span>
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">routeData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">kAudioChannels</span> <span class="o">&amp;&amp;</span>
		    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span>
		    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">routeData</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
        <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">k1212MaxADCSens</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">k1212MinADCSens</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">leftADCInSens</span><span class="p">;</span>
        <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">rightADCInSens</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k1212MinADCSens</span> <span class="o">&amp;&amp;</span>
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">k1212MaxADCSens</span> <span class="o">&amp;&amp;</span>
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">leftADCInSens</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">leftADCInSens</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">k1212MinADCSens</span> <span class="o">&amp;&amp;</span>
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">k1212MaxADCSens</span> <span class="o">&amp;&amp;</span>
	    <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">rightADCInSens</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">rightADCInSens</span> <span class="o">=</span> <span class="n">u</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
                <span class="n">snd_korg1212_WriteADCSensitivity</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_sync_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">clockSourceTypeName</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_sync_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSource</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_control_sync_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSource</span><span class="p">;</span>
        <span class="n">snd_korg1212_SetClockSource</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MON_MIXER(ord,c_name)									\</span>
<span class="cp">        {											\</span>
<span class="cp">                .access =	SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_WRITE,	\</span>
<span class="cp">                .iface =        SNDRV_CTL_ELEM_IFACE_MIXER,					\</span>
<span class="cp">                .name =		c_name &quot; Monitor Volume&quot;,					\</span>
<span class="cp">                .info =		snd_korg1212_control_volume_info,				\</span>
<span class="cp">                .get =		snd_korg1212_control_volume_get,				\</span>
<span class="cp">                .put =		snd_korg1212_control_volume_put,				\</span>
<span class="cp">		.private_value = ord,								\</span>
<span class="cp">        },                                                                                      \</span>
<span class="cp">        {											\</span>
<span class="cp">                .access =	SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_WRITE,	\</span>
<span class="cp">                .iface =        SNDRV_CTL_ELEM_IFACE_MIXER,					\</span>
<span class="cp">                .name =		c_name &quot; Monitor Route&quot;,					\</span>
<span class="cp">                .info =		snd_korg1212_control_route_info,				\</span>
<span class="cp">                .get =		snd_korg1212_control_route_get,					\</span>
<span class="cp">                .put =		snd_korg1212_control_route_put,					\</span>
<span class="cp">		.private_value = ord,								\</span>
<span class="cp">        },                                                                                      \</span>
<span class="cp">        {											\</span>
<span class="cp">                .access =	SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_WRITE,	\</span>
<span class="cp">                .iface =        SNDRV_CTL_ELEM_IFACE_MIXER,					\</span>
<span class="cp">                .name =		c_name &quot; Monitor Phase Invert&quot;,					\</span>
<span class="cp">                .info =		snd_korg1212_control_phase_info,				\</span>
<span class="cp">                .get =		snd_korg1212_control_phase_get,					\</span>
<span class="cp">                .put =		snd_korg1212_control_phase_put,					\</span>
<span class="cp">		.private_value = ord,								\</span>
<span class="cp">        }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_korg1212_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s">&quot;Analog&quot;</span><span class="p">),</span>
	<span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">),</span> 
        <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ADAT-1&quot;</span><span class="p">),</span> <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ADAT-2&quot;</span><span class="p">),</span> <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ADAT-3&quot;</span><span class="p">),</span> <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;ADAT-4&quot;</span><span class="p">),</span>
        <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;ADAT-5&quot;</span><span class="p">),</span> <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s">&quot;ADAT-6&quot;</span><span class="p">),</span> <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="s">&quot;ADAT-7&quot;</span><span class="p">),</span> <span class="n">MON_MIXER</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="s">&quot;ADAT-8&quot;</span><span class="p">),</span>
	<span class="p">{</span>
                <span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_WRITE</span><span class="p">,</span>
                <span class="p">.</span><span class="n">iface</span> <span class="o">=</span>        <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
                <span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;Sync Source&quot;</span><span class="p">,</span>
                <span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_korg1212_control_sync_info</span><span class="p">,</span>
                <span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_korg1212_control_sync_get</span><span class="p">,</span>
                <span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_korg1212_control_sync_put</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
                <span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_WRITE</span><span class="p">,</span>
                <span class="p">.</span><span class="n">iface</span> <span class="o">=</span>        <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
                <span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;ADC Attenuation&quot;</span><span class="p">,</span>
                <span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_korg1212_control_info</span><span class="p">,</span>
                <span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_korg1212_control_get</span><span class="p">,</span>
                <span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_korg1212_control_put</span><span class="p">,</span>
        <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_korg1212_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; (index #%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">General settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;    period size: %Zd bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">K1212_PERIOD_BYTES</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;     clock mode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clockSourceName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSrcRate</span><span class="p">]</span> <span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  left ADC Sens: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">leftADCInSens</span> <span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; right ADC Sens: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">rightADCInSens</span> <span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;    Volume Info:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">n</span><span class="o">&lt;</span><span class="n">kAudioChannels</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span>
                <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; Channel %d: %s -&gt; %s [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span>
                                    <span class="n">channelName</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
                                    <span class="n">channelName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">routeData</span><span class="p">[</span><span class="n">n</span><span class="p">]],</span>
                                    <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">volumeData</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">General status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; ADAT Time Code: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">AdatTimeCode</span><span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;     Card State: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Idle mon. State: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span><span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Cmd retry count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cmdRetryCount</span><span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;      Irq count: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irqcount</span><span class="p">);</span>
        <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;    Error count: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">totalerrorcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_korg1212_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;korg1212&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">korg1212</span><span class="p">,</span> <span class="n">snd_korg1212_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_korg1212_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">snd_korg1212_TurnOffIdleMonitor</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">snd_korg1212_DisableCardInterrupts</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="n">free_irq</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">korg1212</span><span class="p">);</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">iounmap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><hr />

<h2>free up memory resources used for the DSP download.</h2></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
        	<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">);</span>
        	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

<span class="cp">#ifndef K1212_LARGEALLOC</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><hr />

<h2>free up memory resources used for the Play/Rec Buffers</h2></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">);</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">);</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><hr />

<h2>free up memory resources used for the Shared Buffers</h2></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_shared</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_shared</span><span class="p">);</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_shared</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
        <span class="n">kfree</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_korg1212_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Freeing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_korg1212_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
                                         <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">**</span> <span class="n">rchip</span><span class="p">)</span>

<span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">ioport_size</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">,</span> <span class="n">iomem2_size</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span> <span class="n">korg1212</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">dsp_code</span><span class="p">;</span>

        <span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
                <span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_korg1212_dev_free</span><span class="p">,</span>
        <span class="p">};</span>

        <span class="o">*</span> <span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

        <span class="n">korg1212</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">korg1212</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">korg1212</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>

        <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
        <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">snd_korg1212_timer_func</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">korg1212</span><span class="p">;</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSource</span> <span class="o">=</span> <span class="n">K1212_CLKIDX_Local</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkRate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inIRQ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">opencnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">setcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">totalerrorcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">snd_korg1212_setCardState</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_STATE_UNINITIALIZED</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idleMonitorOn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">clkSrcRate</span> <span class="o">=</span> <span class="n">K1212_CLKIDX_LocalAt44_1K</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">leftADCInSens</span> <span class="o">=</span> <span class="n">k1212MaxADCSens</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">rightADCInSens</span> <span class="o">=</span> <span class="n">k1212MaxADCSens</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">kAudioChannels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">volumePhase</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;korg1212&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">ioport</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem2</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">iomem_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ioport_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">iomem2_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: resources:</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    iomem = 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;    ioport  = 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    iomem = 0x%lx (%d)</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;    [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">,</span>
		   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">,</span> <span class="n">ioport_size</span><span class="p">,</span>
		   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem2</span><span class="p">,</span> <span class="n">iomem2_size</span><span class="p">,</span>
		   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">,</span> <span class="n">iomem_size</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: unable to remap memory region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">,</span>
                           <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem</span> <span class="o">+</span> <span class="n">iomem_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_korg1212_interrupt</span><span class="p">,</span>
                          <span class="n">IRQF_SHARED</span><span class="p">,</span>
                          <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">korg1212</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">statusRegPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">STATUS_REG_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">outDoorbellPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">OUT_DOORBELL_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inDoorbellPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">IN_DOORBELL_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox0Ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MAILBOX0_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox1Ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MAILBOX1_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox2Ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MAILBOX2_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox3Ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">MAILBOX3_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">controlRegPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">PCI_CONTROL_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">SENS_CONTROL_OFFSET</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idRegPtr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">DEV_VEND_ID_OFFSET</span><span class="p">);</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: card registers:</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    Status register = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    OutDoorbell     = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    InDoorbell      = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    Mailbox0        = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    Mailbox1        = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    Mailbox2        = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    Mailbox3        = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    ControlReg      = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    SensReg         = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
                   <span class="s">&quot;    IDReg           = 0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		   <span class="s">&quot;    [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">statusRegPtr</span><span class="p">,</span>
		   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">outDoorbellPtr</span><span class="p">,</span>
		   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">inDoorbellPtr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox0Ptr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox1Ptr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox2Ptr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">mailbox3Ptr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">controlRegPtr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sensRegPtr</span><span class="p">,</span>
                   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">idRegPtr</span><span class="p">,</span>
		   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_shared</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: can not allocate shared buffer memory (%Zd bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span><span class="p">));</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span> <span class="o">*</span><span class="p">)</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_shared</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_shared</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Shared Buffer Area = 0x%p (0x%08lx), %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span><span class="p">));</span>

<span class="cp">#ifndef K1212_LARGEALLOC</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgAudioBuffer</span><span class="p">)</span> <span class="o">*</span> <span class="n">kNumBuffers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: can not allocate play data buffer memory (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span><span class="p">);</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">KorgAudioBuffer</span> <span class="o">*</span><span class="p">)</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">PlayDataPhy</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_play</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Play Data Area = 0x%p (0x%08x), %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">PlayDataPhy</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: can not allocate record data buffer memory (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span><span class="p">);</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">recordDataBufsPtr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">KorgAudioBuffer</span> <span class="o">*</span><span class="p">)</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RecDataPhy</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_rec</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Record Data Area = 0x%p (0x%08x), %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">recordDataBufsPtr</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RecDataPhy</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">DataBufsSize</span><span class="p">);</span>

<span class="cp">#else </span><span class="c1">// K1212_LARGEALLOC</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">recordDataBufsPtr</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">recordDataBufs</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">playDataBufsPtr</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPtr</span><span class="o">-&gt;</span><span class="n">playDataBufs</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">PlayDataPhy</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">playDataBufs</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RecDataPhy</span>  <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span> <span class="o">*</span><span class="p">)</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">recordDataBufs</span><span class="p">;</span>

<span class="cp">#endif </span><span class="c1">// K1212_LARGEALLOC</span>

        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">VolumeTablePhy</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span> <span class="o">+</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span><span class="p">,</span> <span class="n">volumeData</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RoutingTablePhy</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span> <span class="o">+</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span><span class="p">,</span> <span class="n">routeData</span><span class="p">);</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">AdatTimeCodePhy</span> <span class="o">=</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">sharedBufferPhy</span> <span class="o">+</span>
		<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">KorgSharedBuffer</span><span class="p">,</span> <span class="n">AdatTimeCode</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_code</span><span class="p">,</span> <span class="s">&quot;korg/k1212.dsp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">dsp_code</span><span class="p">);</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">dsp_code</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;korg1212: cannot allocate dsp code memory (%zd bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dsp_code</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">dsp_code</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: DSP Code area = 0x%p (0x%08x) %d bytes [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">dsp_code</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
		   <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">dsp_code</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dsp_code</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dsp_code</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_korg1212_Send1212Command</span><span class="p">(</span><span class="n">korg1212</span><span class="p">,</span> <span class="n">K1212_DB_RebootCard</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: Reboot Card - RC = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">stateName</span><span class="p">[</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">cardState</span><span class="p">]);</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">korg1212</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">snd_korg1212_free</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>
        
	<span class="n">snd_korg1212_EnableCardInterrupts</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="n">CARD_BOOT_DELAY_IN_MS</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">snd_korg1212_downloadDSPCode</span><span class="p">(</span><span class="n">korg1212</span><span class="p">))</span>
        	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;korg1212: dspMemPhy = %08x U[%08x], &quot;</span>
               <span class="s">&quot;PlayDataPhy = %08x L[%08x]</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;korg1212: RecDataPhy = %08x L[%08x], &quot;</span>
               <span class="s">&quot;VolumeTablePhy = %08x L[%08x]</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="s">&quot;korg1212: RoutingTablePhy = %08x L[%08x], &quot;</span>
               <span class="s">&quot;AdatTimeCodePhy = %08x L[%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>    <span class="n">UpperWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">dma_dsp</span><span class="p">.</span><span class="n">addr</span><span class="p">),</span>
               <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">PlayDataPhy</span><span class="p">,</span>     <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">PlayDataPhy</span><span class="p">),</span>
               <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RecDataPhy</span><span class="p">,</span>      <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RecDataPhy</span><span class="p">),</span>
               <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">VolumeTablePhy</span><span class="p">,</span>  <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">VolumeTablePhy</span><span class="p">),</span>
               <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RoutingTablePhy</span><span class="p">,</span> <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">RoutingTablePhy</span><span class="p">),</span>
               <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">AdatTimeCodePhy</span><span class="p">,</span> <span class="n">LowerWordSwap</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">AdatTimeCodePhy</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;korg1212&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">korg1212</span><span class="p">;</span>
        <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_korg1212_free_pcm</span><span class="p">;</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;korg1212&quot;</span><span class="p">);</span>

        <span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_korg1212_playback_ops</span><span class="p">);</span>
        
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_korg1212_capture_ops</span><span class="p">);</span>

	<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_korg1212_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_korg1212_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">korg1212</span><span class="p">));</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">snd_korg1212_proc_init</span><span class="p">(</span><span class="n">korg1212</span><span class="p">);</span>
        
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

        <span class="o">*</span> <span class="n">rchip</span> <span class="o">=</span> <span class="n">korg1212</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Card initialisation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_korg1212_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_korg1212</span> <span class="o">*</span><span class="n">korg1212</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_korg1212_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">korg1212</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;korg1212&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;korg1212&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		<span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">,</span> <span class="n">korg1212</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

        <span class="n">K1212_DEBUG_PRINTK</span><span class="p">(</span><span class="s">&quot;K1212_DEBUG: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_korg1212_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">korg1212_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_korg1212_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_korg1212_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_korg1212_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">korg1212_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
