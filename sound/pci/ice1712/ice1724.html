<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ice1712 › ice1724.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ice1724.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for VT1724 ICEnsemble ICE1724 / VIA VT1724 (Envy24HT)</span>
<span class="cm"> *                   VIA VT1720 (Envy24PT)</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2000 Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *                    2002 James Stafford &lt;jstafford@ampltd.com&gt;</span>
<span class="cm"> *                    2003 Takashi Iwai &lt;tiwai@suse.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/rawmidi.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;sound/asoundef.h&gt;</span>

<span class="cp">#include &quot;ice1712.h&quot;</span>
<span class="cp">#include &quot;envy24ht.h&quot;</span>

<span class="cm">/* lowlevel routines */</span>
<span class="cp">#include &quot;amp.h&quot;</span>
<span class="cp">#include &quot;revo.h&quot;</span>
<span class="cp">#include &quot;aureon.h&quot;</span>
<span class="cp">#include &quot;vt1720_mobo.h&quot;</span>
<span class="cp">#include &quot;pontis.h&quot;</span>
<span class="cp">#include &quot;prodigy192.h&quot;</span>
<span class="cp">#include &quot;prodigy_hifi.h&quot;</span>
<span class="cp">#include &quot;juli.h&quot;</span>
<span class="cp">#include &quot;maya44.h&quot;</span>
<span class="cp">#include &quot;phase.h&quot;</span>
<span class="cp">#include &quot;wtm.h&quot;</span>
<span class="cp">#include &quot;se.h&quot;</span>
<span class="cp">#include &quot;quartet.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;VIA ICEnsemble ICE1724/1720 (Envy24HT/PT)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{&quot;</span>
	       <span class="n">REVO_DEVICE_DESC</span>
	       <span class="n">AMP_AUDIO2000_DEVICE_DESC</span>
	       <span class="n">AUREON_DEVICE_DESC</span>
	       <span class="n">VT1720_MOBO_DEVICE_DESC</span>
	       <span class="n">PONTIS_DEVICE_DESC</span>
	       <span class="n">PRODIGY192_DEVICE_DESC</span>
	       <span class="n">PRODIGY_HIFI_DEVICE_DESC</span>
	       <span class="n">JULI_DEVICE_DESC</span>
	       <span class="n">MAYA44_DEVICE_DESC</span>
	       <span class="n">PHASE_DEVICE_DESC</span>
	       <span class="n">WTM_DEVICE_DESC</span>
	       <span class="n">SE_DEVICE_DESC</span>
	       <span class="n">QTET_DEVICE_DESC</span>
		<span class="s">&quot;{VIA,VT1720},&quot;</span>
		<span class="s">&quot;{VIA,VT1724},&quot;</span>
		<span class="s">&quot;{ICEnsemble,Generic ICE1724},&quot;</span>
		<span class="s">&quot;{ICEnsemble,Generic Envy24HT}&quot;</span>
		<span class="s">&quot;{ICEnsemble,Generic Envy24PT}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>		<span class="cm">/* Enable this card */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for ICE1724 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for ICE1724 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable ICE1724 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;Use the given board model.&quot;</span><span class="p">);</span>


<span class="cm">/* Both VT1720 and VT1724 have the same PCI IDs */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_vt1724_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ICE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_VT1724</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_vt1724_ids</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">PRO_RATE_LOCKED</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PRO_RATE_RESET</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">PRO_RATE_DEFAULT</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ext_clock_names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;IEC958 In&quot;</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Basic I/O</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  default rates, default clock routines</span>
<span class="cm"> */</span>

<span class="cm">/* check whether the clock mode is spdif-in */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">stdclock_is_spdif_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VT1724_SPDIF_MASTER</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * locking rate makes sense only for internal clock mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_pro_rate_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">PRO_RATE_LOCKED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ac97 section</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_vt1724_ac97_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tm</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tm</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="n">tm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">old_cmd</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VT1724_AC97_WRITE</span> <span class="o">|</span> <span class="n">VT1724_AC97_READ</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">old_cmd</span> <span class="o">&amp;</span> <span class="n">VT1724_AC97_READY</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">old_cmd</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd_vt1724_ac97_ready: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">old_cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_ac97_wait_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tm</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tm</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="n">tm</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd_vt1724_ac97_wait_bit: timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_vt1724_ac97_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_cmd</span><span class="p">;</span>

	<span class="n">old_cmd</span> <span class="o">=</span> <span class="n">snd_vt1724_ac97_ready</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">old_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VT1724_AC97_ID_MASK</span><span class="p">;</span>
	<span class="n">old_cmd</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_INDEX</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_DATA</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">old_cmd</span> <span class="o">|</span> <span class="n">VT1724_AC97_WRITE</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>
	<span class="n">snd_vt1724_ac97_wait_bit</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">VT1724_AC97_WRITE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_vt1724_ac97_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old_cmd</span><span class="p">;</span>

	<span class="n">old_cmd</span> <span class="o">=</span> <span class="n">snd_vt1724_ac97_ready</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">old_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VT1724_AC97_ID_MASK</span><span class="p">;</span>
	<span class="n">old_cmd</span> <span class="o">|=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_INDEX</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">old_cmd</span> <span class="o">|</span> <span class="n">VT1724_AC97_READ</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_vt1724_ac97_wait_bit</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">VT1724_AC97_READ</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_DATA</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * GPIO operations</span>
<span class="cm"> */</span>

<span class="cm">/* set gpio direction 0 = read, 1 = write */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_vt1724_set_gpio_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DIRECTION</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DIRECTION</span><span class="p">));</span> <span class="cm">/* dummy read for pci-posting */</span>
<span class="p">}</span>

<span class="cm">/* get gpio direction 0 = read, 1 = write */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_vt1724_get_gpio_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inl</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DIRECTION</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* set the gpio mask (0 = writable) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_vt1724_set_gpio_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_WRITE_MASK</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1720</span><span class="p">)</span> <span class="cm">/* VT1720 supports only 16 GPIO bits */</span>
		<span class="n">outb</span><span class="p">((</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_WRITE_MASK_22</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_WRITE_MASK</span><span class="p">));</span> <span class="cm">/* dummy read for pci-posting */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_vt1724_get_gpio_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1720</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_WRITE_MASK_22</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_WRITE_MASK</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_vt1724_set_gpio_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1720</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DATA_22</span><span class="p">));</span>
	<span class="n">inw</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">));</span> <span class="cm">/* dummy read for pci-posting */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">snd_vt1724_get_gpio_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1720</span><span class="p">)</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DATA_22</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MIDI</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_midi_clear_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_RXFIFO</span><span class="p">));</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">count</span><span class="p">)</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_DATA</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span>
<span class="nf">get_rawmidi_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">stream</span><span class="p">].</span><span class="n">substreams</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">enable_midi_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_midi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">get_rawmidi_substream</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_TXFIFO</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">snd_rawmidi_transmit</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_DATA</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* mask irq when all bytes have been transmitted.</span>
<span class="cm">	 * enabled again in output_trigger when the new data comes in.</span>
<span class="cm">	 */</span>
	<span class="n">enable_midi_irq</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">,</span>
			<span class="o">!</span><span class="n">snd_rawmidi_transmit_empty</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_midi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">get_rawmidi_substream</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_RXFIFO</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_DATA</span><span class="p">));</span>
		<span class="n">snd_rawmidi_receive</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* call with ice-&gt;reg_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_midi_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQMASK</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">flag</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQMASK</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_enable_midi_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">enable_midi_irq</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1724_midi_output_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1724_midi_output_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_midi_output_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vt1724_midi_write</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">midi_output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">enable_midi_irq</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_midi_output_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">vt1724_enable_midi_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* 32 bytes should be transmitted in less than about 12 ms */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VT1724_MPU_TX_EMPTY</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">vt1724_midi_output_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">vt1724_midi_output_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">vt1724_midi_output_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">vt1724_midi_output_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">drain</span> <span class="o">=</span> <span class="n">vt1724_midi_output_drain</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1724_midi_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vt1724_midi_clear_rx</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">vt1724_enable_midi_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_RX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt1724_midi_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vt1724_enable_midi_irq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_RX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vt1724_midi_input_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vt1724_midi_read</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">midi_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">vt1724_midi_input_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">vt1724_midi_input_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">vt1724_midi_input_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">vt1724_midi_input_trigger</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_vt1724_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status_mask</span> <span class="o">=</span>
		<span class="n">VT1724_IRQ_MPU_RX</span> <span class="o">|</span> <span class="n">VT1724_IRQ_MPU_TX</span> <span class="o">|</span> <span class="n">VT1724_IRQ_MTPCM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQSTAT</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">status_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQSTAT</span><span class="p">));</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ice1724: Too long irq loop, &quot;</span>
			       <span class="s">&quot;status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ice1724: Disabling MPU_TX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">enable_midi_irq</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">midi_output</span><span class="p">)</span>
				<span class="n">vt1724_midi_write</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">enable_midi_irq</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">VT1724_IRQ_MPU_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* Due to mysterical reasons, MPU_TX is always</span>
<span class="cm">			 * generated (and can&#39;t be cleared) when a PCM</span>
<span class="cm">			 * playback is going.  So let&#39;s ignore at the</span>
<span class="cm">			 * next loop.</span>
<span class="cm">			 */</span>
			<span class="n">status_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VT1724_IRQ_MPU_TX</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VT1724_IRQ_MPU_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">midi_input</span><span class="p">)</span>
				<span class="n">vt1724_midi_read</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">vt1724_midi_clear_rx</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* ack MPU irq */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQSTAT</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VT1724_IRQ_MTPCM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Multi-track PCM</span>
<span class="cm">			 * PCM assignment are:</span>
<span class="cm">			 * Playback DMA0 (M/C) = playback_pro_substream</span>
<span class="cm">			 * Playback DMA1 = playback_con_substream_ds[0]</span>
<span class="cm">			 * Playback DMA2 = playback_con_substream_ds[1]</span>
<span class="cm">			 * Playback DMA3 = playback_con_substream_ds[2]</span>
<span class="cm">			 * Playback DMA4 (SPDIF) = playback_con_substream</span>
<span class="cm">			 * Record DMA0 = capture_pro_substream</span>
<span class="cm">			 * Record DMA1 = capture_con_substream</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mtstat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_PDMA0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_pro_substream</span><span class="p">)</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_pro_substream</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_RDMA0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_pro_substream</span><span class="p">)</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_pro_substream</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_PDMA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_PDMA2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_PDMA3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_PDMA4</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream</span><span class="p">)</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_RDMA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_con_substream</span><span class="p">)</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_con_substream</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/* ack anyway to avoid freeze */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">mtstat</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">));</span>
			<span class="cm">/* ought to really handle this properly */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mtstat</span> <span class="o">&amp;</span> <span class="n">VT1724_MULTI_FIFO_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fstat</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_FIFO_ERR</span><span class="p">));</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">fstat</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_FIFO_ERR</span><span class="p">));</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">VT1724_MULTI_FIFO_ERR</span> <span class="o">|</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_INT_MASK</span><span class="p">)),</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_INT_MASK</span><span class="p">));</span>
				<span class="cm">/* If I don&#39;t do this, I get machine lockup due to continual interrupts */</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM code - professional part (multitrack)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">8000</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">11025</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span>
	<span class="mi">32000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span>
	<span class="mi">176400</span><span class="p">,</span> <span class="mi">192000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_rates_96</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* up to 96000 */</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_rates_48</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="cm">/* up to 48000 */</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_rates_192</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rates</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>	<span class="cm">/* ADDR register offset */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>	<span class="cm">/* SIZE register offset */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>	<span class="cm">/* COUNT register offset */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>	<span class="cm">/* start &amp; pause bit */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">what</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">what</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">ice</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="n">what</span> <span class="o">|=</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
			<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_PAUSE</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span><span class="p">)</span>
			<span class="n">old</span> <span class="o">|=</span> <span class="n">what</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">old</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">what</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_PAUSE</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_CONTROL</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span>
			<span class="n">old</span> <span class="o">|=</span> <span class="n">what</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">old</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">what</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_CONTROL</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="cm">/* apps will have to restart stream */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="cp">#define DMA_STARTS	(VT1724_RDMA0_START|VT1724_PDMA0_START|VT1724_RDMA1_START|\</span>
<span class="cp">	VT1724_PDMA1_START|VT1724_PDMA2_START|VT1724_PDMA3_START|VT1724_PDMA4_START)</span>
<span class="cp">#define DMA_PAUSES	(VT1724_RDMA0_PAUSE|VT1724_PDMA0_PAUSE|VT1724_RDMA1_PAUSE|\</span>
<span class="cp">	VT1724_PDMA1_PAUSE|VT1724_PDMA2_PAUSE|VT1724_PDMA3_PAUSE|VT1724_PDMA4_PAUSE)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stdclock_rate_list</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">48000</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="mi">9600</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span>
	<span class="mi">22050</span><span class="p">,</span> <span class="mi">11025</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">192000</span><span class="p">,</span> <span class="mi">64000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">stdclock_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">stdclock_rate_list</span><span class="p">[</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stdclock_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stdclock_rate_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stdclock_rate_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">stdclock_set_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="n">old</span><span class="p">;</span>
	<span class="cm">/* check MT02 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_PRO_I2S</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2S_FORMAT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">96000</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">VT1724_MT_I2S_MCLK_128X</span><span class="p">;</span> <span class="cm">/* 128x MCLK */</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VT1724_MT_I2S_MCLK_128X</span><span class="p">;</span> <span class="cm">/* 256x MCLK */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2S_FORMAT</span><span class="p">));</span>
			<span class="cm">/* master clock changed */</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* no change in master clock */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mclk_change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">old_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_CONTROL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DMA_STARTS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_PAUSE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">DMA_PAUSES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* running? we cannot change the rate now... */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">rate</span> <span class="o">==</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">cur_rate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="n">is_pro_rate_locked</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* comparing required and current rate - makes sense for</span>
<span class="cm">		 * internal clock only */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">cur_rate</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span> <span class="o">||</span> <span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* force means the rate was switched by ucontrol, otherwise</span>
<span class="cm">		 * setting clock rate for internal clock mode */</span>
		<span class="n">old_rate</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force</span> <span class="o">||</span> <span class="p">(</span><span class="n">old_rate</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">))</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">cur_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">cur_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* setting master clock */</span>
	<span class="n">mclk_change</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_mclk</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mclk_change</span> <span class="o">&amp;&amp;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">i2s_mclk_changed</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">i2s_mclk_changed</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_pro_rate</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* set up codecs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rate_val</span><span class="p">)</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rate_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_rate</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">setup_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chs</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chs</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="cm">/* mark surround channels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span> <span class="o">==</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_pro_substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PDMA0 can be multi-channel up to 8 */</span>
		<span class="n">chs</span> <span class="o">=</span> <span class="n">chs</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">substream</span><span class="p">)</span>
				<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* check individual playback stream */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="cm">/* unmark surround channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">substream</span><span class="p">)</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_pro_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">BURST</span><span class="p">));</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">PLAYBACK_ADDR</span><span class="p">));</span>

	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* outl(size, ICEMT1724(ice, PLAYBACK_SIZE)); */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">PLAYBACK_SIZE</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">PLAYBACK_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* outl(size, ICEMT1724(ice, PLAYBACK_COUNT)); */</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">PLAYBACK_COUNT</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">PLAYBACK_COUNT</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	printk(KERN_DEBUG &quot;pro prepare: ch = %d, addr = 0x%x, &quot;</span>
<span class="cm">	       &quot;buffer = 0x%x, period = 0x%x\n&quot;,</span>
<span class="cm">	       substream-&gt;runtime-&gt;channels,</span>
<span class="cm">	       (unsigned int)substream-&gt;runtime-&gt;dma_addr,</span>
<span class="cm">	       snd_pcm_lib_buffer_bytes(substream),</span>
<span class="cm">	       snd_pcm_lib_period_bytes(substream));</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_vt1724_playback_pro_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_CONTROL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VT1724_PDMA0_START</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"> /* read PLAYBACK_ADDR */</span>
<span class="c">	ptr = inl(ICEMT1724(ice, PLAYBACK_ADDR));</span>
<span class="c">	if (ptr &lt; substream-&gt;runtime-&gt;dma_addr) {</span>
<span class="c">		snd_printd(&quot;ice1724: invalid negative ptr\n&quot;);</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="c">	ptr -= substream-&gt;runtime-&gt;dma_addr;</span>
<span class="c">	ptr = bytes_to_frames(substream-&gt;runtime, ptr);</span>
<span class="c">	if (ptr &gt;= substream-&gt;runtime-&gt;buffer_size) {</span>
<span class="c">		snd_printd(&quot;ice1724: invalid ptr %d (size=%d)\n&quot;,</span>
<span class="c">			   (int)ptr, (int)substream-&gt;runtime-&gt;period_size);</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="cp">#else /* read PLAYBACK_SIZE */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">PLAYBACK_SIZE</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;ice1724: invalid ptr %d (size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">profi_port</span> <span class="o">+</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	     <span class="n">ice</span><span class="o">-&gt;</span><span class="n">profi_port</span> <span class="o">+</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">outw</span><span class="p">((</span><span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
	     <span class="n">ice</span><span class="o">-&gt;</span><span class="n">profi_port</span> <span class="o">+</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_vt1724_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_CONTROL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"> /* use ADDR register */</span>
<span class="c">	ptr = inl(ice-&gt;profi_port + reg-&gt;addr);</span>
<span class="c">	ptr -= substream-&gt;runtime-&gt;dma_addr;</span>
<span class="c">	return bytes_to_frames(substream-&gt;runtime, ptr);</span>
<span class="cp">#else /* use SIZE register */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">profi_port</span> <span class="o">+</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;ice1724: invalid ptr %d (size=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="n">vt1724_pdma0_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_PLAYBACK_ADDR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_PLAYBACK_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_PLAYBACK_COUNT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_PDMA0_START</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="n">vt1724_pdma4_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA4_ADDR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA4_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA4_COUNT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_PDMA4_START</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="n">vt1724_rdma0_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_CAPTURE_ADDR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_CAPTURE_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_CAPTURE_COUNT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_RDMA0_START</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="n">vt1724_rdma1_reg</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_RDMA1_ADDR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_RDMA1_SIZE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_RDMA1_COUNT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_RDMA1_START</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define vt1724_playback_pro_reg vt1724_pdma0_reg</span>
<span class="cp">#define vt1724_playback_spdif_reg vt1724_pdma4_reg</span>
<span class="cp">#define vt1724_capture_pro_reg vt1724_rdma0_reg</span>
<span class="cp">#define vt1724_capture_spdif_reg vt1724_rdma1_reg</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vt1724_playback_pro</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">),</span>	<span class="cm">/* 19bits dword */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>	<span class="cm">/* FIXME: constraints needed */</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vt1724_spdif</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>	        <span class="p">(</span><span class="n">SNDRV_PCM_RATE_32000</span><span class="o">|</span><span class="n">SNDRV_PCM_RATE_44100</span><span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_48000</span><span class="o">|</span><span class="n">SNDRV_PCM_RATE_88200</span><span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_96000</span><span class="o">|</span><span class="n">SNDRV_PCM_RATE_176400</span><span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_192000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span>	<span class="cm">/* 16bits dword */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vt1724_2ch_stereo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span>	<span class="cm">/* 16bits dword */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * set rate constraints</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_std_hw_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_PRO_I2S</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* I2S */</span>
		<span class="cm">/* VT1720 doesn&#39;t support more than 96kHz */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_I2S</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1720</span><span class="p">)</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_constraints_rates_192</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_constraints_rates_96</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ACLINK */</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw_constraints_rates_48</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rate_constraints</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
					  <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* if the card has the internal rate locked (is_pro_locked), limit runtime</span>
<span class="cm">   hw rates to the current internal rate only.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">constrain_rate_if_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_pro_rate_locked</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span>
		    <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* multi-channel playback needs alignment 8x32bit regardless of the channels</span>
<span class="cm"> * actually used</span>
<span class="cm"> */</span>
<span class="cp">#define VT1724_BUFFER_ALIGN	0x20</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_pro_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chs</span><span class="p">,</span> <span class="n">num_indeps</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vt1724_playback_pro_reg</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_pro_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_playback_pro</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">set_rate_constraints</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="cm">/* calculate the currently available channels */</span>
	<span class="n">num_indeps</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_dacs</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chs</span> <span class="o">&lt;</span> <span class="n">num_indeps</span><span class="p">;</span> <span class="n">chs</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">chs</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chs</span> <span class="o">=</span> <span class="p">(</span><span class="n">chs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">chs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chs</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* channels must be even */</span>
		<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">constrain_rate_if_locked</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_open</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_open</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_capture_pro_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vt1724_capture_pro_reg</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_pro_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_2ch_stereo</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">set_rate_constraints</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">constrain_rate_if_locked</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_open</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_open</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_pro_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PRO_RATE_RESET</span><span class="p">)</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_pro_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_capture_pro_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PRO_RATE_RESET</span><span class="p">)</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_pro_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_vt1724_playback_pro_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_vt1724_playback_pro_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_pro_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_pro_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_pro_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_vt1724_capture_pro_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_vt1724_capture_pro_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_vt1724_capture_pro_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_pcm_profi</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">capt</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_ADC_MASK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">VT1724_CFG_ADC_NONE</span><span class="p">)</span>
		<span class="n">capt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">capt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ICE1724&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">capt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_vt1724_playback_pro_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capt</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_vt1724_capture_pro_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ICE1724&quot;</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_pro</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * SPDIF PCM</span>
<span class="cm"> */</span>

<span class="cm">/* update spdif control bits; call with reg_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_spdif_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cbit</span><span class="p">,</span> <span class="n">disabled</span><span class="p">;</span>

	<span class="n">cbit</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">disabled</span> <span class="o">=</span> <span class="n">cbit</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VT1724_CFG_SPDIF_OUT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbit</span> <span class="o">!=</span> <span class="n">disabled</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">disabled</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CTRL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cbit</span> <span class="o">!=</span> <span class="n">disabled</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">cbit</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CTRL</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* update SPDIF control bits according to the given rate */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_spdif_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">nval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">nval</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">nval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">44100</span>: <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>: <span class="n">nval</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>: <span class="n">nval</span> <span class="o">|=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>: <span class="n">nval</span> <span class="o">|=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>: <span class="n">nval</span> <span class="o">|=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192000</span>: <span class="n">nval</span> <span class="o">|=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">176400</span>: <span class="n">nval</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">nval</span><span class="p">)</span>
		<span class="n">update_spdif_bits</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">nval</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_spdif_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_pdma4</span><span class="p">)</span>
		<span class="n">update_spdif_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_vt1724_pcm_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_spdif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vt1724_playback_spdif_reg</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_pdma4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_2ch_stereo</span><span class="p">;</span>
		<span class="n">set_rate_constraints</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_spdif</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">constrain_rate_if_locked</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_spdif_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PRO_RATE_RESET</span><span class="p">)</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">close</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_capture_spdif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vt1724_capture_spdif_reg</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_con_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_rdma1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_2ch_stereo</span><span class="p">;</span>
		<span class="n">set_rate_constraints</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_spdif</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span>
				   <span class="n">VT1724_BUFFER_ALIGN</span><span class="p">);</span>
	<span class="n">constrain_rate_if_locked</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_capture_spdif_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PRO_RATE_RESET</span><span class="p">)</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">capture_con_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">close</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_vt1724_playback_spdif_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_vt1724_playback_spdif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_spdif_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_spdif_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_vt1724_capture_spdif_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_vt1724_capture_spdif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_vt1724_capture_spdif_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_pcm_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">play</span><span class="p">,</span> <span class="n">capt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_pdma4</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_SPDIF_OUT_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">play</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">has_spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">play</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_rdma1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_SPDIF_IN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">capt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">has_spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">capt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">play</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">capt</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no spdif device */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_pdma4</span> <span class="o">||</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_rdma1</span><span class="p">)</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ICE1724 Secondary&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ICE1724 IEC958&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">play</span><span class="p">,</span> <span class="n">capt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">play</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">snd_vt1724_playback_spdif_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capt</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">snd_vt1724_capture_spdif_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * independent surround PCMs</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vt1724_pcm_reg</span> <span class="n">vt1724_playback_dma_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA1_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA1_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA1_COUNT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_PDMA1_START</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA2_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA2_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA2_COUNT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_PDMA2_START</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA3_ADDR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA3_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">VT1724_MT_PDMA3_COUNT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">VT1724_PDMA3_START</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_indep_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">BURST</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">BURST</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_vt1724_pcm_prepare</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_indep_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="cm">/* already used by PDMA0? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* FIXME: should handle blocking mode properly */</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vt1724_playback_dma_regs</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vt1724_2ch_stereo</span><span class="p">;</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">set_rate_constraints</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_playback_indep_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PRO_RATE_RESET</span><span class="p">)</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">playback_con_substream_ds</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_reserved</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_vt1724_playback_indep_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_vt1724_playback_indep_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_indep_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_vt1724_playback_indep_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_vt1724_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_pcm_indep</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">play</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">play</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_dacs</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">play</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ICE1724 Surrounds&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">play</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_vt1724_playback_indep_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ICE1724 Surround PCM&quot;</span><span class="p">);</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_ds</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Mixer section</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_ac97_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_PRO_I2S</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_vt1724_ac97_write</span><span class="p">,</span>
			<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_vt1724_ac97_read</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="cm">/* cold reset */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="cm">/* FIXME */</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
		<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ice1712: cannot initialize pro ac97, skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* I2S mixer only */</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;ICE1724 - multitrack&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">eeprom_triple</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">|</span> \
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> \
		<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_vt1724_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;EEPROM:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Subvendor        : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Size             : %i bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Version          : %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  System Config    : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  ACLink           : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  I2S              : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_I2S</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  S/PDIF           : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  GPIO direction   : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiodir</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  GPIO mask        : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiomask</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  GPIO state       : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiostate</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Extra #%02i        : 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">idx</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Registers:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  PSDOUT03 : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ROUTE_PLAYBACK</span><span class="p">)));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  CCS%02x    : 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">idx</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">port</span><span class="o">+</span><span class="n">idx</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mh">0x30</span> <span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  MT%02x     : 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">idx</span><span class="p">,</span> <span class="n">inb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">profi_port</span><span class="o">+</span><span class="n">idx</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ice1724&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ice</span><span class="p">,</span> <span class="n">snd_vt1724_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_eeprom_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BYTES</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712_eeprom</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_eeprom_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_eeprom</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_CARD</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ICE1724 EEPROM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_eeprom_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_eeprom_get</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">encode_spdif_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_aes_iec958</span> <span class="o">*</span><span class="n">diga</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">rbits</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* professional, non-audio */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* professional */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PRO_EMPHASIS</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">rbits</span> <span class="o">=</span> <span class="p">(</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">rbits</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 96k */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 192k */</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 88.2k */</span>
			<span class="k">case</span> <span class="mi">11</span>: <span class="n">val</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* 176.4k */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PRO_FS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IEC958_AES0_PRO_FS_44100</span>:
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IEC958_AES0_PRO_FS_32000</span>:
				<span class="n">val</span> <span class="o">|=</span> <span class="mi">3U</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="mi">2U</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* consumer */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* copyright */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_CON_EMPHASIS</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* category */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="cm">/* fs */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_spdif_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_aes_iec958</span> <span class="o">*</span><span class="n">diga</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* professional, non-audio */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* professional */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IEC958_AES0_PRO_FS_32000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IEC958_AES0_PRO_FS_48000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* consumer */</span>
		<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* copyright */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="p">;</span>
		<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span> <span class="cm">/* category */</span>
		<span class="n">diga</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span> <span class="cm">/* fs */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_default_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">decode_spdif_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_default_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">encode_spdif_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CTRL</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span>
		<span class="n">update_spdif_bits</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">old</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_spdif_default</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_default_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_default_put</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_maskc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
						     <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
						     <span class="n">IEC958_AES0_CON_NOT_COPYRIGHT</span> <span class="o">|</span>
						     <span class="n">IEC958_AES0_CON_EMPHASIS</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES1_CON_ORIGINAL</span> <span class="o">|</span>
						     <span class="n">IEC958_AES1_CON_CATEGORY</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_maskp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
						     <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
						     <span class="n">IEC958_AES0_PRO_FS</span> <span class="o">|</span>
						     <span class="n">IEC958_AES0_PRO_EMPHASIS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_spdif_maskc</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">CON_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_maskc_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_spdif_maskp</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">PRO_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_maskp_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define snd_vt1724_spdif_sw_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_sw_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">))</span> <span class="o">&amp;</span>
		<span class="n">VT1724_CFG_SPDIF_OUT_EN</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_spdif_sw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VT1724_CFG_SPDIF_OUT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VT1724_CFG_SPDIF_OUT_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_spdif_switch</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="cm">/* FIXME: the following conflict with IEC958 Playback Route */</span>
	<span class="cm">/* .name =         SNDRV_CTL_NAME_IEC958(&quot;&quot;, PLAYBACK, SWITCH), */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Output &quot;</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_sw_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_sw_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_vt1724_spdif_sw_put</span>
<span class="p">};</span>


<span class="cp">#if 0</span><span class="c"> /* NOT USED YET */</span>
<span class="c">/*</span>
<span class="c"> * GPIO access from extern</span>
<span class="c"> */</span>

<span class="c">#define snd_vt1724_gpio_info		snd_ctl_boolean_mono_info</span>

<span class="c">int snd_vt1724_gpio_get(struct snd_kcontrol *kcontrol,</span>
<span class="c">			struct snd_ctl_elem_value *ucontrol)</span>
<span class="c">{</span>
<span class="c">	struct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);</span>
<span class="c">	int shift = kcontrol-&gt;private_value &amp; 0xff;</span>
<span class="c">	int invert = (kcontrol-&gt;private_value &amp; (1&lt;&lt;24)) ? 1 : 0;</span>

<span class="c">	snd_ice1712_save_gpio_status(ice);</span>
<span class="c">	ucontrol-&gt;value.integer.value[0] =</span>
<span class="c">		(snd_ice1712_gpio_read(ice) &amp; (1 &lt;&lt; shift) ? 1 : 0) ^ invert;</span>
<span class="c">	snd_ice1712_restore_gpio_status(ice);</span>
<span class="c">	return 0;</span>
<span class="c">}</span>

<span class="c">int snd_ice1712_gpio_put(struct snd_kcontrol *kcontrol,</span>
<span class="c">			 struct snd_ctl_elem_value *ucontrol)</span>
<span class="c">{</span>
<span class="c">	struct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);</span>
<span class="c">	int shift = kcontrol-&gt;private_value &amp; 0xff;</span>
<span class="c">	int invert = (kcontrol-&gt;private_value &amp; (1&lt;&lt;24)) ? mask : 0;</span>
<span class="c">	unsigned int val, nval;</span>

<span class="c">	if (kcontrol-&gt;private_value &amp; (1 &lt;&lt; 31))</span>
<span class="c">		return -EPERM;</span>
<span class="c">	nval = (ucontrol-&gt;value.integer.value[0] ? (1 &lt;&lt; shift) : 0) ^ invert;</span>
<span class="c">	snd_ice1712_save_gpio_status(ice);</span>
<span class="c">	val = snd_ice1712_gpio_read(ice);</span>
<span class="c">	nval |= val &amp; ~(1 &lt;&lt; shift);</span>
<span class="c">	if (val != nval)</span>
<span class="c">		snd_ice1712_gpio_write(ice, nval);</span>
<span class="c">	snd_ice1712_restore_gpio_status(ice);</span>
<span class="c">	return val != nval;</span>
<span class="c">}</span>
<span class="cp">#endif /* NOT USED YET */</span>

<span class="cm">/*</span>
<span class="cm"> *  rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_internal_clock_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">hw_rates_count</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* internal clocks */</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">hw_rates_count</span><span class="p">;</span>
	<span class="cm">/* external clocks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">force_rdma1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_SPDIF_IN</span><span class="p">))</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">+=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_count</span><span class="p">;</span>
	<span class="cm">/* upper limit - keep at top */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">hw_rates_count</span><span class="p">)</span>
		<span class="cm">/* ext_clock items */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_names</span><span class="p">[</span>
				<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">-</span> <span class="n">hw_rates_count</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="cm">/* int clock items */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_internal_clock_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_spdif_master_type</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stdclock_get_spdif_master_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* standard external clock - only single type - SPDIF IN */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setting clock to external - SPDIF */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stdclock_set_spdif_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i2s_oval</span><span class="p">;</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">oval</span> <span class="o">|</span> <span class="n">VT1724_SPDIF_MASTER</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
	<span class="cm">/* setting 256fs */</span>
	<span class="n">i2s_oval</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2S_FORMAT</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">i2s_oval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VT1724_MT_I2S_MCLK_128X</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2S_FORMAT</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_internal_clock_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_rate</span><span class="p">,</span> <span class="n">new_rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">item</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first_ext_clock</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="o">&gt;</span>  <span class="n">first_ext_clock</span> <span class="o">+</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* if rate = 0 =&gt; external clock */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span>
		<span class="n">old_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">old_rate</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">first_ext_clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switching to external clock */</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_spdif_clock</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">item</span> <span class="o">-</span> <span class="n">first_ext_clock</span><span class="p">);</span>
		<span class="n">new_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* internal on-card clock */</span>
		<span class="n">new_rate</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">[</span><span class="n">item</span><span class="p">];</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span> <span class="o">=</span> <span class="n">new_rate</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="cm">/* the first switch to the ext. clock mode? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_rate</span> <span class="o">!=</span> <span class="n">new_rate</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">new_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* notify akm chips as well */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_pro_rate</span><span class="p">)</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rate_val</span><span class="p">)</span>
				<span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ops</span><span class="p">.</span><span class="n">set_rate_val</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">old_rate</span> <span class="o">!=</span> <span class="n">new_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_pro_internal_clock</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi Track Internal Clock&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_internal_clock_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_internal_clock_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_internal_clock_put</span>
<span class="p">};</span>

<span class="cp">#define snd_vt1724_pro_rate_locking_info	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_rate_locking_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRO_RATE_LOCKED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_rate_locking_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nval</span><span class="p">;</span>

	<span class="n">nval</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">PRO_RATE_LOCKED</span> <span class="o">!=</span> <span class="n">nval</span><span class="p">;</span>
	<span class="n">PRO_RATE_LOCKED</span> <span class="o">=</span> <span class="n">nval</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_pro_rate_locking</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi Track Rate Locking&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_rate_locking_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_rate_locking_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_rate_locking_put</span>
<span class="p">};</span>

<span class="cp">#define snd_vt1724_pro_rate_reset_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_rate_reset_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRO_RATE_RESET</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_rate_reset_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nval</span><span class="p">;</span>

	<span class="n">nval</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">PRO_RATE_RESET</span> <span class="o">!=</span> <span class="n">nval</span><span class="p">;</span>
	<span class="n">PRO_RATE_RESET</span> <span class="o">=</span> <span class="n">nval</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_pro_rate_reset</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi Track Rate Reset&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_rate_reset_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_rate_reset_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_rate_reset_put</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * routing</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_route_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;PCM Out&quot;</span><span class="p">,</span> <span class="cm">/* 0 */</span>
		<span class="s">&quot;H/W In 0&quot;</span><span class="p">,</span> <span class="s">&quot;H/W In 1&quot;</span><span class="p">,</span> <span class="cm">/* 1-2 */</span>
		<span class="s">&quot;IEC958 In L&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958 In R&quot;</span><span class="p">,</span> <span class="cm">/* 3-4 */</span>
	<span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">analog_route_shift</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">idx</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span> <span class="o">+</span> <span class="p">((</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">digital_route_shift</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idx</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_ice1724_get_route_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">eitem</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xlate</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ROUTE_PLAYBACK</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* we now have 3 bits per output */</span>
	<span class="n">eitem</span> <span class="o">=</span> <span class="n">xlate</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eitem</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">eitem</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_ice1724_put_route_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
								<span class="kt">int</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_val</span><span class="p">,</span> <span class="n">nval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xroute</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="cm">/* PCM */</span>
		<span class="mi">2</span><span class="p">,</span> <span class="cm">/* PSDIN0 Left */</span>
		<span class="mi">3</span><span class="p">,</span> <span class="cm">/* PSDIN0 Right */</span>
		<span class="mi">6</span><span class="p">,</span> <span class="cm">/* SPDIN Left */</span>
		<span class="mi">7</span><span class="p">,</span> <span class="cm">/* SPDIN Right */</span>
	<span class="p">};</span>

	<span class="n">nval</span> <span class="o">=</span> <span class="n">xroute</span><span class="p">[</span><span class="n">val</span> <span class="o">%</span> <span class="mi">5</span><span class="p">];</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">old_val</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ROUTE_PLAYBACK</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x07</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">nval</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">old_val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ROUTE_PLAYBACK</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_route_analog_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">snd_ctl_get_ioffidx</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">snd_ice1724_get_route_val</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">analog_route_shift</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_route_analog_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">snd_ctl_get_ioffidx</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ice1724_put_route_val</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span>
					 <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">analog_route_shift</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_route_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">snd_ctl_get_ioffidx</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">snd_ice1724_get_route_val</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">digital_route_shift</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_route_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">snd_ctl_get_ioffidx</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ice1724_put_route_val</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span>
					 <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					 <span class="n">digital_route_shift</span><span class="p">(</span><span class="n">idx</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_mixer_pro_analog_route</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;H/W Playback Route&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_route_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_route_analog_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_route_analog_put</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_mixer_pro_spdif_route</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span> <span class="n">NONE</span><span class="p">)</span> <span class="s">&quot;Route&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_route_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_route_spdif_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_route_spdif_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_peak_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="cm">/* FIXME: for compatibility with ice1712... */</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_pro_peak_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MONITOR_PEAKINDEX</span><span class="p">));</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MONITOR_PEAKDATA</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vt1724_mixer_pro_peak</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Multi Track Peak&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_VOLATILE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_peak_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vt1724_pro_peak_get</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="n">no_matched</span> <span class="n">__devinitdata</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm">  ooAoo cards with no controls</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ooaoo_sq210_eeprom</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x4c</span><span class="p">,</span>	<span class="cm">/* 49MHz crystal, no mpu401, no ADC,</span>
<span class="cm">					   1xDACs */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]</span>      <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/* I2S */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_I2S</span><span class="p">]</span>         <span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>	<span class="cm">/* no volume, 96k, 24bit, 192k */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]</span>       <span class="o">=</span> <span class="mh">0xc1</span><span class="p">,</span>	<span class="cm">/* out-en, out-int, out-ext */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR</span><span class="p">]</span>    <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* no GPIOs are used */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR1</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR2</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK2</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>

	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* inputs */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* all 1, but GPIO_CPLD_RW</span>
<span class="cm">					  and GPIO15 always zero */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* inputs */</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="n">snd_vt1724_ooaoo_cards</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ooAoo SQ210a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="s">&quot;sq210a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">eeprom_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ooaoo_sq210_eeprom</span><span class="p">),</span>
		<span class="p">.</span><span class="n">eeprom_data</span> <span class="o">=</span> <span class="n">ooaoo_sq210_eeprom</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="o">*</span><span class="n">card_tables</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">snd_vt1724_revo_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_amp_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_aureon_cards</span><span class="p">,</span>
	<span class="n">snd_vt1720_mobo_cards</span><span class="p">,</span>
	<span class="n">snd_vt1720_pontis_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_prodigy_hifi_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_prodigy192_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_juli_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_maya44_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_phase_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_wtm_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_se_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_qtet_cards</span><span class="p">,</span>
	<span class="n">snd_vt1724_ooaoo_cards</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_i2c_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VT1724_I2C_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">t</span><span class="o">--</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ice1724: i2c busy timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_vt1724_read_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="n">wait_i2c_busy</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_BYTE_ADDR</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VT1724_I2C_WRITE</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_DEV_ADDR</span><span class="p">));</span>
	<span class="n">wait_i2c_busy</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_DATA</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	printk(KERN_DEBUG &quot;i2c_read: [0x%x,0x%x] = 0x%x\n&quot;, dev, addr, val);</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">snd_vt1724_write_i2c</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="n">wait_i2c_busy</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	printk(KERN_DEBUG &quot;i2c_write: [0x%x,0x%x] = 0x%x\n&quot;, dev, addr, data);</span>
<span class="cm">	*/</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_BYTE_ADDR</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_DATA</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">dev</span> <span class="o">|</span> <span class="n">VT1724_I2C_WRITE</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_DEV_ADDR</span><span class="p">));</span>
	<span class="n">wait_i2c_busy</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modelname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>		<span class="cm">/* EEPROM device address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modelname</span> <span class="o">||</span> <span class="o">!*</span><span class="n">modelname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2C_CTRL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">VT1724_I2C_EEPROM</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* invalid subvendor from EEPROM, try the PCI</span>
<span class="cm">			 * subststem ID instead</span>
<span class="cm">			 */</span>
			<span class="n">u16</span> <span class="n">vendor</span><span class="p">,</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_VENDOR_ID</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">vendor</span><span class="p">);</span>
			<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SUBSYSTEM_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">swab16</span><span class="p">(</span><span class="n">vendor</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">swab16</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ice1724: No valid ID is found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">card_tables</span><span class="p">;</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span> <span class="n">tbl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">modelname</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">modelname</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ice1724: Using board model %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">subvendor</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">!=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">eeprom_size</span> <span class="o">||</span> <span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">eeprom_data</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="cm">/* if the EEPROM is given by the driver, use it */</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;using the defined eeprom..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">eeprom_size</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">eeprom_data</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">eeprom_size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">read_skipped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ice1724: No matching model found for ID 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span><span class="p">);</span>

 <span class="nl">found:</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ice1724: Invalid EEPROM (size = %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ice1724: Invalid EEPROM version %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_vt1724_read_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>

 <span class="nl">read_skipped:</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiomask</span> <span class="o">=</span> <span class="n">eeprom_triple</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ICE_EEP2_GPIO_MASK</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiostate</span> <span class="o">=</span> <span class="n">eeprom_triple</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ICE_EEP2_GPIO_STATE</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiodir</span> <span class="o">=</span> <span class="n">eeprom_triple</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ICE_EEP2_GPIO_DIR</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_vt1724_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VT1724_RESET</span> <span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span> <span class="cm">/* pci posting flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">CONTROL</span><span class="p">));</span> <span class="cm">/* pci posting flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">],</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SYS_CFG</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">],</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CFG</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_I2S</span><span class="p">],</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">I2S_FEATURES</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">],</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">write_mask</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiomask</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiodir</span><span class="p">;</span>
	<span class="n">snd_vt1724_set_gpio_mask</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiomask</span><span class="p">);</span>
	<span class="n">snd_vt1724_set_gpio_dir</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiodir</span><span class="p">);</span>
	<span class="n">snd_vt1724_set_gpio_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">gpiostate</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">POWERDOWN</span><span class="p">));</span>

	<span class="cm">/* MPU_RX and TX irq masks are cleared later dynamically */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VT1724_IRQ_MPU_RX</span> <span class="o">|</span> <span class="n">VT1724_IRQ_MPU_TX</span> <span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQMASK</span><span class="p">));</span>

	<span class="cm">/* don&#39;t handle FIFO overrun/underruns (just yet),</span>
<span class="cm">	 * since they cause machine lockups</span>
<span class="cm">	 */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">VT1724_MULTI_FIFO_ERR</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_INT_MASK</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_spdif_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">own_routing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
			<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_mixer_pro_spdif_route</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_spdif_switch</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_spdif_default</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_spdif_maskc</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_spdif_maskp</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"> /* use default only */</span>
<span class="c">	err = snd_ctl_add(ice-&gt;card, kctl = snd_ctl_new1(&amp;snd_vt1724_spdif_stream, ice));</span>
<span class="c">	if (err &lt; 0)</span>
<span class="c">		return err;</span>
<span class="c">	kctl-&gt;id.device = ice-&gt;pcm-&gt;device;</span>
<span class="c">	ice-&gt;spdif.stream_ctl = kctl;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_build_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_eeprom</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_pro_internal_clock</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_pro_rate_locking</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_pro_rate_reset</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">own_routing</span> <span class="o">&amp;&amp;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_dacs</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_vt1724_mixer_pro_analog_route</span><span class="p">;</span>
		<span class="n">tmp</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_dacs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1720</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">tmp</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vt1724_mixer_pro_peak</span><span class="p">,</span> <span class="n">ice</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__hw_end</span><span class="p">;</span>
	<span class="cm">/* mask all interrupts */</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">DMA_INT_MASK</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">IRQMASK</span><span class="p">));</span>
	<span class="cm">/* --- */</span>
<span class="nl">__hw_end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ice</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_ice1712_akm4xxx_free</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_vt1724_free</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modelname</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">**</span><span class="n">r_ice1712</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_vt1724_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">r_ice1712</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ice</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ice</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">vt1724</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">open_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">i2c_mutex</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_mask</span> <span class="o">=</span> <span class="n">snd_vt1724_set_gpio_mask</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_mask</span> <span class="o">=</span> <span class="n">snd_vt1724_get_gpio_mask</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_dir</span> <span class="o">=</span> <span class="n">snd_vt1724_set_gpio_dir</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_dir</span> <span class="o">=</span> <span class="n">snd_vt1724_get_gpio_dir</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span> <span class="o">=</span> <span class="n">snd_vt1724_set_gpio_data</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span> <span class="o">=</span> <span class="n">snd_vt1724_get_gpio_data</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_vt1724_proc_init</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;ICE1724&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">profi_port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_vt1724_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">ice</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_vt1724_free</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">snd_vt1724_chip_reset</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_vt1724_read_eeprom</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">modelname</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_vt1724_free</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_vt1724_chip_init</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_vt1724_free</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">ice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_vt1724_free</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">r_ice1712</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Registration</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vt1724_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcm_dev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ICE1724&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;ICEnsemble ICE1724&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* field init before calling chip_init */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">card_tables</span><span class="p">;</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span> <span class="n">tbl</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">model</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">&amp;&amp;</span>
			     <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">subvendor</span> <span class="o">==</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">subvendor</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="cm">/* specific driver? */</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">chip_init</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">chip_init</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
						<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">__found</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">no_matched</span><span class="p">;</span>
<span class="nl">__found:</span>
	<span class="cm">/*</span>
<span class="cm">	* VT1724 has separate DMAs for the analog and the SPDIF streams while</span>
<span class="cm">	* ICE1712 has only one for both (mixed up).</span>
<span class="cm">	*</span>
<span class="cm">	* Confusingly the analog PCM is named &quot;professional&quot; here because it</span>
<span class="cm">	* was called so in ice1712 driver, and vt1724 driver is derived from</span>
<span class="cm">	* ice1712 driver.</span>
<span class="cm">	*/</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span> <span class="o">=</span> <span class="n">PRO_RATE_DEFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span> <span class="o">=</span> <span class="n">stdclock_is_spdif_master</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span> <span class="o">=</span> <span class="n">stdclock_get_rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_rate</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_rate</span> <span class="o">=</span> <span class="n">stdclock_set_rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_mclk</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_mclk</span> <span class="o">=</span> <span class="n">stdclock_set_mclk</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_spdif_clock</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_spdif_clock</span> <span class="o">=</span> <span class="n">stdclock_set_spdif_clock</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_spdif_master_type</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_spdif_master_type</span> <span class="o">=</span> <span class="n">stdclock_get_spdif_master_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_names</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_names</span> <span class="o">=</span> <span class="n">ext_clock_names</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_count</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ext_clock_names</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span><span class="p">)</span>
		<span class="n">set_std_hw_rates</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_pcm_profi</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">pcm_dev</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_pcm_spdif</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">pcm_dev</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_pcm_indep</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">pcm_dev</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_ac97_mixer</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_build_controls</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">&amp;&amp;</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">has_spdif</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* has SPDIF I/O */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_vt1724_spdif_build_controls</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">build_controls</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">build_controls</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">no_mpu401</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">VT1724_CFG_MPU401</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_rawmidi_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;MIDI&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rmidi</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmidi</span><span class="p">;</span>
			<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ICE1724 MIDI&quot;</span><span class="p">);</span>
			<span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_RAWMIDI_INFO_OUTPUT</span> <span class="o">|</span>
					    <span class="n">SNDRV_RAWMIDI_INFO_INPUT</span> <span class="o">|</span>
					    <span class="n">SNDRV_RAWMIDI_INFO_DUPLEX</span><span class="p">;</span>
			<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vt1724_midi_output_ops</span><span class="p">);</span>
			<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vt1724_midi_input_ops</span><span class="p">);</span>

			<span class="cm">/* set watermarks */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">VT1724_MPU_RX_FIFO</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">,</span>
			     <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_FIFO_WM</span><span class="p">));</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_FIFO_WM</span><span class="p">));</span>
			<span class="cm">/* set UART mode */</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">VT1724_MPU_UART</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">MPU_CTRL</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %i&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_vt1724_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_suspend_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>

	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_pro</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm_ds</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_is_spdif_master</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_spdif_ctrl</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CTRL</span><span class="p">));</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_spdif_cfg</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_route</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ROUTE_PLAYBACK</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_suspend</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_suspend</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vt1724_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_suspend_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">snd_vt1724_chip_reset</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_vt1724_chip_init</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_resume</span><span class="p">)</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_resume</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_is_spdif_master</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switching to external clock via SPDIF */</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_spdif_clock</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* internal on-card clock */</span>
		<span class="n">snd_vt1724_set_pro_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_rate_default</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">update_spdif_bits</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_spdif_ctrl</span><span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_spdif_cfg</span><span class="p">,</span> <span class="n">ICEREG1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SPDIF_CFG</span><span class="p">));</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_saved_route</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">ROUTE_PLAYBACK</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">)</span>
		<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">vt1724_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_vt1724_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_vt1724_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_vt1724_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">snd_vt1724_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">snd_vt1724_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">vt1724_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
