<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ice1712 › quartet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>quartet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for ICEnsemble VT1724 (Envy24HT)</span>
<span class="cm"> *</span>
<span class="cm"> *   Lowlevel functions for Infrasonic Quartet</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2009 Pavel Hofman &lt;pavel.hofman@ivitera.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>

<span class="cp">#include &quot;ice1712.h&quot;</span>
<span class="cp">#include &quot;envy24ht.h&quot;</span>
<span class="cp">#include &lt;sound/ak4113.h&gt;</span>
<span class="cp">#include &quot;quartet.h&quot;</span>

<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ak4113</span> <span class="o">*</span><span class="n">ak4113</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scr</span><span class="p">;</span>	<span class="cm">/* system control register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mcr</span><span class="p">;</span>	<span class="cm">/* monitoring control register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpld</span><span class="p">;</span>	<span class="cm">/* cpld register */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">qtet_kcontrol_private</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">set_register</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_register</span><span class="p">)(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">IN12_SEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">IN34_SEL</span><span class="p">,</span>
	<span class="n">AIN34_SEL</span><span class="p">,</span>
	<span class="n">COAX_OUT</span><span class="p">,</span>
	<span class="n">IN12_MON12</span><span class="p">,</span>
	<span class="n">IN12_MON34</span><span class="p">,</span>
	<span class="n">IN34_MON12</span><span class="p">,</span>
	<span class="n">IN34_MON34</span><span class="p">,</span>
	<span class="n">OUT12_MON34</span><span class="p">,</span>
	<span class="n">OUT34_MON12</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ext_clock_names</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;IEC958 In&quot;</span><span class="p">,</span> <span class="s">&quot;Word Clock 1xFS&quot;</span><span class="p">,</span>
	<span class="s">&quot;Word Clock 256xFS&quot;</span><span class="p">};</span>

<span class="cm">/* chip address on I2C bus */</span>
<span class="cp">#define AK4113_ADDR		0x26	</span><span class="cm">/* S/PDIF receiver */</span><span class="cp"></span>

<span class="cm">/* chip address on SPI bus */</span>
<span class="cp">#define AK4620_ADDR		0x02	</span><span class="cm">/* ADC/DAC */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * GPIO pins</span>
<span class="cm"> */</span>

<span class="cm">/* GPIO0 - O - DATA0, def. 0 */</span>
<span class="cp">#define GPIO_D0			(1&lt;&lt;0)</span>
<span class="cm">/* GPIO1 - I/O - DATA1, Jack Detect Input0 (0:present, 1:missing), def. 1 */</span>
<span class="cp">#define GPIO_D1_JACKDTC0	(1&lt;&lt;1)</span>
<span class="cm">/* GPIO2 - I/O - DATA2, Jack Detect Input1 (0:present, 1:missing), def. 1 */</span>
<span class="cp">#define GPIO_D2_JACKDTC1	(1&lt;&lt;2)</span>
<span class="cm">/* GPIO3 - I/O - DATA3, def. 1 */</span>
<span class="cp">#define GPIO_D3			(1&lt;&lt;3)</span>
<span class="cm">/* GPIO4 - I/O - DATA4, SPI CDTO, def. 1 */</span>
<span class="cp">#define GPIO_D4_SPI_CDTO	(1&lt;&lt;4)</span>
<span class="cm">/* GPIO5 - I/O - DATA5, SPI CCLK, def. 1 */</span>
<span class="cp">#define GPIO_D5_SPI_CCLK	(1&lt;&lt;5)</span>
<span class="cm">/* GPIO6 - I/O - DATA6, Cable Detect Input (0:detected, 1:not detected */</span>
<span class="cp">#define GPIO_D6_CD		(1&lt;&lt;6)</span>
<span class="cm">/* GPIO7 - I/O - DATA7, Device Detect Input (0:detected, 1:not detected */</span>
<span class="cp">#define GPIO_D7_DD		(1&lt;&lt;7)</span>
<span class="cm">/* GPIO8 - O - CPLD Chip Select, def. 1 */</span>
<span class="cp">#define GPIO_CPLD_CSN		(1&lt;&lt;8)</span>
<span class="cm">/* GPIO9 - O - CPLD register read/write (0:write, 1:read), def. 0 */</span>
<span class="cp">#define GPIO_CPLD_RW		(1&lt;&lt;9)</span>
<span class="cm">/* GPIO10 - O - SPI Chip Select for CODEC#0, def. 1 */</span>
<span class="cp">#define GPIO_SPI_CSN0		(1&lt;&lt;10)</span>
<span class="cm">/* GPIO11 - O - SPI Chip Select for CODEC#1, def. 1 */</span>
<span class="cp">#define GPIO_SPI_CSN1		(1&lt;&lt;11)</span>
<span class="cm">/* GPIO12 - O - Ex. Register Output Enable (0:enable, 1:disable), def. 1,</span>
<span class="cm"> * init 0 */</span>
<span class="cp">#define GPIO_EX_GPIOE		(1&lt;&lt;12)</span>
<span class="cm">/* GPIO13 - O - Ex. Register0 Chip Select for System Control Register,</span>
<span class="cm"> * def. 1 */</span>
<span class="cp">#define GPIO_SCR		(1&lt;&lt;13)</span>
<span class="cm">/* GPIO14 - O - Ex. Register1 Chip Select for Monitor Control Register,</span>
<span class="cm"> * def. 1 */</span>
<span class="cp">#define GPIO_MCR		(1&lt;&lt;14)</span>

<span class="cp">#define GPIO_SPI_ALL		(GPIO_D4_SPI_CDTO | GPIO_D5_SPI_CCLK |\</span>
<span class="cp">		GPIO_SPI_CSN0 | GPIO_SPI_CSN1)</span>

<span class="cp">#define GPIO_DATA_MASK		(GPIO_D0 | GPIO_D1_JACKDTC0 | \</span>
<span class="cp">		GPIO_D2_JACKDTC1 | GPIO_D3 | \</span>
<span class="cp">		GPIO_D4_SPI_CDTO | GPIO_D5_SPI_CCLK | \</span>
<span class="cp">		GPIO_D6_CD | GPIO_D7_DD)</span>

<span class="cm">/* System Control Register GPIO_SCR data bits */</span>
<span class="cm">/* Mic/Line select relay (0:line, 1:mic) */</span>
<span class="cp">#define SCR_RELAY		GPIO_D0</span>
<span class="cm">/* Phantom power drive control (0:5V, 1:48V) */</span>
<span class="cp">#define SCR_PHP_V		GPIO_D1_JACKDTC0</span>
<span class="cm">/* H/W mute control (0:Normal, 1:Mute) */</span>
<span class="cp">#define SCR_MUTE		GPIO_D2_JACKDTC1</span>
<span class="cm">/* Phantom power control (0:Phantom on, 1:off) */</span>
<span class="cp">#define SCR_PHP			GPIO_D3</span>
<span class="cm">/* Analog input 1/2 Source Select */</span>
<span class="cp">#define SCR_AIN12_SEL0		GPIO_D4_SPI_CDTO</span>
<span class="cp">#define SCR_AIN12_SEL1		GPIO_D5_SPI_CCLK</span>
<span class="cm">/* Analog input 3/4 Source Select (0:line, 1:hi-z) */</span>
<span class="cp">#define SCR_AIN34_SEL		GPIO_D6_CD</span>
<span class="cm">/* Codec Power Down (0:power down, 1:normal) */</span>
<span class="cp">#define SCR_CODEC_PDN		GPIO_D7_DD</span>

<span class="cp">#define SCR_AIN12_LINE		(0)</span>
<span class="cp">#define SCR_AIN12_MIC		(SCR_AIN12_SEL0)</span>
<span class="cp">#define SCR_AIN12_LOWCUT	(SCR_AIN12_SEL1 | SCR_AIN12_SEL0)</span>

<span class="cm">/* Monitor Control Register GPIO_MCR data bits */</span>
<span class="cm">/* Input 1/2 to Monitor 1/2 (0:off, 1:on) */</span>
<span class="cp">#define MCR_IN12_MON12		GPIO_D0</span>
<span class="cm">/* Input 1/2 to Monitor 3/4 (0:off, 1:on) */</span>
<span class="cp">#define MCR_IN12_MON34		GPIO_D1_JACKDTC0</span>
<span class="cm">/* Input 3/4 to Monitor 1/2 (0:off, 1:on) */</span>
<span class="cp">#define MCR_IN34_MON12		GPIO_D2_JACKDTC1</span>
<span class="cm">/* Input 3/4 to Monitor 3/4 (0:off, 1:on) */</span>
<span class="cp">#define MCR_IN34_MON34		GPIO_D3</span>
<span class="cm">/* Output to Monitor 1/2 (0:off, 1:on) */</span>
<span class="cp">#define MCR_OUT34_MON12		GPIO_D4_SPI_CDTO</span>
<span class="cm">/* Output to Monitor 3/4 (0:off, 1:on) */</span>
<span class="cp">#define MCR_OUT12_MON34		GPIO_D5_SPI_CCLK</span>

<span class="cm">/* CPLD Register DATA bits */</span>
<span class="cm">/* Clock Rate Select */</span>
<span class="cp">#define CPLD_CKS0		GPIO_D0</span>
<span class="cp">#define CPLD_CKS1		GPIO_D1_JACKDTC0</span>
<span class="cp">#define CPLD_CKS2		GPIO_D2_JACKDTC1</span>
<span class="cm">/* Sync Source Select (0:Internal, 1:External) */</span>
<span class="cp">#define CPLD_SYNC_SEL		GPIO_D3</span>
<span class="cm">/* Word Clock FS Select (0:FS, 1:256FS) */</span>
<span class="cp">#define CPLD_WORD_SEL		GPIO_D4_SPI_CDTO</span>
<span class="cm">/* Coaxial Output Source (IS-Link) (0:SPDIF, 1:I2S) */</span>
<span class="cp">#define CPLD_COAX_OUT		GPIO_D5_SPI_CCLK</span>
<span class="cm">/* Input 1/2 Source Select (0:Analog12, 1:An34) */</span>
<span class="cp">#define CPLD_IN12_SEL		GPIO_D6_CD</span>
<span class="cm">/* Input 3/4 Source Select (0:Analog34, 1:Digital In) */</span>
<span class="cp">#define CPLD_IN34_SEL		GPIO_D7_DD</span>

<span class="cm">/* internal clock (CPLD_SYNC_SEL = 0) options */</span>
<span class="cp">#define CPLD_CKS_44100HZ	(0)</span>
<span class="cp">#define CPLD_CKS_48000HZ	(CPLD_CKS0)</span>
<span class="cp">#define CPLD_CKS_88200HZ	(CPLD_CKS1)</span>
<span class="cp">#define CPLD_CKS_96000HZ	(CPLD_CKS1 | CPLD_CKS0)</span>
<span class="cp">#define CPLD_CKS_176400HZ	(CPLD_CKS2)</span>
<span class="cp">#define CPLD_CKS_192000HZ	(CPLD_CKS2 | CPLD_CKS0)</span>

<span class="cp">#define CPLD_CKS_MASK		(CPLD_CKS0 | CPLD_CKS1 | CPLD_CKS2)</span>

<span class="cm">/* external clock (CPLD_SYNC_SEL = 1) options */</span>
<span class="cm">/* external clock - SPDIF */</span>
<span class="cp">#define CPLD_EXT_SPDIF	(0 | CPLD_SYNC_SEL)</span>
<span class="cm">/* external clock - WordClock 1xfs */</span>
<span class="cp">#define CPLD_EXT_WORDCLOCK_1FS	(CPLD_CKS1 | CPLD_SYNC_SEL)</span>
<span class="cm">/* external clock - WordClock 256xfs */</span>
<span class="cp">#define CPLD_EXT_WORDCLOCK_256FS	(CPLD_CKS1 | CPLD_WORD_SEL |\</span>
<span class="cp">		CPLD_SYNC_SEL)</span>

<span class="cp">#define EXT_SPDIF_TYPE			0</span>
<span class="cp">#define EXT_WORDCLOCK_1FS_TYPE		1</span>
<span class="cp">#define EXT_WORDCLOCK_256FS_TYPE	2</span>

<span class="cp">#define AK4620_DFS0		(1&lt;&lt;0)</span>
<span class="cp">#define AK4620_DFS1		(1&lt;&lt;1)</span>
<span class="cp">#define AK4620_CKS0		(1&lt;&lt;2)</span>
<span class="cp">#define AK4620_CKS1		(1&lt;&lt;3)</span>
<span class="cm">/* Clock and Format Control register */</span>
<span class="cp">#define AK4620_DFS_REG		0x02</span>

<span class="cm">/* Deem and Volume Control register */</span>
<span class="cp">#define AK4620_DEEMVOL_REG	0x03</span>
<span class="cp">#define AK4620_SMUTE		(1&lt;&lt;7)</span>

<span class="cm">/*</span>
<span class="cm"> * Conversion from int value to its binary form. Used for debugging.</span>
<span class="cm"> * The output buffer must be allocated prior to calling the function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_binary</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span><span class="o">-</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="n">j</span><span class="p">))))</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
			<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
			<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">buffer</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initial setup of the conversion array GPIO &lt;-&gt; rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qtet_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span>
	<span class="mi">96000</span><span class="p">,</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">192000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cks_vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CPLD_CKS_44100HZ</span><span class="p">,</span> <span class="n">CPLD_CKS_48000HZ</span><span class="p">,</span> <span class="n">CPLD_CKS_88200HZ</span><span class="p">,</span>
	<span class="n">CPLD_CKS_96000HZ</span><span class="p">,</span> <span class="n">CPLD_CKS_176400HZ</span><span class="p">,</span> <span class="n">CPLD_CKS_192000HZ</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">qtet_rates_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">qtet_rates</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">qtet_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_ak4113_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_vt1724_write_i2c</span><span class="p">((</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="p">)</span><span class="n">private_data</span><span class="p">,</span> <span class="n">AK4113_ADDR</span><span class="p">,</span>
			<span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">qtet_ak4113_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_vt1724_read_i2c</span><span class="p">((</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="p">)</span><span class="n">private_data</span><span class="p">,</span>
			<span class="n">AK4113_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * AK4620 section</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Write data to addr register of ak4620</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_akm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">orig_dir</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addrdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ak</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">chip</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">chip</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*printk(KERN_DEBUG &quot;Writing to AK4620: chip=%d, addr=0x%x,</span>
<span class="cm">	  data=0x%x\n&quot;, chip, addr, data);*/</span>
	<span class="n">orig_dir</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_dir</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_dir</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">orig_dir</span> <span class="o">|</span> <span class="n">GPIO_SPI_ALL</span><span class="p">);</span>
	<span class="cm">/* set mask - only SPI bits */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="o">~</span><span class="n">GPIO_SPI_ALL</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="cm">/* high all */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">GPIO_SPI_ALL</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* drop chip select */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="p">)</span>
		<span class="cm">/* CODEC 1 */</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_SPI_CSN1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_SPI_CSN0</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* build I2C address + data byte */</span>
	<span class="n">addrdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">AK4620_ADDR</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="n">addrdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">addrdata</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* drop clock */</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_D5_SPI_CCLK</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* set data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addrdata</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">))</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">GPIO_D4_SPI_CDTO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_D4_SPI_CDTO</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* raise clock */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">GPIO_D5_SPI_CCLK</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* all back to 1 */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">GPIO_SPI_ALL</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* return all gpios to non-writable */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
	<span class="cm">/* restore GPIOs direction */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_dir</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">orig_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_akm_set_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chip</span> <span class="o">&lt;</span> <span class="n">ak</span><span class="o">-&gt;</span><span class="n">num_chips</span><span class="p">;</span> <span class="n">chip</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_akm4xxx_get</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="cm">/* clear the bits */</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="cm">/* set the new bits */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">snd_akm4xxx_write</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * change the rate of AK4620</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_akm_set_rate_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ak4620_dfs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* no hint - S/PDIF input is master or the new spdif</span>
<span class="cm">			   input rate undetected, simply return */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* adjust DFS on codecs - see datasheet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">108000</span><span class="p">)</span>
		<span class="n">ak4620_dfs</span> <span class="o">=</span> <span class="n">AK4620_DFS1</span> <span class="o">|</span> <span class="n">AK4620_CKS1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">54000</span><span class="p">)</span>
		<span class="n">ak4620_dfs</span> <span class="o">=</span> <span class="n">AK4620_DFS0</span> <span class="o">|</span> <span class="n">AK4620_CKS0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ak4620_dfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set new value */</span>
	<span class="n">qtet_akm_set_regs</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="n">AK4620_DFS_REG</span><span class="p">,</span> <span class="n">AK4620_DFS0</span> <span class="o">|</span> <span class="n">AK4620_DFS1</span> <span class="o">|</span>
			<span class="n">AK4620_CKS0</span> <span class="o">|</span> <span class="n">AK4620_CKS1</span><span class="p">,</span> <span class="n">ak4620_dfs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define AK_CONTROL(xname, xch)	{ .name = xname, .num_channels = xch }</span>

<span class="cp">#define PCM_12_PLAYBACK_VOLUME	&quot;PCM 1/2 Playback Volume&quot;</span>
<span class="cp">#define PCM_34_PLAYBACK_VOLUME	&quot;PCM 3/4 Playback Volume&quot;</span>
<span class="cp">#define PCM_12_CAPTURE_VOLUME	&quot;PCM 1/2 Capture Volume&quot;</span>
<span class="cp">#define PCM_34_CAPTURE_VOLUME	&quot;PCM 3/4 Capture Volume&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_akm4xxx_dac_channel</span> <span class="n">qtet_dac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AK_CONTROL</span><span class="p">(</span><span class="n">PCM_12_PLAYBACK_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">AK_CONTROL</span><span class="p">(</span><span class="n">PCM_34_PLAYBACK_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_akm4xxx_adc_channel</span> <span class="n">qtet_adc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AK_CONTROL</span><span class="p">(</span><span class="n">PCM_12_CAPTURE_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">AK_CONTROL</span><span class="p">(</span><span class="n">PCM_34_CAPTURE_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="n">akm_qtet_dac</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SND_AK4620</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* DAC1 - Output 12</span>
<span class="cm">	*/</span>
	<span class="p">.</span><span class="n">num_adcs</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="cm">/* ADC1 - Input 12</span>
<span class="cm">	*/</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">qtet_akm_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_rate_val</span> <span class="o">=</span> <span class="n">qtet_akm_set_rate_val</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">dac_info</span> <span class="o">=</span> <span class="n">qtet_dac</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adc_info</span> <span class="o">=</span> <span class="n">qtet_adc</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Communication routines with the CPLD */</span>


<span class="cm">/* Writes data to external register reg, both reg and data are</span>
<span class="cm"> * GPIO representations */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio_mutex</span><span class="p">);</span>
	<span class="cm">/* set direction of used GPIOs*/</span>
	<span class="cm">/* all outputs */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x00ffff</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_dir</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* mask - writable bits */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="cm">/* write the data */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">GPIO_DATA_MASK</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* drop output enable */</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span>  <span class="o">~</span><span class="n">GPIO_EX_GPIOE</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* drop the register gpio */</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="cm">/* raise the register GPIO */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* raise all data gpios */</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">GPIO_DATA_MASK</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* mask - immutable bits */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_mask</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mh">0xffffff</span><span class="p">);</span>
	<span class="cm">/* outputs only 8-15 */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_dir</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mh">0x00ff00</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">scr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_mcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_cpld</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">cpld</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_scr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_SCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">scr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_mcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_MCR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_cpld</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">GPIO_CPLD_CSN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">cpld</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_regs_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bin_buffer</span><span class="p">[</span><span class="mi">36</span><span class="p">];</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SCR:	%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_binary</span><span class="p">(</span><span class="n">bin_buffer</span><span class="p">,</span>
				<span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">)));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MCR:	%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_binary</span><span class="p">(</span><span class="n">bin_buffer</span><span class="p">,</span>
				<span class="n">get_mcr</span><span class="p">(</span><span class="n">ice</span><span class="p">)));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;CPLD:	%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_binary</span><span class="p">(</span><span class="n">bin_buffer</span><span class="p">,</span>
				<span class="n">get_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;quartet&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">ice</span><span class="p">,</span> <span class="n">proc_regs_read</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* !CONFIG_PROC_FS */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_mute_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCR_MUTE</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_mute_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">smute</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCR_MUTE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* unmute */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* un-smuting DAC */</span>
		<span class="n">smute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* mute */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">SCR_MUTE</span><span class="p">;</span>
		<span class="cm">/* smuting DAC */</span>
		<span class="n">smute</span> <span class="o">=</span> <span class="n">AK4620_SMUTE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">;</span>
		<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="p">(</span><span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCR_MUTE</span><span class="p">)</span> <span class="o">|</span> <span class="n">new</span><span class="p">);</span>
		<span class="cm">/* set smute */</span>
		<span class="n">qtet_akm_set_regs</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="n">AK4620_DEEMVOL_REG</span><span class="p">,</span> <span class="n">AK4620_SMUTE</span><span class="p">,</span> <span class="n">smute</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no change */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_ain12_enum_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Line In 1/2&quot;</span><span class="p">,</span> <span class="s">&quot;Mic&quot;</span><span class="p">,</span> <span class="s">&quot;Mic + Low-cut&quot;</span><span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">texts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_ain12_sw_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCR_AIN12_SEL1</span> <span class="o">|</span> <span class="n">SCR_AIN12_SEL0</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCR_AIN12_LINE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCR_AIN12_MIC</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SCR_AIN12_LOWCUT</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* BUG - no other combinations allowed */</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_ain12_sw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">masked_old</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">new</span> <span class="o">=</span> <span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">masked_old</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SCR_AIN12_SEL1</span> <span class="o">|</span> <span class="n">SCR_AIN12_SEL0</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* binary 10 is not supported */</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* shifting to SCR_AIN12_SEL0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">masked_old</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* change requested */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCR_AIN12_LINE</span>:
			<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SCR_AIN12_SEL1</span> <span class="o">|</span> <span class="n">SCR_AIN12_SEL0</span><span class="p">);</span>
			<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="cm">/* turn off relay */</span>
			<span class="n">new</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCR_RELAY</span><span class="p">;</span>
			<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCR_AIN12_MIC</span>:
			<span class="cm">/* turn on relay */</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">|</span> <span class="n">SCR_RELAY</span><span class="p">;</span>
			<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">new</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCR_AIN12_SEL1</span><span class="p">)</span> <span class="o">|</span> <span class="n">SCR_AIN12_SEL0</span><span class="p">;</span>
			<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SCR_AIN12_LOWCUT</span>:
			<span class="cm">/* turn on relay */</span>
			<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">|</span> <span class="n">SCR_RELAY</span><span class="p">;</span>
			<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="n">new</span> <span class="o">|=</span> <span class="n">SCR_AIN12_SEL1</span> <span class="o">|</span> <span class="n">SCR_AIN12_SEL0</span><span class="p">;</span>
			<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no change */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_php_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* if phantom voltage =48V, phantom on */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SCR_PHP_V</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_php_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">new</span> <span class="o">=</span> <span class="n">get_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="cm">/* phantom on requested */</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">old</span> <span class="o">&amp;</span> <span class="n">SCR_PHP_V</span><span class="p">))</span> <span class="cm">/* 0 = voltage 5V */</span> <span class="p">{</span>
		<span class="cm">/* is off, turn on */</span>
		<span class="cm">/* turn voltage on first, = 1 */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">|</span> <span class="n">SCR_PHP_V</span><span class="p">;</span>
		<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="cm">/* turn phantom on, = 0 */</span>
		<span class="n">new</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SCR_PHP</span><span class="p">;</span>
		<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="n">SCR_PHP_V</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* phantom off requested and 1 = voltage 48V */</span>
		<span class="cm">/* is on, turn off */</span>
		<span class="cm">/* turn voltage off first, = 0 */</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SCR_PHP_V</span><span class="p">;</span>
		<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="cm">/* turn phantom off, = 1 */</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">SCR_PHP</span><span class="p">;</span>
		<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* no change */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PRIV_SW(xid, xbit, xreg)	[xid] = {.bit = xbit,\</span>
<span class="cp">	.set_register = set_##xreg,\</span>
<span class="cp">	.get_register = get_##xreg, }</span>


<span class="cp">#define PRIV_ENUM2(xid, xbit, xreg, xtext1, xtext2)	[xid] = {.bit = xbit,\</span>
<span class="cp">	.set_register = set_##xreg,\</span>
<span class="cp">	.get_register = get_##xreg,\</span>
<span class="cp">	.texts = {xtext1, xtext2} }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">qtet_kcontrol_private</span> <span class="n">qtet_privates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PRIV_ENUM2</span><span class="p">(</span><span class="n">IN12_SEL</span><span class="p">,</span> <span class="n">CPLD_IN12_SEL</span><span class="p">,</span> <span class="n">cpld</span><span class="p">,</span> <span class="s">&quot;An In 1/2&quot;</span><span class="p">,</span> <span class="s">&quot;An In 3/4&quot;</span><span class="p">),</span>
	<span class="n">PRIV_ENUM2</span><span class="p">(</span><span class="n">IN34_SEL</span><span class="p">,</span> <span class="n">CPLD_IN34_SEL</span><span class="p">,</span> <span class="n">cpld</span><span class="p">,</span> <span class="s">&quot;An In 3/4&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958 In&quot;</span><span class="p">),</span>
	<span class="n">PRIV_ENUM2</span><span class="p">(</span><span class="n">AIN34_SEL</span><span class="p">,</span> <span class="n">SCR_AIN34_SEL</span><span class="p">,</span> <span class="n">scr</span><span class="p">,</span> <span class="s">&quot;Line In 3/4&quot;</span><span class="p">,</span> <span class="s">&quot;Hi-Z&quot;</span><span class="p">),</span>
	<span class="n">PRIV_ENUM2</span><span class="p">(</span><span class="n">COAX_OUT</span><span class="p">,</span> <span class="n">CPLD_COAX_OUT</span><span class="p">,</span> <span class="n">cpld</span><span class="p">,</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span> <span class="s">&quot;I2S&quot;</span><span class="p">),</span>
	<span class="n">PRIV_SW</span><span class="p">(</span><span class="n">IN12_MON12</span><span class="p">,</span> <span class="n">MCR_IN12_MON12</span><span class="p">,</span> <span class="n">mcr</span><span class="p">),</span>
	<span class="n">PRIV_SW</span><span class="p">(</span><span class="n">IN12_MON34</span><span class="p">,</span> <span class="n">MCR_IN12_MON34</span><span class="p">,</span> <span class="n">mcr</span><span class="p">),</span>
	<span class="n">PRIV_SW</span><span class="p">(</span><span class="n">IN34_MON12</span><span class="p">,</span> <span class="n">MCR_IN34_MON12</span><span class="p">,</span> <span class="n">mcr</span><span class="p">),</span>
	<span class="n">PRIV_SW</span><span class="p">(</span><span class="n">IN34_MON34</span><span class="p">,</span> <span class="n">MCR_IN34_MON34</span><span class="p">,</span> <span class="n">mcr</span><span class="p">),</span>
	<span class="n">PRIV_SW</span><span class="p">(</span><span class="n">OUT12_MON34</span><span class="p">,</span> <span class="n">MCR_OUT12_MON34</span><span class="p">,</span> <span class="n">mcr</span><span class="p">),</span>
	<span class="n">PRIV_SW</span><span class="p">(</span><span class="n">OUT34_MON12</span><span class="p">,</span> <span class="n">MCR_OUT34_MON12</span><span class="p">,</span> <span class="n">mcr</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_enum_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_kcontrol_private</span> <span class="n">private</span> <span class="o">=</span>
		<span class="n">qtet_privates</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">];</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">private</span><span class="p">.</span><span class="n">texts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">private</span><span class="p">.</span><span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_sw_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_kcontrol_private</span> <span class="n">private</span> <span class="o">=</span>
		<span class="n">qtet_privates</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">private</span><span class="p">.</span><span class="n">get_register</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">private</span><span class="p">.</span><span class="n">bit</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_sw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_kcontrol_private</span> <span class="n">private</span> <span class="o">=</span>
		<span class="n">qtet_privates</span><span class="p">[</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">private</span><span class="p">.</span><span class="n">get_register</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">|</span> <span class="n">private</span><span class="p">.</span><span class="n">bit</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">private</span><span class="p">.</span><span class="n">bit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">private</span><span class="p">.</span><span class="n">set_register</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no change */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define qtet_sw_info	snd_ctl_boolean_mono_info</span>

<span class="cp">#define QTET_CONTROL(xname, xtype, xpriv)	\</span>
<span class="cp">	{.iface = SNDRV_CTL_ELEM_IFACE_MIXER,\</span>
<span class="cp">	.name = xname,\</span>
<span class="cp">	.info = qtet_##xtype##_info,\</span>
<span class="cp">	.get = qtet_sw_get,\</span>
<span class="cp">	.put = qtet_sw_put,\</span>
<span class="cp">	.private_value = xpriv }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">qtet_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">qtet_sw_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">qtet_mute_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">qtet_mute_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Phantom Power&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">qtet_sw_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">qtet_php_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">qtet_php_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Analog In 1/2 Capture Switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">qtet_ain12_enum_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">qtet_ain12_sw_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">qtet_ain12_sw_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="p">},</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Analog In 3/4 Capture Switch&quot;</span><span class="p">,</span> <span class="k">enum</span><span class="p">,</span> <span class="n">AIN34_SEL</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;PCM In 1/2 Capture Switch&quot;</span><span class="p">,</span> <span class="k">enum</span><span class="p">,</span> <span class="n">IN12_SEL</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;PCM In 3/4 Capture Switch&quot;</span><span class="p">,</span> <span class="k">enum</span><span class="p">,</span> <span class="n">IN34_SEL</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Coax Output Source&quot;</span><span class="p">,</span> <span class="k">enum</span><span class="p">,</span> <span class="n">COAX_OUT</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Analog In 1/2 to Monitor 1/2&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">IN12_MON12</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Analog In 1/2 to Monitor 3/4&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">IN12_MON34</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Analog In 3/4 to Monitor 1/2&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">IN34_MON12</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Analog In 3/4 to Monitor 3/4&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">IN34_MON34</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Output 1/2 to Monitor 3/4&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">OUT12_MON34</span><span class="p">),</span>
	<span class="n">QTET_CONTROL</span><span class="p">(</span><span class="s">&quot;Output 3/4 to Monitor 1/2&quot;</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">OUT34_MON12</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_vols</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCM_12_PLAYBACK_VOLUME</span><span class="p">,</span>
	<span class="n">PCM_34_PLAYBACK_VOLUME</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span>
<span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">qtet_master_db_scale</span><span class="p">,</span> <span class="o">-</span><span class="mi">6350</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">ctl_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">sid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sid</span><span class="p">));</span>
	<span class="cm">/* FIXME: strcpy is bad. */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">sid</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">add_slaves</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span> <span class="n">list</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span>
			<span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">slave</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qtet_add_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">vmaster</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ice1712_akm4xxx_build_controls</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">qtet_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qtet_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ice</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create virtual master control */</span>
	<span class="n">vmaster</span> <span class="o">=</span> <span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
			<span class="n">qtet_master_db_scale</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vmaster</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">add_slaves</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vmaster</span><span class="p">,</span> <span class="n">slave_vols</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vmaster</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* only capture SPDIF over AK4113 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ak4113_build</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4113</span><span class="p">,</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">qtet_is_spdif_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* CPLD_SYNC_SEL: 0 = internal, 1 = external (i.e. spdif master) */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">get_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPLD_SYNC_SEL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">qtet_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span>  <span class="n">get_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPLD_CKS_MASK</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cks_vals</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cks_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">qtet_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_cks_val</span><span class="p">(</span><span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">qtet_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qtet_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cks_vals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setting new rate */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>
	<span class="cm">/* switching ice1724 to external clock - supplied by ext. circuits */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">VT1724_SPDIF_MASTER</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>

	<span class="n">new</span> <span class="o">=</span>  <span class="p">(</span><span class="n">get_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CPLD_CKS_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">get_cks_val</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="cm">/* switch to internal clock, drop CPLD_SYNC_SEL */</span>
	<span class="n">new</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CPLD_SYNC_SEL</span><span class="p">;</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;QT - set_rate: old %x, new %x\n&quot;,</span>
<span class="cm">	   get_cpld(ice), new); */</span>
	<span class="n">set_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">qtet_set_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no change in master clock */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setting clock to external - SPDIF */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_set_spdif_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">new</span> <span class="o">=</span> <span class="n">get_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CPLD_CKS_MASK</span> <span class="o">|</span> <span class="n">CPLD_WORD_SEL</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EXT_SPDIF_TYPE</span>:
		<span class="n">new</span> <span class="o">|=</span> <span class="n">CPLD_EXT_SPDIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXT_WORDCLOCK_1FS_TYPE</span>:
		<span class="n">new</span> <span class="o">|=</span> <span class="n">CPLD_EXT_WORDCLOCK_1FS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EXT_WORDCLOCK_256FS_TYPE</span>:
		<span class="n">new</span> <span class="o">|=</span> <span class="n">CPLD_EXT_WORDCLOCK_256FS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="cm">/* changed */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">qtet_get_spdif_master_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">get_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="cm">/* checking only rate/clock-related bits */</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">CPLD_CKS_MASK</span> <span class="o">|</span> <span class="n">CPLD_WORD_SEL</span> <span class="o">|</span> <span class="n">CPLD_SYNC_SEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CPLD_SYNC_SEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* switched to internal clock, is not any external type */</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">CPLD_EXT_SPDIF</span><span class="p">)</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">EXT_SPDIF_TYPE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">CPLD_EXT_WORDCLOCK_1FS</span><span class="p">)</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">EXT_WORDCLOCK_1FS_TYPE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="p">(</span><span class="n">CPLD_EXT_WORDCLOCK_256FS</span><span class="p">)</span>:
			<span class="n">result</span> <span class="o">=</span> <span class="n">EXT_WORDCLOCK_256FS_TYPE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* undefined combination of external clock setup */</span>
			<span class="n">snd_BUG</span><span class="p">();</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when ak4113 detects change in the input SPDIF stream */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_ak4113_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ak4113</span> <span class="o">*</span><span class="n">ak4113</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c0</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ak4113</span><span class="o">-&gt;</span><span class="n">change_callback_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">qtet_get_spdif_master_type</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">==</span> <span class="n">EXT_SPDIF_TYPE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">c1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only for SPDIF master mode, rate was changed */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">snd_ak4113_external_rate</span><span class="p">(</span><span class="n">ak4113</span><span class="p">);</span>
		<span class="cm">/* printk(KERN_DEBUG &quot;ak4113 - input rate changed to %d\n&quot;,</span>
<span class="cm">		   rate); */</span>
		<span class="n">qtet_akm_set_rate_val</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If clock slaved to SPDIF-IN, setting runtime rate</span>
<span class="cm"> * to the detected external rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">qtet_spdif_in_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qtet_get_spdif_master_type</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXT_SPDIF_TYPE</span><span class="p">)</span>
		<span class="cm">/* not external SPDIF, no rate limitation */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* only external SPDIF can detect incoming sample rate */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">snd_ak4113_external_rate</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4113</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * initialize the chip</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">qtet_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ak4113_init_vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* AK4113_REG_PWRDN */</span>	<span class="n">AK4113_RST</span> <span class="o">|</span> <span class="n">AK4113_PWN</span> <span class="o">|</span>
			<span class="n">AK4113_OCKS0</span> <span class="o">|</span> <span class="n">AK4113_OCKS1</span><span class="p">,</span>
		<span class="cm">/* AK4113_REQ_FORMAT */</span>	<span class="n">AK4113_DIF_I24I2S</span> <span class="o">|</span> <span class="n">AK4113_VTX</span> <span class="o">|</span>
			<span class="n">AK4113_DEM_OFF</span> <span class="o">|</span> <span class="n">AK4113_DEAU</span><span class="p">,</span>
		<span class="cm">/* AK4113_REG_IO0 */</span>	<span class="n">AK4113_OPS2</span> <span class="o">|</span> <span class="n">AK4113_TXE</span> <span class="o">|</span>
			<span class="n">AK4113_XTL_24_576M</span><span class="p">,</span>
		<span class="cm">/* AK4113_REG_IO1 */</span>	<span class="n">AK4113_EFH_1024LRCLK</span> <span class="o">|</span> <span class="n">AK4113_IPS</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="cm">/* AK4113_REG_INT0_MASK */</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* AK4113_REG_INT1_MASK */</span>	<span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* AK4113_REG_DATDTS */</span>		<span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">qtet_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* switching ice1724 to external clock - supplied by ext. circuits */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">VT1724_SPDIF_MASTER</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/* qtet is clocked by Xilinx array */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qtet_rates_info</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span> <span class="o">=</span> <span class="n">qtet_is_spdif_master</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span> <span class="o">=</span> <span class="n">qtet_get_rate</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_rate</span> <span class="o">=</span> <span class="n">qtet_set_rate</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_mclk</span> <span class="o">=</span> <span class="n">qtet_set_mclk</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_spdif_clock</span> <span class="o">=</span> <span class="n">qtet_set_spdif_clock</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_spdif_master_type</span> <span class="o">=</span> <span class="n">qtet_get_spdif_master_type</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_names</span> <span class="o">=</span> <span class="n">ext_clock_names</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">ext_clock_count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ext_clock_names</span><span class="p">);</span>
	<span class="cm">/* since Qtet can detect correct SPDIF-in rate, all streams can be</span>
<span class="cm">	 * limited to this specific rate */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">pro_open</span> <span class="o">=</span> <span class="n">qtet_spdif_in_open</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="cm">/* Mute Off */</span>
	<span class="cm">/* SCR Initialize*/</span>
	<span class="cm">/* keep codec power down first */</span>
	<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SCR_PHP</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* codec power up */</span>
	<span class="n">set_scr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">SCR_PHP</span> <span class="o">|</span> <span class="n">SCR_CODEC_PDN</span><span class="p">);</span>

	<span class="cm">/* MCR Initialize */</span>
	<span class="n">set_mcr</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CPLD Initialize */</span>
	<span class="n">set_cpld</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_dacs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_adcs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ak</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ak</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="cm">/* only one codec with two chips */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm_codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ice1712_akm4xxx_init</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">akm_qtet_dac</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ak4113_create</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
			<span class="n">qtet_ak4113_read</span><span class="p">,</span>
			<span class="n">qtet_ak4113_write</span><span class="p">,</span>
			<span class="n">ak4113_init_vals</span><span class="p">,</span>
			<span class="n">ice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4113</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* callback for codecs rate setting */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4113</span><span class="o">-&gt;</span><span class="n">change_callback</span> <span class="o">=</span> <span class="n">qtet_ak4113_change</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4113</span><span class="o">-&gt;</span><span class="n">change_callback_private</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
	<span class="cm">/* AK41143 in Quartet can detect external rate correctly</span>
<span class="cm">	 * (i.e. check_flags = 0) */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4113</span><span class="o">-&gt;</span><span class="n">check_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">proc_init</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>

	<span class="n">qtet_set_rate</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="mi">44100</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qtet_eeprom</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>	<span class="cm">/* clock 256(24MHz), mpu401, 1xADC,</span>
<span class="cm">					   1xDACs, SPDIF in */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]</span>      <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/* I2S */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_I2S</span><span class="p">]</span>         <span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>	<span class="cm">/* 96k, 24bit, 192k */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]</span>       <span class="o">=</span> <span class="mh">0xc3</span><span class="p">,</span>	<span class="cm">/* out-en, out-int, in, out-ext */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR</span><span class="p">]</span>    <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 0-7 inputs, switched to output</span>
<span class="cm">					   only during output operations */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR1</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>  <span class="cm">/* 8-15 outputs */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR2</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>	<span class="cm">/* changed only for OUT operations */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK2</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>

	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* inputs */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="cm">/* all 1, but GPIO_CPLD_RW</span>
<span class="cm">					  and GPIO15 always zero */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* inputs */</span>
<span class="p">};</span>

<span class="cm">/* entry point */</span>
<span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="n">snd_vt1724_qtet_cards</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">VT1724_SUBDEVICE_QTET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Infrasonic Quartet&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="s">&quot;quartet&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_init</span> <span class="o">=</span> <span class="n">qtet_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">qtet_add_controls</span><span class="p">,</span>
		<span class="p">.</span><span class="n">eeprom_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qtet_eeprom</span><span class="p">),</span>
		<span class="p">.</span><span class="n">eeprom_data</span> <span class="o">=</span> <span class="n">qtet_eeprom</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
