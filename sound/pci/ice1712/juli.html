<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ice1712 › juli.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>juli.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for ICEnsemble VT1724 (Envy24HT)</span>
<span class="cm"> *</span>
<span class="cm"> *   Lowlevel functions for ESI Juli@ cards</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2004 Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *	              2008 Pavel Hofman &lt;dustin@seznam.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>

<span class="cp">#include &quot;ice1712.h&quot;</span>
<span class="cp">#include &quot;envy24ht.h&quot;</span>
<span class="cp">#include &quot;juli.h&quot;</span>

<span class="k">struct</span> <span class="n">juli_spec</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ak4114</span> <span class="o">*</span><span class="n">ak4114</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">analog</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * chip addresses on I2C bus</span>
<span class="cm"> */</span>
<span class="cp">#define AK4114_ADDR		0x20		</span><span class="cm">/* S/PDIF receiver */</span><span class="cp"></span>
<span class="cp">#define AK4358_ADDR		0x22		</span><span class="cm">/* DAC */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Juli does not use the standard ICE1724 clock scheme. Juli&#39;s ice1724 chip is</span>
<span class="cm"> * supplied by external clock provided by Xilinx array and MK73-1 PLL frequency</span>
<span class="cm"> * multiplier. Actual frequency is set by ice1724 GPIOs hooked to the Xilinx.</span>
<span class="cm"> *</span>
<span class="cm"> * The clock circuitry is supplied by the two ice1724 crystals. This</span>
<span class="cm"> * arrangement allows to generate independent clock signal for AK4114&#39;s input</span>
<span class="cm"> * rate detection circuit. As a result, Juli, unlike most other</span>
<span class="cm"> * ice1724+ak4114-based cards, detects spdif input rate correctly.</span>
<span class="cm"> * This fact is applied in the driver, allowing to modify PCM stream rate</span>
<span class="cm"> * parameter according to the actual input rate.</span>
<span class="cm"> *</span>
<span class="cm"> * Juli uses the remaining three stereo-channels of its DAC to optionally</span>
<span class="cm"> * monitor analog input, digital input, and digital output. The corresponding</span>
<span class="cm"> * I2S signals are routed by Xilinx, controlled by GPIOs.</span>
<span class="cm"> *</span>
<span class="cm"> * The master mute is implemented using output muting transistors (GPIO) in</span>
<span class="cm"> * combination with smuting the DAC.</span>
<span class="cm"> *</span>
<span class="cm"> * The card itself has no HW master volume control, implemented using the</span>
<span class="cm"> * vmaster control.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * researching and fixing the input monitors</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * GPIO pins</span>
<span class="cm"> */</span>
<span class="cp">#define GPIO_FREQ_MASK		(3&lt;&lt;0)</span>
<span class="cp">#define GPIO_FREQ_32KHZ		(0&lt;&lt;0)</span>
<span class="cp">#define GPIO_FREQ_44KHZ		(1&lt;&lt;0)</span>
<span class="cp">#define GPIO_FREQ_48KHZ		(2&lt;&lt;0)</span>
<span class="cp">#define GPIO_MULTI_MASK		(3&lt;&lt;2)</span>
<span class="cp">#define GPIO_MULTI_4X		(0&lt;&lt;2)</span>
<span class="cp">#define GPIO_MULTI_2X		(1&lt;&lt;2)</span>
<span class="cp">#define GPIO_MULTI_1X		(2&lt;&lt;2)		</span><span class="cm">/* also external */</span><span class="cp"></span>
<span class="cp">#define GPIO_MULTI_HALF		(3&lt;&lt;2)</span>
<span class="cp">#define GPIO_INTERNAL_CLOCK	(1&lt;&lt;4)		</span><span class="cm">/* 0 = external, 1 = internal */</span><span class="cp"></span>
<span class="cp">#define GPIO_CLOCK_MASK		(1&lt;&lt;4)</span>
<span class="cp">#define GPIO_ANALOG_PRESENT	(1&lt;&lt;5)		</span><span class="cm">/* RO only: 0 = present */</span><span class="cp"></span>
<span class="cp">#define GPIO_RXMCLK_SEL		(1&lt;&lt;7)		</span><span class="cm">/* must be 0 */</span><span class="cp"></span>
<span class="cp">#define GPIO_AK5385A_CKS0	(1&lt;&lt;8)</span>
<span class="cp">#define GPIO_AK5385A_DFS1	(1&lt;&lt;9)</span>
<span class="cp">#define GPIO_AK5385A_DFS0	(1&lt;&lt;10)</span>
<span class="cp">#define GPIO_DIGOUT_MONITOR	(1&lt;&lt;11)		</span><span class="cm">/* 1 = active */</span><span class="cp"></span>
<span class="cp">#define GPIO_DIGIN_MONITOR	(1&lt;&lt;12)		</span><span class="cm">/* 1 = active */</span><span class="cp"></span>
<span class="cp">#define GPIO_ANAIN_MONITOR	(1&lt;&lt;13)		</span><span class="cm">/* 1 = active */</span><span class="cp"></span>
<span class="cp">#define GPIO_AK5385A_CKS1	(1&lt;&lt;14)		</span><span class="cm">/* must be 0 */</span><span class="cp"></span>
<span class="cp">#define GPIO_MUTE_CONTROL	(1&lt;&lt;15)		</span><span class="cm">/* output mute, 1 = muted */</span><span class="cp"></span>

<span class="cp">#define GPIO_RATE_MASK		(GPIO_FREQ_MASK | GPIO_MULTI_MASK | \</span>
<span class="cp">		GPIO_CLOCK_MASK)</span>
<span class="cp">#define GPIO_AK5385A_MASK	(GPIO_AK5385A_CKS0 | GPIO_AK5385A_DFS0 | \</span>
<span class="cp">		GPIO_AK5385A_DFS1 | GPIO_AK5385A_CKS1)</span>

<span class="cp">#define JULI_PCM_RATE	(SNDRV_PCM_RATE_16000 | SNDRV_PCM_RATE_22050 | \</span>
<span class="cp">		SNDRV_PCM_RATE_32000 | SNDRV_PCM_RATE_44100 | \</span>
<span class="cp">		SNDRV_PCM_RATE_48000 | SNDRV_PCM_RATE_64000 | \</span>
<span class="cp">		SNDRV_PCM_RATE_88200 | SNDRV_PCM_RATE_96000 | \</span>
<span class="cp">		SNDRV_PCM_RATE_176400 | SNDRV_PCM_RATE_192000)</span>

<span class="cp">#define GPIO_RATE_16000		(GPIO_FREQ_32KHZ | GPIO_MULTI_HALF | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_22050		(GPIO_FREQ_44KHZ | GPIO_MULTI_HALF | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_24000		(GPIO_FREQ_48KHZ | GPIO_MULTI_HALF | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_32000		(GPIO_FREQ_32KHZ | GPIO_MULTI_1X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_44100		(GPIO_FREQ_44KHZ | GPIO_MULTI_1X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_48000		(GPIO_FREQ_48KHZ | GPIO_MULTI_1X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_64000		(GPIO_FREQ_32KHZ | GPIO_MULTI_2X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_88200		(GPIO_FREQ_44KHZ | GPIO_MULTI_2X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_96000		(GPIO_FREQ_48KHZ | GPIO_MULTI_2X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_176400	(GPIO_FREQ_44KHZ | GPIO_MULTI_4X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>
<span class="cp">#define GPIO_RATE_192000	(GPIO_FREQ_48KHZ | GPIO_MULTI_4X | \</span>
<span class="cp">		GPIO_INTERNAL_CLOCK)</span>

<span class="cm">/*</span>
<span class="cm"> * Initial setup of the conversion array GPIO &lt;-&gt; rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">juli_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">16000</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span>
	<span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span>
	<span class="mi">96000</span><span class="p">,</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">192000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">GPIO_RATE_16000</span><span class="p">,</span> <span class="n">GPIO_RATE_22050</span><span class="p">,</span> <span class="n">GPIO_RATE_24000</span><span class="p">,</span> <span class="n">GPIO_RATE_32000</span><span class="p">,</span>
	<span class="n">GPIO_RATE_44100</span><span class="p">,</span> <span class="n">GPIO_RATE_48000</span><span class="p">,</span> <span class="n">GPIO_RATE_64000</span><span class="p">,</span> <span class="n">GPIO_RATE_88200</span><span class="p">,</span>
	<span class="n">GPIO_RATE_96000</span><span class="p">,</span> <span class="n">GPIO_RATE_176400</span><span class="p">,</span> <span class="n">GPIO_RATE_192000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">juli_rates_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">juli_rates</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">juli_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_gpio_val</span><span class="p">(</span><span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">juli_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">juli_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">gpio_vals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_ak4114_write</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_vt1724_write_i2c</span><span class="p">((</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="p">)</span><span class="n">private_data</span><span class="p">,</span> <span class="n">AK4114_ADDR</span><span class="p">,</span>
				<span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">juli_ak4114_read</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">private_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_vt1724_read_i2c</span><span class="p">((</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="p">)</span><span class="n">private_data</span><span class="p">,</span>
					<span class="n">AK4114_ADDR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If SPDIF capture and slaved to SPDIF-IN, setting runtime rate</span>
<span class="cm"> * to the external rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_spdif_in_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">juli_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">snd_ak4114_external_rate</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AK4358 section</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_akm_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_akm_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_akm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ak</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	 
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">snd_vt1724_write_i2c</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AK4358_ADDR</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * change the rate of envy24HT, AK4358, AK5385</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_akm_set_rate_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">old</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">ak4358_dfs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ak5385_pins</span><span class="p">,</span> <span class="n">old_gpio</span><span class="p">,</span> <span class="n">new_gpio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ak</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">juli_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="cm">/* no hint - S/PDIF input is master or the new spdif</span>
<span class="cm">			   input rate undetected, simply return */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* adjust DFS on codecs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">96000</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">ak4358_dfs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ak5385_pins</span> <span class="o">=</span> <span class="n">GPIO_AK5385A_DFS1</span> <span class="o">|</span> <span class="n">GPIO_AK5385A_CKS0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ak4358_dfs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ak5385_pins</span> <span class="o">=</span> <span class="n">GPIO_AK5385A_DFS0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ak4358_dfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ak5385_pins</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* AK5385 first, since it requires cold reset affecting both codecs */</span>
	<span class="n">old_gpio</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">new_gpio</span> <span class="o">=</span>  <span class="p">(</span><span class="n">old_gpio</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPIO_AK5385A_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">ak5385_pins</span><span class="p">;</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;JULI - ak5385 set_rate_val: new gpio 0x%x\n&quot;,</span>
<span class="cm">		new_gpio); */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new_gpio</span><span class="p">);</span>

	<span class="cm">/* cold reset */</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">old</span> <span class="o">|</span> <span class="n">VT1724_AC97_COLD</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">VT1724_AC97_COLD</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">AC97_CMD</span><span class="p">));</span>

	<span class="cm">/* AK4358 */</span>
	<span class="cm">/* set new value, reset DFS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_akm4xxx_get</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">snd_akm4xxx_reset</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_akm4xxx_get</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ak4358_dfs</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">snd_akm4xxx_set</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">snd_akm4xxx_reset</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* reinit ak4114 */</span>
	<span class="n">snd_ak4114_reinit</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define AK_DAC(xname, xch)	{ .name = xname, .num_channels = xch }</span>
<span class="cp">#define PCM_VOLUME		&quot;PCM Playback Volume&quot;</span>
<span class="cp">#define MONITOR_AN_IN_VOLUME	&quot;Monitor Analog In Volume&quot;</span>
<span class="cp">#define MONITOR_DIG_IN_VOLUME	&quot;Monitor Digital In Volume&quot;</span>
<span class="cp">#define MONITOR_DIG_OUT_VOLUME	&quot;Monitor Digital Out Volume&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">snd_akm4xxx_dac_channel</span> <span class="n">juli_dac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">AK_DAC</span><span class="p">(</span><span class="n">PCM_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">AK_DAC</span><span class="p">(</span><span class="n">MONITOR_AN_IN_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">AK_DAC</span><span class="p">(</span><span class="n">MONITOR_DIG_OUT_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">AK_DAC</span><span class="p">(</span><span class="n">MONITOR_DIG_IN_VOLUME</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="n">akm_juli_dac</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SND_AK4358</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_dacs</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="cm">/* DAC1 - analog out</span>
<span class="cm">			   DAC2 - analog in monitor</span>
<span class="cm">			   DAC3 - digital out monitor</span>
<span class="cm">			   DAC4 - digital in monitor</span>
<span class="cm">			 */</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">juli_akm_lock</span><span class="p">,</span>
		<span class="p">.</span><span class="n">unlock</span> <span class="o">=</span> <span class="n">juli_akm_unlock</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">juli_akm_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_rate_val</span> <span class="o">=</span> <span class="n">juli_akm_set_rate_val</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">dac_info</span> <span class="o">=</span> <span class="n">juli_dac</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define juli_mute_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">juli_mute_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">==</span> <span class="n">GPIO_MUTE_CONTROL</span><span class="p">)</span>
		<span class="cm">/* val 0 = signal on */</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* val 1 = signal on */</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">juli_mute_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_gpio</span><span class="p">,</span> <span class="n">new_gpio</span><span class="p">;</span>
	<span class="n">old_gpio</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* unmute */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">==</span> <span class="n">GPIO_MUTE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 0 = signal on */</span>
			<span class="n">new_gpio</span> <span class="o">=</span> <span class="n">old_gpio</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPIO_MUTE_CONTROL</span><span class="p">;</span>
			<span class="cm">/* un-smuting DAC */</span>
			<span class="n">snd_akm4xxx_write</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* 1 = signal on */</span>
			<span class="n">new_gpio</span> <span class="o">=</span>  <span class="n">old_gpio</span> <span class="o">|</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* mute */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">==</span> <span class="n">GPIO_MUTE_CONTROL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 1 = signal off */</span>
			<span class="n">new_gpio</span> <span class="o">=</span> <span class="n">old_gpio</span> <span class="o">|</span> <span class="n">GPIO_MUTE_CONTROL</span><span class="p">;</span>
			<span class="cm">/* smuting DAC */</span>
			<span class="n">snd_akm4xxx_write</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* 0 = signal off */</span>
			<span class="n">new_gpio</span> <span class="o">=</span>  <span class="n">old_gpio</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* printk(KERN_DEBUG</span>
<span class="cm">		&quot;JULI - mute/unmute: control_value: 0x%x, old_gpio: 0x%x, &quot;</span>
<span class="cm">		&quot;new_gpio 0x%x\n&quot;,</span>
<span class="cm">		(unsigned int)ucontrol-&gt;value.integer.value[0], old_gpio,</span>
<span class="cm">		new_gpio); */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_gpio</span> <span class="o">!=</span> <span class="n">new_gpio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new_gpio</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no change */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">juli_mute_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Master Playback Switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">juli_mute_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">juli_mute_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">juli_mute_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">GPIO_MUTE_CONTROL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Although the following functionality respects the succint NDA&#39;d</span>
<span class="cm">	 * documentation from the card manufacturer, and the same way of</span>
<span class="cm">	 * operation is coded in OSS Juli driver, only Digital Out monitor</span>
<span class="cm">	 * seems to work. Surprisingly, Analog input monitor outputs Digital</span>
<span class="cm">	 * output data. The two are independent, as enabling both doubles</span>
<span class="cm">	 * volume of the monitor sound.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Checking traces on the board suggests the functionality described</span>
<span class="cm">	 * by the manufacturer is correct - I2S from ADC and AK4114</span>
<span class="cm">	 * go to ICE as well as to Xilinx, I2S inputs of DAC2,3,4 (the monitor</span>
<span class="cm">	 * inputs) are fed from Xilinx.</span>
<span class="cm">	 *</span>
<span class="cm">	 * I even checked traces on board and coded a support in driver for</span>
<span class="cm">	 * an alternative possibility - the unused I2S ICE output channels</span>
<span class="cm">	 * switched to HW-IN/SPDIF-IN and providing the monitoring signal to</span>
<span class="cm">	 * the DAC - to no avail. The I2S outputs seem to be unconnected.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The windows driver supports the monitoring correctly.</span>
<span class="cm">	 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Monitor Analog In Switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">juli_mute_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">juli_mute_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">juli_mute_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">GPIO_ANAIN_MONITOR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Monitor Digital Out Switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">juli_mute_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">juli_mute_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">juli_mute_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">GPIO_DIGOUT_MONITOR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Monitor Digital In Switch&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">juli_mute_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">juli_mute_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">juli_mute_put</span><span class="p">,</span>
		<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">GPIO_DIGIN_MONITOR</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slave_vols</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCM_VOLUME</span><span class="p">,</span>
	<span class="n">MONITOR_AN_IN_VOLUME</span><span class="p">,</span>
	<span class="n">MONITOR_DIG_IN_VOLUME</span><span class="p">,</span>
	<span class="n">MONITOR_DIG_OUT_VOLUME</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__devinitdata</span>
<span class="n">DECLARE_TLV_DB_SCALE</span><span class="p">(</span><span class="n">juli_master_db_scale</span><span class="p">,</span> <span class="o">-</span><span class="mi">6350</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">ctl_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="n">sid</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sid</span><span class="p">));</span>
	<span class="cm">/* FIXME: strcpy is bad. */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">sid</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">sid</span><span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ctl_find_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">add_slaves</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span> <span class="n">list</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">ctl_find</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
		<span class="cm">/* printk(KERN_DEBUG &quot;add_slaves - %s\n&quot;, *list); */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* printk(KERN_DEBUG &quot;slave %s found\n&quot;, *list); */</span>
			<span class="n">snd_ctl_add_slave</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">slave</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">juli_add_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">juli_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">vmaster</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ice1712_akm4xxx_build_controls</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">juli_mute_controls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">juli_mute_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ice</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Create virtual master control */</span>
	<span class="n">vmaster</span> <span class="o">=</span> <span class="n">snd_ctl_make_virtual_master</span><span class="p">(</span><span class="s">&quot;Master Playback Volume&quot;</span><span class="p">,</span>
					      <span class="n">juli_master_db_scale</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vmaster</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">add_slaves</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vmaster</span><span class="p">,</span> <span class="n">slave_vols</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vmaster</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* only capture SPDIF over AK4114 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ak4114_build</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * suspend/resume</span>
<span class="cm"> * */</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">juli_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">juli_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="cm">/* akm4358 un-reset, un-mute */</span>
	<span class="n">snd_akm4xxx_reset</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* reinit ak4114 */</span>
	<span class="n">snd_ak4114_reinit</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">juli_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">;</span>
	<span class="cm">/* akm4358 reset and soft-mute */</span>
	<span class="n">snd_akm4xxx_reset</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * initialize the chip</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">juli_is_spdif_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GPIO_INTERNAL_CLOCK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">juli_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span>  <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">GPIO_RATE_MASK</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gpio_vals</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">result</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">juli_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setting new rate */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span>  <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPIO_RATE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">get_gpio_val</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
	<span class="cm">/* printk(KERN_DEBUG &quot;JULI - set_rate: old %x, new %x\n&quot;,</span>
<span class="cm">			old &amp; GPIO_RATE_MASK,</span>
<span class="cm">			new &amp; GPIO_RATE_MASK); */</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="cm">/* switching to external clock - supplied by external circuits */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">VT1724_SPDIF_MASTER</span><span class="p">,</span> <span class="n">ICEMT1724</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="n">RATE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">juli_set_mclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no change in master clock */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setting clock to external - SPDIF */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">juli_set_spdif_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old</span><span class="p">;</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">ice</span><span class="p">);</span>
	<span class="cm">/* external clock (= 0), multiply 1x, 48kHz */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">ice</span><span class="p">,</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GPIO_RATE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">GPIO_MULTI_1X</span> <span class="o">|</span>
			<span class="n">GPIO_FREQ_48KHZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called when ak4114 detects change in the input SPDIF stream */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">juli_ak4114_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ak4114</span> <span class="o">*</span><span class="n">ak4114</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c0</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span> <span class="o">=</span> <span class="n">ak4114</span><span class="o">-&gt;</span><span class="n">change_callback_private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span><span class="p">(</span><span class="n">ice</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">c1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only for SPDIF master mode, rate was changed */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">snd_ak4114_external_rate</span><span class="p">(</span><span class="n">ak4114</span><span class="p">);</span>
		<span class="cm">/* printk(KERN_DEBUG &quot;ak4114 - input rate changed to %d\n&quot;,</span>
<span class="cm">				rate); */</span>
		<span class="n">juli_akm_set_rate_val</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">juli_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ice1712</span> <span class="o">*</span><span class="n">ice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ak4114_init_vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* AK4117_REG_PWRDN */</span>	<span class="n">AK4114_RST</span> <span class="o">|</span> <span class="n">AK4114_PWN</span> <span class="o">|</span>
					<span class="n">AK4114_OCKS0</span> <span class="o">|</span> <span class="n">AK4114_OCKS1</span><span class="p">,</span>
		<span class="cm">/* AK4114_REQ_FORMAT */</span>	<span class="n">AK4114_DIF_I24I2S</span><span class="p">,</span>
		<span class="cm">/* AK4114_REG_IO0 */</span>	<span class="n">AK4114_TX1E</span><span class="p">,</span>
		<span class="cm">/* AK4114_REG_IO1 */</span>	<span class="n">AK4114_EFH_1024</span> <span class="o">|</span> <span class="n">AK4114_DIT</span> <span class="o">|</span>
					<span class="n">AK4114_IPS</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
		<span class="cm">/* AK4114_REG_INT0_MASK */</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* AK4114_REG_INT1_MASK */</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ak4114_init_txcsb</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">juli_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_akm4xxx</span> <span class="o">*</span><span class="n">ak</span><span class="p">;</span>

	<span class="n">spec</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">spec</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spec</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ak4114_create</span><span class="p">(</span><span class="n">ice</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				<span class="n">juli_ak4114_read</span><span class="p">,</span>
				<span class="n">juli_ak4114_write</span><span class="p">,</span>
				<span class="n">ak4114_init_vals</span><span class="p">,</span> <span class="n">ak4114_init_txcsb</span><span class="p">,</span>
				<span class="n">ice</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* callback for codecs rate setting */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="o">-&gt;</span><span class="n">change_callback</span> <span class="o">=</span> <span class="n">juli_ak4114_change</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="o">-&gt;</span><span class="n">change_callback_private</span> <span class="o">=</span> <span class="n">ice</span><span class="p">;</span>
	<span class="cm">/* AK4114 in Juli can detect external rate correctly */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ak4114</span><span class="o">-&gt;</span><span class="n">check_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> * it seems that the analog doughter board detection does not work reliably, so</span>
<span class="c"> * force the analog flag; it should be very rare (if ever) to come at Juli@</span>
<span class="c"> * used without the analog daughter board</span>
<span class="c"> */</span>
<span class="c">	spec-&gt;analog = (ice-&gt;gpio.get_data(ice) &amp; GPIO_ANALOG_PRESENT) ? 0 : 1;</span>
<span class="cp">#else</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">analog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;juli@: analog I/O detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_dacs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">num_total_adcs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_akm4xxx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">ak</span> <span class="o">=</span> <span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ak</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">ice</span><span class="o">-&gt;</span><span class="n">akm_codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ice1712_akm4xxx_init</span><span class="p">(</span><span class="n">ak</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">akm_juli_dac</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* juli is clocked by Xilinx array */</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">hw_rates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">juli_rates_info</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">is_spdif_master</span> <span class="o">=</span> <span class="n">juli_is_spdif_master</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">get_rate</span> <span class="o">=</span> <span class="n">juli_get_rate</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_rate</span> <span class="o">=</span> <span class="n">juli_set_rate</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_mclk</span> <span class="o">=</span> <span class="n">juli_set_mclk</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">set_spdif_clock</span> <span class="o">=</span> <span class="n">juli_set_spdif_clock</span><span class="p">;</span>

	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">spdif</span><span class="p">.</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">juli_spdif_in_open</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_resume</span> <span class="o">=</span> <span class="n">juli_resume</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_suspend</span> <span class="o">=</span> <span class="n">juli_suspend</span><span class="p">;</span>
	<span class="n">ice</span><span class="o">-&gt;</span><span class="n">pm_suspend_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Juli@ boards don&#39;t provide the EEPROM data except for the vendor IDs.</span>
<span class="cm"> * hence the driver needs to sets up it properly.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">juli_eeprom</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">ICE_EEP2_SYSCONF</span><span class="p">]</span>     <span class="o">=</span> <span class="mh">0x2b</span><span class="p">,</span>	<span class="cm">/* clock 512, mpu401, 1xADC, 1xDACs,</span>
<span class="cm">					   SPDIF in */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_ACLINK</span><span class="p">]</span>      <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/* I2S */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_I2S</span><span class="p">]</span>         <span class="o">=</span> <span class="mh">0xf8</span><span class="p">,</span>	<span class="cm">/* vol, 96k, 24bit, 192k */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_SPDIF</span><span class="p">]</span>       <span class="o">=</span> <span class="mh">0xc3</span><span class="p">,</span>	<span class="cm">/* out-en, out-int, spdif-in */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR</span><span class="p">]</span>    <span class="o">=</span> <span class="mh">0x9f</span><span class="p">,</span>	<span class="cm">/* 5, 6:inputs; 7, 4-0 outputs*/</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR1</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_DIR2</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK</span><span class="p">]</span>   <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>	<span class="cm">/* 5, 6: locked; 7, 4-0 writable */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK1</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* 0-7 writable */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_MASK2</span><span class="p">]</span>  <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE</span><span class="p">]</span>  <span class="o">=</span> <span class="n">GPIO_FREQ_48KHZ</span> <span class="o">|</span> <span class="n">GPIO_MULTI_1X</span> <span class="o">|</span>
	       <span class="n">GPIO_INTERNAL_CLOCK</span><span class="p">,</span>	<span class="cm">/* internal clock, multiple 1x, 48kHz*/</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* unmuted */</span>
	<span class="p">[</span><span class="n">ICE_EEP2_GPIO_STATE2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* entry point */</span>
<span class="k">struct</span> <span class="n">snd_ice1712_card_info</span> <span class="n">snd_vt1724_juli_cards</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">VT1724_SUBDEVICE_JULI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ESI Juli@&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">model</span> <span class="o">=</span> <span class="s">&quot;juli&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chip_init</span> <span class="o">=</span> <span class="n">juli_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">build_controls</span> <span class="o">=</span> <span class="n">juli_add_controls</span><span class="p">,</span>
		<span class="p">.</span><span class="n">eeprom_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">juli_eeprom</span><span class="p">),</span>
		<span class="p">.</span><span class="n">eeprom_data</span> <span class="o">=</span> <span class="n">juli_eeprom</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
