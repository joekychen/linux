<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › mixart › mixart.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mixart.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Digigram miXart soundcards</span>
<span class="cm"> *</span>
<span class="cm"> * main file with alsa callbacks</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 by Digigram &lt;alsa@digigram.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &quot;mixart.h&quot;</span>
<span class="cp">#include &quot;mixart_hwdep.h&quot;</span>
<span class="cp">#include &quot;mixart_core.h&quot;</span>
<span class="cp">#include &quot;mixart_mixer.h&quot;</span>

<span class="cp">#define CARD_NAME &quot;miXart&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Digigram &lt;alsa@digigram.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Digigram &quot;</span> <span class="n">CARD_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Digigram,&quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot;}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>             <span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>              <span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>     <span class="cm">/* Enable this card */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Digigram &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Digigram &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Digigram &quot;</span> <span class="n">CARD_NAME</span> <span class="s">&quot; soundcard.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_mixart_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MOTOROLA</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* MC8240 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_mixart_ids</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_set_pipe_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_group_state_req</span> <span class="n">group_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_group_state_resp</span> <span class="n">group_state_resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">system_msg_uid</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_RUNNING</span>:
	<span class="k">case</span> <span class="n">PIPE_CLOCK_SET</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already started */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_STOPPED</span>:
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">start</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* already stopped */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error mixart_set_pipe_state called with wrong pipe-&gt;status!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>      <span class="cm">/* function called with wrong pipe status */</span>
	<span class="p">}</span>

	<span class="n">system_msg_uid</span> <span class="o">=</span> <span class="mh">0x12345678</span><span class="p">;</span> <span class="cm">/* the event ! (take care: the MSB and two LSB&#39;s have to be 0) */</span>

	<span class="cm">/* wait on the last MSG_SYSTEM_SEND_SYNCHRO_CMD command to be really finished */</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_SYSTEM_WAIT_SYNCHRO_CMD</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">system_msg_uid</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">system_msg_uid</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg_wait_notif</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="n">system_msg_uid</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error : MSG_SYSTEM_WAIT_SYNCHRO_CMD was not notified !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start or stop the pipe (1 pipe) */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">group_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">group_state</span><span class="p">));</span>
	<span class="n">group_state</span><span class="p">.</span><span class="n">pipe_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">group_state</span><span class="p">.</span><span class="n">pipe_uid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_STREAM_START_STREAM_GRP_PACKET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_STREAM_STOP_STREAM_GRP_PACKET</span><span class="p">;</span>

	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">;</span> <span class="cm">/*(struct mixart_uid){0,0};*/</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">group_state</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">group_state</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">group_state_resp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">group_state_resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">group_state_resp</span><span class="p">.</span><span class="n">txx_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_STREAM_ST***_STREAM_GRP_PACKET err=%x stat=%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">group_state_resp</span><span class="p">.</span><span class="n">txx_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

		<span class="n">group_state</span><span class="p">.</span><span class="n">pipe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* in case of start same command once again with pipe_count=0 */</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">group_state_resp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">group_state_resp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">group_state_resp</span><span class="p">.</span><span class="n">txx_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_STREAM_START_STREAM_GRP_PACKET err=%x stat=%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">group_state_resp</span><span class="p">.</span><span class="n">txx_status</span><span class="p">);</span>
 			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* in case of start send a synchro top */</span>

		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_SYSTEM_SEND_SYNCHRO_CMD</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_SYSTEM_SEND_SYNCHRO_CMD err=%x stat=%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PIPE_RUNNING</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="cm">/* !start */</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PIPE_STOPPED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_clock_properties</span> <span class="n">clock_properties</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_clock_properties_resp</span> <span class="n">clock_prop_resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PIPE_CLOCK_SET</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PIPE_RUNNING</span>:
		<span class="k">if</span><span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span><span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* nothing to do */</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error mixart_set_clock(%d) called with wrong pipe-&gt;status !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clock_properties</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clock_properties</span><span class="p">));</span>
	<span class="n">clock_properties</span><span class="p">.</span><span class="n">clock_generic_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">CGT_INTERNAL_CLOCK</span> <span class="o">:</span> <span class="n">CGT_NO_CLOCK</span><span class="p">;</span>
	<span class="n">clock_properties</span><span class="p">.</span><span class="n">clock_mode</span> <span class="o">=</span> <span class="n">CM_STANDALONE</span><span class="p">;</span>
	<span class="n">clock_properties</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">clock_properties</span><span class="p">.</span><span class="n">nb_callers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* only one entry in uid_caller ! */</span>
	<span class="n">clock_properties</span><span class="p">.</span><span class="n">uid_caller</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;mixart_set_clock to %d kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_CLOCK_SET_PROPERTIES</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">uid_console_manager</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">clock_properties</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clock_properties</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clock_prop_resp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">clock_prop_resp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clock_prop_resp</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">clock_prop_resp</span><span class="p">.</span><span class="n">clock_mode</span> <span class="o">!=</span> <span class="n">CM_STANDALONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_CLOCK_SET_PROPERTIES err=%x stat=%x mod=%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">clock_prop_resp</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">clock_prop_resp</span><span class="p">.</span><span class="n">clock_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>  <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PIPE_CLOCK_SET</span><span class="p">;</span>
	<span class="k">else</span>      <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PIPE_RUNNING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Allocate or reference output pipe for analog IOs (pcmp0/1)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span>
<span class="nf">snd_mixart_add_ref_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="kt">int</span> <span class="n">capture</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">monitoring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stream_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">capture</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcm_number</span> <span class="o">==</span> <span class="n">MIXART_PCM_ANALOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pipe_in_ana</span><span class="p">);</span>  <span class="cm">/* analog inputs */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pipe_in_dig</span><span class="p">);</span> <span class="cm">/* digital inputs */</span>
		<span class="p">}</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_STREAM_ADD_OUTPUT_GROUP</span><span class="p">;</span>
		<span class="n">stream_count</span> <span class="o">=</span> <span class="n">MIXART_CAPTURE_STREAMS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcm_number</span> <span class="o">==</span> <span class="n">MIXART_PCM_ANALOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pipe_out_ana</span><span class="p">);</span>  <span class="cm">/* analog outputs */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pipe_out_dig</span><span class="p">);</span>  <span class="cm">/* digital outputs */</span>
		<span class="p">}</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_STREAM_ADD_INPUT_GROUP</span><span class="p">;</span>
		<span class="n">stream_count</span> <span class="o">=</span> <span class="n">MIXART_PLAYBACK_STREAMS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* a new stream is opened and there are already all streams in use */</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">monitoring</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">references</span> <span class="o">&gt;=</span> <span class="n">stream_count</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pipe is not yet defined */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">PIPE_UNDEFINED</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mixart_streaming_group_req</span> <span class="n">sgroup_req</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mixart_streaming_group</span> <span class="n">sgroup_resp</span><span class="p">;</span>
		<span class="p">}</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;add_ref_pipe audio chip(%d) pcm(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>      <span class="cm">/* should be StreamManagerUID, but zero is OK if there is only one ! */</span>
		<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">));</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">stream_count</span> <span class="o">=</span> <span class="n">stream_count</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">channel_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">latency</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">connector</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">uid_left_connector</span><span class="p">;</span>  <span class="cm">/* the left connector */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">stream_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mixart_flowinfo</span> <span class="o">*</span><span class="n">flowinfo</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mixart_bufferinfo</span> <span class="o">*</span><span class="n">bufferinfo</span><span class="p">;</span>
			
			<span class="cm">/* we don&#39;t yet know the format, so config 16 bit pcm audio for instance */</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">stream_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size_max_byte_frame</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">stream_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size_max_sample_frame</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">stream_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">nb_bytes_max_per_sample</span> <span class="o">=</span> <span class="n">MIXART_FLOAT_P__4_0_TO_HEX</span><span class="p">;</span> <span class="cm">/* is 4.0f */</span>

			<span class="cm">/* find the right bufferinfo_array */</span>
			<span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span> <span class="o">*</span> <span class="n">MIXART_MAX_STREAM_PER_CARD</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pcm_number</span> <span class="o">*</span> <span class="p">(</span><span class="n">MIXART_PLAYBACK_STREAMS</span> <span class="o">+</span> <span class="n">MIXART_CAPTURE_STREAMS</span><span class="p">))</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">capture</span><span class="p">)</span> <span class="n">j</span> <span class="o">+=</span> <span class="n">MIXART_PLAYBACK_STREAMS</span><span class="p">;</span> <span class="cm">/* in the array capture is behind playback */</span>

			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_req</span><span class="p">.</span><span class="n">flow_entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">flowinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_flowinfo</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
			<span class="n">flowinfo</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bufferinfo_array_phy_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_bufferinfo</span><span class="p">));</span>
			<span class="n">flowinfo</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bufferinfo_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>               <span class="cm">/* 1 will set the miXart to ring-buffer mode ! */</span>

			<span class="n">bufferinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_bufferinfo</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
			<span class="n">bufferinfo</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">buffer_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>               <span class="cm">/* buffer is not yet allocated */</span>
			<span class="n">bufferinfo</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">available_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>             <span class="cm">/* buffer is not yet allocated */</span>

			<span class="cm">/* construct the identifier of the stream buffer received in the interrupts ! */</span>
			<span class="n">bufferinfo</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">buffer_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span> <span class="o">&lt;&lt;</span> <span class="n">MIXART_NOTIFY_CARD_OFFSET</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">pcm_number</span> <span class="o">&lt;&lt;</span> <span class="n">MIXART_NOTIFY_PCM_OFFSET</span> <span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="n">capture</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bufferinfo</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">buffer_id</span> <span class="o">|=</span> <span class="n">MIXART_NOTIFY_CAPT_MASK</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_resp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_resp</span><span class="p">);</span>
		<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_resp</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_STREAM_ADD_**PUT_GROUP err=%x stat=%x !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_resp</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_resp</span><span class="p">.</span><span class="n">group</span><span class="p">;</span>     <span class="cm">/* id of the pipe, as returned by embedded */</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_count</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">sgroup_resp</span><span class="p">.</span><span class="n">stream_count</span><span class="p">;</span>
		<span class="cm">/* pipe-&gt;stream_uid[i] = buf-&gt;sgroup_resp.stream[i].stream_uid; */</span>

		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PIPE_STOPPED</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">monitoring</span><span class="p">)</span>	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">monitoring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">references</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pipe</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">snd_mixart_kill_ref_pipe</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span> <span class="kt">int</span> <span class="n">monitoring</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">PIPE_UNDEFINED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">monitoring</span><span class="p">)</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">monitoring</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">references</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">references</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">monitoring</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mixart_delete_group_resp</span> <span class="n">delete_resp</span><span class="p">;</span>

		<span class="cm">/* release the clock */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_set_clock</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mixart_set_clock(0) return error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* stop the pipe */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_set_pipe_state</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error stopping pipe!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_STREAM_DELETE_GROUP</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">;</span>            <span class="cm">/* the streaming group ! */</span>
		<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">);</span>

		<span class="cm">/* delete the pipe */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">delete_resp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">delete_resp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">delete_resp</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_STREAM_DELETE_GROUP err(%x), status(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">delete_resp</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">PIPE_UNDEFINED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_set_stream_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream_state_req</span> <span class="n">stream_state_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream_state_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream_state_req</span><span class="p">));</span>
	<span class="n">stream_state_req</span><span class="p">.</span><span class="n">stream_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">stream_state_req</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">stream_desc</span><span class="p">.</span><span class="n">uid_pipe</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">;</span>
	<span class="n">stream_state_req</span><span class="p">.</span><span class="n">stream_info</span><span class="p">.</span><span class="n">stream_desc</span><span class="p">.</span><span class="n">stream_idx</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">start</span> <span class="o">?</span> <span class="n">MSG_STREAM_START_INPUT_STAGE_PACKET</span> <span class="o">:</span> <span class="n">MSG_STREAM_STOP_INPUT_STAGE_PACKET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">start</span> <span class="o">?</span> <span class="n">MSG_STREAM_START_OUTPUT_STAGE_PACKET</span> <span class="o">:</span> <span class="n">MSG_STREAM_STOP_OUTPUT_STAGE_PACKET</span><span class="p">;</span>

	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stream_state_req</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream_state_req</span><span class="p">);</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">abs_period_elapsed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>            <span class="cm">/* reset stream pos      */</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">buf_periods</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">buf_period_frag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_mixart_send_msg_nonblock</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Trigger callback</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:

		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SNDRV_PCM_TRIGGER_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* START_STREAM */</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">mixart_set_stream_state</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_RUNNING</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:

		<span class="cm">/* STOP_STREAM */</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">mixart_set_stream_state</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_OPEN</span><span class="p">;</span>

		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SNDRV_PCM_TRIGGER_STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="cm">/* TODO */</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_PAUSE</span><span class="p">;</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SNDRV_PCM_PAUSE_PUSH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="cm">/* TODO */</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_RUNNING</span><span class="p">;</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;SNDRV_PCM_PAUSE_RELEASE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_sync_nonblock_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_processed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mixart: cannot process nonblock events!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  prepare callback for all pcms</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* TODO de façon non bloquante, réappliquer les hw_params (rate, bits, codec) */</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_mixart_prepare</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mixart_sync_nonblock_events</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">);</span>

	<span class="cm">/* only the first stream can choose the sample rate */</span>
	<span class="cm">/* the further opened streams will be limited to its frequency (see open) */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">ref_count_rate</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* set the clock only once (first stream) on the same pipe */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">references</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">mixart_set_clock</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream_param_desc</span> <span class="n">stream_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_return_uid</span> <span class="n">resp</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream_param</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream_param</span><span class="p">));</span>

	<span class="n">stream_param</span><span class="p">.</span><span class="n">coding_type</span> <span class="o">=</span> <span class="n">CT_LINEAR</span><span class="p">;</span>
	<span class="n">stream_param</span><span class="p">.</span><span class="n">number_of_channel</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="n">stream_param</span><span class="p">.</span><span class="n">sampling_freq</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">stream_param</span><span class="p">.</span><span class="n">sampling_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sampling_freq</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="cm">/* if frequency not yet defined, use some default */</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">format</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U8</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_INTEGER_8</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_INTEGER_16LE</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_INTEGER_16BE</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_3LE</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_INTEGER_24LE</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_3BE</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_INTEGER_24BE</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_FLOAT_LE</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_FLOATING_POINT_32LE</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span>  <span class="n">SNDRV_PCM_FORMAT_FLOAT_BE</span>:
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span> <span class="o">=</span> <span class="n">ST_FLOATING_POINT_32BE</span><span class="p">;</span>
		<span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error mixart_set_format() : unknown format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;set SNDRV_PCM_FORMAT sample_type(%d) sample_size(%d) freq(%d) channels(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">stream_param</span><span class="p">.</span><span class="n">sample_type</span><span class="p">,</span> <span class="n">stream_param</span><span class="p">.</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">stream_param</span><span class="p">.</span><span class="n">sampling_freq</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="cm">/* TODO: what else to configure ? */</span>
	<span class="cm">/* stream_param.samples_per_frame = 2; */</span>
	<span class="cm">/* stream_param.bytes_per_frame = 4; */</span>
	<span class="cm">/* stream_param.bytes_per_sample = 2; */</span>

	<span class="n">stream_param</span><span class="p">.</span><span class="n">pipe_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>      <span class="cm">/* set to 1 */</span>
	<span class="n">stream_param</span><span class="p">.</span><span class="n">stream_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>    <span class="cm">/* set to 1 */</span>
	<span class="n">stream_param</span><span class="p">.</span><span class="n">stream_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uid_pipe</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">group_uid</span><span class="p">;</span>
	<span class="n">stream_param</span><span class="p">.</span><span class="n">stream_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">stream_idx</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_STREAM_SET_INPUT_STAGE_PARAM</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stream_param</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stream_param</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">resp</span><span class="p">.</span><span class="n">error_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;MSG_STREAM_SET_INPUT_STAGE_PARAM err=%x; resp=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">resp</span><span class="p">.</span><span class="n">error_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  HW_PARAMS callback for all pcms</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">,</span>
                                <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* set up channels */</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*  set up format for the stream */</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">params_format</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="cm">/* update the stream levels */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span> <span class="o">&lt;=</span> <span class="n">MIXART_PCM_DIGITAL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">is_aes</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span> <span class="o">&gt;</span> <span class="n">MIXART_PCM_ANALOG</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="p">)</span>
			<span class="n">mixart_update_playback_stream_level</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">is_aes</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mixart_update_capture_stream_level</span><span class="p">(</span> <span class="n">chip</span><span class="p">,</span> <span class="n">is_aes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* set the format to the board */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_set_format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate buffer */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mixart_bufferinfo</span> <span class="o">*</span><span class="n">bufferinfo</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span> <span class="o">*</span> <span class="n">MIXART_MAX_STREAM_PER_CARD</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span> <span class="o">*</span> <span class="p">(</span><span class="n">MIXART_PLAYBACK_STREAMS</span><span class="o">+</span><span class="n">MIXART_CAPTURE_STREAMS</span><span class="p">))</span> <span class="o">+</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="n">MIXART_PLAYBACK_STREAMS</span><span class="p">;</span> <span class="cm">/* in array capture is behind playback */</span>
		<span class="p">}</span>
		
		<span class="n">bufferinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_bufferinfo</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
		<span class="n">bufferinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer_address</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
		<span class="n">bufferinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">available_length</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">;</span>
		<span class="cm">/* bufferinfo[i].buffer_id  is already defined */</span>

		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_mixart_hw_params(pcm %d) : dma_addr(%x) dma_bytes(%x) subs-number(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">bufferinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer_address</span><span class="p">,</span>
				<span class="n">bufferinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">available_length</span><span class="p">,</span>
				<span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="n">mixart_sync_nonblock_events</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> *  TODO CONFIGURATION SPACE for all pcms, mono pcm must update channels_max</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_mixart_analog_caps</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>             <span class="o">=</span> <span class="p">(</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_PAUSE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span>	  <span class="o">=</span> <span class="p">(</span> <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_FMTBIT_S24_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S24_3BE</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_FMTBIT_FLOAT_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_FLOAT_BE</span> <span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span>            <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>         <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>         <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>                  <span class="cm">/* 256 frames U8 mono*/</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="o">/</span><span class="mi">256</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_mixart_digital_caps</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span>             <span class="o">=</span> <span class="p">(</span> <span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_INFO_PAUSE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span>	  <span class="o">=</span> <span class="p">(</span> <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_FMTBIT_S24_3LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S24_3BE</span> <span class="o">|</span>
			      <span class="n">SNDRV_PCM_FMTBIT_FLOAT_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_FLOAT_BE</span> <span class="p">),</span>
	<span class="p">.</span><span class="n">rates</span>            <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span>         <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span>         <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>                  <span class="cm">/* 256 frames U8 mono*/</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span>      <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span>      <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="o">/</span><span class="mi">256</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span>            <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span>        <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span>     <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_pipe</span>       <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcm_number</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">pcm</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">pcm_number</span> <span class="o">=</span> <span class="n">MIXART_PCM_ANALOG</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_mixart_analog_caps</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pcm</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_dig</span><span class="p">);</span>
		<span class="n">pcm_number</span> <span class="o">=</span> <span class="n">MIXART_PCM_DIGITAL</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_mixart_digital_caps</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_mixart_playback_open C%d/P%d/Sub%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/* get stream info */</span>
	<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_stream</span><span class="p">[</span><span class="n">pcm_number</span><span class="p">][</span><span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MIXART_STREAM_STATUS_FREE</span><span class="p">){</span>
		<span class="cm">/* streams in use */</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd_mixart_playback_open C%d/P%d/Sub%d in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit_open</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get pipe pointer (out pipe) */</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">snd_mixart_add_ref_pipe</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit_open</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start the pipe if necessary */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_set_pipe_state</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error starting pipe!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_mixart_kill_ref_pipe</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit_open</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span>        <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span>  <span class="o">=</span> <span class="n">pcm_number</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span>      <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_OPEN</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span>   <span class="o">=</span> <span class="n">subs</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not configured yet */</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">stream</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="cm">/* if a sample rate is already used, another stream cannot change */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">ref_count_rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">_exit_open:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span>            <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span>        <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span>     <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_pipe</span>       <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcm_number</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">pcm</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">pcm_number</span> <span class="o">=</span> <span class="n">MIXART_PCM_ANALOG</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_mixart_analog_caps</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pcm</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_dig</span><span class="p">);</span>
		<span class="n">pcm_number</span> <span class="o">=</span> <span class="n">MIXART_PCM_DIGITAL</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_mixart_digital_caps</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* for instance, no mono */</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_mixart_capture_open C%d/P%d/Sub%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/* get stream info */</span>
	<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_stream</span><span class="p">[</span><span class="n">pcm_number</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">MIXART_STREAM_STATUS_FREE</span><span class="p">){</span>
		<span class="cm">/* streams in use */</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;snd_mixart_capture_open C%d/P%d/Sub%d in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit_open</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get pipe pointer (in pipe) */</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">snd_mixart_add_ref_pipe</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pcm_number</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit_open</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start the pipe if necessary */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_set_pipe_state</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error starting pipe!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_mixart_kill_ref_pipe</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">_exit_open</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span>        <span class="o">=</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span>  <span class="o">=</span> <span class="n">pcm_number</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span>      <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_OPEN</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span>   <span class="o">=</span> <span class="n">subs</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">channels</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not configured yet */</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">stream</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="cm">/* if a sample rate is already used, another stream cannot change */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">ref_count_rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">_exit_open:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">subs</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;snd_mixart_close C%d/P%d/Sub%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span><span class="p">,</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="cm">/* sample rate released */</span>
	<span class="k">if</span><span class="p">(</span><span class="o">--</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">ref_count_rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">sample_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* delete pipe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_mixart_kill_ref_pipe</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error snd_mixart_kill_ref_pipe C%dP%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">pcm_number</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">pipe</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">status</span>    <span class="o">=</span> <span class="n">MIXART_STREAM_STATUS_FREE</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_mixart_stream_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_stream</span>   <span class="o">*</span><span class="n">stream</span>  <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">snd_pcm_uframes_t</span><span class="p">)((</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">buf_periods</span> <span class="o">*</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="o">+</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">buf_period_frag</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_mixart_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>      <span class="o">=</span> <span class="n">snd_mixart_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>     <span class="o">=</span> <span class="n">snd_mixart_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>     <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>   <span class="o">=</span> <span class="n">snd_mixart_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_mixart_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>   <span class="o">=</span> <span class="n">snd_mixart_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>   <span class="o">=</span> <span class="n">snd_mixart_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>   <span class="o">=</span> <span class="n">snd_mixart_stream_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_mixart_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>      <span class="o">=</span> <span class="n">snd_mixart_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>     <span class="o">=</span> <span class="n">snd_mixart_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>     <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span>   <span class="o">=</span> <span class="n">snd_mixart_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_mixart_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span>   <span class="o">=</span> <span class="n">snd_mixart_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span>   <span class="o">=</span> <span class="n">snd_mixart_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span>   <span class="o">=</span> <span class="n">snd_mixart_stream_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">preallocate_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	struct snd_pcm_substream *subs;</span>
<span class="c">	int stream;</span>

<span class="c">	for (stream = 0; stream &lt; 2; stream++) {</span>
<span class="c">		int idx = 0;</span>
<span class="c">		for (subs = pcm-&gt;streams[stream].substream; subs; subs = subs-&gt;next, idx++)</span>
<span class="c">			/* set up the unique device id with the chip index */</span>
<span class="c">			subs-&gt;dma_device.id = subs-&gt;pcm-&gt;device &lt;&lt; 16 |</span>
<span class="c">				subs-&gt;stream &lt;&lt; 8 | (subs-&gt;number + 1) |</span>
<span class="c">				(chip-&gt;chip_idx + 1) &lt;&lt; 24;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_pcm_analog</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;miXart analog %d&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">MIXART_PCM_ANALOG</span><span class="p">,</span>
			       <span class="n">MIXART_PLAYBACK_STREAMS</span><span class="p">,</span>
			       <span class="n">MIXART_CAPTURE_STREAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot create the analog pcm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_mixart_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_mixart_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">preallocate_buffers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pcm</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_pcm_digital</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;miXart AES/EBU %d&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">MIXART_PCM_DIGITAL</span><span class="p">,</span>
			       <span class="n">MIXART_PLAYBACK_STREAMS</span><span class="p">,</span>
			       <span class="n">MIXART_CAPTURE_STREAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot create the digital pcm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_mixart_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_mixart_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">preallocate_buffers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pcm</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_dig</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_chip_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_chip_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_mixart_chip_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_mixart_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_mixart_chip_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot allocate chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">mgr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixart_chip_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_mixart_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span><span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_pcm_analog</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">MIXART_DAUGHTER_TYPE_AES</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_pcm_digital</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * release all the cards assigned to a manager instance</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_mixart_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">snd_card_free</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* stop mailbox */</span>
	<span class="n">snd_mixart_exit_mailbox</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>

	<span class="cm">/* release irq  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mgr</span><span class="p">);</span>

	<span class="cm">/* reset board if some firmware was loaded */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixart_reset_board</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;reset miXart !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* release the i/o ports */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* free flowarray */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">);</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* free bufferarray */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">);</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * proc interface</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">  mixart_BA0 proc interface for BAR 0 - read callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_mixart_BA0_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">file_private_data</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span> <span class="cm">/* make sure the read size is a multiple of 4 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  mixart_BA1 proc interface for BAR 1 - read callback</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">snd_mixart_BA1_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">file_private_data</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span> <span class="cm">/* make sure the read size is a multiple of 4 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user_fromio</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">MIXART_REG</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry_ops</span> <span class="n">snd_mixart_proc_ops_BA0</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>   <span class="o">=</span> <span class="n">snd_mixart_BA0_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_info_entry_ops</span> <span class="n">snd_mixart_proc_ops_BA1</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span>   <span class="o">=</span> <span class="n">snd_mixart_BA1_read</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_mixart_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
                                 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>        
	<span class="n">u32</span> <span class="n">ref</span><span class="p">;</span> 

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Digigram miXart (alsa card %d)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_idx</span><span class="p">);</span>

	<span class="cm">/* stats available when embedded OS is running */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MIXART_MOTHERBOARD_ELF_INDEX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;- hardware -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MIXART_DAUGHTER_TYPE_NONE</span>     : <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">miXart8 (no daughter board)</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MIXART_DAUGHTER_TYPE_AES</span>      : <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">miXart8 AES/EBU</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MIXART_DAUGHTER_TYPE_COBRANET</span> : <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">miXart8 Cobranet</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>                             <span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">UNKNOWN!</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;- system load -</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>	 

		<span class="cm">/* get perf reference */</span>

		<span class="n">ref</span> <span class="o">=</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_PERF_SYSTEM_LOAD_OFFSET</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mailbox</span>   <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_PERF_MAILBX_LOAD_OFFSET</span><span class="p">))</span> <span class="o">/</span> <span class="n">ref</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">streaming</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_PERF_STREAM_LOAD_OFFSET</span><span class="p">))</span> <span class="o">/</span> <span class="n">ref</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">interr</span>    <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_PERF_INTERR_LOAD_OFFSET</span><span class="p">))</span> <span class="o">/</span> <span class="n">ref</span><span class="p">;</span>

			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">streaming          : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">streaming</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">mailbox            : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mailbox</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">interrups handling : %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">interr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* endif elf loaded */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_mixart_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="cm">/* text interface to read perf and temp meters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;board_info&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_mixart_proc_read</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;mixart_BA0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_DATA</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>	
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_mixart_proc_ops_BA0</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">MIXART_BA0_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;mixart_BA1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">content</span> <span class="o">=</span> <span class="n">SNDRV_INFO_CONTENT_DATA</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_mixart_proc_ops_BA1</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">MIXART_BA1_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* end of proc interface */</span>


<span class="cm">/*</span>
<span class="cm"> *    probe function - creates the card manager</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_mixart_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* check if we can restrict PCI DMA transfers to 32 bits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support 32bit PCI busmaster DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 */</span>
	<span class="n">mgr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mgr</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* resource assignment */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">CARD_NAME</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virt</span><span class="p">)</span> <span class="p">{</span>
		        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to remap resource 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span><span class="p">);</span>
			<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_mixart_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">mgr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Digigram miXart&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx &amp; 0x%lx, irq %i&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">phys</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">phys</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* ISR spinlock  */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* init mailbox  */</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_fifo_readptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_fifo_writeptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_mutex</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_sleep</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_processed</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* init setup mutex*/</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">setup_mutex</span><span class="p">);</span>

	<span class="cm">/* init message taslket */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">msg_taskq</span><span class="p">,</span> <span class="n">snd_mixart_msg_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mgr</span><span class="p">);</span>

	<span class="cm">/* card assignment */</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span> <span class="o">=</span> <span class="n">MIXART_MAX_CARDS</span><span class="p">;</span> <span class="cm">/* 4  FIXME: configurable? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">tmpid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">tmpid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpid</span><span class="p">),</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">?</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;MIXART&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">tmpid</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot allocate the card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">CARD_NAME</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;%s [PCM #%d]&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s [PCM #%d]&quot;</span><span class="p">,</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_create</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* init proc interface only for chip0 */</span>
			<span class="n">snd_mixart_proc_init</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* init firmware status (mgr-&gt;dsp_loaded reset in hwdep_new) */</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">MIXART_DAUGHTER_TYPE_NONE</span><span class="p">;</span>

	<span class="cm">/* create array of streaminfo */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span> <span class="p">(</span><span class="n">MIXART_MAX_STREAM_PER_CARD</span> <span class="o">*</span> <span class="n">MIXART_MAX_CARDS</span> <span class="o">*</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_flowinfo</span><span class="p">))</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* init streaminfo_array */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* create array of bufferinfo */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span> <span class="p">(</span><span class="n">MIXART_MAX_STREAM_PER_CARD</span> <span class="o">*</span> <span class="n">MIXART_MAX_CARDS</span> <span class="o">*</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_bufferinfo</span><span class="p">))</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* init bufferinfo_array */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">bufferinfo</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="cm">/* set up firmware */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_setup_firmware</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mgr</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_mixart_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_mixart_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mixart_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_mixart_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_mixart_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_mixart_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">mixart_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
