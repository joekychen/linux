<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › mixart › mixart_hwdep.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mixart_hwdep.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Digigram miXart soundcards</span>
<span class="cm"> *</span>
<span class="cm"> * DSP firmware management</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2003 by Digigram &lt;alsa@digigram.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &quot;mixart.h&quot;</span>
<span class="cp">#include &quot;mixart_mixer.h&quot;</span>
<span class="cp">#include &quot;mixart_core.h&quot;</span>
<span class="cp">#include &quot;mixart_hwdep.h&quot;</span>


<span class="cm">/**</span>
<span class="cm"> * wait for a value on a peudo register, exit with a timeout</span>
<span class="cm"> *</span>
<span class="cm"> * @param mgr pointer to miXart manager structure</span>
<span class="cm"> * @param offset unsigned pseudo_register base + offset of value</span>
<span class="cm"> * @param value value</span>
<span class="cm"> * @param timeout timeout in centisenconds</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_wait_nice_for_register_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_egal</span><span class="p">,</span>
					       <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">read</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>	<span class="cm">/* we may take too long time in this loop.</span>
<span class="cm">		 * so give controls back to kernel if needed.</span>
<span class="cm">		 */</span>
		<span class="n">cond_resched</span><span class="p">();</span>

		<span class="n">read</span> <span class="o">=</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">offset</span> <span class="p">));</span>
		<span class="k">if</span><span class="p">(</span><span class="n">is_egal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span> <span class="cm">/* wait for different value */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">read</span> <span class="o">!=</span> <span class="n">value</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span> <span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">)</span> <span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  structures needed to upload elf code packets </span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">snd_mixart_elf32_ehdr</span> <span class="p">{</span>
	<span class="n">u8</span>      <span class="n">e_ident</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u16</span>     <span class="n">e_type</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_machine</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">e_version</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">e_entry</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">e_phoff</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">e_shoff</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">e_flags</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_ehsize</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_phentsize</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_phnum</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_shentsize</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_shnum</span><span class="p">;</span>
	<span class="n">u16</span>     <span class="n">e_shstrndx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">snd_mixart_elf32_phdr</span> <span class="p">{</span>
	<span class="n">u32</span>     <span class="n">p_type</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_offset</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_vaddr</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_paddr</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_filesz</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_memsz</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_flags</span><span class="p">;</span>
	<span class="n">u32</span>     <span class="n">p_align</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_load_elf</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">dsp</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>                    <span class="n">elf32_magic_number</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x7f</span><span class="p">,</span><span class="sc">&#39;E&#39;</span><span class="p">,</span><span class="sc">&#39;L&#39;</span><span class="p">,</span><span class="sc">&#39;F&#39;</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">snd_mixart_elf32_ehdr</span> <span class="o">*</span><span class="n">elf_header</span><span class="p">;</span>
	<span class="kt">int</span>                     <span class="n">i</span><span class="p">;</span>

	<span class="n">elf_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_mixart_elf32_ehdr</span> <span class="o">*</span><span class="p">)</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">elf32_magic_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">elf_header</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">elf_header</span><span class="o">-&gt;</span><span class="n">e_phoff</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mixart_elf32_phdr</span>     <span class="n">elf_programheader</span><span class="p">;</span>

		<span class="k">for</span><span class="p">(</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">elf_header</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">elf_header</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">i</span> <span class="o">*</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">elf_header</span><span class="o">-&gt;</span><span class="n">e_phentsize</span><span class="p">));</span>

			<span class="n">memcpy</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">elf_programheader</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">elf_programheader</span><span class="p">)</span> <span class="p">);</span>

			<span class="k">if</span><span class="p">(</span><span class="n">elf_programheader</span><span class="p">.</span><span class="n">p_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span> <span class="n">elf_programheader</span><span class="p">.</span><span class="n">p_filesz</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">memcpy_toio</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">elf_programheader</span><span class="p">.</span><span class="n">p_vaddr</span><span class="p">)),</span>
						     <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">be32_to_cpu</span><span class="p">(</span> <span class="n">elf_programheader</span><span class="p">.</span><span class="n">p_offset</span> <span class="p">),</span>
						     <span class="n">be32_to_cpu</span><span class="p">(</span> <span class="n">elf_programheader</span><span class="p">.</span><span class="n">p_filesz</span> <span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get basic information and init miXart</span>
<span class="cm"> */</span>

<span class="cm">/* audio IDs for request to the board */</span>
<span class="cp">#define MIXART_FIRST_ANA_AUDIO_ID       0</span>
<span class="cp">#define MIXART_FIRST_DIG_AUDIO_ID       8</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_enum_connectors</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_enum_connector_resp</span> <span class="o">*</span><span class="n">connector</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_audio_info_req</span>  <span class="o">*</span><span class="n">audio_info_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_audio_info_resp</span> <span class="o">*</span><span class="n">audio_info</span><span class="p">;</span>

	<span class="n">connector</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">connector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">audio_info_req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_info_req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">audio_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">connector</span> <span class="o">||</span> <span class="o">!</span> <span class="n">audio_info_req</span> <span class="o">||</span> <span class="o">!</span> <span class="n">audio_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">audio_info_req</span><span class="o">-&gt;</span><span class="n">line_max_level</span> <span class="o">=</span> <span class="n">MIXART_FLOAT_P_22_0_TO_HEX</span><span class="p">;</span>
	<span class="n">audio_info_req</span><span class="o">-&gt;</span><span class="n">micro_max_level</span> <span class="o">=</span> <span class="n">MIXART_FLOAT_M_20_0_TO_HEX</span><span class="p">;</span>
	<span class="n">audio_info_req</span><span class="o">-&gt;</span><span class="n">cd_max_level</span> <span class="o">=</span> <span class="n">MIXART_FLOAT____0_0_TO_HEX</span><span class="p">;</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_SYSTEM_ENUM_PLAY_CONNECTOR</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>  <span class="cm">/* board num = 0 */</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">connector</span><span class="p">),</span> <span class="n">connector</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid_count</span> <span class="o">&gt;</span> <span class="n">MIXART_MAX_PHYS_CONNECTORS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_SYSTEM_ENUM_PLAY_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid_count</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">MIXART_FIRST_DIG_AUDIO_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pipe_out_ana</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[(</span><span class="n">k</span><span class="o">-</span><span class="n">MIXART_FIRST_DIG_AUDIO_ID</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pipe_out_dig</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">uid_right_connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>   <span class="cm">/* odd */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">uid_left_connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>    <span class="cm">/* even */</span>
		<span class="p">}</span>

		<span class="cm">/* snd_printk(KERN_DEBUG &quot;playback connector[%d].object_id = %x\n&quot;, k, connector-&gt;uid[k].object_id); */</span>

		<span class="cm">/* TODO: really need send_msg MSG_CONNECTOR_GET_AUDIO_INFO for each connector ? perhaps for analog level caps ? */</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_CONNECTOR_GET_AUDIO_INFO</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">audio_info_req</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_info_req</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_info</span><span class="p">),</span> <span class="n">audio_info</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_CONNECTOR_GET_AUDIO_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*snd_printk(KERN_DEBUG &quot;play  analog_info.analog_level_present = %x\n&quot;, audio_info-&gt;info.analog_info.analog_level_present);*/</span>
	<span class="p">}</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_SYSTEM_ENUM_RECORD_CONNECTOR</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>  <span class="cm">/* board num = 0 */</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">connector</span><span class="p">),</span> <span class="n">connector</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid_count</span> <span class="o">&gt;</span> <span class="n">MIXART_MAX_PHYS_CONNECTORS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_SYSTEM_ENUM_RECORD_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid_count</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mixart_pipe</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="n">MIXART_FIRST_DIG_AUDIO_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">k</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pipe_in_ana</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[(</span><span class="n">k</span><span class="o">-</span><span class="n">MIXART_FIRST_DIG_AUDIO_ID</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pipe_in_dig</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">uid_right_connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>   <span class="cm">/* odd */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">uid_left_connector</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>    <span class="cm">/* even */</span>
		<span class="p">}</span>

		<span class="cm">/* snd_printk(KERN_DEBUG &quot;capture connector[%d].object_id = %x\n&quot;, k, connector-&gt;uid[k].object_id); */</span>

		<span class="cm">/* TODO: really need send_msg MSG_CONNECTOR_GET_AUDIO_INFO for each connector ? perhaps for analog level caps ? */</span>
		<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_CONNECTOR_GET_AUDIO_INFO</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">connector</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">audio_info_req</span><span class="p">;</span>
		<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_info_req</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">audio_info</span><span class="p">),</span> <span class="n">audio_info</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_CONNECTOR_GET_AUDIO_INFO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">__error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*snd_printk(KERN_DEBUG &quot;rec  analog_info.analog_level_present = %x\n&quot;, audio_info-&gt;info.analog_info.analog_level_present);*/</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">__error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">audio_info_req</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">audio_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_enum_physio</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_uid</span> <span class="n">get_console_mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_return_uid</span> <span class="n">console_mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_uid_enumeration</span> <span class="n">phys_io</span><span class="p">;</span>

	<span class="cm">/* get the uid for the console manager */</span>
	<span class="n">get_console_mgr</span><span class="p">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">get_console_mgr</span><span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">MSG_CONSOLE_MANAGER</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* cardindex = 0 */</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_CONSOLE_GET_CLOCK_UID</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">get_console_mgr</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">get_console_mgr</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">get_console_mgr</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">console_mgr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">console_mgr</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">console_mgr</span><span class="p">.</span><span class="n">error_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;error MSG_CONSOLE_GET_CLOCK_UID : err=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">console_mgr</span><span class="p">.</span><span class="n">error_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* used later for clock issues ! */</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">uid_console_manager</span> <span class="o">=</span> <span class="n">console_mgr</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>

	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_SYSTEM_ENUM_PHYSICAL_IO</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">console_mgr</span><span class="p">.</span><span class="n">uid</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">console_mgr</span><span class="p">.</span><span class="n">uid</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phys_io</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">phys_io</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span> <span class="n">phys_io</span><span class="p">.</span><span class="n">error_code</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_SYSTEM_ENUM_PHYSICAL_IO err(%x) error_code(%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">phys_io</span><span class="p">.</span><span class="n">error_code</span> <span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* min 2 phys io per card (analog in + analog out) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phys_io</span><span class="p">.</span><span class="n">nb_uid</span> <span class="o">&lt;</span> <span class="n">MIXART_MAX_CARDS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">k</span><span class="o">&lt;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uid_in_analog_physio</span> <span class="o">=</span> <span class="n">phys_io</span><span class="p">.</span><span class="n">uid</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">uid_out_analog_physio</span> <span class="o">=</span> <span class="n">phys_io</span><span class="p">.</span><span class="n">uid</span><span class="p">[</span><span class="n">phys_io</span><span class="p">.</span><span class="n">nb_uid</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">k</span><span class="p">];</span> 
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_first_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mixart_msg</span> <span class="n">request</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">mixart_enum_connectors</span><span class="p">(</span><span class="n">mgr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span><span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">mixart_enum_physio</span><span class="p">(</span><span class="n">mgr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* send a synchro command to card (necessary to do this before first MSG_STREAM_START_STREAM_GRP_PACKET) */</span>
	<span class="cm">/* though why not here */</span>
	<span class="n">request</span><span class="p">.</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">MSG_SYSTEM_SEND_SYNCHRO_CMD</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mixart_uid</span><span class="p">){</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* this command has no data. response is a 32 bit status */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_send_msg</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">k</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">k</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error MSG_SYSTEM_SEND_SYNCHRO_CMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* firmware base addresses (when hard coded) */</span>
<span class="cp">#define MIXART_MOTHERBOARD_XLX_BASE_ADDRESS   0x00600000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_dsp_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span><span class="o">*</span> <span class="n">mgr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>           <span class="n">err</span><span class="p">,</span> <span class="n">card_index</span><span class="p">;</span>
	<span class="n">u32</span>           <span class="n">status_xilinx</span><span class="p">,</span> <span class="n">status_elf</span><span class="p">,</span> <span class="n">status_daught</span><span class="p">;</span>
	<span class="n">u32</span>           <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* read motherboard xilinx status */</span>
	<span class="n">status_xilinx</span> <span class="o">=</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span><span class="n">MIXART_PSEUDOREG_MXLX_STATUS_OFFSET</span> <span class="p">));</span>
	<span class="cm">/* read elf status */</span>
	<span class="n">status_elf</span> <span class="o">=</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span><span class="n">MIXART_PSEUDOREG_ELF_STATUS_OFFSET</span> <span class="p">));</span>
	<span class="cm">/* read daughterboard xilinx status */</span>
	<span class="n">status_daught</span> <span class="o">=</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span><span class="n">MIXART_PSEUDOREG_DXLX_STATUS_OFFSET</span> <span class="p">));</span>

	<span class="cm">/* motherboard xilinx status 5 will say that the board is performing a reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_xilinx</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;miXart is resetting !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span> <span class="cm">/* try again later */</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span>   <span class="p">{</span>
	<span class="k">case</span> <span class="n">MIXART_MOTHERBOARD_XLX_INDEX</span>:

		<span class="cm">/* xilinx already loaded ? */</span> 
		<span class="k">if</span> <span class="p">(</span><span class="n">status_xilinx</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;xilinx is already loaded !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* the status should be 0 == &quot;idle&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_xilinx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xilinx load error ! status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">status_xilinx</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* modprob -r may help ? */</span>
		<span class="p">}</span>

		<span class="cm">/* check xilinx validity */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* set xilinx status to copying */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_MXLX_STATUS_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* setup xilinx base address */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="n">MIXART_MOTHERBOARD_XLX_BASE_ADDRESS</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span><span class="n">MIXART_PSEUDOREG_MXLX_BASE_ADDR_OFFSET</span> <span class="p">));</span>
		<span class="cm">/* setup code size for xilinx file */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_MXLX_SIZE_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* copy xilinx code */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span>  <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_MOTHERBOARD_XLX_BASE_ADDRESS</span><span class="p">),</span>  <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>  <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
    
		<span class="cm">/* set xilinx status to copy finished */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_MXLX_STATUS_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* return, because no further processing needed */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MIXART_MOTHERBOARD_ELF_INDEX</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">status_elf</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;elf file already loaded !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* the status should be 0 == &quot;idle&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_elf</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;elf load error ! status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">status_elf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* modprob -r may help ? */</span>
		<span class="p">}</span>

		<span class="cm">/* wait for xilinx status == 4 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_wait_nice_for_register_value</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_MXLX_STATUS_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span> <span class="cm">/* 5sec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xilinx was not loaded or &quot;</span>
				   <span class="s">&quot;could not be started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* init some data on the card */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_BOARDNUMBER</span> <span class="p">)</span> <span class="p">);</span> <span class="cm">/* set miXart boardnumber to 0 */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_FLOWTABLE_PTR</span> <span class="p">)</span> <span class="p">);</span>         <span class="cm">/* reset pointer to flow table on miXart */</span>

		<span class="cm">/* set elf status to copying */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_ELF_STATUS_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* process the copying of the elf packets */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_load_elf</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">dsp</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* set elf status to copy finished */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_ELF_STATUS_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* wait for elf status == 4 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_wait_nice_for_register_value</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_ELF_STATUS_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span> <span class="cm">/* 3sec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;elf could not be started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* miXart waits at this point on the pointer to the flow table */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">flowinfo</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_FLOWTABLE_PTR</span> <span class="p">)</span> <span class="p">);</span> <span class="cm">/* give pointer of flow table to miXart */</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* return, another xilinx file has to be loaded before */</span>

	<span class="k">case</span> <span class="n">MIXART_AESEBUBOARD_XLX_INDEX</span>:
	<span class="nl">default:</span>

		<span class="cm">/* elf and xilinx should be loaded */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_elf</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">status_xilinx</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xilinx or elf not &quot;</span>
			       <span class="s">&quot;successfully loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* modprob -r may help ? */</span>
		<span class="p">}</span>

		<span class="cm">/* wait for daughter detection != 0 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_wait_nice_for_register_value</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DBRD_PRESENCE_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span> <span class="cm">/* 300msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error starting elf file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* the board type can now be retrieved */</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">DAUGHTER_TYPE_MASK</span> <span class="o">&amp;</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DBRD_TYPE_OFFSET</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">MIXART_DAUGHTER_TYPE_NONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>  <span class="cm">/* no daughter board; the file does not have to be loaded, continue after the switch */</span>

		<span class="cm">/* only if aesebu daughter board presence (elf code must run)  */</span> 
		<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">!=</span> <span class="n">MIXART_DAUGHTER_TYPE_AES</span> <span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* daughter should be idle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_daught</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;daughter load error ! status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">status_daught</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* modprob -r may help ? */</span>
		<span class="p">}</span>
 
		<span class="cm">/* check daughterboard xilinx validity */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">u32</span><span class="o">*</span><span class="p">)(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* inform mixart about the size of the file */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DXLX_SIZE_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* set daughterboard status to 1 */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DXLX_STATUS_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* wait for status == 2 */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_wait_nice_for_register_value</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DXLX_STATUS_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span> <span class="cm">/* 300msec */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;daughter board load error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* get the address where to write the file */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">readl_be</span><span class="p">(</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DXLX_BASE_ADDR_OFFSET</span> <span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* copy daughterboard xilinx code */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span>  <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span>  <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>  <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

		<span class="cm">/* set daughterboard status to 4 */</span>
		<span class="n">writel_be</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="n">MIXART_MEM</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DXLX_STATUS_OFFSET</span> <span class="p">));</span>

		<span class="cm">/* continue with init */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* end of switch file index*/</span>

        <span class="cm">/* wait for daughter status == 3 */</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">mixart_wait_nice_for_register_value</span><span class="p">(</span> <span class="n">mgr</span><span class="p">,</span> <span class="n">MIXART_PSEUDOREG_DXLX_STATUS_OFFSET</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span> <span class="cm">/* 3sec */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;daughter board could not be initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init mailbox (communication with embedded) */</span>
	<span class="n">snd_mixart_init_mailbox</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>

	<span class="cm">/* first communication with embedded */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_first_init</span><span class="p">(</span><span class="n">mgr</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;miXart could not be set up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

       	<span class="cm">/* create devices and mixer in accordance with HW options*/</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">card_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">card_index</span> <span class="o">&lt;</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">num_cards</span><span class="p">;</span> <span class="n">card_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_mixart</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="n">card_index</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_create_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_mixart_create_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mgr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	        		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;miXart firmware downloaded and successfully set up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if defined(CONFIG_FW_LOADER) || defined(CONFIG_FW_LOADER_MODULE)</span>
<span class="cp">#if !defined(CONFIG_USE_MIXARTLOADER) &amp;&amp; !defined(CONFIG_SND_MIXART) </span><span class="cm">/* built-in kernel */</span><span class="cp"></span>
<span class="cp">#define SND_MIXART_FW_LOADER	</span><span class="cm">/* use the standard firmware loader */</span><span class="cp"></span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SND_MIXART_FW_LOADER</span>

<span class="kt">int</span> <span class="nf">snd_mixart_setup_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_files</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;miXart8.xlx&quot;</span><span class="p">,</span> <span class="s">&quot;miXart8.elf&quot;</span><span class="p">,</span> <span class="s">&quot;miXart8AES.xlx&quot;</span>
	<span class="p">};</span>
	<span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;mixart/%s&quot;</span><span class="p">,</span> <span class="n">fw_files</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;miXart: can&#39;t load firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fake hwdep dsp record */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_dsp_load</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fw_entry</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mixart/miXart8.xlx&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mixart/miXart8.elf&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mixart/miXart8AES.xlx&quot;</span><span class="p">);</span>

<span class="cp">#else </span><span class="cm">/* old style firmware loading */</span><span class="cp"></span>

<span class="cm">/* miXart hwdep interface id string */</span>
<span class="cp">#define SND_MIXART_HWDEP_ID       &quot;miXart Loader&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_hwdep_dsp_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_hwdep_dsp_status</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;miXart&quot;</span><span class="p">);</span>
        <span class="n">info</span><span class="o">-&gt;</span><span class="n">num_dsps</span> <span class="o">=</span> <span class="n">MIXART_HARDW_FILES_MAX_INDEX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span>  <span class="n">MIXART_MOTHERBOARD_ELF_INDEX</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">chip_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">MIXART_DRIVER_VERSION</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mixart_hwdep_dsp_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_hwdep_dsp_image</span> <span class="o">*</span><span class="n">dsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mixart_mgr</span><span class="o">*</span> <span class="n">mgr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware</span> <span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">fw</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">fw</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">fw</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;miXart: cannot allocate image size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">fw</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">image</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">fw</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mixart_dsp_load</span><span class="p">(</span><span class="n">mgr</span><span class="p">,</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">fw</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">dsp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_mixart_setup_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">mixart_mgr</span> <span class="o">*</span><span class="n">mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* only create hwdep interface for first cardX (see &quot;index&quot; module parameter)*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hwdep_new</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SND_MIXART_HWDEP_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_HWDEP_IFACE_MIXART</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">mgr</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dsp_status</span> <span class="o">=</span> <span class="n">mixart_hwdep_dsp_status</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">dsp_load</span> <span class="o">=</span> <span class="n">mixart_hwdep_dsp_load</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>  <span class="n">SND_MIXART_HWDEP_ID</span><span class="p">);</span>
	<span class="n">mgr</span><span class="o">-&gt;</span><span class="n">dsp_loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">mgr</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* SND_MIXART_FW_LOADER */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
