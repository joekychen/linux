<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ymfpci › ymfpci_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ymfpci_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) by Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *  Routines for control of YMF724/740/744/754 chips</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/tlv.h&gt;</span>
<span class="cp">#include &lt;sound/ymfpci.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> *  common I/O routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_ymfpci_irq_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">snd_ymfpci_readb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readb</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_writeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">snd_ymfpci_readw</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readw</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_writew</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">snd_ymfpci_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_codec_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">secondary</span> <span class="o">?</span> <span class="n">YDSXGR_SECSTATUSADR</span> <span class="o">:</span> <span class="n">YDSXGR_PRISTATUSADR</span><span class="p">;</span>
	
	<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">750</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">end_time</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_ready: codec %i is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">secondary</span><span class="p">,</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	
	<span class="n">snd_ymfpci_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">((</span><span class="n">YDSXG_AC97WRITECMD</span> <span class="o">|</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_AC97CMDDATA</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">snd_ymfpci_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ymfpci_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_AC97CMDADR</span><span class="p">,</span> <span class="n">YDSXG_AC97READCMD</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ymfpci_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_744</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">600</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PRISTATUSDATA</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PRISTATUSDATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Misc routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">snd_ymfpci_calc_delta</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8000</span>:	<span class="k">return</span> <span class="mh">0x02aaab00</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11025</span>:	<span class="k">return</span> <span class="mh">0x03accd00</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16000</span>:	<span class="k">return</span> <span class="mh">0x05555500</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">22050</span>:	<span class="k">return</span> <span class="mh">0x07599a00</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>:	<span class="k">return</span> <span class="mh">0x0aaaab00</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:	<span class="k">return</span> <span class="mh">0x0eb33300</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">375</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">def_rate</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">100</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">,</span> <span class="mi">11025</span><span class="p">,</span> <span class="mi">16000</span><span class="p">,</span> <span class="mi">22050</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">48000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">snd_ymfpci_calc_lpfK</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">val</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00570000</span><span class="p">,</span> <span class="mh">0x06AA0000</span><span class="p">,</span> <span class="mh">0x18B20000</span><span class="p">,</span> <span class="mh">0x20930000</span><span class="p">,</span>
		<span class="mh">0x2B9A0000</span><span class="p">,</span> <span class="mh">0x35A10000</span><span class="p">,</span> <span class="mh">0x3EAA0000</span><span class="p">,</span> <span class="mh">0x40000000</span>
	<span class="p">};</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x40000000</span><span class="p">;</span>	<span class="cm">/* FIXME: What&#39;s the right value? */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">def_rate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">snd_ymfpci_calc_lpfQ</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">val</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x35280000</span><span class="p">,</span> <span class="mh">0x34A70000</span><span class="p">,</span> <span class="mh">0x32020000</span><span class="p">,</span> <span class="mh">0x31770000</span><span class="p">,</span>
		<span class="mh">0x31390000</span><span class="p">,</span> <span class="mh">0x31C90000</span><span class="p">,</span> <span class="mh">0x33D00000</span><span class="p">,</span> <span class="mh">0x40000000</span>
	<span class="p">};</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0x370A0000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">def_rate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Hardware start management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_hw_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">start_count</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span>
			  <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CTRLSELECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nl">__end:</span>
      	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_hw_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">start_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span>
			  <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep</span><span class="p">);</span>
	<span class="p">}</span>
      <span class="nl">__end:</span>
      	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Playback voice management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">voice_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">snd_ymfpci_voice_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pair</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">**</span><span class="n">rvoice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">,</span> <span class="o">*</span><span class="n">voice2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	
	<span class="o">*</span><span class="n">rvoice</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">YDSXG_PLAYBACK_VOICES</span><span class="p">;</span> <span class="n">idx</span> <span class="o">+=</span> <span class="n">pair</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">voice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">voice2</span> <span class="o">=</span> <span class="n">pair</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">||</span> <span class="p">(</span><span class="n">voice2</span> <span class="o">&amp;&amp;</span> <span class="n">voice2</span><span class="o">-&gt;</span><span class="n">use</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">voice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice2</span><span class="p">)</span>
			<span class="n">voice2</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">YMFPCI_PCM</span>:
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice2</span><span class="p">)</span>
				<span class="n">voice2</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">YMFPCI_SYNTH</span>:
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">synth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">YMFPCI_MIDI</span>:
			<span class="n">voice</span><span class="o">-&gt;</span><span class="n">midi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_ymfpci_hw_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">voice2</span><span class="p">)</span>
			<span class="n">snd_ymfpci_hw_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="o">*</span><span class="n">rvoice</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_voice_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">snd_ymfpci_voice_type</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pair</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">**</span><span class="n">rvoice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">rvoice</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pair</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">YMFPCI_PCM</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">voice_alloc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">rvoice</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">type</span> <span class="o">!=</span> <span class="n">YMFPCI_PCM</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* TODO: synth/midi voice deallocation */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>		
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_voice_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">*</span><span class="n">pvoice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">pvoice</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">snd_ymfpci_hw_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">use</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">synth</span> <span class="o">=</span> <span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">midi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">ypcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pvoice</span><span class="o">-&gt;</span><span class="n">interrupt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_pcm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pos</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">ypcm</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span><span class="p">].</span><span class="n">start</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">&gt;=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			printk(KERN_DEBUG</span>
<span class="cm">			       &quot;done - active_bank = 0x%x, start = 0x%x\n&quot;,</span>
<span class="cm">			       chip-&gt;active_bank,</span>
<span class="cm">			       voice-&gt;bank[chip-&gt;active_bank].start);</span>
<span class="cm">			*/</span>
			<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">%=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">update_pcm_vol</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_bank</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">snd_ymfpci_playback_bank</span> <span class="o">*</span><span class="n">bank</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">volume</span><span class="p">;</span>
			
			<span class="n">bank</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">next_bank</span><span class="p">];</span>
			<span class="n">volume</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
			<span class="n">bank</span><span class="o">-&gt;</span><span class="n">left_gain_end</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span><span class="p">)</span>
				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff2_gain_end</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">bank</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">next_bank</span><span class="p">];</span>
			<span class="n">volume</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">right</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
			<span class="n">bank</span><span class="o">-&gt;</span><span class="n">right_gain_end</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span><span class="p">)</span>
				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff3_gain_end</span> <span class="o">=</span> <span class="n">volume</span><span class="p">;</span>
			<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">update_pcm_vol</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_pcm_capture_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pos</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_capture</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">][</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">&gt;=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">%=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			printk(KERN_DEBUG</span>
<span class="cm">			       &quot;done - active_bank = 0x%x, start = 0x%x\n&quot;,</span>
<span class="cm">			       chip-&gt;active_bank,</span>
<span class="cm">			       voice-&gt;bank[chip-&gt;active_bank].start);</span>
<span class="cm">			*/</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">__unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ctrl_playback</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bank_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ctrl_playback</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bank_addr</span><span class="p">);</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kctl</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">ctl</span><span class="p">;</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ctrl_playback</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ctrl_playback</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
      <span class="nl">__unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kctl</span><span class="p">)</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFREC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFREC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFREC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFREC</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_pcm_voice_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">voices</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">voices</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_voice_free</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voices</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* already allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voices</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* already allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voices</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_ymfpci_voice_free</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>		
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_voice_alloc</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">YMFPCI_PCM</span><span class="p">,</span> <span class="n">voices</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">ypcm</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_interrupt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voices</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">ypcm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_pcm_init_voice</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">voiceidx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">has_pcm_volume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">voiceidx</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">snd_ymfpci_calc_delta</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lpfQ</span> <span class="o">=</span> <span class="n">snd_ymfpci_calc_lpfQ</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">lpfK</span> <span class="o">=</span> <span class="n">snd_ymfpci_calc_lpfK</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_playback_bank</span> <span class="o">*</span><span class="n">bank</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbank</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_left</span><span class="p">,</span> <span class="n">vol_right</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">use_left</span><span class="p">,</span> <span class="n">use_right</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">voice</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">use_left</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">use_right</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">use_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">voiceidx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">use_right</span> <span class="o">=</span> <span class="o">!</span><span class="n">use_left</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_pcm_volume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vol_left</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span>
				       <span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">vol_right</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span>
					<span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">right</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vol_left</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">);</span>
		<span class="n">vol_right</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mh">0x00010000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">format</span> <span class="o">|=</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_754</span> <span class="o">&amp;&amp;</span>
		 <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">44100</span> <span class="o">&amp;&amp;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		 <span class="n">voiceidx</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
				   <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">==</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">=</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">|=</span> <span class="mh">0x10000000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">==</span> <span class="n">voice</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">format</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">voiceidx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">format</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nbank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nbank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">nbank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">nbank</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bank</span><span class="p">));</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">format</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">loop_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">lpfQ</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lpfQ</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">delta</span> <span class="o">=</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">delta_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">delta</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">lpfK</span> <span class="o">=</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">lpfK_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">lpfK</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eg_gain</span> <span class="o">=</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eg_gain_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x40000000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_front</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_left</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">left_gain</span> <span class="o">=</span>
				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">left_gain_end</span> <span class="o">=</span> <span class="n">vol_left</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">use_right</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">right_gain</span> <span class="o">=</span>
				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">right_gain_end</span> <span class="o">=</span> <span class="n">vol_right</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span><span class="p">)</span> <span class="p">{</span>
		        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">swap_rear</span><span class="p">)</span> <span class="p">{</span>
        			<span class="k">if</span> <span class="p">(</span><span class="n">use_left</span><span class="p">)</span> <span class="p">{</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff2_gain</span> <span class="o">=</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff2_gain_end</span> <span class="o">=</span> <span class="n">vol_left</span><span class="p">;</span>
        			<span class="p">}</span>
        			<span class="k">if</span> <span class="p">(</span><span class="n">use_right</span><span class="p">)</span> <span class="p">{</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff3_gain</span> <span class="o">=</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff3_gain_end</span> <span class="o">=</span> <span class="n">vol_right</span><span class="p">;</span>
        			<span class="p">}</span>
		        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        			<span class="cm">/* The SPDIF out channels seem to be swapped, so we have</span>
<span class="cm">        			 * to swap them here, too.  The rear analog out channels</span>
<span class="cm">        			 * will be wrong, but otherwise AC3 would not work.</span>
<span class="cm">        			 */</span>
        			<span class="k">if</span> <span class="p">(</span><span class="n">use_left</span><span class="p">)</span> <span class="p">{</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff3_gain</span> <span class="o">=</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff3_gain_end</span> <span class="o">=</span> <span class="n">vol_left</span><span class="p">;</span>
        			<span class="p">}</span>
        			<span class="k">if</span> <span class="p">(</span><span class="n">use_right</span><span class="p">)</span> <span class="p">{</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff2_gain</span> <span class="o">=</span>
        				<span class="n">bank</span><span class="o">-&gt;</span><span class="n">eff2_gain_end</span> <span class="o">=</span> <span class="n">vol_right</span><span class="p">;</span>
        			<span class="p">}</span>
        		<span class="p">}</span>
                <span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_ac3_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				<span class="mi">4096</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac3_tmp_base</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac3_tmp_base</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">loop_end</span> <span class="o">=</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">loop_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac3_tmp_base</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">2048</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">loop_end</span> <span class="o">=</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">loop_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFEFFECT</span><span class="p">,</span>
			  <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFEFFECT</span><span class="p">)</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_ac3_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFEFFECT</span><span class="p">,</span>
			  <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFEFFECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>snd<em>ymfpci</em>irq_wait(chip);</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac3_tmp_base</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac3_tmp_base</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac3_tmp_base</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_voice_alloc</span><span class="p">(</span><span class="n">ypcm</span><span class="p">,</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="cm">/* wait, until the PCI operations are not finished */</span>
	<span class="n">snd_ymfpci_irq_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_voice_free</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_voice_free</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nvoice</span><span class="p">;</span>

	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nvoice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nvoice</span> <span class="o">&lt;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span> <span class="n">nvoice</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ymfpci_pcm_init_voice</span><span class="p">(</span><span class="n">ypcm</span><span class="p">,</span> <span class="n">nvoice</span><span class="p">,</span> <span class="n">runtime</span><span class="p">,</span>
					  <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">ctl</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="cm">/* wait, until the PCI operations are not finished */</span>
	<span class="n">snd_ymfpci_irq_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_capture_bank</span> <span class="o">*</span> <span class="n">bank</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbank</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">format</span><span class="p">;</span>

	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">period_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="p">((</span><span class="mi">48000</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">/</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">format</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="o">++</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_RECFORMAT</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_RECSLOTSR</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_ADCFORMAT</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_ADCSLOTSR</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">nbank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nbank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">nbank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bank</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_capture</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">][</span><span class="n">nbank</span><span class="p">];</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">loop_end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">&lt;&lt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">);</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bank</span><span class="o">-&gt;</span><span class="n">num_of_loops</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_ymfpci_playback_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">*</span><span class="n">voice</span> <span class="o">=</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="n">voice</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">bank</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span><span class="p">].</span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_ymfpci_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_capture</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">][</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_irq_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">loops</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		 	<span class="k">continue</span><span class="p">;</span>
		<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep_count</span><span class="p">);</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_ymfpci_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">nvoice</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_voice</span> <span class="o">*</span><span class="n">voice</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CTRLSELECT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">nvoice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nvoice</span> <span class="o">&lt;</span> <span class="n">YDSXG_PLAYBACK_VOICES</span><span class="p">;</span> <span class="n">nvoice</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">voice</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">nvoice</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">voice</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span>
				<span class="n">voice</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">voice</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">nvoice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nvoice</span> <span class="o">&lt;</span> <span class="n">YDSXG_CAPTURE_VOICES</span><span class="p">;</span> <span class="n">nvoice</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">[</span><span class="n">nvoice</span><span class="p">])</span>
				<span class="n">snd_ymfpci_pcm_capture_interrupt</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">[</span><span class="n">nvoice</span><span class="p">]);</span>
		<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		for (nvoice = 0; nvoice &lt; YDSXG_EFFECT_VOICES; nvoice++) {</span>
<span class="c">			if (chip-&gt;effect_substream[nvoice])</span>
<span class="c">				snd_ymfpci_pcm_effect_interrupt(chip-&gt;effect_substream[nvoice]);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_STATUS</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_INTFLAG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span>
			<span class="n">snd_timer_interrupt</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_ticks</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_INTFLAG</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rawmidi</span><span class="p">)</span>
		<span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rawmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ymfpci_playback</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span> 
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="cm">/* FIXME: enough? */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="cm">/* FIXME: enough? */</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_ymfpci_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="cm">/* FIXME: enough? */</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">256</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="cm">/* FIXME: enough? */</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_pcm_free_substream</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_open_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ymfpci_playback</span><span class="p">;</span>
	<span class="cm">/* FIXME? True value is 256/48 = 5.33333 ms */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_TIME</span><span class="p">,</span>
					   <span class="mi">5334</span><span class="p">,</span> <span class="n">UINT_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_rule_noresample</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">48000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ypcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ypcm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">PLAYBACK_VOICE</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ypcm</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_free_substream</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* call with spinlock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ymfpci_open_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_opened</span><span class="p">)</span> <span class="cm">/* set AC3 */</span>
			<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span>
					  <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">));</span>
		<span class="cm">/* enable second codec (4CHEN) */</span>
		<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SECCONFIG</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SECCONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0330</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* call with spinlock held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ymfpci_close_extension</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_opened</span><span class="p">)</span>
			<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span>
					  <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">));</span>
		<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SECCONFIG</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SECCONFIG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0330</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0010</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_playback_open_1</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_front</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode_dup4ch</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">swap_rear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ymfpci_open_extension</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_spdif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_playback_open_1</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_front</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">swap_rear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">,</span>
			  <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">)</span> <span class="o">|</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">ymfpci_open_extension</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTSTATUS</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_opened</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_4ch_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_playback_open_1</span><span class="p">(</span><span class="n">substream</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_front</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">swap_rear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ymfpci_open_extension</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">capture_bank_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ymfpci_capture</span><span class="p">;</span>
	<span class="cm">/* FIXME? True value is 256/48 = 5.33333 ms */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					   <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_TIME</span><span class="p">,</span>
					   <span class="mi">5334</span><span class="p">,</span> <span class="n">UINT_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_rule_noresample</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">48000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ypcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ypcm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">capture_bank_number</span> <span class="o">+</span> <span class="n">CAPTURE_REC</span><span class="p">;</span>
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>	
	<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span> <span class="o">=</span> <span class="n">capture_bank_number</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">[</span><span class="n">capture_bank_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ypcm</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_free_substream</span><span class="p">;</span>
	<span class="n">snd_ymfpci_hw_start</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_rec_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_capture_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_ac97_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_capture_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_close_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">output_rear</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ymfpci_close_extension</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_playback_close_1</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_spdif_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_opened</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ymfpci_close_extension</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">,</span>
			  <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTSTATUS</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
		       <span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_playback_close_1</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_playback_4ch_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rear_opened</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ymfpci_close_extension</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_playback_close_1</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ypcm</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">[</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">capture_bank_number</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">snd_ymfpci_hw_stop</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ymfpci_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_ymfpci_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ymfpci_capture_rec_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_ymfpci_capture_rec_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;YMFPCI&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ymfpci_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ymfpci_capture_rec_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;YMFPCI&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ymfpci_capture_ac97_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_ymfpci_capture_ac97_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_ymfpci_capture_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_pcm2</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;YMFPCI - PCM2&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ymfpci_capture_ac97_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;YMFPCI - %s&quot;</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_754</span> <span class="o">?</span> <span class="s">&quot;Direct Recording&quot;</span> <span class="o">:</span> <span class="s">&quot;AC&#39;97&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm2</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ymfpci_playback_spdif_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_ymfpci_playback_spdif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_spdif_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_pcm_spdif</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;YMFPCI - IEC958&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ymfpci_playback_spdif_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;YMFPCI - IEC958&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_ymfpci_playback_4ch_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_ymfpci_playback_4ch_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_4ch_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_ymfpci_playback_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_pcm_4ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span> <span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;YMFPCI - Rear&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_ymfpci_playback_4ch_ops</span><span class="p">);</span>

	<span class="cm">/* global setup */</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;YMFPCI - Rear PCM&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_4ch</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_default_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_default_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_48000</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_default_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTSTATUS</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_spdif_default</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_default_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_default_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_default_put</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_mask_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x3e</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_spdif_mask</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">CON_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_mask_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_mask_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_stream_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_48000</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_spdif_stream_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3e</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">!=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTSTATUS</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_spdif_stream</span> <span class="n">__devinitdata</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PCM_STREAM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_stream_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_stream_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_ymfpci_spdif_stream_put</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_drec_source_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">texts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;AC&#39;97&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span> <span class="s">&quot;ZV Port&quot;</span><span class="p">};</span>

	<span class="k">return</span> <span class="n">snd_ctl_enum_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">texts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_drec_source_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_drec_source_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">old_reg</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">old_reg</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">old_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x100</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">old_reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x300</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span> <span class="o">|</span> <span class="p">((</span><span class="n">value</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg</span> <span class="o">!=</span> <span class="n">old_reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_drec_source</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;Direct Recording Source&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_ymfpci_drec_source_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_ymfpci_drec_source_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_ymfpci_drec_source_put</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  Mixer controls</span>
<span class="cm"> */</span>

<span class="cp">#define YMFPCI_SINGLE(xname, xindex, reg, shift) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_ymfpci_info_single, \</span>
<span class="cp">  .get = snd_ymfpci_get_single, .put = snd_ymfpci_put_single, \</span>
<span class="cp">  .private_value = ((reg) | ((shift) &lt;&lt; 16)) }</span>

<span class="cp">#define snd_ymfpci_info_single		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_get_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span>: <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">YDSXGR_SPDIFINCTRL</span>: <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_put_single</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
 	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span>: <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">YDSXGR_SPDIFINCTRL</span>: <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">oval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">|</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_LINEAR</span><span class="p">(</span><span class="n">db_scale_native</span><span class="p">,</span> <span class="n">TLV_DB_GAIN_MUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#define YMFPCI_DOUBLE(xname, xindex, reg) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READWRITE | SNDRV_CTL_ELEM_ACCESS_TLV_READ, \</span>
<span class="cp">  .info = snd_ymfpci_info_double, \</span>
<span class="cp">  .get = snd_ymfpci_get_double, .put = snd_ymfpci_put_double, \</span>
<span class="cp">  .private_value = reg, \</span>
<span class="cp">  .tlv = { .p = db_scale_native } }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_info_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x80</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">16383</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_get_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shift_right</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">16383</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x80</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">shift_left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="n">shift_right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_put_double</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shift_right</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">16383</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x80</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0xc0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">val1</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">val1</span> <span class="o">&lt;&lt;=</span> <span class="n">shift_left</span><span class="p">;</span>
	<span class="n">val2</span> <span class="o">&lt;&lt;=</span> <span class="n">shift_right</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">val1</span> <span class="o">=</span> <span class="p">(</span><span class="n">oval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift_left</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift_right</span><span class="p">)))</span> <span class="o">|</span> <span class="n">val1</span> <span class="o">|</span> <span class="n">val2</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val1</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_put_nativedacvol</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg2</span> <span class="o">=</span> <span class="n">YDSXGR_BUF441OUTVOL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="n">oval</span><span class="p">;</span>
	
	<span class="n">value</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">oval</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">oval</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg2</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 4ch duplication</span>
<span class="cm"> */</span>
<span class="cp">#define snd_ymfpci_info_dup4ch		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_get_dup4ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode_dup4ch</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_put_dup4ch</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode_dup4ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode_dup4ch</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_dup4ch</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;4ch Duplication&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ymfpci_info_dup4ch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ymfpci_get_dup4ch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ymfpci_put_dup4ch</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_controls</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Wave Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
		  <span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ymfpci_info_double</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ymfpci_get_double</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ymfpci_put_nativedacvol</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">db_scale_native</span> <span class="p">},</span>
<span class="p">},</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;Wave Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACLOOPVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;Digital Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACINVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;Digital Capture Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEADCINVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;ADC Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_PRIADCOUTVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;ADC Capture Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_PRIADCLOOPVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;ADC Playback Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">YDSXGR_SECADCOUTVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;ADC Capture Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">YDSXGR_SECADCLOOPVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="s">&quot;FM Legacy Playback Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_LEGACYOUTVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;AC97 &quot;</span><span class="p">,</span> <span class="n">PLAYBACK</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_ZVOUTVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">CAPTURE</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_ZVLOOPVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;AC97 &quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTVOL</span><span class="p">),</span>
<span class="n">YMFPCI_DOUBLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">VOLUME</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFLOOPVOL</span><span class="p">),</span>
<span class="n">YMFPCI_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">YMFPCI_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">CAPTURE</span><span class="p">,</span><span class="n">SWITCH</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFINCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">YMFPCI_SINGLE</span><span class="p">(</span><span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;Loop&quot;</span><span class="p">,</span><span class="n">NONE</span><span class="p">,</span><span class="n">NONE</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFINCTRL</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * GPIO</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_get_gpio_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOFUNCENABLE</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOFUNCENABLE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* set the level mode for input line */</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOTYPECONFIG</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOTYPECONFIG</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOFUNCENABLE</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOINSTATUS</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&gt;&gt;</span> <span class="n">pin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_set_gpio_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOFUNCENABLE</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pin</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOFUNCENABLE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOOUTCTRL</span><span class="p">,</span> <span class="n">enable</span> <span class="o">&lt;&lt;</span> <span class="n">pin</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GPIOFUNCENABLE</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_ymfpci_gpio_sw_info		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_gpio_sw_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_ymfpci_get_gpio_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_gpio_sw_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pin</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ymfpci_get_gpio_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pin</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_set_gpio_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_ymfpci_get_gpio_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_rear_shared</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Shared Rear/Line-In Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ymfpci_gpio_sw_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ymfpci_gpio_sw_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ymfpci_gpio_sw_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * PCM voice volume</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_pcm_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_pcm_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">left</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">right</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_pcm_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">left</span> <span class="o">||</span>
	    <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">left</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">right</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">left</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">right</span> <span class="o">&gt;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">subs</span><span class="p">].</span><span class="n">right</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>

		<span class="n">substream</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="p">)</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span> <span class="o">&amp;&amp;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_ymfpci_pcm</span> <span class="o">*</span><span class="n">ypcm</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">use_441_slot</span><span class="p">)</span>
				<span class="n">ypcm</span><span class="o">-&gt;</span><span class="n">update_pcm_vol</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_ymfpci_pcm_volume</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
		<span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_ymfpci_pcm_vol_put</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> *  Mixer routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rear_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_ymfpci_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_ymfpci_codec_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ymfpci_mixer_free_ac97_bus</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">no_vra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* YMFPCI doesn&#39;t need VRA */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_ymfpci_mixer_free_ac97</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* to be sure */</span>
	<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">,</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span>
			     <span class="n">AC97_EA_VRA</span><span class="o">|</span><span class="n">AC97_EA_VRM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_ymfpci_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">ext_id</span> <span class="o">&amp;</span> <span class="n">AC97_EI_SDAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_dup4ch</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add S/PDIF control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_spdif_default</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_spdif_mask</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_spdif_stream</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_ctl</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>

	<span class="cm">/* direct recording source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_754</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_drec_source</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * shared rear/line-in</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rear_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_rear_shared</span><span class="p">,</span> <span class="n">chip</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* per-voice volume */</span>
	<span class="n">substream</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_ymfpci_pcm_volume</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">private_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">substream</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">left</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">right</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_mixer</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
		<span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * timer</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">sticks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">sticks</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">sticks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Divisor 1 is not allowed; fake it by using divisor 2 and</span>
<span class="cm">		 * counting two ticks for each interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_TIMERCOUNT</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_TIMERCTRL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_timer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">snd_timer_chip</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writeb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_TIMERCTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_timer_precise_resolution</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">den</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">den</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_timer_hardware</span> <span class="n">snd_ymfpci_timer_hw</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SNDRV_TIMER_HW_AUTO</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">10417</span><span class="p">,</span> <span class="cm">/* 1 / 96 kHz = 10.41666...us */</span>
	<span class="p">.</span><span class="n">ticks</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">snd_ymfpci_timer_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">snd_ymfpci_timer_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">precise_resolution</span> <span class="o">=</span> <span class="n">snd_ymfpci_timer_precise_resolution</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_timer</span> <span class="o">*</span><span class="n">timer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_timer_id</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tid</span><span class="p">.</span><span class="n">dev_class</span> <span class="o">=</span> <span class="n">SNDRV_TIMER_CLASS_CARD</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">dev_sclass</span> <span class="o">=</span> <span class="n">SNDRV_TIMER_SCLASS_NONE</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">tid</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_timer_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;YMFPCI&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;YMFPCI timer&quot;</span><span class="p">);</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_ymfpci_timer_hw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  proc interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> 
				 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;YMFPCI</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">YDSXGR_WORKBASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%04x: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ymfpci&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_ymfpci_proc_read</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  initialization routines</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_aclink_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> // force to reset</span>
<span class="c">	if (cmd &amp; 0x03) {</span>
<span class="cp">#endif</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_CTRL</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_CTRL</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_CTRL</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xfc</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_PWRCTRL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_PWRCTRL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_enable_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CONFIG</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_disable_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CONFIG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CONFIG</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00000002</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">is_1e</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_microcode</span><span class="p">,</span> <span class="s">&quot;yamaha/ds1_dsp.fw&quot;</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_microcode</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">YDSXG_DSPLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;DSP microcode has wrong size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">is_1e</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_724F</span> <span class="o">||</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_740C</span> <span class="o">||</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_744</span> <span class="o">||</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_YAMAHA_754</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">is_1e</span> <span class="o">?</span> <span class="s">&quot;yamaha/ds1e_ctrl.fw&quot;</span> <span class="o">:</span> <span class="s">&quot;yamaha/ds1_ctrl.fw&quot;</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller_microcode</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller_microcode</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">YDSXG_CTRLLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;controller microcode&quot;</span>
				   <span class="s">&quot; has wrong size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;yamaha/ds1_dsp.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;yamaha/ds1_ctrl.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;yamaha/ds1e_ctrl.fw&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_ymfpci_download_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">inst</span><span class="p">;</span>

	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_disable_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span> <span class="mh">0x00010000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFREC</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MAPOFEFFECT</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PLAYCTRLBASE</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_RECCTRLBASE</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_EFFCTRLBASE</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0007</span><span class="p">);</span>

	<span class="cm">/* setup DSP instruction code */</span>
	<span class="n">inst</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_microcode</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">YDSXG_DSPLENGTH</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_DSPINSTRAM</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
				  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

	<span class="cm">/* setup control instruction code */</span>
	<span class="n">inst</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller_microcode</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">YDSXG_CTRLLENGTH</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CTRLINSTRAM</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
				  <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

	<span class="n">snd_ymfpci_enable_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_memalloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">size</span><span class="p">,</span> <span class="n">playback_ctrl_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">voice</span><span class="p">,</span> <span class="n">bank</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">ptr_addr</span><span class="p">;</span>

	<span class="n">playback_ctrl_size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">YDSXG_PLAYBACK_VOICES</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_playback</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PLAYCTRLSIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_capture</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_RECCTRLSIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_effect</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_EFFCTRLSIZE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_size</span> <span class="o">=</span> <span class="n">YDSXG_DEFAULT_WORK_SIZE</span><span class="p">;</span>
	
	<span class="n">size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">playback_ctrl_size</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">ALIGN</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_playback</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">YDSXG_PLAYBACK_VOICES</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">ALIGN</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_capture</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">YDSXG_CAPTURE_VOICES</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">ALIGN</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_effect</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">YDSXG_EFFECT_VOICES</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span>
	       <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_size</span><span class="p">;</span>
	<span class="cm">/* work_ptr must be aligned to 256 bytes, but it&#39;s already</span>
<span class="cm">	   covered with the kernel page allocation mechanism */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">.</span><span class="n">area</span><span class="p">;</span>
	<span class="n">ptr_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>	<span class="cm">/* for sure */</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_playback</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_playback_addr</span> <span class="o">=</span> <span class="n">ptr_addr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ctrl_playback</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ctrl_playback</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">YDSXG_PLAYBACK_VOICES</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">playback_ctrl_size</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">ptr_addr</span> <span class="o">+=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">playback_ctrl_size</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">voice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">voice</span> <span class="o">&lt;</span> <span class="n">YDSXG_PLAYBACK_VOICES</span><span class="p">;</span> <span class="n">voice</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">voice</span><span class="p">].</span><span class="n">number</span> <span class="o">=</span> <span class="n">voice</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">voice</span><span class="p">].</span><span class="n">bank</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci_playback_bank</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">voices</span><span class="p">[</span><span class="n">voice</span><span class="p">].</span><span class="n">bank_addr</span> <span class="o">=</span> <span class="n">ptr_addr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_playback</span><span class="p">[</span><span class="n">voice</span><span class="p">][</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci_playback_bank</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_playback</span><span class="p">;</span>
			<span class="n">ptr_addr</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_playback</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">ptr_addr</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_capture</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_capture_addr</span> <span class="o">=</span> <span class="n">ptr_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">voice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">voice</span> <span class="o">&lt;</span> <span class="n">YDSXG_CAPTURE_VOICES</span><span class="p">;</span> <span class="n">voice</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_capture</span><span class="p">[</span><span class="n">voice</span><span class="p">][</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci_capture_bank</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_capture</span><span class="p">;</span>
			<span class="n">ptr_addr</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_capture</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">ptr_addr</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_effect</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_effect_addr</span> <span class="o">=</span> <span class="n">ptr_addr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">voice</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">voice</span> <span class="o">&lt;</span> <span class="n">YDSXG_EFFECT_VOICES</span><span class="p">;</span> <span class="n">voice</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bank</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">bank</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_effect</span><span class="p">[</span><span class="n">voice</span><span class="p">][</span><span class="n">bank</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci_effect_bank</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_effect</span><span class="p">;</span>
			<span class="n">ptr_addr</span> <span class="o">+=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_size_effect</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">ptr_addr</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">ptr_addr</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_base</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_base_addr</span> <span class="o">=</span> <span class="n">ptr_addr</span><span class="p">;</span>
	
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_size</span> <span class="o">!=</span>
		   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">.</span><span class="n">bytes</span><span class="p">);</span>

	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PLAYCTRLBASE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_playback_addr</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_RECCTRLBASE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_capture_addr</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_EFFCTRLBASE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bank_base_effect_addr</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_WORKBASE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_base_addr</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_WORKSIZE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* S/PDIF output initialization */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_pcm_bits</span> <span class="o">=</span> <span class="n">SNDRV_PCM_DEFAULT_CON_SPDIF</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTSTATUS</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_bits</span><span class="p">);</span>

	<span class="cm">/* S/PDIF input initialization */</span>
	<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFINCTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* digital mixer setup */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xc0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_BUF441OUTVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_ZVOUTVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_SPDIFOUTVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEADCINVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACINVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PRIADCLOOPVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_LEGACYOUTVOL</span><span class="p">,</span> <span class="mh">0x3fff3fff</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_reg_area</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* don&#39;t touch busy hardware */</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_BUF441OUTVOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_LEGACYOUTVOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_STATUS</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_disable_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_PLAYCTRLBASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_RECCTRLBASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_EFFCTRLBASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_WORKBASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_WORKSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">snd_ymfpci_readw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writew</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_GLOBALCTRL</span><span class="p">,</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0007</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_ymfpci_ac3_done</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="cm">/* Set PCI device to D3 state */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* FIXME: temporarily disabled, otherwise we cannot fire up</span>
<span class="c">	 * the chip again unless reboot.  ACPI bug?</span>
<span class="c">	 */</span>
<span class="c">	pci_set_power_state(chip-&gt;pci, 3);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpu_res</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fm_res</span><span class="p">);</span>
	<span class="n">snd_ymfpci_free_gameport</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">work_ptr</span><span class="p">);</span>
	
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_reg_area</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy_ctrl</span><span class="p">);</span>
	
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dsp_microcode</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">controller_microcode</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_ymfpci_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saved_regs_index</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* spdif */</span>
	<span class="n">YDSXGR_SPDIFOUTCTRL</span><span class="p">,</span>
	<span class="n">YDSXGR_SPDIFOUTSTATUS</span><span class="p">,</span>
	<span class="n">YDSXGR_SPDIFINCTRL</span><span class="p">,</span>
	<span class="cm">/* volumes */</span>
	<span class="n">YDSXGR_PRIADCLOOPVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_NATIVEDACINVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_BUF441OUTVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_NATIVEADCINVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_SPDIFLOOPVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_SPDIFOUTVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_ZVOUTVOL</span><span class="p">,</span>
	<span class="n">YDSXGR_LEGACYOUTVOL</span><span class="p">,</span>
	<span class="cm">/* address bases */</span>
	<span class="n">YDSXGR_PLAYCTRLBASE</span><span class="p">,</span>
	<span class="n">YDSXGR_RECCTRLBASE</span><span class="p">,</span>
	<span class="n">YDSXGR_EFFCTRLBASE</span><span class="p">,</span>
	<span class="n">YDSXGR_WORKBASE</span><span class="p">,</span>
	<span class="cm">/* capture set up */</span>
	<span class="n">YDSXGR_MAPOFREC</span><span class="p">,</span>
	<span class="n">YDSXGR_RECFORMAT</span><span class="p">,</span>
	<span class="n">YDSXGR_RECSLOTSR</span><span class="p">,</span>
	<span class="n">YDSXGR_ADCFORMAT</span><span class="p">,</span>
	<span class="n">YDSXGR_ADCSLOTSR</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define YDSXGR_NUM_SAVED_REGS	ARRAY_SIZE(saved_regs_index)</span>

<span class="kt">int</span> <span class="nf">snd_ymfpci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm2</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_spdif</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_4ch</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">YDSXGR_NUM_SAVED_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">saved_regs_index</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_ydsxgr_mode</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_LEGACY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_dsxg_legacy</span><span class="p">);</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_ELEGACY</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_dsxg_elegacy</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_NATIVEDACOUTVOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_BUF441OUTVOL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ymfpci_disable_dsp</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">snd_ymfpci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ymfpci: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_ymfpci_aclink_reset</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_ymfpci_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_ymfpci_download_image</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">YDSXGR_NUM_SAVED_REGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">saved_regs_index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>

	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_LEGACY</span><span class="p">,</span>
			      <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_dsxg_legacy</span><span class="p">);</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCIR_DSXG_ELEGACY</span><span class="p">,</span>
			      <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_dsxg_elegacy</span><span class="p">);</span>

	<span class="cm">/* start hw again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">start_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
		<span class="n">snd_ymfpci_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_MODE</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_ydsxgr_mode</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">active_bank</span> <span class="o">=</span> <span class="n">snd_ymfpci_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">YDSXGR_CTRLSELECT</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_ymfpci_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span> <span class="n">pci</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">old_legacy_ctrl</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">**</span> <span class="n">rchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ymfpci</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_ymfpci_dev_free</span><span class="p">,</span>
	<span class="p">};</span>
	
	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* enable PCI device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">old_legacy_ctrl</span> <span class="o">=</span> <span class="n">old_legacy_ctrl</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">voice_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">interrupt_sleep_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_phys</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_virt</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_phys</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">src441_used</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_reg_area</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_phys</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="s">&quot;YMFPCI&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab memory region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_phys</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_area_phys</span> <span class="o">+</span> <span class="mh">0x8000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_ymfpci_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">snd_ymfpci_aclink_reset</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ymfpci_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_request_firmware</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware request failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_ymfpci_download_image</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="cm">/* seems we need a delay after downloading image.. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ymfpci_memalloc</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ymfpci_ac3_init</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">YDSXGR_NUM_SAVED_REGS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">saved_regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ymfpci_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_ymfpci_proc_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
