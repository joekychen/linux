<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ctxfi › cthw20k2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cthw20k2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) 2008, Creative Technology Ltd. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This source file is released under GPL v2 license (no other versions).</span>
<span class="cm"> * See the COPYING file included in the main directory of this source</span>
<span class="cm"> * distribution for the license terms and conditions.</span>
<span class="cm"> *</span>
<span class="cm"> * @File	cthw20k2.c</span>
<span class="cm"> *</span>
<span class="cm"> * @Brief</span>
<span class="cm"> * This file contains the implementation of hardware access method for 20k2.</span>
<span class="cm"> *</span>
<span class="cm"> * @Author	Liu Chun</span>
<span class="cm"> * @Date 	May 14 2008</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;cthw20k2.h&quot;</span>
<span class="cp">#include &quot;ct20k2reg.h&quot;</span>

<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="cp">#define CT_XFI_DMA_MASK		DMA_BIT_MASK(32) </span><span class="cm">/* 32 bit PTE */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define CT_XFI_DMA_MASK		DMA_BIT_MASK(64) </span><span class="cm">/* 64 bit PTE */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">hw20k2</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="n">hw</span><span class="p">;</span>
	<span class="cm">/* for i2c */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">addr_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data_size</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">mic_source</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hw_write_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Type definition block.</span>
<span class="cm"> * The layout of control structures can be directly applied on 20k2 chip.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * SRC control block definitions.</span>
<span class="cm"> */</span>

<span class="cm">/* SRC resource control block */</span>
<span class="cp">#define SRCCTL_STATE	0x00000007</span>
<span class="cp">#define SRCCTL_BM	0x00000008</span>
<span class="cp">#define SRCCTL_RSR	0x00000030</span>
<span class="cp">#define SRCCTL_SF	0x000001C0</span>
<span class="cp">#define SRCCTL_WR	0x00000200</span>
<span class="cp">#define SRCCTL_PM	0x00000400</span>
<span class="cp">#define SRCCTL_ROM	0x00001800</span>
<span class="cp">#define SRCCTL_VO	0x00002000</span>
<span class="cp">#define SRCCTL_ST	0x00004000</span>
<span class="cp">#define SRCCTL_IE	0x00008000</span>
<span class="cp">#define SRCCTL_ILSZ	0x000F0000</span>
<span class="cp">#define SRCCTL_BP	0x00100000</span>

<span class="cp">#define SRCCCR_CISZ	0x000007FF</span>
<span class="cp">#define SRCCCR_CWA	0x001FF800</span>
<span class="cp">#define SRCCCR_D	0x00200000</span>
<span class="cp">#define SRCCCR_RS	0x01C00000</span>
<span class="cp">#define SRCCCR_NAL	0x3E000000</span>
<span class="cp">#define SRCCCR_RA	0xC0000000</span>

<span class="cp">#define SRCCA_CA	0x0FFFFFFF</span>
<span class="cp">#define SRCCA_RS	0xE0000000</span>

<span class="cp">#define SRCSA_SA	0x0FFFFFFF</span>

<span class="cp">#define SRCLA_LA	0x0FFFFFFF</span>

<span class="cm">/* Mixer Parameter Ring ram Low and Hight register.</span>
<span class="cm"> * Fixed-point value in 8.24 format for parameter channel */</span>
<span class="cp">#define MPRLH_PITCH	0xFFFFFFFF</span>

<span class="cm">/* SRC resource register dirty flags */</span>
<span class="k">union</span> <span class="n">src_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctl</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ccr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">sa</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">la</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ca</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">mpr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">czbfs</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Clear Z-Buffers */</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> 	<span class="n">ccr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ca</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">la</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">mpr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">src_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SRC manager control block */</span>
<span class="k">union</span> <span class="n">src_mgr_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">enb0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb2</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb3</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb4</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb5</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb6</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb7</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enbsa</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">enbsa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">enb</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">union</span> <span class="n">src_mgr_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SRCIMP manager control block */</span>
<span class="cp">#define SRCAIM_ARC	0x00000FFF</span>
<span class="cp">#define SRCAIM_NXT	0x00FF0000</span>
<span class="cp">#define SRCAIM_SRC	0xFF000000</span>

<span class="k">struct</span> <span class="n">srcimap</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srcaim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SRCIMP manager register dirty flags */</span>
<span class="k">union</span> <span class="n">srcimp_mgr_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">srcimap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimap</span>		<span class="n">srcimap</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">srcimp_mgr_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function implementation block.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_get_rsc_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_put_rsc_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_state</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_STATE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_bm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_BM</span><span class="p">,</span> <span class="n">bm</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_rsr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_RSR</span><span class="p">,</span> <span class="n">rsr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_sf</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_SF</span><span class="p">,</span> <span class="n">sf</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_wr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_WR</span><span class="p">,</span> <span class="n">wr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_pm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_PM</span><span class="p">,</span> <span class="n">pm</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_rom</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_ROM</span><span class="p">,</span> <span class="n">rom</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_vo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_VO</span><span class="p">,</span> <span class="n">vo</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_st</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_ST</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_ie</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_IE</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_ilsz</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ilsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_ILSZ</span><span class="p">,</span> <span class="n">ilsz</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_bp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_BP</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_cisz</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cisz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">,</span> <span class="n">SRCCCR_CISZ</span><span class="p">,</span> <span class="n">cisz</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_ca</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">SRCCA_CA</span><span class="p">,</span> <span class="n">ca</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_sa</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">SRCSA_SA</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">sa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_la</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">la</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">la</span><span class="p">,</span> <span class="n">SRCLA_LA</span><span class="p">,</span> <span class="n">la</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">la</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_pitch</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">mpr</span><span class="p">,</span> <span class="n">MPRLH_PITCH</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">mpr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_clear_zbufs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">czbfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_dirty_all</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AR_SLOT_SIZE		4096</span>
<span class="cp">#define AR_SLOT_BLOCK_SIZE	16</span>
<span class="cp">#define AR_PTS_PITCH		6</span>
<span class="cp">#define AR_PARAM_SRC_OFFSET	0x60</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">src_param_pitch_mixer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">src_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">AR_PTS_PITCH</span> <span class="o">+</span> <span class="n">AR_SLOT_SIZE</span>
			<span class="o">-</span> <span class="n">AR_PARAM_SRC_OFFSET</span><span class="p">)</span> <span class="o">%</span> <span class="n">AR_SLOT_SIZE</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">czbfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear Z-Buffer registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_UPZ</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_DN0Z</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_DN1Z</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">czbfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">mpr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Take the parameter mixer resource in the same group as that</span>
<span class="cm">		 * the idx src is in for simplicity. Unlike src, all conjugate</span>
<span class="cm">		 * parameter mixer resources must be programmed for</span>
<span class="cm">		 * corresponding conjugate src resources. */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm_idx</span> <span class="o">=</span> <span class="n">src_param_pitch_mixer</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MIXER_PRING_LO_HI</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">pm_idx</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">mpr</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MIXER_PMOPLO</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">pm_idx</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MIXER_PMOPHI</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">pm_idx</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">mpr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">sa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_SA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">sa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">la</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_LA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">la</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">la</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_CA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write srccf register */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_CF</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ccr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_CCR</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_CTL</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_get_ca</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_CA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">get_field</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">SRCCA_CA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">src_get_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">src_dirty_conj_mask</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_enbs_src</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enbsa</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">idx</span><span class="o">%</span><span class="mi">128</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">));</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">enbsa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">%</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_enb_src</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">%</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_dsb_src</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">%</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">enbsa</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_ENBSTAT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_ENBSA</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">enbsa</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">enbsa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_ENB</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mh">0x100</span><span class="p">),</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imaparc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">,</span> <span class="n">SRCAIM_ARC</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imapuser</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">,</span> <span class="n">SRCAIM_SRC</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imapnxt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">,</span> <span class="n">SRCAIM_NXT</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imapaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_IMAP</span><span class="o">+</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span>
						<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AMIXER control block definitions.</span>
<span class="cm"> */</span>

<span class="cp">#define AMOPLO_M	0x00000003</span>
<span class="cp">#define AMOPLO_IV	0x00000004</span>
<span class="cp">#define AMOPLO_X	0x0003FFF0</span>
<span class="cp">#define AMOPLO_Y	0xFFFC0000</span>

<span class="cp">#define AMOPHI_SADR	0x000000FF</span>
<span class="cp">#define AMOPHI_SE	0x80000000</span>

<span class="cm">/* AMIXER resource register dirty flags */</span>
<span class="k">union</span> <span class="n">amixer_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">amoplo</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">amophi</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* AMIXER resource control block */</span>
<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">amoplo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">amophi</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">amixer_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_mode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_M</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_iv</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_IV</span><span class="p">,</span> <span class="n">iv</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_x</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_y</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_sadr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amophi</span><span class="p">,</span> <span class="n">AMOPHI_SADR</span><span class="p">,</span> <span class="n">sadr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_se</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amophi</span><span class="p">,</span> <span class="n">AMOPHI_SE</span><span class="p">,</span> <span class="n">se</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_dirty_all</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">||</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MIXER_AMOPLO</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MIXER_AMOPHI</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amophi</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_get_y</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">get_field</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_Y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">amixer_get_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_rsc_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_rsc_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_mgr_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DAIO control block definitions.</span>
<span class="cm"> */</span>

<span class="cm">/* Receiver Sample Rate Tracker Control register */</span>
<span class="cp">#define SRTCTL_SRCO	0x000000FF</span>
<span class="cp">#define SRTCTL_SRCM	0x0000FF00</span>
<span class="cp">#define SRTCTL_RSR	0x00030000</span>
<span class="cp">#define SRTCTL_DRAT	0x00300000</span>
<span class="cp">#define SRTCTL_EC	0x01000000</span>
<span class="cp">#define SRTCTL_ET	0x10000000</span>

<span class="cm">/* DAIO Receiver register dirty flags */</span>
<span class="k">union</span> <span class="n">dai_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">srt</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* DAIO Receiver control block */</span>
<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">srt</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">dai_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Audio Input Mapper RAM */</span>
<span class="cp">#define AIM_ARC		0x00000FFF</span>
<span class="cp">#define AIM_NXT		0x007F0000</span>

<span class="k">struct</span> <span class="n">daoimap</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Audio Transmitter Control and Status register */</span>
<span class="cp">#define ATXCTL_EN	0x00000001</span>
<span class="cp">#define ATXCTL_MODE	0x00000010</span>
<span class="cp">#define ATXCTL_CD	0x00000020</span>
<span class="cp">#define ATXCTL_RAW	0x00000100</span>
<span class="cp">#define ATXCTL_MT	0x00000200</span>
<span class="cp">#define ATXCTL_NUC	0x00003000</span>
<span class="cp">#define ATXCTL_BEN	0x00010000</span>
<span class="cp">#define ATXCTL_BMUX	0x00700000</span>
<span class="cp">#define ATXCTL_B24	0x01000000</span>
<span class="cp">#define ATXCTL_CPF	0x02000000</span>
<span class="cp">#define ATXCTL_RIV	0x10000000</span>
<span class="cp">#define ATXCTL_LIV	0x20000000</span>
<span class="cp">#define ATXCTL_RSAT	0x40000000</span>
<span class="cp">#define ATXCTL_LSAT	0x80000000</span>

<span class="cm">/* XDIF Transmitter register dirty flags */</span>
<span class="k">union</span> <span class="n">dao_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">atxcsl</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* XDIF Transmitter control block */</span>
<span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="p">{</span>
	<span class="cm">/* XDIF Transmitter Channel Status Low Register */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">atxcsl</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">dao_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Audio Receiver Control register */</span>
<span class="cp">#define ARXCTL_EN	0x00000001</span>

<span class="cm">/* DAIO manager register dirty flags */</span>
<span class="k">union</span> <span class="n">daio_mgr_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">atxctl</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">arxctl</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">daoimap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* DAIO manager control block */</span>
<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">daoimap</span>		<span class="n">daoimap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">txctl</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">rxctl</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">union</span> <span class="n">daio_mgr_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_srco</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="n">SRTCTL_SRCO</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_srcm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="n">SRTCTL_SRCM</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_rsr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="n">SRTCTL_RSR</span><span class="p">,</span> <span class="n">rsr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_drat</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="n">SRTCTL_DRAT</span><span class="p">,</span> <span class="n">drat</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_ec</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="n">SRTCTL_EC</span><span class="p">,</span> <span class="n">ec</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_et</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">et</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">,</span> <span class="n">SRTCTL_ET</span><span class="p">,</span> <span class="n">et</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_RX_SRT_CTL</span><span class="o">+</span><span class="mh">0x40</span><span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srt</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_set_spos</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">atxcsl</span> <span class="o">=</span> <span class="n">spos</span><span class="p">;</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxcsl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxcsl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* S/PDIF SPOSx */</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_CSTAT_L</span><span class="o">+</span><span class="mh">0x40</span><span class="o">*</span><span class="n">idx</span><span class="p">,</span>
							<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">atxcsl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxcsl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_get_spos</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">spos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">spos</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">atxcsl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_enb_dai</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ARXCTL_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">arxctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_dsb_dai</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ARXCTL_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">arxctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_enb_dao</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_dsb_dao</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_dao_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S/PDIF output */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">conf</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_NUC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_NUC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_NUC</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_NUC</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* CDIF */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_CD</span><span class="p">,</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conf</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)));</span>
		<span class="cm">/* Non-audio */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_LIV</span><span class="p">,</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="cm">/* Non-audio */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_RIV</span><span class="p">,</span> <span class="p">(</span><span class="n">conf</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ATXCTL_RAW</span><span class="p">,</span>
			  <span class="p">((</span><span class="n">conf</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2S output */</span>
		<span class="cm">/*idx %= 4; */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_set_imaparc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">aim</span><span class="p">,</span> <span class="n">AIM_ARC</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_set_imapnxt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">aim</span><span class="p">,</span> <span class="n">AIM_NXT</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_set_imapaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">AUDIO_IO_TX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">)),</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">atxctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">arxctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">AUDIO_IO_RX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">)),</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">arxctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_AIM</span><span class="o">+</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
						<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">aim</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_get_ctrl_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">blk</span><span class="o">-&gt;</span><span class="n">txctl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
		<span class="n">blk</span><span class="o">-&gt;</span><span class="n">rxctl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_RX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Timer interrupt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_timer_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIE</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">IT_INT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_timer_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
		<span class="n">ticks</span> <span class="o">|=</span> <span class="n">TIMR_IE</span> <span class="o">|</span> <span class="n">TIMR_IP</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TIMR</span><span class="p">,</span> <span class="n">ticks</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_wc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">WC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Card hardware initialization block */</span>
<span class="k">struct</span> <span class="n">dac_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span> <span class="cm">/* master sample rate in rsrs */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">adc_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span> 	<span class="cm">/* master sample rate in rsrs */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">input</span><span class="p">;</span> 	<span class="cm">/* the input source of ADC */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mic20db</span><span class="p">;</span> 	<span class="cm">/* boost mic by 20db if input is microphone */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">daio_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span> <span class="cm">/* master sample rate in rsrs */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">trn_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vm_pgt_phys</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_daio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">daio_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Program I2S with proper sample rate and enable the correct I2S</span>
<span class="cm">	 * channel. ED(0/8/16/24): Enable all I2S/I2X master clock output */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_MCLK</span><span class="p">,</span> <span class="mh">0x01010101</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_BLRCLK</span><span class="p">,</span> <span class="mh">0x01010101</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_RX_BLRCLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_MCLK</span><span class="p">,</span> <span class="mh">0x11111111</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* PCM4220 on Titanium HD is different. */</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_MCLK</span><span class="p">,</span> <span class="mh">0x11011111</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Specify all playing 96khz</span>
<span class="cm">		 * EA [0]	- Enabled</span>
<span class="cm">		 * RTA [4:5]	- 96kHz</span>
<span class="cm">		 * EB [8]	- Enabled</span>
<span class="cm">		 * RTB [12:13]	- 96kHz</span>
<span class="cm">		 * EC [16]	- Enabled</span>
<span class="cm">		 * RTC [20:21]	- 96kHz</span>
<span class="cm">		 * ED [24]	- Enabled</span>
<span class="cm">		 * RTD [28:29]	- 96kHz */</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_BLRCLK</span><span class="p">,</span> <span class="mh">0x11111111</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_RX_BLRCLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="mi">4</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_MCLK</span><span class="p">,</span> <span class="mh">0x21011111</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_BLRCLK</span><span class="p">,</span> <span class="mh">0x21212121</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_RX_BLRCLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ctxfi: ERROR!!! Invalid sampling rate!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This comment looks wrong since loop is over 4  */</span>
			<span class="cm">/* channels and emu20k2 supports 4 spdif IOs.     */</span>
			<span class="cm">/* 1st 3 channels are SPDIFs (SB0960) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">=</span> <span class="mh">0x1001001</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">=</span> <span class="mh">0x1000001</span><span class="p">;</span>

			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">AUDIO_IO_TX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">)),</span> <span class="n">data</span><span class="p">);</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="n">AUDIO_IO_RX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">)),</span> <span class="n">data</span><span class="p">);</span>

			<span class="cm">/* Initialize the SPDIF Out Channel status registers.</span>
<span class="cm">			 * The value specified here is based on the typical</span>
<span class="cm">			 * values provided in the specification, namely: Clock</span>
<span class="cm">			 * Accuracy of 1000ppm, Sample Rate of 48KHz,</span>
<span class="cm">			 * unspecified source number, Generation status = 1,</span>
<span class="cm">			 * Category code = 0x12 (Digital Signal Mixer),</span>
<span class="cm">			 * Mode = 0, Emph = 0, Copy Permitted, AN = 0</span>
<span class="cm">			 * (indicating that we&#39;re transmitting digital audio,</span>
<span class="cm">			 * and the Professional Use bit is 0. */</span>

			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_CSTAT_L</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">),</span>
					<span class="mh">0x02109204</span><span class="p">);</span> <span class="cm">/* Default to 48kHz */</span>

			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_CSTAT_H</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="mh">0x0B</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Again, loop is over 4 channels not 5. */</span>
			<span class="cm">/* Next 5 channels are I2S (SB0960) */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_RX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Four channels per sample period */</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x1000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* FIXME: check this against the chip spec */</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AUDIO_IO_TX_CTL</span><span class="o">+</span><span class="p">(</span><span class="mh">0x40</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TRANSPORT operations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_trn_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trn_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vmctl</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptp_phys_low</span><span class="p">,</span> <span class="n">ptp_phys_high</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set up device page table */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ctxfi: &quot;</span>
		       <span class="s">&quot;Wrong device page table page address!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vmctl</span> <span class="o">=</span> <span class="mh">0x80000C0F</span><span class="p">;</span>  <span class="cm">/* 32-bit, 4k-size page */</span>
	<span class="n">ptp_phys_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">;</span>
	<span class="n">ptp_phys_high</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* 64bit address */</span>
		<span class="n">vmctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* Write page table physical address to all PTPAL registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">VMEM_PTPAL</span><span class="o">+</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">ptp_phys_low</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">VMEM_PTPAH</span><span class="o">+</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">ptp_phys_high</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Enable virtual memory transfer */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">VMEM_CTL</span><span class="p">,</span> <span class="n">vmctl</span><span class="p">);</span>
	<span class="cm">/* Enable transport bus master and queueing of request */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRANSPORT_CTL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRANSPORT_INT</span><span class="p">,</span> <span class="mh">0x200c01</span><span class="p">);</span>
	<span class="cm">/* Enable transport ring */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRANSPORT_ENB</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRANSPORT_ENB</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card initialization */</span>
<span class="cp">#define GCTL_AIE	0x00000001</span>
<span class="cp">#define GCTL_UAA	0x00000002</span>
<span class="cp">#define GCTL_DPC	0x00000004</span>
<span class="cp">#define GCTL_DBP	0x00000008</span>
<span class="cp">#define GCTL_ABP	0x00000010</span>
<span class="cp">#define GCTL_TBP	0x00000020</span>
<span class="cp">#define GCTL_SBP	0x00000040</span>
<span class="cp">#define GCTL_FBP	0x00000080</span>
<span class="cp">#define GCTL_ME		0x00000100</span>
<span class="cp">#define GCTL_AID	0x00001000</span>

<span class="cp">#define PLLCTL_SRC	0x00000007</span>
<span class="cp">#define PLLCTL_SPE	0x00000008</span>
<span class="cp">#define PLLCTL_RD	0x000000F0</span>
<span class="cp">#define PLLCTL_FD	0x0001FF00</span>
<span class="cp">#define PLLCTL_OD	0x00060000</span>
<span class="cp">#define PLLCTL_B	0x00080000</span>
<span class="cp">#define PLLCTL_AS	0x00100000</span>
<span class="cp">#define PLLCTL_LF	0x03E00000</span>
<span class="cp">#define PLLCTL_SPS	0x1C000000</span>
<span class="cp">#define PLLCTL_AD	0x60000000</span>

<span class="cp">#define PLLSTAT_CCS	0x00000007</span>
<span class="cp">#define PLLSTAT_SPL	0x00000008</span>
<span class="cp">#define PLLSTAT_CRD	0x000000F0</span>
<span class="cp">#define PLLSTAT_CFD	0x0001FF00</span>
<span class="cp">#define PLLSTAT_SL	0x00020000</span>
<span class="cp">#define PLLSTAT_FAS	0x00040000</span>
<span class="cp">#define PLLSTAT_B	0x00080000</span>
<span class="cp">#define PLLSTAT_PD	0x00100000</span>
<span class="cp">#define PLLSTAT_OCA	0x00200000</span>
<span class="cp">#define PLLSTAT_NCA	0x00400000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pllenb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pllctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pllstat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pllenb</span> <span class="o">=</span> <span class="mh">0xB</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_ENB</span><span class="p">,</span> <span class="n">pllenb</span><span class="p">);</span>
	<span class="n">pllctl</span> <span class="o">=</span> <span class="mh">0x20C00000</span><span class="p">;</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_FD</span><span class="p">,</span> <span class="mi">48000</span> <span class="o">==</span> <span class="n">rsr</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">147</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_RD</span><span class="p">,</span> <span class="mi">48000</span> <span class="o">==</span> <span class="n">rsr</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">10</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_CTL</span><span class="p">,</span> <span class="n">pllctl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="n">pllctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_CTL</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_FD</span><span class="p">,</span> <span class="mi">48000</span> <span class="o">==</span> <span class="n">rsr</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">147</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_CTL</span><span class="p">,</span> <span class="n">pllctl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pllstat</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">pllstat</span><span class="p">,</span> <span class="n">PLLSTAT_PD</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">pllstat</span><span class="p">,</span> <span class="n">PLLSTAT_B</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">get_field</span><span class="p">(</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_B</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">pllstat</span><span class="p">,</span> <span class="n">PLLSTAT_CCS</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">get_field</span><span class="p">(</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_SRC</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">pllstat</span><span class="p">,</span> <span class="n">PLLSTAT_CRD</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">get_field</span><span class="p">(</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_RD</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">pllstat</span><span class="p">,</span> <span class="n">PLLSTAT_CFD</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">get_field</span><span class="p">(</span><span class="n">pllctl</span><span class="p">,</span> <span class="n">PLLCTL_FD</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ctxfi: PLL initialization failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_auto_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_AIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_AIE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">400000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_AID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_field</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_AID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ctxfi: Card Auto-init failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* DAC operations */</span>

<span class="cp">#define CS4382_MC1 		0x1</span>
<span class="cp">#define CS4382_MC2 		0x2</span>
<span class="cp">#define CS4382_MC3		0x3</span>
<span class="cp">#define CS4382_FC		0x4</span>
<span class="cp">#define CS4382_IC		0x5</span>
<span class="cp">#define CS4382_XC1		0x6</span>
<span class="cp">#define CS4382_VCA1 		0x7</span>
<span class="cp">#define CS4382_VCB1 		0x8</span>
<span class="cp">#define CS4382_XC2		0x9</span>
<span class="cp">#define CS4382_VCA2 		0xA</span>
<span class="cp">#define CS4382_VCB2 		0xB</span>
<span class="cp">#define CS4382_XC3		0xC</span>
<span class="cp">#define CS4382_VCA3		0xD</span>
<span class="cp">#define CS4382_VCB3		0xE</span>
<span class="cp">#define CS4382_XC4 		0xF</span>
<span class="cp">#define CS4382_VCA4 		0x10</span>
<span class="cp">#define CS4382_VCB4 		0x11</span>
<span class="cp">#define CS4382_CREV 		0x12</span>

<span class="cm">/* I2C status */</span>
<span class="cp">#define STATE_LOCKED		0x00</span>
<span class="cp">#define STATE_UNLOCKED		0xAA</span>
<span class="cp">#define DATA_READY		0x800000    </span><span class="cm">/* Used with I2C_IF_STATUS */</span><span class="cp"></span>
<span class="cp">#define DATA_ABORT		0x10000     </span><span class="cm">/* Used with I2C_IF_STATUS */</span><span class="cp"></span>

<span class="cp">#define I2C_STATUS_DCM	0x00000001</span>
<span class="cp">#define I2C_STATUS_BC	0x00000006</span>
<span class="cp">#define I2C_STATUS_APD	0x00000008</span>
<span class="cp">#define I2C_STATUS_AB	0x00010000</span>
<span class="cp">#define I2C_STATUS_DR	0x00800000</span>

<span class="cp">#define I2C_ADDRESS_PTAD	0x0000FFFF</span>
<span class="cp">#define I2C_ADDRESS_SLAD	0x007F0000</span>

<span class="k">struct</span> <span class="n">regs_cs4382</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">mode_control_1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode_control_2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode_control_3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">filter_control</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">invert_control</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">mix_control_P1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_A1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_B1</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">mix_control_P2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_A2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_B2</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">mix_control_P3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_A3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_B3</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">mix_control_P4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_A4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vol_control_B4</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_unlock_full_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">UnlockKeySequence_FLASH_FULLACCESS_MODE</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="p">{</span><span class="mh">0xB3</span><span class="p">,</span> <span class="mh">0xD4</span><span class="p">};</span>

	<span class="cm">/* Send keys for forced BIOS mode */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WLOCK</span><span class="p">,</span>
			<span class="n">UnlockKeySequence_FLASH_FULLACCESS_MODE</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WLOCK</span><span class="p">,</span>
			<span class="n">UnlockKeySequence_FLASH_FULLACCESS_MODE</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="cm">/* Check whether the chip is unlocked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WLOCK</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_UNLOCKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_lock_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Write twice */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WLOCK</span><span class="p">,</span> <span class="n">STATE_LOCKED</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WLOCK</span><span class="p">,</span> <span class="n">STATE_LOCKED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WLOCK</span><span class="p">)</span> <span class="o">==</span> <span class="n">STATE_LOCKED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr_size</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="n">hw20k2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_addr</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw20k2_i2c_unlock_full_access</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">addr_size</span> <span class="o">=</span> <span class="n">addr_size</span><span class="p">;</span>
	<span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">i2c_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="n">I2C_ADDRESS_SLAD</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_ADDRESS</span><span class="p">,</span> <span class="n">i2c_addr</span><span class="p">);</span>

	<span class="n">i2c_status</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">);</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_status</span><span class="p">,</span> <span class="n">I2C_STATUS_DCM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Direct control mode */</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">,</span> <span class="n">i2c_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_uninit</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_addr</span><span class="p">;</span>

	<span class="n">i2c_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_addr</span><span class="p">,</span> <span class="n">I2C_ADDRESS_SLAD</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">);</span> <span class="cm">/* I2C id */</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_ADDRESS</span><span class="p">,</span> <span class="n">i2c_addr</span><span class="p">);</span>

	<span class="n">i2c_status</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">);</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_status</span><span class="p">,</span> <span class="n">I2C_STATUS_DCM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* I2C mode */</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">,</span> <span class="n">i2c_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hw20k2_i2c_lock_chip</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="n">DATA_READY</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">datap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="n">hw20k2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_status</span><span class="p">;</span>

	<span class="n">i2c_status</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_status</span><span class="p">,</span> <span class="n">I2C_STATUS_BC</span><span class="p">,</span>
		  <span class="p">(</span><span class="mi">4</span> <span class="o">==</span> <span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">addr_size</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">addr_size</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">,</span> <span class="n">i2c_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WDATA</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Force a read operation */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_RDATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">datap</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_RDATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw20k2_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="n">hw20k2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">addr_size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">|</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2c_status</span><span class="p">;</span>

	<span class="n">i2c_status</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">);</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2c_status</span><span class="p">,</span> <span class="n">I2C_STATUS_BC</span><span class="p">,</span>
		  <span class="p">(</span><span class="mi">4</span> <span class="o">==</span> <span class="p">(</span><span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">addr_size</span> <span class="o">+</span> <span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">))</span> <span class="o">?</span>
		  <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">addr_size</span> <span class="o">+</span> <span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">));</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_STATUS</span><span class="p">,</span> <span class="n">i2c_status</span><span class="p">);</span>
	<span class="n">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* Dummy write to trigger the write operation */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WDATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* This is the real data */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2C_IF_WDATA</span><span class="p">,</span> <span class="n">i2c_data</span><span class="p">);</span>
	<span class="n">hw20k2_i2c_wait_data_ready</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_dac_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFD</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_dac_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_dac_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_dac_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">hw_dac_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_dac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dac_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regs_cs4382</span> <span class="n">cs_read</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">regs_cs4382</span> <span class="n">cs_def</span> <span class="o">=</span> <span class="p">{</span>
				   <span class="mh">0x00000001</span><span class="p">,</span>  <span class="cm">/* Mode Control 1 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Mode Control 2 */</span>
				   <span class="mh">0x00000084</span><span class="p">,</span>  <span class="cm">/* Mode Control 3 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Filter Control */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Invert Control */</span>
				   <span class="mh">0x00000024</span><span class="p">,</span>  <span class="cm">/* Mixing Control Pair 1 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control A1 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control B1 */</span>
				   <span class="mh">0x00000024</span><span class="p">,</span>  <span class="cm">/* Mixing Control Pair 2 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control A2 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control B2 */</span>
				   <span class="mh">0x00000024</span><span class="p">,</span>  <span class="cm">/* Mixing Control Pair 3 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control A3 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control B3 */</span>
				   <span class="mh">0x00000024</span><span class="p">,</span>  <span class="cm">/* Mixing Control Pair 4 */</span>
				   <span class="mh">0x00000000</span><span class="p">,</span>  <span class="cm">/* Vol Control A4 */</span>
				   <span class="mh">0x00000000</span>   <span class="cm">/* Vol Control B4 */</span>
				 <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_dac_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0600</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x0000</span><span class="p">;</span> <span class="cm">/* Single Speed Mode 0-50kHz */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span> <span class="cm">/* Double Speed Mode 50-100kHz */</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x0600</span><span class="p">;</span> <span class="cm">/* Quad Speed Mode 100-200kHz */</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">hw_dac_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set DAC reset bit as output */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hw20k2_i2c_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">End</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset DAC twice just in-case the chip</span>
<span class="cm">		 * didn&#39;t initialized properly */</span>
		<span class="n">hw_dac_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">hw_dac_reset</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_MC1</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mode_control_1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_MC2</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mode_control_2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_MC3</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mode_control_3</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_FC</span><span class="p">,</span>   <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">filter_control</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_IC</span><span class="p">,</span>   <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">invert_control</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC1</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mix_control_P1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCA1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_A1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCB1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_B1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC2</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mix_control_P2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCA2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_A2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCB2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_B2</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC3</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mix_control_P3</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCA3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_A3</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCB3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_B3</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC4</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">mix_control_P4</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCA4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_A4</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw20k2_i2c_read</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_VCB4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_read</span><span class="p">.</span><span class="n">vol_control_B4</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs_read</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs_def</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cs_read</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">End</span><span class="p">;</span>

	<span class="cm">/* Note: Every I2C write must have some delay.</span>
<span class="cm">	 * This is not a requirement but the delay works here... */</span>
	<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_MC1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_MC2</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC1</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC2</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC3</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC4</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC1</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC2</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC3</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC4</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC1</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC2</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC3</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">CS4382_XC4</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">End:</span>

	<span class="n">hw20k2_i2c_uninit</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ADC operations */</span>
<span class="cp">#define MAKE_WM8775_ADDR(addr, data)	(u32)(((addr&lt;&lt;1)&amp;0xFE)|((data&gt;&gt;8)&amp;0x1))</span>
<span class="cp">#define MAKE_WM8775_DATA(data)	(u32)(data&amp;0xFF)</span>

<span class="cp">#define WM8775_IC       0x0B</span>
<span class="cp">#define WM8775_MMC      0x0C</span>
<span class="cp">#define WM8775_AADCL    0x0E</span>
<span class="cp">#define WM8775_AADCR    0x0F</span>
<span class="cp">#define WM8775_ADCMC    0x15</span>
<span class="cp">#define WM8775_RESET    0x17</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_is_adc_input_selected</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Titanium HD has two ADC chips, one for line in and one */</span>
		<span class="cm">/* for MIC. We don&#39;t need to switch the ADC input. */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MIC_BOOST_0DB 0xCF</span>
<span class="cp">#define MIC_BOOST_STEPS_PER_DB 2</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_wm8775_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">input</span><span class="p">,</span> <span class="n">s8</span> <span class="n">gain_in_db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">adcmc</span><span class="p">,</span> <span class="n">gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">input</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">adcmc</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">input</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span> <span class="cm">/* Link L+R gain... */</span>

	<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MAKE_WM8775_ADDR</span><span class="p">(</span><span class="n">WM8775_ADCMC</span><span class="p">,</span> <span class="n">adcmc</span><span class="p">),</span>
				<span class="n">MAKE_WM8775_DATA</span><span class="p">(</span><span class="n">adcmc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gain_in_db</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">103</span><span class="p">)</span>
		<span class="n">gain_in_db</span> <span class="o">=</span> <span class="o">-</span><span class="mi">103</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gain_in_db</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">gain_in_db</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="n">gain</span> <span class="o">=</span> <span class="n">gain_in_db</span> <span class="o">*</span> <span class="n">MIC_BOOST_STEPS_PER_DB</span> <span class="o">+</span> <span class="n">MIC_BOOST_0DB</span><span class="p">;</span>

	<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MAKE_WM8775_ADDR</span><span class="p">(</span><span class="n">WM8775_AADCL</span><span class="p">,</span> <span class="n">gain</span><span class="p">),</span>
				<span class="n">MAKE_WM8775_DATA</span><span class="p">(</span><span class="n">gain</span><span class="p">));</span>
	<span class="cm">/* ...so there should be no need for the following. */</span>
	<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MAKE_WM8775_ADDR</span><span class="p">(</span><span class="n">WM8775_AADCR</span><span class="p">,</span> <span class="n">gain</span><span class="p">),</span>
				<span class="n">MAKE_WM8775_DATA</span><span class="p">(</span><span class="n">gain</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_adc_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">hw_wm8775_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span> <span class="cm">/* Mic, 20dB */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">hw_wm8775_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Line-in, 0dB */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_adc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">adc_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">ctl</span><span class="p">;</span>

	<span class="cm">/*  Set ADC reset bit as output */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Initialize I2C */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw20k2_i2c_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ctxfi: Failure to acquire I2C!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset the ADC (reset is active low). */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set up the PCM4220 ADC on Titanium HD */</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0C</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* Single Speed Mode 32-50kHz */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span> <span class="cm">/* Double Speed Mode 50-108kHz */</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* Quad Speed Mode 108kHz-216kHz */</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* Return the ADC to normal operation. */</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* I2C write to register offset 0x0B to set ADC LRCLK polarity */</span>
	<span class="cm">/* invert bit, interface format to I2S, word length to 24-bit, */</span>
	<span class="cm">/* enable ADC high pass filter. Fixes bug 5323?		*/</span>
	<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MAKE_WM8775_ADDR</span><span class="p">(</span><span class="n">WM8775_IC</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">),</span>
			 <span class="n">MAKE_WM8775_DATA</span><span class="p">(</span><span class="mh">0x26</span><span class="p">));</span>

	<span class="cm">/* Set the master mode (256fs) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* slave mode, 128x oversampling 256fs */</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MAKE_WM8775_ADDR</span><span class="p">(</span><span class="n">WM8775_MMC</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">),</span>
						<span class="n">MAKE_WM8775_DATA</span><span class="p">(</span><span class="mh">0x02</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="mi">2</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="mi">4</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* slave mode, 64x oversampling, 256fs */</span>
		<span class="n">hw20k2_i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MAKE_WM8775_ADDR</span><span class="p">(</span><span class="n">WM8775_MMC</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">),</span>
						<span class="n">MAKE_WM8775_DATA</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;ctxfi: Invalid master sampling &quot;</span>
				  <span class="s">&quot;rate (msr %d)!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Configure GPIO bit 14 change to line-in/mic-in */</span>
		<span class="n">ctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">);</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
		<span class="n">hw_adc_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_LINEIN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_wm8775_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">hw20k2_i2c_uninit</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">capabilities</span> <span class="nf">hw_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">capabilities</span> <span class="n">cap</span><span class="p">;</span>

	<span class="n">cap</span><span class="p">.</span><span class="n">digit_io_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">dedicated_mic</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">;</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">output_switch</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">;</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">mic_source_switch</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_output_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_EXT_DATA</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>:
	     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10</span>:
	     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x20</span>:
	     <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
	     <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_output_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">position</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">position</span> <span class="o">==</span> <span class="n">hw_output_switch_get</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Mute line and headphones (intended for anti-pop). */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_EXT_DATA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_EXT_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Unmute line and headphones. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_mic_source_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="n">hw20k2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">mic_source</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_mic_source_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">position</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="n">hw20k2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">position</span> <span class="o">==</span> <span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">mic_source</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">hw_wm8775_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Mic, 0dB */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hw_wm8775_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* FP Mic, 0dB */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hw_wm8775_input_select</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Aux Ext, 0dB */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">mic_source</span> <span class="o">=</span> <span class="n">position</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ct_20k2_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback_data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIP</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gctl</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set DMA transfer mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">CT_XFI_DMA_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">CT_XFI_DMA_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: architecture does not support PCI &quot;</span>
		<span class="s">&quot;busmaster DMA with mask 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CT_XFI_DMA_MASK</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;XFi&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">,</span>
					<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Switch to 20k2 mode from UAA mode. */</span>
	<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_UAA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ct_20k2_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;XFi: Cannot get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*error3:</span>
<span class="cm">	iounmap((void *)hw-&gt;mem_base);</span>
<span class="cm">	hw-&gt;mem_base = (unsigned long)NULL;*/</span>
<span class="nl">error2:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error1:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* disable transport bus master and queueing of request */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRANSPORT_CTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* disable pll */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_ENB</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLL_ENB</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x07</span><span class="p">)));</span>

	<span class="cm">/* TODO: Disable interrupt and so on... */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">card_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dac_conf</span> <span class="n">dac_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">adc_conf</span> <span class="n">adc_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">daio_conf</span> <span class="n">daio_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">trn_conf</span> <span class="n">trn_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* Get PCI io port/memory base address and</span>
<span class="cm">	 * do 20kx core switch if needed. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_card_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* PLL init */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_pll_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* kick off auto-init */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_auto_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_DBP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_TBP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_FBP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_DPC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GLOBAL_CNTL_GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>

	<span class="cm">/* Reset all global pending interrupts */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Reset all SRC pending interrupts */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_IP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: detect the card ID and configure GPIO accordingly. */</span>
		<span class="cm">/* Configures GPIO (0xD802 0x98028) */</span>
		<span class="cm">/*hw_write_20kx(hw, GPIO_CTRL, 0x7F07);*/</span>
		<span class="cm">/* Configures GPIO (SB0880) */</span>
		<span class="cm">/*hw_write_20kx(hw, GPIO_CTRL, 0xFF07);*/</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="mh">0xD802</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO_CTRL</span><span class="p">,</span> <span class="mh">0x9E5F</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Enable audio ring */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MIXER_AR_ENABLE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="n">trn_info</span><span class="p">.</span><span class="n">vm_pgt_phys</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_trn_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trn_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">daio_info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_daio_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">daio_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dac_info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_dac_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">adc_info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">adc_info</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">ADC_LINEIN</span><span class="p">;</span>
	<span class="n">adc_info</span><span class="p">.</span><span class="n">mic20db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_adc_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adc_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_MCTL</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* Enables input from the audio ring */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRC_MCTL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>

	<span class="n">hw_card_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">card_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* Re-initialize card hardware. */</span>
	<span class="k">return</span> <span class="n">hw_card_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hw_read_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_write_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hw</span> <span class="n">ct20k2_preset</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">card_init</span> <span class="o">=</span> <span class="n">hw_card_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card_stop</span> <span class="o">=</span> <span class="n">hw_card_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_init</span> <span class="o">=</span> <span class="n">hw_pll_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_adc_source_selected</span> <span class="o">=</span> <span class="n">hw_is_adc_input_selected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">select_adc_source</span> <span class="o">=</span> <span class="n">hw_adc_input_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">hw_capabilities</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_switch_get</span> <span class="o">=</span> <span class="n">hw_output_switch_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_switch_put</span> <span class="o">=</span> <span class="n">hw_output_switch_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mic_source_switch_get</span> <span class="o">=</span> <span class="n">hw_mic_source_switch_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mic_source_switch_put</span> <span class="o">=</span> <span class="n">hw_mic_source_switch_put</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">hw_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">hw_resume</span><span class="p">,</span>
<span class="cp">#endif</span>

	<span class="p">.</span><span class="n">src_rsc_get_ctrl_blk</span> <span class="o">=</span> <span class="n">src_get_rsc_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_rsc_put_ctrl_blk</span> <span class="o">=</span> <span class="n">src_put_rsc_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">src_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">src_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_state</span> <span class="o">=</span> <span class="n">src_set_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_bm</span> <span class="o">=</span> <span class="n">src_set_bm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_rsr</span> <span class="o">=</span> <span class="n">src_set_rsr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_sf</span> <span class="o">=</span> <span class="n">src_set_sf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_wr</span> <span class="o">=</span> <span class="n">src_set_wr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_pm</span> <span class="o">=</span> <span class="n">src_set_pm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_rom</span> <span class="o">=</span> <span class="n">src_set_rom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_vo</span> <span class="o">=</span> <span class="n">src_set_vo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_st</span> <span class="o">=</span> <span class="n">src_set_st</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_ie</span> <span class="o">=</span> <span class="n">src_set_ie</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_ilsz</span> <span class="o">=</span> <span class="n">src_set_ilsz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_bp</span> <span class="o">=</span> <span class="n">src_set_bp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_cisz</span> <span class="o">=</span> <span class="n">src_set_cisz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_ca</span> <span class="o">=</span> <span class="n">src_set_ca</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_sa</span> <span class="o">=</span> <span class="n">src_set_sa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_la</span> <span class="o">=</span> <span class="n">src_set_la</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_pitch</span> <span class="o">=</span> <span class="n">src_set_pitch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_dirty</span> <span class="o">=</span> <span class="n">src_set_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_clear_zbufs</span> <span class="o">=</span> <span class="n">src_set_clear_zbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_dirty_all</span> <span class="o">=</span> <span class="n">src_set_dirty_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_commit_write</span> <span class="o">=</span> <span class="n">src_commit_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_get_ca</span> <span class="o">=</span> <span class="n">src_get_ca</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_get_dirty</span> <span class="o">=</span> <span class="n">src_get_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dirty_conj_mask</span> <span class="o">=</span> <span class="n">src_dirty_conj_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_enbs_src</span> <span class="o">=</span> <span class="n">src_mgr_enbs_src</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_enb_src</span> <span class="o">=</span> <span class="n">src_mgr_enb_src</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_dsb_src</span> <span class="o">=</span> <span class="n">src_mgr_dsb_src</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_commit_write</span> <span class="o">=</span> <span class="n">src_mgr_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">srcimp_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">srcimp_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">srcimp_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imaparc</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imaparc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imapuser</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imapuser</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imapnxt</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imapnxt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imapaddr</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imapaddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_commit_write</span> <span class="o">=</span> <span class="n">srcimp_mgr_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">amixer_rsc_get_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_rsc_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_rsc_put_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_rsc_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_mode</span> <span class="o">=</span> <span class="n">amixer_set_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_iv</span> <span class="o">=</span> <span class="n">amixer_set_iv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_x</span> <span class="o">=</span> <span class="n">amixer_set_x</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_y</span> <span class="o">=</span> <span class="n">amixer_set_y</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_sadr</span> <span class="o">=</span> <span class="n">amixer_set_sadr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_se</span> <span class="o">=</span> <span class="n">amixer_set_se</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_dirty</span> <span class="o">=</span> <span class="n">amixer_set_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_dirty_all</span> <span class="o">=</span> <span class="n">amixer_set_dirty_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_commit_write</span> <span class="o">=</span> <span class="n">amixer_commit_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_get_y</span> <span class="o">=</span> <span class="n">amixer_get_y</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_get_dirty</span> <span class="o">=</span> <span class="n">amixer_get_dirty</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dai_get_ctrl_blk</span> <span class="o">=</span> <span class="n">dai_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_put_ctrl_blk</span> <span class="o">=</span> <span class="n">dai_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_srco</span> <span class="o">=</span> <span class="n">dai_srt_set_srco</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_srcm</span> <span class="o">=</span> <span class="n">dai_srt_set_srcm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_rsr</span> <span class="o">=</span> <span class="n">dai_srt_set_rsr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_drat</span> <span class="o">=</span> <span class="n">dai_srt_set_drat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_ec</span> <span class="o">=</span> <span class="n">dai_srt_set_ec</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_et</span> <span class="o">=</span> <span class="n">dai_srt_set_et</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_commit_write</span> <span class="o">=</span> <span class="n">dai_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dao_get_ctrl_blk</span> <span class="o">=</span> <span class="n">dao_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_put_ctrl_blk</span> <span class="o">=</span> <span class="n">dao_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_set_spos</span> <span class="o">=</span> <span class="n">dao_set_spos</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_commit_write</span> <span class="o">=</span> <span class="n">dao_commit_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_get_spos</span> <span class="o">=</span> <span class="n">dao_get_spos</span><span class="p">,</span>

	<span class="p">.</span><span class="n">daio_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">daio_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">daio_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_enb_dai</span> <span class="o">=</span> <span class="n">daio_mgr_enb_dai</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_dsb_dai</span> <span class="o">=</span> <span class="n">daio_mgr_dsb_dai</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_enb_dao</span> <span class="o">=</span> <span class="n">daio_mgr_enb_dao</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_dsb_dao</span> <span class="o">=</span> <span class="n">daio_mgr_dsb_dao</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_dao_init</span> <span class="o">=</span> <span class="n">daio_mgr_dao_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_set_imaparc</span> <span class="o">=</span> <span class="n">daio_mgr_set_imaparc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_set_imapnxt</span> <span class="o">=</span> <span class="n">daio_mgr_set_imapnxt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_set_imapaddr</span> <span class="o">=</span> <span class="n">daio_mgr_set_imapaddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_commit_write</span> <span class="o">=</span> <span class="n">daio_mgr_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_timer_irq</span> <span class="o">=</span> <span class="n">set_timer_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_timer_tick</span> <span class="o">=</span> <span class="n">set_timer_tick</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wc</span> <span class="o">=</span> <span class="n">get_wc</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">create_20k2_hw_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">**</span><span class="n">rhw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k2</span> <span class="o">*</span><span class="n">hw20k2</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rhw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hw20k2</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw20k2</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw20k2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ct20k2_preset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw20k2</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">destroy_20k2_hw_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
		<span class="n">hw_card_shutdown</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
