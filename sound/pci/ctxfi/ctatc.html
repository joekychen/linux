<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ctxfi › ctatc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ctatc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) 2008, Creative Technology Ltd. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This source file is released under GPL v2 license (no other versions).</span>
<span class="cm"> * See the COPYING file included in the main directory of this source</span>
<span class="cm"> * distribution for the license terms and conditions.</span>
<span class="cm"> *</span>
<span class="cm"> * @File    ctatc.c</span>
<span class="cm"> *</span>
<span class="cm"> * @Brief</span>
<span class="cm"> * This file contains the implementation of the device resource management</span>
<span class="cm"> * object.</span>
<span class="cm"> *</span>
<span class="cm"> * @Author Liu Chun</span>
<span class="cm"> * @Date Mar 28 2008</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ctatc.h&quot;</span>
<span class="cp">#include &quot;ctpcm.h&quot;</span>
<span class="cp">#include &quot;ctmixer.h&quot;</span>
<span class="cp">#include &quot;ctsrc.h&quot;</span>
<span class="cp">#include &quot;ctamixer.h&quot;</span>
<span class="cp">#include &quot;ctdaio.h&quot;</span>
<span class="cp">#include &quot;cttimer.h&quot;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>

<span class="cp">#define MONO_SUM_SCALE	0x19a8	</span><span class="cm">/* 2^(-0.5) in 14-bit floating format */</span><span class="cp"></span>
<span class="cp">#define MAX_MULTI_CHN	8</span>

<span class="cp">#define IEC958_DEFAULT_CON ((IEC958_AES0_NONAUDIO \</span>
<span class="cp">			    | IEC958_AES0_CON_NOT_COPYRIGHT) \</span>
<span class="cp">			    | ((IEC958_AES1_CON_MIXER \</span>
<span class="cp">			    | IEC958_AES1_CON_ORIGINAL) &lt;&lt; 8) \</span>
<span class="cp">			    | (0x10 &lt;&lt; 16) \</span>
<span class="cp">			    | ((IEC958_AES3_CON_FS_48000) &lt;&lt; 24))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">__devinitdata</span> <span class="n">subsys_20k1_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="s">&quot;SB055x&quot;</span><span class="p">,</span> <span class="n">CTSB055X</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="mh">0x002f</span><span class="p">,</span> <span class="s">&quot;SB055x&quot;</span><span class="p">,</span> <span class="n">CTSB055X</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="mh">0x0029</span><span class="p">,</span> <span class="s">&quot;SB073x&quot;</span><span class="p">,</span> <span class="n">CTSB073X</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="s">&quot;SB073x&quot;</span><span class="p">,</span> <span class="n">CTSB073X</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_MASK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">,</span>
			   <span class="s">&quot;UAA&quot;</span><span class="p">,</span> <span class="n">CTUAA</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">__devinitdata</span> <span class="n">subsys_20k2_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="n">PCI_SUBDEVICE_ID_CREATIVE_SB0760</span><span class="p">,</span>
		      <span class="s">&quot;SB0760&quot;</span><span class="p">,</span> <span class="n">CTSB0760</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="n">PCI_SUBDEVICE_ID_CREATIVE_SB1270</span><span class="p">,</span>
		      <span class="s">&quot;SB1270&quot;</span><span class="p">,</span> <span class="n">CTSB1270</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="n">PCI_SUBDEVICE_ID_CREATIVE_SB08801</span><span class="p">,</span>
		      <span class="s">&quot;SB0880&quot;</span><span class="p">,</span> <span class="n">CTSB0880</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="n">PCI_SUBDEVICE_ID_CREATIVE_SB08802</span><span class="p">,</span>
		      <span class="s">&quot;SB0880&quot;</span><span class="p">,</span> <span class="n">CTSB0880</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="n">PCI_SUBDEVICE_ID_CREATIVE_SB08803</span><span class="p">,</span>
		      <span class="s">&quot;SB0880&quot;</span><span class="p">,</span> <span class="n">CTSB0880</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK_MASK</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_CREATIVE</span><span class="p">,</span> <span class="mh">0xf000</span><span class="p">,</span>
			   <span class="n">PCI_SUBDEVICE_ID_CREATIVE_HENDRIX</span><span class="p">,</span> <span class="s">&quot;HENDRIX&quot;</span><span class="p">,</span>
			   <span class="n">CTHENDRIX</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ct_subsys_name</span><span class="p">[</span><span class="n">NUM_CTCARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 20k1 models */</span>
	<span class="p">[</span><span class="n">CTSB055X</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SB055x&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CTSB073X</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SB073x&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CTUAA</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;UAA&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CT20K1_UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="cm">/* 20k2 models */</span>
	<span class="p">[</span><span class="n">CTSB0760</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SB076x&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CTHENDRIX</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;Hendrix&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CTSB0880</span><span class="p">]</span>	<span class="o">=</span> <span class="s">&quot;SB0880&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CTSB1270</span><span class="p">]</span>      <span class="o">=</span> <span class="s">&quot;SB1270&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CT20K2_UNKNOWN</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">CTALSADEVS</span> <span class="n">device</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_name</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">alsa_dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">public_name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">alsa_dev_funcs</span><span class="p">[</span><span class="n">NUM_CTALSADEVS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">FRONT</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ct_alsa_pcm_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="s">&quot;Front/WaveIn&quot;</span><span class="p">},</span>
	<span class="p">[</span><span class="n">SURROUND</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ct_alsa_pcm_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="s">&quot;Surround&quot;</span><span class="p">},</span>
	<span class="p">[</span><span class="n">CLFE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ct_alsa_pcm_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="s">&quot;Center/LFE&quot;</span><span class="p">},</span>
	<span class="p">[</span><span class="n">SIDE</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ct_alsa_pcm_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="s">&quot;Side&quot;</span><span class="p">},</span>
	<span class="p">[</span><span class="n">IEC958</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ct_alsa_pcm_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="s">&quot;IEC958 Non-audio&quot;</span><span class="p">},</span>

	<span class="p">[</span><span class="n">MIXER</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ct_alsa_mix_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">public_name</span> <span class="o">=</span> <span class="s">&quot;Mixer&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create_t</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy_t</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">create</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">rmgr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">destroy</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mgr</span><span class="p">);</span>
<span class="p">}</span> <span class="n">rsc_mgr_funcs</span><span class="p">[</span><span class="n">NUM_RSCTYP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">SRC</span><span class="p">]</span> 		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> 	<span class="o">=</span> <span class="p">(</span><span class="n">create_t</span><span class="p">)</span><span class="n">src_mgr_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> 	<span class="o">=</span> <span class="p">(</span><span class="n">destroy_t</span><span class="p">)</span><span class="n">src_mgr_destroy</span>	<span class="p">},</span>
	<span class="p">[</span><span class="n">SRCIMP</span><span class="p">]</span> 	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span> 	<span class="o">=</span> <span class="p">(</span><span class="n">create_t</span><span class="p">)</span><span class="n">srcimp_mgr_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span> 	<span class="o">=</span> <span class="p">(</span><span class="n">destroy_t</span><span class="p">)</span><span class="n">srcimp_mgr_destroy</span>	<span class="p">},</span>
	<span class="p">[</span><span class="n">AMIXER</span><span class="p">]</span>	<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span>	<span class="o">=</span> <span class="p">(</span><span class="n">create_t</span><span class="p">)</span><span class="n">amixer_mgr_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span>	<span class="o">=</span> <span class="p">(</span><span class="n">destroy_t</span><span class="p">)</span><span class="n">amixer_mgr_destroy</span>	<span class="p">},</span>
	<span class="p">[</span><span class="n">SUM</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span>	<span class="o">=</span> <span class="p">(</span><span class="n">create_t</span><span class="p">)</span><span class="n">sum_mgr_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span>	<span class="o">=</span> <span class="p">(</span><span class="n">destroy_t</span><span class="p">)</span><span class="n">sum_mgr_destroy</span>	<span class="p">},</span>
	<span class="p">[</span><span class="n">DAIO</span><span class="p">]</span>		<span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">create</span>	<span class="o">=</span> <span class="p">(</span><span class="n">create_t</span><span class="p">)</span><span class="n">daio_mgr_create</span><span class="p">,</span>
			    <span class="p">.</span><span class="n">destroy</span>	<span class="o">=</span> <span class="p">(</span><span class="n">destroy_t</span><span class="p">)</span><span class="n">daio_mgr_destroy</span>	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">);</span>

<span class="cm">/* *</span>
<span class="cm"> * Only mono and interleaved modes are supported now.</span>
<span class="cm"> * Always allocates a contiguous channel block.</span>
<span class="cm"> * */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ct_map_audio_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_vm</span> <span class="o">*</span><span class="n">vm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">runtime</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">vm</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">;</span>

	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span> <span class="o">=</span> <span class="n">vm</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ct_unmap_audio_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ct_vm</span> <span class="o">*</span><span class="n">vm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vm</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">;</span>

	<span class="n">vm</span><span class="o">-&gt;</span><span class="n">unmap</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="p">);</span>

	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">atc_get_ptp_phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">get_ptp_phys</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">convert_format</span><span class="p">(</span><span class="n">snd_pcm_format_t</span> <span class="n">snd_format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">snd_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U8</span>:
		<span class="k">return</span> <span class="n">SRC_SF_U8</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="k">return</span> <span class="n">SRC_SF_S16</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S24_3LE</span>:
		<span class="k">return</span> <span class="n">SRC_SF_S24</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S32_LE</span>:
		<span class="k">return</span> <span class="n">SRC_SF_S32</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_FLOAT_LE</span>:
		<span class="k">return</span> <span class="n">SRC_SF_F32</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: not recognized snd format is %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">snd_format</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SRC_SF_S16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">atc_get_pitch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input_rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">output_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>

	<span class="cm">/* get pitch and convert to fixed-point 8.24 format. */</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_rate</span> <span class="o">/</span> <span class="n">output_rate</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">input_rate</span> <span class="o">%=</span> <span class="n">output_rate</span><span class="p">;</span>
	<span class="n">input_rate</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">output_rate</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">b</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="p">((</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">input_rate</span> <span class="o">&gt;&gt;</span> <span class="n">b</span><span class="p">));</span> <span class="p">)</span>
		<span class="n">b</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_rate</span> <span class="o">&lt;&lt;=</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">b</span><span class="p">);</span>
		<span class="n">input_rate</span> <span class="o">/=</span> <span class="n">output_rate</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">-</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">input_rate</span> <span class="o">&lt;&lt;=</span> <span class="n">b</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">input_rate</span> <span class="o">&gt;&gt;=</span> <span class="o">-</span><span class="n">b</span><span class="p">;</span>

		<span class="n">pitch</span> <span class="o">|=</span> <span class="n">input_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pitch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">select_rom</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&gt;</span> <span class="mh">0x00428f5c</span> <span class="o">&amp;&amp;</span> <span class="n">pitch</span> <span class="o">&lt;</span> <span class="mh">0x01b851ec</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 0.26 &lt;= pitch &lt;= 1.72 */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">==</span> <span class="mh">0x01d66666</span> <span class="o">||</span> <span class="n">pitch</span> <span class="o">==</span> <span class="mh">0x01d66667</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pitch == 1.8375 */</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">==</span> <span class="mh">0x02000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pitch == 2 */</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;=</span> <span class="mh">0x08000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 0 &lt;= pitch &lt;= 8 */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_pcm_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">amixer_mgr</span> <span class="o">*</span><span class="n">amixer_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">AMIXER</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">src_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">amixer_desc</span> <span class="n">mix_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amixer</span> <span class="o">*</span><span class="n">amixer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">device</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>

	<span class="cm">/* first release old resources */</span>
	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>

	<span class="cm">/* Get SRC resource */</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MEMRD</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">get_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span>
						<span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">));</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rom</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">select_rom</span><span class="p">(</span><span class="n">pitch</span><span class="p">));</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sf</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">convert_format</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">));</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next_interleave</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="cm">/* Get AMIXER resource */</span>
	<span class="n">n_amixer</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_amixer</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">n_amixer</span><span class="p">;</span>
	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">n_amixer</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mix_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_amixer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">amixer_mgr</span><span class="o">-&gt;</span><span class="n">get_amixer</span><span class="p">(</span><span class="n">amixer_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">amixer</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up device virtual mem map */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ct_map_audio_buffer</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="cm">/* Connect resources */</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_amixer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>
		<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">,</span>
					<span class="n">INIT_VOL</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">device</span><span class="o">*</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next_interleave</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ct_timer_prepare</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error1:</span>
	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_pcm_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr</span> <span class="o">*</span><span class="n">srcimp_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRCIMP</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">amixer_mgr</span> <span class="o">*</span><span class="n">amixer_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">AMIXER</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sum_mgr</span> <span class="o">*</span><span class="n">sum_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SUM</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">srcimp</span> <span class="o">*</span><span class="n">srcimp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcimp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srcimp</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">srcimp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap</span><span class="p">(</span><span class="n">srcimp</span><span class="p">);</span>
			<span class="n">srcimp_mgr</span><span class="o">-&gt;</span><span class="n">put_srcimp</span><span class="p">(</span><span class="n">srcimp_mgr</span><span class="p">,</span> <span class="n">srcimp</span><span class="p">);</span>
			<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">);</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">put_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">);</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">amixer_mgr</span><span class="o">-&gt;</span><span class="n">put_amixer</span><span class="p">(</span><span class="n">amixer_mgr</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">);</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">mono</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sum_mgr</span><span class="o">-&gt;</span><span class="n">put_sum</span><span class="p">(</span><span class="n">sum_mgr</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">mono</span><span class="p">);</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">mono</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">put_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Undo device virtual mem map */</span>
		<span class="n">ct_unmap_audio_buffer</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_pcm_playback_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_cisz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">max_cisz</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">multi</span> <span class="o">*</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">.</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">max_cisz</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_cisz</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">max_cisz</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sa</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_la</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_ca</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">max_cisz</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_cisz</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">max_cisz</span><span class="p">);</span>

	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">SRC_STATE_INIT</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

	<span class="n">ct_timer_start</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_pcm_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ct_timer_stop</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">SRC_STATE_OFF</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">SRC_STATE_OFF</span><span class="p">);</span>
			<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_pcm_playback_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_cisz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">position</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">position</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_ca</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">max_cisz</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">multi</span> <span class="o">*</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">.</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">max_cisz</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_cisz</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">max_cisz</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">size</span> <span class="o">-</span> <span class="n">max_cisz</span> <span class="o">-</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">src_node_conf_t</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mix_msr</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">imp_msr</span><span class="o">:</span><span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vo</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_src_node_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">src_node_conf_t</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">n_srcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>

	<span class="cm">/* get pitch and convert to fixed-point 8.24 format. */</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">((</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">),</span>
				<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="o">*</span><span class="n">n_srcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* FIXME: do we really need SRC here if pitch==1 */</span>
		<span class="o">*</span><span class="n">n_srcc</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
		<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">pitch</span><span class="p">;</span>
		<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mix_msr</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imp_msr</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mh">0x8000000</span> <span class="o">&lt;</span> <span class="n">pitch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Need two-stage SRCs, SRCIMPs and</span>
<span class="cm">			 * AMIXERs for converting format */</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">msr</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mix_msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imp_msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">,</span>
					<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">msr</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mix_msr</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">imp_msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">vo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">n_srcc</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x1000000</span> <span class="o">&lt;</span> <span class="n">pitch</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Need one-stage SRCs, SRCIMPs and</span>
<span class="cm">			 * AMIXERs for converting format */</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">pitch</span><span class="p">;</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">msr</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mix_msr</span>
				    <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imp_msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
			<span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">vo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">n_srcc</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_pcm_capture_get_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr</span> <span class="o">*</span><span class="n">srcimp_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRCIMP</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">amixer_mgr</span> <span class="o">*</span><span class="n">amixer_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">AMIXER</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sum_mgr</span> <span class="o">*</span><span class="n">sum_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SUM</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">src_desc</span> <span class="n">src_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srcimp_desc</span> <span class="n">srcimp_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">srcimp</span> <span class="o">*</span><span class="n">srcimp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amixer_desc</span> <span class="n">mix_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">sum_desc</span> <span class="n">sum_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">multi</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_srcimp</span><span class="p">,</span> <span class="n">n_amixer</span><span class="p">,</span> <span class="n">n_srcc</span><span class="p">,</span> <span class="n">n_sum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src_node_conf_t</span> <span class="n">src_node_conf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">0</span><span class="p">}</span> <span class="p">};</span>

	<span class="cm">/* first release old resources */</span>
	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>

	<span class="cm">/* The numbers of converting SRCs and SRCIMPs should be determined</span>
<span class="cm">	 * by pitch value. */</span>

	<span class="n">multi</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="cm">/* get pitch and convert to fixed-point 8.24 format. */</span>
	<span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">((</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">),</span>
				<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="n">setup_src_node_conf</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">,</span> <span class="n">src_node_conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n_srcc</span><span class="p">);</span>
	<span class="n">n_sum</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">multi</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">n_amixer</span> <span class="o">=</span> <span class="n">n_sum</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">n_srcc</span><span class="p">;</span>
	<span class="n">n_srcimp</span> <span class="o">=</span> <span class="n">n_srcc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">multi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x8000000</span> <span class="o">&gt;=</span> <span class="n">pitch</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Need extra AMIXERs and SRCIMPs for special treatment</span>
<span class="cm">		 * of interleaved recording of conjugate channels */</span>
		<span class="n">n_amixer</span> <span class="o">+=</span> <span class="n">multi</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
		<span class="n">n_srcimp</span> <span class="o">+=</span> <span class="n">multi</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">n_srcimp</span> <span class="o">+=</span> <span class="n">multi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_srcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">n_srcc</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_amixer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">n_amixer</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">n_srcimp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate SRCs for sample rate conversion if needed */</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">multi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ARCRW</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_srcc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">src_node_conf</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">multi</span><span class="p">].</span><span class="n">msr</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">get_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">pitch</span> <span class="o">=</span> <span class="n">src_node_conf</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">multi</span><span class="p">].</span><span class="n">pitch</span><span class="p">;</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rom</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">select_rom</span><span class="p">(</span><span class="n">pitch</span><span class="p">));</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_vo</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">src_node_conf</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">multi</span><span class="p">].</span><span class="n">vo</span><span class="p">);</span>

		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate AMIXERs for routing SRCs of conversion if needed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_amixer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_sum</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
			<span class="n">mix_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_sum</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">n_srcc</span><span class="p">))</span>
			<span class="n">mix_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">src_node_conf</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="n">n_sum</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">multi</span><span class="p">].</span><span class="n">mix_msr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mix_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">amixer_mgr</span><span class="o">-&gt;</span><span class="n">get_amixer</span><span class="p">(</span><span class="n">amixer_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">amixer</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a SUM resource to mix all input channels together */</span>
	<span class="n">sum_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">sum_mgr</span><span class="o">-&gt;</span><span class="n">get_sum</span><span class="p">(</span><span class="n">sum_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sum_dsc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sum</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">mono</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">((</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">),</span>
				<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="cm">/* Allocate SRCIMP resources */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcimp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_srcimp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_srcc</span><span class="p">))</span>
			<span class="n">srcimp_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">src_node_conf</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="n">multi</span><span class="p">].</span><span class="n">imp_msr</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">multi</span><span class="p">)</span>
			<span class="n">srcimp_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;=</span> <span class="mh">0x8000000</span><span class="p">)</span> <span class="o">?</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">srcimp_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">srcimp_mgr</span><span class="o">-&gt;</span><span class="n">get_srcimp</span><span class="p">(</span><span class="n">srcimp_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srcimp_dsc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srcimp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">srcimp</span><span class="p">;</span>
		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcimp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a SRC for writing data to host memory */</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MEMWR</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">get_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_dsc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>

	<span class="cm">/* Set up device virtual mem map */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ct_map_audio_buffer</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error1:</span>
	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_pcm_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amixer</span> <span class="o">*</span><span class="n">amixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srcimp</span> <span class="o">*</span><span class="n">srcimp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sum</span> <span class="o">*</span><span class="n">mono</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsc</span> <span class="o">*</span><span class="n">out_ports</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n_sum</span><span class="p">,</span> <span class="n">multi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mix_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">imp_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>

	<span class="cm">/* Get needed resources. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_pcm_capture_get_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Connect resources */</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_output_ports</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_PCMO_FRONT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">out_ports</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">out_ports</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">multi</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">multi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mono</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">mono</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">MONO_SUM_SCALE</span><span class="p">,</span> <span class="n">mono</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">out_ports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mono</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">;</span>
		<span class="n">n_sum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mix_base</span> <span class="o">=</span> <span class="n">n_sum</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">srcimp</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">imp_base</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
		<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">mix_base</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
		<span class="n">srcimp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">srcimp</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">multi</span><span class="p">]);</span>
		<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">,</span> <span class="n">INIT_VOL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="n">multi</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">amixer</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">((</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">),</span>
				<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">multi</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pitch</span> <span class="o">&lt;=</span> <span class="mh">0x8000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Special connection for interleaved</span>
<span class="cm">		 * recording with conjugate channels */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">multi</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">(</span><span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">multi</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
				<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_input</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_scale</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="n">INIT_VOL</span><span class="p">);</span>
				<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sum</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_raw_write</span><span class="p">(</span><span class="n">amixer</span><span class="p">);</span>
				<span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next_conj</span><span class="p">(</span><span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

				<span class="n">srcimp</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">multi</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
				<span class="n">srcimp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">srcimp</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">amixer</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">multi</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srcimp</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="o">+</span><span class="n">i</span><span class="p">];</span>
			<span class="n">srcimp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">srcimp</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">,</span> <span class="n">out_ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ct_timer_prepare</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_pcm_capture_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">multi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">multi</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="cm">/* Set up converting SRCs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">((</span><span class="n">i</span><span class="o">%</span><span class="n">multi</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">multi</span><span class="o">-</span><span class="mi">1</span><span class="p">)));</span>
		<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">src_disable</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*  Set up recording SRC */</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sf</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">convert_format</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">));</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sa</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_la</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_ca</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">src_disable</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="cm">/* Disable relevant SRCs firstly */</span>
	<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">);</span>

	<span class="cm">/* Enable SRCs respectively */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_srcc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">srccs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">SRC_STATE_RUN</span><span class="p">);</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">src_enable_s</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">SRC_STATE_RUN</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
	<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">src_enable_s</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="cm">/* Enable relevant SRCs synchronously */</span>
	<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">);</span>

	<span class="n">ct_timer_start</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_pcm_capture_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_ca</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">-</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">vm_block</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">spdif_passthru_playback_get_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span>
						 <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">amixer_mgr</span> <span class="o">*</span><span class="n">amixer_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">AMIXER</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">src_desc</span> <span class="n">desc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">amixer_desc</span> <span class="n">mix_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">rsr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pll_rate</span><span class="p">;</span>

	<span class="cm">/* first release old resources */</span>
	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>

	<span class="cm">/* Get SRC resource */</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">desc</span><span class="p">.</span><span class="n">msr</span><span class="p">))</span>
		<span class="n">desc</span><span class="p">.</span><span class="n">msr</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">desc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MEMRD</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">get_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">pitch</span> <span class="o">=</span> <span class="n">atc_get_pitch</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="p">(</span><span class="n">rsr</span> <span class="o">*</span> <span class="n">desc</span><span class="p">.</span><span class="n">msr</span><span class="p">));</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pitch</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rom</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">select_rom</span><span class="p">(</span><span class="n">pitch</span><span class="p">));</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_sf</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">convert_format</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">));</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next_interleave</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_bp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Get AMIXER resource */</span>
	<span class="n">n_amixer</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_amixer</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">n_amixer</span><span class="p">;</span>
	<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">n_amixer</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mix_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">msr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_amixer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">amixer_mgr</span><span class="o">-&gt;</span><span class="n">get_amixer</span><span class="p">(</span><span class="n">amixer_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mix_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">amixer</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up device virtual mem map */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ct_map_audio_buffer</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error1:</span>
	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pll_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">pll_rate</span> <span class="o">=</span> <span class="n">err</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spdif_passthru_playback_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">SPDIFOO</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iec958_con_fs</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">iec958_con_fs</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">iec958_con_fs</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_44100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">iec958_con_fs</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_32000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>
	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_spos</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">)</span> <span class="o">!=</span> <span class="n">iec958_con_fs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">IEC958_AES3_CON_FS</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">iec958_con_fs</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_spos</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">dao</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pll_rate</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mi">32000</span> <span class="o">!=</span> <span class="n">rate</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">atc_pll_init</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">spdif_passthru_playback_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ct_atc_pcm</span> <span class="o">*</span><span class="n">apcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amixer</span> <span class="o">*</span><span class="n">amixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">atc_pcm_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>

	<span class="cm">/* Configure SPDIFOO and PLL to passthrough mode;</span>
<span class="cm">	 * determine pll_rate. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">spdif_passthru_playback_setup</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Get needed resources. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">spdif_passthru_playback_get_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">apcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Connect resources */</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">n_amixer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">amixer</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">(</span><span class="n">amixer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">,</span> <span class="n">INIT_VOL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next_interleave</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Connect to SPDIFOO */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>
	<span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">SPDIFOO</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
	<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_left_input</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amixer</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="n">amixer</span> <span class="o">=</span> <span class="n">apcm</span><span class="o">-&gt;</span><span class="n">amixers</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_right_input</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amixer</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>

	<span class="n">ct_timer_prepare</span><span class="p">(</span><span class="n">apcm</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_select_line_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">is_adc_source_selected</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_LINEIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">select_adc_source</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_LINEIN</span><span class="p">);</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_select_mic_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">is_adc_source_selected</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_MICIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">select_adc_source</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_MICIN</span><span class="p">);</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">capabilities</span> <span class="nf">atc_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_output_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">output_switch_get</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_output_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">position</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">output_switch_put</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_mic_source_switch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mic_source_switch_get</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_mic_source_switch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">position</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">mic_source_switch_put</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_select_digit_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">is_adc_source_selected</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_NONE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">select_adc_source</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ADC_NONE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_daio_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr</span> <span class="o">*</span><span class="n">daio_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">DAIO</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span>
		<span class="n">daio_mgr</span><span class="o">-&gt;</span><span class="n">daio_enable</span><span class="p">(</span><span class="n">daio_mgr</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">daio_mgr</span><span class="o">-&gt;</span><span class="n">daio_disable</span><span class="p">(</span><span class="n">daio_mgr</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>

	<span class="n">daio_mgr</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">daio_mgr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_dao_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_spos</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">atc_dao_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">type</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>

	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_spos</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">dao</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_line_front_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">LINEO1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_line_surround_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">LINEO2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_line_clfe_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">LINEO3</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_line_rear_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">LINEO4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_line_in_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">LINEIM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_mic_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">MIC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_spdif_out_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">SPDIFOO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_spdif_in_unmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_daio_unmute</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">SPDIFIO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_spdif_out_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_dao_get_status</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">SPDIFOO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_spdif_out_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atc_dao_set_status</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">SPDIFOO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_spdif_out_passthru</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao_desc</span> <span class="n">da_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsc</span> <span class="o">*</span><span class="n">rscs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>
	<span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">SPDIFOO</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
	<span class="n">da_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">state</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">da_dsc</span><span class="p">.</span><span class="n">passthru</span> <span class="o">=</span> <span class="n">state</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">reinit</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da_dsc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spos</span> <span class="o">=</span> <span class="n">IEC958_DEFAULT_CON</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_output_ports</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_SPDIF_OUT</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rscs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rscs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_left_input</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">rscs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_right_input</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">rscs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="cm">/* Restore PLL to atc-&gt;rsr if needed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pll_rate</span> <span class="o">!=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">atc_pll_init</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_spos</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">spos</span><span class="p">);</span>
	<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">dao</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_release_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">daio_mgr</span> <span class="o">*</span><span class="n">daio_mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dai</span> <span class="o">*</span><span class="n">dai</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">daio</span> <span class="o">*</span><span class="n">daio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sum_mgr</span> <span class="o">*</span><span class="n">sum_mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr</span> <span class="o">*</span><span class="n">srcimp_mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srcimp</span> <span class="o">*</span><span class="n">srcimp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* disconnect internal mixer objects */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_SPDIF_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_SPDIF_IN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">daio_mgr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">daio_mgr</span> <span class="o">*</span><span class="p">)</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">DAIO</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_daio</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">daio</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">daio</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">LINEIM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">daio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
				<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">clear_left_input</span><span class="p">(</span><span class="n">dao</span><span class="p">);</span>
				<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">clear_right_input</span><span class="p">(</span><span class="n">dao</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dai</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">daio</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dai</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
				<span class="cm">/* some thing to do for dai ... */</span>
			<span class="p">}</span>
			<span class="n">daio_mgr</span><span class="o">-&gt;</span><span class="n">put_daio</span><span class="p">(</span><span class="n">daio_mgr</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">);</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sum_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SUM</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_pcm</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sum_mgr</span><span class="o">-&gt;</span><span class="n">put_sum</span><span class="p">(</span><span class="n">sum_mgr</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_src</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">put_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">);</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">srcimp_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRCIMP</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_srcimp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">srcimp</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">srcimp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">unmap</span><span class="p">(</span><span class="n">srcimp</span><span class="p">);</span>
			<span class="n">srcimp_mgr</span><span class="o">-&gt;</span><span class="n">put_srcimp</span><span class="p">(</span><span class="n">srcimp_mgr</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">);</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ct_atc_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ct_timer_free</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atc_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>

	<span class="cm">/* Destroy internal mixer objects */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">)</span>
		<span class="n">ct_mixer_destroy</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RSCTYP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsc_mgr_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">destroy</span> <span class="o">&amp;&amp;</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">rsc_mgr_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">destroy</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span>
		<span class="n">destroy_hw_obj</span><span class="p">((</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="p">)</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Destroy device virtual memory manager object */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ct_vm_destroy</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">);</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ct_atc_destroy</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atc_identify_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATC20K1</span>:
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;20K1&quot;</span><span class="p">;</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">subsys_20k1_list</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATC20K2</span>:
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_name</span> <span class="o">=</span> <span class="s">&quot;20K2&quot;</span><span class="p">;</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">subsys_20k2_list</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vendor_id</span> <span class="o">=</span> <span class="n">ssid</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">device_id</span> <span class="o">=</span> <span class="n">ssid</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vendor_id</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
		<span class="n">device_id</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup_id</span><span class="p">(</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: &quot;</span>
			       <span class="s">&quot;Device %04x:%04x is black-listed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">==</span> <span class="n">ATC20K1</span><span class="p">)</span>
			<span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">CT20K1_UNKNOWN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">CT20K2_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">ct_subsys_name</span><span class="p">[</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">];</span>
	<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;ctxfi: chip %s model %s (%04x:%04x) is found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span>
		   <span class="n">vendor_id</span><span class="p">,</span> <span class="n">device_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ct_atc_create_alsa_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">CTALSADEVS</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">alsa_dev_funcs</span><span class="p">[</span><span class="n">MIXER</span><span class="p">].</span><span class="n">public_name</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_name</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CTALSADEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alsa_dev_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">create</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">alsa_dev_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">create</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">alsa_dev_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">public_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: &quot;</span>
			       <span class="s">&quot;Creating alsa device %d failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">atc_create_hw_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">card_conf</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_hw_obj</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_type</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to create hw obj!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* Initialize card hardware. */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">rsr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">vm_pgt_phys</span> <span class="o">=</span> <span class="n">atc_get_ptp_phys</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">card_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RSCTYP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsc_mgr_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">create</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rsc_mgr_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">create</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: &quot;</span>
			       <span class="s">&quot;Failed to create rsc_mgr %d!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_get_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_desc</span> <span class="n">da_desc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">daio_mgr</span> <span class="o">*</span><span class="n">daio_mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src_desc</span> <span class="n">src_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srcimp_desc</span> <span class="n">srcimp_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr</span> <span class="o">*</span><span class="n">srcimp_mgr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sum_desc</span> <span class="n">sum_dsc</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">sum_mgr</span> <span class="o">*</span><span class="n">sum_mgr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_srcs</span><span class="p">,</span> <span class="n">num_daios</span><span class="p">;</span>

	<span class="n">num_daios</span> <span class="o">=</span> <span class="p">((</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">num_srcs</span> <span class="o">=</span> <span class="p">((</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">num_daios</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">num_srcs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">num_srcs</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">daio_mgr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">daio_mgr</span> <span class="o">*</span><span class="p">)</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">DAIO</span><span class="p">];</span>
	<span class="n">da_desc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_daio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_daios</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">da_desc</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">!=</span> <span class="n">CTSB073X</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span>
			     <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="n">SPDIFIO</span><span class="p">)</span> <span class="o">?</span> <span class="n">SPDIFI1</span> <span class="o">:</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">daio_mgr</span><span class="o">-&gt;</span><span class="n">get_daio</span><span class="p">(</span><span class="n">daio_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">da_desc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">daio</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: Failed to get DAIO &quot;</span>
					<span class="s">&quot;resource %d!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_daio</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">src_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">];</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">multi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">src_dsc</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">ARCRW</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_srcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">get_src</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_src</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">srcimp_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRCIMP</span><span class="p">];</span>
	<span class="n">srcimp_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_srcimp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_srcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">srcimp_mgr</span><span class="o">-&gt;</span><span class="n">get_srcimp</span><span class="p">(</span><span class="n">srcimp_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srcimp_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">srcimp</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_srcimp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sum_mgr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SUM</span><span class="p">];</span>
	<span class="n">sum_dsc</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_pcm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">sum_mgr</span><span class="o">-&gt;</span><span class="n">get_sum</span><span class="p">(</span><span class="n">sum_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sum_dsc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">sum</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">atc</span><span class="o">-&gt;</span><span class="n">n_pcm</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">atc_connect_dai</span><span class="p">(</span><span class="k">struct</span> <span class="n">src_mgr</span> <span class="o">*</span><span class="n">src_mgr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="n">srcs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">srcimp</span> <span class="o">**</span><span class="n">srcimps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rsc</span> <span class="o">*</span><span class="n">rscs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">srcimp</span> <span class="o">*</span><span class="n">srcimp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rscs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">daio</span><span class="p">.</span><span class="n">rscl</span><span class="p">;</span>
	<span class="n">rscs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dai</span><span class="o">-&gt;</span><span class="n">daio</span><span class="p">.</span><span class="n">rscr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">srcimp</span> <span class="o">=</span> <span class="n">srcimps</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">srcimp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">srcimp</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">rscs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">src_disable</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">);</span> <span class="cm">/* Actually disable SRCs */</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_pm</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">srcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_state</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">SRC_STATE_RUN</span><span class="p">);</span>
		<span class="n">src</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
		<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">src_enable_s</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_srt_srcl</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">));</span>
	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_srt_srcr</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">srcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">));</span>

	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_enb_src</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_enb_srt</span><span class="p">(</span><span class="n">dai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dai</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">dai</span><span class="p">);</span>

	<span class="n">src_mgr</span><span class="o">-&gt;</span><span class="n">commit_write</span><span class="p">(</span><span class="n">src_mgr</span><span class="p">);</span> <span class="cm">/* Synchronously enable SRCs */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atc_connect_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai</span> <span class="o">*</span><span class="n">dai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dao</span> <span class="o">*</span><span class="n">dao</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">src</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sum</span> <span class="o">*</span><span class="n">sum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rsc</span> <span class="o">*</span><span class="n">rscs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MIX_WAVE_FRONT</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">LINEO1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MIX_SPDIF_OUT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">get_output_ports</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rscs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rscs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">dao</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dao</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
		<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_left_input</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">rscs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">dao</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_right_input</span><span class="p">(</span><span class="n">dao</span><span class="p">,</span> <span class="n">rscs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">dai</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">LINEIM</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dai</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
	<span class="n">atc_connect_dai</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">],</span> <span class="n">dai</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">srcimp</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_LINE_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB1270</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Titanium HD has a dedicated ADC for the Mic. */</span>
		<span class="n">dai</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">MIC</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dai</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
		<span class="n">atc_connect_dai</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">],</span> <span class="n">dai</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">srcimp</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_MIC_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dai</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">daios</span><span class="p">[</span><span class="n">SPDIFIO</span><span class="p">],</span> <span class="k">struct</span> <span class="n">dai</span><span class="p">,</span> <span class="n">daio</span><span class="p">);</span>
	<span class="n">atc_connect_dai</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsc_mgrs</span><span class="p">[</span><span class="n">SRC</span><span class="p">],</span> <span class="n">dai</span><span class="p">,</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">src</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">srcimp</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcimps</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_SPDIF_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">srcs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">MIX_SPDIF_IN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MIX_PCMI_FRONT</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">MIX_PCMI_SURROUND</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sum</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_left</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sum</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
		<span class="n">sum</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">set_input_right</span><span class="p">(</span><span class="n">mixer</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sum</span><span class="o">-&gt;</span><span class="n">rsc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">FRONT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_PCMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">atc_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_hw_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">card_conf</span> <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* Re-initialize card hardware. */</span>
	<span class="n">info</span><span class="p">.</span><span class="n">rsr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">vm_pgt_phys</span> <span class="o">=</span> <span class="n">atc_get_ptp_phys</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_resources_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">*</span><span class="n">mixer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get resources */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_get_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atc_release_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Build topology */</span>
	<span class="n">atc_connect_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>

	<span class="n">mixer</span> <span class="o">=</span> <span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">;</span>
	<span class="n">mixer</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">mixer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Do hardware resume. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_hw_resume</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_resources_resume</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ct_atc</span> <span class="n">atc_preset</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">map_audio_buffer</span> <span class="o">=</span> <span class="n">ct_map_audio_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unmap_audio_buffer</span> <span class="o">=</span> <span class="n">ct_unmap_audio_buffer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_playback_prepare</span> <span class="o">=</span> <span class="n">atc_pcm_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_release_resources</span> <span class="o">=</span> <span class="n">atc_pcm_release_resources</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_playback_start</span> <span class="o">=</span> <span class="n">atc_pcm_playback_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_playback_stop</span> <span class="o">=</span> <span class="n">atc_pcm_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_playback_position</span> <span class="o">=</span> <span class="n">atc_pcm_playback_position</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_capture_prepare</span> <span class="o">=</span> <span class="n">atc_pcm_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_capture_start</span> <span class="o">=</span> <span class="n">atc_pcm_capture_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_capture_stop</span> <span class="o">=</span> <span class="n">atc_pcm_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pcm_capture_position</span> <span class="o">=</span> <span class="n">atc_pcm_capture_position</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spdif_passthru_playback_prepare</span> <span class="o">=</span> <span class="n">spdif_passthru_playback_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ptp_phys</span> <span class="o">=</span> <span class="n">atc_get_ptp_phys</span><span class="p">,</span>
	<span class="p">.</span><span class="n">select_line_in</span> <span class="o">=</span> <span class="n">atc_select_line_in</span><span class="p">,</span>
	<span class="p">.</span><span class="n">select_mic_in</span> <span class="o">=</span> <span class="n">atc_select_mic_in</span><span class="p">,</span>
	<span class="p">.</span><span class="n">select_digit_io</span> <span class="o">=</span> <span class="n">atc_select_digit_io</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_front_unmute</span> <span class="o">=</span> <span class="n">atc_line_front_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_surround_unmute</span> <span class="o">=</span> <span class="n">atc_line_surround_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_clfe_unmute</span> <span class="o">=</span> <span class="n">atc_line_clfe_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_rear_unmute</span> <span class="o">=</span> <span class="n">atc_line_rear_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_in_unmute</span> <span class="o">=</span> <span class="n">atc_line_in_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mic_unmute</span> <span class="o">=</span> <span class="n">atc_mic_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spdif_out_unmute</span> <span class="o">=</span> <span class="n">atc_spdif_out_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spdif_in_unmute</span> <span class="o">=</span> <span class="n">atc_spdif_in_unmute</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spdif_out_get_status</span> <span class="o">=</span> <span class="n">atc_spdif_out_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spdif_out_set_status</span> <span class="o">=</span> <span class="n">atc_spdif_out_set_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">spdif_out_passthru</span> <span class="o">=</span> <span class="n">atc_spdif_out_passthru</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">atc_capabilities</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_switch_get</span> <span class="o">=</span> <span class="n">atc_output_switch_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">output_switch_put</span> <span class="o">=</span> <span class="n">atc_output_switch_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mic_source_switch_get</span> <span class="o">=</span> <span class="n">atc_mic_source_switch_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mic_source_switch_put</span> <span class="o">=</span> <span class="n">atc_mic_source_switch_put</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">atc_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">atc_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *  ct_atc_create - create and initialize a hardware manager</span>
<span class="cm"> *  @card: corresponding alsa card object</span>
<span class="cm"> *  @pci: corresponding kernel pci device object</span>
<span class="cm"> *  @ratc: return created object address in it</span>
<span class="cm"> *</span>
<span class="cm"> *  Creates and initializes a hardware manager.</span>
<span class="cm"> *</span>
<span class="cm"> *  Creates kmallocated ct_atc structure. Initializes hardware.</span>
<span class="cm"> *  Returns 0 if succeeds, or negative error code if fails.</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ct_atc_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">chip_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ssid</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">**</span><span class="n">ratc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ct_atc</span> <span class="o">*</span><span class="n">atc</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">atc_dev_free</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ratc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">atc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">atc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Set operations */</span>
	<span class="o">*</span><span class="n">atc</span> <span class="o">=</span> <span class="n">atc_preset</span><span class="p">;</span>

	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">rsr</span> <span class="o">=</span> <span class="n">rsr</span><span class="p">;</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">msr</span> <span class="o">=</span> <span class="n">msr</span><span class="p">;</span>
	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">chip_type</span> <span class="o">=</span> <span class="n">chip_type</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">atc_mutex</span><span class="p">);</span>

	<span class="cm">/* Find card model */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_identify_card</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="n">ssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctatc: Card not recognised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up device virtual memory management object */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ct_vm_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">,</span> <span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="cm">/* Create all atc hw devices */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_create_hw_devs</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ct_mixer_create</span><span class="p">(</span><span class="n">atc</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ct_mixer</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: Failed to create mixer obj!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get resources */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">atc_get_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="cm">/* Build topology */</span>
	<span class="n">atc_connect_resources</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>

	<span class="n">atc</span><span class="o">-&gt;</span><span class="n">timer</span> <span class="o">=</span> <span class="n">ct_timer_new</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atc</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">atc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ratc</span> <span class="o">=</span> <span class="n">atc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error1:</span>
	<span class="n">ct_atc_destroy</span><span class="p">(</span><span class="n">atc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ctxfi: Something wrong!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
