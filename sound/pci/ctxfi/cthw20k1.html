<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › ctxfi › cthw20k1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cthw20k1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * Copyright (C) 2008, Creative Technology Ltd. All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This source file is released under GPL v2 license (no other versions).</span>
<span class="cm"> * See the COPYING file included in the main directory of this source</span>
<span class="cm"> * distribution for the license terms and conditions.</span>
<span class="cm"> *</span>
<span class="cm"> * @File	cthw20k1.c</span>
<span class="cm"> *</span>
<span class="cm"> * @Brief</span>
<span class="cm"> * This file contains the implementation of hardware access methord for 20k1.</span>
<span class="cm"> *</span>
<span class="cm"> * @Author	Liu Chun</span>
<span class="cm"> * @Date 	Jun 24 2008</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;cthw20k1.h&quot;</span>
<span class="cp">#include &quot;ct20k1reg.h&quot;</span>

<span class="cp">#if BITS_PER_LONG == 32</span>
<span class="cp">#define CT_XFI_DMA_MASK		DMA_BIT_MASK(32) </span><span class="cm">/* 32 bit PTE */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define CT_XFI_DMA_MASK		DMA_BIT_MASK(64) </span><span class="cm">/* 64 bit PTE */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">hw20k1</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">reg_20k1_lock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">reg_pci_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hw_write_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hw_write_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Type definition block.</span>
<span class="cm"> * The layout of control structures can be directly applied on 20k2 chip.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * SRC control block definitions.</span>
<span class="cm"> */</span>

<span class="cm">/* SRC resource control block */</span>
<span class="cp">#define SRCCTL_STATE	0x00000007</span>
<span class="cp">#define SRCCTL_BM	0x00000008</span>
<span class="cp">#define SRCCTL_RSR	0x00000030</span>
<span class="cp">#define SRCCTL_SF	0x000001C0</span>
<span class="cp">#define SRCCTL_WR	0x00000200</span>
<span class="cp">#define SRCCTL_PM	0x00000400</span>
<span class="cp">#define SRCCTL_ROM	0x00001800</span>
<span class="cp">#define SRCCTL_VO	0x00002000</span>
<span class="cp">#define SRCCTL_ST	0x00004000</span>
<span class="cp">#define SRCCTL_IE	0x00008000</span>
<span class="cp">#define SRCCTL_ILSZ	0x000F0000</span>
<span class="cp">#define SRCCTL_BP	0x00100000</span>

<span class="cp">#define SRCCCR_CISZ	0x000007FF</span>
<span class="cp">#define SRCCCR_CWA	0x001FF800</span>
<span class="cp">#define SRCCCR_D	0x00200000</span>
<span class="cp">#define SRCCCR_RS	0x01C00000</span>
<span class="cp">#define SRCCCR_NAL	0x3E000000</span>
<span class="cp">#define SRCCCR_RA	0xC0000000</span>

<span class="cp">#define SRCCA_CA	0x03FFFFFF</span>
<span class="cp">#define SRCCA_RS	0x1C000000</span>
<span class="cp">#define SRCCA_NAL	0xE0000000</span>

<span class="cp">#define SRCSA_SA	0x03FFFFFF</span>

<span class="cp">#define SRCLA_LA	0x03FFFFFF</span>

<span class="cm">/* Mixer Parameter Ring ram Low and Hight register.</span>
<span class="cm"> * Fixed-point value in 8.24 format for parameter channel */</span>
<span class="cp">#define MPRLH_PITCH	0xFFFFFFFF</span>

<span class="cm">/* SRC resource register dirty flags */</span>
<span class="k">union</span> <span class="n">src_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ctl</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ccr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">sa</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">la</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">ca</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">mpr</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">czbfs</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Clear Z-Buffers */</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> 	<span class="n">ccr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ca</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">sa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">la</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">mpr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">src_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SRC manager control block */</span>
<span class="k">union</span> <span class="n">src_mgr_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">enb0</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb1</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb2</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb3</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb4</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb5</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb6</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enb7</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">enbsa</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">enbsa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">enb</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">union</span> <span class="n">src_mgr_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SRCIMP manager control block */</span>
<span class="cp">#define SRCAIM_ARC	0x00000FFF</span>
<span class="cp">#define SRCAIM_NXT	0x00FF0000</span>
<span class="cp">#define SRCAIM_SRC	0xFF000000</span>

<span class="k">struct</span> <span class="n">srcimap</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">srcaim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SRCIMP manager register dirty flags */</span>
<span class="k">union</span> <span class="n">srcimp_mgr_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">srcimap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimap</span>		<span class="n">srcimap</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">srcimp_mgr_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Function implementation block.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_get_rsc_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_put_rsc_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_state</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_STATE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_bm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_BM</span><span class="p">,</span> <span class="n">bm</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_rsr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_RSR</span><span class="p">,</span> <span class="n">rsr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_sf</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_SF</span><span class="p">,</span> <span class="n">sf</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_wr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_WR</span><span class="p">,</span> <span class="n">wr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_pm</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_PM</span><span class="p">,</span> <span class="n">pm</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_rom</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_ROM</span><span class="p">,</span> <span class="n">rom</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_vo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_VO</span><span class="p">,</span> <span class="n">vo</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_st</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_ST</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_ie</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_IE</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_ilsz</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ilsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_ILSZ</span><span class="p">,</span> <span class="n">ilsz</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_bp</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">SRCCTL_BP</span><span class="p">,</span> <span class="n">bp</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_cisz</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cisz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">,</span> <span class="n">SRCCCR_CISZ</span><span class="p">,</span> <span class="n">cisz</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_ca</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ca</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">SRCCA_CA</span><span class="p">,</span> <span class="n">ca</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_sa</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">SRCSA_SA</span><span class="p">,</span> <span class="n">sa</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">sa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_la</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">la</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">la</span><span class="p">,</span> <span class="n">SRCLA_LA</span><span class="p">,</span> <span class="n">la</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">la</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_pitch</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pitch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">mpr</span><span class="p">,</span> <span class="n">MPRLH_PITCH</span><span class="p">,</span> <span class="n">pitch</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">mpr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_clear_zbufs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">czbfs</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_set_dirty_all</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AR_SLOT_SIZE		4096</span>
<span class="cp">#define AR_SLOT_BLOCK_SIZE	16</span>
<span class="cp">#define AR_PTS_PITCH		6</span>
<span class="cp">#define AR_PARAM_SRC_OFFSET	0x60</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">src_param_pitch_mixer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">src_idx</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">AR_PTS_PITCH</span> <span class="o">+</span> <span class="n">AR_SLOT_SIZE</span>
			<span class="o">-</span> <span class="n">AR_PARAM_SRC_OFFSET</span><span class="p">)</span> <span class="o">%</span> <span class="n">AR_SLOT_SIZE</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">czbfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear Z-Buffer registers */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCUPZ</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCDN0Z</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCDN1Z</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mh">0x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">czbfs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">mpr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Take the parameter mixer resource in the same group as that</span>
<span class="cm">		 * the idx src is in for simplicity. Unlike src, all conjugate</span>
<span class="cm">		 * parameter mixer resources must be programmed for</span>
<span class="cm">		 * corresponding conjugate src resources. */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm_idx</span> <span class="o">=</span> <span class="n">src_param_pitch_mixer</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PRING_LO_HI</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">pm_idx</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">mpr</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PMOPLO</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">pm_idx</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PMOPHI</span><span class="o">+</span><span class="mi">8</span><span class="o">*</span><span class="n">pm_idx</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">mpr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">sa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCSA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">sa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">la</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCLA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">la</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">la</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCCA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write srccf register */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCCF</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ccr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCCCR</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ccr</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ccr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCCTL</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_get_ca</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCCA</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">ca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">get_field</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">ca</span><span class="p">,</span> <span class="n">SRCCA_CA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">src_get_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">src_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">src_dirty_conj_mask</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mh">0x20</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_enbs_src</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enbsa</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">enbsa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">%</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_enb_src</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">%</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_dsb_src</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">%</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">/</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">enbsa</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCENBSTAT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCENBS</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">enbsa</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">enbsa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCENB</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mh">0x100</span><span class="p">),</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">enb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">src_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">src_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imaparc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">,</span> <span class="n">SRCAIM_ARC</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imapuser</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">,</span> <span class="n">SRCAIM_SRC</span><span class="p">,</span> <span class="n">user</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imapnxt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">,</span> <span class="n">SRCAIM_NXT</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_set_imapaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">srcimp_mgr_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">srcimp_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCIMAP</span><span class="o">+</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">idx</span><span class="o">*</span><span class="mh">0x100</span><span class="p">,</span>
						<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srcimap</span><span class="p">.</span><span class="n">srcaim</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srcimap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AMIXER control block definitions.</span>
<span class="cm"> */</span>

<span class="cp">#define AMOPLO_M	0x00000003</span>
<span class="cp">#define AMOPLO_X	0x0003FFF0</span>
<span class="cp">#define AMOPLO_Y	0xFFFC0000</span>

<span class="cp">#define AMOPHI_SADR	0x000000FF</span>
<span class="cp">#define AMOPHI_SE	0x80000000</span>

<span class="cm">/* AMIXER resource register dirty flags */</span>
<span class="k">union</span> <span class="n">amixer_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">amoplo</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">amophi</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* AMIXER resource control block */</span>
<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">amoplo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">amophi</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">amixer_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_mode</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_M</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_iv</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">iv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 20k1 amixer does not have this field */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_x</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_y</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_sadr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sadr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amophi</span><span class="p">,</span> <span class="n">AMOPHI_SADR</span><span class="p">,</span> <span class="n">sadr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_se</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">se</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amophi</span><span class="p">,</span> <span class="n">AMOPHI_SE</span><span class="p">,</span> <span class="n">se</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_set_dirty_all</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">||</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AMOPLO</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amoplo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">AMOPHI</span><span class="o">+</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amophi</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">amophi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_get_y</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">get_field</span><span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">amoplo</span><span class="p">,</span> <span class="n">AMOPLO_Y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">amixer_get_dirty</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_rsc_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_rsc_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">amixer_rsc_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_mgr_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*amixer_mgr_ctrl_blk_t *blk;*/</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/*blk = kzalloc(sizeof(*blk), GFP_KERNEL);</span>
<span class="cm">	if (!blk)</span>
<span class="cm">		return -ENOMEM;</span>

<span class="cm">	*rblk = blk;*/</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amixer_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*kfree((amixer_mgr_ctrl_blk_t *)blk);*/</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DAIO control block definitions.</span>
<span class="cm"> */</span>

<span class="cm">/* Receiver Sample Rate Tracker Control register */</span>
<span class="cp">#define SRTCTL_SRCR	0x000000FF</span>
<span class="cp">#define SRTCTL_SRCL	0x0000FF00</span>
<span class="cp">#define SRTCTL_RSR	0x00030000</span>
<span class="cp">#define SRTCTL_DRAT	0x000C0000</span>
<span class="cp">#define SRTCTL_RLE	0x10000000</span>
<span class="cp">#define SRTCTL_RLP	0x20000000</span>
<span class="cp">#define SRTCTL_EC	0x40000000</span>
<span class="cp">#define SRTCTL_ET	0x80000000</span>

<span class="cm">/* DAIO Receiver register dirty flags */</span>
<span class="k">union</span> <span class="n">dai_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">srtctl</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* DAIO Receiver control block */</span>
<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">srtctl</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">dai_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* S/PDIF Transmitter register dirty flags */</span>
<span class="k">union</span> <span class="n">dao_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">spos</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* S/PDIF Transmitter control block */</span>
<span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> 	<span class="n">spos</span><span class="p">;</span> <span class="cm">/* S/PDIF Output Channel Status Register */</span>
	<span class="k">union</span> <span class="n">dao_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Audio Input Mapper RAM */</span>
<span class="cp">#define AIM_ARC		0x00000FFF</span>
<span class="cp">#define AIM_NXT		0x007F0000</span>

<span class="k">struct</span> <span class="n">daoimap</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">aim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* I2S Transmitter/Receiver Control register */</span>
<span class="cp">#define I2SCTL_EA	0x00000004</span>
<span class="cp">#define I2SCTL_EI	0x00000010</span>

<span class="cm">/* S/PDIF Transmitter Control register */</span>
<span class="cp">#define SPOCTL_OE	0x00000001</span>
<span class="cp">#define SPOCTL_OS	0x0000000E</span>
<span class="cp">#define SPOCTL_RIV	0x00000010</span>
<span class="cp">#define SPOCTL_LIV	0x00000020</span>
<span class="cp">#define SPOCTL_SR	0x000000C0</span>

<span class="cm">/* S/PDIF Receiver Control register */</span>
<span class="cp">#define SPICTL_EN	0x00000001</span>
<span class="cp">#define SPICTL_I24	0x00000002</span>
<span class="cp">#define SPICTL_IB	0x00000004</span>
<span class="cp">#define SPICTL_SM	0x00000008</span>
<span class="cp">#define SPICTL_VM	0x00000010</span>

<span class="cm">/* DAIO manager register dirty flags */</span>
<span class="k">union</span> <span class="n">daio_mgr_dirty</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">i2soctl</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">i2sictl</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">spoctl</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">spictl</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">daoimap</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">rsv</span><span class="o">:</span><span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* DAIO manager control block */</span>
<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">i2sctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">spoctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">spictl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">daoimap</span>		<span class="n">daoimap</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">daio_mgr_dirty</span>	<span class="n">dirty</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_srcr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">,</span> <span class="n">SRTCTL_SRCR</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_srcl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">,</span> <span class="n">SRTCTL_SRCL</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_rsr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">,</span> <span class="n">SRTCTL_RSR</span><span class="p">,</span> <span class="n">rsr</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_drat</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">drat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">,</span> <span class="n">SRTCTL_DRAT</span><span class="p">,</span> <span class="n">drat</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_ec</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">,</span> <span class="n">SRTCTL_EC</span><span class="p">,</span> <span class="n">ec</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_srt_set_et</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">et</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">,</span> <span class="n">SRTCTL_ET</span><span class="p">,</span> <span class="n">et</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* S/PDIF SRTs */</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRTSCTL</span><span class="o">+</span><span class="mh">0x4</span><span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* I2S SRT */</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRTICTL</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">srtctl</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">srtctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dai_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">dai_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_set_spos</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spos</span> <span class="o">=</span> <span class="n">spos</span><span class="p">;</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* S/PDIF SPOSx */</span>
			<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPOS</span><span class="o">+</span><span class="mh">0x4</span><span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spos</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_get_spos</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">spos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">spos</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">spos</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_get_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dao_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">dao_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_enb_dai</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S/PDIF input */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spictl</span><span class="p">,</span> <span class="n">SPICTL_EN</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spictl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2S input */</span>
		<span class="n">idx</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">i2sctl</span><span class="p">,</span> <span class="n">I2SCTL_EI</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2sictl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_dsb_dai</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S/PDIF input */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spictl</span><span class="p">,</span> <span class="n">SPICTL_EN</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spictl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2S input */</span>
		<span class="n">idx</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">i2sctl</span><span class="p">,</span> <span class="n">I2SCTL_EI</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2sictl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_enb_dao</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S/PDIF output */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_OE</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spoctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2S output */</span>
		<span class="n">idx</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">i2sctl</span><span class="p">,</span> <span class="n">I2SCTL_EA</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2soctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_dsb_dao</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S/PDIF output */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_OE</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spoctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2S output */</span>
		<span class="n">idx</span> <span class="o">%=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">i2sctl</span><span class="p">,</span> <span class="n">I2SCTL_EA</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2soctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_dao_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* S/PDIF output */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">conf</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_SR</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* CDIF */</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_SR</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_SR</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_SR</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_LIV</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">conf</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span> <span class="cm">/* Non-audio */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_RIV</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">conf</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span> <span class="cm">/* Non-audio */</span>
		<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">,</span> <span class="n">SPOCTL_OS</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span>
			  <span class="p">((</span><span class="n">conf</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* Raw */</span>

		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spoctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I2S output */</span>
		<span class="cm">/*idx %= 4; */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_set_imaparc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">aim</span><span class="p">,</span> <span class="n">AIM_ARC</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_set_imapnxt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">aim</span><span class="p">,</span> <span class="n">AIM_NXT</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_set_imapaddr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_commit_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2sictl</span> <span class="o">||</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2soctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2sictl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2sictl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2soctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">i2soctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2SCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">i2sctl</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spoctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spoctl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spoctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPOCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spoctl</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spictl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spictl</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
				<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">spictl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPICTL</span><span class="p">,</span> <span class="n">ctl</span><span class="o">-&gt;</span><span class="n">spictl</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">DAOIMAP</span><span class="o">+</span><span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">idx</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
					<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">daoimap</span><span class="p">.</span><span class="n">aim</span><span class="p">);</span>
		<span class="n">ctl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">.</span><span class="n">bf</span><span class="p">.</span><span class="n">daoimap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_get_ctrl_blk</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">rblk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="n">blk</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">blk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">blk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">blk</span><span class="o">-&gt;</span><span class="n">i2sctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2SCTL</span><span class="p">);</span>
	<span class="n">blk</span><span class="o">-&gt;</span><span class="n">spoctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPOCTL</span><span class="p">);</span>
	<span class="n">blk</span><span class="o">-&gt;</span><span class="n">spictl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPICTL</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rblk</span> <span class="o">=</span> <span class="n">blk</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">daio_mgr_put_ctrl_blk</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">blk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">((</span><span class="k">struct</span> <span class="n">daio_mgr_ctrl_blk</span> <span class="o">*</span><span class="p">)</span><span class="n">blk</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Timer interrupt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_timer_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIE</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">IT_INT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_timer_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ticks</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
		<span class="n">ticks</span> <span class="o">|=</span> <span class="n">TIMR_IE</span> <span class="o">|</span> <span class="n">TIMR_IP</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TIMR</span><span class="p">,</span> <span class="n">ticks</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_wc</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">WC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Card hardware initialization block */</span>
<span class="k">struct</span> <span class="n">dac_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span> <span class="cm">/* master sample rate in rsrs */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">adc_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span> 	<span class="cm">/* master sample rate in rsrs */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">input</span><span class="p">;</span> 	<span class="cm">/* the input source of ADC */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mic20db</span><span class="p">;</span> 	<span class="cm">/* boost mic by 20db if input is microphone */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">daio_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msr</span><span class="p">;</span> <span class="cm">/* master sample rate in rsrs */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">trn_conf</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vm_pgt_phys</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_daio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">daio_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i2sorg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">spdorg</span><span class="p">;</span>

	<span class="cm">/* Read I2S CTL.  Keep original value. */</span>
	<span class="cm">/*i2sorg = hw_read_20kx(hw, I2SCTL);*/</span>
	<span class="n">i2sorg</span> <span class="o">=</span> <span class="mh">0x94040404</span><span class="p">;</span> <span class="cm">/* enable all audio out and I2S-D input */</span>
	<span class="cm">/* Program I2S with proper master sample rate and enable</span>
<span class="cm">	 * the correct I2S channel. */</span>
	<span class="n">i2sorg</span> <span class="o">&amp;=</span> <span class="mh">0xfffffffc</span><span class="p">;</span>

	<span class="cm">/* Enable S/PDIF-out-A in fixed 24-bit data</span>
<span class="cm">	 * format and default to 48kHz. */</span>
	<span class="cm">/* Disable all before doing any changes. */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPOCTL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">spdorg</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">i2sorg</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spdorg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x0</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">i2sorg</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">spdorg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">i2sorg</span> <span class="o">|=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">spdorg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x2</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">i2sorg</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">I2SCTL</span><span class="p">,</span> <span class="n">i2sorg</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPOCTL</span><span class="p">,</span> <span class="n">spdorg</span><span class="p">);</span>

	<span class="cm">/* Enable S/PDIF-in-A in fixed 24-bit data format. */</span>
	<span class="cm">/* Disable all before doing any changes. */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPICTL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spdorg</span> <span class="o">=</span> <span class="mh">0x0a0a0a0a</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SPICTL</span><span class="p">,</span> <span class="n">spdorg</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TRANSPORT operations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_trn_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">trn_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">trnctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ptp_phys_low</span><span class="p">,</span> <span class="n">ptp_phys_high</span><span class="p">;</span>

	<span class="cm">/* Set up device page table */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">~</span><span class="mi">0UL</span><span class="p">)</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Wrong device page table page address!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trnctl</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>  <span class="cm">/* 32-bit, 4k-size page */</span>
	<span class="n">ptp_phys_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">;</span>
	<span class="n">ptp_phys_high</span> <span class="o">=</span> <span class="n">upper_32_bits</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* 64bit address */</span>
		<span class="n">trnctl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* Only 4k h/w pages for simplicitiy */</span>
<span class="cp">#if PAGE_SIZE == 8192</span>
<span class="c">	trnctl |= (1&lt;&lt;5);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PTPALX</span><span class="p">,</span> <span class="n">ptp_phys_low</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PTPAHX</span><span class="p">,</span> <span class="n">ptp_phys_high</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRNCTL</span><span class="p">,</span> <span class="n">trnctl</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRNIS</span><span class="p">,</span> <span class="mh">0x200c01</span><span class="p">);</span> <span class="cm">/* really needed? */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card initialization */</span>
<span class="cp">#define GCTL_EAC	0x00000001</span>
<span class="cp">#define GCTL_EAI	0x00000002</span>
<span class="cp">#define GCTL_BEP	0x00000004</span>
<span class="cp">#define GCTL_BES	0x00000008</span>
<span class="cp">#define GCTL_DSP	0x00000010</span>
<span class="cp">#define GCTL_DBP	0x00000020</span>
<span class="cp">#define GCTL_ABP	0x00000040</span>
<span class="cp">#define GCTL_TBP	0x00000080</span>
<span class="cp">#define GCTL_SBP	0x00000100</span>
<span class="cp">#define GCTL_FBP	0x00000200</span>
<span class="cp">#define GCTL_XA		0x00000400</span>
<span class="cp">#define GCTL_ET		0x00000800</span>
<span class="cp">#define GCTL_PR		0x00001000</span>
<span class="cp">#define GCTL_MRL	0x00002000</span>
<span class="cp">#define GCTL_SDE	0x00004000</span>
<span class="cp">#define GCTL_SDI	0x00008000</span>
<span class="cp">#define GCTL_SM		0x00010000</span>
<span class="cp">#define GCTL_SR		0x00020000</span>
<span class="cp">#define GCTL_SD		0x00040000</span>
<span class="cp">#define GCTL_SE		0x00080000</span>
<span class="cp">#define GCTL_AID	0x00100000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_pll_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rsr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pllctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pllctl</span> <span class="o">=</span> <span class="p">(</span><span class="mi">48000</span> <span class="o">==</span> <span class="n">rsr</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1480a001</span> <span class="o">:</span> <span class="mh">0x1480a731</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLLCTL</span><span class="p">)</span> <span class="o">==</span> <span class="n">pllctl</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLLCTL</span><span class="p">,</span> <span class="n">pllctl</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;PLL initialization failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_auto_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_EAI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_EAI</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">400000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_field</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_AID</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_field</span><span class="p">(</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_AID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;Card Auto-init failed!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">);</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">);</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xaa</span><span class="p">)</span>
		<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">device</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x800000</span><span class="p">));</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xE0</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xE4</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* DAC operations */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_reset_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpioorg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x800000</span><span class="p">));</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>  <span class="cm">/* write to i2c status control */</span>

	<span class="cm">/* To be effective, need to reset the DAC twice. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span>  <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set gpio */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">gpioorg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
		<span class="n">gpioorg</span> <span class="o">&amp;=</span> <span class="mh">0xfffd</span><span class="p">;</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">gpioorg</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">gpioorg</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x00180080</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x00180080</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_dac_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dac_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gpioorg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB055X</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SB055x, unmute outputs */</span>
		<span class="n">gpioorg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
		<span class="n">gpioorg</span> <span class="o">&amp;=</span> <span class="mh">0xffbf</span><span class="p">;</span>	<span class="cm">/* set GPIO6 to low */</span>
		<span class="n">gpioorg</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* set GPIO1 to high */</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">gpioorg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* mute outputs */</span>
	<span class="n">gpioorg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="n">gpioorg</span> <span class="o">&amp;=</span> <span class="mh">0xffbf</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">gpioorg</span><span class="p">);</span>

	<span class="n">hw_reset_dac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>  <span class="cm">/* write to i2c status control */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x800000</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x00180080</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x00180080</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x00180080</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x00180080</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* unmute outputs */</span>
	<span class="n">gpioorg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="n">gpioorg</span> <span class="o">=</span> <span class="n">gpioorg</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">gpioorg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ADC operations */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_adc_input_selected_SB055x</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_adc_input_selected_SBx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_NONE</span>: <span class="cm">/* Digital I/O */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_adc_input_selected_hendrix</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_is_adc_input_selected</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTSB055X</span>:
		<span class="k">return</span> <span class="n">is_adc_input_selected_SB055x</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CTSB073X</span>:
		<span class="k">return</span> <span class="n">is_adc_input_selected_hendrix</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CTUAA</span>:
		<span class="k">return</span> <span class="n">is_adc_input_selected_hendrix</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">is_adc_input_selected_SBx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adc_input_select_SB055x</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">boost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check and set the following GPIO bits accordingly</span>
<span class="cm">	 * ADC_Gain		= GPIO2</span>
<span class="cm">	 * DRM_off		= GPIO3</span>
<span class="cm">	 * Mic_Pwr_on		= GPIO7</span>
<span class="cm">	 * Digital_IO_Sel	= GPIO8</span>
<span class="cm">	 * Mic_Sw		= GPIO9</span>
<span class="cm">	 * Aux/MicLine_Sw	= GPIO12</span>
<span class="cm">	 */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="mh">0xec73</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">boost</span> <span class="o">?</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_AUX</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_NONE</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">);</span>  <span class="cm">/* set to digital */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adc_input_select_SBx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">boost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i2c_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x800000</span><span class="p">));</span> <span class="cm">/* i2c ready poll */</span>
	<span class="cm">/* set i2c access mode as Direct Control */</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">((</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>  <span class="cm">/* Mic-in */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* Line-in */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_NONE</span>:
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="cm">/* set to Digital */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">i2c_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">);</span> <span class="cm">/* +12dB boost */</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">);</span> <span class="cm">/* +12dB boost */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span> <span class="cm">/* No boost */</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span> <span class="cm">/* No boost */</span>
	<span class="p">}</span>

	<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adc_input_select_hendrix</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">boost</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i2c_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x800000</span><span class="p">));</span> <span class="cm">/* i2c ready poll */</span>
	<span class="cm">/* set i2c access mode as Direct Control */</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>  <span class="cm">/* Mic-in */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">i2c_data</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* Line-in */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">i2c_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">);</span> <span class="cm">/* +12dB boost */</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">);</span> <span class="cm">/* +12dB boost */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span> <span class="cm">/* No boost */</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span> <span class="cm">/* No boost */</span>
	<span class="p">}</span>

	<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_adc_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ADCSRC</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">type</span> <span class="o">==</span> <span class="n">ADC_MICIN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTSB055X</span>:
		<span class="k">return</span> <span class="n">adc_input_select_SB055x</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CTSB073X</span>:
		<span class="k">return</span> <span class="n">adc_input_select_hendrix</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CTUAA</span>:
		<span class="k">return</span> <span class="n">adc_input_select_hendrix</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">adc_input_select_SBx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_init_SB055x</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mic20db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">adc_input_select_SB055x</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">mic20db</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adc_init_SBx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mic20db</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">gpioorg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">input_source</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">adcdata</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">input_source</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>  <span class="cm">/* default to analog */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADC_MICIN</span>:
		<span class="n">adcdata</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">input_source</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">;</span>  <span class="cm">/* set GPIO7 to select Mic */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_LINEIN</span>:
		<span class="n">adcdata</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_VIDEO</span>:
		<span class="n">adcdata</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_AUX</span>:
		<span class="n">adcdata</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADC_NONE</span>:
		<span class="n">adcdata</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">input_source</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>  <span class="cm">/* set to Digital */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">adcdata</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hw_read_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0x800000</span><span class="p">));</span> <span class="cm">/* i2c ready poll */</span>
	<span class="n">hw_write_pci</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0xEC</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>  <span class="cm">/* write to i2c status control */</span>

	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">);</span>
	<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="n">adcdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mic20db</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xcf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ID0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span>
		<span class="n">i2c_write</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x001a0080</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>

	<span class="n">i2c_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">gpioorg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>  <span class="n">GPIO</span><span class="p">);</span>
	<span class="n">gpioorg</span> <span class="o">&amp;=</span> <span class="mh">0xfe7f</span><span class="p">;</span>
	<span class="n">gpioorg</span> <span class="o">|=</span> <span class="n">input_source</span><span class="p">;</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIO</span><span class="p">,</span> <span class="n">gpioorg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_adc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">adc_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB055X</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">adc_init_SB055x</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mic20db</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">adc_init_SBx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">mic20db</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">capabilities</span> <span class="nf">hw_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">capabilities</span> <span class="n">cap</span><span class="p">;</span>

	<span class="cm">/* SB073x and Vista compatible cards have no digit IO switch */</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">digit_io_switch</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTSB073X</span> <span class="o">||</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTUAA</span><span class="p">);</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">dedicated_mic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">output_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cap</span><span class="p">.</span><span class="n">mic_source_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cap</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CTLBITS(a, b, c, d)	(((a) &lt;&lt; 24) | ((b) &lt;&lt; 16) | ((c) &lt;&lt; 8) | (d))</span>

<span class="cp">#define UAA_CFG_PWRSTATUS	0x44</span>
<span class="cp">#define UAA_CFG_SPACE_FLAG	0xA0</span>
<span class="cp">#define UAA_CORE_CHANGE		0x3FFC</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uaa_to_xfi</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bar0</span><span class="p">,</span> <span class="n">bar1</span><span class="p">,</span> <span class="n">bar2</span><span class="p">,</span> <span class="n">bar3</span><span class="p">,</span> <span class="n">bar4</span><span class="p">,</span> <span class="n">bar5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">cl_size</span><span class="p">,</span> <span class="n">l_timer</span><span class="p">,</span> <span class="n">pwr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">is_uaa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">io_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTLX</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTL_</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTLF</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTLi</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;i&#39;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTLA</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTLZ</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;Z&#39;</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">CTLL</span> <span class="o">=</span> <span class="n">CTLBITS</span><span class="p">(</span><span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">);</span>

	<span class="cm">/* By default, Hendrix card UAA Bar0 should be using memory... */</span>
	<span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mem_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">io_base</span><span class="p">,</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="cm">/* Read current mode from Mode Change Register */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">UAA_CORE_CHANGE</span><span class="p">);</span>

	<span class="cm">/* Determine current mode... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_uaa</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLZ</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLL</span>
			  <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span>
			  <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLZ</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLL</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_uaa</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLL</span>
				<span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_uaa</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span>
				<span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLA</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">CTLZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">is_uaa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_uaa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not in UAA mode currently. Return directly. */</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar0</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar1</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar2</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar3</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar4</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bar5</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cl_size</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l_timer</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">UAA_CFG_PWRSTATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwr</span><span class="p">);</span>
	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Set up X-Fi core PCI configuration space. */</span>
	<span class="cm">/* Switch to X-Fi config space with BAR0 exposed. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">UAA_CFG_SPACE_FLAG</span><span class="p">,</span> <span class="mh">0x87654321</span><span class="p">);</span>
	<span class="cm">/* Copy UAA&#39;s BAR5 into X-Fi BAR0 */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_0</span><span class="p">,</span> <span class="n">bar5</span><span class="p">);</span>
	<span class="cm">/* Switch to X-Fi config space without BAR0 exposed. */</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">UAA_CFG_SPACE_FLAG</span><span class="p">,</span> <span class="mh">0x12345678</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_1</span><span class="p">,</span> <span class="n">bar1</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_2</span><span class="p">,</span> <span class="n">bar2</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_3</span><span class="p">,</span> <span class="n">bar3</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_BASE_ADDRESS_4</span><span class="p">,</span> <span class="n">bar4</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">cl_size</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">l_timer</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">UAA_CFG_PWRSTATUS</span><span class="p">,</span> <span class="n">pwr</span><span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* Switch to X-Fi mode */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CTLX</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">UAA_CORE_CHANGE</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CTL_</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">UAA_CORE_CHANGE</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CTLF</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">UAA_CORE_CHANGE</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">CTLi</span><span class="p">,</span> <span class="p">(</span><span class="n">mem_base</span> <span class="o">+</span> <span class="n">UAA_CORE_CHANGE</span><span class="p">));</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">mem_base</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ct_20k1_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq_callback_data</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIP</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Set DMA transfer mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">CT_XFI_DMA_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">CT_XFI_DMA_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;architecture does not support PCI &quot;</span>
				<span class="s">&quot;busmaster DMA with mask 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">CT_XFI_DMA_MASK</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;XFi&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTUAA</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* Switch to X-Fi mode from UAA mode if neeeded */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTUAA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">uaa_to_xfi</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ct_20k1_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
				  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;XFi: Cannot get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error2:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error1:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* disable transport bus master and queueing of request */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">TRNCTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* disable pll */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLLCTL</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">PLLCTL</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mh">0x0F</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">))));</span>

	<span class="cm">/* TODO: Disable interrupt and so on... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mem_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_card_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">card_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dac_conf</span> <span class="n">dac_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">adc_conf</span> <span class="n">adc_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">daio_conf</span> <span class="n">daio_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">trn_conf</span> <span class="n">trn_info</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* Get PCI io port base address and do Hendrix switch if needed. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_card_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* PLL init */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_pll_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* kick off auto-init */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_auto_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Enable audio ring */</span>
	<span class="n">gctl</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_EAC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_DBP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_TBP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_FBP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gctl</span><span class="p">,</span> <span class="n">GCTL_ET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GCTL</span><span class="p">,</span> <span class="n">gctl</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Reset all global pending interrupts */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GIE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Reset all SRC pending interrupts */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* Detect the card ID and configure GPIO accordingly. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CTSB055X</span>:
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIOCTL</span><span class="p">,</span> <span class="mh">0x13fe</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTSB073X</span>:
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIOCTL</span><span class="p">,</span> <span class="mh">0x00e6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CTUAA</span>:
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIOCTL</span><span class="p">,</span> <span class="mh">0x00c2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">GPIOCTL</span><span class="p">,</span> <span class="mh">0x01e6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trn_info</span><span class="p">.</span><span class="n">vm_pgt_phys</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">vm_pgt_phys</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_trn_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trn_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">daio_info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_daio_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">daio_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dac_info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_dac_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dac_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">adc_info</span><span class="p">.</span><span class="n">msr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">msr</span><span class="p">;</span>
	<span class="n">adc_info</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">ADC_LINEIN</span><span class="p">;</span>
	<span class="n">adc_info</span><span class="p">.</span><span class="n">mic20db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hw_adc_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adc_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">hw_read_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCMCTL</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* Enables input from the audio ring */</span>
	<span class="n">hw_write_20kx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SRCMCTL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>

	<span class="n">hw_card_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">==</span> <span class="n">CTUAA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Switch to UAA config space. */</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">UAA_CFG_SPACE_FLAG</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hw_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">card_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/* Re-initialize card hardware. */</span>
	<span class="k">return</span> <span class="n">hw_card_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hw_read_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_20k1_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_20k1_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_write_20kx</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_20k1_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_20k1_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">hw_read_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_pci_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_pci_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_write_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_pci_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">reg_pci_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">hw</span> <span class="n">ct20k1_preset</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">card_init</span> <span class="o">=</span> <span class="n">hw_card_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">card_stop</span> <span class="o">=</span> <span class="n">hw_card_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pll_init</span> <span class="o">=</span> <span class="n">hw_pll_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_adc_source_selected</span> <span class="o">=</span> <span class="n">hw_is_adc_input_selected</span><span class="p">,</span>
	<span class="p">.</span><span class="n">select_adc_source</span> <span class="o">=</span> <span class="n">hw_adc_input_select</span><span class="p">,</span>
	<span class="p">.</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">hw_capabilities</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">hw_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">hw_resume</span><span class="p">,</span>
<span class="cp">#endif</span>

	<span class="p">.</span><span class="n">src_rsc_get_ctrl_blk</span> <span class="o">=</span> <span class="n">src_get_rsc_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_rsc_put_ctrl_blk</span> <span class="o">=</span> <span class="n">src_put_rsc_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">src_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">src_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_state</span> <span class="o">=</span> <span class="n">src_set_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_bm</span> <span class="o">=</span> <span class="n">src_set_bm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_rsr</span> <span class="o">=</span> <span class="n">src_set_rsr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_sf</span> <span class="o">=</span> <span class="n">src_set_sf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_wr</span> <span class="o">=</span> <span class="n">src_set_wr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_pm</span> <span class="o">=</span> <span class="n">src_set_pm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_rom</span> <span class="o">=</span> <span class="n">src_set_rom</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_vo</span> <span class="o">=</span> <span class="n">src_set_vo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_st</span> <span class="o">=</span> <span class="n">src_set_st</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_ie</span> <span class="o">=</span> <span class="n">src_set_ie</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_ilsz</span> <span class="o">=</span> <span class="n">src_set_ilsz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_bp</span> <span class="o">=</span> <span class="n">src_set_bp</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_cisz</span> <span class="o">=</span> <span class="n">src_set_cisz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_ca</span> <span class="o">=</span> <span class="n">src_set_ca</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_sa</span> <span class="o">=</span> <span class="n">src_set_sa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_la</span> <span class="o">=</span> <span class="n">src_set_la</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_pitch</span> <span class="o">=</span> <span class="n">src_set_pitch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_dirty</span> <span class="o">=</span> <span class="n">src_set_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_clear_zbufs</span> <span class="o">=</span> <span class="n">src_set_clear_zbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_set_dirty_all</span> <span class="o">=</span> <span class="n">src_set_dirty_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_commit_write</span> <span class="o">=</span> <span class="n">src_commit_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_get_ca</span> <span class="o">=</span> <span class="n">src_get_ca</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_get_dirty</span> <span class="o">=</span> <span class="n">src_get_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_dirty_conj_mask</span> <span class="o">=</span> <span class="n">src_dirty_conj_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_enbs_src</span> <span class="o">=</span> <span class="n">src_mgr_enbs_src</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_enb_src</span> <span class="o">=</span> <span class="n">src_mgr_enb_src</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_dsb_src</span> <span class="o">=</span> <span class="n">src_mgr_dsb_src</span><span class="p">,</span>
	<span class="p">.</span><span class="n">src_mgr_commit_write</span> <span class="o">=</span> <span class="n">src_mgr_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">srcimp_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">srcimp_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">srcimp_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imaparc</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imaparc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imapuser</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imapuser</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imapnxt</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imapnxt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_set_imapaddr</span> <span class="o">=</span> <span class="n">srcimp_mgr_set_imapaddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">srcimp_mgr_commit_write</span> <span class="o">=</span> <span class="n">srcimp_mgr_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">amixer_rsc_get_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_rsc_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_rsc_put_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_rsc_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">amixer_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_mode</span> <span class="o">=</span> <span class="n">amixer_set_mode</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_iv</span> <span class="o">=</span> <span class="n">amixer_set_iv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_x</span> <span class="o">=</span> <span class="n">amixer_set_x</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_y</span> <span class="o">=</span> <span class="n">amixer_set_y</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_sadr</span> <span class="o">=</span> <span class="n">amixer_set_sadr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_se</span> <span class="o">=</span> <span class="n">amixer_set_se</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_dirty</span> <span class="o">=</span> <span class="n">amixer_set_dirty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_set_dirty_all</span> <span class="o">=</span> <span class="n">amixer_set_dirty_all</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_commit_write</span> <span class="o">=</span> <span class="n">amixer_commit_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_get_y</span> <span class="o">=</span> <span class="n">amixer_get_y</span><span class="p">,</span>
	<span class="p">.</span><span class="n">amixer_get_dirty</span> <span class="o">=</span> <span class="n">amixer_get_dirty</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dai_get_ctrl_blk</span> <span class="o">=</span> <span class="n">dai_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_put_ctrl_blk</span> <span class="o">=</span> <span class="n">dai_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_srco</span> <span class="o">=</span> <span class="n">dai_srt_set_srcr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_srcm</span> <span class="o">=</span> <span class="n">dai_srt_set_srcl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_rsr</span> <span class="o">=</span> <span class="n">dai_srt_set_rsr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_drat</span> <span class="o">=</span> <span class="n">dai_srt_set_drat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_ec</span> <span class="o">=</span> <span class="n">dai_srt_set_ec</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_srt_set_et</span> <span class="o">=</span> <span class="n">dai_srt_set_et</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dai_commit_write</span> <span class="o">=</span> <span class="n">dai_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">dao_get_ctrl_blk</span> <span class="o">=</span> <span class="n">dao_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_put_ctrl_blk</span> <span class="o">=</span> <span class="n">dao_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_set_spos</span> <span class="o">=</span> <span class="n">dao_set_spos</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_commit_write</span> <span class="o">=</span> <span class="n">dao_commit_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dao_get_spos</span> <span class="o">=</span> <span class="n">dao_get_spos</span><span class="p">,</span>

	<span class="p">.</span><span class="n">daio_mgr_get_ctrl_blk</span> <span class="o">=</span> <span class="n">daio_mgr_get_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_put_ctrl_blk</span> <span class="o">=</span> <span class="n">daio_mgr_put_ctrl_blk</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_enb_dai</span> <span class="o">=</span> <span class="n">daio_mgr_enb_dai</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_dsb_dai</span> <span class="o">=</span> <span class="n">daio_mgr_dsb_dai</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_enb_dao</span> <span class="o">=</span> <span class="n">daio_mgr_enb_dao</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_dsb_dao</span> <span class="o">=</span> <span class="n">daio_mgr_dsb_dao</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_dao_init</span> <span class="o">=</span> <span class="n">daio_mgr_dao_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_set_imaparc</span> <span class="o">=</span> <span class="n">daio_mgr_set_imaparc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_set_imapnxt</span> <span class="o">=</span> <span class="n">daio_mgr_set_imapnxt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_set_imapaddr</span> <span class="o">=</span> <span class="n">daio_mgr_set_imapaddr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">daio_mgr_commit_write</span> <span class="o">=</span> <span class="n">daio_mgr_commit_write</span><span class="p">,</span>

	<span class="p">.</span><span class="n">set_timer_irq</span> <span class="o">=</span> <span class="n">set_timer_irq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_timer_tick</span> <span class="o">=</span> <span class="n">set_timer_tick</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wc</span> <span class="o">=</span> <span class="n">get_wc</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">create_20k1_hw_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">**</span><span class="n">rhw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw20k1</span> <span class="o">*</span><span class="n">hw20k1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rhw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hw20k1</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hw20k1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw20k1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw20k1</span><span class="o">-&gt;</span><span class="n">reg_20k1_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw20k1</span><span class="o">-&gt;</span><span class="n">reg_pci_lock</span><span class="p">);</span>

	<span class="n">hw20k1</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ct20k1_preset</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rhw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw20k1</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">destroy_20k1_hw_obj</span><span class="p">(</span><span class="k">struct</span> <span class="n">hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">io_base</span><span class="p">)</span>
		<span class="n">hw_card_shutdown</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hw20k1</span><span class="p">,</span> <span class="n">hw</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
