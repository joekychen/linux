<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › intel8x0.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>intel8x0.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for Intel ICH (i8x0) chipsets</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2000 Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This code also contains alpha support for SiS 735 chipsets provided</span>
<span class="cm"> *   by Mike Pieper &lt;mptei@users.sourceforge.net&gt;. We have no datasheet</span>
<span class="cm"> *   for SiS735, so the code is not fully functional.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>

<span class="cm"> *</span>
<span class="cm"> */</span>      

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cm">/* for 440MX workaround */</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="cp">#ifdef CONFIG_KVM_GUEST</span>
<span class="cp">#include &lt;linux/kvm_para.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#define kvm_para_available() (0)</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jaroslav Kysela &lt;perex@perex.cz&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel 82801AA,82901AB,i810,i820,i830,i840,i845,MX440; SiS 7012; Ali 5455&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Intel,82801AA-ICH},&quot;</span>
		<span class="s">&quot;{Intel,82901AB-ICH0},&quot;</span>
		<span class="s">&quot;{Intel,82801BA-ICH2},&quot;</span>
		<span class="s">&quot;{Intel,82801CA-ICH3},&quot;</span>
		<span class="s">&quot;{Intel,82801DB-ICH4},&quot;</span>
		<span class="s">&quot;{Intel,ICH5},&quot;</span>
		<span class="s">&quot;{Intel,ICH6},&quot;</span>
		<span class="s">&quot;{Intel,ICH7},&quot;</span>
		<span class="s">&quot;{Intel,6300ESB},&quot;</span>
		<span class="s">&quot;{Intel,ESB2},&quot;</span>
		<span class="s">&quot;{Intel,MX440},&quot;</span>
		<span class="s">&quot;{SiS,SI7012},&quot;</span>
		<span class="s">&quot;{NVidia,nForce Audio},&quot;</span>
		<span class="s">&quot;{NVidia,nForce2 Audio},&quot;</span>
		<span class="s">&quot;{NVidia,nForce3 Audio},&quot;</span>
		<span class="s">&quot;{NVidia,MCP04},&quot;</span>
		<span class="s">&quot;{NVidia,MCP501},&quot;</span>
		<span class="s">&quot;{NVidia,CK804},&quot;</span>
		<span class="s">&quot;{NVidia,CK8},&quot;</span>
		<span class="s">&quot;{NVidia,CK8S},&quot;</span>
		<span class="s">&quot;{AMD,AMD768},&quot;</span>
		<span class="s">&quot;{AMD,AMD8111},&quot;</span>
	        <span class="s">&quot;{ALI,M5455}}&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX1</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR1</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ac97_quirk</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">buggy_semaphore</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">buggy_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* auto-check */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">xbox</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">spdif_aclink</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">inside_vm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Intel i8x0 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Intel i8x0 soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ac97_clock</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codec clock (0 = whitelist + auto-detect, 1 = force autodetect).&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ac97_quirk</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ac97_quirk</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 workaround for strange hardware.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">buggy_semaphore</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">buggy_semaphore</span><span class="p">,</span> <span class="s">&quot;Enable workaround for hardwares with problematic codec semaphores.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">buggy_irq</span><span class="p">,</span> <span class="n">bint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">buggy_irq</span><span class="p">,</span> <span class="s">&quot;Enable workaround for buggy interrupts on some motherboards.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">xbox</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">xbox</span><span class="p">,</span> <span class="s">&quot;Set to 1 for Xbox, if you have problems with the AC&#39;97 codec detection.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">spdif_aclink</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">spdif_aclink</span><span class="p">,</span> <span class="s">&quot;S/PDIF over AC-link.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">inside_vm</span><span class="p">,</span> <span class="n">bint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">inside_vm</span><span class="p">,</span> <span class="s">&quot;KVM/Parallels optimization.&quot;</span><span class="p">);</span>

<span class="cm">/* just for backward compatibility */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">joystick</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">joystick</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Direct registers</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">DEVICE_INTEL</span><span class="p">,</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">,</span> <span class="n">DEVICE_SIS</span><span class="p">,</span> <span class="n">DEVICE_ALI</span><span class="p">,</span> <span class="n">DEVICE_NFORCE</span> <span class="p">};</span>

<span class="cp">#define ICHREG(x) ICH_REG_##x</span>

<span class="cp">#define DEFINE_REGSET(name,base) \</span>
<span class="cp">enum { \</span>
<span class="cp">	ICH_REG_##name##_BDBAR	= base + 0x0,	</span><span class="cm">/* dword - buffer descriptor list base address */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_CIV	= base + 0x04,	</span><span class="cm">/* byte - current index value */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_LVI	= base + 0x05,	</span><span class="cm">/* byte - last valid index */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_SR	= base + 0x06,	</span><span class="cm">/* byte - status register */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_PICB	= base + 0x08,	</span><span class="cm">/* word - position in current buffer */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_PIV	= base + 0x0a,	</span><span class="cm">/* byte - prefetched index value */</span><span class="cp"> \</span>
<span class="cp">	ICH_REG_##name##_CR	= base + 0x0b,	</span><span class="cm">/* byte - control register */</span><span class="cp"> \</span>
<span class="cp">};</span>

<span class="cm">/* busmaster blocks */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* offset */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">PI</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* PCM in */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">PO</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>	<span class="cm">/* PCM out */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">MC</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>	<span class="cm">/* Mic in */</span>

<span class="cm">/* ICH4 busmaster blocks */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">MC2</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* Mic in 2 */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">PI2</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>	<span class="cm">/* PCM in 2 */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">SP</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* SPDIF out */</span>

<span class="cm">/* values for each busmaster block */</span>

<span class="cm">/* LVI */</span>
<span class="cp">#define ICH_REG_LVI_MASK		0x1f</span>

<span class="cm">/* SR */</span>
<span class="cp">#define ICH_FIFOE			0x10	</span><span class="cm">/* FIFO error */</span><span class="cp"></span>
<span class="cp">#define ICH_BCIS			0x08	</span><span class="cm">/* buffer completion interrupt status */</span><span class="cp"></span>
<span class="cp">#define ICH_LVBCI			0x04	</span><span class="cm">/* last valid buffer completion interrupt */</span><span class="cp"></span>
<span class="cp">#define ICH_CELV			0x02	</span><span class="cm">/* current equals last valid */</span><span class="cp"></span>
<span class="cp">#define ICH_DCH				0x01	</span><span class="cm">/* DMA controller halted */</span><span class="cp"></span>

<span class="cm">/* PIV */</span>
<span class="cp">#define ICH_REG_PIV_MASK		0x1f	</span><span class="cm">/* mask */</span><span class="cp"></span>

<span class="cm">/* CR */</span>
<span class="cp">#define ICH_IOCE			0x10	</span><span class="cm">/* interrupt on completion enable */</span><span class="cp"></span>
<span class="cp">#define ICH_FEIE			0x08	</span><span class="cm">/* fifo error interrupt enable */</span><span class="cp"></span>
<span class="cp">#define ICH_LVBIE			0x04	</span><span class="cm">/* last valid buffer interrupt enable */</span><span class="cp"></span>
<span class="cp">#define ICH_RESETREGS			0x02	</span><span class="cm">/* reset busmaster registers */</span><span class="cp"></span>
<span class="cp">#define ICH_STARTBM			0x01	</span><span class="cm">/* start busmaster operation */</span><span class="cp"></span>


<span class="cm">/* global block */</span>
<span class="cp">#define ICH_REG_GLOB_CNT		0x2c	</span><span class="cm">/* dword - global control */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_SPDIF_MASK	0xc0000000	</span><span class="cm">/* s/pdif pcm slot mask (ICH4) */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_SPDIF_NONE	0x00000000	</span><span class="cm">/* reserved - undefined */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_SPDIF_78	0x40000000	</span><span class="cm">/* s/pdif pcm on slots 7&amp;8 */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_SPDIF_69	0x80000000	</span><span class="cm">/* s/pdif pcm on slots 6&amp;9 */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_SPDIF_1011	0xc0000000	</span><span class="cm">/* s/pdif pcm on slots 10&amp;11 */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_20BIT		0x00400000	</span><span class="cm">/* 20-bit samples (ICH4) */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_246_MASK	0x00300000	</span><span class="cm">/* chan mask (not all chips) */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_8		0x00300000      </span><span class="cm">/* 8 channels (not all chips) */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_6		0x00200000	</span><span class="cm">/* 6 channels (not all chips) */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_4		0x00100000	</span><span class="cm">/* 4 channels (not all chips) */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCM_2		0x00000000	</span><span class="cm">/* 2 channels (stereo) */</span><span class="cp"></span>
<span class="cp">#define   ICH_SIS_PCM_246_MASK	0x000000c0	</span><span class="cm">/* 6 channels (SIS7012) */</span><span class="cp"></span>
<span class="cp">#define   ICH_SIS_PCM_6		0x00000080	</span><span class="cm">/* 6 channels (SIS7012) */</span><span class="cp"></span>
<span class="cp">#define   ICH_SIS_PCM_4		0x00000040	</span><span class="cm">/* 4 channels (SIS7012) */</span><span class="cp"></span>
<span class="cp">#define   ICH_SIS_PCM_2		0x00000000	</span><span class="cm">/* 2 channels (SIS7012) */</span><span class="cp"></span>
<span class="cp">#define   ICH_TRIE		0x00000040	</span><span class="cm">/* tertiary resume interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_SRIE		0x00000020	</span><span class="cm">/* secondary resume interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_PRIE		0x00000010	</span><span class="cm">/* primary resume interrupt enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_ACLINK		0x00000008	</span><span class="cm">/* AClink shut off */</span><span class="cp"></span>
<span class="cp">#define   ICH_AC97WARM		0x00000004	</span><span class="cm">/* AC&#39;97 warm reset */</span><span class="cp"></span>
<span class="cp">#define   ICH_AC97COLD		0x00000002	</span><span class="cm">/* AC&#39;97 cold reset */</span><span class="cp"></span>
<span class="cp">#define   ICH_GIE		0x00000001	</span><span class="cm">/* GPI interrupt enable */</span><span class="cp"></span>
<span class="cp">#define ICH_REG_GLOB_STA		0x30	</span><span class="cm">/* dword - global status */</span><span class="cp"></span>
<span class="cp">#define   ICH_TRI		0x20000000	</span><span class="cm">/* ICH4: tertiary (AC_SDIN2) resume interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_TCR		0x10000000	</span><span class="cm">/* ICH4: tertiary (AC_SDIN2) codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_BCS		0x08000000	</span><span class="cm">/* ICH4: bit clock stopped */</span><span class="cp"></span>
<span class="cp">#define   ICH_SPINT		0x04000000	</span><span class="cm">/* ICH4: S/PDIF interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_P2INT		0x02000000	</span><span class="cm">/* ICH4: PCM2-In interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_M2INT		0x01000000	</span><span class="cm">/* ICH4: Mic2-In interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_SAMPLE_CAP	0x00c00000	</span><span class="cm">/* ICH4: sample capability bits (RO) */</span><span class="cp"></span>
<span class="cp">#define   ICH_SAMPLE_16_20	0x00400000	</span><span class="cm">/* ICH4: 16- and 20-bit samples */</span><span class="cp"></span>
<span class="cp">#define   ICH_MULTICHAN_CAP	0x00300000	</span><span class="cm">/* ICH4: multi-channel capability bits (RO) */</span><span class="cp"></span>
<span class="cp">#define   ICH_SIS_TRI		0x00080000	</span><span class="cm">/* SIS: tertiary resume irq */</span><span class="cp"></span>
<span class="cp">#define   ICH_SIS_TCR		0x00040000	</span><span class="cm">/* SIS: tertiary codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_MD3		0x00020000	</span><span class="cm">/* modem power down semaphore */</span><span class="cp"></span>
<span class="cp">#define   ICH_AD3		0x00010000	</span><span class="cm">/* audio power down semaphore */</span><span class="cp"></span>
<span class="cp">#define   ICH_RCS		0x00008000	</span><span class="cm">/* read completion status */</span><span class="cp"></span>
<span class="cp">#define   ICH_BIT3		0x00004000	</span><span class="cm">/* bit 3 slot 12 */</span><span class="cp"></span>
<span class="cp">#define   ICH_BIT2		0x00002000	</span><span class="cm">/* bit 2 slot 12 */</span><span class="cp"></span>
<span class="cp">#define   ICH_BIT1		0x00001000	</span><span class="cm">/* bit 1 slot 12 */</span><span class="cp"></span>
<span class="cp">#define   ICH_SRI		0x00000800	</span><span class="cm">/* secondary (AC_SDIN1) resume interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_PRI		0x00000400	</span><span class="cm">/* primary (AC_SDIN0) resume interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_SCR		0x00000200	</span><span class="cm">/* secondary (AC_SDIN1) codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_PCR		0x00000100	</span><span class="cm">/* primary (AC_SDIN0) codec ready */</span><span class="cp"></span>
<span class="cp">#define   ICH_MCINT		0x00000080	</span><span class="cm">/* MIC capture interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_POINT		0x00000040	</span><span class="cm">/* playback interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_PIINT		0x00000020	</span><span class="cm">/* capture interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_NVSPINT		0x00000010	</span><span class="cm">/* nforce spdif interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_MOINT		0x00000004	</span><span class="cm">/* modem playback interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_MIINT		0x00000002	</span><span class="cm">/* modem capture interrupt */</span><span class="cp"></span>
<span class="cp">#define   ICH_GSCI		0x00000001	</span><span class="cm">/* GPI status change interrupt */</span><span class="cp"></span>
<span class="cp">#define ICH_REG_ACC_SEMA		0x34	</span><span class="cm">/* byte - codec write semaphore */</span><span class="cp"></span>
<span class="cp">#define   ICH_CAS		0x01		</span><span class="cm">/* codec access semaphore */</span><span class="cp"></span>
<span class="cp">#define ICH_REG_SDM		0x80</span>
<span class="cp">#define   ICH_DI2L_MASK		0x000000c0	</span><span class="cm">/* PCM In 2, Mic In 2 data in line */</span><span class="cp"></span>
<span class="cp">#define   ICH_DI2L_SHIFT	6</span>
<span class="cp">#define   ICH_DI1L_MASK		0x00000030	</span><span class="cm">/* PCM In 1, Mic In 1 data in line */</span><span class="cp"></span>
<span class="cp">#define   ICH_DI1L_SHIFT	4</span>
<span class="cp">#define   ICH_SE		0x00000008	</span><span class="cm">/* steer enable */</span><span class="cp"></span>
<span class="cp">#define   ICH_LDI_MASK		0x00000003	</span><span class="cm">/* last codec read data input */</span><span class="cp"></span>

<span class="cp">#define ICH_MAX_FRAGS		32		</span><span class="cm">/* max hw frags */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * registers for Ali5455</span>
<span class="cm"> */</span>

<span class="cm">/* ALi 5455 busmaster blocks */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_PI</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>	<span class="cm">/* ALi PCM in */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_PO</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>	<span class="cm">/* Ali PCM out */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_MC</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>	<span class="cm">/* Ali Mic in */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_CDC_SPO</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>	<span class="cm">/* Ali Codec SPDIF out */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_CENTER</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>		<span class="cm">/* Ali center out */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_LFE</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>		<span class="cm">/* Ali center out */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_CLR_SPI</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>	<span class="cm">/* Ali Controller SPDIF in */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_CLR_SPO</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">);</span>	<span class="cm">/* Ali Controller SPDIF out */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_I2S</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>	<span class="cm">/* Ali I2S in */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_PI2</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>	<span class="cm">/* Ali PCM2 in */</span>
<span class="n">DEFINE_REGSET</span><span class="p">(</span><span class="n">AL_MC2</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>	<span class="cm">/* Ali Mic2 in */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ICH_REG_ALI_SCR</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* System Control Register */</span>
	<span class="n">ICH_REG_ALI_SSR</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>		<span class="cm">/* System Status Register  */</span>
	<span class="n">ICH_REG_ALI_DMACR</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* DMA Control Register    */</span>
	<span class="n">ICH_REG_ALI_FIFOCR1</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>	<span class="cm">/* FIFO Control Register 1  */</span>
	<span class="n">ICH_REG_ALI_INTERFACECR</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* Interface Control Register */</span>
	<span class="n">ICH_REG_ALI_INTERRUPTCR</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>	<span class="cm">/* Interrupt control Register */</span>
	<span class="n">ICH_REG_ALI_INTERRUPTSR</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="cm">/* Interrupt  Status Register */</span>
	<span class="n">ICH_REG_ALI_FIFOCR2</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>	<span class="cm">/* FIFO Control Register 2   */</span>
	<span class="n">ICH_REG_ALI_CPR</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>		<span class="cm">/* Command Port Register     */</span>
	<span class="n">ICH_REG_ALI_CPR_ADDR</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">,</span>	<span class="cm">/* ac97 addr write */</span>
	<span class="n">ICH_REG_ALI_SPR</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>		<span class="cm">/* Status Port Register      */</span>
	<span class="n">ICH_REG_ALI_SPR_ADDR</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">,</span>	<span class="cm">/* ac97 addr read */</span>
	<span class="n">ICH_REG_ALI_FIFOCR3</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>	<span class="cm">/* FIFO Control Register 3  */</span>
	<span class="n">ICH_REG_ALI_TTSR</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* Transmit Tag Slot Register */</span>
	<span class="n">ICH_REG_ALI_RTSR</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="cm">/* Receive Tag Slot  Register */</span>
	<span class="n">ICH_REG_ALI_CSPSR</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>	<span class="cm">/* Command/Status Port Status Register */</span>
	<span class="n">ICH_REG_ALI_CAS</span> <span class="o">=</span> <span class="mh">0x3c</span><span class="p">,</span>		<span class="cm">/* Codec Write Semaphore Register */</span>
	<span class="n">ICH_REG_ALI_HWVOL</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">,</span>	<span class="cm">/* hardware volume control/status */</span>
	<span class="n">ICH_REG_ALI_I2SCR</span> <span class="o">=</span> <span class="mh">0xf4</span><span class="p">,</span>	<span class="cm">/* I2S control/status */</span>
	<span class="n">ICH_REG_ALI_SPDIFCSR</span> <span class="o">=</span> <span class="mh">0xf8</span><span class="p">,</span>	<span class="cm">/* spdif channel status register  */</span>
	<span class="n">ICH_REG_ALI_SPDIFICS</span> <span class="o">=</span> <span class="mh">0xfc</span><span class="p">,</span>	<span class="cm">/* spdif interface control/status  */</span>
<span class="p">};</span>

<span class="cp">#define ALI_CAS_SEM_BUSY	0x80000000</span>
<span class="cp">#define ALI_CPR_ADDR_SECONDARY	0x100</span>
<span class="cp">#define ALI_CPR_ADDR_READ	0x80</span>
<span class="cp">#define ALI_CSPSR_CODEC_READY	0x08</span>
<span class="cp">#define ALI_CSPSR_READ_OK	0x02</span>
<span class="cp">#define ALI_CSPSR_WRITE_OK	0x01</span>

<span class="cm">/* interrupts for the whole chip by interrupt status register finish */</span>
 
<span class="cp">#define ALI_INT_MICIN2		(1&lt;&lt;26)</span>
<span class="cp">#define ALI_INT_PCMIN2		(1&lt;&lt;25)</span>
<span class="cp">#define ALI_INT_I2SIN		(1&lt;&lt;24)</span>
<span class="cp">#define ALI_INT_SPDIFOUT	(1&lt;&lt;23)	</span><span class="cm">/* controller spdif out INTERRUPT */</span><span class="cp"></span>
<span class="cp">#define ALI_INT_SPDIFIN		(1&lt;&lt;22)</span>
<span class="cp">#define ALI_INT_LFEOUT		(1&lt;&lt;21)</span>
<span class="cp">#define ALI_INT_CENTEROUT	(1&lt;&lt;20)</span>
<span class="cp">#define ALI_INT_CODECSPDIFOUT	(1&lt;&lt;19)</span>
<span class="cp">#define ALI_INT_MICIN		(1&lt;&lt;18)</span>
<span class="cp">#define ALI_INT_PCMOUT		(1&lt;&lt;17)</span>
<span class="cp">#define ALI_INT_PCMIN		(1&lt;&lt;16)</span>
<span class="cp">#define ALI_INT_CPRAIS		(1&lt;&lt;7)	</span><span class="cm">/* command port available */</span><span class="cp"></span>
<span class="cp">#define ALI_INT_SPRAIS		(1&lt;&lt;5)	</span><span class="cm">/* status port available */</span><span class="cp"></span>
<span class="cp">#define ALI_INT_GPIO		(1&lt;&lt;1)</span>
<span class="cp">#define ALI_INT_MASK		(ALI_INT_SPDIFOUT|ALI_INT_CODECSPDIFOUT|\</span>
<span class="cp">				 ALI_INT_MICIN|ALI_INT_PCMOUT|ALI_INT_PCMIN)</span>

<span class="cp">#define ICH_ALI_SC_RESET	(1&lt;&lt;31)	</span><span class="cm">/* master reset */</span><span class="cp"></span>
<span class="cp">#define ICH_ALI_SC_AC97_DBL	(1&lt;&lt;30)</span>
<span class="cp">#define ICH_ALI_SC_CODEC_SPDF	(3&lt;&lt;20)	</span><span class="cm">/* 1=7/8, 2=6/9, 3=10/11 */</span><span class="cp"></span>
<span class="cp">#define ICH_ALI_SC_IN_BITS	(3&lt;&lt;18)</span>
<span class="cp">#define ICH_ALI_SC_OUT_BITS	(3&lt;&lt;16)</span>
<span class="cp">#define ICH_ALI_SC_6CH_CFG	(3&lt;&lt;14)</span>
<span class="cp">#define ICH_ALI_SC_PCM_4	(1&lt;&lt;8)</span>
<span class="cp">#define ICH_ALI_SC_PCM_6	(2&lt;&lt;8)</span>
<span class="cp">#define ICH_ALI_SC_PCM_246_MASK	(3&lt;&lt;8)</span>

<span class="cp">#define ICH_ALI_SS_SEC_ID	(3&lt;&lt;5)</span>
<span class="cp">#define ICH_ALI_SS_PRI_ID	(3&lt;&lt;3)</span>

<span class="cp">#define ICH_ALI_IF_AC97SP	(1&lt;&lt;21)</span>
<span class="cp">#define ICH_ALI_IF_MC		(1&lt;&lt;20)</span>
<span class="cp">#define ICH_ALI_IF_PI		(1&lt;&lt;19)</span>
<span class="cp">#define ICH_ALI_IF_MC2		(1&lt;&lt;18)</span>
<span class="cp">#define ICH_ALI_IF_PI2		(1&lt;&lt;17)</span>
<span class="cp">#define ICH_ALI_IF_LINE_SRC	(1&lt;&lt;15)	</span><span class="cm">/* 0/1 = slot 3/6 */</span><span class="cp"></span>
<span class="cp">#define ICH_ALI_IF_MIC_SRC	(1&lt;&lt;14)	</span><span class="cm">/* 0/1 = slot 3/6 */</span><span class="cp"></span>
<span class="cp">#define ICH_ALI_IF_SPDF_SRC	(3&lt;&lt;12)	</span><span class="cm">/* 00 = PCM, 01 = AC97-in, 10 = spdif-in, 11 = i2s */</span><span class="cp"></span>
<span class="cp">#define ICH_ALI_IF_AC97_OUT	(3&lt;&lt;8)	</span><span class="cm">/* 00 = PCM, 10 = spdif-in, 11 = i2s */</span><span class="cp"></span>
<span class="cp">#define ICH_ALI_IF_PO_SPDF	(1&lt;&lt;3)</span>
<span class="cp">#define ICH_ALI_IF_PO		(1&lt;&lt;1)</span>

<span class="cm">/*</span>
<span class="cm"> *  </span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ICHD_PCMIN</span><span class="p">,</span>
	<span class="n">ICHD_PCMOUT</span><span class="p">,</span>
	<span class="n">ICHD_MIC</span><span class="p">,</span>
	<span class="n">ICHD_MIC2</span><span class="p">,</span>
	<span class="n">ICHD_PCM2IN</span><span class="p">,</span>
	<span class="n">ICHD_SPBAR</span><span class="p">,</span>
	<span class="n">ICHD_LAST</span> <span class="o">=</span> <span class="n">ICHD_SPBAR</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">NVD_PCMIN</span><span class="p">,</span>
	<span class="n">NVD_PCMOUT</span><span class="p">,</span>
	<span class="n">NVD_MIC</span><span class="p">,</span>
	<span class="n">NVD_SPBAR</span><span class="p">,</span>
	<span class="n">NVD_LAST</span> <span class="o">=</span> <span class="n">NVD_SPBAR</span>
<span class="p">};</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">ALID_PCMIN</span><span class="p">,</span>
	<span class="n">ALID_PCMOUT</span><span class="p">,</span>
	<span class="n">ALID_MIC</span><span class="p">,</span>
	<span class="n">ALID_AC97SPDIFOUT</span><span class="p">,</span>
	<span class="n">ALID_SPDIFIN</span><span class="p">,</span>
	<span class="n">ALID_SPDIFOUT</span><span class="p">,</span>
	<span class="n">ALID_LAST</span> <span class="o">=</span> <span class="n">ALID_SPDIFOUT</span>
<span class="p">};</span>

<span class="cp">#define get_ichdev(substream) (substream-&gt;runtime-&gt;private_data)</span>

<span class="k">struct</span> <span class="n">ichdev</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ichd</span><span class="p">;</span>			<span class="cm">/* ich device number */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reg_offset</span><span class="p">;</span>		<span class="cm">/* offset to bmaddr */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">bdbar</span><span class="p">;</span>				<span class="cm">/* CPU address (32bit) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bdbar_addr</span><span class="p">;</span>		<span class="cm">/* PCI bus address (32bit) */</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">physbuf</span><span class="p">;</span>			<span class="cm">/* physical address (32bit) */</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fragsize1</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">position</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos_shift</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_pos</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">frags</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">lvi</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">lvi_frag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">civ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack_reload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ack_bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">roff_sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">roff_picb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_sta_mask</span><span class="p">;</span>		<span class="cm">/* interrupt status mask */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ali_slot</span><span class="p">;</span>			<span class="cm">/* ALI DMA slot */</span>
	<span class="k">struct</span> <span class="n">ac97_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pcm_open_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_attr_changed</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">suspended</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">intel8x0</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_type</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bmaddr</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">pcm_devs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="n">ichd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="kt">unsigned</span> <span class="n">multi4</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		 <span class="nl">multi6:</span> <span class="mi">1</span><span class="p">,</span>
		 <span class="n">multi8</span> <span class="o">:</span><span class="mi">1</span><span class="p">,</span>
		 <span class="nl">dra:</span> <span class="mi">1</span><span class="p">,</span>
		 <span class="nl">smp20bit:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">in_ac97_init</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
		 <span class="nl">in_sdin_init:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">in_measurement</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* during ac97 clock measurement */</span>
	<span class="kt">unsigned</span> <span class="n">fix_nocache</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span> 	<span class="cm">/* workaround for 440MX */</span>
	<span class="kt">unsigned</span> <span class="n">buggy_irq</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* workaround for buggy mobos */</span>
	<span class="kt">unsigned</span> <span class="n">xbox</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* workaround for Xbox AC&#39;97 detection */</span>
	<span class="kt">unsigned</span> <span class="n">buggy_semaphore</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* workaround for buggy codec semaphore */</span>
	<span class="kt">unsigned</span> <span class="n">inside_vm</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* enable VM optimization */</span>

	<span class="kt">int</span> <span class="n">spdif_idx</span><span class="p">;</span>	<span class="cm">/* SPDIF BAR index; *_SPBAR or -1 if use PCMOUT */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sdm_saved</span><span class="p">;</span>	<span class="cm">/* SDM reg value */</span>

	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ac97_sdin</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_codecs</span><span class="p">,</span> <span class="n">ncodecs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">codec_bit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec_isr_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec_ready_bits</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">reg_lock</span><span class="p">;</span>
	
	<span class="n">u32</span> <span class="n">bdbars_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">bdbars</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_sta_reg</span><span class="p">;</span>		<span class="cm">/* interrupt status register */</span>
	<span class="n">u32</span> <span class="n">int_sta_mask</span><span class="p">;</span>		<span class="cm">/* interrupt status mask */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_intel8x0_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2415</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 82801AA */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2425</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 82901AB */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2445</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 82801BA */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2485</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* ICH3 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x24c5</span><span class="p">),</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="p">},</span> <span class="cm">/* ICH4 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x24d5</span><span class="p">),</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="p">},</span> <span class="cm">/* ICH5 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x25a6</span><span class="p">),</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="p">},</span> <span class="cm">/* ESB */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x266e</span><span class="p">),</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="p">},</span> <span class="cm">/* ICH6 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x27de</span><span class="p">),</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="p">},</span> <span class="cm">/* ICH7 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x2698</span><span class="p">),</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="p">},</span> <span class="cm">/* ESB2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="mh">0x7195</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* 440MX */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">SI</span><span class="p">,</span> <span class="mh">0x7012</span><span class="p">),</span> <span class="n">DEVICE_SIS</span> <span class="p">},</span>	<span class="cm">/* SI7012 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x01b1</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* NFORCE */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x003a</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* MCP04 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x006a</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* NFORCE2 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* CK804 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x008a</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* CK8 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x00da</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* NFORCE3 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x00ea</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* CK8S */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">NVIDIA</span><span class="p">,</span> <span class="mh">0x026b</span><span class="p">),</span> <span class="n">DEVICE_NFORCE</span> <span class="p">},</span>	<span class="cm">/* MCP51 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span> <span class="mh">0x746d</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* AMD8111 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AMD</span><span class="p">,</span> <span class="mh">0x7445</span><span class="p">),</span> <span class="n">DEVICE_INTEL</span> <span class="p">},</span>	<span class="cm">/* AMD768 */</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">AL</span><span class="p">,</span> <span class="mh">0x5455</span><span class="p">),</span> <span class="n">DEVICE_ALI</span> <span class="p">},</span>   <span class="cm">/* Ali5455 */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_intel8x0_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Lowlevel I/O - busmaster</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">igetbyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">igetword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">igetdword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iputbyte</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite8</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iputword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iputdword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Lowlevel I/O - AC&#39;97 registers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">iagetword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ioread16</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">iaputword</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite16</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Basic I/O</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * access to AC97 codec via normal i/o (for ICH and SIS7012)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_codec_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">codec</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_sdin_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we don&#39;t know the ready bit assignment at the moment */</span>
		<span class="cm">/* so we check any */</span>
		<span class="n">codec</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">codec</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">codec</span><span class="p">]];</span>
	<span class="p">}</span>

	<span class="cm">/* codec ready ? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">codec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buggy_semaphore</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just ignore ... */</span>

	<span class="cm">/* Anyone holding a semaphore for 1 msec should be shot... */</span>
	<span class="n">time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
      	<span class="k">do</span> <span class="p">{</span>
      		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ACC_SEMA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICH_CAS</span><span class="p">))</span>
      			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time</span><span class="o">--</span><span class="p">);</span>

	<span class="cm">/* access to some forbidden (non existent) ac97 registers will not</span>
<span class="cm">	 * reset the semaphore. So even if you don&#39;t get the semaphore, still</span>
<span class="cm">	 * continue the access. We don&#39;t need the semaphore anyway. */</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_semaphore: semaphore is not ready [0x%x][0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ACC_SEMA</span><span class="p">)),</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)));</span>
	<span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear semaphore flag */</span>
	<span class="cm">/* I don&#39;t care about the semaphore */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_write %d: semaphore is not ready for register 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iaputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_intel8x0_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_read %d: semaphore is not ready for register 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">ICH_RCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset RCS and preserve other R/WC bits */</span>
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">),</span> <span class="n">tmp</span> <span class="o">&amp;</span>
				  <span class="o">~</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_ready_bits</span> <span class="o">|</span> <span class="n">ICH_GSCI</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_read %d: read timeout for register 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_codec_read_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">codec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codec</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codec</span> <span class="o">*</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">ICH_RCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset RCS and preserve other R/WC bits */</span>
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">),</span> <span class="n">tmp</span> <span class="o">&amp;</span>
				  <span class="o">~</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_ready_bits</span> <span class="o">|</span> <span class="n">ICH_GSCI</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * access to AC97 for Ali5455</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ali_codec_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mh">0x7f</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_CSPSR</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
		<span class="n">snd_printd</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;intel8x0: AC97 codec ready timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ali_codec_semaphore</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">buggy_semaphore</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* just ignore ... */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">time</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_CAS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ALI_CAS_SEM_BUSY</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">time</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span><span class="p">)</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;ali_codec_semaphore timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_intel8x0_ali_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_CSPSR_CODEC_READY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_intel8x0_ali_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_ali_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">ALI_CPR_ADDR_READ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ALI_CPR_ADDR_SECONDARY</span><span class="p">;</span>
	<span class="n">iputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_CPR_ADDR</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_ali_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_CSPSR_READ_OK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_SPR</span><span class="p">));</span>
 <span class="nl">__err:</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_ali_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_ali_codec_semaphore</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">iputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_CPR</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ALI_CPR_ADDR_SECONDARY</span><span class="p">;</span>
	<span class="n">iputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_CPR_ADDR</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">snd_intel8x0_ali_codec_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALI_CSPSR_WRITE_OK</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * DMA I/O</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_setup_periods</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">bdbar</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>

	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_BDBAR</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack_reload</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ICH_REG_LVI_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span><span class="p">);</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="cm">/* interrupt on completion */</span>
						     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">&gt;&gt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span><span class="p">);</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">+</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="cm">/* interrupt on completion */</span>
						     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">&gt;&gt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack_reload</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ICH_REG_LVI_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span> <span class="n">idx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">+</span>
						     <span class="p">(((</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">)</span> <span class="o">%</span>
						      <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
			<span class="n">bdbar</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x80000000</span> <span class="o">|</span> <span class="cm">/* interrupt on completion */</span>
						     <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">&gt;&gt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			printk(KERN_DEBUG &quot;bdbar[%i] = 0x%x [0x%x]\n&quot;,</span>
<span class="c">			       idx + 0, bdbar[idx + 0], bdbar[idx + 1]);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_LVI</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">=</span> <span class="n">ICH_REG_LVI_MASK</span><span class="p">);</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span> <span class="o">=</span> <span class="n">ICH_REG_LVI_MASK</span> <span class="o">%</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;lvi_frag = %i, frags = %i, period_size = 0x%x, &quot;</span>
<span class="c">	       &quot;period_size1 = 0x%x\n&quot;,</span>
<span class="c">	       ichdev-&gt;lvi_frag, ichdev-&gt;frags, ichdev-&gt;fragsize,</span>
<span class="c">	       ichdev-&gt;fragsize1);</span>
<span class="cp">#endif</span>
	<span class="cm">/* clear interrupts */</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">,</span> <span class="n">ICH_FIFOE</span> <span class="o">|</span> <span class="n">ICH_BCIS</span> <span class="o">|</span> <span class="n">ICH_LVBCI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef __i386__</span>
<span class="cm">/*</span>
<span class="cm"> * Intel 82443MX running a 100MHz processor system bus has a hardware bug,</span>
<span class="cm"> * which aborts PCI busmaster for audio transfer.  A workaround is to set</span>
<span class="cm"> * the pages as non-cached.  For details, see the errata in</span>
<span class="cm"> *	http://download.intel.com/design/chipsets/specupdt/24505108.pdf</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_nocache</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nocache</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nocache</span><span class="p">)</span>
		<span class="n">set_pages_uc</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_pages_wb</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define fill_nocache(buf, size, nocache) do { ; } while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *  Interrupt handler</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">civ</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">);</span>
	<span class="n">civ</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ICH_BCIS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">civ</span> <span class="o">==</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>snd_printd("civ same %d\n", civ);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span> <span class="o">&amp;=</span> <span class="n">ICH_REG_LVI_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">civ</span> <span class="o">-</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">step</span> <span class="o">+=</span> <span class="n">ICH_REG_LVI_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>if (step != 1)
snd_printd("step = %d, %d -> %d\n", step, ichdev->civ, civ);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span> <span class="o">=</span> <span class="n">civ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">+=</span> <span class="n">step</span> <span class="o">*</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_measurement</span><span class="p">)</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">%=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">+=</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">&amp;=</span> <span class="n">ICH_REG_LVI_MASK</span><span class="p">;</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_LVI</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">step</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span> <span class="o">%=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar</span><span class="p">[</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi_frag</span> <span class="o">*</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(KERN_DEBUG &quot;new: bdbar[%i] = 0x%x [0x%x], prefetch = %i, &quot;</span>
<span class="c">	       &quot;all = 0x%x, 0x%x\n&quot;,</span>
<span class="c">	       ichdev-&gt;lvi * 2, ichdev-&gt;bdbar[ichdev-&gt;lvi * 2],</span>
<span class="c">	       ichdev-&gt;bdbar[ichdev-&gt;lvi * 2 + 1], inb(ICH_REG_OFF_PIV + port),</span>
<span class="c">	       inl(port + 4), inb(port + ICH_REG_OFF_CR));</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ack_reload</span><span class="p">;</span>
			<span class="n">ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">&amp;&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">,</span>
		 <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ICH_FIFOE</span> <span class="o">|</span> <span class="n">ICH_BCIS</span> <span class="o">|</span> <span class="n">ICH_LVBCI</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_intel8x0_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>	<span class="cm">/* we are not yet resumed */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ack */</span>
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">buggy_irq</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">)</span>
			<span class="n">snd_intel8x0_update</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ack them */</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  PCM part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ICH_IOCE</span> <span class="o">|</span> <span class="n">ICH_STARTBM</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ICH_IOCE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait until DMA stopped */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ICH_DCH</span><span class="p">))</span> <span class="p">;</span>
		<span class="cm">/* reset whole DMA things */</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ali_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">fiforeg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_FIFOCR1</span><span class="p">),</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_FIFOCR2</span><span class="p">),</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_FIFOCR3</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">fifo</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_DMACR</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* clear FIFO for synchronization of channels */</span>
			<span class="n">fifo</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">fiforeg</span><span class="p">[</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]);</span>
			<span class="n">fifo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">%</span> <span class="mi">4</span><span class="p">));</span>  
			<span class="n">fifo</span> <span class="o">|=</span> <span class="mh">0x83</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span> 
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">fiforeg</span><span class="p">[</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">/</span> <span class="mi">4</span><span class="p">],</span> <span class="n">fifo</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_IOCE</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">+</span> <span class="mi">16</span><span class="p">));</span> <span class="cm">/* clear PAUSE flag */</span>
		<span class="cm">/* start DMA */</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_DMACR</span><span class="p">),</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fallthru */</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="cm">/* pause */</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_DMACR</span><span class="p">),</span> <span class="n">val</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)));</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">))</span>
			<span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* reset whole DMA things */</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
		<span class="cm">/* clear interrupts */</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_SR</span><span class="p">,</span>
			 <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_SR</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1e</span><span class="p">);</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERRUPTSR</span><span class="p">),</span>
			  <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERRUPTSR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dbl</span> <span class="o">=</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span> <span class="o">&amp;&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fill_nocache</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* clear */</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fill_nocache</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm_open_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_pcm_close</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm_open_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_pcm_open</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
				<span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
				<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">[</span><span class="n">dbl</span><span class="p">].</span><span class="n">slots</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm_open_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Force SPDIF setting */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ichd</span> <span class="o">==</span> <span class="n">ICHD_PCMOUT</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">codec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AC97_SPDIF</span><span class="p">,</span>
					  <span class="n">params_rate</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm_open_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_pcm_close</span><span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm_open_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span> <span class="o">&amp;&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fill_nocache</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_setup_pcm_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dbl</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_ALI</span>:
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_SCR</span><span class="p">));</span>
		<span class="n">cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICH_ALI_SC_PCM_246_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">dbl</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_ALI_SC_PCM_4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_ALI_SC_PCM_6</span><span class="p">;</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_SCR</span><span class="p">),</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_SIS</span>:
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">));</span>
		<span class="n">cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICH_SIS_PCM_246_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">dbl</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_SIS_PCM_4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_SIS_PCM_6</span><span class="p">;</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">));</span>
		<span class="n">cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICH_PCM_246_MASK</span> <span class="o">|</span> <span class="n">ICH_PCM_20BIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">dbl</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_PCM_4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_PCM_6</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_PCM_8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reset to 2ch once to keep the 6 channel data in alignment,</span>
<span class="cm">			 * to start from Front Left always</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="n">ICH_PCM_246_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICH_PCM_246_MASK</span><span class="p">);</span>
				<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span> <span class="cm">/* grrr... */</span>
				<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sample_bits</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
				<span class="n">cnt</span> <span class="o">|=</span> <span class="n">ICH_PCM_20BIT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">snd_pcm_lib_buffer_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ichd</span> <span class="o">==</span> <span class="n">ICHD_PCMOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0_setup_pcm_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">runtime</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">sample_bits</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_intel8x0_setup_periods</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_intel8x0_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="n">get_ichdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">civ</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">position</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">civ</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">);</span>
		<span class="n">ptr1</span> <span class="o">=</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span><span class="p">);</span>
		<span class="n">position</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">civ</span> <span class="o">!=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* IO read operation is very expensive inside virtual machine</span>
<span class="cm">		 * as it is emulated. The probability that subsequent PICB read</span>
<span class="cm">		 * will return different result is high enough to loop till</span>
<span class="cm">		 * timeout here.</span>
<span class="cm">		 * Same CIV is strict enough condition to be sure that PICB</span>
<span class="cm">		 * is valid inside VM on emulated card. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">inside_vm</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr1</span> <span class="o">==</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ptr1</span> <span class="o">&lt;&lt;=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span> <span class="o">-</span> <span class="n">ptr1</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">position</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos_base</span><span class="p">,</span> <span class="n">last_base</span><span class="p">;</span>
			<span class="n">pos_base</span> <span class="o">=</span> <span class="n">position</span> <span class="o">/</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">;</span>
			<span class="n">last_base</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">/</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">;</span>
			<span class="cm">/* another sanity check; ptr1 can go back to full</span>
<span class="cm">			 * before the base position is updated</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos_base</span> <span class="o">==</span> <span class="n">last_base</span><span class="p">)</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">last_pos</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">last_pos</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_intel8x0_stream</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_RESUME</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels4</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_channels4</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channels4</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">channels4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels6</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_channels6</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channels6</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">channels6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels8</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_channels8</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channels8</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">channels8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_intel8x0_stream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">snd_pcm_limit_hw_rates</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">ichdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMOUT</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">hw_constraints_channels8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">hw_constraints_channels6</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">hw_constraints_channels4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_ac97_pcm_double_rate_rules</span><span class="p">(</span><span class="n">runtime</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">smp20bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">formats</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMOUT</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMIN</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMIN</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_mic_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MIC</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_mic_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MIC</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_mic2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MIC2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_mic2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MIC2</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_capture2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCM2IN</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_capture2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCM2IN</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_spdif_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span> <span class="o">?</span> <span class="n">NVD_SPBAR</span> <span class="o">:</span> <span class="n">ICHD_SPBAR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_spdif_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span> <span class="o">?</span> <span class="n">NVD_SPBAR</span> <span class="o">:</span> <span class="n">ICHD_SPBAR</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ali_ac97spdifout_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERFACECR</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ICH_ALI_IF_AC97SP</span><span class="p">;</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERFACECR</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="cm">/* also needs to set ALI_SC_CODEC_SPDF correctly */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_intel8x0_pcm_open</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ALID_AC97SPDIFOUT</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ali_ac97spdifout_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ALID_AC97SPDIFOUT</span><span class="p">].</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERFACECR</span><span class="p">));</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICH_ALI_IF_AC97SP</span><span class="p">;</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERFACECR</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> // NYI</span>
<span class="c">static int snd_intel8x0_ali_spdifin_open(struct snd_pcm_substream *substream)</span>
<span class="c">{</span>
<span class="c">	struct intel8x0 *chip = snd_pcm_substream_chip(substream);</span>

<span class="c">	return snd_intel8x0_pcm_open(substream, &amp;chip-&gt;ichd[ALID_SPDIFIN]);</span>
<span class="c">}</span>

<span class="c">static int snd_intel8x0_ali_spdifin_close(struct snd_pcm_substream *substream)</span>
<span class="c">{</span>
<span class="c">	struct intel8x0 *chip = snd_pcm_substream_chip(substream);</span>

<span class="c">	chip-&gt;ichd[ALID_SPDIFIN].substream = NULL;</span>
<span class="c">	return 0;</span>
<span class="c">}</span>

<span class="c">static int snd_intel8x0_ali_spdifout_open(struct snd_pcm_substream *substream)</span>
<span class="c">{</span>
<span class="c">	struct intel8x0 *chip = snd_pcm_substream_chip(substream);</span>

<span class="c">	return snd_intel8x0_pcm_open(substream, &amp;chip-&gt;ichd[ALID_SPDIFOUT]);</span>
<span class="c">}</span>

<span class="c">static int snd_intel8x0_ali_spdifout_close(struct snd_pcm_substream *substream)</span>
<span class="c">{</span>
<span class="c">	struct intel8x0 *chip = snd_pcm_substream_chip(substream);</span>

<span class="c">	chip-&gt;ichd[ALID_SPDIFOUT].substream = NULL;</span>
<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_capture_mic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_mic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_mic_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_capture_mic2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_mic2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_mic2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_capture2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_capture2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_capture2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_spdif_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_spdif_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_spdif_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_ali_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_ali_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_ali_capture_mic_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_mic_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_mic_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_intel8x0_ali_ac97spdifout_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_intel8x0_ali_ac97spdifout_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_intel8x0_ali_ac97spdifout_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_intel8x0_ali_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_intel8x0_pcm_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"> // NYI</span>
<span class="c">static struct snd_pcm_ops snd_intel8x0_ali_spdifin_ops = {</span>
<span class="c">	.open =		snd_intel8x0_ali_spdifin_open,</span>
<span class="c">	.close =	snd_intel8x0_ali_spdifin_close,</span>
<span class="c">	.ioctl =	snd_pcm_lib_ioctl,</span>
<span class="c">	.hw_params =	snd_intel8x0_hw_params,</span>
<span class="c">	.hw_free =	snd_intel8x0_hw_free,</span>
<span class="c">	.prepare =	snd_intel8x0_pcm_prepare,</span>
<span class="c">	.trigger =	snd_intel8x0_pcm_trigger,</span>
<span class="c">	.pointer =	snd_intel8x0_pcm_pointer,</span>
<span class="c">};</span>

<span class="c">static struct snd_pcm_ops snd_intel8x0_ali_spdifout_ops = {</span>
<span class="c">	.open =		snd_intel8x0_ali_spdifout_open,</span>
<span class="c">	.close =	snd_intel8x0_ali_spdifout_close,</span>
<span class="c">	.ioctl =	snd_pcm_lib_ioctl,</span>
<span class="c">	.hw_params =	snd_intel8x0_hw_params,</span>
<span class="c">	.hw_free =	snd_intel8x0_hw_free,</span>
<span class="c">	.prepare =	snd_intel8x0_pcm_prepare,</span>
<span class="c">	.trigger =	snd_intel8x0_pcm_trigger,</span>
<span class="c">	.pointer =	snd_intel8x0_pcm_pointer,</span>
<span class="c">};</span>
<span class="cp">#endif // NYI</span>

<span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">suffix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">playback_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="o">*</span><span class="n">capture_ops</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">prealloc_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">prealloc_max_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ac97_idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_pcm1</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Intel ICH - %s&quot;</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Intel ICH&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span>
			  <span class="n">rec</span><span class="o">-&gt;</span><span class="n">playback_ops</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="n">rec</span><span class="o">-&gt;</span><span class="n">capture_ops</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">playback_ops</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">playback_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">capture_ops</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">)</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s - %s&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>

	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="n">rec</span><span class="o">-&gt;</span><span class="n">prealloc_size</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">prealloc_max_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="n">intel_pcms</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_playback_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_capture_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;MIC ADC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_capture_mic_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">ICHD_MIC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;MIC2 ADC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_capture_mic2_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">ICHD_MIC2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;ADC2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_capture2_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">ICHD_PCM2IN</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_spdif_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">ICHD_SPBAR</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="n">nforce_pcms</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_playback_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_capture_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;MIC ADC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_capture_mic_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">NVD_MIC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_spdif_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">NVD_SPBAR</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="n">ali_pcms</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_ali_playback_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_ali_capture_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;MIC ADC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">capture_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_ali_capture_mic_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">ALID_MIC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">playback_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">snd_intel8x0_ali_ac97spdifout_ops</span><span class="p">,</span>
		<span class="cm">/* .capture_ops = &amp;snd_intel8x0_ali_spdifin_ops, */</span>
		<span class="p">.</span><span class="n">prealloc_size</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">prealloc_max_size</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ac97_idx</span> <span class="o">=</span> <span class="n">ALID_AC97SPDIFOUT</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#if 0</span><span class="c"> // NYI</span>
<span class="c">	{</span>
<span class="c">		.suffix = &quot;HW IEC958&quot;,</span>
<span class="c">		.playback_ops = &amp;snd_intel8x0_ali_spdifout_ops,</span>
<span class="c">		.prealloc_size = 64 * 1024,</span>
<span class="c">		.prealloc_max_size = 128 * 1024,</span>
<span class="c">	},</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tblsize</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ich_pcm_table</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_INTEL_ICH4</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">intel_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intel_pcms</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spdif_aclink</span><span class="p">)</span>
			<span class="n">tblsize</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_NFORCE</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">nforce_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nforce_pcms</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spdif_aclink</span><span class="p">)</span>
			<span class="n">tblsize</span><span class="o">--</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_ALI</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">ali_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ali_pcms</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">intel_pcms</span><span class="p">;</span>
		<span class="n">tblsize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tblsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rec</span> <span class="o">=</span> <span class="n">tbl</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">ac97_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* activate PCM only when associated AC&#39;97 codec */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">ac97_idx</span><span class="p">].</span><span class="n">pcm</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_pcm1</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">device</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_devs</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
	

<span class="cm">/*</span>
<span class="cm"> *  Mixer part</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_mixer_free_ac97_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_mixer_free_ac97</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">ac97</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ac97_pcm</span> <span class="n">ac97_pcm_defs</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* front PCM */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">{</span>	<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_LEFT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_RIGHT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_CENTER</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_SLEFT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_SRIGHT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_LFE</span><span class="p">)</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_LEFT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_RIGHT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_LEFT_0</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_RIGHT_0</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* PCM IN #1 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">{</span>	<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_LEFT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_RIGHT</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* MIC IN #1 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">{</span>	<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_MIC</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* S/PDIF PCM */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">spdif</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">{</span>	<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_SPDIF_LEFT2</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_SPDIF_RIGHT2</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* PCM IN #2 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">{</span>	<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_LEFT</span><span class="p">)</span> <span class="o">|</span>
					 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_RIGHT</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* MIC IN #2 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">stream</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="p">{</span>	<span class="p">{</span>
				<span class="p">.</span><span class="n">slots</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_MIC</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ac97_quirk</span> <span class="n">ac97_quirks</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x0e11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x000e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Compaq Deskpro EN&quot;</span><span class="p">,</span>	<span class="cm">/* AD1885 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
        <span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x0e11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x008a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Compaq Evo W4000&quot;</span><span class="p">,</span>	<span class="cm">/* AD1885 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x0e11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x00b8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Compaq Evo D510C&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
        <span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x0e11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0860</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP/Compaq nx7010&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_MUTE_LED</span>
        <span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1014</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0534</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ThinkPad X31&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1014</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x1f00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MS-9128&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_ALC_JACK</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1014</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0267</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;IBM NetVista A30p&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981B */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1025</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0082</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Acer Travelmate 2310&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1025</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0083</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 3003LCi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x00d8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Precision 530&quot;</span><span class="p">,</span>	<span class="cm">/* AD1885 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x010d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell&quot;</span><span class="p">,</span>	<span class="cm">/* which model?  AD1885 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0126</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Optiplex GX260&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981A */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x012c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Precision 650&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981A */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x012d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Precision 450&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981B*/</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0147</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell&quot;</span><span class="p">,</span>	<span class="cm">/* which model?  AD1981B*/</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0151</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Optiplex GX270&quot;</span><span class="p">,</span>  <span class="cm">/* AD1981B */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x014e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell D800&quot;</span><span class="p">,</span> <span class="cm">/* STAC9750/51 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0163</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Unknown&quot;</span><span class="p">,</span>	<span class="cm">/* STAC9750/51 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x016a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 8600&quot;</span><span class="p">,</span>	<span class="cm">/* STAC9750/51 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0182</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude D610&quot;</span><span class="p">,</span>	<span class="cm">/* STAC9750/51 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0186</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Latitude D810&quot;</span><span class="p">,</span> <span class="cm">/* cf. Malone #41015 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0188</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 6000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span> <span class="cm">/* cf. Malone #41015 */</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0189</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 9300&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1028</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0191</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 8600&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x006d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP zv5000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_MUTE_LED</span>	<span class="cm">/*AD1981B*/</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* FIXME: which codec? */</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x00c3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP xw6000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x088c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP nc8000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0890</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP nc6000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x129d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP xw8000&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0938</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP nc4200&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x099c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP nx6110/nc6120&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0944</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP nc6220&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0934</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP nc8220&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_MUTE_LED</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x12f1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP xw8200&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981B*/</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x12f2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP xw6200&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x103c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x3008</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP xw4200&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981B*/</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x104d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x8144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sony&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x104d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x8197</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sony S1XP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x104d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x81c0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sony VAIO VGN-T350P&quot;</span><span class="p">,</span> <span class="cm">/*AD1981B*/</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x104d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x81c5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sony VAIO VGN-B1VP&quot;</span><span class="p">,</span> <span class="cm">/*AD1981B*/</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
 	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1043</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x80f3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ASUS ICH5/AD1985&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_AD_SHARING</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x11c3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens E4010&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x1225</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens T3010&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x1253</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu S6210&quot;</span><span class="p">,</span>	<span class="cm">/* STAC9750/51 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x127d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu Lifebook P7010&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x127e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu Lifebook C1211D&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x12ec</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens 4010&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10cf</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x12f2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens Celsius H320&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_SWAP_HP</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10f1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2665</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens Celsius&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981? */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10f1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2885</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AMD64 Mobo&quot;</span><span class="p">,</span>	<span class="cm">/* ALC650 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10f1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2895</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Tyan Thunder K8WE&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x10f7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x834c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Panasonic CF-R4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x110a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0056</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens Scenic&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981? */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x11d4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x5375</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ADI AD1985 (discrete)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1462</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x5470</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MSI P4 ATX 645 Ultra&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x161f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x202f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Gateway M520&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x161f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x203a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Gateway 4525GZ&quot;</span><span class="p">,</span>		<span class="cm">/* AD1981B */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_INV_EAPD</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x1734</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x0088</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Fujitsu-Siemens D1522&quot;</span><span class="p">,</span>	<span class="cm">/* AD1981 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel ICH5/AD1985&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_AD_SHARING</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel ICH5/AD1985&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_AD_SHARING</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x4856</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel D845WN (82801BA)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_SWAP_HP</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x4d44</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel D850EMV2&quot;</span><span class="p">,</span>	<span class="cm">/* AD1885 */</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x4d56</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel ICH/AD1885&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_HP_ONLY</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0x6000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel ICH5/AD1985&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_AD_SHARING</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="mh">0x8086</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="mh">0xe000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Intel ICH5/AD1985&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">AC97_TUNE_AD_SHARING</span>
	<span class="p">},</span>
<span class="cp">#if 0</span><span class="c"> /* FIXME: this seems wrong on most boards */</span>
<span class="c">	{</span>
<span class="c">		.subvendor = 0x8086,</span>
<span class="c">		.subdevice = 0xa000,</span>
<span class="c">		.mask = 0xfff0,</span>
<span class="c">		.name = &quot;Intel ICH5/AD1985&quot;,</span>
<span class="c">		.type = AC97_TUNE_HP_ONLY</span>
<span class="c">	},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ac97_clock</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">quirk_override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">codecs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">glob_sta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">standard_bus_ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_intel8x0_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_intel8x0_codec_read</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ali_bus_ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_intel8x0_ali_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_intel8x0_ali_codec_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* use PCMOUT (or disabled) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DEVICE_NFORCE</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">=</span> <span class="n">NVD_SPBAR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DEVICE_ALI</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">=</span> <span class="n">ALID_AC97SPDIFOUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DEVICE_INTEL_ICH4</span>:
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">=</span> <span class="n">ICHD_SPBAR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_intel8x0_mixer_free_ac97</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_SKIP_MODEM</span> <span class="o">|</span> <span class="n">AC97_SCAP_POWER_SAVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xbox</span><span class="p">)</span>
		<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">|=</span> <span class="n">AC97_SCAP_DETECT_BY_VENDOR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_ALI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">glob_sta</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">));</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">standard_bus_ops</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_sdin_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">codecs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">glob_sta</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_intel8x0_codec_read_test</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">codecs</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">codecs</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">SDM</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICH_LDI_MASK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">codecs</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">))</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">codecs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">codecs</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">codecs</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_sdin_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">codecs</span><span class="p">)</span>
			<span class="n">codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ali_bus_ops</span><span class="p">;</span>
		<span class="n">codecs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* detect the secondary codec */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_RTSR</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">codecs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_RTSR</span><span class="p">),</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_intel8x0_mixer_free_ac97_bus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_clock</span> <span class="o">&gt;=</span> <span class="mi">8000</span> <span class="o">&amp;&amp;</span> <span class="n">ac97_clock</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">ac97_clock</span><span class="p">;</span>
	<span class="cm">/* FIXME: my test board doesn&#39;t work well with VRA... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
		<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">no_vra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">dra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="n">pbus</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ncodecs</span> <span class="o">=</span> <span class="n">codecs</span><span class="p">;</span>

	<span class="n">ac97</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac97</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to initialize codec #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* tune up the primary codec */</span>
	<span class="n">snd_ac97_tune_hardware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ac97_quirks</span><span class="p">,</span> <span class="n">quirk_override</span><span class="p">);</span>
	<span class="cm">/* enable separate SDINs for ICH4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span>
		<span class="n">pbus</span><span class="o">-&gt;</span><span class="n">isdin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* find the available PCM streams */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ac97_pcm_defs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* do not allocate PCM2IN and MIC2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>		<span class="cm">/* do not allocate S/PDIF */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_pcm_assign</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ac97_pcm_defs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__err</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMOUT</span><span class="p">].</span><span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMIN</span><span class="p">].</span><span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MIC</span><span class="p">].</span><span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span><span class="p">].</span><span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCM2IN</span><span class="p">].</span><span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_MIC2</span><span class="p">].</span><span class="n">pcm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* enable separate SDINs for ICH4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ac97_pcm</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCM2IN</span><span class="p">].</span><span class="n">pcm</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">SDM</span><span class="p">));</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICH_DI2L_MASK</span><span class="o">|</span><span class="n">ICH_DI1L_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">ICH_SE</span><span class="p">;</span>	<span class="cm">/* steer enable for multiple SDINs */</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">ICH_DI1L_SHIFT</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">codec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">tmp</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">codec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">ICH_DI2L_SHIFT</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ICH_SE</span><span class="p">;</span> <span class="cm">/* steer disable */</span>
		<span class="p">}</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">SDM</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">slots</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_PCM_SLEFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi4</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">slots</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">AC97_SLOT_LFE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi6</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AC97_HAS_8CH</span><span class="p">)</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">multi8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbus</span><span class="o">-&gt;</span><span class="n">pcms</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">rslots</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICH_SAMPLE_CAP</span><span class="p">)</span> <span class="o">==</span> <span class="n">ICH_SAMPLE_16_20</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">smp20bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 48kHz only */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">spdif_idx</span><span class="p">].</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use slot 10/11 for SPDIF */</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICH_PCM_SPDIF_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ICH_PCM_SPDIF_1011</span><span class="p">;</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">snd_ac97_update_bits</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AC97_EXTENDED_STATUS</span><span class="p">,</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_ac97_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">__err:</span>
	<span class="cm">/* clear the cold-reset bit for the next chance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span>
			  <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICH_AC97COLD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_ali_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_SCR</span><span class="p">),</span> <span class="n">ICH_ALI_SC_RESET</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_FIFOCR1</span><span class="p">),</span> <span class="mh">0x83838383</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_FIFOCR2</span><span class="p">),</span> <span class="mh">0x83838383</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_FIFOCR3</span><span class="p">),</span> <span class="mh">0x83838383</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERFACECR</span><span class="p">),</span>
		  <span class="n">ICH_ALI_IF_PI</span><span class="o">|</span><span class="n">ICH_ALI_IF_PO</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERRUPTCR</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERRUPTSR</span><span class="p">),</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_AC97_POWER_SAVE</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">ich_chip_reset_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1014</span><span class="p">,</span> <span class="mh">0x051f</span><span class="p">,</span> <span class="s">&quot;Thinkpad R32&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ich_chip_cold_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="cm">/* ACLink on, 2 channels */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">ich_chip_reset_mode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">));</span>
	<span class="n">cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICH_ACLINK</span> <span class="o">|</span> <span class="n">ICH_PCM_246_MASK</span><span class="p">);</span>

	<span class="cm">/* do cold reset - the full ac97 powerdown may leave the controller</span>
<span class="cm">	 * in a warm state but actually it cannot communicate with the codec.</span>
<span class="cm">	 */</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICH_AC97COLD</span><span class="p">);</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">));</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span> <span class="o">|</span> <span class="n">ICH_AC97COLD</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define snd_intel8x0_ich_chip_can_cold_reset(chip) \</span>
<span class="cp">	(!snd_pci_quirk_lookup(chip-&gt;pci, ich_chip_reset_mode))</span>
<span class="cp">#else</span>
<span class="cp">#define snd_intel8x0_ich_chip_cold_reset(chip)	0</span>
<span class="cp">#define snd_intel8x0_ich_chip_can_cold_reset(chip) (0)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ich_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="cm">/* ACLink on, 2 channels */</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">));</span>
	<span class="n">cnt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ICH_ACLINK</span> <span class="o">|</span> <span class="n">ICH_PCM_246_MASK</span><span class="p">);</span>
	<span class="cm">/* finish cold or do warm reset */</span>
	<span class="n">cnt</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="n">ICH_AC97COLD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ICH_AC97COLD</span> <span class="o">:</span> <span class="n">ICH_AC97WARM</span><span class="p">;</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ICH_AC97WARM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 warm reset still in progress? [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">)));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ich_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">probing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_time</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">nstatus</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* put logic to right state */</span>
	<span class="cm">/* first clear status bits */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ICH_RCS</span> <span class="o">|</span> <span class="n">ICH_MCINT</span> <span class="o">|</span> <span class="n">ICH_POINT</span> <span class="o">|</span> <span class="n">ICH_PIINT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">ICH_NVSPINT</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">));</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">),</span> <span class="n">cnt</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_intel8x0_ich_chip_can_cold_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_ich_chip_cold_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_ich_chip_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probing</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for any codec ready status.</span>
<span class="cm">		 * Once it becomes ready it should remain ready</span>
<span class="cm">		 * as long as we do not disable the ac97 link.</span>
<span class="cm">		 */</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no codec is found */</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;codec_ready: codec is not ready [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">)));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* wait for other codecs ready status. */</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span> <span class="o">&amp;&amp;</span>
		       <span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* resume phase */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ncodecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">status</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
		<span class="cm">/* wait until all the probed codecs are ready */</span>
		<span class="n">end_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">nstatus</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">))</span> <span class="o">&amp;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">nstatus</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* unmute the output on SIS7012 */</span>
		<span class="n">iputword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable SPDIF interrupt */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x1000000</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
      	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_ali_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">probing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_SCR</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* Cold required */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Warm */</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x80000000</span><span class="p">;</span>	<span class="cm">/* ACLink on */</span>
	<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_SCR</span><span class="p">),</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_INTERRUPTSR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ALI_INT_GPIO</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">__ok</span><span class="p">;</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probing</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

 <span class="nl">__ok:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_RTSR</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="cm">/* primary codec */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_RTSR</span><span class="p">),</span> <span class="n">reg</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">do_ali_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">probing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_ALI</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_ich_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">probing</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">iagetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear semaphore flag */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_ali_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">probing</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* reset channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
	        <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        		<span class="k">if</span> <span class="p">((</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ICH_RESETREGS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        		        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0: reset of registers failed?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="cm">/* initialize Buffer Descriptor Lists */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_BDBAR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span>
			  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bdbar_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__hw_end</span><span class="p">;</span>
	<span class="cm">/* disable interrupts */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="cm">/* reset channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICH_REG_OFF_CR</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_offset</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop the spdif interrupt */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000000</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* --- */</span>

      <span class="nl">__hw_end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span><span class="p">)</span>
			<span class="n">fill_nocache</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * power management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel8x0_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_devs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="cm">/* clear nocache */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">)</span>
					<span class="n">fill_nocache</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ncodecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdm_saved</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">SDM</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="cm">/* The call below may disable built-in speaker on some laptops</span>
<span class="cm">	 * after S2RAM.  So, don&#39;t touch it.</span>
<span class="cm">	 */</span>
	<span class="cm">/* pci_set_power_state(pci, pci_choose_state(pci, state)); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">intel8x0_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_intel8x0_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_intel8x0_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0: unable to grab IRQ %d, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* re-initialize mixer stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable separate SDINs for ICH4 */</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">SDM</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdm_saved</span><span class="p">);</span>
		<span class="cm">/* use slot 10/11 for SPDIF */</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ICH_PCM_SPDIF_MASK</span><span class="p">)</span> <span class="o">|</span>
			  <span class="n">ICH_PCM_SPDIF_1011</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* refill nocache */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span><span class="p">)</span>
		<span class="n">fill_nocache</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ncodecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* refill nocache */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">&amp;&amp;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">page_attr_changed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">)</span>
					<span class="n">fill_nocache</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* resume status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">||</span> <span class="o">!</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ichd</span> <span class="o">==</span> <span class="n">ICHD_PCMOUT</span><span class="p">)</span>
			<span class="n">snd_intel8x0_setup_pcm_out</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">);</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_BDBAR</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar_addr</span><span class="p">);</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_LVI</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">lvi</span><span class="p">);</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">civ</span><span class="p">);</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">,</span> <span class="n">ICH_FIFOE</span> <span class="o">|</span> <span class="n">ICH_BCIS</span> <span class="o">|</span> <span class="n">ICH_LVBCI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define INTEL8X0_TESTBUF_SIZE	32768	</span><span class="cm">/* enough large for one shot */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">intel8x0_measure_ac97_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">subs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pos1</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">civ</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">attempt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">stop_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">!=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* specified in module option */</span>

      <span class="nl">__again:</span>
	<span class="n">subs</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">subs</span> <span class="o">||</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">.</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="n">INTEL8X0_TESTBUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;no playback buffer allocated - aborting measure ac97 clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">ICHD_PCMOUT</span><span class="p">];</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">physbuf</span> <span class="o">=</span> <span class="n">subs</span><span class="o">-&gt;</span><span class="n">dma_buffer</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize</span> <span class="o">=</span> <span class="n">INTEL8X0_TESTBUF_SIZE</span><span class="p">;</span>
	<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* don&#39;t process interrupts */</span>

	<span class="cm">/* set rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_ac97_set_rate</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot set ac97 rate: clock = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_intel8x0_setup_periods</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="p">);</span>
	<span class="n">port</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_measurement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* trigger */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_IOCE</span> <span class="o">|</span> <span class="n">ICH_STARTBM</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_IOCE</span><span class="p">);</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_DMACR</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">do_posix_clock_monotonic_gettime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start_time</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="cm">/* check the position */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">civ</span> <span class="o">=</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">);</span>
		<span class="n">pos1</span> <span class="o">=</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">civ</span> <span class="o">==</span> <span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CIV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pos1</span> <span class="o">==</span> <span class="n">igetword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* oops, this value is not reliable */</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">fragsize1</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">-=</span> <span class="n">pos1</span> <span class="o">&lt;&lt;</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_measurement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">do_posix_clock_monotonic_gettime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stop_time</span><span class="p">);</span>
	<span class="cm">/* stop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iputdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">ALI_DMACR</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">+</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">))</span>
			<span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">igetbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ICH_DCH</span><span class="p">))</span>
			<span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iputbyte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">port</span> <span class="o">+</span> <span class="n">ICH_REG_OFF_CR</span><span class="p">,</span> <span class="n">ICH_RESETREGS</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0: measure - unreliable DMA position..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="nl">__retry:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
			<span class="n">attempt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">__again</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">__end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">stop_time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">*=</span> <span class="mi">1000000</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">+=</span> <span class="p">(</span><span class="n">stop_time</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: measured %lu usecs (%lu samples)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0: ?? calculation error..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pos</span> <span class="o">*=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">/</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="p">((</span><span class="n">pos</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">t</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">40000</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;=</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* abnormal value. hw problem? */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intel8x0: measured clock %ld rejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__retry</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">40500</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">41500</span><span class="p">)</span>
		<span class="cm">/* first exception - 41000Hz reference clock */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">41000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">43600</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">44600</span><span class="p">)</span>
		<span class="cm">/* second exception - 44100HZ reference clock */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="mi">47500</span> <span class="o">||</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">48500</span><span class="p">)</span>
		<span class="cm">/* not 48000Hz, tuning the clock.. */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">*</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">/</span> <span class="n">pos</span><span class="p">;</span>
      <span class="nl">__end:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intel8x0: clocking to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
	<span class="n">snd_ac97_update_power</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AC97_PCM_FRONT_DAC_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">intel8x0_clock_list</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x0e11</span><span class="p">,</span> <span class="mh">0x008a</span><span class="p">,</span> <span class="s">&quot;AD1885&quot;</span><span class="p">,</span> <span class="mi">41000</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x00be</span><span class="p">,</span> <span class="s">&quot;AD1885&quot;</span><span class="p">,</span> <span class="mi">44100</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x0177</span><span class="p">,</span> <span class="s">&quot;AD1980&quot;</span><span class="p">,</span> <span class="mi">48000</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1028</span><span class="p">,</span> <span class="mh">0x01ad</span><span class="p">,</span> <span class="s">&quot;AD1981B&quot;</span><span class="p">,</span> <span class="mi">48000</span><span class="p">),</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x1043</span><span class="p">,</span> <span class="mh">0x80f3</span><span class="p">,</span> <span class="s">&quot;AD1985&quot;</span><span class="p">,</span> <span class="mi">48000</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span>	<span class="cm">/* terminator */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">intel8x0_in_clock_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">intel8x0_clock_list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intel8x0: white list rate for %04x:%04x is %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_intel8x0_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Intel8x0</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_STA</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Global control        : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">GLOB_CNT</span><span class="p">)));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Global status         : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SDM                   : 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">igetdword</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ICHREG</span><span class="p">(</span><span class="n">SDM</span><span class="p">)));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codecs ready    :&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">codecs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;primary&quot;</span><span class="p">,</span> <span class="s">&quot;secondary&quot;</span><span class="p">,</span> <span class="s">&quot;tertiary&quot;</span>
		<span class="p">};</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">codecs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot; none&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_INTEL_ICH4</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AC&#39;97 codecs SDIN     : %i %i %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_sdin</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;intel8x0&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_intel8x0_proc_read</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define snd_intel8x0_proc_init(x)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_intel8x0_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_sta_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ich_codec_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ICH_PCR</span><span class="p">,</span> <span class="n">ICH_SCR</span><span class="p">,</span> <span class="n">ICH_TCR</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sis_codec_bits</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ICH_PCR</span><span class="p">,</span> <span class="n">ICH_SCR</span><span class="p">,</span> <span class="n">ICH_SIS_TCR</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_inside_vm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span>  <span class="o">=</span> <span class="n">inside_vm</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* check module parameter first (override detection) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">result</span> <span class="o">?</span> <span class="s">&quot;enable (forced) VM&quot;</span> <span class="o">:</span> <span class="s">&quot;disable (forced) VM&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fini</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* detect KVM and Parallels virtual environments */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">kvm_para_available</span><span class="p">();</span>
<span class="cp">#ifdef X86_FEATURE_HYPERVISOR</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">||</span> <span class="n">boot_cpu_has</span><span class="p">(</span><span class="n">X86_FEATURE_HYPERVISOR</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fini</span><span class="p">;</span>

	<span class="cm">/* check for known (emulated) devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1af4</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span> <span class="mh">0x1100</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* KVM emulated sound, PCI SSID: 1af4:1100 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;enable KVM&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="mh">0x1ab8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Parallels VM emulated sound, PCI SSID: 1ab8:xxxx */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;enable Parallels VM&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;disable (unknown or VT-d) VM&quot;</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">fini:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intel8x0: %s optimization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">device_type</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">**</span> <span class="n">r_intel8x0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_sta_masks</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ichdev</span> <span class="o">*</span><span class="n">ichdev</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span>	<span class="n">snd_intel8x0_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bdbars</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">3</span><span class="p">,</span> <span class="cm">/* DEVICE_INTEL */</span>
		<span class="mi">6</span><span class="p">,</span> <span class="cm">/* DEVICE_INTEL_ICH4 */</span>
		<span class="mi">3</span><span class="p">,</span> <span class="cm">/* DEVICE_SIS */</span>
		<span class="mi">6</span><span class="p">,</span> <span class="cm">/* DEVICE_ALI */</span>
		<span class="mi">4</span><span class="p">,</span> <span class="cm">/* DEVICE_NFORCE */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="n">intel_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ICH_PIINT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_POINT</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_MCINT</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_M2INT</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_P2INT</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_SPINT</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="n">nforce_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ICH_PIINT</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_POINT</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_MCINT</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ICH_NVSPINT</span><span class="p">,</span> <span class="mh">0x70</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="n">ali_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ALI_INT_PCMIN</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ALI_INT_PCMOUT</span><span class="p">,</span> <span class="mh">0x50</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ALI_INT_MICIN</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ALI_INT_CODECSPDIFOUT</span><span class="p">,</span> <span class="mh">0x70</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ALI_INT_SPDIFIN</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ALI_INT_SPDIFOUT</span><span class="p">,</span> <span class="mh">0xb0</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">ich_reg_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>

	<span class="o">*</span><span class="n">r_intel8x0</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">device_type</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* module parameters */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">buggy_irq</span> <span class="o">=</span> <span class="n">buggy_irq</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">buggy_semaphore</span> <span class="o">=</span> <span class="n">buggy_semaphore</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xbox</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">xbox</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">inside_vm</span> <span class="o">=</span> <span class="n">snd_intel8x0_inside_vm</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_INTEL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_INTEL_440MX</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* enable workaround */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ALI5455 has no ac97 region */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">port_inited</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="cm">/* ICH4 and Nforce */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;AC&#39;97 space ioremap problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_resource_flags</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_MEM</span><span class="p">)</span> <span class="cm">/* ICH4 */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bmaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Controller space ioremap problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">port_inited:</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span> <span class="o">=</span> <span class="n">bdbars</span><span class="p">[</span><span class="n">device_type</span><span class="p">];</span>

	<span class="cm">/* initialize offsets */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_NFORCE</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">nforce_regs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_ALI</span>:
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">ali_regs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">intel_regs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ichd</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span> <span class="o">=</span> <span class="n">tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">int_sta_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* SiS 7012 swaps the registers */</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_PICB</span><span class="p">;</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_SR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_sr</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_SR</span><span class="p">;</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">roff_picb</span> <span class="o">=</span> <span class="n">ICH_REG_OFF_PICB</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span><span class="p">)</span>
			<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">ali_slot</span> <span class="o">=</span> <span class="p">(</span><span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">reg_offset</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">/</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="cm">/* SIS7012 handles the pcm data in bytes, others are in samples */</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">pos_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_SIS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate buffer descriptor lists */</span>
	<span class="cm">/* the start of each lists must be aligned to 8 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">ICH_MAX_FRAGS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;intel8x0: cannot allocate buffer descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* tables must be aligned to 8 bytes here, but the kernel pages</span>
<span class="cm">	   are much bigger, so we don&#39;t care (on i386) */</span>
	<span class="cm">/* workaround for 440MX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fix_nocache</span><span class="p">)</span>
		<span class="n">fill_nocache</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">int_sta_masks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ichdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ichd</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">ICH_MAX_FRAGS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">bdbar_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bdbars</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span>
			<span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">ICH_MAX_FRAGS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">int_sta_masks</span> <span class="o">|=</span> <span class="n">ichdev</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_reg</span> <span class="o">=</span> <span class="n">device_type</span> <span class="o">==</span> <span class="n">DEVICE_ALI</span> <span class="o">?</span>
		<span class="n">ICH_REG_ALI_INTERRUPTSR</span> <span class="o">:</span> <span class="n">ICH_REG_GLOB_STA</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_sta_mask</span> <span class="o">=</span> <span class="n">int_sta_masks</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DEVICE_INTEL_ICH4</span>:
		<span class="cm">/* ICH4 can have three codecs */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_codecs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span> <span class="o">=</span> <span class="n">ich_codec_bits</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_ready_bits</span> <span class="o">=</span> <span class="n">ICH_PRI</span> <span class="o">|</span> <span class="n">ICH_SRI</span> <span class="o">|</span> <span class="n">ICH_TRI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEVICE_SIS</span>:
		<span class="cm">/* recent SIS7012 can have three codecs */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_codecs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span> <span class="o">=</span> <span class="n">sis_codec_bits</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_ready_bits</span> <span class="o">=</span> <span class="n">ICH_PRI</span> <span class="o">|</span> <span class="n">ICH_SRI</span> <span class="o">|</span> <span class="n">ICH_SIS_TRI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* others up to two codecs */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_codecs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span> <span class="o">=</span> <span class="n">ich_codec_bits</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_ready_bits</span> <span class="o">=</span> <span class="n">ICH_PRI</span> <span class="o">|</span> <span class="n">ICH_SRI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_codecs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_isr_bits</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">codec_bit</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_chip_init</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* request irq after initializaing int_sta_mask, etc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_intel8x0_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_intel8x0_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">r_intel8x0</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">shortname_table</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span> <span class="n">shortnames</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AA_5</span><span class="p">,</span> <span class="s">&quot;Intel 82801AA-ICH&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801AB_5</span><span class="p">,</span> <span class="s">&quot;Intel 82901AB-ICH0&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801BA_4</span><span class="p">,</span> <span class="s">&quot;Intel 82801BA-ICH2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_440MX</span><span class="p">,</span> <span class="s">&quot;Intel 440MX&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801CA_5</span><span class="p">,</span> <span class="s">&quot;Intel 82801CA-ICH3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801DB_5</span><span class="p">,</span> <span class="s">&quot;Intel 82801DB-ICH4&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_82801EB_5</span><span class="p">,</span> <span class="s">&quot;Intel ICH5&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_ESB_5</span><span class="p">,</span> <span class="s">&quot;Intel 6300ESB&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH6_18</span><span class="p">,</span> <span class="s">&quot;Intel ICH6&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_ICH7_20</span><span class="p">,</span> <span class="s">&quot;Intel ICH7&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_INTEL_ESB2_14</span><span class="p">,</span> <span class="s">&quot;Intel ESB2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_SI_7012</span><span class="p">,</span> <span class="s">&quot;SiS SI7012&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP1_AUDIO</span><span class="p">,</span> <span class="s">&quot;NVidia nForce&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP2_AUDIO</span><span class="p">,</span> <span class="s">&quot;NVidia nForce2&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_MCP3_AUDIO</span><span class="p">,</span> <span class="s">&quot;NVidia nForce3&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_CK8S_AUDIO</span><span class="p">,</span> <span class="s">&quot;NVidia CK8S&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_CK804_AUDIO</span><span class="p">,</span> <span class="s">&quot;NVidia CK804&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE_ID_NVIDIA_CK8_AUDIO</span><span class="p">,</span> <span class="s">&quot;NVidia CK8&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x003a</span><span class="p">,</span> <span class="s">&quot;NVidia MCP04&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x746d</span><span class="p">,</span> <span class="s">&quot;AMD AMD8111&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x7445</span><span class="p">,</span> <span class="s">&quot;AMD AMD768&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x5455</span><span class="p">,</span> <span class="s">&quot;ALi M5455&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="n">spdif_aclink_defaults</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SND_PCI_QUIRK</span><span class="p">(</span><span class="mh">0x147b</span><span class="p">,</span> <span class="mh">0x1c1a</span><span class="p">,</span> <span class="s">&quot;ASUS KN8&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">{</span> <span class="p">}</span> <span class="cm">/* end */</span>
<span class="p">};</span>

<span class="cm">/* look up white/black list for SPDIF over ac-link */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">check_default_spdif_aclink</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">snd_pci_quirk</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">snd_pci_quirk_lookup</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">spdif_aclink_defaults</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intel8x0: Using SPDIF over &quot;</span>
				    <span class="s">&quot;AC-Link for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;intel8x0: Using integrated &quot;</span>
				    <span class="s">&quot;SPDIF DMA for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_intel8x0_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intel8x0</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">shortname_table</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spdif_aclink</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">spdif_aclink</span> <span class="o">=</span> <span class="n">check_default_spdif_aclink</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ICH&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spdif_aclink</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DEVICE_NFORCE</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;NFORCE&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DEVICE_INTEL_ICH4</span>:
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ICH4&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Intel ICH&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">shortnames</span><span class="p">;</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span> <span class="n">name</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buggy_irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some Nforce[2] and ICH boards have problems with IRQ handling.</span>
<span class="cm">		 * Needs to return IRQ_HANDLED for unknown irqs.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">DEVICE_NFORCE</span><span class="p">)</span>
			<span class="n">buggy_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buggy_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ac97_clock</span><span class="p">,</span> <span class="n">ac97_quirk</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_intel8x0_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">snd_intel8x0_proc_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s with %s at irq %i&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span>
		 <span class="n">snd_ac97_get_short_name</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac97_clock</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ac97_clock</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ac97_clock</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intel8x0_in_clock_list</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">intel8x0_measure_ac97_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">intel8x0_measure_ac97_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_intel8x0_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">intel8x0_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_intel8x0_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_intel8x0_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_intel8x0_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">intel8x0_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">intel8x0_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">intel8x0_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
