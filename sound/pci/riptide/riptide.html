<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › riptide › riptide.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>riptide.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   Driver for the Conexant Riptide Soundchip</span>
<span class="cm"> *</span>
<span class="cm"> *	Copyright (c) 2004 Peter Gruber &lt;nokos@gmx.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm">  History:</span>
<span class="cm">   - 02/15/2004 first release</span>
<span class="cm">   </span>
<span class="cm">  This Driver is based on the OSS Driver version from Linuxant (riptide-0.6lnxtbeta03111100)</span>
<span class="cm">  credits from the original files:</span>
<span class="cm">  </span>
<span class="cm">  MODULE NAME:        cnxt_rt.h                       </span>
<span class="cm">  AUTHOR:             K. Lazarev  (Transcribed by KNL)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Created                           02/1/2000     KNL</span>

<span class="cm">  MODULE NAME:     int_mdl.c                       </span>
<span class="cm">  AUTHOR:          Konstantin Lazarev    (Transcribed by KNL)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Created                           10/01/99      KNL</span>
<span class="cm">	    </span>
<span class="cm">  MODULE NAME:        riptide.h                       </span>
<span class="cm">  AUTHOR:             O. Druzhinin  (Transcribed by OLD)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Created                           10/16/97      OLD</span>

<span class="cm">  MODULE NAME:        Rp_Cmdif.cpp                       </span>
<span class="cm">  AUTHOR:             O. Druzhinin  (Transcribed by OLD)</span>
<span class="cm">                      K. Lazarev    (Transcribed by KNL)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Adopted from NT4 driver            6/22/99      OLD</span>
<span class="cm">            Ported to Linux                    9/01/99      KNL</span>

<span class="cm">  MODULE NAME:        rt_hw.c                       </span>
<span class="cm">  AUTHOR:             O. Druzhinin  (Transcribed by OLD)</span>
<span class="cm">                      C. Lazarev    (Transcribed by CNL)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Created                           11/18/97      OLD</span>
<span class="cm">            Hardware functions for RipTide    11/24/97      CNL</span>
<span class="cm">            (ES1) are coded</span>
<span class="cm">            Hardware functions for RipTide    12/24/97      CNL</span>
<span class="cm">            (A0) are coded</span>
<span class="cm">            Hardware functions for RipTide    03/20/98      CNL</span>
<span class="cm">            (A1) are coded</span>
<span class="cm">            Boot loader is included           05/07/98      CNL</span>
<span class="cm">            Redesigned for WDM                07/27/98      CNL</span>
<span class="cm">            Redesigned for Linux              09/01/99      CNL</span>

<span class="cm">  MODULE NAME:        rt_hw.h</span>
<span class="cm">  AUTHOR:             C. Lazarev    (Transcribed by CNL)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Created                           11/18/97      CNL</span>

<span class="cm">  MODULE NAME:     rt_mdl.c                       </span>
<span class="cm">  AUTHOR:          Konstantin Lazarev    (Transcribed by KNL)</span>
<span class="cm">  HISTORY:         Major Revision               Date        By</span>
<span class="cm">            -----------------------------     --------     -----</span>
<span class="cm">            Created                           10/01/99      KNL</span>

<span class="cm">  MODULE NAME:        mixer.h                        </span>
<span class="cm">  AUTHOR:             K. Kenney</span>
<span class="cm">  HISTORY:         Major Revision                   Date          By</span>
<span class="cm">            -----------------------------          --------     -----</span>
<span class="cm">            Created from MS W95 Sample             11/28/95      KRS</span>
<span class="cm">            RipTide                                10/15/97      KRS</span>
<span class="cm">            Adopted for Windows NT driver          01/20/98      CNL</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/gameport.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/ac97_codec.h&gt;</span>
<span class="cp">#include &lt;sound/mpu401.h&gt;</span>
<span class="cp">#include &lt;sound/opl3.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#if defined(CONFIG_GAMEPORT) || (defined(MODULE) &amp;&amp; defined(CONFIG_GAMEPORT_MODULE))</span>
<span class="cp">#define SUPPORT_JOYSTICK 1</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Peter Gruber &lt;nokos@gmx.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;riptide&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{Conexant,Riptide}}&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;riptide.hex&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">joystick_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x200</span> <span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mpu_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x330</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">opl3_port</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mh">0x388</span> <span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for Riptide soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for Riptide soundcard.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable Riptide soundcard.&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">joystick_port</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">joystick_port</span><span class="p">,</span> <span class="s">&quot;Joystick port # for Riptide soundcard.&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mpu_port</span><span class="p">,</span> <span class="s">&quot;MPU401 port # for Riptide driver.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">opl3_port</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">opl3_port</span><span class="p">,</span> <span class="s">&quot;OPL3 port # for Riptide driver.&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="cp">#define MPU401_HW_RIPTIDE MPU401_HW_MPU401</span>
<span class="cp">#define OPL3_HW_RIPTIDE   OPL3_HW_OPL3</span>

<span class="cp">#define PCI_EXT_CapId       0x40</span>
<span class="cp">#define PCI_EXT_NextCapPrt  0x41</span>
<span class="cp">#define PCI_EXT_PWMC        0x42</span>
<span class="cp">#define PCI_EXT_PWSCR       0x44</span>
<span class="cp">#define PCI_EXT_Data00      0x46</span>
<span class="cp">#define PCI_EXT_PMSCR_BSE   0x47</span>
<span class="cp">#define PCI_EXT_SB_Base     0x48</span>
<span class="cp">#define PCI_EXT_FM_Base     0x4a</span>
<span class="cp">#define PCI_EXT_MPU_Base    0x4C</span>
<span class="cp">#define PCI_EXT_Game_Base   0x4E</span>
<span class="cp">#define PCI_EXT_Legacy_Mask 0x50</span>
<span class="cp">#define PCI_EXT_AsicRev     0x52</span>
<span class="cp">#define PCI_EXT_Reserved3   0x53</span>

<span class="cp">#define LEGACY_ENABLE_ALL      0x8000	</span><span class="cm">/* legacy device options */</span><span class="cp"></span>
<span class="cp">#define LEGACY_ENABLE_SB       0x4000</span>
<span class="cp">#define LEGACY_ENABLE_FM       0x2000</span>
<span class="cp">#define LEGACY_ENABLE_MPU_INT  0x1000</span>
<span class="cp">#define LEGACY_ENABLE_MPU      0x0800</span>
<span class="cp">#define LEGACY_ENABLE_GAMEPORT 0x0400</span>

<span class="cp">#define MAX_WRITE_RETRY  10	</span><span class="cm">/* cmd interface limits */</span><span class="cp"></span>
<span class="cp">#define MAX_ERROR_COUNT  10</span>
<span class="cp">#define CMDIF_TIMEOUT    50000</span>
<span class="cp">#define RESET_TRIES      5</span>

<span class="cp">#define READ_PORT_ULONG(p)     inl((unsigned long)&amp;(p))</span>
<span class="cp">#define WRITE_PORT_ULONG(p,x)  outl(x,(unsigned long)&amp;(p))</span>

<span class="cp">#define READ_AUDIO_CONTROL(p)     READ_PORT_ULONG(p-&gt;audio_control)</span>
<span class="cp">#define WRITE_AUDIO_CONTROL(p,x)  WRITE_PORT_ULONG(p-&gt;audio_control,x)</span>
<span class="cp">#define UMASK_AUDIO_CONTROL(p,x)  WRITE_PORT_ULONG(p-&gt;audio_control,READ_PORT_ULONG(p-&gt;audio_control)|x)</span>
<span class="cp">#define MASK_AUDIO_CONTROL(p,x)   WRITE_PORT_ULONG(p-&gt;audio_control,READ_PORT_ULONG(p-&gt;audio_control)&amp;x)</span>
<span class="cp">#define READ_AUDIO_STATUS(p)      READ_PORT_ULONG(p-&gt;audio_status)</span>

<span class="cp">#define SET_GRESET(p)     UMASK_AUDIO_CONTROL(p,0x0001)	</span><span class="cm">/* global reset switch */</span><span class="cp"></span>
<span class="cp">#define UNSET_GRESET(p)   MASK_AUDIO_CONTROL(p,~0x0001)</span>
<span class="cp">#define SET_AIE(p)        UMASK_AUDIO_CONTROL(p,0x0004)	</span><span class="cm">/* interrupt enable */</span><span class="cp"></span>
<span class="cp">#define UNSET_AIE(p)      MASK_AUDIO_CONTROL(p,~0x0004)</span>
<span class="cp">#define SET_AIACK(p)      UMASK_AUDIO_CONTROL(p,0x0008)	</span><span class="cm">/* interrupt acknowledge */</span><span class="cp"></span>
<span class="cp">#define UNSET_AIACKT(p)   MASKAUDIO_CONTROL(p,~0x0008)</span>
<span class="cp">#define SET_ECMDAE(p)     UMASK_AUDIO_CONTROL(p,0x0010)</span>
<span class="cp">#define UNSET_ECMDAE(p)   MASK_AUDIO_CONTROL(p,~0x0010)</span>
<span class="cp">#define SET_ECMDBE(p)     UMASK_AUDIO_CONTROL(p,0x0020)</span>
<span class="cp">#define UNSET_ECMDBE(p)   MASK_AUDIO_CONTROL(p,~0x0020)</span>
<span class="cp">#define SET_EDATAF(p)     UMASK_AUDIO_CONTROL(p,0x0040)</span>
<span class="cp">#define UNSET_EDATAF(p)   MASK_AUDIO_CONTROL(p,~0x0040)</span>
<span class="cp">#define SET_EDATBF(p)     UMASK_AUDIO_CONTROL(p,0x0080)</span>
<span class="cp">#define UNSET_EDATBF(p)   MASK_AUDIO_CONTROL(p,~0x0080)</span>
<span class="cp">#define SET_ESBIRQON(p)   UMASK_AUDIO_CONTROL(p,0x0100)</span>
<span class="cp">#define UNSET_ESBIRQON(p) MASK_AUDIO_CONTROL(p,~0x0100)</span>
<span class="cp">#define SET_EMPUIRQ(p)    UMASK_AUDIO_CONTROL(p,0x0200)</span>
<span class="cp">#define UNSET_EMPUIRQ(p)  MASK_AUDIO_CONTROL(p,~0x0200)</span>
<span class="cp">#define IS_CMDE(a)        (READ_PORT_ULONG(a-&gt;stat)&amp;0x1)	</span><span class="cm">/* cmd empty */</span><span class="cp"></span>
<span class="cp">#define IS_DATF(a)        (READ_PORT_ULONG(a-&gt;stat)&amp;0x2)	</span><span class="cm">/* data filled */</span><span class="cp"></span>
<span class="cp">#define IS_READY(p)       (READ_AUDIO_STATUS(p)&amp;0x0001)</span>
<span class="cp">#define IS_DLREADY(p)     (READ_AUDIO_STATUS(p)&amp;0x0002)</span>
<span class="cp">#define IS_DLERR(p)       (READ_AUDIO_STATUS(p)&amp;0x0004)</span>
<span class="cp">#define IS_GERR(p)        (READ_AUDIO_STATUS(p)&amp;0x0008)	</span><span class="cm">/* error ! */</span><span class="cp"></span>
<span class="cp">#define IS_CMDAEIRQ(p)    (READ_AUDIO_STATUS(p)&amp;0x0010)</span>
<span class="cp">#define IS_CMDBEIRQ(p)    (READ_AUDIO_STATUS(p)&amp;0x0020)</span>
<span class="cp">#define IS_DATAFIRQ(p)    (READ_AUDIO_STATUS(p)&amp;0x0040)</span>
<span class="cp">#define IS_DATBFIRQ(p)    (READ_AUDIO_STATUS(p)&amp;0x0080)</span>
<span class="cp">#define IS_EOBIRQ(p)      (READ_AUDIO_STATUS(p)&amp;0x0100)	</span><span class="cm">/* interrupt status */</span><span class="cp"></span>
<span class="cp">#define IS_EOSIRQ(p)      (READ_AUDIO_STATUS(p)&amp;0x0200)</span>
<span class="cp">#define IS_EOCIRQ(p)      (READ_AUDIO_STATUS(p)&amp;0x0400)</span>
<span class="cp">#define IS_UNSLIRQ(p)     (READ_AUDIO_STATUS(p)&amp;0x0800)</span>
<span class="cp">#define IS_SBIRQ(p)       (READ_AUDIO_STATUS(p)&amp;0x1000)</span>
<span class="cp">#define IS_MPUIRQ(p)      (READ_AUDIO_STATUS(p)&amp;0x2000)</span>

<span class="cp">#define RESP 0x00000001		</span><span class="cm">/* command flags */</span><span class="cp"></span>
<span class="cp">#define PARM 0x00000002</span>
<span class="cp">#define CMDA 0x00000004</span>
<span class="cp">#define CMDB 0x00000008</span>
<span class="cp">#define NILL 0x00000000</span>

<span class="cp">#define LONG0(a)   ((u32)a)	</span><span class="cm">/* shifts and masks */</span><span class="cp"></span>
<span class="cp">#define BYTE0(a)   (LONG0(a)&amp;0xff)</span>
<span class="cp">#define BYTE1(a)   (BYTE0(a)&lt;&lt;8)</span>
<span class="cp">#define BYTE2(a)   (BYTE0(a)&lt;&lt;16)</span>
<span class="cp">#define BYTE3(a)   (BYTE0(a)&lt;&lt;24)</span>
<span class="cp">#define WORD0(a)   (LONG0(a)&amp;0xffff)</span>
<span class="cp">#define WORD1(a)   (WORD0(a)&lt;&lt;8)</span>
<span class="cp">#define WORD2(a)   (WORD0(a)&lt;&lt;16)</span>
<span class="cp">#define TRINIB0(a) (LONG0(a)&amp;0xffffff)</span>
<span class="cp">#define TRINIB1(a) (TRINIB0(a)&lt;&lt;8)</span>

<span class="cp">#define RET(a)     ((union cmdret *)(a))</span>

<span class="cp">#define SEND_GETV(p,b)             sendcmd(p,RESP,GETV,0,RET(b))	</span><span class="cm">/* get version */</span><span class="cp"></span>
<span class="cp">#define SEND_GETC(p,b,c)           sendcmd(p,PARM|RESP,GETC,c,RET(b))</span>
<span class="cp">#define SEND_GUNS(p,b)             sendcmd(p,RESP,GUNS,0,RET(b))</span>
<span class="cp">#define SEND_SCID(p,b)             sendcmd(p,RESP,SCID,0,RET(b))</span>
<span class="cp">#define SEND_RMEM(p,b,c,d)         sendcmd(p,PARM|RESP,RMEM|BYTE1(b),LONG0(c),RET(d))	</span><span class="cm">/* memory access for firmware write */</span><span class="cp"></span>
<span class="cp">#define SEND_SMEM(p,b,c)           sendcmd(p,PARM,SMEM|BYTE1(b),LONG0(c),RET(0))	</span><span class="cm">/* memory access for firmware write */</span><span class="cp"></span>
<span class="cp">#define SEND_WMEM(p,b,c)           sendcmd(p,PARM,WMEM|BYTE1(b),LONG0(c),RET(0))	</span><span class="cm">/* memory access for firmware write */</span><span class="cp"></span>
<span class="cp">#define SEND_SDTM(p,b,c)           sendcmd(p,PARM|RESP,SDTM|TRINIB1(b),0,RET(c))	</span><span class="cm">/* memory access for firmware write */</span><span class="cp"></span>
<span class="cp">#define SEND_GOTO(p,b)             sendcmd(p,PARM,GOTO,LONG0(b),RET(0))	</span><span class="cm">/* memory access for firmware write */</span><span class="cp"></span>
<span class="cp">#define SEND_SETDPLL(p)	           sendcmd(p,0,ARM_SETDPLL,0,RET(0))</span>
<span class="cp">#define SEND_SSTR(p,b,c)           sendcmd(p,PARM,SSTR|BYTE3(b),LONG0(c),RET(0))	</span><span class="cm">/* start stream */</span><span class="cp"></span>
<span class="cp">#define SEND_PSTR(p,b)             sendcmd(p,PARM,PSTR,BYTE3(b),RET(0))	</span><span class="cm">/* pause stream */</span><span class="cp"></span>
<span class="cp">#define SEND_KSTR(p,b)             sendcmd(p,PARM,KSTR,BYTE3(b),RET(0))	</span><span class="cm">/* stop stream */</span><span class="cp"></span>
<span class="cp">#define SEND_KDMA(p)               sendcmd(p,0,KDMA,0,RET(0))	</span><span class="cm">/* stop all dma */</span><span class="cp"></span>
<span class="cp">#define SEND_GPOS(p,b,c,d)         sendcmd(p,PARM|RESP,GPOS,BYTE3(c)|BYTE2(b),RET(d))	</span><span class="cm">/* get position in dma */</span><span class="cp"></span>
<span class="cp">#define SEND_SETF(p,b,c,d,e,f,g)   sendcmd(p,PARM,SETF|WORD1(b)|BYTE3(c),d|BYTE1(e)|BYTE2(f)|BYTE3(g),RET(0))	</span><span class="cm">/* set sample format at mixer */</span><span class="cp"></span>
<span class="cp">#define SEND_GSTS(p,b,c,d)         sendcmd(p,PARM|RESP,GSTS,BYTE3(c)|BYTE2(b),RET(d))</span>
<span class="cp">#define SEND_NGPOS(p,b,c,d)        sendcmd(p,PARM|RESP,NGPOS,BYTE3(c)|BYTE2(b),RET(d))</span>
<span class="cp">#define SEND_PSEL(p,b,c)           sendcmd(p,PARM,PSEL,BYTE2(b)|BYTE3(c),RET(0))	</span><span class="cm">/* activate lbus path */</span><span class="cp"></span>
<span class="cp">#define SEND_PCLR(p,b,c)           sendcmd(p,PARM,PCLR,BYTE2(b)|BYTE3(c),RET(0))	</span><span class="cm">/* deactivate lbus path */</span><span class="cp"></span>
<span class="cp">#define SEND_PLST(p,b)             sendcmd(p,PARM,PLST,BYTE3(b),RET(0))</span>
<span class="cp">#define SEND_RSSV(p,b,c,d)         sendcmd(p,PARM|RESP,RSSV,BYTE2(b)|BYTE3(c),RET(d))</span>
<span class="cp">#define SEND_LSEL(p,b,c,d,e,f,g,h) sendcmd(p,PARM,LSEL|BYTE1(b)|BYTE2(c)|BYTE3(d),BYTE0(e)|BYTE1(f)|BYTE2(g)|BYTE3(h),RET(0))	</span><span class="cm">/* select paths for internal connections */</span><span class="cp"></span>
<span class="cp">#define SEND_SSRC(p,b,c,d,e)       sendcmd(p,PARM,SSRC|BYTE1(b)|WORD2(c),WORD0(d)|WORD2(e),RET(0))	</span><span class="cm">/* configure source */</span><span class="cp"></span>
<span class="cp">#define SEND_SLST(p,b)             sendcmd(p,PARM,SLST,BYTE3(b),RET(0))</span>
<span class="cp">#define SEND_RSRC(p,b,c)           sendcmd(p,RESP,RSRC|BYTE1(b),0,RET(c))	</span><span class="cm">/* read source config */</span><span class="cp"></span>
<span class="cp">#define SEND_SSRB(p,b,c)           sendcmd(p,PARM,SSRB|BYTE1(b),WORD2(c),RET(0))</span>
<span class="cp">#define SEND_SDGV(p,b,c,d,e)       sendcmd(p,PARM,SDGV|BYTE2(b)|BYTE3(c),WORD0(d)|WORD2(e),RET(0))	</span><span class="cm">/* set digital mixer */</span><span class="cp"></span>
<span class="cp">#define SEND_RDGV(p,b,c,d)         sendcmd(p,PARM|RESP,RDGV|BYTE2(b)|BYTE3(c),0,RET(d))	</span><span class="cm">/* read digital mixer */</span><span class="cp"></span>
<span class="cp">#define SEND_DLST(p,b)             sendcmd(p,PARM,DLST,BYTE3(b),RET(0))</span>
<span class="cp">#define SEND_SACR(p,b,c)           sendcmd(p,PARM,SACR,WORD0(b)|WORD2(c),RET(0))	</span><span class="cm">/* set AC97 register */</span><span class="cp"></span>
<span class="cp">#define SEND_RACR(p,b,c)           sendcmd(p,PARM|RESP,RACR,WORD2(b),RET(c))	</span><span class="cm">/* get AC97 register */</span><span class="cp"></span>
<span class="cp">#define SEND_ALST(p,b)             sendcmd(p,PARM,ALST,BYTE3(b),RET(0))</span>
<span class="cp">#define SEND_TXAC(p,b,c,d,e,f)     sendcmd(p,PARM,TXAC|BYTE1(b)|WORD2(c),WORD0(d)|BYTE2(e)|BYTE3(f),RET(0))</span>
<span class="cp">#define SEND_RXAC(p,b,c,d)         sendcmd(p,PARM|RESP,RXAC,BYTE2(b)|BYTE3(c),RET(d))</span>
<span class="cp">#define SEND_SI2S(p,b)             sendcmd(p,PARM,SI2S,WORD2(b),RET(0))</span>

<span class="cp">#define EOB_STATUS         0x80000000	</span><span class="cm">/* status flags : block boundary */</span><span class="cp"></span>
<span class="cp">#define EOS_STATUS         0x40000000	</span><span class="cm">/*              : stoppped */</span><span class="cp"></span>
<span class="cp">#define EOC_STATUS         0x20000000	</span><span class="cm">/*              : stream end */</span><span class="cp"></span>
<span class="cp">#define ERR_STATUS         0x10000000</span>
<span class="cp">#define EMPTY_STATUS       0x08000000</span>

<span class="cp">#define IEOB_ENABLE        0x1	</span><span class="cm">/* enable interrupts for status notification above */</span><span class="cp"></span>
<span class="cp">#define IEOS_ENABLE        0x2</span>
<span class="cp">#define IEOC_ENABLE        0x4</span>
<span class="cp">#define RDONCE             0x8</span>
<span class="cp">#define DESC_MAX_MASK      0xff</span>

<span class="cp">#define ST_PLAY  0x1		</span><span class="cm">/* stream states */</span><span class="cp"></span>
<span class="cp">#define ST_STOP  0x2</span>
<span class="cp">#define ST_PAUSE 0x4</span>

<span class="cp">#define I2S_INTDEC     3	</span><span class="cm">/* config for I2S link */</span><span class="cp"></span>
<span class="cp">#define I2S_MERGER     0</span>
<span class="cp">#define I2S_SPLITTER   0</span>
<span class="cp">#define I2S_MIXER      7</span>
<span class="cp">#define I2S_RATE       44100</span>

<span class="cp">#define MODEM_INTDEC   4	</span><span class="cm">/* config for modem link */</span><span class="cp"></span>
<span class="cp">#define MODEM_MERGER   3</span>
<span class="cp">#define MODEM_SPLITTER 0</span>
<span class="cp">#define MODEM_MIXER    11</span>

<span class="cp">#define FM_INTDEC      3	</span><span class="cm">/* config for FM/OPL3 link */</span><span class="cp"></span>
<span class="cp">#define FM_MERGER      0</span>
<span class="cp">#define FM_SPLITTER    0</span>
<span class="cp">#define FM_MIXER       9</span>

<span class="cp">#define SPLIT_PATH  0x80	</span><span class="cm">/* path splitting flag */</span><span class="cp"></span>

<span class="k">enum</span> <span class="n">FIRMWARE</span> <span class="p">{</span>
	<span class="n">DATA_REC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">EXT_END_OF_FILE</span><span class="p">,</span> <span class="n">EXT_SEG_ADDR_REC</span><span class="p">,</span> <span class="n">EXT_GOTO_CMD_REC</span><span class="p">,</span>
	<span class="n">EXT_LIN_ADDR_REC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">CMDS</span> <span class="p">{</span>
	<span class="n">GETV</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">GETC</span><span class="p">,</span> <span class="n">GUNS</span><span class="p">,</span> <span class="n">SCID</span><span class="p">,</span> <span class="n">RMEM</span> <span class="o">=</span>
	    <span class="mh">0x10</span><span class="p">,</span> <span class="n">SMEM</span><span class="p">,</span> <span class="n">WMEM</span><span class="p">,</span> <span class="n">SDTM</span><span class="p">,</span> <span class="n">GOTO</span><span class="p">,</span> <span class="n">SSTR</span> <span class="o">=</span>
	    <span class="mh">0x20</span><span class="p">,</span> <span class="n">PSTR</span><span class="p">,</span> <span class="n">KSTR</span><span class="p">,</span> <span class="n">KDMA</span><span class="p">,</span> <span class="n">GPOS</span><span class="p">,</span> <span class="n">SETF</span><span class="p">,</span> <span class="n">GSTS</span><span class="p">,</span> <span class="n">NGPOS</span><span class="p">,</span> <span class="n">PSEL</span> <span class="o">=</span>
	    <span class="mh">0x30</span><span class="p">,</span> <span class="n">PCLR</span><span class="p">,</span> <span class="n">PLST</span><span class="p">,</span> <span class="n">RSSV</span><span class="p">,</span> <span class="n">LSEL</span><span class="p">,</span> <span class="n">SSRC</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">SLST</span><span class="p">,</span> <span class="n">RSRC</span><span class="p">,</span> <span class="n">SSRB</span><span class="p">,</span> <span class="n">SDGV</span> <span class="o">=</span>
	    <span class="mh">0x50</span><span class="p">,</span> <span class="n">RDGV</span><span class="p">,</span> <span class="n">DLST</span><span class="p">,</span> <span class="n">SACR</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span> <span class="n">RACR</span><span class="p">,</span> <span class="n">ALST</span><span class="p">,</span> <span class="n">TXAC</span><span class="p">,</span> <span class="n">RXAC</span><span class="p">,</span> <span class="n">SI2S</span> <span class="o">=</span>
	    <span class="mh">0x70</span><span class="p">,</span> <span class="n">ARM_SETDPLL</span> <span class="o">=</span> <span class="mh">0x72</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">E1SOURCE</span> <span class="p">{</span>
	<span class="n">ARM2LBUS_FIFO0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO1</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO2</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO3</span><span class="p">,</span>
	<span class="n">ARM2LBUS_FIFO4</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO5</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO6</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO7</span><span class="p">,</span>
	<span class="n">ARM2LBUS_FIFO8</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO9</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO10</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO11</span><span class="p">,</span>
	<span class="n">ARM2LBUS_FIFO12</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO13</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO14</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO15</span><span class="p">,</span>
	<span class="n">INTER0_OUT</span><span class="p">,</span> <span class="n">INTER1_OUT</span><span class="p">,</span> <span class="n">INTER2_OUT</span><span class="p">,</span> <span class="n">INTER3_OUT</span><span class="p">,</span> <span class="n">INTER4_OUT</span><span class="p">,</span>
	<span class="n">INTERM0_OUT</span><span class="p">,</span> <span class="n">INTERM1_OUT</span><span class="p">,</span> <span class="n">INTERM2_OUT</span><span class="p">,</span> <span class="n">INTERM3_OUT</span><span class="p">,</span> <span class="n">INTERM4_OUT</span><span class="p">,</span>
	<span class="n">INTERM5_OUT</span><span class="p">,</span> <span class="n">INTERM6_OUT</span><span class="p">,</span> <span class="n">DECIMM0_OUT</span><span class="p">,</span> <span class="n">DECIMM1_OUT</span><span class="p">,</span> <span class="n">DECIMM2_OUT</span><span class="p">,</span>
	<span class="n">DECIMM3_OUT</span><span class="p">,</span> <span class="n">DECIM0_OUT</span><span class="p">,</span> <span class="n">SR3_4_OUT</span><span class="p">,</span> <span class="n">OPL3_SAMPLE</span><span class="p">,</span> <span class="n">ASRC0</span><span class="p">,</span> <span class="n">ASRC1</span><span class="p">,</span>
	<span class="n">ACLNK2PADC</span><span class="p">,</span> <span class="n">ACLNK2MODEM0RX</span><span class="p">,</span> <span class="n">ACLNK2MIC</span><span class="p">,</span> <span class="n">ACLNK2MODEM1RX</span><span class="p">,</span> <span class="n">ACLNK2HNDMIC</span><span class="p">,</span>
	<span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">GAINFUNC0_OUT</span><span class="p">,</span> <span class="n">GAINFUNC1_OUT</span><span class="p">,</span> <span class="n">GAINFUNC2_OUT</span><span class="p">,</span>
	<span class="n">GAINFUNC3_OUT</span><span class="p">,</span> <span class="n">GAINFUNC4_OUT</span><span class="p">,</span> <span class="n">SOFTMODEMTX</span><span class="p">,</span> <span class="n">SPLITTER0_OUTL</span><span class="p">,</span>
	<span class="n">SPLITTER0_OUTR</span><span class="p">,</span> <span class="n">SPLITTER1_OUTL</span><span class="p">,</span> <span class="n">SPLITTER1_OUTR</span><span class="p">,</span> <span class="n">SPLITTER2_OUTL</span><span class="p">,</span>
	<span class="n">SPLITTER2_OUTR</span><span class="p">,</span> <span class="n">SPLITTER3_OUTL</span><span class="p">,</span> <span class="n">SPLITTER3_OUTR</span><span class="p">,</span> <span class="n">MERGER0_OUT</span><span class="p">,</span>
	<span class="n">MERGER1_OUT</span><span class="p">,</span> <span class="n">MERGER2_OUT</span><span class="p">,</span> <span class="n">MERGER3_OUT</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO_DIRECT</span><span class="p">,</span> <span class="n">NO_OUT</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">E2SINK</span> <span class="p">{</span>
	<span class="n">LBUS2ARM_FIFO0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO1</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO2</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO3</span><span class="p">,</span>
	<span class="n">LBUS2ARM_FIFO4</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO5</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO6</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO7</span><span class="p">,</span>
	<span class="n">INTER0_IN</span><span class="p">,</span> <span class="n">INTER1_IN</span><span class="p">,</span> <span class="n">INTER2_IN</span><span class="p">,</span> <span class="n">INTER3_IN</span><span class="p">,</span> <span class="n">INTER4_IN</span><span class="p">,</span> <span class="n">INTERM0_IN</span><span class="p">,</span>
	<span class="n">INTERM1_IN</span><span class="p">,</span> <span class="n">INTERM2_IN</span><span class="p">,</span> <span class="n">INTERM3_IN</span><span class="p">,</span> <span class="n">INTERM4_IN</span><span class="p">,</span> <span class="n">INTERM5_IN</span><span class="p">,</span> <span class="n">INTERM6_IN</span><span class="p">,</span>
	<span class="n">DECIMM0_IN</span><span class="p">,</span> <span class="n">DECIMM1_IN</span><span class="p">,</span> <span class="n">DECIMM2_IN</span><span class="p">,</span> <span class="n">DECIMM3_IN</span><span class="p">,</span> <span class="n">DECIM0_IN</span><span class="p">,</span> <span class="n">SR3_4_IN</span><span class="p">,</span>
	<span class="n">PDAC2ACLNK</span><span class="p">,</span> <span class="n">MODEM0TX2ACLNK</span><span class="p">,</span> <span class="n">MODEM1TX2ACLNK</span><span class="p">,</span> <span class="n">HNDSPK2ACLNK</span><span class="p">,</span>
	<span class="n">DIGITAL_MIXER_IN0</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN1</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN2</span><span class="p">,</span>
	<span class="n">DIGITAL_MIXER_IN3</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN4</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN5</span><span class="p">,</span>
	<span class="n">DIGITAL_MIXER_IN6</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN7</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN8</span><span class="p">,</span>
	<span class="n">DIGITAL_MIXER_IN9</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN10</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN11</span><span class="p">,</span>
	<span class="n">GAINFUNC0_IN</span><span class="p">,</span> <span class="n">GAINFUNC1_IN</span><span class="p">,</span> <span class="n">GAINFUNC2_IN</span><span class="p">,</span> <span class="n">GAINFUNC3_IN</span><span class="p">,</span> <span class="n">GAINFUNC4_IN</span><span class="p">,</span>
	<span class="n">SOFTMODEMRX</span><span class="p">,</span> <span class="n">SPLITTER0_IN</span><span class="p">,</span> <span class="n">SPLITTER1_IN</span><span class="p">,</span> <span class="n">SPLITTER2_IN</span><span class="p">,</span> <span class="n">SPLITTER3_IN</span><span class="p">,</span>
	<span class="n">MERGER0_INL</span><span class="p">,</span> <span class="n">MERGER0_INR</span><span class="p">,</span> <span class="n">MERGER1_INL</span><span class="p">,</span> <span class="n">MERGER1_INR</span><span class="p">,</span> <span class="n">MERGER2_INL</span><span class="p">,</span>
	<span class="n">MERGER2_INR</span><span class="p">,</span> <span class="n">MERGER3_INL</span><span class="p">,</span> <span class="n">MERGER3_INR</span><span class="p">,</span> <span class="n">E2SINK_MAX</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">LBUS_SINK</span> <span class="p">{</span>
	<span class="n">LS_SRC_INTERPOLATOR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">,</span> <span class="n">LS_SRC_DECIMATOR</span><span class="p">,</span>
	<span class="n">LS_SRC_DECIMATORM</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">,</span> <span class="n">LS_MIXER_GAIN_FUNCTION</span><span class="p">,</span>
	<span class="n">LS_SRC_SPLITTER</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">,</span> <span class="n">LS_NONE2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">RT_CHANNEL_IDS</span> <span class="p">{</span>
	<span class="n">M0TX</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">M1TX</span><span class="p">,</span> <span class="n">TAMTX</span><span class="p">,</span> <span class="n">HSSPKR</span><span class="p">,</span> <span class="n">PDAC</span><span class="p">,</span> <span class="n">DSNDTX0</span><span class="p">,</span> <span class="n">DSNDTX1</span><span class="p">,</span> <span class="n">DSNDTX2</span><span class="p">,</span>
	<span class="n">DSNDTX3</span><span class="p">,</span> <span class="n">DSNDTX4</span><span class="p">,</span> <span class="n">DSNDTX5</span><span class="p">,</span> <span class="n">DSNDTX6</span><span class="p">,</span> <span class="n">DSNDTX7</span><span class="p">,</span> <span class="n">WVSTRTX</span><span class="p">,</span> <span class="n">COP3DTX</span><span class="p">,</span> <span class="n">SPARE</span><span class="p">,</span>
	<span class="n">M0RX</span><span class="p">,</span> <span class="n">HSMIC</span><span class="p">,</span> <span class="n">M1RX</span><span class="p">,</span> <span class="n">CLEANRX</span><span class="p">,</span> <span class="n">MICADC</span><span class="p">,</span> <span class="n">PADC</span><span class="p">,</span> <span class="n">COPRX1</span><span class="p">,</span> <span class="n">COPRX2</span><span class="p">,</span>
	<span class="n">CHANNEL_ID_COUNTER</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="n">SB_CMD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MODEM_CMD</span><span class="p">,</span> <span class="n">I2S_CMD0</span><span class="p">,</span> <span class="n">I2S_CMD1</span><span class="p">,</span> <span class="n">FM_CMD</span><span class="p">,</span> <span class="n">MAX_CMD</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">lbuspath</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">noconv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stereo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mono</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cmdport</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">data1</span><span class="p">;</span>		<span class="cm">/* cmd,param */</span>
	<span class="n">u32</span> <span class="n">data2</span><span class="p">;</span>		<span class="cm">/* param */</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>		<span class="cm">/* status */</span>
	<span class="n">u32</span> <span class="n">pad</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">riptideport</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">audio_control</span><span class="p">;</span>	<span class="cm">/* status registers */</span>
	<span class="n">u32</span> <span class="n">audio_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pad</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">cmdport</span> <span class="n">port</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* command ports */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cmdif</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">riptideport</span> <span class="o">*</span><span class="n">hwport</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdcnt</span><span class="p">;</span>	<span class="cm">/* cmd statistics */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdtime</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdtimemax</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmdtimemin</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">errcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_reset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">riptide_firmware</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">ASIC</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">CODEC</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">AUXDSP</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">PROG</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">cmdret</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">retbytes</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">retwords</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">retlongs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">union</span> <span class="n">firmware_version</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">riptide_firmware</span> <span class="n">firmware</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define get_pcmhwdev(substream) (struct pcmhw *)(substream-&gt;runtime-&gt;private_data)</span>

<span class="cp">#define PLAYBACK_SUBSTREAMS 3</span>
<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm_i2s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_opl3</span> <span class="o">*</span><span class="n">opl3</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">ac97_bus</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">PLAYBACK_SUBSTREAMS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">openstreams</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mpuaddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">opladdr</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">gameaddr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res_port</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">device_id</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">firmware_version</span> <span class="n">firmware</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">riptide_tq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">proc_entry</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">received_irqs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">handled_irqs</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="kt">int</span> <span class="n">in_suspend</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sgd</span> <span class="p">{</span>			<span class="cm">/* scatter gather desriptor */</span>
	<span class="n">u32</span> <span class="n">dwNextLink</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwSegPtrPhys</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwSegLen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dwStat_Ctl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcmhw</span> <span class="p">{</span>			<span class="cm">/* pcm descriptor */</span>
	<span class="k">struct</span> <span class="n">lbuspath</span> <span class="n">paths</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lbuspath</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">intdec</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">sgdlist</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgd</span> <span class="o">*</span><span class="n">sgdbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pages</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldpos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pointer</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define CMDRET_ZERO (union cmdret){{(u32)0, (u32) 0}}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sendcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">parm</span><span class="p">,</span>
		   <span class="k">union</span> <span class="n">cmdret</span> <span class="o">*</span><span class="n">ret</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">getsourcesink</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sink</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_riptide_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">riptide_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_riptide_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4310</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4330</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4340</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_riptide_joystick_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4312</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4322</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4332</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x127a</span><span class="p">,</span> <span class="mh">0x4342</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_riptide_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbusin2out</span><span class="p">[</span><span class="n">E2SINK_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE2</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span>
								     <span class="n">LS_NONE2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE2</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span>
								     <span class="n">LS_NONE2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTER0_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATOR</span><span class="p">},</span> <span class="p">{</span><span class="n">INTER1_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATOR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTER2_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATOR</span><span class="p">},</span> <span class="p">{</span><span class="n">INTER3_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATOR</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTER4_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATOR</span><span class="p">},</span> <span class="p">{</span><span class="n">INTERM0_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTERM1_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span> <span class="p">{</span><span class="n">INTERM2_OUT</span><span class="p">,</span>
					      <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTERM3_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span> <span class="p">{</span><span class="n">INTERM4_OUT</span><span class="p">,</span>
					      <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">INTERM5_OUT</span><span class="p">,</span> <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span> <span class="p">{</span><span class="n">INTERM6_OUT</span><span class="p">,</span>
					      <span class="n">LS_SRC_INTERPOLATORM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DECIMM0_OUT</span><span class="p">,</span> <span class="n">LS_SRC_DECIMATORM</span><span class="p">},</span> <span class="p">{</span><span class="n">DECIMM1_OUT</span><span class="p">,</span> <span class="n">LS_SRC_DECIMATORM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DECIMM2_OUT</span><span class="p">,</span> <span class="n">LS_SRC_DECIMATORM</span><span class="p">},</span> <span class="p">{</span><span class="n">DECIMM3_OUT</span><span class="p">,</span> <span class="n">LS_SRC_DECIMATORM</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DECIM0_OUT</span><span class="p">,</span> <span class="n">LS_SRC_DECIMATOR</span><span class="p">},</span> <span class="p">{</span><span class="n">SR3_4_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span>
								<span class="n">LS_NONE2</span><span class="p">},</span>
	<span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE2</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span> <span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span> <span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span> <span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span> <span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span> <span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span> <span class="p">{</span><span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">LS_MIXER_IN</span><span class="p">},</span>
	<span class="p">{</span><span class="n">GAINFUNC0_OUT</span><span class="p">,</span> <span class="n">LS_MIXER_GAIN_FUNCTION</span><span class="p">},</span> <span class="p">{</span><span class="n">GAINFUNC1_OUT</span><span class="p">,</span>
						  <span class="n">LS_MIXER_GAIN_FUNCTION</span><span class="p">},</span>
	<span class="p">{</span><span class="n">GAINFUNC2_OUT</span><span class="p">,</span> <span class="n">LS_MIXER_GAIN_FUNCTION</span><span class="p">},</span> <span class="p">{</span><span class="n">GAINFUNC3_OUT</span><span class="p">,</span>
						  <span class="n">LS_MIXER_GAIN_FUNCTION</span><span class="p">},</span>
	<span class="p">{</span><span class="n">GAINFUNC4_OUT</span><span class="p">,</span> <span class="n">LS_MIXER_GAIN_FUNCTION</span><span class="p">},</span> <span class="p">{</span><span class="n">SOFTMODEMTX</span><span class="p">,</span> <span class="n">LS_NONE1</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SPLITTER0_OUTL</span><span class="p">,</span> <span class="n">LS_SRC_SPLITTER</span><span class="p">},</span> <span class="p">{</span><span class="n">SPLITTER1_OUTL</span><span class="p">,</span> <span class="n">LS_SRC_SPLITTER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SPLITTER2_OUTL</span><span class="p">,</span> <span class="n">LS_SRC_SPLITTER</span><span class="p">},</span> <span class="p">{</span><span class="n">SPLITTER3_OUTL</span><span class="p">,</span> <span class="n">LS_SRC_SPLITTER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MERGER0_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span> <span class="p">{</span><span class="n">MERGER0_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MERGER1_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MERGER1_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span> <span class="p">{</span><span class="n">MERGER2_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MERGER2_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span>
	<span class="p">{</span><span class="n">MERGER3_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span> <span class="p">{</span><span class="n">MERGER3_OUT</span><span class="p">,</span> <span class="n">LS_SRC_MERGER</span><span class="p">},</span> <span class="p">{</span><span class="n">NO_OUT</span><span class="p">,</span>
								     <span class="n">LS_NONE2</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_opl3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DIGITAL_MIXER_IN0</span> <span class="o">+</span> <span class="n">FM_MIXER</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_modem</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DIGITAL_MIXER_IN0</span> <span class="o">+</span> <span class="n">MODEM_MIXER</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_i2s</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTER0_IN</span> <span class="o">+</span> <span class="n">I2S_INTDEC</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN0</span> <span class="o">+</span> <span class="n">I2S_MIXER</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_out</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PDAC2ACLNK</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_outhp</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HNDSPK2ACLNK</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_noconv1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DIGITAL_MIXER_IN0</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_stereo1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTER0_IN</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN0</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_mono1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTERM0_IN</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN0</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_noconv2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DIGITAL_MIXER_IN1</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_stereo2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTER1_IN</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN1</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_mono2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTERM1_IN</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN1</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_noconv3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DIGITAL_MIXER_IN2</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_stereo3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTER2_IN</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN2</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_play_mono3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">INTERM2_IN</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_IN2</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_rec_noconv1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">LBUS2ARM_FIFO5</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_rec_stereo1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DECIM0_IN</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO5</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lbus_rec_mono1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DECIMM3_IN</span><span class="p">,</span> <span class="n">LBUS2ARM_FIFO5</span><span class="p">,</span> <span class="mh">0xff</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">play_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">play_sources</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ARM2LBUS_FIFO4</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO1</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO2</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lbuspath</span> <span class="n">lbus_play_paths</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">noconv</span> <span class="o">=</span> <span class="n">lbus_play_noconv1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">lbus_play_stereo1</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">mono</span> <span class="o">=</span> <span class="n">lbus_play_mono1</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">noconv</span> <span class="o">=</span> <span class="n">lbus_play_noconv2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">lbus_play_stereo2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">mono</span> <span class="o">=</span> <span class="n">lbus_play_mono2</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">noconv</span> <span class="o">=</span> <span class="n">lbus_play_noconv3</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">lbus_play_stereo3</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">mono</span> <span class="o">=</span> <span class="n">lbus_play_mono3</span><span class="p">,</span>
	 <span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lbuspath</span> <span class="n">lbus_rec_path</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">noconv</span> <span class="o">=</span> <span class="n">lbus_rec_noconv1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stereo</span> <span class="o">=</span> <span class="n">lbus_rec_stereo1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mono</span> <span class="o">=</span> <span class="n">lbus_rec_mono1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define FIRMWARE_VERSIONS 1</span>
<span class="k">static</span> <span class="k">union</span> <span class="n">firmware_version</span> <span class="n">firmware_versions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">firmware</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">ASIC</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">CODEC</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">AUXDSP</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
			<span class="p">.</span><span class="n">PROG</span> <span class="o">=</span> <span class="mi">773</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">atoh</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mult</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

		<span class="n">c</span> <span class="o">=</span> <span class="n">in</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sum</span> <span class="o">+=</span> <span class="n">mult</span> <span class="o">*</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">mult</span> <span class="o">*=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">--</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">senddata</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">atoh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">atoh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SEND_SMEM</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">in</span> <span class="o">+</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">atoh</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">SEND_WMEM</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x0f0f0f0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xf0f0f0f0</span><span class="p">)</span>
							    <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">loadfirmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">saddr</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">laddr</span> <span class="o">=</span> <span class="n">saddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in</span> <span class="o">=</span> <span class="n">img</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">atoh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DATA_REC</span>:
				<span class="n">err</span> <span class="o">=</span> <span class="n">senddata</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">laddr</span> <span class="o">+</span> <span class="n">saddr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EXT_SEG_ADDR_REC</span>:
				<span class="n">saddr</span> <span class="o">=</span> <span class="n">atoh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EXT_LIN_ADDR_REC</span>:
				<span class="n">laddr</span> <span class="o">=</span> <span class="n">atoh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EXT_GOTO_CMD_REC</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="n">atoh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">SEND_GOTO</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">EXT_END_OF_FILE</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">img</span><span class="o">++</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;load firmware return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">alloclbuspath</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mixer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">path</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sink</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">sink</span> <span class="o">=</span> <span class="o">*</span><span class="n">path</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">SPLIT_PATH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sink</span> <span class="o">!=</span> <span class="n">E2SINK_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;alloc path 0x%x-&gt;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
			<span class="n">SEND_PSEL</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
			<span class="n">source</span> <span class="o">=</span> <span class="n">lbusin2out</span><span class="p">[</span><span class="n">sink</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">lbusin2out</span><span class="p">[</span><span class="n">sink</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">LS_MIXER_IN</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mixer</span><span class="p">)</span>
					<span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">sink</span> <span class="o">-</span> <span class="n">DIGITAL_MIXER_IN0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">LS_SRC_DECIMATORM</span> <span class="o">||</span>
			    <span class="n">type</span> <span class="o">==</span> <span class="n">LS_SRC_DECIMATOR</span> <span class="o">||</span>
			    <span class="n">type</span> <span class="o">==</span> <span class="n">LS_SRC_INTERPOLATORM</span> <span class="o">||</span>
			    <span class="n">type</span> <span class="o">==</span> <span class="n">LS_SRC_INTERPOLATOR</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
						<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="o">++</span> <span class="o">&amp;</span> <span class="n">SPLIT_PATH</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">npath</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">npath</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">npath</span><span class="o">++</span><span class="p">;</span>
			<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">source</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">++</span><span class="n">npath</span><span class="p">,</span> <span class="n">mixer</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">freelbuspath</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">path</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sink</span><span class="p">;</span>

		<span class="n">sink</span> <span class="o">=</span> <span class="o">*</span><span class="n">path</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">SPLIT_PATH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sink</span> <span class="o">!=</span> <span class="n">E2SINK_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;free path 0x%x-&gt;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
			<span class="n">SEND_PCLR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">);</span>
			<span class="n">source</span> <span class="o">=</span> <span class="n">lbusin2out</span><span class="p">[</span><span class="n">sink</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="o">++</span> <span class="o">&amp;</span> <span class="n">SPLIT_PATH</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">npath</span> <span class="o">=</span> <span class="n">path</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">npath</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">npath</span><span class="o">++</span><span class="p">;</span>
			<span class="n">freelbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">source</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">++</span><span class="n">npath</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writearm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">SEND_RMEM</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
	<span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SEND_SMEM</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">SEND_WMEM</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">(</span><span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">data</span><span class="p">));</span>
		<span class="n">SEND_RMEM</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;send arm 0x%x 0x%x 0x%x return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
		    <span class="n">flag</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sendcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">parm</span><span class="p">,</span>
		   <span class="k">union</span> <span class="n">cmdret</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">riptideport</span> <span class="o">*</span><span class="n">hwport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdport</span> <span class="o">*</span><span class="n">cmdport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cif</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">hwport</span> <span class="o">=</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">errcnt</span> <span class="o">&gt;</span> <span class="n">MAX_ERROR_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">is_reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;Riptide: Too many failed cmds, reinitializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">riptide_reset</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cif</span><span class="o">-&gt;</span><span class="n">errcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Riptide: Initialization failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span><span class="o">-&gt;</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">CMDIF_TIMEOUT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_READY</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">CMDIF_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="n">CMDIF_TIMEOUT</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">time</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">hwport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">j</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_DATF</span><span class="p">(</span><span class="n">cmdport</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* free pending data */</span>
			<span class="n">READ_PORT_ULONG</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">);</span>
			<span class="n">READ_PORT_ULONG</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CMDE</span><span class="p">(</span><span class="n">cmdport</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PARM</span><span class="p">)</span>	<span class="cm">/* put data */</span>
				<span class="n">WRITE_PORT_ULONG</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">,</span> <span class="n">parm</span><span class="p">);</span>
			<span class="n">WRITE_PORT_ULONG</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>	<span class="cm">/* write cmd */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_DATF</span><span class="p">(</span><span class="n">cmdport</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				       <span class="n">time</span> <span class="o">&lt;</span> <span class="n">CMDIF_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
					<span class="n">time</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">CMDIF_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* read response */</span>
					<span class="n">ret</span><span class="o">-&gt;</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">READ_PORT_ULONG</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">data1</span><span class="p">);</span>
					<span class="n">ret</span><span class="o">-&gt;</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">READ_PORT_ULONG</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">data2</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">==</span> <span class="n">CMDIF_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>

	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdcnt</span><span class="o">++</span><span class="p">;</span>		<span class="cm">/* update command statistics */</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtime</span> <span class="o">+=</span> <span class="n">time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemax</span><span class="p">)</span>
		<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemax</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemin</span><span class="p">)</span>
		<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemin</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdcnt</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_printdd</span>
		    <span class="p">(</span><span class="s">&quot;send cmd %d time: %d mintime: %d maxtime %d err: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdcnt</span><span class="p">,</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtime</span><span class="p">,</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemin</span><span class="p">,</span>
		     <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemax</span><span class="p">,</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

      <span class="nl">errout:</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
	<span class="n">snd_printdd</span>
	    <span class="p">(</span><span class="s">&quot;send cmd %d hw: 0x%x flag: 0x%x cmd: 0x%x parm: 0x%x ret: 0x%x 0x%x CMDE: %d DATF: %d failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdcnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">cmdport</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hwport</span><span class="p">),</span>
	     <span class="n">flags</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">parm</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	     <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span><span class="o">-&gt;</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IS_CMDE</span><span class="p">(</span><span class="n">cmdport</span><span class="p">),</span> <span class="n">IS_DATF</span><span class="p">(</span><span class="n">cmdport</span><span class="p">),</span>
	     <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setmixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">short</span> <span class="n">num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">lval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;sent mixer %d: 0x%d 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">SEND_SDGV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>
		<span class="n">SEND_RDGV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">lval</span> <span class="o">&amp;&amp;</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;sent mixer failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">getpaths</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">[</span><span class="n">E2SINK_MAX</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sink</span><span class="p">[</span><span class="n">E2SINK_MAX</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">E2SINK_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">getsourcesink</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">sink</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sink</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">E2SINK_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">o</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">sink</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">o</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">getsourcesink</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sink</span><span class="p">,</span>
	      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SEND_RSSV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SEND_RSSV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retbytes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retbytes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;getsourcesink 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">getsamplerate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">intdec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">intdec</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">SEND_RSRC</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">SEND_RSRC</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;rates differ %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;getsampleformat %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">*</span><span class="n">rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setsampleformat</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channels</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">w</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">order</span><span class="p">;</span>

	<span class="n">snd_printdd</span>
	    <span class="p">(</span><span class="s">&quot;setsampleformat mixer: %d id: %d channels: %d format: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">mixer</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sig</span> <span class="o">=</span> <span class="n">snd_pcm_format_unsigned</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">order</span> <span class="o">=</span> <span class="n">snd_pcm_format_big_endian</span><span class="p">(</span><span class="n">format</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SEND_SETF</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">mixer</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">SEND_SETF</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">mixer</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;setsampleformat failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">setsamplerate</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">intdec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">D</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;setsamplerate intdec: %d,%d rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">D</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">M</span> <span class="o">=</span> <span class="p">((</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">47999</span> <span class="o">:</span> <span class="n">rate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="n">N</span> <span class="o">=</span> <span class="n">M</span> <span class="o">%</span> <span class="n">D</span><span class="p">;</span>
	<span class="n">M</span> <span class="o">/=</span> <span class="n">D</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">intdec</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">SEND_SSRC</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">*</span><span class="n">intdec</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">);</span>
				<span class="n">SEND_RSRC</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">*</span><span class="n">intdec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">D</span> <span class="o">&amp;&amp;</span>
				 <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">M</span> <span class="o">&amp;&amp;</span>
				 <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">N</span> <span class="o">&amp;&amp;</span>
				 <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;sent samplerate %d: %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="o">*</span><span class="n">intdec</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">intdec</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">getmixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="kt">short</span> <span class="n">num</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">rval</span><span class="p">,</span>
	 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">lval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SEND_RDGV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">SEND_RDGV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rval</span> <span class="o">=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">lval</span> <span class="o">=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;got mixer %d: 0x%d 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="o">*</span><span class="n">rval</span><span class="p">,</span> <span class="o">*</span><span class="n">lval</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">riptide_handleirq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">[</span><span class="n">PLAYBACK_SUBSTREAMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">,</span> <span class="n">period_bytes</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgd</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cif</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PLAYBACK_SUBSTREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PLAYBACK_SUBSTREAMS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ST_STOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdbuf</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">flag</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dwStat_Ctl</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">EOB_STATUS</span><span class="p">)</span>
					<span class="n">pos</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dwSegLen</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">EOC_STATUS</span><span class="p">)</span>
					<span class="n">pos</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">dwSegLen</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">EOS_STATUS</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_PLAY</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_STOP</span><span class="p">;</span>
					<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						   <span class="s">&quot;Riptide: DMA stopped unexpectedly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">dwStat_Ctl</span> <span class="o">=</span>
				    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flag</span> <span class="o">&amp;</span>
						<span class="o">~</span><span class="p">(</span><span class="n">EOS_STATUS</span> <span class="o">|</span> <span class="n">EOB_STATUS</span> <span class="o">|</span>
						  <span class="n">EOC_STATUS</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">+=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">oldpos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ST_STOP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">period_bytes</span> <span class="o">=</span>
				    <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
						    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
				<span class="n">snd_printdd</span>
				    <span class="p">(</span><span class="s">&quot;interrupt 0x%x after 0x%lx of 0x%lx frames in period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">READ_AUDIO_STATUS</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">),</span>
				     <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">pos</span><span class="p">),</span>
				     <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
				<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">period_bytes</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">j</span><span class="o">++</span><span class="p">;</span>
					<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">period_bytes</span><span class="p">)</span>
						<span class="n">pos</span> <span class="o">-=</span> <span class="n">period_bytes</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">oldpos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">substream</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">riptide_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D3hot</span><span class="p">);</span>
	<span class="n">snd_pcm_suspend_all</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">snd_ac97_suspend</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">riptide_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;riptide: pci_enable_device failed, &quot;</span>
		       <span class="s">&quot;disabling device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_card_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_riptide_initialize</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">snd_ac97_resume</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">);</span>
	<span class="n">snd_power_change_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_POWER_D0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">in_suspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_to_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">firmware_version</span> <span class="n">firmware</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">ret</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WRITE_PORT_ULONG</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">WRITE_PORT_ULONG</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SET_GRESET</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">UNSET_GRESET</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">;</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_READY</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_GERR</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;Riptide: device not ready, audio status: 0x%x &quot;</span>
			   <span class="s">&quot;ready: %d gerr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">READ_AUDIO_STATUS</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">),</span>
			   <span class="n">IS_READY</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">),</span> <span class="n">IS_GERR</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printdd</span>
			<span class="p">(</span><span class="s">&quot;Riptide: audio status: 0x%x ready: %d gerr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">READ_AUDIO_STATUS</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">),</span>
			 <span class="n">IS_READY</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">),</span> <span class="n">IS_GERR</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">SEND_GETV</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firmware</span><span class="p">.</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Firmware version: ASIC: %d CODEC %d AUXDSP %d PROG %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">ASIC</span><span class="p">,</span> <span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">CODEC</span><span class="p">,</span>
		    <span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">AUXDSP</span><span class="p">,</span> <span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">PROG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIRMWARE_VERSIONS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firmware_versions</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">firmware</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">firmware</span><span class="p">)))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* OK */</span>

	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Writing Firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="s">&quot;riptide.hex&quot;</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;Riptide: Firmware not available %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">loadfirmware</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;Riptide: Could not load firmware %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">firmware</span> <span class="o">=</span> <span class="n">firmware</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* OK */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">riptide_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">tries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemin</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">errcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">is_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tries</span> <span class="o">=</span> <span class="n">RESET_TRIES</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">try_to_load_firmware</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">tries</span><span class="p">);</span>

	<span class="n">SEND_SACR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">);</span>
	<span class="n">SEND_RACR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">AC97_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;AC97: 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">SEND_PLST</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SEND_SLST</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SEND_DLST</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SEND_ALST</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">SEND_KDMA</span><span class="p">(</span><span class="n">cif</span><span class="p">);</span>

	<span class="n">writearm</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x301F8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writearm</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x301F4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">SEND_LSEL</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">MODEM_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MODEM_INTDEC</span><span class="p">,</span> <span class="n">MODEM_MERGER</span><span class="p">,</span>
		  <span class="n">MODEM_SPLITTER</span><span class="p">,</span> <span class="n">MODEM_MIXER</span><span class="p">);</span>
	<span class="n">setmixer</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">MODEM_MIXER</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO13</span><span class="p">,</span> <span class="n">lbus_play_modem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">SEND_LSEL</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">FM_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FM_INTDEC</span><span class="p">,</span> <span class="n">FM_MERGER</span><span class="p">,</span> <span class="n">FM_SPLITTER</span><span class="p">,</span>
		  <span class="n">FM_MIXER</span><span class="p">);</span>
	<span class="n">setmixer</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">FM_MIXER</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>
	<span class="n">writearm</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x30648</span> <span class="o">+</span> <span class="n">FM_MIXER</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">);</span>
	<span class="n">writearm</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x301A8</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">);</span>
	<span class="n">writearm</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mh">0x30264</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">OPL3_SAMPLE</span><span class="p">,</span> <span class="n">lbus_play_opl3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">SEND_SSRC</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">I2S_INTDEC</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">I2S_RATE</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48000</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">I2S_RATE</span> <span class="o">*</span> <span class="mi">65536</span><span class="p">)</span> <span class="o">%</span> <span class="mi">48000</span><span class="p">);</span>
	<span class="n">SEND_LSEL</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">I2S_CMD0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2S_INTDEC</span><span class="p">,</span> <span class="n">I2S_MERGER</span><span class="p">,</span> <span class="n">I2S_SPLITTER</span><span class="p">,</span>
		  <span class="n">I2S_MIXER</span><span class="p">);</span>
	<span class="n">SEND_SI2S</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">ARM2LBUS_FIFO0</span><span class="p">,</span> <span class="n">lbus_play_i2s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">lbus_play_out</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">DIGITAL_MIXER_OUT0</span><span class="p">,</span> <span class="n">lbus_play_outhp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">SET_AIACK</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="n">SET_AIE</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="n">SET_AIACK</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">is_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_riptide_playback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
	    <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span>
	    <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">5500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_riptide_capture</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
	    <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_S8</span>
	    <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">5500</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_riptide_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span>
					     <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">SEND_GPOS</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span>
		    <span class="p">(</span><span class="s">&quot;pointer stream %d position 0x%x(0x%x in buffer) bytes 0x%lx(0x%lx in period) frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
		     <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
		     <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
				     <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					    <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					    <span class="n">data</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">%</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;stream not started or strange parms (%d %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_RESUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ST_PLAY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SEND_SSTR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">SET_AIE</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_PLAY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
				<span class="n">setmixer</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">,</span> <span class="mh">0x7fff</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">openstreams</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">oldpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">pointer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_SUSPEND</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
			<span class="n">setmixer</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">setmixer</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">SEND_KSTR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_STOP</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">openstreams</span><span class="o">--</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">SEND_GPOS</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retlongs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Riptide: Could not stop stream!&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ST_PAUSE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SEND_PSTR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">ST_PAUSE</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">openstreams</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ST_PAUSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SEND_SSTR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ST_PAUSE</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">openstreams</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">lbuspath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">channels</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snd_pcm_format_t</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cif</span> <span class="o">||</span> <span class="o">!</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;prepare id %d ch: %d f:0x%x r:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span><span class="p">)</span>
			<span class="n">lbuspath</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">.</span><span class="n">noconv</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lbuspath</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">.</span><span class="n">mono</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="n">format</span> <span class="o">==</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span><span class="p">)</span>
			<span class="n">lbuspath</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">.</span><span class="n">noconv</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lbuspath</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">paths</span><span class="p">.</span><span class="n">stereo</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;use sgdlist at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">area</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pt</span><span class="p">,</span> <span class="n">period</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sgd</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
		<span class="n">period</span> <span class="o">=</span> <span class="n">frames_to_bytes</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">period_size</span><span class="p">);</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">period</span><span class="p">)</span>
			<span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
		<span class="n">snd_printdd</span>
		    <span class="p">(</span><span class="s">&quot;create sgd size: 0x%x pages %d of size 0x%x for period 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">size</span><span class="p">,</span> <span class="n">pages</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
		<span class="n">pt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
			<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdbuf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">dwNextLink</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span>
							    <span class="p">(</span><span class="n">i</span> <span class="o">*</span>
							     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
								    <span class="n">sgd</span><span class="p">)));</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dwNextLink</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">ofs</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">ofs</span><span class="p">)</span> <span class="o">+</span> <span class="n">pt</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dwSegPtrPhys</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">pt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span> <span class="o">%</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dwSegLen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">dwStat_Ctl</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IEOB_ENABLE</span> <span class="o">|</span> <span class="n">IEOS_ENABLE</span> <span class="o">|</span>
					<span class="n">IEOC_ENABLE</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">f</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdbuf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dwSegLen</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbuspath</span> <span class="o">&amp;&amp;</span> <span class="n">lbuspath</span> <span class="o">!=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span><span class="p">)</span>
			<span class="n">freelbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span><span class="p">);</span>
		<span class="n">alloclbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">lbuspath</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span> <span class="o">=</span> <span class="n">lbuspath</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">rate</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">!=</span> <span class="n">format</span> <span class="o">||</span>
	    <span class="n">data</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">!=</span> <span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setsampleformat</span>
		    <span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">format</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">setsamplerate</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">,</span> <span class="n">rate</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_riptide_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">sgdlist</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;hw params id %d (sgdlist: 0x%p 0x%lx %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
		    <span class="n">sgdlist</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sgdlist</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sgdlist</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sgdlist</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">)</span>
		<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="n">sgdlist</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span>
				       <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">DESC_MAX_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
				       <span class="n">sgdlist</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Riptide: failed to alloc %d dma bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgd</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">DESC_MAX_MASK</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgd</span> <span class="o">*</span><span class="p">)</span><span class="n">sgdlist</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span>
					<span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cif</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span><span class="p">)</span>
			<span class="n">freelbuspath</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">lbuspath</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">sgdlist</span><span class="p">.</span><span class="n">area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sub_num</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">sub_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_riptide_playback</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmhw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">paths</span> <span class="o">=</span> <span class="n">lbus_play_paths</span><span class="p">[</span><span class="n">sub_num</span><span class="p">];</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">play_ids</span><span class="p">[</span><span class="n">sub_num</span><span class="p">];</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">play_sources</span><span class="p">[</span><span class="n">sub_num</span><span class="p">];</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_STOP</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_riptide_capture</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmhw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">paths</span> <span class="o">=</span> <span class="n">lbus_rec_path</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">PADC</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">ACLNK2PADC</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ST_STOP</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_playback_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sub_num</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">sub_num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">get_pcmhwdev</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_riptide_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_riptide_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_riptide_playback_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_riptide_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_riptide_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_riptide_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_riptide_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_riptide_pointer</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_riptide_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_riptide_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_riptide_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_riptide_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_riptide_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_riptide_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_riptide_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_riptide_pointer</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_riptide_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">**</span><span class="n">rpcm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span>
	     <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;RIPTIDE&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">PLAYBACK_SUBSTREAMS</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			 <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_riptide_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_riptide_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;RIPTIDE&quot;</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
					      <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpcm</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rpcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">snd_riptide_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">received_irqs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_EOBIRQ</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_EOSIRQ</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_EOCIRQ</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">handled_irqs</span><span class="o">++</span><span class="p">;</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">riptide_tq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span> <span class="o">&amp;&amp;</span> <span class="n">IS_MPUIRQ</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">handled_irqs</span><span class="o">++</span><span class="p">;</span>
			<span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span>
						  <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">SET_AIACK</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_riptide_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cif</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Write AC97 reg 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">SEND_SACR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">SEND_RACR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">MAX_WRITE_RETRY</span><span class="p">)</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Write AC97 reg failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">snd_riptide_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span><span class="n">ac97</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">ac97</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">cmdret</span> <span class="n">rptr</span> <span class="o">=</span> <span class="n">CMDRET_ZERO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">cif</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SEND_RACR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">SEND_RACR</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rptr</span><span class="p">);</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Read AC97 reg 0x%x got 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">rptr</span><span class="p">.</span><span class="n">retwords</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">device_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cif</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmdif</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">riptideport</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span> <span class="o">=</span> <span class="n">cif</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cif</span><span class="o">-&gt;</span><span class="n">is_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">riptide_reset</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">device_id</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">device_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x4310</span>:
	<span class="k">case</span> <span class="mh">0x4320</span>:
	<span class="k">case</span> <span class="mh">0x4330</span>:
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Modem enable?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">SEND_SETDPLL</span><span class="p">(</span><span class="n">cif</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Enabling MPU IRQs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span>
		<span class="n">SET_EMPUIRQ</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SET_GRESET</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">UNSET_GRESET</span><span class="p">(</span><span class="n">cif</span><span class="o">-&gt;</span><span class="n">hwport</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="n">release_and_free_resource</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_port</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_riptide_dev_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">device_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_riptide_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_riptide_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">**</span><span class="n">rchip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">riptideport</span> <span class="o">*</span><span class="n">hwport</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_device_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">dev_free</span> <span class="o">=</span> <span class="n">snd_riptide_dev_free</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">openstreams</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">received_irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">handled_irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">riptide_tq</span><span class="p">,</span> <span class="n">riptide_handleirq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">res_port</span> <span class="o">=</span>
	     <span class="n">request_region</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;RIPTIDE&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			   <span class="s">&quot;Riptide: unable to grab region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="mi">64</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">snd_riptide_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwport</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">riptideport</span> <span class="o">*</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">UNSET_AIE</span><span class="p">(</span><span class="n">hwport</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_riptide_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Riptide: unable to grab IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">snd_riptide_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_riptide_initialize</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_riptide_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_device_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_DEV_LOWLEVEL</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_riptide_free</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">rchip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_riptide_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmhw</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmdif</span> <span class="o">*</span><span class="n">cif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Device ID: 0x%x</span><span class="se">\n</span><span class="s">Received IRQs: (%ld)%ld</span><span class="se">\n</span><span class="s">Ports:&quot;</span><span class="p">,</span>
		    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">device_id</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">handled_irqs</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">received_irqs</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%c%02x: %08x&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39; &#39;</span> <span class="o">:</span> <span class="sc">&#39;\n&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inl</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cif</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="s">&quot;</span><span class="se">\n</span><span class="s">Version: ASIC: %d CODEC: %d AUXDSP: %d PROG: %d&quot;</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">ASIC</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">CODEC</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">AUXDSP</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">.</span><span class="n">firmware</span><span class="p">.</span><span class="n">PROG</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Digital mixer:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">getmixer</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rval</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lval</span><span class="p">);</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> %d: %d %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">rval</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="s">&quot;</span><span class="se">\n</span><span class="s">ARM Commands num: %d failed: %d time: %d max: %d min: %d&quot;</span><span class="p">,</span>
			    <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdcnt</span><span class="p">,</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">errcnt</span><span class="p">,</span>
			    <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtime</span><span class="p">,</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemax</span><span class="p">,</span> <span class="n">cif</span><span class="o">-&gt;</span><span class="n">cmdtimemin</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Open streams %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">openstreams</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PLAYBACK_SUBSTREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
		    <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">runtime</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
				    <span class="s">&quot;stream: %d mixer: %d source: %d (%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span>
				    <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">getsamplerate</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">)))</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span>
	    <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="o">-&gt;</span><span class="n">runtime</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="s">&quot;stream: %d mixer: %d source: %d (%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span>
			    <span class="n">data</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">getsamplerate</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">intdec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">)))</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Paths:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">getpaths</span><span class="p">(</span><span class="n">cif</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%x-&gt;%x &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_riptide_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;riptide&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">snd_riptide_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_riptide_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_ac97_bus</span> <span class="o">*</span><span class="n">pbus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ac97_template</span> <span class="n">ac97</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_ac97_bus_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">snd_riptide_codec_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">snd_riptide_codec_read</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ac97</span><span class="p">));</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">scaps</span> <span class="o">=</span> <span class="n">AC97_SCAP_SKIP_MODEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_bus</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbus</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97_bus</span> <span class="o">=</span> <span class="n">pbus</span><span class="p">;</span>
	<span class="n">ac97</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ac97_mixer</span><span class="p">(</span><span class="n">pbus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac97</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ac97</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_riptide_joystick_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="o">++</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">gameport</span> <span class="o">=</span> <span class="n">gameport_allocate_port</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gameport</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;Riptide gameport&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			   <span class="s">&quot;Riptide: cannot grab gameport 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">]);</span>
		<span class="n">gameport_free_port</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gameport</span><span class="o">-&gt;</span><span class="n">io</span> <span class="o">=</span> <span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
	<span class="n">gameport_register_port</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">gameport</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_riptide_joystick_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gameport</span> <span class="o">*</span><span class="n">gameport</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gameport</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">gameport</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">gameport_unregister_port</span><span class="p">(</span><span class="n">gameport</span><span class="p">);</span>
		<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">snd_card_riptide_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_riptide</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_riptide_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_riptide_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_riptide_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">LEGACY_ENABLE_ALL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opl3_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LEGACY_ENABLE_FM</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LEGACY_ENABLE_GAMEPORT</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">LEGACY_ENABLE_MPU_INT</span> <span class="o">|</span> <span class="n">LEGACY_ENABLE_MPU</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_EXT_Legacy_Mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mpu_port</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_EXT_MPU_Base</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_mpu401_uart_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPU401_HW_RIPTIDE</span><span class="p">,</span>
					  <span class="n">val</span><span class="p">,</span> <span class="n">MPU401_INFO_IRQ_HOOK</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				   <span class="s">&quot;Riptide: Can&#39;t Allocate MPU at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpuaddr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opl3_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">opl3_port</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_EXT_FM_Base</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				      <span class="n">OPL3_HW_RIPTIDE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">opl3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
				   <span class="s">&quot;Riptide: Can&#39;t Allocate OPL3 at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">val</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">opladdr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_opl3_hwdep_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">opl3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
					   <span class="s">&quot;Riptide: Can&#39;t Allocate OPL3-HWDEP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">joystick_port</span><span class="p">[</span><span class="n">dev</span><span class="p">];</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_EXT_Game_Base</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameaddr</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;RIPTIDE&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Riptide&quot;</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s at 0x%lx, irq %i mpu 0x%x opl3 0x%x gameport 0x%x&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpuaddr</span><span class="p">,</span>
		 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">opladdr</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">gameaddr</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s at 0x%lx, irq %i mpu 0x%x opl3 0x%x&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mpuaddr</span><span class="p">,</span>
		 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">opladdr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">snd_riptide_proc_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">error:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_card_riptide_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_riptide_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_card_riptide_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_card_riptide_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">riptide_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">riptide_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#ifdef SUPPORT_JOYSTICK</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">joystick_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;-joystick&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_riptide_joystick_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_riptide_joystick_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_riptide_joystick_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">alsa_card_riptide_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#if defined(SUPPORT_JOYSTICK)</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">joystick_driver</span><span class="p">);</span>
	<span class="cm">/* On failure unregister formerly registered audio driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">alsa_card_riptide_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="p">);</span>
<span class="cp">#if defined(SUPPORT_JOYSTICK)</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">joystick_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">alsa_card_riptide_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">alsa_card_riptide_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
