<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › au88x0 › au88x0_core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>au88x0_core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU Library General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">    Vortex core low level functions.</span>
<span class="cm">	</span>
<span class="cm"> Author: Manuel Jander (mjander@users.sourceforge.cl)</span>
<span class="cm"> These functions are mainly the result of translations made</span>
<span class="cm"> from the original disassembly of the au88x0 binary drivers,</span>
<span class="cm"> written by Aureal before they went down.</span>
<span class="cm"> Many thanks to the Jeff Muizelaar, Kester Maddock, and whoever</span>
<span class="cm"> contributed to the OpenVortex project.</span>
<span class="cm"> The author of this file, put the few available pieces together</span>
<span class="cm"> and translated the rest of the riddle (Mix, Src and connection stuff).</span>
<span class="cm"> Some things are still to be discovered, and their meanings are unclear.</span>

<span class="cm"> Some of these functions aren&#39;t intended to be really used, rather</span>
<span class="cm"> to help to understand how does the AU88X0 chips work. Keep them in, because</span>
<span class="cm"> they could be used somewhere in the future.</span>

<span class="cm"> This code hasn&#39;t been tested or proof read thoroughly. If you wanna help,</span>
<span class="cm"> take a look at the AU88X0 assembly and check if this matches.</span>
<span class="cm"> Functions tested ok so far are (they show the desired effect</span>
<span class="cm"> at least):</span>
<span class="cm">   vortex_routes(); (1 bug fixed).</span>
<span class="cm">   vortex_adb_addroute();</span>
<span class="cm">   vortex_adb_addroutes();</span>
<span class="cm">   vortex_connect_codecplay();</span>
<span class="cm">   vortex_src_flushbuffers();</span>
<span class="cm">   vortex_adbdma_setmode();  note: still some unknown arguments!</span>
<span class="cm">   vortex_adbdma_startfifo();</span>
<span class="cm">   vortex_adbdma_stopfifo();</span>
<span class="cm">   vortex_fifo_setadbctrl(); note: still some unknown arguments!</span>
<span class="cm">   vortex_mix_setinputvolumebyte();</span>
<span class="cm">   vortex_mix_enableinput();</span>
<span class="cm">   vortex_mixer_addWTD(); (fixed)</span>
<span class="cm">   vortex_connection_adbdma_src_src();</span>
<span class="cm">   vortex_connection_adbdma_src();</span>
<span class="cm">   vortex_src_change_convratio();</span>
<span class="cm">   vortex_src_addWTD(); (fixed)</span>

<span class="cm"> History:</span>

<span class="cm"> 01-03-2003 First revision.</span>
<span class="cm"> 01-21-2003 Some bug fixes.</span>
<span class="cm"> 17-02-2003 many bugfixes after a big versioning mess.</span>
<span class="cm"> 18-02-2003 JAAAAAHHHUUUUUU!!!! The mixer works !! I&#39;m just so happy !</span>
<span class="cm">			 (2 hours later...) I cant believe it! Im really lucky today.</span>
<span class="cm">			 Now the SRC is working too! Yeah! XMMS works !</span>
<span class="cm"> 20-02-2003 First steps into the ALSA world.</span>
<span class="cm"> 28-02-2003 As my birthday present, i discovered how the DMA buffer pages really</span>
<span class="cm">            work :-). It was all wrong.</span>
<span class="cm"> 12-03-2003 ALSA driver starts working (2 channels).</span>
<span class="cm"> 16-03-2003 More srcblock_setupchannel discoveries.</span>
<span class="cm"> 12-04-2003 AU8830 playback support. Recording in the works.</span>
<span class="cm"> 17-04-2003 vortex_route() and vortex_routes() bug fixes. AU8830 recording</span>
<span class="cm"> 			works now, but chipn&#39; dale effect is still there.</span>
<span class="cm"> 16-05-2003 SrcSetupChannel cleanup. Moved the Src setup stuff entirely</span>
<span class="cm">            into au88x0_pcm.c .</span>
<span class="cm"> 06-06-2003 Buffer shifter bugfix. Mixer volume fix.</span>
<span class="cm"> 07-12-2003 A3D routing finally fixed. Believed to be OK.</span>
<span class="cm"> 25-03-2004 Many thanks to Claudia, for such valuable bug reports.</span>
<span class="cm"> </span>
<span class="cm">*/</span>

<span class="cp">#include &quot;au88x0.h&quot;</span>
<span class="cp">#include &quot;au88x0_a3d.h&quot;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cm">/*  MIXER (CAsp4Mix.s and CAsp4Mixer.s) */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>FIXME: get rid of this.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="n">mchannels</span><span class="p">[</span><span class="n">NR_MIXIN</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rampchs</span><span class="p">[</span><span class="n">NR_MIXIN</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_mixer_en_sr</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_mixer_dis_sr</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void</span>
<span class="c">vortex_mix_muteinputgain(vortex_t * vortex, unsigned char mix,</span>
<span class="c">			 unsigned char channel)</span>
<span class="c">{</span>
<span class="c">	hwwrite(vortex-&gt;mmio, VORTEX_MIX_INVOL_A + ((mix &lt;&lt; 5) + channel),</span>
<span class="c">		0x80);</span>
<span class="c">	hwwrite(vortex-&gt;mmio, VORTEX_MIX_INVOL_B + ((mix &lt;&lt; 5) + channel),</span>
<span class="c">		0x80);</span>
<span class="c">}</span>

<span class="c">static int vortex_mix_getvolume(vortex_t * vortex, unsigned char mix)</span>
<span class="c">{</span>
<span class="c">	int a;</span>
<span class="c">	a = hwread(vortex-&gt;mmio, VORTEX_MIX_VOL_A + (mix &lt;&lt; 2)) &amp; 0xff;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FP2LinearFrac(a);</p></td><td class="code"><div class="highlight"><pre><span class="c">	return (a);</span>
<span class="c">}</span>

<span class="c">static int</span>
<span class="c">vortex_mix_getinputvolume(vortex_t * vortex, unsigned char mix,</span>
<span class="c">			  int channel, int *vol)</span>
<span class="c">{</span>
<span class="c">	int a;</span>
<span class="c">	if (!(mchannels[mix] &amp; (1 &lt;&lt; channel)))</span>
<span class="c">		return 0;</span>
<span class="c">	a = hwread(vortex-&gt;mmio,</span>
<span class="c">		   VORTEX_MIX_INVOL_A + (((mix &lt;&lt; 5) + channel) &lt;&lt; 2));</span>
<span class="c">	/*</span>
<span class="c">	   if (rampchs[mix] == 0)</span>
<span class="c">	   a = FP2LinearFrac(a);</span>
<span class="c">	   else</span>
<span class="c">	   a = FP2LinearFracWT(a);</span>
<span class="c">	 */</span>
<span class="c">	*vol = a;</span>
<span class="c">	return (0);</span>
<span class="c">}</span>

<span class="c">static unsigned int vortex_mix_boost6db(unsigned char vol)</span>
<span class="c">{</span>
<span class="c">	return (vol + 8);	/* WOW! what a complex function! */</span>
<span class="c">}</span>

<span class="c">static void vortex_mix_rampvolume(vortex_t * vortex, int mix)</span>
<span class="c">{</span>
<span class="c">	int ch;</span>
<span class="c">	char a;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>This function is intended for ramping down only (see vortex_disableinput()).</p></td><td class="code"><div class="highlight"><pre><span class="c">	for (ch = 0; ch &lt; 0x20; ch++) {</span>
<span class="c">		if (((1 &lt;&lt; ch) &amp; rampchs[mix]) == 0)</span>
<span class="c">			continue;</span>
<span class="c">		a = hwread(vortex-&gt;mmio,</span>
<span class="c">			   VORTEX_MIX_INVOL_B + (((mix &lt;&lt; 5) + ch) &lt;&lt; 2));</span>
<span class="c">		if (a &gt; -126) {</span>
<span class="c">			a -= 2;</span>
<span class="c">			hwwrite(vortex-&gt;mmio,</span>
<span class="c">				VORTEX_MIX_INVOL_A +</span>
<span class="c">				(((mix &lt;&lt; 5) + ch) &lt;&lt; 2), a);</span>
<span class="c">			hwwrite(vortex-&gt;mmio,</span>
<span class="c">				VORTEX_MIX_INVOL_B +</span>
<span class="c">				(((mix &lt;&lt; 5) + ch) &lt;&lt; 2), a);</span>
<span class="c">		} else</span>
<span class="c">			vortex_mix_killinput(vortex, mix, ch);</span>
<span class="c">	}</span>
<span class="c">}</span>

<span class="c">static int</span>
<span class="c">vortex_mix_getenablebit(vortex_t * vortex, unsigned char mix, int mixin)</span>
<span class="c">{</span>
<span class="c">	int addr, temp;</span>
<span class="c">	if (mixin &gt;= 0)</span>
<span class="c">		addr = mixin;</span>
<span class="c">	else</span>
<span class="c">		addr = mixin + 3;</span>
<span class="c">	addr = ((mix &lt;&lt; 3) + (addr &gt;&gt; 2)) &lt;&lt; 2;</span>
<span class="c">	temp = hwread(vortex-&gt;mmio, VORTEX_MIX_ENIN + addr);</span>
<span class="c">	return ((temp &gt;&gt; (mixin &amp; 3)) &amp; 1);</span>
<span class="c">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_mix_setvolumebyte</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_VOL_A</span> <span class="o">+</span> <span class="p">(</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">vol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/*if (this_10) */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_VOL_B</span> <span class="o">+</span> <span class="p">(</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vol</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_VOL_B</span> <span class="o">+</span> <span class="p">(</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">vol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">mixin</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
		<span class="n">VORTEX_MIX_INVOL_A</span> <span class="o">+</span> <span class="p">(((</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mixin</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">vol</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* this_10, initialized to 1. */</span>
		<span class="n">temp</span> <span class="o">=</span>
		    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			   <span class="n">VORTEX_MIX_INVOL_B</span> <span class="o">+</span> <span class="p">(((</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mixin</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vol</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
		<span class="n">VORTEX_MIX_INVOL_B</span> <span class="o">+</span> <span class="p">(((</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mixin</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">vol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_mix_setenablebit</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mixin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mixin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">mixin</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">mixin</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_ENIN</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">mixin</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">mixin</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="cm">/* Mute input. Astatic void crackling? */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
		<span class="n">VORTEX_MIX_INVOL_B</span> <span class="o">+</span> <span class="p">(((</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mixin</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="cm">/* Looks like clear buffer. */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_SMP</span> <span class="o">+</span> <span class="p">(</span><span class="n">mixin</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_SMP</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">mixin</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="cm">/* Write enable bit. */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIX_ENIN</span> <span class="o">+</span> <span class="n">addr</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_mix_killinput</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mixin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rampchs</span><span class="p">[</span><span class="n">mix</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mixin</span><span class="p">);</span>
	<span class="n">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">mchannels</span><span class="p">[</span><span class="n">mix</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mixin</span><span class="p">);</span>
	<span class="n">vortex_mix_setenablebit</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_mix_enableinput</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mixin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_mix_killinput</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mchannels</span><span class="p">[</span><span class="n">mix</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mixin</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>	<span class="cm">/*0x80 : mute */</span>
		<span class="n">mchannels</span><span class="p">[</span><span class="n">mix</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mixin</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vortex_mix_setenablebit</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_mix_disableinput</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">ramp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ramp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rampchs</span><span class="p">[</span><span class="n">mix</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Register callback.
vortex<em>mix</em>startrampvolume(vortex);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">vortex_mix_killinput</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vortex_mix_killinput</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_mixer_addWTD</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mix</span><span class="p">);</span>
		<span class="n">vortex_mixer_en_sr</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">VORTEX_MIXER_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>printk(KERN_INFO "vortex: mixAddWTD: while addr=%x, val=%x\n", prev, temp);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">lifeboat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;vortex_mixer_addWTD: lifeboat overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">mix</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_mixer_delWTD</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">esp14</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">esp18</span><span class="p">,</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">edx</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>int esp1f=edi(while)=src, esp10=ch;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">eax</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">eax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;mix ALARM %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eax</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ebp</span> <span class="o">=</span> <span class="n">VORTEX_MIXER_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">esp18</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp18</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ebx</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp18</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mix</span> <span class="o">==</span> <span class="n">ebx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ebx</span> <span class="o">=</span> <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">mix</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">edx</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>7b60</p></td><td class="code"><div class="highlight"><pre>			<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">edx</span><span class="p">);</span>
			<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>7ad3</p></td><td class="code"><div class="highlight"><pre>			<span class="n">edx</span> <span class="o">=</span>
			    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
				   <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ebx</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>printk(KERN_INFO "vortex: mixdelWTD: 1 addr=%x, val=%x, src=%x\n", ebx, edx, src);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mix</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">esi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					       <span class="s">&quot;vortex: mixdelWTD: error lifeboat overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">esp14</span> <span class="o">=</span> <span class="n">ebx</span><span class="p">;</span>
				<span class="n">ebx</span> <span class="o">=</span> <span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">ebp</span> <span class="o">=</span> <span class="n">ebx</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">edx</span> <span class="o">=</span>
				    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
					   <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="n">ebp</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>printk(KERN_INFO "vortex: mixdelWTD: while addr=%x, val=%x\n", ebp, edx);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">esi</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>7b30</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ebp</span> <span class="o">=</span> <span class="n">ebx</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Delete entry in between others */</span>
				<span class="n">ebx</span> <span class="o">=</span> <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">edx</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>7b60</p></td><td class="code"><div class="highlight"><pre>				<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
					<span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">edx</span><span class="p">);</span>
				<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>printk(KERN_INFO "vortex mixdelWTD between addr= 0x%x, val= 0x%x\n", ebp, edx);</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Delete last entry */</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>7b83</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">esp14</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
						<span class="n">VORTEX_MIXER_CHNBASE</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">esp18</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">ebx</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffe0</span> <span class="o">&amp;</span> <span class="n">edx</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&amp;</span> <span class="n">ebx</span><span class="p">);</span>
					<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
						<span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">esp14</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ebx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>printk(KERN_INFO "vortex mixdelWTD last addr= 0x%x, val= 0x%x\n", esp14, ebx);</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span>
				<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
					<span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="n">ebp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>printk(KERN_INFO "removed last mix\n");
7be0</p></td><td class="code"><div class="highlight"><pre>		<span class="n">vortex_mixer_dis_sr</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_mixer_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>FIXME: get rid of this crap.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="n">mchannels</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NR_MIXOUT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rampchs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NR_MIXOUT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_SMP</span> <span class="o">+</span> <span class="mh">0x17c</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0x5f</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_ENIN</span> <span class="o">+</span> <span class="mh">0x1fc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_SMP</span> <span class="o">+</span> <span class="mh">0x17c</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0x5f</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_INVOL_A</span> <span class="o">+</span> <span class="mh">0x7fc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0x1ff</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_VOL_A</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_INVOL_B</span> <span class="o">+</span> <span class="mh">0x7fc</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0x1ff</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIX_VOL_B</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_MIXER_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">MIXER_RTBASE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIXER_RTBASE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_MIXER_SR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set clipping ceiling (this may be all wrong). */</span>
	<span class="cm">/*</span>
<span class="cm">	for (x = 0; x &lt; 0x80; x++) {</span>
<span class="cm">		hwwrite(vortex-&gt;mmio, VORTEX_MIXER_CLIP + (x &lt;&lt; 2), 0x3ffff);</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>
	<span class="cm">/*</span>
<span class="cm">	   call CAsp4Mix__Initialize_CAsp4HwIO____CAsp4Mixer____</span>
<span class="cm">	   Register ISR callback for volume smooth fade out.</span>
<span class="cm">	   Maybe this avoids clicks when press &quot;stop&quot; ?</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cm">/*  SRC (CAsp4Src.s and CAsp4SrcBlock) */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_src_en_sr</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRCBLOCK_SR</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRCBLOCK_SR</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_src_dis_sr</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRCBLOCK_SR</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRCBLOCK_SR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_src_flushbuffers</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_SRC_DATA0</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_DATA</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_src_cleardrift</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_DRIFT0</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_DRIFT1</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_DRIFT2</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_src_set_throttlesource</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_SOURCE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">src</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_SOURCE</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_src_persist_convratio</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_CONVRATIO</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ratio</span><span class="p">);</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_CONVRATIO</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">lifeboat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Vortex: Src cvr fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">ratio</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void vortex_src_slowlock(vortex_t * vortex, unsigned char src)</span>
<span class="c">{</span>
<span class="c">	int temp;</span>

<span class="c">	hwwrite(vortex-&gt;mmio, VORTEX_SRC_DRIFT2 + (src &lt;&lt; 2), 1);</span>
<span class="c">	hwwrite(vortex-&gt;mmio, VORTEX_SRC_DRIFT0 + (src &lt;&lt; 2), 0);</span>
<span class="c">	temp = hwread(vortex-&gt;mmio, VORTEX_SRC_U0 + (src &lt;&lt; 2));</span>
<span class="c">	if (temp &amp; 0x200)</span>
<span class="c">		hwwrite(vortex-&gt;mmio, VORTEX_SRC_U0 + (src &lt;&lt; 2),</span>
<span class="c">			temp &amp; ~0x200L);</span>
<span class="c">}</span>

<span class="c">static void</span>
<span class="c">vortex_src_change_convratio(vortex_t * vortex, unsigned char src, int ratio)</span>
<span class="c">{</span>
<span class="c">	int temp, a;</span>

<span class="c">	if ((ratio &amp; 0x10000) &amp;&amp; (ratio != 0x10000)) {</span>
<span class="c">		if (ratio &amp; 0x3fff)</span>
<span class="c">			a = (0x11 - ((ratio &gt;&gt; 0xe) &amp; 0x3)) - 1;</span>
<span class="c">		else</span>
<span class="c">			a = (0x11 - ((ratio &gt;&gt; 0xe) &amp; 0x3)) - 2;</span>
<span class="c">	} else</span>
<span class="c">		a = 0xc;</span>
<span class="c">	temp = hwread(vortex-&gt;mmio, VORTEX_SRC_U0 + (src &lt;&lt; 2));</span>
<span class="c">	if (((temp &gt;&gt; 4) &amp; 0xf) != a)</span>
<span class="c">		hwwrite(vortex-&gt;mmio, VORTEX_SRC_U0 + (src &lt;&lt; 2),</span>
<span class="c">			(temp &amp; 0xf) | ((a &amp; 0xf) &lt;&lt; 4));</span>

<span class="c">	vortex_src_persist_convratio(vortex, src, ratio);</span>
<span class="c">}</span>

<span class="c">static int</span>
<span class="c">vortex_src_checkratio(vortex_t * vortex, unsigned char src,</span>
<span class="c">		      unsigned int desired_ratio)</span>
<span class="c">{</span>
<span class="c">	int hw_ratio, lifeboat = 0;</span>

<span class="c">	hw_ratio = hwread(vortex-&gt;mmio, VORTEX_SRC_CONVRATIO + (src &lt;&lt; 2));</span>

<span class="c">	while (hw_ratio != desired_ratio) {</span>
<span class="c">		hwwrite(vortex-&gt;mmio, VORTEX_SRC_CONVRATIO + (src &lt;&lt; 2), desired_ratio);</span>

<span class="c">		if ((lifeboat++) &gt; 15) {</span>
<span class="c">			printk(KERN_ERR &quot;Vortex: could not set src-%d from %d to %d\n&quot;,</span>
<span class="c">			       src, hw_ratio, desired_ratio);</span>
<span class="c">			break;</span>
<span class="c">		}</span>
<span class="c">	}</span>

<span class="c">	return hw_ratio;</span>
<span class="c">}</span>

<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> Objective: Set samplerate for given SRC module.</span>
<span class="cm"> Arguments:</span>
<span class="cm">	card:	pointer to vortex_t strcut.</span>
<span class="cm">	src:	Integer index of the SRC module.</span>
<span class="cm">	cr:		Current sample rate conversion factor.</span>
<span class="cm">	b:		unknown 16 bit value.</span>
<span class="cm">	sweep:	Enable Samplerate fade from cr toward tr flag.</span>
<span class="cm">	dirplay: 1: playback, 0: recording.</span>
<span class="cm">	sl:		Slow Lock flag.</span>
<span class="cm">	tr:		Target samplerate conversion.</span>
<span class="cm">	thsource: Throttle source flag (no idea what that means).</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_src_setupchannel</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sweep</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">dirplay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sl</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">thsource</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>noplayback: d=2,4,7,0xa,0xb when using first 2 src's.
c: enables pitch sweep.
looks like g is c related. Maybe g is a sweep parameter ?
g = cvr
dirplay: 0 = recording, 1 = playback
d = src hw index.</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">esi</span><span class="p">,</span> <span class="n">ebp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">esp10</span><span class="p">;</span>

	<span class="n">vortex_src_flushbuffers</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sweep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tr</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tr</span> <span class="o">!=</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">esi</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((((</span><span class="kt">short</span><span class="p">)</span><span class="n">tr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tr</span> <span class="o">!=</span> <span class="mh">0x8000</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">esi</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">esi</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cr</span> <span class="o">!=</span> <span class="mh">0x10000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*ebx = 0 */</span>
			<span class="n">esi</span> <span class="o">=</span> <span class="mh">0x11</span> <span class="o">-</span> <span class="p">((</span><span class="n">cr</span> <span class="o">&gt;&gt;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span>
				<span class="n">esi</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">esi</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">esi</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">vortex_src_cleardrift</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">vortex_src_set_throttlesource</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">thsource</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dirplay</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sweep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="p">)</span>
			<span class="n">esp10</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">esp10</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
		<span class="n">ebp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tr</span><span class="p">)</span>
			<span class="n">ebp</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ebp</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
		<span class="n">esp10</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_U0</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="n">sl</span> <span class="o">&lt;&lt;</span> <span class="mh">0x9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sweep</span> <span class="o">&lt;&lt;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">esi</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">d</span><span class="p">);</span>
	<span class="cm">/* 0xc0   esi=0xc c=f=0 d=0 */</span>
	<span class="n">vortex_src_persist_convratio</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">cr</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_U1</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="cm">/* 0   b=0 */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_U2</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="n">tr</span> <span class="o">&lt;&lt;</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dirplay</span> <span class="o">&lt;&lt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ebp</span> <span class="o">&lt;&lt;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">|</span> <span class="n">esp10</span><span class="p">);</span>
	<span class="cm">/* 0x30f00 e=g=1 esp10=0 ebp=f */</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>printk(KERN_INFO "vortex: SRC %d, d=0x%x, esi=0x%x, esp10=0x%x, ebp=0x%x\n", src, d, esi, esp10, ebp);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_srcblock_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_SOURCESIZE</span><span class="p">,</span> <span class="mh">0x1ff</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	   for (x=0; x&lt;0x10; x++) {</span>
<span class="cm">	   vortex_src_init(&amp;vortex_src[x], x);</span>
<span class="cm">	   }</span>
<span class="cm">	 */</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>addr = 0xcc3c;
addr = 0x26c3c;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="mh">0x3c</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>addr = 0xcc94;
addr = 0x26c94;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_SRC_CHNBASE</span> <span class="o">+</span> <span class="mh">0x54</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mh">0x15</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_src_addWTD</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>esp13 = src</p></td><td class="code"><div class="highlight"><pre>	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRCBLOCK_SR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">src</span><span class="p">);</span>
		<span class="n">vortex_src_en_sr</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="n">VORTEX_SRC_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/*ebp */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>while (temp &amp; NR_SRC) {</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/*esp12 */</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>prev = VORTEX<em>SRC</em>RTBASE + ((temp &amp; (NR_SRC-1)) &lt;&lt; 2); /<em>esp12</em>/</p></td><td class="code"><div class="highlight"><pre>		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">prev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>printk(KERN_INFO "vortex: srcAddWTD: while addr=%x, val=%x\n", prev, temp);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">lifeboat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;vortex_src_addWTD: lifeboat overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">src</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>hwwrite(vortex->mmio, prev, (temp &amp; (NR<em>SRC-1)) | NR</em>SRC);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_src_delWTD</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">esp14</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">esp18</span><span class="p">,</span> <span class="n">eax</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="n">edx</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">esi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>int esp1f=edi(while)=src, esp10=ch;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">eax</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SRCBLOCK_SR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ch</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">eax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;src alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ebp</span> <span class="o">=</span> <span class="n">VORTEX_SRC_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">esp18</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">esp18</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ebx</span> <span class="o">=</span> <span class="p">(</span><span class="n">esp18</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">==</span> <span class="n">ebx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ebx</span> <span class="o">=</span> <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">src</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">edx</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>7b60</p></td><td class="code"><div class="highlight"><pre>			<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">edx</span><span class="p">);</span>
			<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>7ad3</p></td><td class="code"><div class="highlight"><pre>			<span class="n">edx</span> <span class="o">=</span>
			    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
				   <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ebx</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>printk(KERN_INFO "vortex: srcdelWTD: 1 addr=%x, val=%x, src=%x\n", ebx, edx, src);</p></td><td class="code"><div class="highlight"><pre>			<span class="k">while</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">!=</span> <span class="n">src</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">esi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;vortex: srcdelWTD: error, lifeboat overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">esp14</span> <span class="o">=</span> <span class="n">ebx</span><span class="p">;</span>
				<span class="n">ebx</span> <span class="o">=</span> <span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
				<span class="n">ebp</span> <span class="o">=</span> <span class="n">ebx</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">edx</span> <span class="o">=</span>
				    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
					   <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="n">ebp</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>printk(KERN_INFO "vortex: srcdelWTD: while addr=%x, val=%x\n", ebp, edx);</p></td><td class="code"><div class="highlight"><pre>				<span class="n">esi</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>7b30</p></td><td class="code"><div class="highlight"><pre>			<span class="n">ebp</span> <span class="o">=</span> <span class="n">ebx</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Delete entry in between others */</span>
				<span class="n">ebx</span> <span class="o">=</span> <span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">edx</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">edx</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>7b60</p></td><td class="code"><div class="highlight"><pre>				<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
					<span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="n">ebp</span><span class="p">,</span> <span class="n">edx</span><span class="p">);</span>
				<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>printk(KERN_INFO "vortex srcdelWTD between addr= 0x%x, val= 0x%x\n", ebp, edx);</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Delete last entry */</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>7b83</p></td><td class="code"><div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">esp14</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
						<span class="n">VORTEX_SRC_CHNBASE</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">ch</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">esp18</span> <span class="o">&amp;</span> <span class="mh">0xef</span><span class="p">);</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">ebx</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xffffffe0</span> <span class="o">&amp;</span> <span class="n">edx</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&amp;</span> <span class="n">ebx</span><span class="p">);</span>
					<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
						<span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">esp14</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ebx</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>printk(KERN_INFO"vortex srcdelWTD last addr= 0x%x, val= 0x%x\n", esp14, ebx);</p></td><td class="code"><div class="highlight"><pre>				<span class="p">}</span>
				<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
					<span class="n">VORTEX_SRC_RTBASE</span> <span class="o">+</span> <span class="n">ebp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>7be0</p></td><td class="code"><div class="highlight"><pre>		<span class="n">vortex_src_dis_sr</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">ebp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

 <span class="cm">/*FIFO*/</span> 

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_fifo_clearadbdata</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="o">--</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_FIFO_ADBDATA</span> <span class="o">+</span>
			<span class="p">(((</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_SIZE_BITS</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void vortex_fifo_adbinitialize(vortex_t * vortex, int fifo, int j)</span>
<span class="c">{</span>
<span class="c">	vortex_fifo_clearadbdata(vortex, fifo, FIFO_SIZE);</span>
<span class="cp">#ifdef CHIP_AU8820</span>
<span class="c">	hwwrite(vortex-&gt;mmio, VORTEX_FIFO_ADBCTRL + (fifo &lt;&lt; 2),</span>
<span class="c">		(FIFO_U1 | ((j &amp; FIFO_MASK) &lt;&lt; 0xb)));</span>
<span class="cp">#else</span>
<span class="c">	hwwrite(vortex-&gt;mmio, VORTEX_FIFO_ADBCTRL + (fifo &lt;&lt; 2),</span>
<span class="c">		(FIFO_U1 | ((j &amp; FIFO_MASK) &lt;&lt; 0xc)));</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_fifo_setadbvalid</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_ADBCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_ADBCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span>
		 <span class="mh">0xffffffef</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="n">en</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">FIFO_U1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stereo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">empty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">valid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>int this<em>8[NR</em>ADB] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0}; /* position */</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="cm">/* f seems priority related.</span>
<span class="cm">	 * CAsp4AdbDma::SetPriority is the only place that calls SetAdbCtrl with f set to 1</span>
<span class="cm">	 * every where else it is set to 0. It seems, however, that CAsp4AdbDma::SetPriority</span>
<span class="cm">	 * is never called, thus the f related bits remain a mystery for now.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_ADBCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lifeboat</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mh">0xbb8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;Vortex: vortex_fifo_setadbctrl fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FIFO_RDONLY</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>AU8830 semes to take some special care about fifo content (data).
But i'm just to lazy to translate that :)</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FIFO_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>this_8[fifo] = 0;</p></td><td class="code"><div class="highlight"><pre>			<span class="n">vortex_fifo_clearadbdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>	<span class="c1">// this_4</span>
<span class="cp">#ifdef CHIP_AU8820</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_4</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xb</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_4</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffffffd</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">stereo</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffffff3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xffffffef</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">FIFO_U1</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xffffffdf</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">empty</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="cp">#ifdef CHIP_AU8820</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffbffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x12</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8830</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf7ffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1b</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xefffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1c</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8810</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfeffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x18</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfdffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x19</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FIFO_VALID</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CHIP_AU8820</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffbffef</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8830</span>
			<span class="n">temp</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xe7ffffef</span><span class="p">)</span> <span class="o">|</span> <span class="n">FIFO_BITS</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8810</span>
			<span class="n">temp</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfcffffef</span><span class="p">)</span> <span class="o">|</span> <span class="n">FIFO_BITS</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/*if (this_8[fifo]) */</span>
			<span class="n">vortex_fifo_clearadbdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_ADBCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_ADBCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#ifndef CHIP_AU8810</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_fifo_clearwtdata</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="o">--</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_FIFO_WTDATA</span> <span class="o">+</span>
			<span class="p">(((</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="n">FIFO_SIZE_BITS</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_fifo_wtinitialize</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">j</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_fifo_clearwtdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>
<span class="cp">#ifdef CHIP_AU8820</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="n">FIFO_U1</span> <span class="o">|</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="n">FIFO_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xb</span><span class="p">)));</span>
<span class="cp">#else</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="n">FIFO_U1</span> <span class="o">|</span> <span class="p">((</span><span class="n">j</span> <span class="o">&amp;</span> <span class="n">FIFO_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">)));</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_fifo_setwtvalid</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span>
		 <span class="mh">0xffffffef</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">en</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">FIFO_U1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">priority</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">empty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">valid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lifeboat</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mh">0xbb8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Vortex: vortex_fifo_setwtctrl fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FIFO_RDONLY</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FIFO_VALID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vortex_fifo_clearwtdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>	<span class="c1">// this_4</span>
<span class="cp">#ifdef CHIP_AU8820</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_4</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xb</span><span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">this_4</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffffffd</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ctrl</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffffff3</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">priority</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xffffffef</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">|=</span> <span class="n">FIFO_U1</span><span class="p">;</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xffffffdf</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">empty</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="cp">#ifdef CHIP_AU8820</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffbffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x12</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8830</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xf7ffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1b</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xefffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1c</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8810</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfeffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x18</span><span class="p">);</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfdffffff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x19</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">FIFO_VALID</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CHIP_AU8820</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfffbffef</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8830</span>
			<span class="n">temp</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xe7ffffef</span><span class="p">)</span> <span class="o">|</span> <span class="n">FIFO_BITS</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8810</span>
			<span class="n">temp</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">f</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="mh">0xfcffffef</span><span class="p">)</span> <span class="o">|</span> <span class="n">FIFO_BITS</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/*if (this_8[fifo]) */</span>
			<span class="n">vortex_fifo_clearwtdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
	<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">fifo</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

<span class="cm">/*	</span>
<span class="cm">    do {</span>
<span class="cm">		temp = hwread(vortex-&gt;mmio, VORTEX_FIFO_WTCTRL + (fifo &lt;&lt; 2));</span>
<span class="cm">		if (lifeboat++ &gt; 0xbb8) {</span>
<span class="cm">			printk(KERN_ERR &quot;Vortex: vortex_fifo_setwtctrl fail (hanging)\n&quot;);</span>
<span class="cm">			break;</span>
<span class="cm">		}</span>
<span class="cm">    } while ((temp &amp; FIFO_RDONLY)&amp;&amp;(temp &amp; FIFO_VALID)&amp;&amp;(temp != 0xFFFFFFFF));</span>
<span class="cm">	</span>
<span class="cm">	</span>
<span class="cm">	if (valid) {</span>
<span class="cm">		if (temp &amp; FIFO_VALID) {</span>
<span class="cm">			temp = 0x40000;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">			temp |= 0x1c400000;</span>
<span class="cm">			temp &amp;= 0xFFFFFFF3;</span>
<span class="cm">			temp &amp;= 0xFFFFFFEF;</span>
<span class="cm">			temp |= (valid &amp; 1) &lt;&lt; 4;</span>
<span class="cm">			hwwrite(vortex-&gt;mmio, VORTEX_FIFO_WTCTRL + (fifo &lt;&lt; 2), temp);</span>
<span class="cm">			return;</span>
<span class="cm">		} else {</span>
<span class="cm">			vortex_fifo_clearwtdata(vortex, fifo, FIFO_SIZE);</span>
<span class="cm">			return;</span>
<span class="cm">		}</span>
<span class="cm">	} else {</span>
<span class="cm">		temp &amp;= 0xffffffef;</span>
<span class="cm">		temp |= 0x08000000;</span>
<span class="cm">		temp |= 0x10000000;</span>
<span class="cm">		temp |= 0x04000000;</span>
<span class="cm">		temp |= 0x00400000;</span>
<span class="cm">		hwwrite(vortex-&gt;mmio, VORTEX_FIFO_WTCTRL + (fifo &lt;&lt; 2), temp);</span>
<span class="cm">		temp = hwread(vortex-&gt;mmio, VORTEX_FIFO_WTCTRL + (fifo &lt;&lt; 2));</span>

<span class="cm">//DIVIDER</span>
<span class="cm">		</span>
<span class="cm">		priority = 0;</span>
<span class="cm">		if (((temp &amp; 0x0fc0) ^ ((temp &gt;&gt; 6) &amp; 0x0fc0)) &amp; 0FFFFFFC0)</span>
<span class="cm">			vortex_fifo_clearwtdata(vortex, fifo, FIFO_SIZE);</span>
<span class="cm">		valid = 0xfb;</span>
<span class="cm">		temp = (temp &amp; 0xfffffffd) | ((ctrl &amp; 1) &lt;&lt; 1);</span>
<span class="cm">		temp = (temp &amp; 0xfffdffff) | ((f &amp; 1) &lt;&lt; 0x11);</span>
<span class="cm">		temp = (temp &amp; 0xfffffff3) | ((priority &amp; 3) &lt;&lt; 2);</span>
<span class="cm">		temp = (temp &amp; 0xffffffef) | ((valid &amp; 1) &lt;&lt; 4);</span>
<span class="cm">		temp = (temp &amp; 0xffffffdf) | ((empty &amp; 1) &lt;&lt; 5);</span>
<span class="cm">		hwwrite(vortex-&gt;mmio, VORTEX_FIFO_WTCTRL + (fifo &lt;&lt; 2), temp);</span>
<span class="cm">	}</span>
<span class="cm">	</span>
<span class="cm">	*/</span>

	<span class="cm">/*</span>
<span class="cm">	   temp = (temp &amp; 0xfffffffd) | ((ctrl &amp; 1) &lt;&lt; 1);</span>
<span class="cm">	   temp = (temp &amp; 0xfffdffff) | ((f &amp; 1) &lt;&lt; 0x11);</span>
<span class="cm">	   temp = (temp &amp; 0xfffffff3) | ((priority &amp; 3) &lt;&lt; 2);</span>
<span class="cm">	   temp = (temp &amp; 0xffffffef) | ((valid &amp; 1) &lt;&lt; 4);</span>
<span class="cm">	   temp = (temp &amp; 0xffffffdf) | ((empty &amp; 1) &lt;&lt; 5);</span>
<span class="cm">	   #ifdef FIFO_BITS</span>
<span class="cm">	   temp = temp | FIFO_BITS | 40000;</span>
<span class="cm">	   #endif</span>

<span class="cm">//DIVIDER</span>
<span class="cm">	   hwwrite(vortex-&gt;mmio, VORTEX_FIFO_WTCTRL + (fifo &lt;&lt; 2), temp);</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_fifo_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* ADB DMA channels fifos. */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_FIFO_ADBCTRL</span> <span class="o">+</span> <span class="p">((</span><span class="n">NR_ADB</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">NR_ADB</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">FIFO_U0</span> <span class="o">|</span> <span class="n">FIFO_U1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">FIFO_U0</span> <span class="o">|</span> <span class="n">FIFO_U1</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;bad adb fifo reset!&quot;</span><span class="p">);</span>
		<span class="n">vortex_fifo_clearadbdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="cm">/* WT DMA channels fifos. */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">VORTEX_FIFO_WTCTRL</span> <span class="o">+</span> <span class="p">((</span><span class="n">NR_WT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">NR_WT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">FIFO_U0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FIFO_U0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;bad wt fifo reset (0x%08x, 0x%08x)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">addr</span><span class="p">,</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">addr</span><span class="p">));</span>
		<span class="n">vortex_fifo_clearwtdata</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">FIFO_SIZE</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* trigger... */</span>
<span class="cp">#ifdef CHIP_AU8820</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="mh">0xf8c0</span><span class="p">,</span> <span class="mh">0xd03</span><span class="p">);</span>	<span class="c1">//0x0843 0xd6b</span>
<span class="cp">#else</span>
<span class="cp">#ifdef CHIP_AU8830</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="mh">0x17000</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>	<span class="cm">/* wt a */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="mh">0x17004</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>	<span class="cm">/* wt b */</span>
<span class="cp">#endif</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="mh">0x17008</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>	<span class="cm">/* adb */</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* ADBDMA */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_setfirstbuffer</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_setstartbuffer</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>temp |= 0x08000000;
temp |= 0x10000000;
temp |= 0x04000000;
temp |= 0x00400000;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_START</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">sb</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mh">0xf</span> <span class="o">-</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vortex_adbdma_setbuffers</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">psize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="n">psize</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Four or more pages */</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span> <span class="o">|=</span> <span class="mh">0x88000000</span> <span class="o">|</span> <span class="mh">0x44000000</span> <span class="o">|</span> <span class="mh">0x30000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">psize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">psize</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>
		<span class="cm">/* 3 pages */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">|=</span> <span class="mh">0x12000000</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span> <span class="o">|=</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="mh">0x40000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">psize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">psize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="cm">/* 2 pages */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">|=</span> <span class="mh">0x88000000</span> <span class="o">|</span> <span class="mh">0x44000000</span> <span class="o">|</span> <span class="mh">0x10000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">psize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">psize</span><span class="p">));</span>
		<span class="cm">/* 1 page */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">|=</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="mh">0x40000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">psize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	printk(KERN_DEBUG &quot;vortex: cfg0 = 0x%x\nvortex: cfg1=0x%x\n&quot;,</span>
<span class="cm">	       dma-&gt;cfg0, dma-&gt;cfg1);</span>
<span class="cm">	*/</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_BUFCFG0</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_BUFCFG1</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span><span class="p">);</span>

	<span class="n">vortex_adbdma_setfirstbuffer</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">);</span>
	<span class="n">vortex_adbdma_setstartbuffer</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vortex_adbdma_setmode</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ie</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stereo</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span> <span class="o">=</span> <span class="n">stereo</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">OFFSET_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OFFSET_MASK</span><span class="p">));</span>
	<span class="cm">/* Enable PCMOUT interrupts. */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ie</span> <span class="o">&lt;&lt;</span> <span class="n">IE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IE_MASK</span><span class="p">);</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DIR_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">dir</span> <span class="o">&lt;&lt;</span> <span class="n">DIR_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DIR_MASK</span><span class="p">);</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FMT_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fmt</span> <span class="o">&lt;&lt;</span> <span class="n">FMT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FMT_MASK</span><span class="p">);</span>

	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
	<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_adbdma_bufshift</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_STAT</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span>
	     <span class="n">ADB_SUBBUF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ADB_SUBBUF_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">+=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* refresh hw page table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* p: audio buffer page index */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">-=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
			<span class="cm">/* pp: hardware DMA page index. */</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pp</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>((temp >> 6) &amp; 0x3f) </p></td><td class="code"><div class="highlight"><pre>			<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
				<span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(((</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
				<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span>
				<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">*</span> <span class="n">p</span><span class="p">));</span>
			<span class="cm">/* Force write thru cache. */</span>
			<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span>
			       <span class="p">(((</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">-=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;vortex: %d virt=%d, real=%d, delta=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_resetup</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* refresh hw page table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* p: audio buffer page index */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">-=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
		<span class="cm">/* pp: hardware DMA page index. */</span>
		<span class="n">pp</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">)</span>
				<span class="n">pp</span> <span class="o">-=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pp</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(((</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span>
					       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">*</span> <span class="n">p</span><span class="p">));</span>
		<span class="cm">/* Force write thru cache. */</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(((</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">pp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">vortex_adbdma_getlinearpos</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_STAT</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">page</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">ADB_SUBBUF_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ADB_SUBBUF_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">+=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_startfifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/*empty */</span> <span class="p">,</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span> <span class="cm">/*priority */</span> <span class="p">;</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_START</span>:
		<span class="n">vortex_fifo_setadbvalid</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span>
					<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_STOP</span>:
		<span class="n">this_8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_PAUSE</span>:
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_START</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_resumefifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_STOP</span>:
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_PAUSE</span>:
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_START</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_pausefifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_START</span>:
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_STOP</span>:
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADBDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">adbdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_PAUSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_adbdma_stopfifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">==</span> <span class="n">FIFO_START</span><span class="p">)</span>
		<span class="n">vortex_fifo_setadbctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">adbdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				       <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">==</span> <span class="n">FIFO_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_STOP</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* WTDMA */</span>

<span class="cp">#ifndef CHIP_AU8810</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_wtdma_setfirstbuffer</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>0x1c440010, 0x1c400000</p></td><td class="code"><div class="highlight"><pre>	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>

	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_wtdma_setstartbuffer</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>hwwrite(vortex->mmio, VORTEX<em>ADBDMA</em>START + (adbdma &lt;&lt; 2), sb &lt;&lt; (((NR_ADB-1)-((adbdma&amp;0xf)*2))));</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_START</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">sb</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="mh">0xf</span> <span class="o">-</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">=</span> <span class="n">sb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vortex_wtdma_setbuffers</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">psize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="n">psize</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Four or more pages */</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span> <span class="o">|=</span> <span class="mh">0x88000000</span> <span class="o">|</span> <span class="mh">0x44000000</span> <span class="o">|</span> <span class="mh">0x30000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">psize</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xc</span><span class="p">,</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">psize</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>
		<span class="cm">/* 3 pages */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">|=</span> <span class="mh">0x12000000</span><span class="p">;</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span> <span class="o">|=</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="mh">0x40000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">psize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>  <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">psize</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="cm">/* 2 pages */</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">|=</span> <span class="mh">0x88000000</span> <span class="o">|</span> <span class="mh">0x44000000</span> <span class="o">|</span> <span class="mh">0x10000000</span> <span class="o">|</span> <span class="p">(</span><span class="n">psize</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x4</span><span class="p">,</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="n">psize</span><span class="p">));</span>
		<span class="cm">/* 1 page */</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span> <span class="o">|=</span> <span class="mh">0x80000000</span> <span class="o">|</span> <span class="mh">0x40000000</span> <span class="o">|</span> <span class="p">((</span><span class="n">psize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">),</span>
			<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFCFG0</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFCFG1</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">cfg1</span><span class="p">);</span>

	<span class="n">vortex_wtdma_setfirstbuffer</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">);</span>
	<span class="n">vortex_wtdma_setstartbuffer</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="n">vortex_wtdma_setmode</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ie</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span>
		     <span class="cm">/*int e, */</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>hwwrite(vortex->mmio, VORTEX<em>ADBDMA</em>BUFBASE+(((adbdma &lt;&lt; 2)+pp) &lt;&lt; 2), dma->table[p].addr);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">OFFSET_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">OFFSET_MASK</span><span class="p">));</span>
	<span class="cm">/* PCMOUT interrupt */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">ie</span> <span class="o">&lt;&lt;</span> <span class="n">IE_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IE_MASK</span><span class="p">);</span>
	<span class="cm">/* Always playback. */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">DIR_SHIFT</span><span class="p">);</span>
	<span class="cm">/* Audio Format */</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span> <span class="o">&amp;</span> <span class="n">FMT_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">fmt</span> <span class="o">&lt;&lt;</span> <span class="n">FMT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FMT_MASK</span><span class="p">);</span>
	<span class="cm">/* Write into hardware */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vortex_wtdma_bufshift</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">page</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_STAT</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span>
	     <span class="n">WT_SUBBUF_MASK</span><span class="p">)</span>
	    <span class="o">&gt;&gt;</span> <span class="n">WT_SUBBUF_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span> <span class="o">-</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">delta</span> <span class="o">+=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* refresh hw page table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* p: audio buffer page index */</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">-=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
			<span class="cm">/* pp: hardware DMA page index. */</span>
			<span class="n">pp</span> <span class="o">=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pp</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">pp</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
				<span class="n">VORTEX_WTDMA_BUFBASE</span> <span class="o">+</span>
				<span class="p">(((</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
				<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">substream</span><span class="p">,</span>
						       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">*</span> <span class="n">p</span><span class="p">));</span>
			<span class="cm">/* Force write thru cache. */</span>
			<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_BUFBASE</span> <span class="o">+</span>
			       <span class="p">(((</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">&gt;=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">)</span>
		<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">-=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">nr_periods</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_real</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;vortex: wt virt = %d, delta = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void</span>
<span class="c">vortex_wtdma_getposition(vortex_t * vortex, int wtdma, int *subbuf, int *pos)</span>
<span class="c">{</span>
<span class="c">	int temp;</span>
<span class="c">	temp = hwread(vortex-&gt;mmio, VORTEX_WTDMA_STAT + (wtdma &lt;&lt; 2));</span>
<span class="c">	*subbuf = (temp &gt;&gt; WT_SUBBUF_SHIFT) &amp; WT_SUBBUF_MASK;</span>
<span class="c">	*pos = temp &amp; POS_MASK;</span>
<span class="c">}</span>

<span class="c">static int vortex_wtdma_getcursubuffer(vortex_t * vortex, int wtdma)</span>
<span class="c">{</span>
<span class="c">	return ((hwread(vortex-&gt;mmio, VORTEX_WTDMA_STAT + (wtdma &lt;&lt; 2)) &gt;&gt;</span>
<span class="c">		 POS_SHIFT) &amp; POS_MASK);</span>
<span class="c">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">vortex_wtdma_getlinearpos</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_STAT</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_virt</span> <span class="o">*</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_wtdma_startfifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_START</span>:
		<span class="n">vortex_fifo_setwtvalid</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span>
				       <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_STOP</span>:
		<span class="n">this_8</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				      <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_PAUSE</span>:
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				      <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_START</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_wtdma_resumefifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_STOP</span>:
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				      <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_PAUSE</span>:
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span>
				      <span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_START</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_wtdma_pausefifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIFO_START</span>:
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIFO_STOP</span>:
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_WTDMA_CTRL</span> <span class="o">+</span> <span class="p">(</span><span class="n">wtdma</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_ctrl</span><span class="p">);</span>
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_PAUSE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vortex_wtdma_stopfifo</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wtdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">dma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">wtdma</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">this_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">==</span> <span class="n">FIFO_START</span><span class="p">)</span>
		<span class="n">vortex_fifo_setwtctrl</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">wtdma</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">dma_unknown</span><span class="p">,</span>
				      <span class="n">this_4</span><span class="p">,</span> <span class="n">this_8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">==</span> <span class="n">FIFO_STOP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_status</span> <span class="o">=</span> <span class="n">FIFO_STOP</span><span class="p">;</span>
	<span class="n">dma</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
<span class="cm">/* ADB Routes */</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="n">ADBRamLink</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_adb_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="cm">/* it looks like we are writing more than we need to...</span>
<span class="cm">	 * if we write what we are supposed to it breaks things... */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_SR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VORTEX_ADB_RTBASE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			       <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="n">ROUTE_MASK</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VORTEX_ADB_CHNBASE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			       <span class="n">VORTEX_ADB_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">|</span> <span class="n">ROUTE_MASK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_adb_en_sr</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_SR</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_SR</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_adb_dis_sr</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_SR</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_SR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_adb_addroutes</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
		     <span class="n">ADBRamLink</span> <span class="o">*</span> <span class="n">route</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rnum</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">route</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Write last routes. */</span>
	<span class="n">rnum</span><span class="o">--</span><span class="p">;</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
		<span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">route</span><span class="p">[</span><span class="n">rnum</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">ROUTE_MASK</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rnum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			<span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span>
			<span class="p">((</span><span class="n">route</span><span class="p">[</span><span class="n">rnum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">route</span><span class="p">[</span><span class="n">rnum</span><span class="p">]);</span>
		<span class="n">rnum</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Write first route. */</span>
	<span class="n">temp</span> <span class="o">=</span>
	    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
		   <span class="n">VORTEX_ADB_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First entry on this channel. */</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">vortex_adb_en_sr</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Not first entry on this channel. Need to link. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span>
		    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			   <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lifeboat</span><span class="o">++</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;vortex_adb_addroutes: unending route! 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="o">*</span><span class="n">route</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="n">ADB_MASK</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_adb_delroutes</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
		     <span class="n">ADBRamLink</span> <span class="n">route0</span><span class="p">,</span> <span class="n">ADBRamLink</span> <span class="n">route1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">prev</span><span class="p">;</span>

	<span class="cm">/* Find route. */</span>
	<span class="n">temp</span> <span class="o">=</span>
	    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
		   <span class="n">VORTEX_ADB_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="p">(</span><span class="n">route0</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span>
		    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			   <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">((</span><span class="n">route1</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">ADB_MASK</span><span class="p">)</span>
			<span class="n">vortex_adb_dis_sr</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_CHNBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">temp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">=</span>
		    <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span>
			   <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">lifeboat</span><span class="o">++</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">ADB_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;vortex_adb_delroutes: route not found! 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">route0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">temp</span> <span class="o">!=</span> <span class="p">(</span><span class="n">route0</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">));</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">route1</span><span class="p">)</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="cm">/* Make bridge over deleted route. */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ADB_RTBASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">temp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_route</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span>
	     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ADBRamLink</span> <span class="n">route</span><span class="p">;</span>

	<span class="n">route</span> <span class="o">=</span> <span class="p">((</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ADB_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_adb_addroutes</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">route</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_SRCOUT</span> <span class="o">+</span> <span class="n">NR_SRC</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">OFFSET_SRCOUT</span><span class="p">))</span>
			<span class="n">vortex_src_addWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span> <span class="o">-</span> <span class="n">OFFSET_SRCOUT</span><span class="p">),</span>
					  <span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_MIXOUT</span> <span class="o">+</span> <span class="n">NR_MIXOUT</span><span class="p">))</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">OFFSET_MIXOUT</span><span class="p">))</span>
			<span class="n">vortex_mixer_addWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">source</span> <span class="o">-</span> <span class="n">OFFSET_MIXOUT</span><span class="p">),</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vortex_adb_delroutes</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">route</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_SRCOUT</span> <span class="o">+</span> <span class="n">NR_SRC</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">OFFSET_SRCOUT</span><span class="p">))</span>
			<span class="n">vortex_src_delWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="p">(</span><span class="n">source</span> <span class="o">-</span> <span class="n">OFFSET_SRCOUT</span><span class="p">),</span>
					  <span class="n">channel</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_MIXOUT</span> <span class="o">+</span> <span class="n">NR_MIXOUT</span><span class="p">))</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">OFFSET_MIXOUT</span><span class="p">))</span>
			<span class="n">vortex_mixer_delWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">source</span> <span class="o">-</span> <span class="n">OFFSET_MIXOUT</span><span class="p">),</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void</span>
<span class="c">vortex_routes(vortex_t * vortex, int en, unsigned char channel,</span>
<span class="c">	      unsigned char source, unsigned char dest0, unsigned char dest1)</span>
<span class="c">{</span>
<span class="c">	ADBRamLink route[2];</span>

<span class="c">	route[0] = ((source &amp; ADB_MASK) &lt;&lt; ADB_SHIFT) | (dest0 &amp; ADB_MASK);</span>
<span class="c">	route[1] = ((source &amp; ADB_MASK) &lt;&lt; ADB_SHIFT) | (dest1 &amp; ADB_MASK);</span>

<span class="c">	if (en) {</span>
<span class="c">		vortex_adb_addroutes(vortex, channel, route, 2);</span>
<span class="c">		if ((source &lt; (OFFSET_SRCOUT + NR_SRC))</span>
<span class="c">		    &amp;&amp; (source &gt;= (OFFSET_SRCOUT)))</span>
<span class="c">			vortex_src_addWTD(vortex, (source - OFFSET_SRCOUT),</span>
<span class="c">					  channel);</span>
<span class="c">		else if ((source &lt; (OFFSET_MIXOUT + NR_MIXOUT))</span>
<span class="c">			 &amp;&amp; (source &gt;= (OFFSET_MIXOUT)))</span>
<span class="c">			vortex_mixer_addWTD(vortex,</span>
<span class="c">					    (source - OFFSET_MIXOUT), channel);</span>
<span class="c">	} else {</span>
<span class="c">		vortex_adb_delroutes(vortex, channel, route[0], route[1]);</span>
<span class="c">		if ((source &lt; (OFFSET_SRCOUT + NR_SRC))</span>
<span class="c">		    &amp;&amp; (source &gt;= (OFFSET_SRCOUT)))</span>
<span class="c">			vortex_src_delWTD(vortex, (source - OFFSET_SRCOUT),</span>
<span class="c">					  channel);</span>
<span class="c">		else if ((source &lt; (OFFSET_MIXOUT + NR_MIXOUT))</span>
<span class="c">			 &amp;&amp; (source &gt;= (OFFSET_MIXOUT)))</span>
<span class="c">			vortex_mixer_delWTD(vortex,</span>
<span class="c">					    (source - OFFSET_MIXOUT), channel);</span>
<span class="c">	}</span>
<span class="c">}</span>

<span class="cp">#endif</span>
<span class="cm">/* Route two sources to same target. Sources must be of same class !!! */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_routeLRT</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source1</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ADBRamLink</span> <span class="n">route</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">source0</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ADB_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">);</span>
	<span class="n">route</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">source1</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ADB_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="n">ADB_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">route</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">route</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ADB_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">);</span>	<span class="cm">/* fifo A */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_adb_addroutes</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">source0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_SRCOUT</span> <span class="o">+</span> <span class="n">NR_SRC</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source0</span> <span class="o">&gt;=</span> <span class="n">OFFSET_SRCOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vortex_src_addWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">source0</span> <span class="o">-</span> <span class="n">OFFSET_SRCOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">vortex_src_addWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">source1</span> <span class="o">-</span> <span class="n">OFFSET_SRCOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">source0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_MIXOUT</span> <span class="o">+</span> <span class="n">NR_MIXOUT</span><span class="p">))</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source0</span> <span class="o">&gt;=</span> <span class="n">OFFSET_MIXOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vortex_mixer_addWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">source0</span> <span class="o">-</span> <span class="n">OFFSET_MIXOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">vortex_mixer_addWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">source1</span> <span class="o">-</span> <span class="n">OFFSET_MIXOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vortex_adb_delroutes</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">route</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">route</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">source0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_SRCOUT</span> <span class="o">+</span> <span class="n">NR_SRC</span><span class="p">))</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source0</span> <span class="o">&gt;=</span> <span class="n">OFFSET_SRCOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vortex_src_delWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">source0</span> <span class="o">-</span> <span class="n">OFFSET_SRCOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">vortex_src_delWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">source1</span> <span class="o">-</span> <span class="n">OFFSET_SRCOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">source0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">OFFSET_MIXOUT</span> <span class="o">+</span> <span class="n">NR_MIXOUT</span><span class="p">))</span>
			   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">source0</span> <span class="o">&gt;=</span> <span class="n">OFFSET_MIXOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vortex_mixer_delWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">source0</span> <span class="o">-</span> <span class="n">OFFSET_MIXOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
			<span class="n">vortex_mixer_delWTD</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">source1</span> <span class="o">-</span> <span class="n">OFFSET_MIXOUT</span><span class="p">),</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Connection stuff */</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>int this<em>7c=dma</em>ctrl;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_adbdma_src</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">adbdma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ADB_DMA</span><span class="p">(</span><span class="n">adbdma</span><span class="p">),</span> <span class="n">ADB_SRCIN</span><span class="p">(</span><span class="n">src</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>hwwrite(vortex->mmio, VORTEX<em>WTDMA</em>START + (wtdma &lt;&lt; 2), sb &lt;&lt; ((0x1f-(wtdma&amp;0xf)*2)));</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_src_mixin</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ADB_SRCOUT</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">ADB_MIXIN</span><span class="p">(</span><span class="n">mixin</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>dma->this_08 = e;</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixin</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_mix_enableinput</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">);</span>
		<span class="n">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="n">MIX_DEFIGAIN</span><span class="p">);</span>	<span class="c1">// added to original code.</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vortex_mix_disableinput</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Connect adbdma to src('s).</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_adb_mixin</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">channel</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">source</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">ADB_MIXIN</span><span class="p">(</span><span class="n">mixin</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_src_adbdma</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ADB_SRCOUT</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="n">ADB_DMA</span><span class="p">(</span><span class="n">adbdma</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_src_src_adbdma</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src0</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">adbdma</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">vortex_routeLRT</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ADB_SRCOUT</span><span class="p">(</span><span class="n">src0</span><span class="p">),</span> <span class="n">ADB_SRCOUT</span><span class="p">(</span><span class="n">src1</span><span class="p">),</span>
			<span class="n">ADB_DMA</span><span class="p">(</span><span class="n">adbdma</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Connect SRC to mixin.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ADB_MIXOUT</span><span class="p">(</span><span class="n">mix</span><span class="p">),</span> <span class="n">dest</span><span class="p">);</span>
	<span class="n">vortex_mix_setvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">MIX_DEFOGAIN</span><span class="p">);</span>	<span class="c1">// added to original code.</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Connect mixin with mix output.</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connection_mix_src</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ch</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mix</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ADB_MIXOUT</span><span class="p">(</span><span class="n">mix</span><span class="p">),</span> <span class="n">ADB_SRCIN</span><span class="p">(</span><span class="n">src</span><span class="p">));</span>
	<span class="n">vortex_mix_setvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mix</span><span class="p">,</span> <span class="n">MIX_DEFOGAIN</span><span class="p">);</span>	<span class="c1">// added to original code.</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void</span>
<span class="c">vortex_connection_adbdma_src_src(vortex_t * vortex, int en,</span>
<span class="c">				 unsigned char channel,</span>
<span class="c">				 unsigned char adbdma, unsigned char src0,</span>
<span class="c">				 unsigned char src1)</span>
<span class="c">{</span>
<span class="c">	vortex_routes(vortex, en, channel, ADB_DMA(adbdma),</span>
<span class="c">		      ADB_SRCIN(src0), ADB_SRCIN(src1));</span>
<span class="c">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Connect absolut address to mixin.</p></td><td class="code"><div class="highlight"><pre><span class="c">static void</span>
<span class="c">vortex_connection_mix_mix_adbdma(vortex_t * vortex, int en,</span>
<span class="c">				 unsigned char ch, unsigned char mix0,</span>
<span class="c">				 unsigned char mix1, unsigned char adbdma)</span>
<span class="c">{</span>

<span class="c">	ADBRamLink routes[2];</span>
<span class="c">	routes[0] =</span>
<span class="c">	    (((mix0 +</span>
<span class="c">	       OFFSET_MIXOUT) &amp; ADB_MASK) &lt;&lt; ADB_SHIFT) | (adbdma &amp; ADB_MASK);</span>
<span class="c">	routes[1] =</span>
<span class="c">	    (((mix1 + OFFSET_MIXOUT) &amp; ADB_MASK) &lt;&lt; ADB_SHIFT) | ((adbdma +</span>
<span class="c">								   0x20) &amp;</span>
<span class="c">								  ADB_MASK);</span>
<span class="c">	if (en) {</span>
<span class="c">		vortex_adb_addroutes(vortex, ch, routes, 0x2);</span>
<span class="c">		vortex_mixer_addWTD(vortex, mix0, ch);</span>
<span class="c">		vortex_mixer_addWTD(vortex, mix1, ch);</span>
<span class="c">	} else {</span>
<span class="c">		vortex_adb_delroutes(vortex, ch, routes[0], routes[1]);</span>
<span class="c">		vortex_mixer_delWTD(vortex, mix0, ch);</span>
<span class="c">		vortex_mixer_delWTD(vortex, mix1, ch);</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* CODEC connect. */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connect_codecplay</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixers</span><span class="p">[])</span>
<span class="p">{</span>
<span class="cp">#ifdef CHIP_AU8820</span>
	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="cp">#else</span>
<span class="cp">#if 1</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>mix to absolut address.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ADB_EQIN</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ADB_EQIN</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="cm">/* Lower volume, since EQ has some gain. */</span>
	<span class="n">vortex_mix_setvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vortex_mix_setvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">ADB_EQOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">ADB_EQOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Check if reg 0x28 has SDAC bit set. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Rear channel. Note: ADB_CODECOUT(0+2) and (1+2) is for AC97 modem */</span>
		<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
					  <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">0</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					  <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
		<span class="cm">/* printk(KERN_DEBUG &quot;SDAC detected &quot;); */</span>
	<span class="p">}</span>
<span class="cp">#else</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>mixer to src.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mixers</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ADB_CODECOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_connect_codecrec</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixin0</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mixin1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	   Enable: 0x1, 0x1</span>
<span class="cm">	   Channel: 0x11, 0x11</span>
<span class="cm">	   ADB Source address: 0x48, 0x49</span>
<span class="cm">	   Destination Asp4Topology_0x9c,0x98</span>
<span class="cm">	 */</span>
	<span class="n">vortex_connection_adb_mixin</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">ADB_CODECIN</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mixin0</span><span class="p">);</span>
	<span class="n">vortex_connection_adb_mixin</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">ADB_CODECIN</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mixin1</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Connect two mix to AdbDma.</p></td><td class="code"><div class="highlight"><pre><span class="cm">/* Resource manager */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">resnum</span><span class="p">[</span><span class="n">VORTEX_RESOURCE_LAST</span><span class="p">]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="n">NR_ADB</span><span class="p">,</span> <span class="n">NR_SRC</span><span class="p">,</span> <span class="n">NR_MIXIN</span><span class="p">,</span> <span class="n">NR_MIXOUT</span><span class="p">,</span> <span class="n">NR_A3D</span> <span class="p">};</span>
<span class="cm">/*</span>
<span class="cm"> Checkout/Checkin resource of given type. </span>
<span class="cm"> resmap: resource map to be used. If NULL means that we want to allocate</span>
<span class="cm"> a DMA resource (root of all other resources of a dma channel).</span>
<span class="cm"> out: Mean checkout if != 0. Else mean Checkin resource.</span>
<span class="cm"> restype: Indicates type of resource to be checked in or out.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">char</span>
<span class="nf">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">resmap</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">restype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">qty</span> <span class="o">=</span> <span class="n">resnum</span><span class="p">[</span><span class="n">restype</span><span class="p">],</span> <span class="n">resinuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Gather used resources by all streams. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_ADB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resinuse</span> <span class="o">|=</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resources</span><span class="p">[</span><span class="n">restype</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">resinuse</span> <span class="o">|=</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">[</span><span class="n">restype</span><span class="p">];</span>
		<span class="cm">/* Find and take free resource. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qty</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">resinuse</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">resmap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">resmap</span><span class="p">[</span><span class="n">restype</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resources</span><span class="p">[</span><span class="n">restype</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				printk(KERN_DEBUG</span>
<span class="cm">				       &quot;vortex: ResManager: type %d out %d\n&quot;,</span>
<span class="cm">				       restype, i);</span>
<span class="cm">				*/</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resmap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* Checkin first resource of type restype. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">qty</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resmap</span><span class="p">[</span><span class="n">restype</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">resmap</span><span class="p">[</span><span class="n">restype</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				printk(KERN_DEBUG</span>
<span class="cm">				       &quot;vortex: ResManager: type %d in %d\n&quot;,</span>
<span class="cm">				       restype, i);</span>
<span class="cm">				*/</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: FATAL: ResManager: resource type %d exhausted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">restype</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Default Connections  */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_connect_default</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Connect front channels through EQ.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixplayb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				  <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">);</span>
	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixplayb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				  <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixplayb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
					  <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">);</span>
		<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixplayb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
					  <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vortex_connect_codecplay</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixplayb</span><span class="p">);</span>

	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixcapt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				  <span class="n">VORTEX_RESOURCE_MIXIN</span><span class="p">);</span>
	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixcapt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				  <span class="n">VORTEX_RESOURCE_MIXIN</span><span class="p">);</span>
	<span class="n">vortex_connect_codecrec</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">MIX_CAPT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">MIX_CAPT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Use plain direct output to codec.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef CHIP_AU8820</span>
	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				  <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">);</span>
	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">fixed_res</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				  <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">);</span>
	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				  <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">vortex_connection_mix_adb</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				  <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Higher level ADB audio path (de)allocator.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef CHIP_AU8810</span>
	<span class="n">vortex_wt_connect</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Connect AC97 codec.</p></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef CHIP_AU8820</span>
	<span class="n">vortex_Vort3D_connect</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Connect SPDIF</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>Connect WT</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>A3D (crosstalk canceler and A3D slices). AU8810 disabled for now.</p></td><td class="code"><div class="highlight"><pre>	
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  Allocate nr_ch pcm audio routes if dma &lt; 0. If dma &gt;= 0, existing routes</span>
<span class="cm">  are deallocated.</span>
<span class="cm">  dma: DMA engine routes to be deallocated when dma &gt;= 0.</span>
<span class="cm">  nr_ch: Number of channels to be de/allocated.</span>
<span class="cm">  dir: direction of stream. Uses same values as substream-&gt;stream.</span>
<span class="cm">  type: Type of audio output/source (codec, spdif, i2s, dsp, etc)</span>
<span class="cm">  Return: Return allocated DMA or same DMA passed as &quot;dma&quot; when dma &gt;= 0.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">vortex_adb_allocroute</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_ch</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">en</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_vol</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
				      <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">dma</span><span class="p">].</span><span class="n">resources</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
				      <span class="n">VORTEX_RESOURCE_DMA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">dma</span> <span class="o">=</span>
		     <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
					   <span class="n">VORTEX_RESOURCE_DMA</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">dma</span><span class="p">];</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">dir</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="cm">/* PLAYBACK ROUTES. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">src</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">mix</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ch_top</span><span class="p">;</span>
<span class="cp">#ifndef CHIP_AU8820</span>
		<span class="kt">int</span> <span class="n">a3d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="cm">/* Get SRC and MIXER hardware resources. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
							   <span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							   <span class="n">VORTEX_RESOURCE_SRC</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">memset</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span>
					       <span class="n">VORTEX_RESOURCE_LAST</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_A3D</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
								   <span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span>
								   <span class="n">en</span><span class="p">,</span>
								   <span class="n">VORTEX_RESOURCE_MIXIN</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">memset</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span>
						       <span class="mi">0</span><span class="p">,</span>
						       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">VORTEX_RESOURCE_LAST</span><span class="p">);</span>
						<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8820</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_A3D</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">a3d</span> <span class="o">=</span>
			     <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
						   <span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
						   <span class="n">VORTEX_RESOURCE_A3D</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">VORTEX_RESOURCE_LAST</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: out of A3D sources. Sorry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* (De)Initialize A3D hardware source. */</span>
			<span class="n">vortex_Vort3D_InitializeSource</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">a3d</span><span class="p">[</span><span class="n">a3d</span><span class="p">]),</span> <span class="n">en</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Make SPDIF out exclusive to &quot;spdif&quot; device when in use. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">en</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
				     <span class="n">ADB_MIXOUT</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				     <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
				     <span class="n">ADB_MIXOUT</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
				     <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* Make playback routes. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vortex_connection_adbdma_src</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							     <span class="n">src</span><span class="p">[</span><span class="n">nr_ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
							     <span class="n">dma</span><span class="p">,</span>
							     <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">vortex_connection_src_mixin</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							    <span class="mh">0x11</span><span class="p">,</span> <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							    <span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							    <span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							    <span class="n">MIX_PLAYB</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8820</span>
				<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							    <span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							    <span class="n">MIX_SPDIF</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
							      <span class="n">MIX_SPDIF</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span>
							      <span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							      <span class="n">MIX_DEFIGAIN</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8820</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_A3D</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vortex_connection_adbdma_src</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							     <span class="n">src</span><span class="p">[</span><span class="n">nr_ch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> 
								 <span class="n">dma</span><span class="p">,</span>
							     <span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">ADB_SRCOUT</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">ADB_A3DIN</span><span class="p">(</span><span class="n">a3d</span><span class="p">));</span>
				<span class="cm">/* XTalk test. */</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>Connect I2S</p></td><td class="code"><div class="highlight"><pre>			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span>
				<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
					     <span class="n">ADB_DMA</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">),</span>
					     <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_SPDIF</span> <span class="o">&amp;&amp;</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_A3D</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch_top</span> <span class="o">=</span> <span class="p">(</span><span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">nr_ch</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ch_top</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							    <span class="n">mix</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">nr_ch</span><span class="p">],</span>
							    <span class="n">MIX_PLAYB</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8820</span>
				<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							    <span class="n">mix</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">nr_ch</span><span class="p">],</span>
							    <span class="n">MIX_SPDIF</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span>
								<span class="mi">0</span><span class="p">);</span>
				<span class="n">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
							      <span class="n">MIX_SPDIF</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">),</span>
							      <span class="n">mix</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="n">nr_ch</span><span class="p">],</span>
							      <span class="n">MIX_DEFIGAIN</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span> <span class="o">&amp;&amp;</span> <span class="n">en</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">subdev</span><span class="p">];</span>
				<span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">dma</span><span class="p">;</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">mixin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ch_top</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">p</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8820</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr_ch</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span>
				<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
					     <span class="n">ADB_DMA</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">),</span>
					     <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="cm">/* Reconnect SPDIF out when &quot;spdif&quot; device is down. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">en</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
				     <span class="n">ADB_MIXOUT</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
				     <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
			<span class="n">vortex_route</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span>
				     <span class="n">ADB_MIXOUT</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixspdif</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
				     <span class="n">ADB_SPDIFOUT</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* CAPTURE ROUTES. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mix</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="cm">/* Get SRC and MIXER hardware resources. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nr_ch</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">mix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			     <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
						   <span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
						   <span class="n">VORTEX_RESOURCE_MIXOUT</span><span class="p">))</span>
			    <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">VORTEX_RESOURCE_LAST</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">src</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			     <span class="n">vortex_adb_checkinout</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
						   <span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
						   <span class="n">VORTEX_RESOURCE_SRC</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="o">*</span>
				       <span class="n">VORTEX_RESOURCE_LAST</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Make capture routes. */</span>
		<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">MIX_CAPT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">mix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vortex_connection_mix_src</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nr_ch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
						    <span class="n">MIX_CAPT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">vortex_connection_src_adbdma</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
						     <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						     <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vortex_connection_mixin_mix</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
						    <span class="n">MIX_CAPT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">vortex_connection_mix_src</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">mix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						  <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">vortex_connection_src_src_adbdma</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span>
							 <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							 <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">dma</span><span class="p">].</span><span class="n">nr_ch</span> <span class="o">=</span> <span class="n">nr_ch</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* AC97 Codec channel setup. FIXME: this has no effect on some cards !! */</span>
<span class="c">	if (nr_ch &lt; 4) {</span>
<span class="c">		/* Copy stereo to rear channel (surround) */</span>
<span class="c">		snd_ac97_write_cache(vortex-&gt;codec,</span>
<span class="c">				     AC97_SIGMATEL_DAC2INVERT,</span>
<span class="c">				     snd_ac97_read(vortex-&gt;codec,</span>
<span class="c">						   AC97_SIGMATEL_DAC2INVERT)</span>
<span class="c">				     | 4);</span>
<span class="c">	} else {</span>
<span class="c">		/* Allow separate front and rear channels. */</span>
<span class="c">		snd_ac97_write_cache(vortex-&gt;codec,</span>
<span class="c">				     AC97_SIGMATEL_DAC2INVERT,</span>
<span class="c">				     snd_ac97_read(vortex-&gt;codec,</span>
<span class="c">						   AC97_SIGMATEL_DAC2INVERT)</span>
<span class="c">				     &amp; ~((u32)</span>
<span class="c">					 4));</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">dma</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> Set the SampleRate of the SRC&#39;s attached to the given DMA engine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_adb_setsrc</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">adbdma</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">adbdma</span><span class="p">]);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cvrt</span><span class="p">;</span>

	<span class="cm">/* dir=1:play ; dir=0:rec */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dir</span><span class="p">)</span>
		<span class="n">cvrt</span> <span class="o">=</span> <span class="n">SRC_RATIO</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mi">48000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cvrt</span> <span class="o">=</span> <span class="n">SRC_RATIO</span><span class="p">(</span><span class="mi">48000</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* Setup SRC&#39;s */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_SRC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">[</span><span class="n">VORTEX_RESOURCE_SRC</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">vortex_src_setupchannel</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cvrt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cvrt</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Connect DSP interface for SQ3500 turbo (not here i think...)</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_settimer</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Connect AC98 modem codec</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_STAT</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void vortex_enable_timer_int(vortex_t * card)</span>
<span class="c">{</span>
<span class="c">	hwwrite(card-&gt;mmio, VORTEX_IRQ_CTRL,</span>
<span class="c">		hwread(card-&gt;mmio, VORTEX_IRQ_CTRL) | IRQ_TIMER | 0x60);</span>
<span class="c">}</span>

<span class="c">static void vortex_disable_timer_int(vortex_t * card)</span>
<span class="c">{</span>
<span class="c">	hwwrite(card-&gt;mmio, VORTEX_IRQ_CTRL,</span>
<span class="c">		hwread(card-&gt;mmio, VORTEX_IRQ_CTRL) &amp; ~IRQ_TIMER);</span>
<span class="c">}</span>

<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_enable_int</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>vortex<em>route(vortex, en, 0x11, dma, ADB</em>XTALKIN(i?9:4));
vortex<em>route(vortex, en, 0x11, ADB</em>SRCOUT(src[i]), ADB_XTALKIN(i?4:9));</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">CTRL_IRQ_ENABLE</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_CTRL</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffefc0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x24</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_disable_int</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CTRL_IRQ_ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vortex_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">source</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Timer and ISR functions.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>set the timer period to <period> 48000ths of a second.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CTRL_IRQ_ENABLE</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_SOURCE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>CAsp4ISR<em>_EnableVortexInt</em>void_</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_SOURCE</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_SOURCE</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>check if the interrupt is ours.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: missing irq source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>This is the Interrupt Enable flag we set before (consistency check).</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_ERR_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_FATAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: IRQ fatal error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_PARITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: IRQ parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_REG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: IRQ reg error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_FIFO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: IRQ fifo error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_DMA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: IRQ dma error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_PCMOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ALSA period acknowledge. */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_ADB</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo_status</span> <span class="o">==</span> <span class="n">FIFO_START</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vortex_adbdma_bufshift</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						       <span class="n">substream</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8810</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_WT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fifo_status</span> <span class="o">==</span> <span class="n">FIFO_START</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vortex_wtdma_bufshift</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
				<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						       <span class="n">substream</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Reset IRQ flags.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_STAT</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">source</span> <span class="o">&amp;</span> <span class="n">IRQ_MIDI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_mpu401_uart_interrupt</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
					  <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: unknown irq source %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Codec */</span>

<span class="cp">#define POLL_COUNT 1000</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_codec_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the windows driver writes -i, so we write -i */</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="p">(</span><span class="n">VORTEX_CODEC_CHN</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="n">i</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x8068</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x00e8</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x00a8</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x80a8</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x80e8</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x80a8</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x00a8</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0x00e8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="p">(</span><span class="n">VORTEX_CODEC_CHN</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="n">i</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Enable codec channels 0 and 1. */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_EN</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_EN</span><span class="p">)</span> <span class="o">|</span> <span class="n">EN_CODEC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">vortex_codec_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* wait for transactions to clear */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lifeboat</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">POLL_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: ac97 codec stuck busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* write register */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_IO</span><span class="p">,</span>
		<span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">VORTEX_CODEC_ADDSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VORTEX_CODEC_ADDMASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">VORTEX_CODEC_DATSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VORTEX_CODEC_DATMASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VORTEX_CODEC_WRITE</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">VORTEX_CODEC_ID_SHIFT</span><span class="p">)</span> <span class="p">);</span>

	<span class="cm">/* Flush Caches. */</span>
	<span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_IO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="nf">vortex_codec_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_ac97</span> <span class="o">*</span> <span class="n">codec</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">codec</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">read_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lifeboat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* wait for transactions to clear */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lifeboat</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">POLL_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: ac97 codec stuck busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* set up read address */</span>
	<span class="n">read_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">VORTEX_CODEC_ADDSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">VORTEX_CODEC_ADDMASK</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">codec</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="n">VORTEX_CODEC_ID_SHIFT</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_IO</span><span class="p">,</span> <span class="n">read_addr</span><span class="p">);</span>

	<span class="cm">/* wait for address */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">hwread</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_IO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lifeboat</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">POLL_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: ac97 address never arrived</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">VORTEX_CODEC_ADDMASK</span><span class="p">)</span> <span class="o">!=</span>
		 <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">VORTEX_CODEC_ADDSHIFT</span><span class="p">));</span>

	<span class="cm">/* return data. */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">VORTEX_CODEC_DATMASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* SPDIF support  */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_spdif_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spdif_sr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">spdif_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">this_38</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_04</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_08</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">this_0c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* CAsp4Spdif::InitializeSpdifHardware(void) */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SPDIF_FLAGS</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SPDIF_FLAGS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff3fffd</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Is at least one IRQ flag set?</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SPDIF_CFG1</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Attend every interrupt source.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_EN</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CODEC_EN</span><span class="p">)</span> <span class="o">|</span> <span class="n">EN_SPDIF</span><span class="p">);</span>

	<span class="cm">/* CAsp4Spdif::ProgramSRCInHardware(enum  SPDIF_SR,enum  SPDIFMODE) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_04</span> <span class="o">&amp;&amp;</span> <span class="n">this_08</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">edi</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(((</span><span class="mh">0x5DC00000</span> <span class="o">/</span> <span class="n">spdif_sr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x1ffff</span><span class="p">)</span>
				<span class="n">edi</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">edi</span> <span class="o">=</span> <span class="mh">0x1ffff</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">edi</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* this_04 and this_08 are the CASp4Src&#39;s (samplerate converters) */</span>
		<span class="n">vortex_src_setupchannel</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">this_04</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">this_0c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vortex_src_setupchannel</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">this_08</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					<span class="n">this_0c</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">edi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">spdif_sr</span><span class="p">;</span>
	<span class="n">spdif_sr</span> <span class="o">|=</span> <span class="mh">0x8c</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFD</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xF3FFFFFF</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">|=</span> <span class="mh">0x03000000</span><span class="p">;</span>	<span class="cm">/* set 32khz samplerate */</span>
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFF3F</span><span class="p">;</span>
		<span class="n">spdif_sr</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFD</span><span class="p">;</span>
		<span class="n">spdif_sr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFD</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xF0FFFFFF</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">|=</span> <span class="mh">0x03000000</span><span class="p">;</span>
		<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFF3F</span><span class="p">;</span>
		<span class="n">spdif_sr</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">spdif_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
			<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFD</span><span class="p">;</span>
			<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xF2FFFFFF</span><span class="p">;</span>
			<span class="n">this_38</span> <span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>	<span class="cm">/* set 48khz samplerate */</span>
			<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFF3F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* J. Gordon Wolfe: I think this stuff is for AC3 */</span>
			<span class="n">this_38</span> <span class="o">|=</span> <span class="mh">0x00000003</span><span class="p">;</span>
			<span class="n">this_38</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFBF</span><span class="p">;</span>
			<span class="n">this_38</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spdif_sr</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">spdif_sr</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFFFFE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* looks like the next 2 lines transfer a 16-bit value into 2 8-bit </span>
<span class="cm">	   registers. seems to be for the standard IEC/SPDIF initialization </span>
<span class="cm">	   stuff */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SPDIF_CFG0</span><span class="p">,</span> <span class="n">this_38</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SPDIF_CFG1</span><span class="p">,</span> <span class="n">this_38</span> <span class="o">&gt;&gt;</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_SPDIF_SMPRATE</span><span class="p">,</span> <span class="n">spdif_sr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialization */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vortex_core_init</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Vortex: init.... &quot;</span><span class="p">);</span>
	<span class="cm">/* Hardware Init. */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffdfffff</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* Reset IRQ flags */</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_SOURCE</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_STAT</span><span class="p">);</span>

	<span class="n">vortex_codec_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>

<span class="cp">#ifdef CHIP_AU8830</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">,</span>
		<span class="n">hwread</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1000000</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Init audio engine. */</span>
	<span class="n">vortex_adbdma_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_ENGINE_CTRL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>	<span class="c1">//, 0xc83c7e58, 0xc5f93e58</span>
	<span class="n">vortex_adb_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="cm">/* Init processing blocks. */</span>
	<span class="n">vortex_fifo_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="n">vortex_mixer_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="n">vortex_srcblock_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8820</span>
	<span class="n">vortex_eq_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="n">vortex_spdif_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vortex_Vort3D_enable</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="n">vortex_wt_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Acknowledge the Timer interrupt</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vortex_settimer</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>for (i=0x291D4; i&lt;0x29200; i+=4)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_core_shutdown</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span> <span class="n">vortex</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Vortex: shutdown...&quot;</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8820</span>
	<span class="n">vortex_eq_free</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="n">vortex_Vort3D_disable</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>hwwrite(vortex->mmio, 0x29190, hwread(vortex->mmio, 0x29190) | 0xc0000);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vortex_disable_int</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="n">vortex_connect_default</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Reset all DMA fifos. */</span>
	<span class="n">vortex_fifo_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>
	<span class="cm">/* Erase all audio routes. */</span>
	<span class="n">vortex_adb_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">);</span>

	<span class="cm">/* Disable MPU401 */</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Moved to au88x0.c
vortex<em>connect</em>default(vortex, 1);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">hwwrite</span><span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mmio</span><span class="p">,</span> <span class="n">VORTEX_IRQ_SOURCE</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Alsa support. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vortex_alsafmt_aspfmt</span><span class="p">(</span><span class="kt">int</span> <span class="n">alsafmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fmt</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">alsafmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_U8</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_MU_LAW</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_A_LAW</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_SPECIAL</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>	<span class="cm">/* guess. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_IEC958_SUBFRAME_LE</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>	<span class="cm">/* guess. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_LE</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_FORMAT_S16_BE</span>:
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>	<span class="cm">/* check this... */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vortex: format unsupported %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">alsafmt</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">fmt</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Some not yet useful translations. */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">typedef enum {</span>
<span class="c">	ASPFMTLINEAR16 = 0,	/* 0x8 */</span>
<span class="c">	ASPFMTLINEAR8,		/* 0x1 */</span>
<span class="c">	ASPFMTULAW,		/* 0x2 */</span>
<span class="c">	ASPFMTALAW,		/* 0x3 */</span>
<span class="c">	ASPFMTSPORT,		/* ? */</span>
<span class="c">	ASPFMTSPDIF,		/* ? */</span>
<span class="c">} ASPENCODING;</span>

<span class="c">static int</span>
<span class="c">vortex_translateformat(vortex_t * vortex, char bits, char nch, int encod)</span>
<span class="c">{</span>
<span class="c">	int a, this_194;</span>

<span class="c">	if ((bits != 8) &amp;&amp; (bits != 16))</span>
<span class="c">		return -1;</span>

<span class="c">	switch (encod) {</span>
<span class="c">	case 0:</span>
<span class="c">		if (bits == 0x10)</span>
<span class="c">			a = 8;	// 16 bit</span>
<span class="c">		break;</span>
<span class="c">	case 1:</span>
<span class="c">		if (bits == 8)</span>
<span class="c">			a = 1;	// 8 bit</span>
<span class="c">		break;</span>
<span class="c">	case 2:</span>
<span class="c">		a = 2;		// U_LAW</span>
<span class="c">		break;</span>
<span class="c">	case 3:</span>
<span class="c">		a = 3;		// A_LAW</span>
<span class="c">		break;</span>
<span class="c">	}</span>
<span class="c">	switch (nch) {</span>
<span class="c">	case 1:</span>
<span class="c">		this_194 = 0;</span>
<span class="c">		break;</span>
<span class="c">	case 2:</span>
<span class="c">		this_194 = 1;</span>
<span class="c">		break;</span>
<span class="c">	case 4:</span>
<span class="c">		this_194 = 1;</span>
<span class="c">		break;</span>
<span class="c">	case 6:</span>
<span class="c">		this_194 = 1;</span>
<span class="c">		break;</span>
<span class="c">	}</span>
<span class="c">	return (a);</span>
<span class="c">}</span>

<span class="c">static void vortex_cdmacore_setformat(vortex_t * vortex, int bits, int nch)</span>
<span class="c">{</span>
<span class="c">	short int d, this_148;</span>

<span class="c">	d = ((bits &gt;&gt; 3) * nch);</span>
<span class="c">	this_148 = 0xbb80 / d;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>Enable Interrupts.
vortex<em>enable</em>int() must be first !!
 hwwrite(vortex->mmio, VORTEX<em>IRQ</em>CTRL, 0);
vortex<em>enable</em>int(vortex);
vortex<em>enable</em>timer<em>int(vortex);
vortex</em>disable<em>timer</em>int(vortex);</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>vortex<em>disable</em>timer_int(vortex);</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>hwwrite(vortex->mmio, VORTEX<em>IRQ</em>CTRL, hwread(vortex->mmio, VORTEX<em>IRQ</em>CTRL) &amp; ~IRQ<em>MIDI);
hwwrite(vortex->mmio, VORTEX</em>CTRL, hwread(vortex->mmio, VORTEX<em>CTRL) &amp; ~CTRL</em>MIDI_EN);</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
