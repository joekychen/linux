<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › au88x0 › au88x0_pcm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>au88x0_pcm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU Library General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>
 
<span class="cm">/*</span>
<span class="cm"> * Vortex PCM ALSA driver.</span>
<span class="cm"> *</span>
<span class="cm"> * Supports ADB and WT DMA. Unfortunately, WT channels do not run yet.</span>
<span class="cm"> * It remains stuck,and DMA transfers do not happen. </span>
<span class="cm"> */</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &quot;au88x0.h&quot;</span>

<span class="cp">#define VORTEX_PCM_TYPE(x) (x-&gt;name[40])</span>

<span class="cm">/* hardware definition */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vortex_playback_hw_adb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="cm">/* SNDRV_PCM_INFO_RESUME | */</span>
	     <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
	     <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
	    <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
	    <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifndef CHIP_AU8820</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vortex_playback_hw_a3d</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="cm">/* SNDRV_PCM_INFO_RESUME | */</span>
	     <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
	     <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
	    <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
	    <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vortex_playback_hw_spdif</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="cm">/* SNDRV_PCM_INFO_RESUME | */</span>
	     <span class="n">SNDRV_PCM_INFO_PAUSE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
	     <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>
	    <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span>
	    <span class="n">SNDRV_PCM_FMTBIT_IEC958_SUBFRAME_LE</span> <span class="o">|</span> <span class="n">SNDRV_PCM_FMTBIT_MU_LAW</span> <span class="o">|</span>
	    <span class="n">SNDRV_PCM_FMTBIT_A_LAW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>
	    <span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifndef CHIP_AU8810</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_vortex_playback_hw_wt</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S16_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_8000_48000</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_CONTINUOUS</span><span class="p">,</span>	<span class="c1">// SNDRV_PCM_RATE_48000,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span> <span class="mh">0x10000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CHIP_AU8830</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">au8830_channels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hw_constraints_au8830_channels</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">au8830_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">au8830_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vortex_notify_pcm_vol_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">activate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">activate</span><span class="p">)</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
	<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
				<span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* open callback */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	
	<span class="cm">/* Force equal size periods */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span>
	     <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					   <span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="cm">/* Avoid PAGE_SIZE boundary to fall inside of a period. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span>
	     <span class="n">snd_pcm_hw_constraint_pow2</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">SNDRV_PCM_HW_PARAM_PERIOD_BYTES</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">SNDRV_PCM_HW_PARAM_BUFFER_BYTES</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef CHIP_AU8820</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_A3D</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vortex_playback_hw_a3d</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vortex_playback_hw_spdif</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">spdif_sr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">32000</span>:
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_32000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">44100</span>:
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_44100</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">48000</span>:
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_48000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span>
		    <span class="o">||</span> <span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_I2S</span><span class="p">)</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vortex_playback_hw_adb</span><span class="p">;</span>
<span class="cp">#ifdef CHIP_AU8830</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span> <span class="o">&amp;&amp;</span>
			<span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hw_constraints_au8830_channels</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_vortex_playback_hw_wt</span><span class="p">;</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* close callback */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>vortex<em>t *chip = snd</em>pcm<em>substream</em>chip(substream);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>the hardware-specific codes will be here</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">nr_ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hw_params callback */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">snd_vortex_pcm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Alloc buffer memory.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">params_buffer_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Vortex: pcm page alloc failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	   printk(KERN_INFO &quot;Vortex: periods %d, period_bytes %d, channels = %d\n&quot;, params_periods(hw_params),</span>
<span class="cm">	   params_period_bytes(hw_params), params_channels(hw_params));</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Make audio routes and config buffer DMA.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dma</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="cm">/* Dealloc any routes. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">vortex_adb_allocroute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					      <span class="n">stream</span><span class="o">-&gt;</span><span class="n">nr_ch</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span>
					      <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					      <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="cm">/* Alloc routes. */</span>
		<span class="n">dma</span> <span class="o">=</span>
		    <span class="n">vortex_adb_allocroute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					  <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
					  <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
					  <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">dma</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">dma</span><span class="p">];</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="cm">/* Setup Buffers. */</span>
		<span class="n">vortex_adbdma_setbuffers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span>
					 <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
					 <span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vortex_notify_pcm_vol_change</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">kctl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* if (stream != NULL)</span>
<span class="cm">		   vortex_wt_allocroute(chip, substream-&gt;number, 0); */</span>
		<span class="n">vortex_wt_allocroute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				     <span class="n">params_channels</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dma_wt</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
		<span class="n">vortex_wtdma_setbuffers</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
					<span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">),</span>
					<span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* hw_free callback */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Delete audio routes.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">vortex_notify_pcm_vol_change</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">].</span><span class="n">kctl</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">vortex_adb_allocroute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span>
					      <span class="n">stream</span><span class="o">-&gt;</span><span class="n">nr_ch</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dir</span><span class="p">,</span>
					      <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					      <span class="n">substream</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">vortex_wt_allocroute</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* prepare callback */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">dir</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>set up the hardware with the current configuration.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmt</span> <span class="o">=</span> <span class="n">vortex_alsafmt_aspfmt</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vortex_adbdma_setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span>
				<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">vortex_adbdma_setstartbuffer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span>
			<span class="n">vortex_adb_setsrc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">vortex_wtdma_setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>FIXME: Set rate (i guess using vortex<em>wt</em>writereg() somehow).</p></td><td class="code"><div class="highlight"><pre>		<span class="n">vortex_wtdma_setstartbuffer</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* trigger callback */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:</pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>do something to start the PCM engine
printk(KERN_INFO "vortex: start %d\n", dma);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vortex_adbdma_resetup</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="n">vortex_adbdma_startfifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifndef CHIP_AU8810</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;vortex: wt start %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="n">vortex_wtdma_startfifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:</pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>do something to stop the PCM engine
printk(KERN_INFO "vortex: stop %d\n", dma);</p></td><td class="code"><div class="highlight"><pre>		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">fifo_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span>
			<span class="n">vortex_adbdma_stopfifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8810</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;vortex: wt stop %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="n">vortex_wtdma_stopfifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span>:</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>printk(KERN_INFO "vortex: pause %d\n", dma);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span>
			<span class="n">vortex_adbdma_pausefifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8810</span>
		<span class="k">else</span>
			<span class="n">vortex_wtdma_pausefifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span>:</pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>printk(KERN_INFO "vortex: resume %d\n", dma);</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span>
			<span class="n">vortex_adbdma_resumefifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8810</span>
		<span class="k">else</span>
			<span class="n">vortex_wtdma_resumefifo</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pointer callback */</span>
<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_vortex_pcm_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">stream_t</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">snd_pcm_uframes_t</span> <span class="n">current_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VORTEX_PCM_WT</span><span class="p">)</span>
		<span class="n">current_ptr</span> <span class="o">=</span> <span class="n">vortex_adbdma_getlinearpos</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#ifndef CHIP_AU8810</span>
	<span class="k">else</span>
		<span class="n">current_ptr</span> <span class="o">=</span> <span class="n">vortex_wtdma_getlinearpos</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>printk(KERN<em>INFO "vortex: pointer = 0x%x\n", current</em>ptr);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">,</span> <span class="n">current_ptr</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* operators */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_vortex_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm">*  definitions of capture are omitted here...</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vortex_pcm_prettyname</span><span class="p">[</span><span class="n">VORTEX_PCM_LAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CARD_NAME</span> <span class="s">&quot; ADB&quot;</span><span class="p">,</span>
	<span class="n">CARD_NAME</span> <span class="s">&quot; SPDIF&quot;</span><span class="p">,</span>
	<span class="n">CARD_NAME</span> <span class="s">&quot; A3D&quot;</span><span class="p">,</span>
	<span class="n">CARD_NAME</span> <span class="s">&quot; WT&quot;</span><span class="p">,</span>
	<span class="n">CARD_NAME</span> <span class="s">&quot; I2S&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vortex_pcm_name</span><span class="p">[</span><span class="n">VORTEX_PCM_LAST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;adb&quot;</span><span class="p">,</span>
	<span class="s">&quot;spdif&quot;</span><span class="p">,</span>
	<span class="s">&quot;a3d&quot;</span><span class="p">,</span>
	<span class="s">&quot;wt&quot;</span><span class="p">,</span>
	<span class="s">&quot;i2s&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* SPDIF kcontrol */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES1_CON_ORIGINAL</span><span class="o">|</span><span class="n">IEC958_AES1_CON_DIGDIGCONV_ID</span><span class="p">;</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">spdif_sr</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>: <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_32000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>: <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_44100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>: <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">IEC958_AES3_CON_FS_48000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">spdif_sr</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES3_CON_FS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_32000</span>: <span class="n">spdif_sr</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_44100</span>: <span class="n">spdif_sr</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEC958_AES3_CON_FS_48000</span>: <span class="n">spdif_sr</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spdif_sr</span> <span class="o">==</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">spdif_sr</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">spdif_sr</span> <span class="o">=</span> <span class="n">spdif_sr</span><span class="p">;</span>
	<span class="n">vortex_spdif_init</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span> <span class="n">vortex</span><span class="o">-&gt;</span><span class="n">spdif_sr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* spdif controls */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vortex_mixer_spdif</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_vortex_spdif_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_vortex_spdif_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_vortex_spdif_put</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">CON_MASK</span><span class="p">),</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_vortex_spdif_info</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_vortex_spdif_mask_get</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* subdevice PCM Volume control */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">subdev</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_vol</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">subdev</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">max_chn</span> <span class="o">=</span> <span class="p">(</span><span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_chn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_vortex_pcm_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mixin</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vol</span><span class="p">;</span>
	<span class="n">vortex_t</span> <span class="o">*</span><span class="n">vortex</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">subdev</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_vol</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">subdev</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">max_chn</span> <span class="o">=</span> <span class="p">(</span><span class="n">VORTEX_IS_QUAD</span><span class="p">(</span><span class="n">vortex</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_chn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">vortex</span><span class="o">-&gt;</span><span class="n">dma_adb</span><span class="p">[</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">].</span><span class="n">nr_ch</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mi">1</span>:
					<span class="n">mixin</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mixin</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">2</span>:
				<span class="nl">default:</span>
					<span class="n">mixin</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mixin</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mi">4</span>:
					<span class="n">mixin</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">mixin</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">};</span>
				<span class="n">vol</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">vol</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">vortex_mix_setinputvolumebyte</span><span class="p">(</span><span class="n">vortex</span><span class="p">,</span>
					<span class="n">vortex</span><span class="o">-&gt;</span><span class="n">mixplayb</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mixin</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">changed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">DECLARE_TLV_DB_MINMAX</span><span class="p">(</span><span class="n">vortex_pcm_vol_db_scale</span><span class="p">,</span> <span class="o">-</span><span class="mi">9600</span><span class="p">,</span> <span class="mi">2400</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_vortex_pcm_vol</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PCM Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
		<span class="n">SNDRV_CTL_ELEM_ACCESS_TLV_READ</span> <span class="o">|</span>
		<span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_vol_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_vortex_pcm_vol_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tlv</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">vortex_pcm_vol_db_scale</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* create a pcm device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_vortex_new_pcm</span><span class="p">(</span><span class="n">vortex_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">nr_capt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">VORTEX_PCM_LAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* idx indicates which kind of PCM device. ADB, SPDIF, I2S and A3D share the </span>
<span class="cm">	 * same dma engine. WT uses it own separate dma engine which can&#39;t capture. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span>
		<span class="n">nr_capt</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nr_capt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vortex_pcm_prettyname</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">idx</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
			  <span class="n">nr_capt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
		<span class="s">&quot;%s %s&quot;</span><span class="p">,</span> <span class="n">CARD_NAME_SHORT</span><span class="p">,</span> <span class="n">vortex_pcm_name</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>This is an evil hack, but it saves a lot of duplicated code.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="cm">/* set operators */</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_vortex_playback_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span>
		<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">snd_vortex_playback_ops</span><span class="p">);</span>
	
	<span class="cm">/* pre-allocation of Scatter-Gather buffers */</span>
	
	<span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
					      <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">),</span>
					      <span class="mh">0x10000</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_SPDIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_vortex_mixer_spdif</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vortex_mixer_spdif</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VORTEX_PCM_TYPE</span><span class="p">(</span><span class="n">pcm</span><span class="p">)</span> <span class="o">==</span> <span class="n">VORTEX_PCM_ADB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_PCM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_vortex_pcm_vol</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kctl</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pcm_vol</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kctl</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">kctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
