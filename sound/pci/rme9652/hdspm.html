<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › rme9652 › hdspm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hdspm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for RME Hammerfall DSP MADI audio interface(s)</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (c) 2003 Winfried Ritsch (IEM)</span>
<span class="cm"> *      code based on hdsp.c   Paul Davis</span>
<span class="cm"> *                             Marcus Andersson</span>
<span class="cm"> *                             Thomas Charbonnel</span>
<span class="cm"> *      Modified 2006-06-01 for AES32 support by Remy Bruno</span>
<span class="cm"> *                                               &lt;remy.bruno@trinnov.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      Modified 2009-04-13 for proper metering by Florian Faber</span>
<span class="cm"> *                                               &lt;faber@faberman.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      Modified 2009-04-14 for native float support by Florian Faber</span>
<span class="cm"> *                                               &lt;faber@faberman.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      Modified 2009-04-26 fixed bug in rms metering by Florian Faber</span>
<span class="cm"> *                                               &lt;faber@faberman.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *      Modified 2009-04-30 added hw serial number support by Florian Faber</span>
<span class="cm"> *</span>
<span class="cm"> *      Modified 2011-01-14 added S/PDIF input on RayDATs by Adrian Knoth</span>
<span class="cm"> *</span>
<span class="cm"> *	Modified 2011-01-25 variable period sizes on RayDAT/AIO by Adrian Knoth</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/math64.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;sound/rawmidi.h&gt;</span>
<span class="cp">#include &lt;sound/hwdep.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;sound/hdspm.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	  <span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	  <span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span><span class="cm">/* Enable this card */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for RME HDSPM interface.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for RME HDSPM interface.&quot;</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable/disable specific HDSPM soundcards.&quot;</span><span class="p">);</span>


<span class="n">MODULE_AUTHOR</span>
<span class="p">(</span>
	<span class="s">&quot;Winfried Ritsch &lt;ritsch_AT_iem.at&gt;, &quot;</span>
	<span class="s">&quot;Paul Davis &lt;paul@linuxaudiosystems.com&gt;, &quot;</span>
	<span class="s">&quot;Marcus Andersson, Thomas Charbonnel &lt;thomas@undata.org&gt;, &quot;</span>
	<span class="s">&quot;Remy Bruno &lt;remy.bruno@trinnov.com&gt;, &quot;</span>
	<span class="s">&quot;Florian Faber &lt;faberman@linuxproaudio.org&gt;, &quot;</span>
	<span class="s">&quot;Adrian Knoth &lt;adi@drcomp.erfurt.thur.de&gt;&quot;</span>
<span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RME HDSPM&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{RME HDSPM-MADI}}&quot;</span><span class="p">);</span>

<span class="cm">/* --- Write registers. ---</span>
<span class="cm">  These are defined as byte-offsets from the iobase value.  */</span>

<span class="cp">#define HDSPM_WR_SETTINGS             0</span>
<span class="cp">#define HDSPM_outputBufferAddress    32</span>
<span class="cp">#define HDSPM_inputBufferAddress     36</span>
<span class="cp">#define HDSPM_controlRegister	     64</span>
<span class="cp">#define HDSPM_interruptConfirmation  96</span>
<span class="cp">#define HDSPM_control2Reg	     256  </span><span class="cm">/* not in specs ???????? */</span><span class="cp"></span>
<span class="cp">#define HDSPM_freqReg                256  </span><span class="cm">/* for AES32 */</span><span class="cp"></span>
<span class="cp">#define HDSPM_midiDataOut0	     352  </span><span class="cm">/* just believe in old code */</span><span class="cp"></span>
<span class="cp">#define HDSPM_midiDataOut1	     356</span>
<span class="cp">#define HDSPM_eeprom_wr		     384  </span><span class="cm">/* for AES32 */</span><span class="cp"></span>

<span class="cm">/* DMA enable for 64 channels, only Bit 0 is relevant */</span>
<span class="cp">#define HDSPM_outputEnableBase       512  </span><span class="cm">/* 512-767  input  DMA */</span><span class="cp"></span>
<span class="cp">#define HDSPM_inputEnableBase        768  </span><span class="cm">/* 768-1023 output DMA */</span><span class="cp"></span>

<span class="cm">/* 16 page addresses for each of the 64 channels DMA buffer in and out</span>
<span class="cm">   (each 64k=16*4k) Buffer must be 4k aligned (which is default i386 ????) */</span>
<span class="cp">#define HDSPM_pageAddressBufferOut       8192</span>
<span class="cp">#define HDSPM_pageAddressBufferIn        (HDSPM_pageAddressBufferOut+64*16*4)</span>

<span class="cp">#define HDSPM_MADI_mixerBase    32768	</span><span class="cm">/* 32768-65535 for 2x64x64 Fader */</span><span class="cp"></span>

<span class="cp">#define HDSPM_MATRIX_MIXER_SIZE  8192	</span><span class="cm">/* = 2*64*64 * 4 Byte =&gt; 32kB */</span><span class="cp"></span>

<span class="cm">/* --- Read registers. ---</span>
<span class="cm">   These are defined as byte-offsets from the iobase value */</span>
<span class="cp">#define HDSPM_statusRegister    0</span>
<span class="cm">/*#define HDSPM_statusRegister2  96 */</span>
<span class="cm">/* after RME Windows driver sources, status2 is 4-byte word # 48 = word at</span>
<span class="cm"> * offset 192, for AES32 *and* MADI</span>
<span class="cm"> * =&gt; need to check that offset 192 is working on MADI */</span>
<span class="cp">#define HDSPM_statusRegister2  192</span>
<span class="cp">#define HDSPM_timecodeRegister 128</span>

<span class="cm">/* AIO, RayDAT */</span>
<span class="cp">#define HDSPM_RD_STATUS_0 0</span>
<span class="cp">#define HDSPM_RD_STATUS_1 64</span>
<span class="cp">#define HDSPM_RD_STATUS_2 128</span>
<span class="cp">#define HDSPM_RD_STATUS_3 192</span>

<span class="cp">#define HDSPM_RD_TCO           256</span>
<span class="cp">#define HDSPM_RD_PLL_FREQ      512</span>
<span class="cp">#define HDSPM_WR_TCO           128</span>

<span class="cp">#define HDSPM_TCO1_TCO_lock			0x00000001</span>
<span class="cp">#define HDSPM_TCO1_WCK_Input_Range_LSB		0x00000002</span>
<span class="cp">#define HDSPM_TCO1_WCK_Input_Range_MSB		0x00000004</span>
<span class="cp">#define HDSPM_TCO1_LTC_Input_valid		0x00000008</span>
<span class="cp">#define HDSPM_TCO1_WCK_Input_valid		0x00000010</span>
<span class="cp">#define HDSPM_TCO1_Video_Input_Format_NTSC	0x00000020</span>
<span class="cp">#define HDSPM_TCO1_Video_Input_Format_PAL	0x00000040</span>

<span class="cp">#define HDSPM_TCO1_set_TC			0x00000100</span>
<span class="cp">#define HDSPM_TCO1_set_drop_frame_flag		0x00000200</span>
<span class="cp">#define HDSPM_TCO1_LTC_Format_LSB		0x00000400</span>
<span class="cp">#define HDSPM_TCO1_LTC_Format_MSB		0x00000800</span>

<span class="cp">#define HDSPM_TCO2_TC_run			0x00010000</span>
<span class="cp">#define HDSPM_TCO2_WCK_IO_ratio_LSB		0x00020000</span>
<span class="cp">#define HDSPM_TCO2_WCK_IO_ratio_MSB		0x00040000</span>
<span class="cp">#define HDSPM_TCO2_set_num_drop_frames_LSB	0x00080000</span>
<span class="cp">#define HDSPM_TCO2_set_num_drop_frames_MSB	0x00100000</span>
<span class="cp">#define HDSPM_TCO2_set_jam_sync			0x00200000</span>
<span class="cp">#define HDSPM_TCO2_set_flywheel			0x00400000</span>

<span class="cp">#define HDSPM_TCO2_set_01_4			0x01000000</span>
<span class="cp">#define HDSPM_TCO2_set_pull_down		0x02000000</span>
<span class="cp">#define HDSPM_TCO2_set_pull_up			0x04000000</span>
<span class="cp">#define HDSPM_TCO2_set_freq			0x08000000</span>
<span class="cp">#define HDSPM_TCO2_set_term_75R			0x10000000</span>
<span class="cp">#define HDSPM_TCO2_set_input_LSB		0x20000000</span>
<span class="cp">#define HDSPM_TCO2_set_input_MSB		0x40000000</span>
<span class="cp">#define HDSPM_TCO2_set_freq_from_app		0x80000000</span>


<span class="cp">#define HDSPM_midiDataOut0    352</span>
<span class="cp">#define HDSPM_midiDataOut1    356</span>
<span class="cp">#define HDSPM_midiDataOut2    368</span>

<span class="cp">#define HDSPM_midiDataIn0     360</span>
<span class="cp">#define HDSPM_midiDataIn1     364</span>
<span class="cp">#define HDSPM_midiDataIn2     372</span>
<span class="cp">#define HDSPM_midiDataIn3     376</span>

<span class="cm">/* status is data bytes in MIDI-FIFO (0-128) */</span>
<span class="cp">#define HDSPM_midiStatusOut0  384</span>
<span class="cp">#define HDSPM_midiStatusOut1  388</span>
<span class="cp">#define HDSPM_midiStatusOut2  400</span>

<span class="cp">#define HDSPM_midiStatusIn0   392</span>
<span class="cp">#define HDSPM_midiStatusIn1   396</span>
<span class="cp">#define HDSPM_midiStatusIn2   404</span>
<span class="cp">#define HDSPM_midiStatusIn3   408</span>


<span class="cm">/* the meters are regular i/o-mapped registers, but offset</span>
<span class="cm">   considerably from the rest. the peak registers are reset</span>
<span class="cm">   when read; the least-significant 4 bits are full-scale counters;</span>
<span class="cm">   the actual peak value is in the most-significant 24 bits.</span>
<span class="cm">*/</span>

<span class="cp">#define HDSPM_MADI_INPUT_PEAK		4096</span>
<span class="cp">#define HDSPM_MADI_PLAYBACK_PEAK	4352</span>
<span class="cp">#define HDSPM_MADI_OUTPUT_PEAK		4608</span>

<span class="cp">#define HDSPM_MADI_INPUT_RMS_L		6144</span>
<span class="cp">#define HDSPM_MADI_PLAYBACK_RMS_L	6400</span>
<span class="cp">#define HDSPM_MADI_OUTPUT_RMS_L		6656</span>

<span class="cp">#define HDSPM_MADI_INPUT_RMS_H		7168</span>
<span class="cp">#define HDSPM_MADI_PLAYBACK_RMS_H	7424</span>
<span class="cp">#define HDSPM_MADI_OUTPUT_RMS_H		7680</span>

<span class="cm">/* --- Control Register bits --------- */</span>
<span class="cp">#define HDSPM_Start                (1&lt;&lt;0) </span><span class="cm">/* start engine */</span><span class="cp"></span>

<span class="cp">#define HDSPM_Latency0             (1&lt;&lt;1) </span><span class="cm">/* buffer size = 2^n */</span><span class="cp"></span>
<span class="cp">#define HDSPM_Latency1             (1&lt;&lt;2) </span><span class="cm">/* where n is defined */</span><span class="cp"></span>
<span class="cp">#define HDSPM_Latency2             (1&lt;&lt;3) </span><span class="cm">/* by Latency{2,1,0} */</span><span class="cp"></span>

<span class="cp">#define HDSPM_ClockModeMaster      (1&lt;&lt;4) </span><span class="cm">/* 1=Master, 0=Autosync */</span><span class="cp"></span>
<span class="cp">#define HDSPM_c0Master		0x1    </span><span class="cm">/* Master clock bit in settings</span>
<span class="cm">					  register [RayDAT, AIO] */</span><span class="cp"></span>

<span class="cp">#define HDSPM_AudioInterruptEnable (1&lt;&lt;5) </span><span class="cm">/* what do you think ? */</span><span class="cp"></span>

<span class="cp">#define HDSPM_Frequency0  (1&lt;&lt;6)  </span><span class="cm">/* 0=44.1kHz/88.2kHz 1=48kHz/96kHz */</span><span class="cp"></span>
<span class="cp">#define HDSPM_Frequency1  (1&lt;&lt;7)  </span><span class="cm">/* 0=32kHz/64kHz */</span><span class="cp"></span>
<span class="cp">#define HDSPM_DoubleSpeed (1&lt;&lt;8)  </span><span class="cm">/* 0=normal speed, 1=double speed */</span><span class="cp"></span>
<span class="cp">#define HDSPM_QuadSpeed   (1&lt;&lt;31) </span><span class="cm">/* quad speed bit */</span><span class="cp"></span>

<span class="cp">#define HDSPM_Professional (1&lt;&lt;9) </span><span class="cm">/* Professional */</span><span class="cp"> </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>
<span class="cp">#define HDSPM_TX_64ch     (1&lt;&lt;10) </span><span class="cm">/* Output 64channel MODE=1,</span>
<span class="cm">				     56channelMODE=0 */</span><span class="cp"> </span><span class="cm">/* MADI ONLY*/</span><span class="cp"></span>
<span class="cp">#define HDSPM_Emphasis    (1&lt;&lt;10) </span><span class="cm">/* Emphasis */</span><span class="cp"> </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>

<span class="cp">#define HDSPM_AutoInp     (1&lt;&lt;11) </span><span class="cm">/* Auto Input (takeover) == Safe Mode,</span>
<span class="cm">                                     0=off, 1=on  */</span><span class="cp"> </span><span class="cm">/* MADI ONLY */</span><span class="cp"></span>
<span class="cp">#define HDSPM_Dolby       (1&lt;&lt;11) </span><span class="cm">/* Dolby = &quot;NonAudio&quot; ?? */</span><span class="cp"> </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>

<span class="cp">#define HDSPM_InputSelect0 (1&lt;&lt;14) </span><span class="cm">/* Input select 0= optical, 1=coax</span>
<span class="cm">				    * -- MADI ONLY</span>
<span class="cm">				    */</span><span class="cp"></span>
<span class="cp">#define HDSPM_InputSelect1 (1&lt;&lt;15) </span><span class="cm">/* should be 0 */</span><span class="cp"></span>

<span class="cp">#define HDSPM_SyncRef2     (1&lt;&lt;13)</span>
<span class="cp">#define HDSPM_SyncRef3     (1&lt;&lt;25)</span>

<span class="cp">#define HDSPM_SMUX         (1&lt;&lt;18) </span><span class="cm">/* Frame ??? */</span><span class="cp"> </span><span class="cm">/* MADI ONY */</span><span class="cp"></span>
<span class="cp">#define HDSPM_clr_tms      (1&lt;&lt;19) </span><span class="cm">/* clear track marker, do not use</span>
<span class="cm">                                      AES additional bits in</span>
<span class="cm">				      lower 5 Audiodatabits ??? */</span><span class="cp"></span>
<span class="cp">#define HDSPM_taxi_reset   (1&lt;&lt;20) </span><span class="cm">/* ??? */</span><span class="cp"> </span><span class="cm">/* MADI ONLY ? */</span><span class="cp"></span>
<span class="cp">#define HDSPM_WCK48        (1&lt;&lt;20) </span><span class="cm">/* Frame ??? = HDSPM_SMUX */</span><span class="cp"> </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>

<span class="cp">#define HDSPM_Midi0InterruptEnable 0x0400000</span>
<span class="cp">#define HDSPM_Midi1InterruptEnable 0x0800000</span>
<span class="cp">#define HDSPM_Midi2InterruptEnable 0x0200000</span>
<span class="cp">#define HDSPM_Midi3InterruptEnable 0x4000000</span>

<span class="cp">#define HDSPM_LineOut (1&lt;&lt;24) </span><span class="cm">/* Analog Out on channel 63/64 on=1, mute=0 */</span><span class="cp"></span>
<span class="cp">#define HDSPe_FLOAT_FORMAT         0x2000000</span>

<span class="cp">#define HDSPM_DS_DoubleWire (1&lt;&lt;26) </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>
<span class="cp">#define HDSPM_QS_DoubleWire (1&lt;&lt;27) </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>
<span class="cp">#define HDSPM_QS_QuadWire   (1&lt;&lt;28) </span><span class="cm">/* AES32 ONLY */</span><span class="cp"></span>

<span class="cp">#define HDSPM_wclk_sel (1&lt;&lt;30)</span>

<span class="cm">/* --- bit helper defines */</span>
<span class="cp">#define HDSPM_LatencyMask    (HDSPM_Latency0|HDSPM_Latency1|HDSPM_Latency2)</span>
<span class="cp">#define HDSPM_FrequencyMask  (HDSPM_Frequency0|HDSPM_Frequency1|\</span>
<span class="cp">			      HDSPM_DoubleSpeed|HDSPM_QuadSpeed)</span>
<span class="cp">#define HDSPM_InputMask      (HDSPM_InputSelect0|HDSPM_InputSelect1)</span>
<span class="cp">#define HDSPM_InputOptical   0</span>
<span class="cp">#define HDSPM_InputCoaxial   (HDSPM_InputSelect0)</span>
<span class="cp">#define HDSPM_SyncRefMask    (HDSPM_SyncRef0|HDSPM_SyncRef1|\</span>
<span class="cp">			      HDSPM_SyncRef2|HDSPM_SyncRef3)</span>

<span class="cp">#define HDSPM_c0_SyncRef0      0x2</span>
<span class="cp">#define HDSPM_c0_SyncRef1      0x4</span>
<span class="cp">#define HDSPM_c0_SyncRef2      0x8</span>
<span class="cp">#define HDSPM_c0_SyncRef3      0x10</span>
<span class="cp">#define HDSPM_c0_SyncRefMask   (HDSPM_c0_SyncRef0 | HDSPM_c0_SyncRef1 |\</span>
<span class="cp">				HDSPM_c0_SyncRef2 | HDSPM_c0_SyncRef3)</span>

<span class="cp">#define HDSPM_SYNC_FROM_WORD    0	</span><span class="cm">/* Preferred sync reference */</span><span class="cp"></span>
<span class="cp">#define HDSPM_SYNC_FROM_MADI    1	</span><span class="cm">/* choices - used by &quot;pref_sync_ref&quot; */</span><span class="cp"></span>
<span class="cp">#define HDSPM_SYNC_FROM_TCO     2</span>
<span class="cp">#define HDSPM_SYNC_FROM_SYNC_IN 3</span>

<span class="cp">#define HDSPM_Frequency32KHz    HDSPM_Frequency0</span>
<span class="cp">#define HDSPM_Frequency44_1KHz  HDSPM_Frequency1</span>
<span class="cp">#define HDSPM_Frequency48KHz   (HDSPM_Frequency1|HDSPM_Frequency0)</span>
<span class="cp">#define HDSPM_Frequency64KHz   (HDSPM_DoubleSpeed|HDSPM_Frequency0)</span>
<span class="cp">#define HDSPM_Frequency88_2KHz (HDSPM_DoubleSpeed|HDSPM_Frequency1)</span>
<span class="cp">#define HDSPM_Frequency96KHz   (HDSPM_DoubleSpeed|HDSPM_Frequency1|\</span>
<span class="cp">				HDSPM_Frequency0)</span>
<span class="cp">#define HDSPM_Frequency128KHz   (HDSPM_QuadSpeed|HDSPM_Frequency0)</span>
<span class="cp">#define HDSPM_Frequency176_4KHz   (HDSPM_QuadSpeed|HDSPM_Frequency1)</span>
<span class="cp">#define HDSPM_Frequency192KHz   (HDSPM_QuadSpeed|HDSPM_Frequency1|\</span>
<span class="cp">				 HDSPM_Frequency0)</span>


<span class="cm">/* Synccheck Status */</span>
<span class="cp">#define HDSPM_SYNC_CHECK_NO_LOCK 0</span>
<span class="cp">#define HDSPM_SYNC_CHECK_LOCK    1</span>
<span class="cp">#define HDSPM_SYNC_CHECK_SYNC	 2</span>

<span class="cm">/* AutoSync References - used by &quot;autosync_ref&quot; control switch */</span>
<span class="cp">#define HDSPM_AUTOSYNC_FROM_WORD      0</span>
<span class="cp">#define HDSPM_AUTOSYNC_FROM_MADI      1</span>
<span class="cp">#define HDSPM_AUTOSYNC_FROM_TCO       2</span>
<span class="cp">#define HDSPM_AUTOSYNC_FROM_SYNC_IN   3</span>
<span class="cp">#define HDSPM_AUTOSYNC_FROM_NONE      4</span>

<span class="cm">/* Possible sources of MADI input */</span>
<span class="cp">#define HDSPM_OPTICAL 0		</span><span class="cm">/* optical   */</span><span class="cp"></span>
<span class="cp">#define HDSPM_COAXIAL 1		</span><span class="cm">/* BNC */</span><span class="cp"></span>

<span class="cp">#define hdspm_encode_latency(x)       (((x)&lt;&lt;1) &amp; HDSPM_LatencyMask)</span>
<span class="cp">#define hdspm_decode_latency(x)       ((((x) &amp; HDSPM_LatencyMask)&gt;&gt;1))</span>

<span class="cp">#define hdspm_encode_in(x) (((x)&amp;0x3)&lt;&lt;14)</span>
<span class="cp">#define hdspm_decode_in(x) (((x)&gt;&gt;14)&amp;0x3)</span>

<span class="cm">/* --- control2 register bits --- */</span>
<span class="cp">#define HDSPM_TMS             (1&lt;&lt;0)</span>
<span class="cp">#define HDSPM_TCK             (1&lt;&lt;1)</span>
<span class="cp">#define HDSPM_TDI             (1&lt;&lt;2)</span>
<span class="cp">#define HDSPM_JTAG            (1&lt;&lt;3)</span>
<span class="cp">#define HDSPM_PWDN            (1&lt;&lt;4)</span>
<span class="cp">#define HDSPM_PROGRAM	      (1&lt;&lt;5)</span>
<span class="cp">#define HDSPM_CONFIG_MODE_0   (1&lt;&lt;6)</span>
<span class="cp">#define HDSPM_CONFIG_MODE_1   (1&lt;&lt;7)</span>
<span class="cm">/*#define HDSPM_VERSION_BIT     (1&lt;&lt;8) not defined any more*/</span>
<span class="cp">#define HDSPM_BIGENDIAN_MODE  (1&lt;&lt;9)</span>
<span class="cp">#define HDSPM_RD_MULTIPLE     (1&lt;&lt;10)</span>

<span class="cm">/* --- Status Register bits --- */</span> <span class="cm">/* MADI ONLY */</span> <span class="cm">/* Bits defined here and</span>
<span class="cm">     that do not conflict with specific bits for AES32 seem to be valid also</span>
<span class="cm">     for the AES32</span>
<span class="cm"> */</span>
<span class="cp">#define HDSPM_audioIRQPending    (1&lt;&lt;0)	</span><span class="cm">/* IRQ is high and pending */</span><span class="cp"></span>
<span class="cp">#define HDSPM_RX_64ch            (1&lt;&lt;1)	</span><span class="cm">/* Input 64chan. MODE=1, 56chn MODE=0 */</span><span class="cp"></span>
<span class="cp">#define HDSPM_AB_int             (1&lt;&lt;2)	</span><span class="cm">/* InputChannel Opt=0, Coax=1</span>
<span class="cm">					 * (like inp0)</span>
<span class="cm">					 */</span><span class="cp"></span>

<span class="cp">#define HDSPM_madiLock           (1&lt;&lt;3)	</span><span class="cm">/* MADI Locked =1, no=0 */</span><span class="cp"></span>
<span class="cp">#define HDSPM_madiSync          (1&lt;&lt;18) </span><span class="cm">/* MADI is in sync */</span><span class="cp"></span>

<span class="cp">#define HDSPM_tcoLock    0x00000020 </span><span class="cm">/* Optional TCO locked status FOR HDSPe MADI! */</span><span class="cp"></span>
<span class="cp">#define HDSPM_tcoSync    0x10000000 </span><span class="cm">/* Optional TCO sync status */</span><span class="cp"></span>

<span class="cp">#define HDSPM_syncInLock 0x00010000 </span><span class="cm">/* Sync In lock status FOR HDSPe MADI! */</span><span class="cp"></span>
<span class="cp">#define HDSPM_syncInSync 0x00020000 </span><span class="cm">/* Sync In sync status FOR HDSPe MADI! */</span><span class="cp"></span>

<span class="cp">#define HDSPM_BufferPositionMask 0x000FFC0 </span><span class="cm">/* Bit 6..15 : h/w buffer pointer */</span><span class="cp"></span>
			<span class="cm">/* since 64byte accurate, last 6 bits are not used */</span>



<span class="cp">#define HDSPM_DoubleSpeedStatus (1&lt;&lt;19) </span><span class="cm">/* (input) card in double speed */</span><span class="cp"></span>

<span class="cp">#define HDSPM_madiFreq0         (1&lt;&lt;22)	</span><span class="cm">/* system freq 0=error */</span><span class="cp"></span>
<span class="cp">#define HDSPM_madiFreq1         (1&lt;&lt;23)	</span><span class="cm">/* 1=32, 2=44.1 3=48 */</span><span class="cp"></span>
<span class="cp">#define HDSPM_madiFreq2         (1&lt;&lt;24)	</span><span class="cm">/* 4=64, 5=88.2 6=96 */</span><span class="cp"></span>
<span class="cp">#define HDSPM_madiFreq3         (1&lt;&lt;25)	</span><span class="cm">/* 7=128, 8=176.4 9=192 */</span><span class="cp"></span>

<span class="cp">#define HDSPM_BufferID          (1&lt;&lt;26)	</span><span class="cm">/* (Double)Buffer ID toggles with</span>
<span class="cm">					 * Interrupt</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define HDSPM_tco_detect         0x08000000</span>
<span class="cp">#define HDSPM_tco_lock	         0x20000000</span>

<span class="cp">#define HDSPM_s2_tco_detect      0x00000040</span>
<span class="cp">#define HDSPM_s2_AEBO_D          0x00000080</span>
<span class="cp">#define HDSPM_s2_AEBI_D          0x00000100</span>


<span class="cp">#define HDSPM_midi0IRQPending    0x40000000</span>
<span class="cp">#define HDSPM_midi1IRQPending    0x80000000</span>
<span class="cp">#define HDSPM_midi2IRQPending    0x20000000</span>
<span class="cp">#define HDSPM_midi2IRQPendingAES 0x00000020</span>
<span class="cp">#define HDSPM_midi3IRQPending    0x00200000</span>

<span class="cm">/* --- status bit helpers */</span>
<span class="cp">#define HDSPM_madiFreqMask  (HDSPM_madiFreq0|HDSPM_madiFreq1|\</span>
<span class="cp">			     HDSPM_madiFreq2|HDSPM_madiFreq3)</span>
<span class="cp">#define HDSPM_madiFreq32    (HDSPM_madiFreq0)</span>
<span class="cp">#define HDSPM_madiFreq44_1  (HDSPM_madiFreq1)</span>
<span class="cp">#define HDSPM_madiFreq48    (HDSPM_madiFreq0|HDSPM_madiFreq1)</span>
<span class="cp">#define HDSPM_madiFreq64    (HDSPM_madiFreq2)</span>
<span class="cp">#define HDSPM_madiFreq88_2  (HDSPM_madiFreq0|HDSPM_madiFreq2)</span>
<span class="cp">#define HDSPM_madiFreq96    (HDSPM_madiFreq1|HDSPM_madiFreq2)</span>
<span class="cp">#define HDSPM_madiFreq128   (HDSPM_madiFreq0|HDSPM_madiFreq1|HDSPM_madiFreq2)</span>
<span class="cp">#define HDSPM_madiFreq176_4 (HDSPM_madiFreq3)</span>
<span class="cp">#define HDSPM_madiFreq192   (HDSPM_madiFreq3|HDSPM_madiFreq0)</span>

<span class="cm">/* Status2 Register bits */</span> <span class="cm">/* MADI ONLY */</span>

<span class="cp">#define HDSPM_version0 (1&lt;&lt;0)	</span><span class="cm">/* not really defined but I guess */</span><span class="cp"></span>
<span class="cp">#define HDSPM_version1 (1&lt;&lt;1)	</span><span class="cm">/* in former cards it was ??? */</span><span class="cp"></span>
<span class="cp">#define HDSPM_version2 (1&lt;&lt;2)</span>

<span class="cp">#define HDSPM_wcLock (1&lt;&lt;3)	</span><span class="cm">/* Wordclock is detected and locked */</span><span class="cp"></span>
<span class="cp">#define HDSPM_wcSync (1&lt;&lt;4)	</span><span class="cm">/* Wordclock is in sync with systemclock */</span><span class="cp"></span>

<span class="cp">#define HDSPM_wc_freq0 (1&lt;&lt;5)	</span><span class="cm">/* input freq detected via autosync  */</span><span class="cp"></span>
<span class="cp">#define HDSPM_wc_freq1 (1&lt;&lt;6)	</span><span class="cm">/* 001=32, 010==44.1, 011=48, */</span><span class="cp"></span>
<span class="cp">#define HDSPM_wc_freq2 (1&lt;&lt;7)	</span><span class="cm">/* 100=64, 101=88.2, 110=96, */</span><span class="cp"></span>
<span class="cm">/* missing Bit   for               111=128, 1000=176.4, 1001=192 */</span>

<span class="cp">#define HDSPM_SyncRef0 0x10000  </span><span class="cm">/* Sync Reference */</span><span class="cp"></span>
<span class="cp">#define HDSPM_SyncRef1 0x20000</span>

<span class="cp">#define HDSPM_SelSyncRef0 (1&lt;&lt;8)	</span><span class="cm">/* AutoSync Source */</span><span class="cp"></span>
<span class="cp">#define HDSPM_SelSyncRef1 (1&lt;&lt;9)	</span><span class="cm">/* 000=word, 001=MADI, */</span><span class="cp"></span>
<span class="cp">#define HDSPM_SelSyncRef2 (1&lt;&lt;10)	</span><span class="cm">/* 111=no valid signal */</span><span class="cp"></span>

<span class="cp">#define HDSPM_wc_valid (HDSPM_wcLock|HDSPM_wcSync)</span>

<span class="cp">#define HDSPM_wcFreqMask  (HDSPM_wc_freq0|HDSPM_wc_freq1|HDSPM_wc_freq2)</span>
<span class="cp">#define HDSPM_wcFreq32    (HDSPM_wc_freq0)</span>
<span class="cp">#define HDSPM_wcFreq44_1  (HDSPM_wc_freq1)</span>
<span class="cp">#define HDSPM_wcFreq48    (HDSPM_wc_freq0|HDSPM_wc_freq1)</span>
<span class="cp">#define HDSPM_wcFreq64    (HDSPM_wc_freq2)</span>
<span class="cp">#define HDSPM_wcFreq88_2  (HDSPM_wc_freq0|HDSPM_wc_freq2)</span>
<span class="cp">#define HDSPM_wcFreq96    (HDSPM_wc_freq1|HDSPM_wc_freq2)</span>

<span class="cp">#define HDSPM_status1_F_0 0x0400000</span>
<span class="cp">#define HDSPM_status1_F_1 0x0800000</span>
<span class="cp">#define HDSPM_status1_F_2 0x1000000</span>
<span class="cp">#define HDSPM_status1_F_3 0x2000000</span>
<span class="cp">#define HDSPM_status1_freqMask (HDSPM_status1_F_0|HDSPM_status1_F_1|HDSPM_status1_F_2|HDSPM_status1_F_3)</span>


<span class="cp">#define HDSPM_SelSyncRefMask       (HDSPM_SelSyncRef0|HDSPM_SelSyncRef1|\</span>
<span class="cp">				    HDSPM_SelSyncRef2)</span>
<span class="cp">#define HDSPM_SelSyncRef_WORD      0</span>
<span class="cp">#define HDSPM_SelSyncRef_MADI      (HDSPM_SelSyncRef0)</span>
<span class="cp">#define HDSPM_SelSyncRef_TCO       (HDSPM_SelSyncRef1)</span>
<span class="cp">#define HDSPM_SelSyncRef_SyncIn    (HDSPM_SelSyncRef0|HDSPM_SelSyncRef1)</span>
<span class="cp">#define HDSPM_SelSyncRef_NVALID    (HDSPM_SelSyncRef0|HDSPM_SelSyncRef1|\</span>
<span class="cp">				    HDSPM_SelSyncRef2)</span>

<span class="cm">/*</span>
<span class="cm">   For AES32, bits for status, status2 and timecode are different</span>
<span class="cm">*/</span>
<span class="cm">/* status */</span>
<span class="cp">#define HDSPM_AES32_wcLock	0x0200000</span>
<span class="cp">#define HDSPM_AES32_wcFreq_bit  22</span>
<span class="cm">/* (status &gt;&gt; HDSPM_AES32_wcFreq_bit) &amp; 0xF gives WC frequency (cf function</span>
<span class="cm">  HDSPM_bit2freq */</span>
<span class="cp">#define HDSPM_AES32_syncref_bit  16</span>
<span class="cm">/* (status &gt;&gt; HDSPM_AES32_syncref_bit) &amp; 0xF gives sync source */</span>

<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_WORD 0</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES1 1</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES2 2</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES3 3</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES4 4</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES5 5</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES6 6</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES7 7</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_AES8 8</span>
<span class="cp">#define HDSPM_AES32_AUTOSYNC_FROM_NONE 9</span>

<span class="cm">/*  status2 */</span>
<span class="cm">/* HDSPM_LockAES_bit is given by HDSPM_LockAES &gt;&gt; (AES# - 1) */</span>
<span class="cp">#define HDSPM_LockAES   0x80</span>
<span class="cp">#define HDSPM_LockAES1  0x80</span>
<span class="cp">#define HDSPM_LockAES2  0x40</span>
<span class="cp">#define HDSPM_LockAES3  0x20</span>
<span class="cp">#define HDSPM_LockAES4  0x10</span>
<span class="cp">#define HDSPM_LockAES5  0x8</span>
<span class="cp">#define HDSPM_LockAES6  0x4</span>
<span class="cp">#define HDSPM_LockAES7  0x2</span>
<span class="cp">#define HDSPM_LockAES8  0x1</span>
<span class="cm">/*</span>
<span class="cm">   Timecode</span>
<span class="cm">   After windows driver sources, bits 4*i to 4*i+3 give the input frequency on</span>
<span class="cm">   AES i+1</span>
<span class="cm"> bits 3210</span>
<span class="cm">      0001  32kHz</span>
<span class="cm">      0010  44.1kHz</span>
<span class="cm">      0011  48kHz</span>
<span class="cm">      0100  64kHz</span>
<span class="cm">      0101  88.2kHz</span>
<span class="cm">      0110  96kHz</span>
<span class="cm">      0111  128kHz</span>
<span class="cm">      1000  176.4kHz</span>
<span class="cm">      1001  192kHz</span>
<span class="cm">  NB: Timecode register doesn&#39;t seem to work on AES32 card revision 230</span>
<span class="cm">*/</span>

<span class="cm">/* Mixer Values */</span>
<span class="cp">#define UNITY_GAIN          32768	</span><span class="cm">/* = 65536/2 */</span><span class="cp"></span>
<span class="cp">#define MINUS_INFINITY_GAIN 0</span>

<span class="cm">/* Number of channels for different Speed Modes */</span>
<span class="cp">#define MADI_SS_CHANNELS       64</span>
<span class="cp">#define MADI_DS_CHANNELS       32</span>
<span class="cp">#define MADI_QS_CHANNELS       16</span>

<span class="cp">#define RAYDAT_SS_CHANNELS     36</span>
<span class="cp">#define RAYDAT_DS_CHANNELS     20</span>
<span class="cp">#define RAYDAT_QS_CHANNELS     12</span>

<span class="cp">#define AIO_IN_SS_CHANNELS        14</span>
<span class="cp">#define AIO_IN_DS_CHANNELS        10</span>
<span class="cp">#define AIO_IN_QS_CHANNELS        8</span>
<span class="cp">#define AIO_OUT_SS_CHANNELS        16</span>
<span class="cp">#define AIO_OUT_DS_CHANNELS        12</span>
<span class="cp">#define AIO_OUT_QS_CHANNELS        10</span>

<span class="cp">#define AES32_CHANNELS		16</span>

<span class="cm">/* the size of a substream (1 mono data stream) */</span>
<span class="cp">#define HDSPM_CHANNEL_BUFFER_SAMPLES  (16*1024)</span>
<span class="cp">#define HDSPM_CHANNEL_BUFFER_BYTES    (4*HDSPM_CHANNEL_BUFFER_SAMPLES)</span>

<span class="cm">/* the size of the area we need to allocate for DMA transfers. the</span>
<span class="cm">   size is the same regardless of the number of channels, and</span>
<span class="cm">   also the latency to use.</span>
<span class="cm">   for one direction !!!</span>
<span class="cm">*/</span>
<span class="cp">#define HDSPM_DMA_AREA_BYTES (HDSPM_MAX_CHANNELS * HDSPM_CHANNEL_BUFFER_BYTES)</span>
<span class="cp">#define HDSPM_DMA_AREA_KILOBYTES (HDSPM_DMA_AREA_BYTES/1024)</span>

<span class="cp">#define HDSPM_RAYDAT_REV	211</span>
<span class="cp">#define HDSPM_AIO_REV		212</span>
<span class="cp">#define HDSPM_MADIFACE_REV	213</span>

<span class="cm">/* speed factor modes */</span>
<span class="cp">#define HDSPM_SPEED_SINGLE 0</span>
<span class="cp">#define HDSPM_SPEED_DOUBLE 1</span>
<span class="cp">#define HDSPM_SPEED_QUAD   2</span>

<span class="cm">/* names for speed modes */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hdspm_speed_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;single&quot;</span><span class="p">,</span> <span class="s">&quot;double&quot;</span><span class="p">,</span> <span class="s">&quot;quad&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_aes_tco</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
					  <span class="s">&quot;AES1&quot;</span><span class="p">,</span> <span class="s">&quot;AES2&quot;</span><span class="p">,</span> <span class="s">&quot;AES3&quot;</span><span class="p">,</span> <span class="s">&quot;AES4&quot;</span><span class="p">,</span>
					  <span class="s">&quot;AES5&quot;</span><span class="p">,</span> <span class="s">&quot;AES6&quot;</span><span class="p">,</span> <span class="s">&quot;AES7&quot;</span><span class="p">,</span> <span class="s">&quot;AES8&quot;</span><span class="p">,</span>
					  <span class="s">&quot;TCO&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_aes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
				      <span class="s">&quot;AES1&quot;</span><span class="p">,</span> <span class="s">&quot;AES2&quot;</span><span class="p">,</span> <span class="s">&quot;AES3&quot;</span><span class="p">,</span> <span class="s">&quot;AES4&quot;</span><span class="p">,</span>
				      <span class="s">&quot;AES5&quot;</span><span class="p">,</span> <span class="s">&quot;AES6&quot;</span><span class="p">,</span> <span class="s">&quot;AES7&quot;</span><span class="p">,</span> <span class="s">&quot;AES8&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_madi_tco</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
					   <span class="s">&quot;MADI&quot;</span><span class="p">,</span> <span class="s">&quot;TCO&quot;</span><span class="p">,</span> <span class="s">&quot;Sync In&quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_madi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
				       <span class="s">&quot;MADI&quot;</span><span class="p">,</span> <span class="s">&quot;Sync In&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_raydat_tco</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT 1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT 2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT 3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT 4&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">,</span> <span class="s">&quot;TCO&quot;</span><span class="p">,</span> <span class="s">&quot;Sync In&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_raydat</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT 1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT 2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT 3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT 4&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">,</span> <span class="s">&quot;Sync In&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_aio_tco</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT&quot;</span><span class="p">,</span> <span class="s">&quot;AES&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">,</span> <span class="s">&quot;TCO&quot;</span><span class="p">,</span> <span class="s">&quot;Sync In&quot;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_autosync_aio</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">,</span>
				      <span class="s">&quot;ADAT&quot;</span><span class="p">,</span> <span class="s">&quot;AES&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">,</span> <span class="s">&quot;Sync In&quot;</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_freq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;No Lock&quot;</span><span class="p">,</span>
	<span class="s">&quot;32 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;44.1 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;48 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;64 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;88.2 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;96 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;128 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;176.4 kHz&quot;</span><span class="p">,</span>
	<span class="s">&quot;192 kHz&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_madi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;MADI.1&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.2&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.3&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.4&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.5&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.6&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.7&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.8&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.9&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.10&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.11&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.12&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.13&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.14&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.15&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.16&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.17&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.18&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.19&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.20&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.21&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.22&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.23&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.24&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.25&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.26&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.27&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.28&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.29&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.30&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.31&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.32&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.33&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.34&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.35&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.36&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.37&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.38&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.39&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.40&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.41&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.42&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.43&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.44&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.45&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.46&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.47&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.48&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.49&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.50&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.51&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.52&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.53&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.54&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.55&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.56&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.57&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.58&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.59&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.60&quot;</span><span class="p">,</span>
	<span class="s">&quot;MADI.61&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.62&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.63&quot;</span><span class="p">,</span> <span class="s">&quot;MADI.64&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_raydat_ss</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADAT1.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.4&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.5&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.6&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT1.7&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.8&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT2.5&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.6&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.7&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.8&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.2&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT3.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.4&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.5&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.6&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.7&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.8&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT4.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.4&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.5&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.6&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT4.7&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.8&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_raydat_ds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADAT1.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT2.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT3.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT4.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_raydat_qs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;ADAT1.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1.2&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT2.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2.2&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT3.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3.2&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT4.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT4.2&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aio_in_ss</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Analogue.L&quot;</span><span class="p">,</span> <span class="s">&quot;Analogue.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.4&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.5&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.6&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.7&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.8&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aio_out_ss</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Analogue.L&quot;</span><span class="p">,</span> <span class="s">&quot;Analogue.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.4&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.5&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.6&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.7&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.8&quot;</span><span class="p">,</span>
	<span class="s">&quot;Phone.L&quot;</span><span class="p">,</span> <span class="s">&quot;Phone.R&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aio_in_ds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Analogue.L&quot;</span><span class="p">,</span> <span class="s">&quot;Analogue.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.4&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aio_out_ds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Analogue.L&quot;</span><span class="p">,</span> <span class="s">&quot;Analogue.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;Phone.L&quot;</span><span class="p">,</span> <span class="s">&quot;Phone.R&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aio_in_qs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Analogue.L&quot;</span><span class="p">,</span> <span class="s">&quot;Analogue.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.4&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aio_out_qs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Analogue.L&quot;</span><span class="p">,</span> <span class="s">&quot;Analogue.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.L&quot;</span><span class="p">,</span> <span class="s">&quot;AES.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;SPDIF.L&quot;</span><span class="p">,</span> <span class="s">&quot;SPDIF.R&quot;</span><span class="p">,</span>
	<span class="s">&quot;ADAT.1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.3&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT.4&quot;</span><span class="p">,</span>
	<span class="s">&quot;Phone.L&quot;</span><span class="p">,</span> <span class="s">&quot;Phone.R&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts_ports_aes32</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;AES.1&quot;</span><span class="p">,</span> <span class="s">&quot;AES.2&quot;</span><span class="p">,</span> <span class="s">&quot;AES.3&quot;</span><span class="p">,</span> <span class="s">&quot;AES.4&quot;</span><span class="p">,</span> <span class="s">&quot;AES.5&quot;</span><span class="p">,</span> <span class="s">&quot;AES.6&quot;</span><span class="p">,</span> <span class="s">&quot;AES.7&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.8&quot;</span><span class="p">,</span> <span class="s">&quot;AES.9.&quot;</span><span class="p">,</span> <span class="s">&quot;AES.10&quot;</span><span class="p">,</span> <span class="s">&quot;AES.11&quot;</span><span class="p">,</span> <span class="s">&quot;AES.12&quot;</span><span class="p">,</span> <span class="s">&quot;AES.13&quot;</span><span class="p">,</span> <span class="s">&quot;AES.14&quot;</span><span class="p">,</span>
	<span class="s">&quot;AES.15&quot;</span><span class="p">,</span> <span class="s">&quot;AES.16&quot;</span>
<span class="p">};</span>

<span class="cm">/* These tables map the ALSA channels 1..N to the channels that we</span>
<span class="cm">   need to use in order to find the relevant channel buffer. RME</span>
<span class="cm">   refers to this kind of mapping as between &quot;the ADAT channel and</span>
<span class="cm">   the DMA channel.&quot; We index it using the logical audio channel,</span>
<span class="cm">   and the value is the DMA channel (i.e. channel buffer number)</span>
<span class="cm">   where the data for that channel can be read/written from/to.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_unity_ss</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	<span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span>
	<span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>
	<span class="mi">40</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
	<span class="mi">48</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
	<span class="mi">56</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_raydat_ss</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>	<span class="cm">/* ADAT 1 */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>	<span class="cm">/* ADAT 2 */</span>
	<span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>	<span class="cm">/* ADAT 3 */</span>
	<span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span>	<span class="cm">/* ADAT 4 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* AES */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>			<span class="cm">/* SPDIF */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_raydat_ds</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>		<span class="cm">/* ADAT 1 */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>		<span class="cm">/* ADAT 2 */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>		<span class="cm">/* ADAT 3 */</span>
	<span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>		<span class="cm">/* ADAT 4 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* AES */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>			<span class="cm">/* SPDIF */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_raydat_qs</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>			<span class="cm">/* ADAT 1 */</span>
	<span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>			<span class="cm">/* ADAT 2 */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* ADAT 3 */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* ADAT 4 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* AES */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>			<span class="cm">/* SPDIF */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aio_in_ss</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* line in */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* aes in, */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* spdif in */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>	<span class="cm">/* ADAT in */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aio_out_ss</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* line out */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* aes out */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* spdif out */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>	<span class="cm">/* ADAT out */</span>
	<span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>			<span class="cm">/* phone out */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aio_in_ds</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* line in */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* aes in */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* spdif in */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>		<span class="cm">/* adat in */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aio_out_ds</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* line out */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* aes out */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* spdif out */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span>		<span class="cm">/* adat out */</span>
	<span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>			<span class="cm">/* phone out */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aio_in_qs</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* line in */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* aes in */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* spdif in */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>			<span class="cm">/* adat in */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aio_out_qs</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>			<span class="cm">/* line out */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>			<span class="cm">/* aes out */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>			<span class="cm">/* spdif out */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span>			<span class="cm">/* adat out */</span>
	<span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>			<span class="cm">/* phone out */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_aes32</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi</span> <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">output</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">istimer</span><span class="p">;</span>		<span class="cm">/* timer in use */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dataIn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">statusIn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dataOut</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">statusOut</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdspm_tco</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">framerate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wordclock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">samplerate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pull</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">term</span><span class="p">;</span> <span class="cm">/* 0 = off, 1 = on */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdspm</span> <span class="p">{</span>
        <span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="cm">/* only one playback and/or capture stream */</span>
        <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">card_name</span><span class="p">;</span>	     <span class="cm">/* for procinfo */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">firmware_rev</span><span class="p">;</span> <span class="cm">/* dont know if relevant (yes if AES32)*/</span>

	<span class="kt">uint8_t</span> <span class="n">io_type</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">monitor_outs</span><span class="p">;</span>	<span class="cm">/* set up monitoring outs init flag */</span>

	<span class="n">u32</span> <span class="n">control_register</span><span class="p">;</span>	<span class="cm">/* cached value */</span>
	<span class="n">u32</span> <span class="n">control2_register</span><span class="p">;</span>	<span class="cm">/* cached value */</span>
	<span class="n">u32</span> <span class="n">settings_register</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="n">midi</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">midi_tasklet</span><span class="p">;</span>

	<span class="kt">size_t</span> <span class="n">period_bytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ss_in_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ds_in_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qs_in_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ss_out_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ds_out_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">qs_out_channels</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max_channels_in</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">max_channels_out</span><span class="p">;</span>

	<span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="n">channel_map_in</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="n">channel_map_out</span><span class="p">;</span>

	<span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="n">channel_map_in_ss</span><span class="p">,</span> <span class="o">*</span><span class="n">channel_map_in_ds</span><span class="p">,</span> <span class="o">*</span><span class="n">channel_map_in_qs</span><span class="p">;</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="o">*</span><span class="n">channel_map_out_ss</span><span class="p">,</span> <span class="o">*</span><span class="n">channel_map_out_ds</span><span class="p">,</span> <span class="o">*</span><span class="n">channel_map_out_qs</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">**</span><span class="n">port_names_in</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">port_names_out</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">**</span><span class="n">port_names_in_ss</span><span class="p">,</span> <span class="o">**</span><span class="n">port_names_in_ds</span><span class="p">,</span> <span class="o">**</span><span class="n">port_names_in_qs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">**</span><span class="n">port_names_out_ss</span><span class="p">,</span> <span class="o">**</span><span class="n">port_names_out_ds</span><span class="p">,</span> <span class="o">**</span><span class="n">port_names_out_qs</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">playback_buffer</span><span class="p">;</span>	<span class="cm">/* suitably aligned address */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">capture_buffer</span><span class="p">;</span>	<span class="cm">/* suitably aligned address */</span>

	<span class="n">pid_t</span> <span class="n">capture_pid</span><span class="p">;</span>	<span class="cm">/* process id which uses capture */</span>
	<span class="n">pid_t</span> <span class="n">playback_pid</span><span class="p">;</span>	<span class="cm">/* process id which uses capture */</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>		<span class="cm">/* running status */</span>

	<span class="kt">int</span> <span class="n">last_external_sample_rate</span><span class="p">;</span>	<span class="cm">/* samplerate mystic ... */</span>
	<span class="kt">int</span> <span class="n">last_internal_sample_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">system_sample_rate</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>		<span class="cm">/* Hardware vars... */</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">iobase</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">irq_count</span><span class="p">;</span>		<span class="cm">/* for debug */</span>
	<span class="kt">int</span> <span class="n">midiPorts</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>	<span class="cm">/* one card */</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>		<span class="cm">/* has one pcm */</span>
	<span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hwdep</span><span class="p">;</span>	<span class="cm">/* and a hwdep for additional ioctl */</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>	<span class="cm">/* and an pci info */</span>

	<span class="cm">/* Mixer vars */</span>
	<span class="cm">/* fast alsa mixer */</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">playback_mixer_ctls</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">];</span>
	<span class="cm">/* but input to much, so not used */</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">input_mixer_ctls</span><span class="p">[</span><span class="n">HDSPM_MAX_CHANNELS</span><span class="p">];</span>
	<span class="cm">/* full mixer accessible over mixer ioctl or hwdep-device */</span>
	<span class="k">struct</span> <span class="n">hdspm_mixer</span> <span class="o">*</span><span class="n">mixer</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdspm_tco</span> <span class="o">*</span><span class="n">tco</span><span class="p">;</span>  <span class="cm">/* NULL if no TCO detected */</span>

	<span class="kt">char</span> <span class="o">**</span><span class="n">texts_autosync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">texts_autosync_items</span><span class="p">;</span>

	<span class="n">cycles_t</span> <span class="n">last_interrupt</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">hdspm_peak_rms</span> <span class="n">peak_rms</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_hdspm_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_XILINX</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_XILINX_HAMMERFALL_DSP_MADI</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">class_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_hdspm_ids</span><span class="p">);</span>

<span class="cm">/* prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">snd_hdspm_create_alsa_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">snd_hdspm_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">snd_hdspm_initialize_midi_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdspm_update_simple_mixer_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_hdspm_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hdspm_set_sgbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">HDSPM_bit2freq</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bit2freq_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span>
		<span class="mi">96000</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">192000</span> <span class="p">};</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">bit2freq_tab</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* Write/read to/from HDSPM with Adresses in Bytes</span>
<span class="cm">   not words but only 32Bit writes are allowed */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdspm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hdspm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* for each output channel (chan) I have an Input (in) and Playback (pb) Fader</span>
<span class="cm">   mixer is write only on hardware so we have to cache him for read</span>
<span class="cm">   each fader is a u32, but uses only the first 16 bit */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdspm_read_in_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span> <span class="o">||</span> <span class="n">in</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">in</span><span class="p">[</span><span class="n">in</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hdspm_read_pb_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span> <span class="o">||</span> <span class="n">pb</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">pb</span><span class="p">[</span><span class="n">pb</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_write_in_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span> <span class="o">||</span> <span class="n">in</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
		    <span class="n">HDSPM_MADI_mixerBase</span> <span class="o">+</span>
		    <span class="p">((</span><span class="n">in</span> <span class="o">+</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">chan</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)),</span>
		    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">in</span><span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_write_pb_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span> <span class="o">||</span> <span class="n">pb</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MIXER_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
		    <span class="n">HDSPM_MADI_mixerBase</span> <span class="o">+</span>
		    <span class="p">((</span><span class="mi">64</span> <span class="o">+</span> <span class="n">pb</span> <span class="o">+</span> <span class="mi">128</span> <span class="o">*</span> <span class="n">chan</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)),</span>
		    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">[</span><span class="n">chan</span><span class="p">].</span><span class="n">pb</span><span class="p">[</span><span class="n">pb</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* enable DMA for specific channels, now available for DSP-MADI */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_hdspm_enable_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_inputEnableBase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_hdspm_enable_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_outputEnableBase</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* check if same process is writing and reading */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">!=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check for external sample rate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_external_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">status2</span><span class="p">,</span> <span class="n">timecode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">syncref</span><span class="p">,</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate_bits</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
		<span class="n">timecode</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_timecodeRegister</span><span class="p">);</span>

		<span class="n">syncref</span> <span class="o">=</span> <span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">syncref</span> <span class="o">==</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_WORD</span> <span class="o">&amp;&amp;</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_AES32_wcLock</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HDSPM_bit2freq</span><span class="p">((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">HDSPM_AES32_wcFreq_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">syncref</span> <span class="o">&gt;=</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES1</span> <span class="o">&amp;&amp;</span>
				<span class="n">syncref</span> <span class="o">&lt;=</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES8</span> <span class="o">&amp;&amp;</span>
				<span class="n">status2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSPM_LockAES</span> <span class="o">&gt;&gt;</span>
				<span class="p">(</span><span class="n">syncref</span> <span class="o">-</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES1</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">HDSPM_bit2freq</span><span class="p">((</span><span class="n">timecode</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">syncref</span><span class="o">-</span><span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES1</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiLock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* no lock */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSPM_status1_freqMask</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">1</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">2</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">3</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">4</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">5</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">6</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">7</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">8</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_status1_F_0</span><span class="o">*</span><span class="mi">9</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if wordclock has synced freq and wordclock is valid */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcLock</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_SelSyncRef0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcFreqMask</span><span class="p">;</span>


			<span class="k">switch</span> <span class="p">(</span><span class="n">rate_bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HDSPM_wcFreq32</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_wcFreq44_1</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_wcFreq48</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_wcFreq64</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_wcFreq88_2</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_wcFreq96</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* if rate detected and Syncref is Word than have it,</span>
<span class="cm">		 * word has priority to MADI</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_SelSyncRefMask</span><span class="p">)</span> <span class="o">==</span> <span class="n">HDSPM_SelSyncRef_WORD</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>

		<span class="cm">/* maybe a madi input (which is taken if sel sync is madi) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiLock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiFreqMask</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">rate_bits</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq32</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq44_1</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq48</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq64</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq88_2</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq96</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq128</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq176_4</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_madiFreq192</span>:
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* QS and DS rates normally can not be detected</span>
<span class="cm">			 * automatically by the card. Only exception is MADI</span>
<span class="cm">			 * in 96k frame mode.</span>
<span class="cm">			 *</span>
<span class="cm">			 * So if we read SS values (32 .. 48k), check for</span>
<span class="cm">			 * user-provided DS/QS bits in the control register</span>
<span class="cm">			 * and multiply the base frequency accordingly.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_QuadSpeed</span><span class="p">)</span>
					<span class="n">rate</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span>
						<span class="n">HDSPM_DoubleSpeed</span><span class="p">)</span>
					<span class="n">rate</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return latency in samples per period */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_get_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">hdspm_decode_latency</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="cm">/* Special case for new RME cards with 32 samples period size.</span>
<span class="cm">	 * The three latency bits in the control register</span>
<span class="cm">	 * (HDSP_LatencyMask) encode latency values of 64 samples as</span>
<span class="cm">	 * 0, 128 samples as 1 ... 4096 samples as 6. For old cards, 7</span>
<span class="cm">	 * denotes 8192 samples, but on new cards like RayDAT or AIO,</span>
<span class="cm">	 * it corresponds to 32 samples.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">7</span> <span class="o">==</span> <span class="n">n</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RayDAT</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">||</span> <span class="n">AIO</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">))</span>
		<span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Latency function */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdspm_compute_period_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">hdspm_get_latency</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">hdspm_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">position</span><span class="p">;</span>

	<span class="n">position</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">position</span> <span class="o">&amp;=</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">;</span>
		<span class="n">position</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* Bytes per sample */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferID</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">position</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdspm_start_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HDSPM_AudioInterruptEnable</span> <span class="o">|</span> <span class="n">HDSPM_Start</span><span class="p">);</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hdspm_stop_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSPM_Start</span> <span class="o">|</span> <span class="n">HDSPM_AudioInterruptEnable</span><span class="p">);</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* should I silence all or only opened ones ? doit all for first even is 4MB*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdspm_silence_playback</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">HDSPM_CHANNEL_BUFFER_BYTES</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_interrupt_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">32</span> <span class="o">==</span> <span class="n">frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Special case for new RME cards like RayDAT/AIO which</span>
<span class="cm">		 * support period sizes of 32 samples. Since latency is</span>
<span class="cm">		 * encoded in the three bits of HDSP_LatencyMask, we can only</span>
<span class="cm">		 * have values from 0 .. 7. While 0 still means 64 samples and</span>
<span class="cm">		 * 6 represents 4096 samples on all cards, 7 represents 8192</span>
<span class="cm">		 * on older cards and 32 samples on new cards.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In other words, period size in samples is calculated by</span>
<span class="cm">		 * 2^(n+6) with n ranging from 0 .. 7.</span>
<span class="cm">		 */</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">frames</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
			<span class="n">frames</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_LatencyMask</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">hdspm_encode_latency</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="n">hdspm_compute_period_size</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">hdspm_calc_dds_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">u64</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">freq_const</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">freq_const</span> <span class="o">=</span> <span class="mi">110069313433624ULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">freq_const</span> <span class="o">=</span> <span class="mi">104857600000000ULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">freq_const</span> <span class="o">=</span> <span class="mi">131072000000000ULL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">freq_const</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdspm_set_dds_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">112000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">56000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="mi">131072000000000ULL</span><span class="p">;</span>  <span class="cm">/* 125 MHz */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="mi">110069313433624ULL</span><span class="p">;</span>  <span class="cm">/* 105 MHz */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="mi">104857600000000ULL</span><span class="p">;</span>  <span class="cm">/* 100 MHz */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="cm">/* n should be less than 2^32 for being written to FREQ register */</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_freqReg</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dummy set rate lets see what happens */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">called_internally</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">current_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_bits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">not_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_speed</span><span class="p">,</span> <span class="n">target_speed</span><span class="p">;</span>

	<span class="cm">/* ASSUMPTION: hdspm-&gt;lock is either set, or there is no need for</span>
<span class="cm">	   it (e.g. during module initialization).</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_ClockModeMaster</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* SLAVE --- */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">called_internally</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* request from ctl or card initialization</span>
<span class="cm">			   just make a warning an remember setting</span>
<span class="cm">			   for future master mode switching */</span>

			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDSPM: &quot;</span>
				   <span class="s">&quot;Warning: device is not running &quot;</span>
				   <span class="s">&quot;as a clock master.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">not_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* hw_param request while in AutoSync mode */</span>
			<span class="kt">int</span> <span class="n">external_freq</span> <span class="o">=</span>
			    <span class="n">hdspm_external_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">HDSPM_AUTOSYNC_FROM_NONE</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDSPM: &quot;</span>
					   <span class="s">&quot;Detected no Externel Sync </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">not_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">external_freq</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;HDSPM: &quot;</span>
					   <span class="s">&quot;Warning: No AutoSync source for &quot;</span>
					   <span class="s">&quot;requested rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">not_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">current_rate</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>

	<span class="cm">/* Changing between Singe, Double and Quad speed is not</span>
<span class="cm">	   allowed if any substreams are open. This is because such a change</span>
<span class="cm">	   causes a shift in the location of the DMA buffers and a reduction</span>
<span class="cm">	   in the number of available buffers.</span>

<span class="cm">	   Note that a similar but essentially insoluble problem exists for</span>
<span class="cm">	   externally-driven rate changes. All we can do is to flag rate</span>
<span class="cm">	   changes in the read/write routines.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">HDSPM_SPEED_SINGLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">HDSPM_SPEED_DOUBLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="n">HDSPM_SPEED_QUAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="n">target_speed</span> <span class="o">=</span> <span class="n">HDSPM_SPEED_SINGLE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span>
		<span class="n">target_speed</span> <span class="o">=</span> <span class="n">HDSPM_SPEED_DOUBLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">target_speed</span> <span class="o">=</span> <span class="n">HDSPM_SPEED_QUAD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency32KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency44_1KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency48KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64000</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency64KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency88_2KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency96KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128000</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency128KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">176400</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency176_4KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192000</span>:
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSPM_Frequency192KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_speed</span> <span class="o">!=</span> <span class="n">target_speed</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span>
		    <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HDSPM: &quot;</span>
		     <span class="s">&quot;cannot change from %s speed to %s speed mode &quot;</span>
		     <span class="s">&quot;(capture PID = %d, playback PID = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">hdspm_speed_names</span><span class="p">[</span><span class="n">current_speed</span><span class="p">],</span>
		     <span class="n">hdspm_speed_names</span><span class="p">[</span><span class="n">target_speed</span><span class="p">],</span>
		     <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_FrequencyMask</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">rate_bits</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="cm">/* For AES32, need to set DDS value in FREQ register</span>
<span class="cm">	   For MADI, also apparently */</span>
	<span class="n">hdspm_set_dds_value</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AES32</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">!=</span> <span class="n">current_rate</span><span class="p">)</span>
		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_eeprom_wr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ss</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ds</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_qs</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_qs</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_qs</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_qs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">not_set</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* mainly for init to 0 on load */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">all_in_all_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sgain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sgain</span> <span class="o">&gt;</span> <span class="n">UNITY_GAIN</span><span class="p">)</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="n">UNITY_GAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sgain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="n">sgain</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDSPM_MIXER_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">HDSPM_MIXER_CHANNELS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm_write_in_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
			<span class="n">hdspm_write_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm">   MIDI</span>
<span class="cm">  ----------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_hdspm_midi_read_byte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span>
						      <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the hardware already does the relevant bit-mask with 0xff */</span>
	<span class="k">return</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dataIn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_hdspm_midi_write_byte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the hardware already does the relevant bit-mask with 0xff */</span>
	<span class="k">return</span> <span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">dataOut</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_input_available</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">statusIn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_output_possible</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fifo_bytes_used</span><span class="p">;</span>

	<span class="n">fifo_bytes_used</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">statusOut</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_bytes_used</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span>  <span class="mi">128</span> <span class="o">-</span> <span class="n">fifo_bytes_used</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdspm_flush_midi_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">snd_hdspm_midi_input_available</span> <span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
		<span class="n">snd_hdspm_midi_read_byte</span> <span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_output_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_write</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="cm">/* Output is not interrupt driven */</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">snd_rawmidi_transmit_empty</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">n_pending</span> <span class="o">=</span> <span class="n">snd_hdspm_midi_output_possible</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span>
							    <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">))</span>
				<span class="n">n_pending</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>

			<span class="n">to_write</span> <span class="o">=</span> <span class="n">snd_rawmidi_transmit</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
							 <span class="n">n_pending</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">to_write</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_write</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
					<span class="n">snd_hdspm_midi_write_byte</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span>
								   <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
								   <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_input_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span> <span class="cm">/* this buffer is designed to match the MIDI</span>
<span class="cm">				 * input FIFO size</span>
<span class="cm">				 */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">n_pending</span> <span class="o">=</span> <span class="n">snd_hdspm_midi_input_available</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">))</span>
				<span class="n">n_pending</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_pending</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_hdspm_midi_read_byte</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span>
								   <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span><span class="p">)</span>
				<span class="n">snd_rawmidi_receive</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
						     <span class="n">n_pending</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* flush the MIDI input FIFO */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">n_pending</span><span class="o">--</span><span class="p">)</span>
				<span class="n">snd_hdspm_midi_read_byte</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span>
							  <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span>
		    <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">snd_hdspm_midi_output_write</span> <span class="p">(</span><span class="n">hmidi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdspm_midi_input_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">hdspm</span> <span class="o">=</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_hdspm_flush_midi_input</span> <span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdspm_midi_output_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">snd_hdspm_midi_output_write</span><span class="p">(</span><span class="n">hmidi</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* this does not bump hmidi-&gt;istimer, because the</span>
<span class="cm">	   kernel automatically removed the timer when it</span>
<span class="cm">	   expired, and we are now adding it back, thus</span>
<span class="cm">	   leaving istimer wherever it was set before.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdspm_midi_output_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">snd_hdspm_midi_output_timer</span><span class="p">;</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hmidi</span><span class="p">;</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">del_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span>
		<span class="n">snd_hdspm_midi_output_write</span><span class="p">(</span><span class="n">hmidi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">snd_hdspm_flush_midi_input</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_output_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">snd_hdspm_midi_input_trigger</span> <span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_midi_output_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">snd_hdspm_midi_output_trigger</span> <span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_hdspm_midi_output</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_hdspm_midi_output_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_hdspm_midi_output_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_hdspm_midi_output_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_hdspm_midi_input</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_hdspm_midi_input_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_hdspm_midi_input_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_hdspm_midi_input_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_create_midi</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">hdspm</span><span class="p">;</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MADIface</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* MIDI-over-MADI on HDSPe MADIface */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dataIn</span> <span class="o">=</span> <span class="n">HDSPM_midiDataIn2</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">statusIn</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusIn2</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dataOut</span> <span class="o">=</span> <span class="n">HDSPM_midiDataOut2</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">statusOut</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusOut2</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ie</span> <span class="o">=</span> <span class="n">HDSPM_Midi2InterruptEnable</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">HDSPM_midi2IRQPending</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dataIn</span> <span class="o">=</span> <span class="n">HDSPM_midiDataIn0</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">statusIn</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusIn0</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dataOut</span> <span class="o">=</span> <span class="n">HDSPM_midiDataOut0</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">statusOut</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusOut0</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ie</span> <span class="o">=</span> <span class="n">HDSPM_Midi0InterruptEnable</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">HDSPM_midi0IRQPending</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dataIn</span> <span class="o">=</span> <span class="n">HDSPM_midiDataIn1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">statusIn</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusIn1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dataOut</span> <span class="o">=</span> <span class="n">HDSPM_midiDataOut1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">statusOut</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusOut1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ie</span> <span class="o">=</span> <span class="n">HDSPM_Midi1InterruptEnable</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">HDSPM_midi1IRQPending</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="mi">2</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MADI</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* MIDI-over-MADI on HDSPe MADI */</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dataIn</span> <span class="o">=</span> <span class="n">HDSPM_midiDataIn2</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">statusIn</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusIn2</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dataOut</span> <span class="o">=</span> <span class="n">HDSPM_midiDataOut2</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">statusOut</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusOut2</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ie</span> <span class="o">=</span> <span class="n">HDSPM_Midi2InterruptEnable</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">HDSPM_midi2IRQPending</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TCO MTC, read only */</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dataIn</span> <span class="o">=</span> <span class="n">HDSPM_midiDataIn2</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">statusIn</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusIn2</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dataOut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">statusOut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">ie</span> <span class="o">=</span> <span class="n">HDSPM_Midi2InterruptEnable</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">HDSPM_midi2IRQPendingAES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">3</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TCO MTC on HDSPe MADI */</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">dataIn</span> <span class="o">=</span> <span class="n">HDSPM_midiDataIn3</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">statusIn</span> <span class="o">=</span> <span class="n">HDSPM_midiStatusIn3</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">dataOut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">statusOut</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">ie</span> <span class="o">=</span> <span class="n">HDSPM_Midi3InterruptEnable</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">HDSPM_midi3IRQPending</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="mi">2</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">MADI</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">MADIface</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MADIface</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s MIDIoverMADI&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">MADI</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s MIDIoverMADI&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s MIDI %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_rawmidi_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s MIDI %d&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

		<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">,</span>
				<span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">snd_hdspm_midi_output</span><span class="p">);</span>
		<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">,</span>
				<span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">snd_hdspm_midi_input</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">|=</span>
			<span class="n">SNDRV_RAWMIDI_INFO_OUTPUT</span> <span class="o">|</span>
			<span class="n">SNDRV_RAWMIDI_INFO_INPUT</span> <span class="o">|</span>
			<span class="n">SNDRV_RAWMIDI_INFO_DUPLEX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* TCO MTC, read only */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s MTC %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_rawmidi_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="s">&quot;%s MTC %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

		<span class="n">snd_rawmidi_set_ops</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">,</span>
				<span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">snd_hdspm_midi_input</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">|=</span> <span class="n">SNDRV_RAWMIDI_INFO_INPUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdspm_midi_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pending</span><span class="p">)</span>
			<span class="n">snd_hdspm_midi_input_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm">  Status Interface</span>
<span class="cm">  ----------------------------------------------------------------------------*/</span>

<span class="cm">/* get the system sample rate which is set */</span>


<span class="cm">/**</span>
<span class="cm"> * Calculate the real sample rate from the</span>
<span class="cm"> * current DDS value.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_get_system_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">period</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_PLL_FREQ</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">hdspm_calc_dds_value</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">207000</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Unreasonable high sample rate as seen on PCI MADI cards.</span>
<span class="cm">		 * Use the cached value instead.</span>
<span class="cm">		 */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_SYSTEM_SAMPLE_RATE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdspm_info_system_sample_rate, \</span>
<span class="cp">  .get = snd_hdspm_get_system_sample_rate \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_system_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">27000</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">207000</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_system_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span>
					    <span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_get_system_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Returns the WordClock sample rate class for the given card.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_get_wc_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_1</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Returns the TCO sample rate class for the given card.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_get_tco_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">case</span> <span class="n">AIO</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_1</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Returns the SYNC_IN sample rate class for the given card.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_get_sync_in_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">case</span> <span class="n">AIO</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_2</span><span class="p">);</span>
			<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Returns the sample rate class for input source &lt;idx&gt; for</span>
<span class="cm"> * &#39;new style&#39; cards like the AIO and RayDAT.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_get_s1_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_2</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">idx</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
<span class="p">}</span>



<span class="cp">#define HDSPM_AUTOSYNC_SAMPLE_RATE(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.private_value = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">	.info = snd_hdspm_info_autosync_sample_rate, \</span>
<span class="cp">	.get = snd_hdspm_get_autosync_sample_rate \</span>
<span class="cp">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_autosync_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts_freq</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_autosync_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span>
					      <span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_wc_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_tco_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_sync_in_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_s1_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
						<span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_wc_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* TCO */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_tco_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* SYNC_IN */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_sync_in_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_s1_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
						<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">AES32</span>:

		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_wc_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* TCO */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_tco_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>: <span class="cm">/* SYNC_IN */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_sync_in_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* AES1 to AES8 */</span>
			<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdspm_get_s1_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
						<span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_SYSTEM_CLOCK_MODE(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">		SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_system_clock_mode, \</span>
<span class="cp">	.get = snd_hdspm_get_system_clock_mode, \</span>
<span class="cp">	.put = snd_hdspm_put_system_clock_mode, \</span>
<span class="cp">}</span>


<span class="cm">/**</span>
<span class="cm"> * Returns the system clock mode for the given card.</span>
<span class="cm"> * @returns 0 - master, 1 - slave</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO</span>:
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_c0Master</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_ClockModeMaster</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Sets the system clock mode.</span>
<span class="cm"> * @param mode 0 - master, 1 - slave</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdspm_set_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO</span>:
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">|=</span> <span class="n">HDSPM_c0Master</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_c0Master</span><span class="p">;</span>

		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_SETTINGS</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_ClockModeMaster</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_ClockModeMaster</span><span class="p">;</span>

		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Master&quot;</span><span class="p">,</span> <span class="s">&quot;AutoSync&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_system_clock_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">hdspm_set_system_clock_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_INTERNAL_CLOCK(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.info = snd_hdspm_info_clock_source, \</span>
<span class="cp">	.get = snd_hdspm_get_clock_source, \</span>
<span class="cp">	.put = snd_hdspm_put_clock_source \</span>
<span class="cp">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64000</span>: <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>: <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>: <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128000</span>: <span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">176400</span>: <span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192000</span>: <span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdspm_set_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts_freq</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_clock_source</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_clock_source</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdspm_set_clock_source</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_PREF_SYNC_REF(xname, xindex) \</span>
<span class="cp">{.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">			SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_pref_sync_ref, \</span>
<span class="cp">	.get = snd_hdspm_get_pref_sync_ref, \</span>
<span class="cp">	.put = snd_hdspm_put_pref_sync_ref \</span>
<span class="cp">}</span>


<span class="cm">/**</span>
<span class="cm"> * Returns the current preferred sync reference setting.</span>
<span class="cm"> * The semantics of the return value are depending on the</span>
<span class="cm"> * card, please see the comments for clarification.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_SyncRefMask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef0</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* AES 1 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef1</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* AES 2 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef1</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span>: <span class="k">return</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* AES 3 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef2</span>: <span class="k">return</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* AES 4 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef2</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span>: <span class="k">return</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* AES 5 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef2</span><span class="o">+</span><span class="n">HDSPM_SyncRef1</span>: <span class="k">return</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* AES 6 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef2</span><span class="o">+</span><span class="n">HDSPM_SyncRef1</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span>:
						    <span class="k">return</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* AES 7 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef3</span>: <span class="k">return</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* AES 8 */</span>
		<span class="k">case</span> <span class="n">HDSPM_SyncRef3</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span>: <span class="k">return</span> <span class="mi">9</span><span class="p">;</span> <span class="cm">/* TCO */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_SyncRefMask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="n">HDSPM_SyncRef0</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* MADI */</span>
			<span class="k">case</span> <span class="n">HDSPM_SyncRef1</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* TCO */</span>
			<span class="k">case</span> <span class="n">HDSPM_SyncRef1</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span>:
					     <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* SYNC_IN */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_SyncRefMask</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="n">HDSPM_SyncRef0</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* MADI */</span>
			<span class="k">case</span> <span class="n">HDSPM_SyncRef1</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span>:
					     <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* SYNC_IN */</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;</span>
				<span class="n">HDSPM_c0_SyncRefMask</span><span class="p">)</span> <span class="o">/</span> <span class="n">HDSPM_c0_SyncRef0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* ADAT 1 */</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* ADAT 2 */</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* ADAT 3 */</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>  <span class="cm">/* ADAT 4 */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="k">return</span> <span class="mi">6</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">9</span>: <span class="k">return</span> <span class="mi">7</span><span class="p">;</span>  <span class="cm">/* TCO */</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="k">return</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;</span>
				<span class="n">HDSPM_c0_SyncRefMask</span><span class="p">)</span> <span class="o">/</span> <span class="n">HDSPM_c0_SyncRef0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* ADAT 1 */</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* ADAT 2 */</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* ADAT 3 */</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>  <span class="cm">/* ADAT 4 */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="k">return</span> <span class="mi">6</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="k">return</span> <span class="mi">7</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;</span>
				<span class="n">HDSPM_c0_SyncRefMask</span><span class="p">)</span> <span class="o">/</span> <span class="n">HDSPM_c0_SyncRef0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* ADAT */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">9</span>: <span class="k">return</span> <span class="mi">4</span><span class="p">;</span>  <span class="cm">/* TCO */</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="k">return</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;</span>
				<span class="n">HDSPM_c0_SyncRefMask</span><span class="p">)</span> <span class="o">/</span> <span class="n">HDSPM_c0_SyncRef0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* ADAT */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">10</span>: <span class="k">return</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Set the preferred sync reference to &lt;pref&gt;. The semantics</span>
<span class="cm"> * of &lt;pref&gt; are depending on the card type, see the comments</span>
<span class="cm"> * for clarification.</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_SyncRefMask</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC  */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* AES 1 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* AES 2 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* AES 3 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
				<span class="n">HDSPM_SyncRef1</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* AES 4 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* AES 5 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
				<span class="n">HDSPM_SyncRef2</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>: <span class="cm">/* AES 6 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
				<span class="n">HDSPM_SyncRef2</span><span class="o">+</span><span class="n">HDSPM_SyncRef1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* AES 7 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
				<span class="n">HDSPM_SyncRef2</span><span class="o">+</span><span class="n">HDSPM_SyncRef1</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* AES 8 */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* TCO */</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
				<span class="n">HDSPM_SyncRef3</span><span class="o">+</span><span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_SyncRefMask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* MADI */</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* TCO */</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* SYNC_IN */</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
					<span class="n">HDSPM_SyncRef0</span><span class="o">+</span><span class="n">HDSPM_SyncRef1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* MADI */</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_SyncRef0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* SYNC_IN */</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span>
					<span class="n">HDSPM_SyncRef0</span><span class="o">+</span><span class="n">HDSPM_SyncRef1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 1 */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 2 */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 3 */</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 4 */</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* TCO */</span>
			<span class="k">case</span> <span class="mi">8</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 1 */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 2 */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 3 */</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT 4 */</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">6</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">7</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* TCO */</span>
			<span class="k">case</span> <span class="mi">5</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* WC */</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* ADAT */</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* AES */</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>  <span class="cm">/* SPDIF */</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="n">p</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span> <span class="cm">/* SYNC_IN */</span>
			<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_c0_SyncRefMask</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">|=</span> <span class="n">HDSPM_c0_SyncRef0</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_SETTINGS</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">MADIface</span>:
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">psf</span> <span class="o">=</span> <span class="n">hdspm_pref_sync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psf</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">psf</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_pref_sync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">hdspm_set_pref_sync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_AUTOSYNC_REF(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdspm_info_autosync_ref, \</span>
<span class="cp">  .get = snd_hdspm_get_autosync_ref, \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AES32</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">syncref</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">HDSPM_AES32_syncref_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">syncref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_WORD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">syncref</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">syncref</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MADI</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This looks at the autosync selected sync reference */</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_SelSyncRefMask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HDSPM_SelSyncRef_WORD</span>:
			<span class="k">return</span> <span class="n">HDSPM_AUTOSYNC_FROM_WORD</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSPM_SelSyncRef_MADI</span>:
			<span class="k">return</span> <span class="n">HDSPM_AUTOSYNC_FROM_MADI</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSPM_SelSyncRef_TCO</span>:
			<span class="k">return</span> <span class="n">HDSPM_AUTOSYNC_FROM_TCO</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSPM_SelSyncRef_SyncIn</span>:
			<span class="k">return</span> <span class="n">HDSPM_AUTOSYNC_FROM_SYNC_IN</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSPM_SelSyncRef_NVALID</span>:
			<span class="k">return</span> <span class="n">HDSPM_AUTOSYNC_FROM_NONE</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AES32</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;WordClock&quot;</span><span class="p">,</span> <span class="s">&quot;AES1&quot;</span><span class="p">,</span> <span class="s">&quot;AES2&quot;</span><span class="p">,</span> <span class="s">&quot;AES3&quot;</span><span class="p">,</span>
			<span class="s">&quot;AES4&quot;</span><span class="p">,</span>	<span class="s">&quot;AES5&quot;</span><span class="p">,</span> <span class="s">&quot;AES6&quot;</span><span class="p">,</span> <span class="s">&quot;AES7&quot;</span><span class="p">,</span> <span class="s">&quot;AES8&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span><span class="p">};</span>

		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
				<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MADI</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Word Clock&quot;</span><span class="p">,</span> <span class="s">&quot;MADI&quot;</span><span class="p">,</span> <span class="s">&quot;TCO&quot;</span><span class="p">,</span>
			<span class="s">&quot;Sync In&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span> <span class="p">};</span>

		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span>
				<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
				<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_LINE_OUT(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_line_out, \</span>
<span class="cp">  .get = snd_hdspm_get_line_out, \</span>
<span class="cp">  .put = snd_hdspm_put_line_out \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_line_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_LineOut</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_line_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_LineOut</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_LineOut</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_line_out		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_line_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_line_out</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_line_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_line_out</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_line_output</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_TX_64(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_tx_64, \</span>
<span class="cp">  .get = snd_hdspm_get_tx_64, \</span>
<span class="cp">  .put = snd_hdspm_put_tx_64 \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_tx_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_TX_64ch</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_tx_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_TX_64ch</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_TX_64ch</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_tx_64		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tx_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_tx_64</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tx_64</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_tx_64</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_tx_64</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_C_TMS(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_c_tms, \</span>
<span class="cp">  .get = snd_hdspm_get_c_tms, \</span>
<span class="cp">  .put = snd_hdspm_put_c_tms \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_c_tms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_clr_tms</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_c_tms</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_clr_tms</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_clr_tms</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_c_tms		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_c_tms</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_c_tms</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_c_tms</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_c_tms</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_c_tms</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_SAFE_MODE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_safe_mode, \</span>
<span class="cp">  .get = snd_hdspm_get_safe_mode, \</span>
<span class="cp">  .put = snd_hdspm_put_safe_mode \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_safe_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_AutoInp</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_safe_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_AutoInp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_AutoInp</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_safe_mode	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_safe_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_safe_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_safe_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_safe_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_safe_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_EMPHASIS(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_emphasis, \</span>
<span class="cp">  .get = snd_hdspm_get_emphasis, \</span>
<span class="cp">  .put = snd_hdspm_put_emphasis \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_Emphasis</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">emp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">emp</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_Emphasis</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_Emphasis</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_emphasis		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_emphasis</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_emphasis</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_emphasis</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_DOLBY(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_dolby, \</span>
<span class="cp">  .get = snd_hdspm_get_dolby, \</span>
<span class="cp">  .put = snd_hdspm_put_dolby \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_dolby</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_Dolby</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_dolby</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dol</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_Dolby</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_Dolby</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_dolby		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_dolby</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_dolby</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_dolby</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_dolby</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_dolby</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_PROFESSIONAL(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_professional, \</span>
<span class="cp">  .get = snd_hdspm_get_professional, \</span>
<span class="cp">  .put = snd_hdspm_put_professional \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_Professional</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dol</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_Professional</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_Professional</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdspm_info_professional	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_professional</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_professional</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_professional</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSPM_INPUT_SELECT(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_input_select, \</span>
<span class="cp">  .get = snd_hdspm_get_input_select, \</span>
<span class="cp">  .put = snd_hdspm_put_input_select \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_InputSelect0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_InputSelect0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_InputSelect0</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;optical&quot;</span><span class="p">,</span> <span class="s">&quot;coaxial&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_input_select</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_input_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_input_select</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_input_select</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_DS_WIRE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_ds_wire, \</span>
<span class="cp">  .get = snd_hdspm_get_ds_wire, \</span>
<span class="cp">  .put = snd_hdspm_put_ds_wire \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_ds_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_DS_DoubleWire</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_ds_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ds</span><span class="p">)</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_DS_DoubleWire</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPM_DS_DoubleWire</span><span class="p">;</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_ds_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Single&quot;</span><span class="p">,</span> <span class="s">&quot;Double&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_ds_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_ds_wire</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_ds_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_ds_wire</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_ds_wire</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_QS_WIRE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdspm_info_qs_wire, \</span>
<span class="cp">  .get = snd_hdspm_get_qs_wire, \</span>
<span class="cp">  .put = snd_hdspm_put_qs_wire \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_qs_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_QS_DoubleWire</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_QS_QuadWire</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_qs_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSPM_QS_DoubleWire</span> <span class="o">|</span> <span class="n">HDSPM_QS_QuadWire</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_QS_DoubleWire</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_QS_QuadWire</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_qs_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Single&quot;</span><span class="p">,</span> <span class="s">&quot;Double&quot;</span><span class="p">,</span> <span class="s">&quot;Quad&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_qs_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_qs_wire</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_qs_wire</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_qs_wire</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_qs_wire</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSPM_MADI_SPEEDMODE(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.info = snd_hdspm_info_madi_speedmode, \</span>
<span class="cp">	.get = snd_hdspm_get_madi_speedmode, \</span>
<span class="cp">	.put = snd_hdspm_put_madi_speedmode \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_madi_speedmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_QuadSpeed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_DoubleSpeed</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_set_madi_speedmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSPM_DoubleSpeed</span> <span class="o">|</span> <span class="n">HDSPM_QuadSpeed</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_DoubleSpeed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPM_QuadSpeed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_madi_speedmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Single&quot;</span><span class="p">,</span> <span class="s">&quot;Double&quot;</span><span class="p">,</span> <span class="s">&quot;Quad&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
		    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_madi_speedmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm_madi_speedmode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_madi_speedmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdspm_madi_speedmode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm_set_madi_speedmode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSPM_MIXER(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_HWDEP, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .device = 0, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READWRITE | \</span>
<span class="cp">		 SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdspm_info_mixer, \</span>
<span class="cp">  .get = snd_hdspm_get_mixer, \</span>
<span class="cp">  .put = snd_hdspm_put_mixer \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destination</span><span class="p">;</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
		<span class="n">source</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">destination</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">destination</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">destination</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">destination</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
		<span class="n">destination</span> <span class="o">=</span> <span class="n">HDSPM_MAX_CHANNELS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">hdspm_read_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span>
				       <span class="n">source</span> <span class="o">-</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">hdspm_read_in_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destination</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">destination</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">source</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">destination</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">destination</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">gain</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">!=</span> <span class="n">hdspm_read_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span>
						    <span class="n">source</span> <span class="o">-</span>
						    <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">!=</span> <span class="n">hdspm_read_in_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span>
						    <span class="n">source</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">)</span>
			<span class="n">hdspm_write_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span>
					    <span class="n">source</span> <span class="o">-</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
					    <span class="n">gain</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">hdspm_write_in_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span>
					    <span class="n">gain</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The simple mixer control(s) provide gain control for the</span>
<span class="cm">   basic 1:1 mappings of playback streams to output</span>
<span class="cm">   streams.</span>
<span class="cm">*/</span>

<span class="cp">#define HDSPM_PLAYBACK_MIXER \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_WRITE | \</span>
<span class="cp">		 SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdspm_info_playback_mixer, \</span>
<span class="cp">  .get = snd_hdspm_get_playback_mixer, \</span>
<span class="cp">  .put = snd_hdspm_put_playback_mixer \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_playback_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_playback_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
	  <span class="p">(</span><span class="n">hdspm_read_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span><span class="o">*</span><span class="mi">64</span><span class="p">)</span><span class="o">/</span><span class="n">UNITY_GAIN</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_playback_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdspm_use_is_exclusive</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">gain</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">UNITY_GAIN</span><span class="o">/</span><span class="mi">64</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span>
	    <span class="n">gain</span> <span class="o">!=</span> <span class="n">hdspm_read_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				       <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">hdspm_write_pb_gain</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
				    <span class="n">gain</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSPM_SYNC_CHECK(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.private_value = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_sync_check, \</span>
<span class="cp">	.get = snd_hdspm_get_sync_check \</span>
<span class="cp">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;No Lock&quot;</span><span class="p">,</span> <span class="s">&quot;Lock&quot;</span><span class="p">,</span> <span class="s">&quot;Sync&quot;</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_wc_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">status2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcSync</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcLock</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
		<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcLock</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcSync</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2000000</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x1000000</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_madi_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiLock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiSync</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_s1_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">sync</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_1</span><span class="p">);</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x1</span><span class="o">&lt;&lt;</span><span class="n">idx</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x100</span><span class="o">&lt;&lt;</span><span class="n">idx</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">sync</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_sync_in_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_3</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_syncInLock</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_syncInSync</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">sync</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_aes_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status2</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">sync</span><span class="p">;</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x0080</span> <span class="o">&gt;&gt;</span> <span class="n">idx</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sync</span> <span class="o">=</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&gt;&gt;</span> <span class="n">idx</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_tco_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MADI</span>:
		<span class="k">case</span> <span class="n">AES32</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_tcoLock</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_tcoSync</span><span class="p">)</span>
					<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">case</span> <span class="n">AIO</span>:
			<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x8000000</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Sync */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x4000000</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Lock */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No signal */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* N/A */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_wc_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>: <span class="cm">/* TCO */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_tco_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>: <span class="cm">/* SYNC IN */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_sync_in_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_s1_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_wc_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="cm">/* TCO */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_tco_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>: <span class="cm">/* SYNC IN */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_sync_in_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_s1_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">MADI</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_wc_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* MADI */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_madi_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* TCO */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_tco_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* SYNC_IN */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_sync_in_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_madi_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="cm">/* MADI */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* WC */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_wc_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>: <span class="cm">/* TCO */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_tco_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span> <span class="cm">/* SYNC IN */</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_sync_in_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* AES1 to AES8 */</span>
			 <span class="n">val</span> <span class="o">=</span> <span class="n">hdspm_aes_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
					 <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * TCO controls</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdspm_tco_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_input_MSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_input_LSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">framerate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO1_LTC_Format_LSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO1_LTC_Format_MSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO1_LTC_Format_MSB</span> <span class="o">+</span>
			<span class="n">HDSPM_TCO1_set_drop_frame_flag</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO1_LTC_Format_LSB</span> <span class="o">+</span>
			<span class="n">HDSPM_TCO1_LTC_Format_MSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO1_LTC_Format_LSB</span> <span class="o">+</span>
			<span class="n">HDSPM_TCO1_LTC_Format_MSB</span> <span class="o">+</span>
			<span class="n">HDSPM_TCO1_set_drop_frame_flag</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">wordclock</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_WCK_IO_ratio_LSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_WCK_IO_ratio_MSB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">samplerate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_freq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_freq_from_app</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">pull</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_pull_up</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_pull_down</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_pull_up</span> <span class="o">+</span> <span class="n">HDSPM_TCO2_set_01_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_pull_down</span> <span class="o">+</span> <span class="n">HDSPM_TCO2_set_01_4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">HDSPM_TCO2_set_term_75R</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_TCO</span><span class="p">,</span> <span class="n">tc</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_TCO</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="n">tc</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_TCO</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">tc</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_TCO</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="n">tc</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_TCO_SAMPLE_RATE(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">		SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_tco_sample_rate, \</span>
<span class="cp">	.get = snd_hdspm_get_tco_sample_rate, \</span>
<span class="cp">	.put = snd_hdspm_put_tco_sample_rate \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_tco_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;44.1 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;48 kHz&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tco_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">samplerate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tco_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">samplerate</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">samplerate</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_TCO_PULL(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">		SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_tco_pull, \</span>
<span class="cp">	.get = snd_hdspm_get_tco_pull, \</span>
<span class="cp">	.put = snd_hdspm_put_tco_pull \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_tco_pull</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="s">&quot;+ 0.1 %&quot;</span><span class="p">,</span> <span class="s">&quot;- 0.1 %&quot;</span><span class="p">,</span> <span class="s">&quot;+ 4 %&quot;</span><span class="p">,</span> <span class="s">&quot;- 4 %&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tco_pull</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">pull</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tco_pull</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">pull</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">pull</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSPM_TCO_WCK_CONVERSION(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">			SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_tco_wck_conversion, \</span>
<span class="cp">	.get = snd_hdspm_get_tco_wck_conversion, \</span>
<span class="cp">	.put = snd_hdspm_put_tco_wck_conversion \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_tco_wck_conversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;1:1&quot;</span><span class="p">,</span> <span class="s">&quot;44.1 -&gt; 48&quot;</span><span class="p">,</span> <span class="s">&quot;48 -&gt; 44.1&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tco_wck_conversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">wordclock</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tco_wck_conversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">wordclock</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">wordclock</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_TCO_FRAME_RATE(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">			SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_tco_frame_rate, \</span>
<span class="cp">	.get = snd_hdspm_get_tco_frame_rate, \</span>
<span class="cp">	.put = snd_hdspm_put_tco_frame_rate \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_tco_frame_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;24 fps&quot;</span><span class="p">,</span> <span class="s">&quot;25 fps&quot;</span><span class="p">,</span> <span class="s">&quot;29.97fps&quot;</span><span class="p">,</span>
		<span class="s">&quot;29.97 dfps&quot;</span><span class="p">,</span> <span class="s">&quot;30 fps&quot;</span><span class="p">,</span> <span class="s">&quot;30 dfps&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tco_frame_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">framerate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tco_frame_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">framerate</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">framerate</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_TCO_SYNC_SOURCE(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">			SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_tco_sync_source, \</span>
<span class="cp">	.get = snd_hdspm_get_tco_sync_source, \</span>
<span class="cp">	.put = snd_hdspm_put_tco_sync_source \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_tco_sync_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;LTC&quot;</span><span class="p">,</span> <span class="s">&quot;Video&quot;</span><span class="p">,</span> <span class="s">&quot;WCK&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span>
			<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tco_sync_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tco_sync_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define HDSPM_TCO_WORD_TERM(xname, xindex) \</span>
<span class="cp">{	.iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">	.name = xname, \</span>
<span class="cp">	.index = xindex, \</span>
<span class="cp">	.access = SNDRV_CTL_ELEM_ACCESS_READWRITE |\</span>
<span class="cp">			SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">	.info = snd_hdspm_info_tco_word_term, \</span>
<span class="cp">	.get = snd_hdspm_get_tco_word_term, \</span>
<span class="cp">	.put = snd_hdspm_put_tco_word_term \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_info_tco_word_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_get_tco_word_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">term</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_put_tco_word_term</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">term</span> <span class="o">!=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="o">-&gt;</span><span class="n">term</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>




<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_controls_madi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDSPM_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_INTERNAL_CLOCK</span><span class="p">(</span><span class="s">&quot;Internal Clock&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_CLOCK_MODE</span><span class="p">(</span><span class="s">&quot;System Clock Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_PREF_SYNC_REF</span><span class="p">(</span><span class="s">&quot;Preferred Sync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_REF</span><span class="p">(</span><span class="s">&quot;AutoSync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;WC SyncCheck&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;MADI SyncCheck&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;TCO SyncCHeck&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SYNC IN SyncCheck&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_LINE_OUT</span><span class="p">(</span><span class="s">&quot;Line Out&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TX_64</span><span class="p">(</span><span class="s">&quot;TX 64 channels mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_C_TMS</span><span class="p">(</span><span class="s">&quot;Clear Track Marker&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SAFE_MODE</span><span class="p">(</span><span class="s">&quot;Safe Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_INPUT_SELECT</span><span class="p">(</span><span class="s">&quot;Input Select&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_MADI_SPEEDMODE</span><span class="p">(</span><span class="s">&quot;MADI Speed Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_controls_madiface</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDSPM_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_INTERNAL_CLOCK</span><span class="p">(</span><span class="s">&quot;Internal Clock&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_CLOCK_MODE</span><span class="p">(</span><span class="s">&quot;System Clock Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;External Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;MADI SyncCheck&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TX_64</span><span class="p">(</span><span class="s">&quot;TX 64 channels mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_C_TMS</span><span class="p">(</span><span class="s">&quot;Clear Track Marker&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SAFE_MODE</span><span class="p">(</span><span class="s">&quot;Safe Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_MADI_SPEEDMODE</span><span class="p">(</span><span class="s">&quot;MADI Speed Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_controls_aio</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDSPM_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_INTERNAL_CLOCK</span><span class="p">(</span><span class="s">&quot;Internal Clock&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_CLOCK_MODE</span><span class="p">(</span><span class="s">&quot;System Clock Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_PREF_SYNC_REF</span><span class="p">(</span><span class="s">&quot;Preferred Sync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_REF</span><span class="p">(</span><span class="s">&quot;AutoSync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;External Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;WC SyncCheck&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES SyncCheck&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SPDIF SyncCheck&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;ADAT SyncCheck&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;TCO SyncCheck&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SYNC IN SyncCheck&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;WC Frequency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES Frequency&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;SPDIF Frequency&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;ADAT Frequency&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;TCO Frequency&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;SYNC IN Frequency&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

		<span class="cm">/*</span>
<span class="cm">		   HDSPM_INPUT_SELECT(&quot;Input Select&quot;, 0),</span>
<span class="cm">		   HDSPM_SPDIF_OPTICAL(&quot;SPDIF Out Optical&quot;, 0),</span>
<span class="cm">		   HDSPM_PROFESSIONAL(&quot;SPDIF Out Professional&quot;, 0);</span>
<span class="cm">		   HDSPM_SPDIF_IN(&quot;SPDIF In&quot;, 0);</span>
<span class="cm">		   HDSPM_BREAKOUT_CABLE(&quot;Breakout Cable&quot;, 0);</span>
<span class="cm">		   HDSPM_INPUT_LEVEL(&quot;Input Level&quot;, 0);</span>
<span class="cm">		   HDSPM_OUTPUT_LEVEL(&quot;Output Level&quot;, 0);</span>
<span class="cm">		   HDSPM_PHONES(&quot;Phones&quot;, 0);</span>
<span class="cm">		   */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_controls_raydat</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDSPM_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_INTERNAL_CLOCK</span><span class="p">(</span><span class="s">&quot;Internal Clock&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_CLOCK_MODE</span><span class="p">(</span><span class="s">&quot;Clock Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_PREF_SYNC_REF</span><span class="p">(</span><span class="s">&quot;Pref Sync Ref&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;WC SyncCheck&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES SyncCheck&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SPDIF SyncCheck&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;ADAT1 SyncCheck&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;ADAT2 SyncCheck&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;ADAT3 SyncCheck&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;ADAT4 SyncCheck&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;TCO SyncCheck&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SYNC IN SyncCheck&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;WC Frequency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES Frequency&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;SPDIF Frequency&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;ADAT1 Frequency&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;ADAT2 Frequency&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;ADAT3 Frequency&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;ADAT4 Frequency&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;TCO Frequency&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;SYNC IN Frequency&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_controls_aes32</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDSPM_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_INTERNAL_CLOCK</span><span class="p">(</span><span class="s">&quot;Internal Clock&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_CLOCK_MODE</span><span class="p">(</span><span class="s">&quot;System Clock Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_PREF_SYNC_REF</span><span class="p">(</span><span class="s">&quot;Preferred Sync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_REF</span><span class="p">(</span><span class="s">&quot;AutoSync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;External Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;WC Sync Check&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES1 Sync Check&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES2 Sync Check&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES3 Sync Check&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES4 Sync Check&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES5 Sync Check&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES6 Sync Check&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES7 Sync Check&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;AES8 Sync Check&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;TCO Sync Check&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">HDSPM_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SYNC IN Sync Check&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;WC Frequency&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES1 Frequency&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES2 Frequency&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES3 Frequency&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES4 Frequency&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES5 Frequency&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES6 Frequency&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES7 Frequency&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;AES8 Frequency&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;TCO Frequency&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">HDSPM_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;SYNC IN Frequency&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">HDSPM_LINE_OUT</span><span class="p">(</span><span class="s">&quot;Line Out&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_EMPHASIS</span><span class="p">(</span><span class="s">&quot;Emphasis&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_DOLBY</span><span class="p">(</span><span class="s">&quot;Non Audio&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_PROFESSIONAL</span><span class="p">(</span><span class="s">&quot;Professional&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_C_TMS</span><span class="p">(</span><span class="s">&quot;Clear Track Marker&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_DS_WIRE</span><span class="p">(</span><span class="s">&quot;Double Speed Wire Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_QS_WIRE</span><span class="p">(</span><span class="s">&quot;Quad Speed Wire Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>



<span class="cm">/* Control elements for the optional TCO module */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_controls_tco</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">HDSPM_TCO_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;TCO Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TCO_PULL</span><span class="p">(</span><span class="s">&quot;TCO Pull&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TCO_WCK_CONVERSION</span><span class="p">(</span><span class="s">&quot;TCO WCK Conversion&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TCO_FRAME_RATE</span><span class="p">(</span><span class="s">&quot;TCO Frame Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TCO_SYNC_SOURCE</span><span class="p">(</span><span class="s">&quot;TCO Sync Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSPM_TCO_WORD_TERM</span><span class="p">(</span><span class="s">&quot;TCO Word Term&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdspm_playback_mixer</span> <span class="o">=</span> <span class="n">HDSPM_PLAYBACK_MIXER</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdspm_update_simple_mixer_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_mixer_ctls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">=</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span> <span class="o">|</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span> <span class="o">|</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_VOLATILE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_mixer_ctls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">=</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_VOLATILE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
				<span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_mixer_ctls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_create_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MADI</span>:
		<span class="n">list</span> <span class="o">=</span> <span class="n">snd_hdspm_controls_madi</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdspm_controls_madi</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">list</span> <span class="o">=</span> <span class="n">snd_hdspm_controls_madiface</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdspm_controls_madiface</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">list</span> <span class="o">=</span> <span class="n">snd_hdspm_controls_aio</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdspm_controls_aio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="n">list</span> <span class="o">=</span> <span class="n">snd_hdspm_controls_raydat</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdspm_controls_raydat</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">list</span> <span class="o">=</span> <span class="n">snd_hdspm_controls_aes32</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdspm_controls_aes32</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
					<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hdspm</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* create simple 1:1 playback mixer controls */</span>
	<span class="n">snd_hdspm_playback_mixer</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Chn&quot;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">&gt;=</span> <span class="mi">128000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">&gt;=</span> <span class="mi">64000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_hdspm_playback_mixer</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdspm_playback_mixer</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_mixer_ctls</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* add tco control elements */</span>
		<span class="n">list</span> <span class="o">=</span> <span class="n">snd_hdspm_controls_tco</span><span class="p">;</span>
		<span class="n">limit</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdspm_controls_tco</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
					<span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">list</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hdspm</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   /proc interface</span>
<span class="cm"> ------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdspm_proc_read_madi</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">status2</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">freq</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">pref_sync_ref</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">autosync_ref</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">system_clock_mode</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">insel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">x2</span><span class="p">;</span>

	<span class="cm">/* TCO stuff */</span>
	<span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="n">ltc</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">hours</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">freq_const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_timecodeRegister</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s (Card #%d) Rev.%x Status2first3bits: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_version0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_version1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span>
				<span class="n">HDSPM_version2</span><span class="p">));</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;HW Serial: 0x%06x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IRQ: %d Registers bus: 0x%lx VM: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- System ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;IRQ Pending: Audio=%d, MIDI0=%d, MIDI1=%d, IRQcount=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_audioIRQPending</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_midi0IRQPending</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_midi1IRQPending</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq_count</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;HW pointer: id = %d, rawptr = %d (%d-&gt;%d) &quot;</span>
		<span class="s">&quot;estimated= %ld (bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">),</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">)</span> <span class="o">%</span>
		<span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">),</span>
		<span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">%</span>
		<span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">hdspm_hw_pointer</span><span class="p">(</span><span class="n">hdspm</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;MIDI FIFO: Out1=0x%x, Out2=0x%x, In1=0x%x, In2=0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusOut0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusOut1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;MIDIoverMADI FIFO: In=0x%x, Out=0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusOut2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;Register: ctrl1=0x%x, ctrl2=0x%x, status1=0x%x, &quot;</span>
		<span class="s">&quot;status2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">status2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_tco_detect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;TCO module detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_TCO</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_LTC_Input_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  LTC valid, &quot;</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSPM_TCO1_LTC_Format_LSB</span> <span class="o">|</span>
						<span class="n">HDSPM_TCO1_LTC_Format_MSB</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;24 fps, &quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_TCO1_LTC_Format_LSB</span>:
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;25 fps, &quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_TCO1_LTC_Format_MSB</span>:
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;29.97 fps, &quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;30 fps, &quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_set_drop_frame_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;drop frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;full frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  no LTC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_Video_Input_Format_NTSC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Video: NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_Video_Input_Format_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Video: PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  No video</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_TCO_lock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Sync: lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Sync: no lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MADI</span>:
		<span class="k">case</span> <span class="n">AES32</span>:
			<span class="n">freq_const</span> <span class="o">=</span> <span class="mi">110069313433624ULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">case</span> <span class="n">AIO</span>:
			<span class="n">freq_const</span> <span class="o">=</span> <span class="mi">104857600000000ULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MADIface</span>:
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* no TCO possible */</span>
		<span class="p">}</span>

		<span class="n">period</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_PLL_FREQ</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;    period: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>


		<span class="cm">/* rate = freq_const/period; */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">freq_const</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">HDSPM_QuadSpeed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;</span> <span class="n">HDSPM_DoubleSpeed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;  Frequency: %u Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">rate</span><span class="p">);</span>

		<span class="n">ltc</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_TCO</span><span class="p">);</span>
		<span class="n">frames</span> <span class="o">=</span> <span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">seconds</span> <span class="o">=</span> <span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">seconds</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">minutes</span> <span class="o">=</span> <span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">minutes</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">hours</span> <span class="o">=</span> <span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="n">ltc</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">hours</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ltc</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
			<span class="s">&quot;  LTC In: %02d:%02d:%02d:%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;No TCO module detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- Settings ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">hdspm_get_latency</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;Size (Latency): %d samples (2 periods of %lu bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Line out: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_LineOut</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on &quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_InputMask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSPM_InputOptical</span>:
		<span class="n">insel</span> <span class="o">=</span> <span class="s">&quot;Optical&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_InputCoaxial</span>:
		<span class="n">insel</span> <span class="o">=</span> <span class="s">&quot;Coaxial&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">insel</span> <span class="o">=</span> <span class="s">&quot;Unkown&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;ClearTrackMarker = %s, Transmit in %s Channel Mode, &quot;</span>
		<span class="s">&quot;Auto Input %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_clr_tms</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_TX_64ch</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;64&quot;</span> <span class="o">:</span> <span class="s">&quot;56&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_AutoInp</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_ClockModeMaster</span><span class="p">))</span>
		<span class="n">system_clock_mode</span> <span class="o">=</span> <span class="s">&quot;AutoSync&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">system_clock_mode</span> <span class="o">=</span> <span class="s">&quot;Master&quot;</span><span class="p">;</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AutoSync Reference: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">system_clock_mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm_pref_sync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSPM_SYNC_FROM_WORD</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_SYNC_FROM_MADI</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;MADI Sync&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_SYNC_FROM_TCO</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;TCO&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_SYNC_FROM_SYNC_IN</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;Sync In&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;XXXX Clock&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Preferred Sync Reference: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pref_sync_ref</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;System Clock Frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">);</span>


	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- Status:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiSync</span><span class="p">;</span>
	<span class="n">x2</span> <span class="o">=</span> <span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcSync</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Inputs MADI=%s, WordClock=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiLock</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">)</span> <span class="o">:</span>
			<span class="s">&quot;NoLock&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcLock</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">x2</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">)</span> <span class="o">:</span>
			<span class="s">&quot;NoLock&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSPM_AUTOSYNC_FROM_SYNC_IN</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;Sync In&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AUTOSYNC_FROM_TCO</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;TCO&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AUTOSYNC_FROM_WORD</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AUTOSYNC_FROM_MADI</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;MADI Sync&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AUTOSYNC_FROM_NONE</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;Input not valid&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;---&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		<span class="s">&quot;AutoSync: Reference= %s, Freq=%d (MADI = %d, Word = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">autosync_ref</span><span class="p">,</span> <span class="n">hdspm_external_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">),</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_madiFreqMask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSPM_wcFreqMask</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input: %s, Mode=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_AB_int</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Coax&quot;</span> <span class="o">:</span> <span class="s">&quot;Optical&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_RX_64ch</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;64 channels&quot;</span> <span class="o">:</span>
		<span class="s">&quot;56 channels&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdspm_proc_read_aes32</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span> <span class="n">entry</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timecode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pref_syncref</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">autosync_ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>
	<span class="n">timecode</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_timecodeRegister</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s (Card #%d) Rev.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IRQ: %d Registers bus: 0x%lx VM: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- System ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;IRQ Pending: Audio=%d, MIDI0=%d, MIDI1=%d, IRQcount=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_audioIRQPending</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_midi0IRQPending</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_midi1IRQPending</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq_count</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;HW pointer: id = %d, rawptr = %d (%d-&gt;%d) &quot;</span>
		    <span class="s">&quot;estimated= %ld (bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferID</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">)</span> <span class="o">%</span>
		    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">),</span>
		    <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_BufferPositionMask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">%</span>
		    <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">),</span>
		    <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">hdspm_hw_pointer</span><span class="p">(</span><span class="n">hdspm</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;MIDI FIFO: Out1=0x%x, Out2=0x%x, In1=0x%x, In2=0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusOut0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		    <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusOut1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		    <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		    <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;MIDIoverMADI FIFO: In=0x%x, Out=0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusIn2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		    <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_midiStatusOut2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;Register: ctrl1=0x%x, ctrl2=0x%x, status1=0x%x, &quot;</span>
		    <span class="s">&quot;status2=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">,</span>
		    <span class="n">status</span><span class="p">,</span> <span class="n">status2</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- Settings ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">hdspm_get_latency</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;Size (Latency): %d samples (2 periods of %lu bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Line out: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span>
		     <span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_LineOut</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on &quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
		    <span class="s">&quot;ClearTrackMarker %s, Emphasis %s, Dolby %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span>
		     <span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_clr_tms</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span>
		     <span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_Emphasis</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span>
		     <span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_Dolby</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>


	<span class="n">pref_syncref</span> <span class="o">=</span> <span class="n">hdspm_pref_sync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pref_syncref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Preferred Sync Reference: Word Clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Preferred Sync Reference: AES%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pref_syncref</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;System Clock Frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Double speed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_DS_DoubleWire</span><span class="o">?</span>
			<span class="s">&quot;Double wire&quot;</span> <span class="o">:</span> <span class="s">&quot;Single wire&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Quad speed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_QS_DoubleWire</span><span class="o">?</span>
			<span class="s">&quot;Double wire&quot;</span> <span class="o">:</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPM_QS_QuadWire</span><span class="o">?</span>
			<span class="s">&quot;Quad wire&quot;</span> <span class="o">:</span> <span class="s">&quot;Single wire&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;--- Status:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Word: %s  Frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_AES32_wcLock</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Sync   &quot;</span> <span class="o">:</span> <span class="s">&quot;No Lock&quot;</span><span class="p">,</span>
		    <span class="n">HDSPM_bit2freq</span><span class="p">((</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="n">HDSPM_AES32_wcFreq_bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AES%d: %s  Frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSPM_LockAES</span> <span class="o">&gt;&gt;</span> <span class="n">x</span><span class="p">))</span> <span class="o">?</span>
			    <span class="s">&quot;Sync   &quot;</span> <span class="o">:</span> <span class="s">&quot;No Lock&quot;</span><span class="p">,</span>
			    <span class="n">HDSPM_bit2freq</span><span class="p">((</span><span class="n">timecode</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">x</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_NONE</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_WORD</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES1</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES1&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES2</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES3</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES3&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES4</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES4&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES5</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES5&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES6</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES6&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES7</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES7&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AES32_AUTOSYNC_FROM_AES8</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;AES8&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;---&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AutoSync ref = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">autosync_ref</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdspm_proc_read_raydat</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status1</span><span class="p">,</span> <span class="n">status2</span><span class="p">,</span> <span class="n">status3</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">,</span> <span class="n">sync</span><span class="p">;</span>

	<span class="n">status1</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_1</span><span class="p">);</span> <span class="cm">/* s1 */</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_2</span><span class="p">);</span> <span class="cm">/* freq */</span>
	<span class="n">status3</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_STATUS_3</span><span class="p">);</span> <span class="cm">/* s2 */</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;STATUS1: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status1</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;STATUS2: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status2</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;STATUS3: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status3</span><span class="p">);</span>


	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">*** CLOCK MODE</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Clock mode      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hdspm_system_clock_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;master&quot;</span> <span class="o">:</span> <span class="s">&quot;slave&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;System frequency: %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hdspm_get_system_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">));</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">*** INPUT STATUS</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">lock</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">sync</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;s1_input %d: Lock %d, Sync %d, Freq %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span>
				<span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">lock</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">sync</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">texts_freq</span><span class="p">[(</span><span class="n">status2</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">]);</span>

		<span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;WC input: Lock %d, Sync %d, Freq %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0x1000000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0x2000000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">texts_freq</span><span class="p">[(</span><span class="n">status1</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">]);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;TCO input: Lock %d, Sync %d, Freq %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0x4000000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="mh">0x8000000</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">texts_freq</span><span class="p">[(</span><span class="n">status1</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">]);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SYNC IN: Lock %d, Sync %d, Freq %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status3</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status3</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">texts_freq</span><span class="p">[(</span><span class="n">status2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">]);</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdspm_proc_read_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="cm">/* 1024*64 */</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;0x%08X: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%08X &quot;</span><span class="p">,</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdspm_proc_ports_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;# generated by hdspm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%d=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdspm_proc_ports_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;# generated by hdspm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%d=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;hdspm&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AES32</span>:
			<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
					<span class="n">snd_hdspm_proc_read_aes32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MADI</span>:
			<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
					<span class="n">snd_hdspm_proc_read_madi</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MADIface</span>:
			<span class="cm">/* snd_info_set_text_ops(entry, hdspm,</span>
<span class="cm">			 snd_hdspm_proc_read_madiface); */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RayDAT</span>:
			<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
					<span class="n">snd_hdspm_proc_read_raydat</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AIO</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ports.in&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span> <span class="n">snd_hdspm_proc_ports_in</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;ports.out&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span> <span class="n">snd_hdspm_proc_ports_out</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SND_DEBUG</span>
	<span class="cm">/* debug file to read all hdspm registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;debug&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
				<span class="n">snd_hdspm_proc_read_debug</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   hdspm intitialize</span>
<span class="cm"> ------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ASSUMPTION: hdspm-&gt;lock is either held, or there is no need to</span>
<span class="cm">	   hold it (e.g. during module initialization).</span>
<span class="cm">	   */</span>

	<span class="cm">/* set defaults:       */</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span>
			<span class="mh">0x2</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mh">0x80</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="mh">0x4000</span> <span class="o">+</span> <span class="mh">0x1000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RayDAT</span>:
	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="cm">/* Magic values are: LAT_0, LAT_2, Master, freq1, tx64ch, inp_0,</span>
<span class="cm">		 * line_out */</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span>
			<span class="mh">0x2</span> <span class="o">+</span> <span class="mh">0x8</span> <span class="o">+</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="mh">0x80</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">+</span> <span class="mh">0x4000</span> <span class="o">+</span> <span class="mh">0x1000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span>
			<span class="n">HDSPM_ClockModeMaster</span> <span class="o">|</span>	<span class="cm">/* Master Cloack Mode on */</span>
			<span class="n">hdspm_encode_latency</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* latency max=8192samples */</span>
			<span class="n">HDSPM_SyncRef0</span> <span class="o">|</span>	<span class="cm">/* AES1 is syncclock */</span>
			<span class="n">HDSPM_LineOut</span> <span class="o">|</span>	<span class="cm">/* Analog output in */</span>
			<span class="n">HDSPM_Professional</span><span class="p">;</span>  <span class="cm">/* Professional mode */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AES32</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No control2 register for AES32 */</span>
<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="n">HDSPM_BIGENDIAN_MODE</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_control2Reg</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hdspm_compute_period_size</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="cm">/* silence everything */</span>

	<span class="n">all_in_all_mixer</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">UNITY_GAIN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">AIO</span> <span class="o">||</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">RayDAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_WR_SETTINGS</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">settings_register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set a default rate so that the channel map is set up. */</span>
	<span class="n">hdspm_set_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   interrupt</span>
<span class="cm"> ------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_hdspm_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">midi</span><span class="p">,</span> <span class="n">schedule</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* cycles_t now; */</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>

	<span class="n">audio</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSPM_audioIRQPending</span><span class="p">;</span>
	<span class="n">midi</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSPM_midi0IRQPending</span> <span class="o">|</span> <span class="n">HDSPM_midi1IRQPending</span> <span class="o">|</span>
			<span class="n">HDSPM_midi2IRQPending</span> <span class="o">|</span> <span class="n">HDSPM_midi3IRQPending</span><span class="p">);</span>

	<span class="cm">/* now = get_cycles(); */</span>
	<span class="cm">/**</span>
<span class="cm">	 *   LAT_2..LAT_0 period  counter (win)  counter (mac)</span>
<span class="cm">	 *          6       4096   ~256053425     ~514672358</span>
<span class="cm">	 *          5       2048   ~128024983     ~257373821</span>
<span class="cm">	 *          4       1024    ~64023706     ~128718089</span>
<span class="cm">	 *          3        512    ~32005945      ~64385999</span>
<span class="cm">	 *          2        256    ~16003039      ~32260176</span>
<span class="cm">	 *          1        128     ~7998738      ~16194507</span>
<span class="cm">	 *          0         64     ~3998231       ~8191558</span>
<span class="cm">	 **/</span>
	<span class="cm">/*</span>
<span class="cm">	   snd_printk(KERN_INFO &quot;snd_hdspm_interrupt %llu @ %llx\n&quot;,</span>
<span class="cm">	   now-hdspm-&gt;last_interrupt, status &amp; 0xFFC0);</span>
<span class="cm">	   hdspm-&gt;last_interrupt = now;</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">midi</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_interruptConfirmation</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq_count</span><span class="o">++</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">midi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">statusIn</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* we disable interrupts for this input until</span>
<span class="cm">				 * processing is done</span>
<span class="cm">				 */</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ie</span><span class="p">;</span>
				<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span>
						<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">schedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">schedule</span><span class="p">)</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   pcm interface</span>
<span class="cm">  ------------------------------------------------------------*/</span>


<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_hdspm_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span>
					      <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hdspm_hw_pointer</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="n">hdspm_hw_pointer</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">oruntime</span> <span class="o">=</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">oruntime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span>
					<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">this_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">other_pid</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">other_pid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">this_pid</span> <span class="o">!=</span> <span class="n">other_pid</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* The other stream is open, and not by the same</span>
<span class="cm">		   task as this one. Make sure that the parameters</span>
<span class="cm">		   that matter are the same.</span>
<span class="cm">		   */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
					<span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params_period_size</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
					<span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="cm">/* We&#39;re fine. */</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* how to make sure that the rate matches an externally-set one ?   */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hdspm_set_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;err on hdspm_set_rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hdspm_set_interrupt_interval</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
			<span class="n">params_period_size</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;err on hdspm_set_interrupt_interval: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Memory allocation, takashi&#39;s method, dont know if we should</span>
<span class="cm">	 * spinlock</span>
<span class="cm">	 */</span>
	<span class="cm">/* malloc all buffer even if not enabled to get sure */</span>
	<span class="cm">/* Update for MADI rev 204: we need to allocate for all channels,</span>
<span class="cm">	 * otherwise it doesn&#39;t work at 96kHz */</span>

	<span class="n">err</span> <span class="o">=</span>
		<span class="n">snd_pcm_lib_malloc_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">HDSPM_DMA_AREA_BYTES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;err on snd_pcm_lib_malloc_pages: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hdspm_set_sgbuf</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">HDSPM_pageAddressBufferOut</span><span class="p">,</span>
				<span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_hdspm_enable_out</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_buffer</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Allocated sample buffer for playback at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdspm_set_sgbuf</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">substream</span><span class="p">,</span> <span class="n">HDSPM_pageAddressBufferIn</span><span class="p">,</span>
				<span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">params_channels</span><span class="p">(</span><span class="n">params</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_hdspm_enable_in</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_buffer</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">;</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Allocated sample buffer for capture at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_buffer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	   snd_printdd(&quot;Allocated sample buffer for %s at 0x%08X\n&quot;,</span>
<span class="cm">	   substream-&gt;stream == SNDRV_PCM_STREAM_PLAYBACK ?</span>
<span class="cm">	   &quot;playback&quot; : &quot;capture&quot;,</span>
<span class="cm">	   snd_pcm_sgbuf_get_addr(substream, 0));</span>
<span class="cm">	   */</span>
	<span class="cm">/*</span>
<span class="cm">	   snd_printdd(&quot;set_hwparams: %s %d Hz, %d channels, bs = %d\n&quot;,</span>
<span class="cm">	   substream-&gt;stream == SNDRV_PCM_STREAM_PLAYBACK ?</span>
<span class="cm">	   &quot;playback&quot; : &quot;capture&quot;,</span>
<span class="cm">	   params_rate(params), params_channels(params),</span>
<span class="cm">	   params_buffer_size(params));</span>
<span class="cm">	   */</span>


	<span class="cm">/* Switch to native float format if requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SNDRV_PCM_FORMAT_FLOAT_LE</span> <span class="o">==</span> <span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPe_FLOAT_FORMAT</span><span class="p">))</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hdspm: Switching to native 32bit LE float format.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSPe_FLOAT_FORMAT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SNDRV_PCM_FORMAT_S32_LE</span> <span class="o">==</span> <span class="n">params_format</span><span class="p">(</span><span class="n">params</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSPe_FLOAT_FORMAT</span><span class="p">)</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;hdspm: Switching to native 32bit LE integer format.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSPe_FLOAT_FORMAT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* params_channels(params) should be enough,</span>
<span class="cm">		   but to get sure in case of error */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_hdspm_enable_out</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">snd_hdspm_enable_in</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">snd_pcm_lib_free_pages</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_channel_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">snd_pcm_channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;snd_hdspm_channel_info: output channel out of range (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;snd_hdspm_channel_info: output channel %d mapped out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">]</span> <span class="o">*</span>
			<span class="n">HDSPM_CHANNEL_BUFFER_BYTES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;snd_hdspm_channel_info: input channel out of range (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;snd_hdspm_channel_info: input channel %d mapped out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">]</span> <span class="o">*</span>
			<span class="n">HDSPM_CHANNEL_BUFFER_BYTES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_IOCTL1_RESET</span>:
		<span class="k">return</span> <span class="n">snd_hdspm_reset</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SNDRV_PCM_IOCTL1_CHANNEL_INFO</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">snd_pcm_channel_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snd_hdspm_channel_info</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">running</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">running</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">running</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span>
					<span class="n">running</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">running</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">_ok</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">running</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">))</span>
					<span class="o">&amp;&amp;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span>
					<span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
				<span class="n">hdspm_silence_playback</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">running</span> <span class="o">&amp;&amp;</span>
				<span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
				<span class="n">hdspm_silence_playback</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
			<span class="n">hdspm_silence_playback</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">_ok:</span>
	<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="n">running</span><span class="p">)</span>
		<span class="n">hdspm_start_audio</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">running</span><span class="p">)</span>
		<span class="n">hdspm_stop_audio</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="n">running</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_hdspm_playback_subinfo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_DOUBLE</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_64000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_88200</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_96000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_176400</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_192000</span> <span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>
	    <span class="n">HDSPM_CHANNEL_BUFFER_BYTES</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_hdspm_capture_subinfo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
		 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span> <span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="p">(</span><span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_64000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_88200</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_96000</span> <span class="o">|</span>
		  <span class="n">SNDRV_PCM_RATE_176400</span> <span class="o">|</span> <span class="n">SNDRV_PCM_RATE_192000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>
	    <span class="n">HDSPM_CHANNEL_BUFFER_BYTES</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span> <span class="mi">512</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_rule_in_channels_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">96000</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">192000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">64000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_rule_out_channels_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span> <span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">96000</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">192000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">64000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_rule_rate_in_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span> <span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_rule_rate_out_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
	    <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_rule_in_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>

	<span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">;</span>
	<span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">;</span>
	<span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hw_rule_out_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>

	<span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">;</span>
	<span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">;</span>
	<span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdspm_aes32_sample_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">32000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">192000</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span>
<span class="n">hdspm_hw_constraints_aes32_sample_rates</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdspm_aes32_sample_rates</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">hdspm_aes32_sample_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>


	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_hdspm_playback_subinfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hdspm_stop_audio</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_pow2</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO</span>:
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span>
					     <span class="mi">32</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="cm">/* RayDAT &amp; AIO have a fixed buffer of 16384 samples per channel */</span>
		<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span>
					     <span class="mi">16384</span><span class="p">,</span> <span class="mi">16384</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span>
					     <span class="mi">64</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AES32</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hdspm_hw_constraints_aes32_sample_rates</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				<span class="n">snd_hdspm_hw_rule_rate_out_channels</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			<span class="n">snd_hdspm_hw_rule_out_channels</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			<span class="n">snd_hdspm_hw_rule_out_channels_rate</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_playback_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_hdspm_capture_subinfo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hdspm_stop_audio</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_pow2</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO</span>:
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span>
					     <span class="mi">32</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_BUFFER_SIZE</span><span class="p">,</span>
					     <span class="mi">16384</span><span class="p">,</span> <span class="mi">16384</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">snd_pcm_hw_constraint_minmax</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
					     <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span>
					     <span class="mi">64</span><span class="p">,</span> <span class="mi">8192</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AES32</span> <span class="o">==</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">|=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hdspm_hw_constraints_aes32_sample_rates</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
				<span class="n">snd_hdspm_hw_rule_rate_in_channels</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
				<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			<span class="n">snd_hdspm_hw_rule_in_channels</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			<span class="n">snd_hdspm_hw_rule_in_channels_rate</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span>
			<span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_capture_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hwdep_dummy_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* we have nothing to initialize but the call is required */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_u32_le</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_hwdep_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_mixer_ioctl</span> <span class="n">mixer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_config</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_version</span> <span class="n">hdspm_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_peak_rms</span> <span class="o">*</span><span class="n">levels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm_ltc</span> <span class="n">ltc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">statusregister</span><span class="p">;</span>
	<span class="kt">long</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">SNDRV_HDSPM_IOCTL_GET_PEAK_RMS</span>:
		<span class="n">levels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">peak_rms</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDSPM_MAX_CHANNELS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">input_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">HDSPM_MADI_INPUT_PEAK</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">playback_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">HDSPM_MADI_PLAYBACK_PEAK</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">output_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">HDSPM_MADI_OUTPUT_PEAK</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>

			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">input_rms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					<span class="n">HDSPM_MADI_INPUT_RMS_H</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">HDSPM_MADI_INPUT_RMS_L</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">playback_rms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					<span class="n">HDSPM_MADI_PLAYBACK_RMS_H</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					<span class="n">HDSPM_MADI_PLAYBACK_RMS_L</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">output_rms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
					<span class="n">HDSPM_MADI_OUTPUT_RMS_H</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span>
						<span class="n">HDSPM_MADI_OUTPUT_RMS_L</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">&gt;</span> <span class="mi">96000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">qs</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">levels</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">ss</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">levels</span><span class="o">-&gt;</span><span class="n">status2</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">);</span>

		<span class="n">s</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_peak_rms</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* snd_printk(KERN_ERR &quot;copy_to_user(.., .., %lu): %lu</span>
<span class="cm">			 [Levels]\n&quot;, sizeof(struct hdspm_peak_rms), s);</span>
<span class="cm">			 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_HDSPM_IOCTL_GET_LTC</span>:
		<span class="n">ltc</span><span class="p">.</span><span class="n">ltc</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_TCO</span><span class="p">);</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_TCO</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_LTC_Input_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSPM_TCO1_LTC_Format_LSB</span> <span class="o">|</span>
				<span class="n">HDSPM_TCO1_LTC_Format_MSB</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">ltc</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">fps_24</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_TCO1_LTC_Format_LSB</span>:
				<span class="n">ltc</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">fps_25</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">HDSPM_TCO1_LTC_Format_MSB</span>:
				<span class="n">ltc</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">fps_2997</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ltc</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_set_drop_frame_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ltc</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">drop_frame</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ltc</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">full_frame</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ltc</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format_invalid</span><span class="p">;</span>
			<span class="n">ltc</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame_invalid</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_Video_Input_Format_NTSC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ltc</span><span class="p">.</span><span class="n">input_format</span> <span class="o">=</span> <span class="n">ntsc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="n">HDSPM_TCO1_Video_Input_Format_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ltc</span><span class="p">.</span><span class="n">input_format</span> <span class="o">=</span> <span class="n">pal</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ltc</span><span class="p">.</span><span class="n">input_format</span> <span class="o">=</span> <span class="n">no_video</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">s</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ltc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_ltc</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 snd_printk(KERN_ERR &quot;copy_to_user(.., .., %lu): %lu [LTC]\n&quot;, sizeof(struct hdspm_ltc), s); */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_HDSPM_IOCTL_GET_CONFIG</span>:

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="n">hdspm_pref_sync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">wordclock_sync_check</span> <span class="o">=</span> <span class="n">hdspm_wc_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="n">info</span><span class="p">.</span><span class="n">system_sample_rate</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">autosync_sample_rate</span> <span class="o">=</span>
			<span class="n">hdspm_external_sample_rate</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">system_clock_mode</span> <span class="o">=</span> <span class="n">hdspm_system_clock_mode</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">clock_source</span> <span class="o">=</span> <span class="n">hdspm_clock_source</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">autosync_ref</span> <span class="o">=</span> <span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">line_out</span> <span class="o">=</span> <span class="n">hdspm_line_out</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">passthru</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_HDSPM_IOCTL_GET_STATUS</span>:
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

		<span class="n">status</span><span class="p">.</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">;</span>

		<span class="n">status</span><span class="p">.</span><span class="n">autosync_source</span> <span class="o">=</span> <span class="n">hdspm_autosync_ref</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

		<span class="n">status</span><span class="p">.</span><span class="n">card_clock</span> <span class="o">=</span> <span class="mi">110069313433624ULL</span><span class="p">;</span>
		<span class="n">status</span><span class="p">.</span><span class="n">master_period</span> <span class="o">=</span> <span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_RD_PLL_FREQ</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MADI</span>:
		<span class="k">case</span> <span class="n">MADIface</span>:
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">sync_wc</span> <span class="o">=</span>
				<span class="n">hdspm_wc_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">sync_madi</span> <span class="o">=</span>
				<span class="n">hdspm_madi_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">sync_tco</span> <span class="o">=</span>
				<span class="n">hdspm_tco_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">sync_in</span> <span class="o">=</span>
				<span class="n">hdspm_sync_in_sync_check</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

			<span class="n">statusregister</span> <span class="o">=</span>
				<span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">madi_input</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">statusregister</span> <span class="o">&amp;</span> <span class="n">HDSPM_AB_int</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">channel_format</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">statusregister</span> <span class="o">&amp;</span> <span class="n">HDSPM_RX_64ch</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* TODO: Mac driver sets it when f_s&gt;48kHz */</span>
			<span class="n">status</span><span class="p">.</span><span class="n">card_specific</span><span class="p">.</span><span class="n">madi</span><span class="p">.</span><span class="n">frame_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>


		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_HDSPM_IOCTL_GET_VERSION</span>:
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm_version</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdspm_version</span><span class="p">));</span>

		<span class="n">hdspm_version</span><span class="p">.</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">hdspm_version</span><span class="p">.</span><span class="n">cardname</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">hdspm_version</span><span class="p">.</span><span class="n">cardname</span><span class="p">));</span>
		<span class="n">hdspm_version</span><span class="p">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
		<span class="n">hdspm_version</span><span class="p">.</span><span class="n">firmware_rev</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">;</span>
		<span class="n">hdspm_version</span><span class="p">.</span><span class="n">addons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span>
			<span class="n">hdspm_version</span><span class="p">.</span><span class="n">addons</span> <span class="o">|=</span> <span class="n">HDSPM_ADDON_TCO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdspm_version</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hdspm_version</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SNDRV_HDSPM_IOCTL_GET_MIXER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mixer</span><span class="p">,</span> <span class="n">argp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mixer</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">mixer</span><span class="p">.</span><span class="n">mixer</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_mixer</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_hdspm_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_hdspm_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_hdspm_playback_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_hdspm_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_hdspm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_hdspm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_hdspm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_hdspm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_hdspm_hw_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_hdspm_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_hdspm_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">snd_hdspm_capture_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_hdspm_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">snd_hdspm_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span> <span class="n">snd_hdspm_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">snd_hdspm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">snd_hdspm_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">snd_hdspm_hw_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">snd_pcm_sgbuf_ops_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_create_hwdep</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hwdep_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;HDSPM hwdep&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">hwdep</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hdspm</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;HDSPM hwdep interface&quot;</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">snd_hdspm_hwdep_dummy_op</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_hdspm_hwdep_ioctl</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl_compat</span> <span class="o">=</span> <span class="n">snd_hdspm_hwdep_ioctl</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">snd_hdspm_hwdep_dummy_op</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   memory interface</span>
<span class="cm"> ------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_preallocate_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">wanted</span><span class="p">;</span>

	<span class="n">pcm</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">;</span>

	<span class="n">wanted</span> <span class="o">=</span> <span class="n">HDSPM_DMA_AREA_BYTES</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span>
	     <span class="n">snd_pcm_lib_preallocate_pages_for_all</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span>
						   <span class="n">SNDRV_DMA_TYPE_DEV_SG</span><span class="p">,</span>
						   <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">),</span>
						   <span class="n">wanted</span><span class="p">,</span>
						   <span class="n">wanted</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Could not preallocate %zd Bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wanted</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot; Preallocated %zd Bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wanted</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdspm_set_sgbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channels</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* continuous memory segment */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">channels</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">snd_pcm_sgbuf_get_addr</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/* ------------- ALSA Devices ---------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hdspm</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_hdspm_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">snd_hdspm_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_preallocate_memory</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">snd_hdspm_initialize_midi_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">snd_hdspm_flush_midi_input</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_create_alsa_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Create card...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_create_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_create_midi</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_create_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_create_hwdep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;proc init...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">snd_hdspm_proc_init</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">last_external_sample_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">last_internal_sample_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Set defaults...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_set_defaults</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Update mixer controls...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hdspm_update_simple_mixer_controls</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;Initializeing complete ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HDSPM: error registering card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;... yes now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_extent</span><span class="p">;</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>
			<span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;Xilinx FPGA&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;HDSPM&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSPM_RAYDAT_REV</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">RayDAT</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME RayDAT&quot;</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_AIO_REV</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">AIO</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME AIO&quot;</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSPM_MADIFACE_REV</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">MADIface</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME MADIface&quot;</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">==</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&gt;=</span> <span class="mh">0xe6</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&lt;=</span> <span class="mh">0xea</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">AES32</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME AES32&quot;</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">==</span> <span class="mh">0xd2</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&gt;=</span> <span class="mh">0xc8</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&lt;=</span> <span class="mh">0xcf</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">MADI</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME MADI&quot;</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;HDSPM: unknown firmware revision %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;hdspm&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">io_extent</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;grabbed memory region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">io_extent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">io_extent</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HDSPM: &quot;</span>
				<span class="s">&quot;unable to remap region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">io_extent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;remapped region (0x%lx) 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">io_extent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_hdspm_interrupt</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HDSPM: unable to use IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;use IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;kmalloc Mixer memory of %zd Bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_mixer</span><span class="p">));</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_mixer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;HDSPM: &quot;</span>
				<span class="s">&quot;unable to kmalloc Mixer memory of %d Bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_mixer</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">AES32_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">AES32_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span> <span class="o">=</span> <span class="n">AES32_CHANNELS</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ss</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ss</span> <span class="o">=</span>
			<span class="n">channel_map_aes32</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ds</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ds</span> <span class="o">=</span>
			<span class="n">channel_map_aes32</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_qs</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_qs</span> <span class="o">=</span>
			<span class="n">channel_map_aes32</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ss</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ss</span> <span class="o">=</span>
			<span class="n">texts_ports_aes32</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ds</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ds</span> <span class="o">=</span>
			<span class="n">texts_ports_aes32</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_qs</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_qs</span> <span class="o">=</span>
			<span class="n">texts_ports_aes32</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span> <span class="o">=</span>
			<span class="n">AES32_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out</span> <span class="o">=</span>
			<span class="n">texts_ports_aes32</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span> <span class="o">=</span>
			<span class="n">channel_map_aes32</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
	<span class="k">case</span> <span class="n">MADIface</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span>
			<span class="n">MADI_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span>
			<span class="n">MADI_DS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span> <span class="o">=</span>
			<span class="n">MADI_QS_CHANNELS</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ss</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ss</span> <span class="o">=</span>
			<span class="n">channel_map_unity_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ds</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ds</span> <span class="o">=</span>
			<span class="n">channel_map_unity_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_qs</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_qs</span> <span class="o">=</span>
			<span class="n">channel_map_unity_ss</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ss</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ss</span> <span class="o">=</span>
			<span class="n">texts_ports_madi</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ds</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ds</span> <span class="o">=</span>
			<span class="n">texts_ports_madi</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_qs</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_qs</span> <span class="o">=</span>
			<span class="n">texts_ports_madi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSPM_s2_AEBI_D</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HDSPM: AEB input board found, but not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">AIO_IN_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">AIO_IN_DS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span> <span class="o">=</span> <span class="n">AIO_IN_QS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">AIO_OUT_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">AIO_OUT_DS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span> <span class="o">=</span> <span class="n">AIO_OUT_QS_CHANNELS</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ss</span> <span class="o">=</span> <span class="n">channel_map_aio_out_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ds</span> <span class="o">=</span> <span class="n">channel_map_aio_out_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_qs</span> <span class="o">=</span> <span class="n">channel_map_aio_out_qs</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ss</span> <span class="o">=</span> <span class="n">channel_map_aio_in_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ds</span> <span class="o">=</span> <span class="n">channel_map_aio_in_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_qs</span> <span class="o">=</span> <span class="n">channel_map_aio_in_qs</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ss</span> <span class="o">=</span> <span class="n">texts_ports_aio_in_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ss</span> <span class="o">=</span> <span class="n">texts_ports_aio_out_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ds</span> <span class="o">=</span> <span class="n">texts_ports_aio_in_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ds</span> <span class="o">=</span> <span class="n">texts_ports_aio_out_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_qs</span> <span class="o">=</span> <span class="n">texts_ports_aio_in_qs</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_qs</span> <span class="o">=</span> <span class="n">texts_ports_aio_out_qs</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span>
			<span class="n">RAYDAT_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span>
			<span class="n">RAYDAT_DS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span> <span class="o">=</span>
			<span class="n">RAYDAT_QS_CHANNELS</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_in</span> <span class="o">=</span> <span class="n">RAYDAT_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">max_channels_out</span> <span class="o">=</span> <span class="n">RAYDAT_SS_CHANNELS</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ss</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ss</span> <span class="o">=</span>
			<span class="n">channel_map_raydat_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_ds</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_ds</span> <span class="o">=</span>
			<span class="n">channel_map_raydat_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in_qs</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out_qs</span> <span class="o">=</span>
			<span class="n">channel_map_raydat_qs</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_in</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">channel_map_out</span> <span class="o">=</span>
			<span class="n">channel_map_raydat_ss</span><span class="p">;</span>

		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ss</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ss</span> <span class="o">=</span>
			<span class="n">texts_ports_raydat_ss</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_ds</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_ds</span> <span class="o">=</span>
			<span class="n">texts_ports_raydat_ds</span><span class="p">;</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_in_qs</span> <span class="o">=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port_names_out_qs</span> <span class="o">=</span>
			<span class="n">texts_ports_raydat_qs</span><span class="p">;</span>


		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* TCO detection */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AIO</span>:
	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister2</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="n">HDSPM_s2_tco_detect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_tco</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HDSPM: AIO/RayDAT TCO module found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSPM_tco_detect</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midiPorts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm_tco</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdspm_tco_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;HDSPM: MADI TCO module found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* texts */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AES32</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_aes_tco</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_aes</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADI</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_madi_tco</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_madi</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MADIface</span>:

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RayDAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_raydat_tco</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_raydat</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">tco</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_aio_tco</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync</span> <span class="o">=</span> <span class="n">texts_autosync_aio</span><span class="p">;</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">texts_autosync_items</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">midi_tasklet</span><span class="p">,</span>
			<span class="n">hdspm_midi_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hdspm</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">MADIface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdspm_read</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span>
				<span class="n">HDSPM_midiStatusIn0</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span><span class="p">;</span>
		<span class="cm">/* id contains either a user-provided value or the default</span>
<span class="cm">		 * NULL. If it&#39;s the default, we&#39;re safe to</span>
<span class="cm">		 * fill card-&gt;id with the serial number.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the serial number is 0xFFFFFF, then we&#39;re dealing with</span>
<span class="cm">		 * an old PCI revision that comes without a sane number. In</span>
<span class="cm">		 * this case, we don&#39;t set card-&gt;id to avoid collisions</span>
<span class="cm">		 * when running with multiple cards.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">id</span><span class="p">[</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span> <span class="o">!=</span> <span class="mh">0xFFFFFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;HDSPMx%06x&quot;</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
			<span class="n">snd_card_set_id</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_printdd</span><span class="p">(</span><span class="s">&quot;create alsa devices.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_create_alsa_devices</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_hdspm_initialize_midi_flush</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdspm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span> <span class="n">hdspm</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* stop th audio, and cancel all interrupts */</span>
		<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">HDSPM_Start</span> <span class="o">|</span> <span class="n">HDSPM_AudioInterruptEnable</span> <span class="o">|</span>
		      <span class="n">HDSPM_Midi0InterruptEnable</span> <span class="o">|</span> <span class="n">HDSPM_Midi1InterruptEnable</span> <span class="o">|</span>
		      <span class="n">HDSPM_Midi2InterruptEnable</span> <span class="o">|</span> <span class="n">HDSPM_Midi3InterruptEnable</span><span class="p">);</span>
		<span class="n">hdspm_write</span><span class="p">(</span><span class="n">hdspm</span><span class="p">,</span> <span class="n">HDSPM_controlRegister</span><span class="p">,</span>
			    <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdspm</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">mixer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdspm_card_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="p">)</span>
		<span class="n">snd_hdspm_free</span><span class="p">(</span><span class="n">hdspm</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdspm_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdspm</span> <span class="o">*</span><span class="n">hdspm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span>
			<span class="n">THIS_MODULE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdspm</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdspm</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_hdspm_card_free</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdspm_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdspm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">MADIface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;%s_%x&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s S/N 0x%x at 0x%lx, irq %d&quot;</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
			<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span>
				<span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdspm</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_hdspm_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hdspm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_hdspm_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">snd_hdspm_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_hdspm_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">hdspm_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
