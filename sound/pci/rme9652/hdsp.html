<!DOCTYPE html>
<html><head><title>joekychen/linux » sound › pci › rme9652 › hdsp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hdsp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   ALSA driver for RME Hammerfall DSP audio interface(s)</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (c) 2002  Paul Davis</span>
<span class="cm"> *                          Marcus Andersson</span>
<span class="cm"> *                          Thomas Charbonnel</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *   (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/math64.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/info.h&gt;</span>
<span class="cp">#include &lt;sound/asoundef.h&gt;</span>
<span class="cp">#include &lt;sound/rawmidi.h&gt;</span>
<span class="cp">#include &lt;sound/hwdep.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;sound/hdsp.h&gt;</span>

<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/current.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE_PNP</span><span class="p">;</span>	<span class="cm">/* Enable this card */</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for RME Hammerfall DSP interface.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ID string for RME Hammerfall DSP interface.&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable/disable specific Hammerfall DSP soundcards.&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Paul Davis &lt;paul@linuxaudiosystems.com&gt;, Marcus Andersson, Thomas Charbonnel &lt;thomas@undata.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;RME Hammerfall DSP&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;{{RME Hammerfall-DSP},&quot;</span>
	        <span class="s">&quot;{RME HDSP-9652},&quot;</span>
		<span class="s">&quot;{RME HDSP-9632}}&quot;</span><span class="p">);</span>
<span class="cp">#ifdef HDSP_FW_LOADER</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;rpm_firmware.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;multiface_firmware.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;multiface_firmware_rev11.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;digiface_firmware.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;digiface_firmware_rev11.bin&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#define HDSP_MAX_CHANNELS        26</span>
<span class="cp">#define HDSP_MAX_DS_CHANNELS     14</span>
<span class="cp">#define HDSP_MAX_QS_CHANNELS     8</span>
<span class="cp">#define DIGIFACE_SS_CHANNELS     26</span>
<span class="cp">#define DIGIFACE_DS_CHANNELS     14</span>
<span class="cp">#define MULTIFACE_SS_CHANNELS    18</span>
<span class="cp">#define MULTIFACE_DS_CHANNELS    14</span>
<span class="cp">#define H9652_SS_CHANNELS        26</span>
<span class="cp">#define H9652_DS_CHANNELS        14</span>
<span class="cm">/* This does not include possible Analog Extension Boards</span>
<span class="cm">   AEBs are detected at card initialization</span>
<span class="cm">*/</span>
<span class="cp">#define H9632_SS_CHANNELS	 12</span>
<span class="cp">#define H9632_DS_CHANNELS	 8</span>
<span class="cp">#define H9632_QS_CHANNELS	 4</span>
<span class="cp">#define RPM_CHANNELS             6</span>

<span class="cm">/* Write registers. These are defined as byte-offsets from the iobase value.</span>
<span class="cm"> */</span>
<span class="cp">#define HDSP_resetPointer               0</span>
<span class="cp">#define HDSP_freqReg			0</span>
<span class="cp">#define HDSP_outputBufferAddress	32</span>
<span class="cp">#define HDSP_inputBufferAddress		36</span>
<span class="cp">#define HDSP_controlRegister		64</span>
<span class="cp">#define HDSP_interruptConfirmation	96</span>
<span class="cp">#define HDSP_outputEnable	  	128</span>
<span class="cp">#define HDSP_control2Reg		256</span>
<span class="cp">#define HDSP_midiDataOut0  		352</span>
<span class="cp">#define HDSP_midiDataOut1  		356</span>
<span class="cp">#define HDSP_fifoData  			368</span>
<span class="cp">#define HDSP_inputEnable	 	384</span>

<span class="cm">/* Read registers. These are defined as byte-offsets from the iobase value</span>
<span class="cm"> */</span>

<span class="cp">#define HDSP_statusRegister    0</span>
<span class="cp">#define HDSP_timecode        128</span>
<span class="cp">#define HDSP_status2Register 192</span>
<span class="cp">#define HDSP_midiDataIn0     360</span>
<span class="cp">#define HDSP_midiDataIn1     364</span>
<span class="cp">#define HDSP_midiStatusOut0  384</span>
<span class="cp">#define HDSP_midiStatusOut1  388</span>
<span class="cp">#define HDSP_midiStatusIn0   392</span>
<span class="cp">#define HDSP_midiStatusIn1   396</span>
<span class="cp">#define HDSP_fifoStatus      400</span>

<span class="cm">/* the meters are regular i/o-mapped registers, but offset</span>
<span class="cm">   considerably from the rest. the peak registers are reset</span>
<span class="cm">   when read; the least-significant 4 bits are full-scale counters;</span>
<span class="cm">   the actual peak value is in the most-significant 24 bits.</span>
<span class="cm">*/</span>

<span class="cp">#define HDSP_playbackPeakLevel  4096  </span><span class="cm">/* 26 * 32 bit values */</span><span class="cp"></span>
<span class="cp">#define HDSP_inputPeakLevel     4224  </span><span class="cm">/* 26 * 32 bit values */</span><span class="cp"></span>
<span class="cp">#define HDSP_outputPeakLevel    4352  </span><span class="cm">/* (26+2) * 32 bit values */</span><span class="cp"></span>
<span class="cp">#define HDSP_playbackRmsLevel   4612  </span><span class="cm">/* 26 * 64 bit values */</span><span class="cp"></span>
<span class="cp">#define HDSP_inputRmsLevel      4868  </span><span class="cm">/* 26 * 64 bit values */</span><span class="cp"></span>


<span class="cm">/* This is for H9652 cards</span>
<span class="cm">   Peak values are read downward from the base</span>
<span class="cm">   Rms values are read upward</span>
<span class="cm">   There are rms values for the outputs too</span>
<span class="cm">   26*3 values are read in ss mode</span>
<span class="cm">   14*3 in ds mode, with no gap between values</span>
<span class="cm">*/</span>
<span class="cp">#define HDSP_9652_peakBase	7164</span>
<span class="cp">#define HDSP_9652_rmsBase	4096</span>

<span class="cm">/* c.f. the hdsp_9632_meters_t struct */</span>
<span class="cp">#define HDSP_9632_metersBase	4096</span>

<span class="cp">#define HDSP_IO_EXTENT     7168</span>

<span class="cm">/* control2 register bits */</span>

<span class="cp">#define HDSP_TMS                0x01</span>
<span class="cp">#define HDSP_TCK                0x02</span>
<span class="cp">#define HDSP_TDI                0x04</span>
<span class="cp">#define HDSP_JTAG               0x08</span>
<span class="cp">#define HDSP_PWDN               0x10</span>
<span class="cp">#define HDSP_PROGRAM	        0x020</span>
<span class="cp">#define HDSP_CONFIG_MODE_0	0x040</span>
<span class="cp">#define HDSP_CONFIG_MODE_1	0x080</span>
<span class="cp">#define HDSP_VERSION_BIT	(0x100 | HDSP_S_LOAD)</span>
<span class="cp">#define HDSP_BIGENDIAN_MODE     0x200</span>
<span class="cp">#define HDSP_RD_MULTIPLE        0x400</span>
<span class="cp">#define HDSP_9652_ENABLE_MIXER  0x800</span>
<span class="cp">#define HDSP_TDO                0x10000000</span>

<span class="cp">#define HDSP_S_PROGRAM     	(HDSP_PROGRAM|HDSP_CONFIG_MODE_0)</span>
<span class="cp">#define HDSP_S_LOAD		(HDSP_PROGRAM|HDSP_CONFIG_MODE_1)</span>

<span class="cm">/* Control Register bits */</span>

<span class="cp">#define HDSP_Start                (1&lt;&lt;0)  </span><span class="cm">/* start engine */</span><span class="cp"></span>
<span class="cp">#define HDSP_Latency0             (1&lt;&lt;1)  </span><span class="cm">/* buffer size = 2^n where n is defined by Latency{2,1,0} */</span><span class="cp"></span>
<span class="cp">#define HDSP_Latency1             (1&lt;&lt;2)  </span><span class="cm">/* [ see above ] */</span><span class="cp"></span>
<span class="cp">#define HDSP_Latency2             (1&lt;&lt;3)  </span><span class="cm">/* [ see above ] */</span><span class="cp"></span>
<span class="cp">#define HDSP_ClockModeMaster      (1&lt;&lt;4)  </span><span class="cm">/* 1=Master, 0=Slave/Autosync */</span><span class="cp"></span>
<span class="cp">#define HDSP_AudioInterruptEnable (1&lt;&lt;5)  </span><span class="cm">/* what do you think ? */</span><span class="cp"></span>
<span class="cp">#define HDSP_Frequency0           (1&lt;&lt;6)  </span><span class="cm">/* 0=44.1kHz/88.2kHz/176.4kHz 1=48kHz/96kHz/192kHz */</span><span class="cp"></span>
<span class="cp">#define HDSP_Frequency1           (1&lt;&lt;7)  </span><span class="cm">/* 0=32kHz/64kHz/128kHz */</span><span class="cp"></span>
<span class="cp">#define HDSP_DoubleSpeed          (1&lt;&lt;8)  </span><span class="cm">/* 0=normal speed, 1=double speed */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFProfessional    (1&lt;&lt;9)  </span><span class="cm">/* 0=consumer, 1=professional */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFEmphasis        (1&lt;&lt;10) </span><span class="cm">/* 0=none, 1=on */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFNonAudio        (1&lt;&lt;11) </span><span class="cm">/* 0=off, 1=on */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFOpticalOut      (1&lt;&lt;12) </span><span class="cm">/* 1=use 1st ADAT connector for SPDIF, 0=do not */</span><span class="cp"></span>
<span class="cp">#define HDSP_SyncRef2             (1&lt;&lt;13)</span>
<span class="cp">#define HDSP_SPDIFInputSelect0    (1&lt;&lt;14)</span>
<span class="cp">#define HDSP_SPDIFInputSelect1    (1&lt;&lt;15)</span>
<span class="cp">#define HDSP_SyncRef0             (1&lt;&lt;16)</span>
<span class="cp">#define HDSP_SyncRef1             (1&lt;&lt;17)</span>
<span class="cp">#define HDSP_AnalogExtensionBoard (1&lt;&lt;18) </span><span class="cm">/* For H9632 cards */</span><span class="cp"></span>
<span class="cp">#define HDSP_XLRBreakoutCable     (1&lt;&lt;20) </span><span class="cm">/* For H9632 cards */</span><span class="cp"></span>
<span class="cp">#define HDSP_Midi0InterruptEnable (1&lt;&lt;22)</span>
<span class="cp">#define HDSP_Midi1InterruptEnable (1&lt;&lt;23)</span>
<span class="cp">#define HDSP_LineOut              (1&lt;&lt;24)</span>
<span class="cp">#define HDSP_ADGain0		  (1&lt;&lt;25) </span><span class="cm">/* From here : H9632 specific */</span><span class="cp"></span>
<span class="cp">#define HDSP_ADGain1		  (1&lt;&lt;26)</span>
<span class="cp">#define HDSP_DAGain0		  (1&lt;&lt;27)</span>
<span class="cp">#define HDSP_DAGain1		  (1&lt;&lt;28)</span>
<span class="cp">#define HDSP_PhoneGain0		  (1&lt;&lt;29)</span>
<span class="cp">#define HDSP_PhoneGain1		  (1&lt;&lt;30)</span>
<span class="cp">#define HDSP_QuadSpeed	  	  (1&lt;&lt;31)</span>

<span class="cm">/* RPM uses some of the registers for special purposes */</span>
<span class="cp">#define HDSP_RPM_Inp12            0x04A00</span>
<span class="cp">#define HDSP_RPM_Inp12_Phon_6dB   0x00800  </span><span class="cm">/* Dolby */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp12_Phon_0dB   0x00000  </span><span class="cm">/* .. */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp12_Phon_n6dB  0x04000  </span><span class="cm">/* inp_0 */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp12_Line_0dB   0x04200  </span><span class="cm">/* Dolby+PRO */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp12_Line_n6dB  0x00200  </span><span class="cm">/* PRO */</span><span class="cp"></span>

<span class="cp">#define HDSP_RPM_Inp34            0x32000</span>
<span class="cp">#define HDSP_RPM_Inp34_Phon_6dB   0x20000  </span><span class="cm">/* SyncRef1 */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp34_Phon_0dB   0x00000  </span><span class="cm">/* .. */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp34_Phon_n6dB  0x02000  </span><span class="cm">/* SyncRef2 */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp34_Line_0dB   0x30000  </span><span class="cm">/* SyncRef1+SyncRef0 */</span><span class="cp"></span>
<span class="cp">#define HDSP_RPM_Inp34_Line_n6dB  0x10000  </span><span class="cm">/* SyncRef0 */</span><span class="cp"></span>

<span class="cp">#define HDSP_RPM_Bypass           0x01000</span>

<span class="cp">#define HDSP_RPM_Disconnect       0x00001</span>

<span class="cp">#define HDSP_ADGainMask       (HDSP_ADGain0|HDSP_ADGain1)</span>
<span class="cp">#define HDSP_ADGainMinus10dBV  HDSP_ADGainMask</span>
<span class="cp">#define HDSP_ADGainPlus4dBu   (HDSP_ADGain0)</span>
<span class="cp">#define HDSP_ADGainLowGain     0</span>

<span class="cp">#define HDSP_DAGainMask         (HDSP_DAGain0|HDSP_DAGain1)</span>
<span class="cp">#define HDSP_DAGainHighGain      HDSP_DAGainMask</span>
<span class="cp">#define HDSP_DAGainPlus4dBu     (HDSP_DAGain0)</span>
<span class="cp">#define HDSP_DAGainMinus10dBV    0</span>

<span class="cp">#define HDSP_PhoneGainMask      (HDSP_PhoneGain0|HDSP_PhoneGain1)</span>
<span class="cp">#define HDSP_PhoneGain0dB        HDSP_PhoneGainMask</span>
<span class="cp">#define HDSP_PhoneGainMinus6dB  (HDSP_PhoneGain0)</span>
<span class="cp">#define HDSP_PhoneGainMinus12dB  0</span>

<span class="cp">#define HDSP_LatencyMask    (HDSP_Latency0|HDSP_Latency1|HDSP_Latency2)</span>
<span class="cp">#define HDSP_FrequencyMask  (HDSP_Frequency0|HDSP_Frequency1|HDSP_DoubleSpeed|HDSP_QuadSpeed)</span>

<span class="cp">#define HDSP_SPDIFInputMask    (HDSP_SPDIFInputSelect0|HDSP_SPDIFInputSelect1)</span>
<span class="cp">#define HDSP_SPDIFInputADAT1    0</span>
<span class="cp">#define HDSP_SPDIFInputCoaxial (HDSP_SPDIFInputSelect0)</span>
<span class="cp">#define HDSP_SPDIFInputCdrom   (HDSP_SPDIFInputSelect1)</span>
<span class="cp">#define HDSP_SPDIFInputAES     (HDSP_SPDIFInputSelect0|HDSP_SPDIFInputSelect1)</span>

<span class="cp">#define HDSP_SyncRefMask        (HDSP_SyncRef0|HDSP_SyncRef1|HDSP_SyncRef2)</span>
<span class="cp">#define HDSP_SyncRef_ADAT1       0</span>
<span class="cp">#define HDSP_SyncRef_ADAT2      (HDSP_SyncRef0)</span>
<span class="cp">#define HDSP_SyncRef_ADAT3      (HDSP_SyncRef1)</span>
<span class="cp">#define HDSP_SyncRef_SPDIF      (HDSP_SyncRef0|HDSP_SyncRef1)</span>
<span class="cp">#define HDSP_SyncRef_WORD       (HDSP_SyncRef2)</span>
<span class="cp">#define HDSP_SyncRef_ADAT_SYNC  (HDSP_SyncRef0|HDSP_SyncRef2)</span>

<span class="cm">/* Sample Clock Sources */</span>

<span class="cp">#define HDSP_CLOCK_SOURCE_AUTOSYNC           0</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_32KHZ     1</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_44_1KHZ   2</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_48KHZ     3</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_64KHZ     4</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_88_2KHZ   5</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_96KHZ     6</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_128KHZ    7</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_176_4KHZ  8</span>
<span class="cp">#define HDSP_CLOCK_SOURCE_INTERNAL_192KHZ    9</span>

<span class="cm">/* Preferred sync reference choices - used by &quot;pref_sync_ref&quot; control switch */</span>

<span class="cp">#define HDSP_SYNC_FROM_WORD      0</span>
<span class="cp">#define HDSP_SYNC_FROM_SPDIF     1</span>
<span class="cp">#define HDSP_SYNC_FROM_ADAT1     2</span>
<span class="cp">#define HDSP_SYNC_FROM_ADAT_SYNC 3</span>
<span class="cp">#define HDSP_SYNC_FROM_ADAT2     4</span>
<span class="cp">#define HDSP_SYNC_FROM_ADAT3     5</span>

<span class="cm">/* SyncCheck status */</span>

<span class="cp">#define HDSP_SYNC_CHECK_NO_LOCK 0</span>
<span class="cp">#define HDSP_SYNC_CHECK_LOCK    1</span>
<span class="cp">#define HDSP_SYNC_CHECK_SYNC	2</span>

<span class="cm">/* AutoSync references - used by &quot;autosync_ref&quot; control switch */</span>

<span class="cp">#define HDSP_AUTOSYNC_FROM_WORD      0</span>
<span class="cp">#define HDSP_AUTOSYNC_FROM_ADAT_SYNC 1</span>
<span class="cp">#define HDSP_AUTOSYNC_FROM_SPDIF     2</span>
<span class="cp">#define HDSP_AUTOSYNC_FROM_NONE	     3</span>
<span class="cp">#define HDSP_AUTOSYNC_FROM_ADAT1     4</span>
<span class="cp">#define HDSP_AUTOSYNC_FROM_ADAT2     5</span>
<span class="cp">#define HDSP_AUTOSYNC_FROM_ADAT3     6</span>

<span class="cm">/* Possible sources of S/PDIF input */</span>

<span class="cp">#define HDSP_SPDIFIN_OPTICAL  0	</span><span class="cm">/* optical  (ADAT1) */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFIN_COAXIAL  1	</span><span class="cm">/* coaxial (RCA) */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFIN_INTERNAL 2	</span><span class="cm">/* internal (CDROM) */</span><span class="cp"></span>
<span class="cp">#define HDSP_SPDIFIN_AES      3 </span><span class="cm">/* xlr for H9632 (AES)*/</span><span class="cp"></span>

<span class="cp">#define HDSP_Frequency32KHz    HDSP_Frequency0</span>
<span class="cp">#define HDSP_Frequency44_1KHz  HDSP_Frequency1</span>
<span class="cp">#define HDSP_Frequency48KHz    (HDSP_Frequency1|HDSP_Frequency0)</span>
<span class="cp">#define HDSP_Frequency64KHz    (HDSP_DoubleSpeed|HDSP_Frequency0)</span>
<span class="cp">#define HDSP_Frequency88_2KHz  (HDSP_DoubleSpeed|HDSP_Frequency1)</span>
<span class="cp">#define HDSP_Frequency96KHz    (HDSP_DoubleSpeed|HDSP_Frequency1|HDSP_Frequency0)</span>
<span class="cm">/* For H9632 cards */</span>
<span class="cp">#define HDSP_Frequency128KHz   (HDSP_QuadSpeed|HDSP_DoubleSpeed|HDSP_Frequency0)</span>
<span class="cp">#define HDSP_Frequency176_4KHz (HDSP_QuadSpeed|HDSP_DoubleSpeed|HDSP_Frequency1)</span>
<span class="cp">#define HDSP_Frequency192KHz   (HDSP_QuadSpeed|HDSP_DoubleSpeed|HDSP_Frequency1|HDSP_Frequency0)</span>
<span class="cm">/* RME says n = 104857600000000, but in the windows MADI driver, I see:</span>
<span class="cm">	return 104857600000000 / rate; // 100 MHz</span>
<span class="cm">	return 110100480000000 / rate; // 105 MHz</span>
<span class="cm">*/</span>
<span class="cp">#define DDS_NUMERATOR 104857600000000ULL;  </span><span class="cm">/*  =  2^20 * 10^8 */</span><span class="cp"></span>

<span class="cp">#define hdsp_encode_latency(x)       (((x)&lt;&lt;1) &amp; HDSP_LatencyMask)</span>
<span class="cp">#define hdsp_decode_latency(x)       (((x) &amp; HDSP_LatencyMask)&gt;&gt;1)</span>

<span class="cp">#define hdsp_encode_spdif_in(x) (((x)&amp;0x3)&lt;&lt;14)</span>
<span class="cp">#define hdsp_decode_spdif_in(x) (((x)&gt;&gt;14)&amp;0x3)</span>

<span class="cm">/* Status Register bits */</span>

<span class="cp">#define HDSP_audioIRQPending    (1&lt;&lt;0)</span>
<span class="cp">#define HDSP_Lock2              (1&lt;&lt;1)     </span><span class="cm">/* this is for Digiface and H9652 */</span><span class="cp"></span>
<span class="cp">#define HDSP_spdifFrequency3	HDSP_Lock2 </span><span class="cm">/* this is for H9632 only */</span><span class="cp"></span>
<span class="cp">#define HDSP_Lock1              (1&lt;&lt;2)</span>
<span class="cp">#define HDSP_Lock0              (1&lt;&lt;3)</span>
<span class="cp">#define HDSP_SPDIFSync          (1&lt;&lt;4)</span>
<span class="cp">#define HDSP_TimecodeLock       (1&lt;&lt;5)</span>
<span class="cp">#define HDSP_BufferPositionMask 0x000FFC0 </span><span class="cm">/* Bit 6..15 : h/w buffer pointer */</span><span class="cp"></span>
<span class="cp">#define HDSP_Sync2              (1&lt;&lt;16)</span>
<span class="cp">#define HDSP_Sync1              (1&lt;&lt;17)</span>
<span class="cp">#define HDSP_Sync0              (1&lt;&lt;18)</span>
<span class="cp">#define HDSP_DoubleSpeedStatus  (1&lt;&lt;19)</span>
<span class="cp">#define HDSP_ConfigError        (1&lt;&lt;20)</span>
<span class="cp">#define HDSP_DllError           (1&lt;&lt;21)</span>
<span class="cp">#define HDSP_spdifFrequency0    (1&lt;&lt;22)</span>
<span class="cp">#define HDSP_spdifFrequency1    (1&lt;&lt;23)</span>
<span class="cp">#define HDSP_spdifFrequency2    (1&lt;&lt;24)</span>
<span class="cp">#define HDSP_SPDIFErrorFlag     (1&lt;&lt;25)</span>
<span class="cp">#define HDSP_BufferID           (1&lt;&lt;26)</span>
<span class="cp">#define HDSP_TimecodeSync       (1&lt;&lt;27)</span>
<span class="cp">#define HDSP_AEBO          	(1&lt;&lt;28) </span><span class="cm">/* H9632 specific Analog Extension Boards */</span><span class="cp"></span>
<span class="cp">#define HDSP_AEBI		(1&lt;&lt;29) </span><span class="cm">/* 0 = present, 1 = absent */</span><span class="cp"></span>
<span class="cp">#define HDSP_midi0IRQPending    (1&lt;&lt;30)</span>
<span class="cp">#define HDSP_midi1IRQPending    (1&lt;&lt;31)</span>

<span class="cp">#define HDSP_spdifFrequencyMask    (HDSP_spdifFrequency0|HDSP_spdifFrequency1|HDSP_spdifFrequency2)</span>
<span class="cp">#define HDSP_spdifFrequencyMask_9632 (HDSP_spdifFrequency0|\</span>
<span class="cp">				      HDSP_spdifFrequency1|\</span>
<span class="cp">				      HDSP_spdifFrequency2|\</span>
<span class="cp">				      HDSP_spdifFrequency3)</span>

<span class="cp">#define HDSP_spdifFrequency32KHz   (HDSP_spdifFrequency0)</span>
<span class="cp">#define HDSP_spdifFrequency44_1KHz (HDSP_spdifFrequency1)</span>
<span class="cp">#define HDSP_spdifFrequency48KHz   (HDSP_spdifFrequency0|HDSP_spdifFrequency1)</span>

<span class="cp">#define HDSP_spdifFrequency64KHz   (HDSP_spdifFrequency2)</span>
<span class="cp">#define HDSP_spdifFrequency88_2KHz (HDSP_spdifFrequency0|HDSP_spdifFrequency2)</span>
<span class="cp">#define HDSP_spdifFrequency96KHz   (HDSP_spdifFrequency2|HDSP_spdifFrequency1)</span>

<span class="cm">/* This is for H9632 cards */</span>
<span class="cp">#define HDSP_spdifFrequency128KHz   (HDSP_spdifFrequency0|\</span>
<span class="cp">				     HDSP_spdifFrequency1|\</span>
<span class="cp">				     HDSP_spdifFrequency2)</span>
<span class="cp">#define HDSP_spdifFrequency176_4KHz HDSP_spdifFrequency3</span>
<span class="cp">#define HDSP_spdifFrequency192KHz   (HDSP_spdifFrequency3|HDSP_spdifFrequency0)</span>

<span class="cm">/* Status2 Register bits */</span>

<span class="cp">#define HDSP_version0     (1&lt;&lt;0)</span>
<span class="cp">#define HDSP_version1     (1&lt;&lt;1)</span>
<span class="cp">#define HDSP_version2     (1&lt;&lt;2)</span>
<span class="cp">#define HDSP_wc_lock      (1&lt;&lt;3)</span>
<span class="cp">#define HDSP_wc_sync      (1&lt;&lt;4)</span>
<span class="cp">#define HDSP_inp_freq0    (1&lt;&lt;5)</span>
<span class="cp">#define HDSP_inp_freq1    (1&lt;&lt;6)</span>
<span class="cp">#define HDSP_inp_freq2    (1&lt;&lt;7)</span>
<span class="cp">#define HDSP_SelSyncRef0  (1&lt;&lt;8)</span>
<span class="cp">#define HDSP_SelSyncRef1  (1&lt;&lt;9)</span>
<span class="cp">#define HDSP_SelSyncRef2  (1&lt;&lt;10)</span>

<span class="cp">#define HDSP_wc_valid (HDSP_wc_lock|HDSP_wc_sync)</span>

<span class="cp">#define HDSP_systemFrequencyMask (HDSP_inp_freq0|HDSP_inp_freq1|HDSP_inp_freq2)</span>
<span class="cp">#define HDSP_systemFrequency32   (HDSP_inp_freq0)</span>
<span class="cp">#define HDSP_systemFrequency44_1 (HDSP_inp_freq1)</span>
<span class="cp">#define HDSP_systemFrequency48   (HDSP_inp_freq0|HDSP_inp_freq1)</span>
<span class="cp">#define HDSP_systemFrequency64   (HDSP_inp_freq2)</span>
<span class="cp">#define HDSP_systemFrequency88_2 (HDSP_inp_freq0|HDSP_inp_freq2)</span>
<span class="cp">#define HDSP_systemFrequency96   (HDSP_inp_freq1|HDSP_inp_freq2)</span>
<span class="cm">/* FIXME : more values for 9632 cards ? */</span>

<span class="cp">#define HDSP_SelSyncRefMask        (HDSP_SelSyncRef0|HDSP_SelSyncRef1|HDSP_SelSyncRef2)</span>
<span class="cp">#define HDSP_SelSyncRef_ADAT1      0</span>
<span class="cp">#define HDSP_SelSyncRef_ADAT2      (HDSP_SelSyncRef0)</span>
<span class="cp">#define HDSP_SelSyncRef_ADAT3      (HDSP_SelSyncRef1)</span>
<span class="cp">#define HDSP_SelSyncRef_SPDIF      (HDSP_SelSyncRef0|HDSP_SelSyncRef1)</span>
<span class="cp">#define HDSP_SelSyncRef_WORD       (HDSP_SelSyncRef2)</span>
<span class="cp">#define HDSP_SelSyncRef_ADAT_SYNC  (HDSP_SelSyncRef0|HDSP_SelSyncRef2)</span>

<span class="cm">/* Card state flags */</span>

<span class="cp">#define HDSP_InitializationComplete  (1&lt;&lt;0)</span>
<span class="cp">#define HDSP_FirmwareLoaded	     (1&lt;&lt;1)</span>
<span class="cp">#define HDSP_FirmwareCached	     (1&lt;&lt;2)</span>

<span class="cm">/* FIFO wait times, defined in terms of 1/10ths of msecs */</span>

<span class="cp">#define HDSP_LONG_WAIT	 5000</span>
<span class="cp">#define HDSP_SHORT_WAIT  30</span>

<span class="cp">#define UNITY_GAIN                       32768</span>
<span class="cp">#define MINUS_INFINITY_GAIN              0</span>

<span class="cm">/* the size of a substream (1 mono data stream) */</span>

<span class="cp">#define HDSP_CHANNEL_BUFFER_SAMPLES  (16*1024)</span>
<span class="cp">#define HDSP_CHANNEL_BUFFER_BYTES    (4*HDSP_CHANNEL_BUFFER_SAMPLES)</span>

<span class="cm">/* the size of the area we need to allocate for DMA transfers. the</span>
<span class="cm">   size is the same regardless of the number of channels - the</span>
<span class="cm">   Multiface still uses the same memory area.</span>

<span class="cm">   Note that we allocate 1 more channel than is apparently needed</span>
<span class="cm">   because the h/w seems to write 1 byte beyond the end of the last</span>
<span class="cm">   page. Sigh.</span>
<span class="cm">*/</span>

<span class="cp">#define HDSP_DMA_AREA_BYTES ((HDSP_MAX_CHANNELS+1) * HDSP_CHANNEL_BUFFER_BYTES)</span>
<span class="cp">#define HDSP_DMA_AREA_KILOBYTES (HDSP_DMA_AREA_BYTES/1024)</span>

<span class="cm">/* use hotplug firmware loader? */</span>
<span class="cp">#if defined(CONFIG_FW_LOADER) || defined(CONFIG_FW_LOADER_MODULE)</span>
<span class="cp">#if !defined(HDSP_USE_HWDEP_LOADER)</span>
<span class="cp">#define HDSP_FW_LOADER</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="k">struct</span> <span class="n">hdsp_9632_meters</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">input_peak</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">playback_peak</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">output_peak</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">xxx_peak</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">padding</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">input_rms_low</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">playback_rms_low</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">output_rms_low</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">xxx_rms_low</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">input_rms_high</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">playback_rms_high</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">output_rms_high</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="n">u32</span> <span class="n">xxx_rms_high</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">hdsp</span>             <span class="o">*</span><span class="n">hdsp</span><span class="p">;</span>
    <span class="kt">int</span>                      <span class="n">id</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">snd_rawmidi</span>           <span class="o">*</span><span class="n">rmidi</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">output</span><span class="p">;</span>
    <span class="kt">char</span>                     <span class="n">istimer</span><span class="p">;</span> <span class="cm">/* timer in use */</span>
    <span class="k">struct</span> <span class="n">timer_list</span>	     <span class="n">timer</span><span class="p">;</span>
    <span class="n">spinlock_t</span>               <span class="n">lock</span><span class="p">;</span>
    <span class="kt">int</span>			     <span class="n">pending</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">hdsp</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>            <span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">playback_substream</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">hdsp_midi</span>      <span class="n">midi</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">midi_tasklet</span><span class="p">;</span>
	<span class="kt">int</span>		      <span class="n">use_midi_tasklet</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">precise_ptr</span><span class="p">;</span>
	<span class="n">u32</span>                   <span class="n">control_register</span><span class="p">;</span>	     <span class="cm">/* cached value */</span>
	<span class="n">u32</span>                   <span class="n">control2_register</span><span class="p">;</span>     <span class="cm">/* cached value */</span>
	<span class="n">u32</span>                   <span class="n">creg_spdif</span><span class="p">;</span>
	<span class="n">u32</span>                   <span class="n">creg_spdif_stream</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">clock_source_locked</span><span class="p">;</span>
	<span class="kt">char</span>                 <span class="o">*</span><span class="n">card_name</span><span class="p">;</span>	 <span class="cm">/* digiface/multiface/rpm */</span>
	<span class="k">enum</span> <span class="n">HDSP_IO_Type</span>     <span class="n">io_type</span><span class="p">;</span>               <span class="cm">/* ditto, but for code use */</span>
        <span class="kt">unsigned</span> <span class="kt">short</span>        <span class="n">firmware_rev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>	      <span class="n">state</span><span class="p">;</span>		     <span class="cm">/* stores state bits */</span>
	<span class="n">u32</span>		      <span class="n">firmware_cache</span><span class="p">[</span><span class="mi">24413</span><span class="p">];</span> <span class="cm">/* this helps recover from accidental iobox power failure */</span>
	<span class="kt">size_t</span>                <span class="n">period_bytes</span><span class="p">;</span> 	     <span class="cm">/* guess what this is */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	      <span class="n">max_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	      <span class="n">qs_in_channels</span><span class="p">;</span>	     <span class="cm">/* quad speed mode for H9632 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>         <span class="n">ds_in_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>         <span class="n">ss_in_channels</span><span class="p">;</span>	    <span class="cm">/* different for multiface/digiface */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	      <span class="n">qs_out_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>         <span class="n">ds_out_channels</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>         <span class="n">ss_out_channels</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">capture_dma_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="n">playback_dma_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>        <span class="o">*</span><span class="n">capture_buffer</span><span class="p">;</span>	    <span class="cm">/* suitably aligned address */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>        <span class="o">*</span><span class="n">playback_buffer</span><span class="p">;</span>	    <span class="cm">/* suitably aligned address */</span>

	<span class="n">pid_t</span>                 <span class="n">capture_pid</span><span class="p">;</span>
	<span class="n">pid_t</span>                 <span class="n">playback_pid</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">running</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">system_sample_rate</span><span class="p">;</span>
	<span class="kt">char</span>                 <span class="o">*</span><span class="n">channel_map</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span>                   <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>         <span class="n">port</span><span class="p">;</span>
        <span class="kt">void</span> <span class="n">__iomem</span>         <span class="o">*</span><span class="n">iobase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_hwdep</span>          <span class="o">*</span><span class="n">hwdep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>       <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">spdif_ctl</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span>        <span class="n">mixer_matrix</span><span class="p">[</span><span class="n">HDSP_MATRIX_MIXER_SIZE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>          <span class="n">dds_value</span><span class="p">;</span> <span class="cm">/* last value written to freq register */</span>
<span class="p">};</span>

<span class="cm">/* These tables map the ALSA channels 1..N to the channels that we</span>
<span class="cm">   need to use in order to find the relevant channel buffer. RME</span>
<span class="cm">   refer to this kind of mapping as between &quot;the ADAT channel and</span>
<span class="cm">   the DMA channel.&quot; We index it using the logical audio channel,</span>
<span class="cm">   and the value is the DMA channel (i.e. channel buffer number)</span>
<span class="cm">   where the data for that channel can be read/written from/to.</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_df_ss</span><span class="p">[</span><span class="n">HDSP_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span>
	<span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_mf_ss</span><span class="p">[</span><span class="n">HDSP_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="cm">/* Multiface */</span>
	<span class="cm">/* Analog */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="cm">/* ADAT 2 */</span>
	<span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
	<span class="cm">/* SPDIF */</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_ds</span><span class="p">[</span><span class="n">HDSP_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADAT channels are remapped */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>
	<span class="cm">/* channels 12 and 13 are S/PDIF */</span>
	<span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span>
	<span class="cm">/* others don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_H9632_ss</span><span class="p">[</span><span class="n">HDSP_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADAT channels */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="cm">/* SPDIF */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	<span class="cm">/* Analog */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
	<span class="cm">/* AO4S-192 and AI4S-192 extension boards */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	<span class="cm">/* others don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_H9632_ds</span><span class="p">[</span><span class="n">HDSP_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADAT */</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="cm">/* SPDIF */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	<span class="cm">/* Analog */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
	<span class="cm">/* AO4S-192 and AI4S-192 extension boards */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	<span class="cm">/* others don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">channel_map_H9632_qs</span><span class="p">[</span><span class="n">HDSP_MAX_CHANNELS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* ADAT is disabled in this mode */</span>
	<span class="cm">/* SPDIF */</span>
	<span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	<span class="cm">/* Analog */</span>
	<span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>
	<span class="cm">/* AO4S-192 and AI4S-192 extension boards */</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
	<span class="cm">/* others don&#39;t exist */</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hammerfall_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">dmab</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">;</span>
	<span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_get_reserved_buf</span><span class="p">(</span><span class="n">dmab</span><span class="p">,</span> <span class="n">snd_dma_pci_buf_id</span><span class="p">(</span><span class="n">pci</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmab</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_dma_alloc_pages</span><span class="p">(</span><span class="n">SNDRV_DMA_TYPE_DEV</span><span class="p">,</span> <span class="n">snd_dma_pci_data</span><span class="p">(</span><span class="n">pci</span><span class="p">),</span>
				<span class="n">size</span><span class="p">,</span> <span class="n">dmab</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hammerfall_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_dma_buffer</span> <span class="o">*</span><span class="n">dmab</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmab</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmab</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* make it anonymous */</span>
		<span class="n">snd_dma_reserve_buf</span><span class="p">(</span><span class="n">dmab</span><span class="p">,</span> <span class="n">snd_dma_pci_buf_id</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">snd_hdsp_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_XILINX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">PCI_DEVICE_ID_XILINX_HAMMERFALL_DSP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span> <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span> <span class="cm">/* RME Hammerfall-DSP */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">snd_hdsp_ids</span><span class="p">);</span>

<span class="cm">/* prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_hdsp_create_alsa_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_hdsp_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_hdsp_enable_io</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_hdsp_initialize_midi_flush</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_hdsp_initialize_channels</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdsp_fifo_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdsp_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">snd_hdsp_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">snd_hdsp_9652_enable_mixer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_playback_to_output_key</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Multiface</span>:
	<span class="k">case</span> <span class="n">Digiface</span>:
	<span class="k">case</span> <span class="n">RPM</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">==</span> <span class="mh">0xa</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="n">in</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">52</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="n">in</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">H9632</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">in</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">52</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="n">in</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_input_to_output_key</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Multiface</span>:
	<span class="k">case</span> <span class="n">Digiface</span>:
	<span class="k">case</span> <span class="n">RPM</span>:
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">==</span> <span class="mh">0xa</span><span class="p">)</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="n">in</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="p">(</span><span class="mi">52</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="n">in</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H9632</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="n">in</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="k">return</span> <span class="p">(</span><span class="mi">52</span> <span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="o">+</span> <span class="n">in</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hdsp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_check_for_iobox</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_ConfigError</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="s">&quot;Hammerfall-DSP: no IO box connected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_FirmwareLoaded</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_wait_for_iobox</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loops</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">loops</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_ConfigError</span><span class="p">)</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printd</span><span class="p">(</span><span class="s">&quot;Hammerfall-DSP: iobox found after %ums!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">i</span> <span class="o">*</span> <span class="n">delay</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span><span class="p">(</span><span class="s">&quot;Hammerfall-DSP: no IO box connected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_FirmwareLoaded</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_load_firmware_from_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span> <span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_DllError</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: loading firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">HDSP_S_PROGRAM</span><span class="p">);</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDSP_LONG_WAIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: timeout waiting for download preparation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">HDSP_S_LOAD</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">24413</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoData</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="n">HDSP_LONG_WAIT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: timeout during firmware loading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ssleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDSP_LONG_WAIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: timeout at end of firmware loading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		    	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="n">HDSP_BIGENDIAN_MODE</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">);</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: finished firmware loading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_InitializationComplete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: firmware loaded from cache, restoring defaults</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">snd_hdsp_set_defaults</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">HDSP_FirmwareLoaded</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_get_iobox_version</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_DllError</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">HDSP_PROGRAM</span><span class="p">);</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDSP_SHORT_WAIT</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">HDSP_S_LOAD</span><span class="p">);</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoData</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDSP_SHORT_WAIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">HDSP_VERSION_BIT</span><span class="p">);</span>
			<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">HDSP_S_LOAD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDSP_SHORT_WAIT</span><span class="p">))</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">RPM</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Multiface</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Digiface</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* firmware was already loaded, get iobox type */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_version2</span><span class="p">)</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">RPM</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_version1</span><span class="p">)</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Multiface</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Digiface</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef HDSP_FW_LOADER</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hdsp_request_fw_loader</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_check_for_firmware</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">load_on_demand</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_DllError</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_FirmwareLoaded</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">load_on_demand</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: firmware not present.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* try to load firmware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_FirmwareCached</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef HDSP_FW_LOADER</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">hdsp_request_fw_loader</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;Hammerfall-DSP: No firmware loaded nor &quot;</span>
				   <span class="s">&quot;cached, please upload firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">snd_hdsp_load_firmware_from_cache</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				   <span class="s">&quot;Hammerfall-DSP: Firmware loading from &quot;</span>
				   <span class="s">&quot;cache failed, please upload manually.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_fifo_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* the fifoStatus registers reports on how many words</span>
<span class="cm">	   are available in the command FIFO.</span>
<span class="cm">	*/</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">count</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* not very friendly, but we only do this during a firmware</span>
<span class="cm">		   load and changing the mixer, so we just put up with it.</span>
<span class="cm">		*/</span>

		<span class="n">udelay</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: wait for FIFO status &lt;= %d failed after %d iterations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_read_gain</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">HDSP_MATRIX_MIXER_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">[</span><span class="n">addr</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_write_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">HDSP_MATRIX_MIXER_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* from martin bjornsen:</span>

<span class="cm">		   &quot;You can only write dwords to the</span>
<span class="cm">		   mixer memory which contain two</span>
<span class="cm">		   mixer values in the low and high</span>
<span class="cm">		   word. So if you want to change</span>
<span class="cm">		   value 0 you have to read value 1</span>
<span class="cm">		   from the cache and write both to</span>
<span class="cm">		   the first dword in the mixer</span>
<span class="cm">		   memory.&quot;</span>
<span class="cm">		*/</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span> <span class="o">&gt;=</span> <span class="mi">1352</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>


		<span class="cm">/* `addr&#39; addresses a 16-bit wide address, but</span>
<span class="cm">		   the address space accessed via hdsp_write</span>
<span class="cm">		   uses byte offsets. put another way, addr</span>
<span class="cm">		   varies from 0 to 1351, but to access the</span>
<span class="cm">		   corresponding memory location, we need</span>
<span class="cm">		   to access 0 to 2703 ...</span>
<span class="cm">		*/</span>
		<span class="n">ad</span> <span class="o">=</span> <span class="n">addr</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">4096</span> <span class="o">+</span> <span class="p">(</span><span class="n">ad</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">[(</span><span class="n">addr</span><span class="o">&amp;</span><span class="mh">0x7fe</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">[</span><span class="n">addr</span><span class="o">&amp;</span><span class="mh">0x7fe</span><span class="p">]);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">ad</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="n">HDSP_LONG_WAIT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoData</span><span class="p">,</span> <span class="n">ad</span><span class="p">);</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_spdifFrequencyMask</span><span class="p">);</span>

	<span class="cm">/* For the 9632, the mask is different */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
		 <span class="n">rate_bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_spdifFrequencyMask_9632</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFErrorFlag</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate_bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency32KHz</span>: <span class="k">return</span> <span class="mi">32000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency44_1KHz</span>: <span class="k">return</span> <span class="mi">44100</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency48KHz</span>: <span class="k">return</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency64KHz</span>: <span class="k">return</span> <span class="mi">64000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency88_2KHz</span>: <span class="k">return</span> <span class="mi">88200</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency96KHz</span>: <span class="k">return</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency128KHz</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="mi">128000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency176_4KHz</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="mi">176400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_spdifFrequency192KHz</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: unknown spdif frequency status; bits = 0x%x, status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate_bits</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_external_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate_bits</span> <span class="o">=</span> <span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSP_systemFrequencyMask</span><span class="p">;</span>

	<span class="cm">/* For the 9632 card, there seems to be no bit for indicating external</span>
<span class="cm">	 * sample rate greater than 96kHz. The card reports the corresponding</span>
<span class="cm">	 * single speed. So the best means seems to get spdif rate when</span>
<span class="cm">	 * autosync reference is spdif */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hdsp_autosync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">==</span> <span class="n">HDSP_AUTOSYNC_FROM_SPDIF</span><span class="p">)</span>
		 <span class="k">return</span> <span class="n">hdsp_spdif_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate_bits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_systemFrequency32</span>:   <span class="k">return</span> <span class="mi">32000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_systemFrequency44_1</span>: <span class="k">return</span> <span class="mi">44100</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_systemFrequency48</span>:   <span class="k">return</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_systemFrequency64</span>:   <span class="k">return</span> <span class="mi">64000</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_systemFrequency88_2</span>: <span class="k">return</span> <span class="mi">88200</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_systemFrequency96</span>:   <span class="k">return</span> <span class="mi">96000</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_compute_period_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">hdsp_decode_latency</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">hdsp_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">position</span><span class="p">;</span>

	<span class="n">position</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">position</span> <span class="o">&amp;</span> <span class="n">HDSP_BufferID</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">position</span> <span class="o">&amp;=</span> <span class="n">HDSP_BufferPositionMask</span><span class="p">;</span>
	<span class="n">position</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">position</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">position</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_reset_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_resetPointer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&gt;=</span> <span class="mi">152</span><span class="p">)</span>
		<span class="cm">/* HDSP_resetPointer = HDSP_freqReg, which is strange and</span>
<span class="cm">		 * requires (?) to write again DDS value after a reset pointer</span>
<span class="cm">		 * (at least, it works like this) */</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_freqReg</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">dds_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_start_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HDSP_AudioInterruptEnable</span> <span class="o">|</span> <span class="n">HDSP_Start</span><span class="p">);</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_stop_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSP_Start</span> <span class="o">|</span> <span class="n">HDSP_AudioInterruptEnable</span><span class="p">);</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_silence_playback</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">HDSP_DMA_AREA_BYTES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_interrupt_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">frames</span> <span class="o">&gt;&gt;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">frames</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_LatencyMask</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">hdsp_encode_latency</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>

	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="n">hdsp_compute_period_size</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_set_dds_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">112000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">56000</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">DDS_NUMERATOR</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="cm">/* n should be less than 2^32 for being written to FREQ register */</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/* HDSP_freqReg and HDSP_resetPointer are the same, so keep the DDS</span>
<span class="cm">	   value to write it after a reset */</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">dds_value</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_freqReg</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">dds_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">called_internally</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_bits</span><span class="p">;</span>

	<span class="cm">/* ASSUMPTION: hdsp-&gt;lock is either held, or</span>
<span class="cm">	   there is no need for it (e.g. during module</span>
<span class="cm">	   initialization).</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_ClockModeMaster</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">called_internally</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* request from ctl or card initialization */</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: device is not running as a clock master: cannot set sample rate.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* hw_param request while in AutoSync mode */</span>
			<span class="kt">int</span> <span class="n">external_freq</span> <span class="o">=</span> <span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">spdif_freq</span> <span class="o">=</span> <span class="n">hdsp_spdif_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">spdif_freq</span> <span class="o">==</span> <span class="n">external_freq</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdsp_autosync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT1</span><span class="p">))</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: Detected ADAT in double speed mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">spdif_freq</span> <span class="o">==</span> <span class="n">external_freq</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdsp_autosync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT1</span><span class="p">))</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: Detected ADAT in quad speed mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">external_freq</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: No AutoSync source for requested rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">current_rate</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>

	<span class="cm">/* Changing from a &quot;single speed&quot; to a &quot;double speed&quot; rate is</span>
<span class="cm">	   not allowed if any substreams are open. This is because</span>
<span class="cm">	   such a change causes a shift in the location of</span>
<span class="cm">	   the DMA buffers and a reduction in the number of available</span>
<span class="cm">	   buffers.</span>

<span class="cm">	   Note that a similar but essentially insoluble problem</span>
<span class="cm">	   exists for externally-driven rate changes. All we can do</span>
<span class="cm">	   is to flag rate changes in the read/write routines.  */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">96000</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">H9632</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency32KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency44_1KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency48KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span> <span class="o">||</span> <span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mi">96000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency64KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span> <span class="o">||</span> <span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mi">96000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency88_2KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;=</span> <span class="mi">48000</span> <span class="o">||</span> <span class="n">current_rate</span> <span class="o">&gt;</span> <span class="mi">96000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency96KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;</span> <span class="mi">128000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency128KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">176400</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;</span> <span class="mi">128000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency176_4KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192000</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">current_rate</span> <span class="o">&lt;</span> <span class="mi">128000</span><span class="p">)</span>
			<span class="n">reject_if_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rate_bits</span> <span class="o">=</span> <span class="n">HDSP_Frequency192KHz</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reject_if_open</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span> <span class="p">(</span><span class="s">&quot;Hammerfall-DSP: cannot change speed mode (capture PID = %d, playback PID = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">,</span>
			    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_FrequencyMask</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">rate_bits</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

	<span class="cm">/* For HDSP9632 rev 152, need to set DDS value in FREQ register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&gt;=</span> <span class="mi">152</span><span class="p">)</span>
		<span class="n">hdsp_set_dds_value</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">128000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_H9632_qs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_H9632_ds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_ds</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RPM</span>:
		<span class="k">case</span> <span class="n">Multiface</span>:
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_mf_ss</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">Digiface</span>:
		<span class="k">case</span> <span class="n">H9652</span>:
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_df_ss</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">H9632</span>:
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span> <span class="o">=</span> <span class="n">channel_map_H9632_ss</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* should never happen */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------------------</span>
<span class="cm">   MIDI</span>
<span class="cm">  ----------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">snd_hdsp_midi_read_byte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the hardware already does the relevant bit-mask with 0xff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiDataIn1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiDataIn0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_midi_write_byte</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the hardware already does the relevant bit-mask with 0xff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
		<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiDataOut1</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiDataOut0</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_input_available</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusIn1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusIn0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_output_possible</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fifo_bytes_used</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
		<span class="n">fifo_bytes_used</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusOut1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fifo_bytes_used</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusOut0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifo_bytes_used</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span>  <span class="mi">128</span> <span class="o">-</span> <span class="n">fifo_bytes_used</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_flush_midi_input</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">snd_hdsp_midi_input_available</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
		<span class="n">snd_hdsp_midi_read_byte</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_output_write</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to_write</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

	<span class="cm">/* Output is not interrupt driven */</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_rawmidi_transmit_empty</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">n_pending</span> <span class="o">=</span> <span class="n">snd_hdsp_midi_output_possible</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">))</span>
					<span class="n">n_pending</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">to_write</span> <span class="o">=</span> <span class="n">snd_rawmidi_transmit</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n_pending</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">to_write</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
						<span class="n">snd_hdsp_midi_write_byte</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_input_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span> <span class="cm">/* this buffer is designed to match the MIDI input FIFO size */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">n_pending</span> <span class="o">=</span> <span class="n">snd_hdsp_midi_input_available</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">))</span>
				<span class="n">n_pending</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_pending</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">snd_hdsp_midi_read_byte</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_pending</span><span class="p">)</span>
				<span class="n">snd_rawmidi_receive</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n_pending</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* flush the MIDI input FIFO */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n_pending</span><span class="p">)</span>
				<span class="n">snd_hdsp_midi_read_byte</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
		<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_Midi1InterruptEnable</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_Midi0InterruptEnable</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snd_hdsp_midi_output_write</span> <span class="p">(</span><span class="n">hmidi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_midi_input_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ie</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">hdsp</span> <span class="o">=</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">;</span>
	<span class="n">ie</span> <span class="o">=</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">?</span> <span class="n">HDSP_Midi1InterruptEnable</span> <span class="o">:</span> <span class="n">HDSP_Midi0InterruptEnable</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">ie</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_hdsp_flush_midi_input</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">ie</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ie</span><span class="p">;</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_midi_output_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">snd_hdsp_midi_output_write</span><span class="p">(</span><span class="n">hmidi</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* this does not bump hmidi-&gt;istimer, because the</span>
<span class="cm">	   kernel automatically removed the timer when it</span>
<span class="cm">	   expired, and we are now adding it back, thus</span>
<span class="cm">	   leaving istimer wherever it was set before.</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_midi_output_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">snd_hdsp_midi_output_timer</span><span class="p">;</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hmidi</span><span class="p">;</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">istimer</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">del_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span>
		<span class="n">snd_hdsp_midi_output_write</span><span class="p">(</span><span class="n">hmidi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_input_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">snd_hdsp_flush_midi_input</span> <span class="p">(</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_output_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_input_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">snd_hdsp_midi_input_trigger</span> <span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_midi_output_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_rawmidi_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="n">hmidi</span><span class="p">;</span>

	<span class="n">snd_hdsp_midi_output_trigger</span> <span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">hmidi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_midi</span> <span class="o">*</span><span class="p">)</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hmidi</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_hdsp_midi_output</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_hdsp_midi_output_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_hdsp_midi_output_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_hdsp_midi_output_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_rawmidi_ops</span> <span class="n">snd_hdsp_midi_input</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_hdsp_midi_input_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_hdsp_midi_input_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_hdsp_midi_input_trigger</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_create_midi</span> <span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">hdsp</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">istimer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">sprintf</span> <span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s MIDI %d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_rawmidi_new</span> <span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;HDSP MIDI %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

	<span class="n">snd_rawmidi_set_ops</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_OUTPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hdsp_midi_output</span><span class="p">);</span>
	<span class="n">snd_rawmidi_set_ops</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="p">,</span> <span class="n">SNDRV_RAWMIDI_STREAM_INPUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hdsp_midi_input</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">rmidi</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">|=</span> <span class="n">SNDRV_RAWMIDI_INFO_OUTPUT</span> <span class="o">|</span>
		<span class="n">SNDRV_RAWMIDI_INFO_INPUT</span> <span class="o">|</span>
		<span class="n">SNDRV_RAWMIDI_INFO_DUPLEX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-----------------------------------------------------------------------------</span>
<span class="cm">  Control Interface</span>
<span class="cm">  ----------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">snd_hdsp_convert_from_aes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_aes_iec958</span> <span class="o">*</span><span class="n">aes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PROFESSIONAL</span><span class="p">)</span> <span class="o">?</span> <span class="n">HDSP_SPDIFProfessional</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_NONAUDIO</span><span class="p">)</span> <span class="o">?</span> <span class="n">HDSP_SPDIFNonAudio</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFProfessional</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span><span class="p">)</span> <span class="o">?</span> <span class="n">HDSP_SPDIFEmphasis</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span><span class="p">)</span> <span class="o">?</span> <span class="n">HDSP_SPDIFEmphasis</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_convert_to_aes</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_aes_iec958</span> <span class="o">*</span><span class="n">aes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFProfessional</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFNonAudio</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFProfessional</span><span class="p">)</span>
		<span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_PRO_EMPHASIS_5015</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">aes</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEC958_AES0_CON_EMPHASIS_5015</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">snd_hdsp_convert_to_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_hdsp_convert_from_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_stream_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_stream_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">snd_hdsp_convert_to_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_stream_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">snd_hdsp_convert_from_aes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSP_SPDIFProfessional</span> <span class="o">|</span> <span class="n">HDSP_SPDIFNonAudio</span> <span class="o">|</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">);</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_mask_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_IEC958</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_control_spdif_mask_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">iec958</span><span class="p">.</span><span class="n">status</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_IN(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_spdif_in, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_in, \</span>
<span class="cp">  .put = snd_hdsp_put_spdif_in }</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdsp_decode_spdif_in</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFInputMask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_spdif_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SPDIFInputMask</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">hdsp_encode_spdif_in</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Optical&quot;</span><span class="p">,</span> <span class="s">&quot;Coaxial&quot;</span><span class="p">,</span> <span class="s">&quot;Internal&quot;</span><span class="p">,</span> <span class="s">&quot;AES&quot;</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_spdif_in</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_spdif_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_spdif_in</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">hdsp_set_spdif_input</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_OUT(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_spdif_bits, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_out, .put = snd_hdsp_put_spdif_out }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFOpticalOut</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_spdif_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SPDIFOpticalOut</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SPDIFOpticalOut</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_spdif_bits	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_spdif_out</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_spdif_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_spdif_out</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_spdif_output</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_PROFESSIONAL(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_spdif_bits, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_professional, .put = snd_hdsp_put_spdif_professional }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFProfessional</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_spdif_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SPDIFProfessional</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SPDIFProfessional</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_spdif_professional</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_spdif_professional</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_spdif_professional</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_spdif_professional</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_EMPHASIS(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_spdif_bits, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_emphasis, .put = snd_hdsp_put_spdif_emphasis }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_spdif_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SPDIFEmphasis</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_spdif_emphasis</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_spdif_emphasis</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_spdif_emphasis</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_spdif_emphasis</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_NON_AUDIO(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_spdif_bits, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_nonaudio, .put = snd_hdsp_put_spdif_nonaudio }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_nonaudio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFNonAudio</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_spdif_nonaudio</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SPDIFNonAudio</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SPDIFNonAudio</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_nonaudio</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_spdif_nonaudio</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_spdif_nonaudio</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_spdif_nonaudio</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_spdif_nonaudio</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_SAMPLE_RATE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdsp_info_spdif_sample_rate, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_sample_rate \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_spdif_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;32000&quot;</span><span class="p">,</span> <span class="s">&quot;44100&quot;</span><span class="p">,</span> <span class="s">&quot;48000&quot;</span><span class="p">,</span> <span class="s">&quot;64000&quot;</span><span class="p">,</span> <span class="s">&quot;88200&quot;</span><span class="p">,</span> <span class="s">&quot;96000&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;128000&quot;</span><span class="p">,</span> <span class="s">&quot;176400&quot;</span><span class="p">,</span> <span class="s">&quot;192000&quot;</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_spdif_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">176400</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SYSTEM_SAMPLE_RATE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdsp_info_system_sample_rate, \</span>
<span class="cp">  .get = snd_hdsp_get_system_sample_rate \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_system_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_system_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_AUTOSYNC_SAMPLE_RATE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdsp_info_autosync_sample_rate, \</span>
<span class="cp">  .get = snd_hdsp_get_autosync_sample_rate \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_autosync_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;32000&quot;</span><span class="p">,</span> <span class="s">&quot;44100&quot;</span><span class="p">,</span> <span class="s">&quot;48000&quot;</span><span class="p">,</span> <span class="s">&quot;64000&quot;</span><span class="p">,</span> <span class="s">&quot;88200&quot;</span><span class="p">,</span> <span class="s">&quot;96000&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;128000&quot;</span><span class="p">,</span> <span class="s">&quot;176400&quot;</span><span class="p">,</span> <span class="s">&quot;192000&quot;</span><span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">7</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_autosync_sample_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">44100</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">48000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">64000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">88200</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">96000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">128000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">176400</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">192000</span>:
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SYSTEM_CLOCK_MODE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdsp_info_system_clock_mode, \</span>
<span class="cp">  .get = snd_hdsp_get_system_clock_mode \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_ClockModeMaster</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Master&quot;</span><span class="p">,</span> <span class="s">&quot;Slave&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_system_clock_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_system_clock_mode</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_CLOCK_SOURCE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_clock_source, \</span>
<span class="cp">  .get = snd_hdsp_get_clock_source, \</span>
<span class="cp">  .put = snd_hdsp_put_clock_source \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_ClockModeMaster</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">32000</span>:
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">44100</span>:
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">48000</span>:
			<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">64000</span>:
			<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">88200</span>:
			<span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">96000</span>:
			<span class="k">return</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">128000</span>:
			<span class="k">return</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">176400</span>:
			<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">192000</span>:
			<span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_AUTOSYNC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdsp_set_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_ClockModeMaster</span><span class="p">;</span>
			<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		    <span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_32KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_44_1KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_48KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_64KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_88_2KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">88200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_96KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_128KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_176_4KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">176400</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_192KHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_ClockModeMaster</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">hdsp_set_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;AutoSync&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 32.0 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 44.1 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 48.0 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 64.0 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 88.2 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 96.0 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 128 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 176.4 kHz&quot;</span><span class="p">,</span> <span class="s">&quot;Internal 192.0 KHz&quot;</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
	    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
	    <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_clock_source</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_clock_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_clock_source</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_clock_source</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_clock_source_lock		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_clock_source_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">clock_source_locked</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_clock_source_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">clock_source_locked</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">clock_source_locked</span> <span class="o">=</span> <span class="o">!!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_DA_GAIN(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_da_gain, \</span>
<span class="cp">  .get = snd_hdsp_get_da_gain, \</span>
<span class="cp">  .put = snd_hdsp_put_da_gain \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_da_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_DAGainMask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_DAGainHighGain</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_DAGainPlus4dBu</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_DAGainMinus10dBV</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_da_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_DAGainMask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_DAGainHighGain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_DAGainPlus4dBu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_DAGainMinus10dBV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_da_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Hi Gain&quot;</span><span class="p">,</span> <span class="s">&quot;+4 dBu&quot;</span><span class="p">,</span> <span class="s">&quot;-10 dbV&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_da_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_da_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_da_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_da_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_da_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_AD_GAIN(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_ad_gain, \</span>
<span class="cp">  .get = snd_hdsp_get_ad_gain, \</span>
<span class="cp">  .put = snd_hdsp_put_ad_gain \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_ad_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_ADGainMask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_ADGainMinus10dBV</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_ADGainPlus4dBu</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_ADGainLowGain</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_ad_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_ADGainMask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_ADGainMinus10dBV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_ADGainPlus4dBu</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_ADGainLowGain</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_ad_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;-10 dBV&quot;</span><span class="p">,</span> <span class="s">&quot;+4 dBu&quot;</span><span class="p">,</span> <span class="s">&quot;Lo Gain&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_ad_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_ad_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_ad_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_ad_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_ad_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_PHONE_GAIN(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_phone_gain, \</span>
<span class="cp">  .get = snd_hdsp_get_phone_gain, \</span>
<span class="cp">  .put = snd_hdsp_put_phone_gain \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_phone_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_PhoneGainMask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_PhoneGain0dB</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_PhoneGainMinus6dB</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_PhoneGainMinus12dB</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_phone_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_PhoneGainMask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_PhoneGain0dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_PhoneGainMinus6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_PhoneGainMinus12dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_phone_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;0 dB&quot;</span><span class="p">,</span> <span class="s">&quot;-6 dB&quot;</span><span class="p">,</span> <span class="s">&quot;-12 dB&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_phone_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_phone_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_phone_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_phone_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_phone_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_XLR_BREAKOUT_CABLE(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_xlr_breakout_cable, \</span>
<span class="cp">  .get = snd_hdsp_get_xlr_breakout_cable, \</span>
<span class="cp">  .put = snd_hdsp_put_xlr_breakout_cable \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_xlr_breakout_cable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_XLRBreakoutCable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_xlr_breakout_cable</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_XLRBreakoutCable</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_XLRBreakoutCable</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_xlr_breakout_cable	snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_xlr_breakout_cable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_xlr_breakout_cable</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_xlr_breakout_cable</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_xlr_breakout_cable</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_xlr_breakout_cable</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* (De)activates old RME Analog Extension Board</span>
<span class="cm">   These are connected to the internal ADAT connector</span>
<span class="cm">   Switching this on desactivates external ADAT</span>
<span class="cm">*/</span>
<span class="cp">#define HDSP_AEB(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_aeb, \</span>
<span class="cp">  .get = snd_hdsp_get_aeb, \</span>
<span class="cp">  .put = snd_hdsp_put_aeb \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_aeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_AnalogExtensionBoard</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_aeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_AnalogExtensionBoard</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_AnalogExtensionBoard</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_aeb		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_aeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_aeb</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_aeb</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_aeb</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_aeb</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_PREF_SYNC_REF(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_pref_sync_ref, \</span>
<span class="cp">  .get = snd_hdsp_get_pref_sync_ref, \</span>
<span class="cp">  .put = snd_hdsp_put_pref_sync_ref \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Notice that this looks at the requested sync source,</span>
<span class="cm">	   not the one actually in use.</span>
<span class="cm">	*/</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SyncRefMask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_SyncRef_ADAT1</span>:
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_ADAT1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SyncRef_ADAT2</span>:
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_ADAT2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SyncRef_ADAT3</span>:
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_ADAT3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SyncRef_SPDIF</span>:
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_SPDIF</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SyncRef_WORD</span>:
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_WORD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SyncRef_ADAT_SYNC</span>:
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_ADAT_SYNC</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">HDSP_SYNC_FROM_WORD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SyncRefMask</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">pref</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT1</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_SyncRefMask</span><span class="p">;</span> <span class="cm">/* clear SyncRef bits */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT2</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SyncRef_ADAT2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT3</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SyncRef_ADAT3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_SPDIF</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SyncRef_SPDIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_WORD</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SyncRef_WORD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT_SYNC</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_SyncRef_ADAT_SYNC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Word&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT Sync&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3&quot;</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Digiface</span>:
	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Multiface</span>:
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H9632</span>:
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_pref_sync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_pref_sync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Digiface</span>:
	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="n">max</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Multiface</span>:
		<span class="n">max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">H9632</span>:
		<span class="n">max</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_pref_sync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_pref_sync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_AUTOSYNC_REF(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ, \</span>
<span class="cp">  .info = snd_hdsp_info_autosync_ref, \</span>
<span class="cp">  .get = snd_hdsp_get_autosync_ref, \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This looks at the autosync selected sync reference */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSP_SelSyncRefMask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRef_WORD</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_WORD</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRef_ADAT_SYNC</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT_SYNC</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRef_SPDIF</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_SPDIF</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRefMask</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_NONE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRef_ADAT1</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRef_ADAT2</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SelSyncRef_ADAT3</span>:
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT3</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">HDSP_AUTOSYNC_FROM_WORD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Word&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT Sync&quot;</span><span class="p">,</span> <span class="s">&quot;IEC958&quot;</span><span class="p">,</span> <span class="s">&quot;None&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT1&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT2&quot;</span><span class="p">,</span> <span class="s">&quot;ADAT3&quot;</span> <span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_autosync_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_autosync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_LINE_OUT(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_line_out, \</span>
<span class="cp">  .get = snd_hdsp_get_line_out, \</span>
<span class="cp">  .put = snd_hdsp_put_line_out \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_line_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_LineOut</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_line_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_LineOut</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_LineOut</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_line_out		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_line_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_line_out</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_line_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_line_out</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_line_output</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_PRECISE_POINTER(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_CARD, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_precise_pointer, \</span>
<span class="cp">  .get = snd_hdsp_get_precise_pointer, \</span>
<span class="cp">  .put = snd_hdsp_put_precise_pointer \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_precise_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">precise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">precise</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_precise_pointer		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_precise_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_precise_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span><span class="p">;</span>
	<span class="n">hdsp_set_precise_pointer</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_USE_MIDI_TASKLET(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_CARD, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_use_midi_tasklet, \</span>
<span class="cp">  .get = snd_hdsp_get_use_midi_tasklet, \</span>
<span class="cp">  .put = snd_hdsp_put_use_midi_tasklet \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_use_midi_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_tasklet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_tasklet</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define snd_hdsp_info_use_midi_tasklet		snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_use_midi_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_use_midi_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span><span class="p">;</span>
	<span class="n">hdsp_set_use_midi_tasklet</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_MIXER(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_HWDEP, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .device = 0, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READWRITE | \</span>
<span class="cp">		 SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdsp_info_mixer, \</span>
<span class="cp">  .get = snd_hdsp_get_mixer, \</span>
<span class="cp">  .put = snd_hdsp_put_mixer \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destination</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">destination</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">hdsp_playback_to_output_key</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">,</span><span class="n">destination</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">hdsp_input_to_output_key</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_read_gain</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_mixer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">destination</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">source</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">destination</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">&gt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">hdsp_playback_to_output_key</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span><span class="n">source</span><span class="o">-</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">hdsp_input_to_output_key</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">);</span>

	<span class="n">gain</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="n">gain</span> <span class="o">!=</span> <span class="n">hdsp_read_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">hdsp_write_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_WC_SYNC_CHECK(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdsp_info_sync_check, \</span>
<span class="cp">  .get = snd_hdsp_get_wc_sync_check \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;No Lock&quot;</span><span class="p">,</span> <span class="s">&quot;Lock&quot;</span><span class="p">,</span> <span class="s">&quot;Sync&quot;</span> <span class="p">};</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_wc_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSP_wc_lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSP_wc_sync</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			 <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_wc_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_wc_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_SPDIF_SYNC_CHECK(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdsp_info_sync_check, \</span>
<span class="cp">  .get = snd_hdsp_get_spdif_sync_check \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_spdif_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFErrorFlag</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFSync</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_spdif_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_spdif_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_ADATSYNC_SYNC_CHECK(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdsp_info_sync_check, \</span>
<span class="cp">  .get = snd_hdsp_get_adatsync_sync_check \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_adatsync_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_TimecodeLock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_TimecodeSync</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_adatsync_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_adatsync_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_ADAT_SYNC_CHECK \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .access = SNDRV_CTL_ELEM_ACCESS_READ | SNDRV_CTL_ELEM_ACCESS_VOLATILE, \</span>
<span class="cp">  .info = snd_hdsp_info_sync_check, \</span>
<span class="cp">  .get = snd_hdsp_get_adat_sync_check \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_adat_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSP_Lock0</span><span class="o">&gt;&gt;</span><span class="n">idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSP_Sync0</span><span class="o">&gt;&gt;</span><span class="n">idx</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_adat_sync_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Digiface</span>:
	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Multiface</span>:
	<span class="k">case</span> <span class="n">H9632</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_adat_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HDSP_DDS_OFFSET(xname, xindex) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, \</span>
<span class="cp">  .name = xname, \</span>
<span class="cp">  .index = xindex, \</span>
<span class="cp">  .info = snd_hdsp_info_dds_offset, \</span>
<span class="cp">  .get = snd_hdsp_get_dds_offset, \</span>
<span class="cp">  .put = snd_hdsp_put_dds_offset \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_dds_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dds_value</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">dds_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">system_sample_rate</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dds_value</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">DDS_NUMERATOR</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * dds_value = n / rate</span>
<span class="cm">	 * rate = n / dds_value</span>
<span class="cm">	 */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dds_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">system_sample_rate</span> <span class="o">&gt;=</span> <span class="mi">112000</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">system_sample_rate</span> <span class="o">&gt;=</span> <span class="mi">56000</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">system_sample_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_dds_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset_hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">+</span> <span class="n">offset_hz</span><span class="p">;</span>
	<span class="n">hdsp_set_dds_value</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_dds_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5000</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_dds_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_dds_offset</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_dds_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_dds_offset</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_dds_offset</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdsp_9632_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">HDSP_DA_GAIN</span><span class="p">(</span><span class="s">&quot;DA Gain&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_AD_GAIN</span><span class="p">(</span><span class="s">&quot;AD Gain&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_PHONE_GAIN</span><span class="p">(</span><span class="s">&quot;Phones Gain&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_XLR_BREAKOUT_CABLE</span><span class="p">(</span><span class="s">&quot;XLR Breakout Cable&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_DDS_OFFSET</span><span class="p">(</span><span class="s">&quot;DDS Sample Rate Offset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdsp_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">DEFAULT</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_put</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span> <span class="o">|</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PCM_STREAM</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_stream_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_stream_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_stream_put</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">CON_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_mask_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_mask_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
  			 <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
			 <span class="n">IEC958_AES0_CON_EMPHASIS</span><span class="p">,</span>
<span class="p">},</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span>	<span class="n">SNDRV_CTL_ELEM_IFACE_PCM</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="n">SNDRV_CTL_NAME_IEC958</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">PLAYBACK</span><span class="p">,</span><span class="n">PRO_MASK</span><span class="p">),</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_mask_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span>		<span class="n">snd_hdsp_control_spdif_mask_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_value</span> <span class="o">=</span> <span class="n">IEC958_AES0_NONAUDIO</span> <span class="o">|</span>
			 <span class="n">IEC958_AES0_PROFESSIONAL</span> <span class="o">|</span>
			 <span class="n">IEC958_AES0_PRO_EMPHASIS</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">HDSP_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_IN</span><span class="p">(</span><span class="s">&quot;IEC958 Input Connector&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_OUT</span><span class="p">(</span><span class="s">&quot;IEC958 Output also on ADAT1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_PROFESSIONAL</span><span class="p">(</span><span class="s">&quot;IEC958 Professional Bit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_EMPHASIS</span><span class="p">(</span><span class="s">&quot;IEC958 Emphasis Bit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_NON_AUDIO</span><span class="p">(</span><span class="s">&quot;IEC958 Non-audio Bit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="cm">/* &#39;Sample Clock Source&#39; complies with the alsa control naming scheme */</span>
<span class="n">HDSP_CLOCK_SOURCE</span><span class="p">(</span><span class="s">&quot;Sample Clock Source&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sample Clock Source Locking&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_hdsp_info_clock_source_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_hdsp_get_clock_source_lock</span><span class="p">,</span>
	<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_hdsp_put_clock_source_lock</span><span class="p">,</span>
<span class="p">},</span>
<span class="n">HDSP_SYSTEM_CLOCK_MODE</span><span class="p">(</span><span class="s">&quot;System Clock Mode&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_PREF_SYNC_REF</span><span class="p">(</span><span class="s">&quot;Preferred Sync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_AUTOSYNC_REF</span><span class="p">(</span><span class="s">&quot;AutoSync Reference&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;SPDIF Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="cm">/* &#39;External Rate&#39; complies with the alsa control naming scheme */</span>
<span class="n">HDSP_AUTOSYNC_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;External Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_WC_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;Word Clock Lock Status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_SPDIF_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;SPDIF Lock Status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_ADATSYNC_SYNC_CHECK</span><span class="p">(</span><span class="s">&quot;ADAT Sync Lock Status&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_LINE_OUT</span><span class="p">(</span><span class="s">&quot;Line Out&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_PRECISE_POINTER</span><span class="p">(</span><span class="s">&quot;Precise Pointer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="n">HDSP_USE_MIDI_TASKLET</span><span class="p">(</span><span class="s">&quot;Use Midi Tasklet&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_rpm_input12</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Inp12</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Phon_6dB</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Phon_n6dB</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Line_0dB</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Line_n6dB</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_rpm_input12</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_rpm_input12</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_rpm_input12</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_RPM_Inp12</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp12_Phon_6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp12_Phon_n6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp12_Line_0dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp12_Line_n6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_rpm_input12</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_rpm_input12</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_rpm_input12</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_rpm_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Phono +6dB&quot;</span><span class="p">,</span> <span class="s">&quot;Phono 0dB&quot;</span><span class="p">,</span> <span class="s">&quot;Phono -6dB&quot;</span><span class="p">,</span> <span class="s">&quot;Line 0dB&quot;</span><span class="p">,</span> <span class="s">&quot;Line -6dB&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_rpm_input34</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Inp34</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Phon_6dB</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Phon_n6dB</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Line_0dB</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Line_n6dB</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_rpm_input34</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_rpm_input34</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_rpm_input34</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_RPM_Inp34</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp34_Phon_6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp34_Phon_n6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp34_Line_0dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Inp34_Line_n6dB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_rpm_input34</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_rpm_input34</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdsp_set_rpm_input34</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* RPM Bypass switch */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_rpm_bypass</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Bypass</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_rpm_bypass</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_rpm_bypass</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_rpm_bypass</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Bypass</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_RPM_Bypass</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_rpm_bypass</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_rpm_bypass</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_rpm_bypass</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_rpm_bypass</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;On&quot;</span><span class="p">,</span> <span class="s">&quot;Off&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* RPM Disconnect switch */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_rpm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Disconnect</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_get_rpm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp_rpm_disconnect</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_set_rpm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">HDSP_RPM_Disconnect</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_RPM_Disconnect</span><span class="p">;</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_put_rpm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">snd_hdsp_use_is_exclusive</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">val</span> <span class="o">!=</span> <span class="n">hdsp_rpm_disconnect</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_set_rpm_disconnect</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_info_rpm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">texts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;On&quot;</span><span class="p">,</span> <span class="s">&quot;Off&quot;</span><span class="p">};</span>

	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_ENUMERATED</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">&gt;=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
		<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span> <span class="o">=</span> <span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">items</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">texts</span><span class="p">[</span><span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">enumerated</span><span class="p">.</span><span class="n">item</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdsp_rpm_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RPM Bypass&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_hdsp_get_rpm_bypass</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_hdsp_put_rpm_bypass</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_hdsp_info_rpm_bypass</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;RPM Disconnect&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_hdsp_get_rpm_disconnect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_hdsp_put_rpm_disconnect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_hdsp_info_rpm_disconnect</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Input 1/2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_hdsp_get_rpm_input12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_hdsp_put_rpm_input12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_hdsp_info_rpm_input</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Input 3/4&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">snd_hdsp_get_rpm_input34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">snd_hdsp_put_rpm_input34</span><span class="p">,</span>
		<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">snd_hdsp_info_rpm_input</span>
	<span class="p">},</span>
	<span class="n">HDSP_SYSTEM_SAMPLE_RATE</span><span class="p">(</span><span class="s">&quot;System Sample Rate&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">HDSP_MIXER</span><span class="p">(</span><span class="s">&quot;Mixer&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdsp_96xx_aeb</span> <span class="o">=</span> <span class="n">HDSP_AEB</span><span class="p">(</span><span class="s">&quot;Analog Extension Board&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_hdsp_adat_sync_check</span> <span class="o">=</span> <span class="n">HDSP_ADAT_SYNC_CHECK</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_create_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kctl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">RPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RPM Bypass, Disconnect and Input switches */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdsp_rpm_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdsp_rpm_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hdsp</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdsp_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdsp_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hdsp</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>	<span class="cm">/* IEC958 (S/PDIF) Stream */</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span> <span class="o">=</span> <span class="n">kctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ADAT SyncCheck status */</span>
	<span class="n">snd_hdsp_adat_sync_check</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ADAT Lock Status&quot;</span><span class="p">;</span>
	<span class="n">snd_hdsp_adat_sync_check</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span> <span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdsp_adat_sync_check</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))))</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">Digiface</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_hdsp_adat_sync_check</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span> <span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdsp_adat_sync_check</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))))</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* DA, AD and Phone gain and XLR breakout cable controls for H9632 cards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_hdsp_9632_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdsp_9632_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">hdsp</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* AEB control for H96xx card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kctl</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_hdsp_96xx_aeb</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------</span>
<span class="cm">   /proc interface</span>
<span class="cm"> ------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">snd_hdsp_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">snd_info_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pref_sync_ref</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">autosync_ref</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">system_clock_mode</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">clock_source</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>
	<span class="n">status2</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%s (Card #%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
		    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Buffers: capture %p playback %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_buffer</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IRQ: %d Registers bus: 0x%lx VM: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Control register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Control2 register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Status register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Status2 register: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;No I/O box connected.</span><span class="se">\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;Please connect one and upload firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_FirmwareCached</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snd_hdsp_load_firmware_from_cache</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Firmware loading from &quot;</span>
					    <span class="s">&quot;cache failed, &quot;</span>
					    <span class="s">&quot;please upload manually.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#ifdef HDSP_FW_LOADER</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_request_fw_loader</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span>
					    <span class="s">&quot;No firmware loaded nor cached, &quot;</span>
					    <span class="s">&quot;please upload firmware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;FIFO status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_fifoStatus</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MIDI1 Output status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusOut0</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MIDI1 Input status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusIn0</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MIDI2 Output status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusOut1</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;MIDI2 Input status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusIn1</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Use Midi Tasklet: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">hdsp_decode_latency</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_LatencyMask</span><span class="p">));</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Buffer Size (Latency): %d samples (2 periods of %lu bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">period_bytes</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Hardware pointer (frames): %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_hw_pointer</span><span class="p">(</span><span class="n">hdsp</span><span class="p">));</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Precise pointer: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Line out: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_LineOut</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Firmware version: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status2</span><span class="o">&amp;</span><span class="n">HDSP_version0</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">status2</span><span class="o">&amp;</span><span class="n">HDSP_version1</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="o">|</span><span class="p">(</span><span class="n">status2</span><span class="o">&amp;</span><span class="n">HDSP_version2</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_clock_source</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_AUTOSYNC</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;AutoSync&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_32KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 32 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_44_1KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 44.1 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_48KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 48 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_64KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 64 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_88_2KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 88.2 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_96KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 96 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_128KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 128 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_176_4KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 176.4 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_CLOCK_SOURCE_INTERNAL_192KHZ</span>:
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Internal 192 kHz&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">clock_source</span> <span class="o">=</span> <span class="s">&quot;Error&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Sample Clock Source: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clock_source</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_system_clock_mode</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="n">system_clock_mode</span> <span class="o">=</span> <span class="s">&quot;Slave&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">system_clock_mode</span> <span class="o">=</span> <span class="s">&quot;Master&quot;</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_pref_sync_ref</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_WORD</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT_SYNC</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT Sync&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_SPDIF</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT1</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT2</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_SYNC_FROM_ADAT3</span>:
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT3&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Preferred Sync Reference: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pref_sync_ref</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_autosync_ref</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_WORD</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;Word Clock&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT_SYNC</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT Sync&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_SPDIF</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;SPDIF&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_NONE</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;None&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT1</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT1&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT2</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HDSP_AUTOSYNC_FROM_ADAT3</span>:
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;ADAT3&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">autosync_ref</span> <span class="o">=</span> <span class="s">&quot;---&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AutoSync Reference: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">autosync_ref</span><span class="p">);</span>

	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AutoSync Frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">));</span>

	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;System Clock Mode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">system_clock_mode</span><span class="p">);</span>

	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;System Clock Frequency: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">);</span>
	<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;System Clock Locked: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">clock_source_locked</span> <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">RPM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_spdif_in</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HDSP_SPDIFIN_OPTICAL</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: Optical</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_SPDIFIN_COAXIAL</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: Coaxial</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_SPDIFIN_INTERNAL</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: Internal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_SPDIFIN_AES</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: AES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 input: ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RPM</span> <span class="o">==</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Bypass</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;RPM Bypass: disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;RPM Bypass: enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Disconnect</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;RPM disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;RPM connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Inp12</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Phon_6dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 1/2: Phono, 6dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Phon_0dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 1/2: Phono, 0dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Phon_n6dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 1/2: Phono, -6dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Line_0dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 1/2: Line, 0dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp12_Line_n6dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 1/2: Line, -6dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 1/2: ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_RPM_Inp34</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Phon_6dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 3/4: Phono, 6dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Phon_0dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 3/4: Phono, 0dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Phon_n6dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 3/4: Phono, -6dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Line_0dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 3/4: Line, 0dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HDSP_RPM_Inp34_Line_n6dB</span>:
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 3/4: Line, -6dB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Input 3/4: ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFOpticalOut</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 output: Coaxial &amp; ADAT1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 output: Coaxial only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFProfessional</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 quality: Professional</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 quality: Consumer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 emphasis: on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 emphasis: off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFNonAudio</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 NonAudio: on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 NonAudio: off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">hdsp_spdif_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 sample rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;IEC958 sample rate: Error flag set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Sync Check */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_Sync0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_Lock0</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT1: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT1: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Digiface</span>:
	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_Sync1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_Lock1</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT2: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT2: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_Sync2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_Lock2</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT3: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT3: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* relax */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFSync</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_SPDIFErrorFlag</span><span class="p">)</span>
		<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SPDIF: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;SPDIF: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSP_wc_sync</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status2</span> <span class="o">&amp;</span> <span class="n">HDSP_wc_lock</span><span class="p">)</span>
		<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Word Clock: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_iprintf</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Word Clock: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_TimecodeSync</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_TimecodeLock</span><span class="p">)</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT Sync: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span> <span class="o">?</span> <span class="s">&quot;Sync&quot;</span> <span class="o">:</span> <span class="s">&quot;Lock&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;ADAT Sync: No Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Informations about H9632 specific controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_ad_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;-10 dBV&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;+4 dBu&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;Lo Gain&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AD Gain : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_da_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;Hi Gain&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;+4 dBu&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;-10 dBV&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;DA Gain : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp_phone_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;0 dB&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;-6 dB&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;-12 dB&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;Phones Gain : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;XLR Breakout Cable : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp_xlr_breakout_cable</span><span class="p">(</span><span class="n">hdsp</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;</span> <span class="n">HDSP_AnalogExtensionBoard</span><span class="p">)</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AEB : on (ADAT1 internal)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;AEB : off (ADAT1 external)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">snd_iprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_proc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_info_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">snd_card_proc_new</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;hdsp&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">))</span>
		<span class="n">snd_info_set_text_ops</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span> <span class="n">snd_hdsp_proc_read</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_free_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hammerfall_free_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">snd_hammerfall_free_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdsp_initialize_memory</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pb_bus</span><span class="p">,</span> <span class="n">cb_bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_hammerfall_get_buffer</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">,</span> <span class="n">HDSP_DMA_AREA_BYTES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">snd_hammerfall_get_buffer</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">,</span> <span class="n">HDSP_DMA_AREA_BYTES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">area</span><span class="p">)</span>
			<span class="n">snd_dma_free_pages</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: no buffers available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Align to bus-space 64K boundary */</span>

	<span class="n">cb_bus</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0x10000ul</span><span class="p">);</span>
	<span class="n">pb_bus</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0x10000ul</span><span class="p">);</span>

	<span class="cm">/* Tell the card where it is */</span>

	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_inputBufferAddress</span><span class="p">,</span> <span class="n">cb_bus</span><span class="p">);</span>
	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_outputBufferAddress</span><span class="p">,</span> <span class="n">pb_bus</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_buffer</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="p">(</span><span class="n">cb_bus</span> <span class="o">-</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_buffer</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">.</span><span class="n">area</span> <span class="o">+</span> <span class="p">(</span><span class="n">pb_bus</span> <span class="o">-</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_dma_buf</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_set_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* ASSUMPTION: hdsp-&gt;lock is either held, or</span>
<span class="cm">	   there is no need to hold it (e.g. during module</span>
<span class="cm">	   initialization).</span>
<span class="cm">	 */</span>

	<span class="cm">/* set defaults:</span>

<span class="cm">	   SPDIF Input via Coax</span>
<span class="cm">	   Master clock mode</span>
<span class="cm">	   maximum latency (7 =&gt; 2^7 = 8192 samples, 64Kbyte buffer,</span>
<span class="cm">	                    which implies 2 4096 sample, 32Kbyte periods).</span>
<span class="cm">           Enable line out.</span>
<span class="cm">	 */</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span> <span class="n">HDSP_ClockModeMaster</span> <span class="o">|</span>
		                 <span class="n">HDSP_SPDIFInputCoaxial</span> <span class="o">|</span>
		                 <span class="n">hdsp_encode_latency</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		                 <span class="n">HDSP_LineOut</span><span class="p">;</span>


	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>

<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="n">HDSP_BIGENDIAN_MODE</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span><span class="p">)</span>
	        <span class="n">snd_hdsp_9652_enable_mixer</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">);</span>

	<span class="n">hdsp_reset_hw_pointer</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp_compute_period_size</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="cm">/* silence everything */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HDSP_MATRIX_MIXER_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">MINUS_INFINITY_GAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1352</span> <span class="o">:</span> <span class="n">HDSP_MATRIX_MIXER_SIZE</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_write_gain</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">MINUS_INFINITY_GAIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* H9632 specific defaults */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="p">(</span><span class="n">HDSP_DAGainPlus4dBu</span> <span class="o">|</span> <span class="n">HDSP_ADGainPlus4dBu</span> <span class="o">|</span> <span class="n">HDSP_PhoneGain0dB</span><span class="p">);</span>
		<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set a default rate so that the channel map is set up.</span>
<span class="cm">	 */</span>

	<span class="n">hdsp_set_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hdsp_midi_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">snd_hdsp_midi_input_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">snd_hdsp_midi_input_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">snd_hdsp_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">audio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">midi0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">midi1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">midi0status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">midi1status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">schedule</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>

	<span class="n">audio</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_audioIRQPending</span><span class="p">;</span>
	<span class="n">midi0</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_midi0IRQPending</span><span class="p">;</span>
	<span class="n">midi1</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_midi1IRQPending</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">audio</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">midi0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">midi1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_interruptConfirmation</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">midi0status</span> <span class="o">=</span> <span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusIn0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">midi1status</span> <span class="o">=</span> <span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_midiStatusIn1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_InitializationComplete</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">].</span><span class="n">substream</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">)</span>
			<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">].</span><span class="n">substream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">midi0</span> <span class="o">&amp;&amp;</span> <span class="n">midi0status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we disable interrupts for this input until processing is done */</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_Midi0InterruptEnable</span><span class="p">;</span>
			<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">schedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_hdsp_midi_input_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">Multiface</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">RPM</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">H9632</span> <span class="o">&amp;&amp;</span> <span class="n">midi1</span> <span class="o">&amp;&amp;</span> <span class="n">midi1status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we disable interrupts for this input until processing is done */</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HDSP_Midi1InterruptEnable</span><span class="p">;</span>
			<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">schedule</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_hdsp_midi_input_read</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span> <span class="o">&amp;&amp;</span> <span class="n">schedule</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi_tasklet</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span> <span class="nf">snd_hdsp_hw_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hdsp_hw_pointer</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">hdsp_channel_buffer_location</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">stream</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>

<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mapped_channel</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mapped_channel</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">mapped_channel</span> <span class="o">*</span> <span class="n">HDSP_CHANNEL_BUFFER_BYTES</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">mapped_channel</span> <span class="o">*</span> <span class="n">HDSP_CHANNEL_BUFFER_BYTES</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_playback_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				  <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">channel_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">HDSP_CHANNEL_BUFFER_BYTES</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">channel_buf</span> <span class="o">=</span> <span class="n">hdsp_channel_buffer_location</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">channel_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">channel_buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_capture_copy</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				 <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">channel_buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">HDSP_CHANNEL_BUFFER_BYTES</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">channel_buf</span> <span class="o">=</span> <span class="n">hdsp_channel_buffer_location</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">channel_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">channel_buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_silence</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
				  <span class="n">snd_pcm_uframes_t</span> <span class="n">pos</span><span class="p">,</span> <span class="n">snd_pcm_uframes_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">channel_buf</span><span class="p">;</span>

	<span class="n">channel_buf</span> <span class="o">=</span> <span class="n">hdsp_channel_buffer_location</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">channel_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">channel_buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="n">hdsp_hw_pointer</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">oruntime</span> <span class="o">=</span> <span class="n">other</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">oruntime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">hw_ptr</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">this_pid</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">other_pid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">pstr</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSP_SPDIFProfessional</span> <span class="o">|</span> <span class="n">HDSP_SPDIFNonAudio</span> <span class="o">|</span> <span class="n">HDSP_SPDIFEmphasis</span><span class="p">);</span>
		<span class="n">hdsp_write</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">|=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span><span class="p">);</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">this_pid</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span><span class="p">;</span>
		<span class="n">other_pid</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">other_pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">this_pid</span> <span class="o">!=</span> <span class="n">other_pid</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* The other stream is open, and not by the same</span>
<span class="cm">		   task as this one. Make sure that the parameters</span>
<span class="cm">		   that matter are the same.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params_period_size</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">period_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* We&#39;re fine. */</span>

		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
 		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* how to make sure that the rate matches an externally-set one ?</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">clock_source_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_set_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">params_rate</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_set_interrupt_interval</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">params_period_size</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_snd_pcm_hw_param_setempty</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_channel_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">snd_pcm_channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mapped_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_BUG_ON</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mapped_channel</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">channel_map</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">mapped_channel</span> <span class="o">*</span> <span class="n">HDSP_CHANNEL_BUFFER_BYTES</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_IOCTL1_RESET</span>:
		<span class="k">return</span> <span class="n">snd_hdsp_reset</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_IOCTL1_CHANNEL_INFO</span>:
		<span class="k">return</span> <span class="n">snd_hdsp_channel_info</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snd_pcm_lib_ioctl</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">other</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="cm">/* no auto-loading in trigger */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">running</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_START</span>:
		<span class="n">running</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span>:
		<span class="n">running</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_BUG</span><span class="p">();</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_substream</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">other</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_substream</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
		<span class="n">snd_pcm_group_for_each_entry</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span>
					<span class="n">running</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">running</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">_ok</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">running</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
				<span class="n">hdsp_silence_playback</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">running</span> <span class="o">&amp;&amp;</span>
			    <span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">)</span>
				<span class="n">hdsp_silence_playback</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">==</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">)</span>
				<span class="n">hdsp_silence_playback</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">_ok:</span>
	<span class="n">snd_pcm_trigger_done</span><span class="p">(</span><span class="n">substream</span><span class="p">,</span> <span class="n">substream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="n">running</span><span class="p">)</span>
		<span class="n">hdsp_start_audio</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">running</span><span class="p">)</span>
		<span class="n">hdsp_stop_audio</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="n">running</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="n">hdsp_reset_hw_pointer</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_hdsp_playback_subinfo</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_SYNC_START</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_DOUBLE</span><span class="p">),</span>
<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_BE</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_64000</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_88200</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">96000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">6</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="n">HDSP_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="n">HDSP_CHANNEL_BUFFER_BYTES</span> <span class="o">*</span> <span class="n">HDSP_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">HDSP_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_hdsp_capture_subinfo</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>			<span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_NONINTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_SYNC_START</span><span class="p">),</span>
<span class="cp">#ifdef SNDRV_BIG_ENDIAN</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_BE</span><span class="p">,</span>
<span class="cp">#else</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S32_LE</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="p">(</span><span class="n">SNDRV_PCM_RATE_32000</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_44100</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_48000</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_64000</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_88200</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_RATE_96000</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">96000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">5</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="n">HDSP_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="n">HDSP_CHANNEL_BUFFER_BYTES</span> <span class="o">*</span> <span class="n">HDSP_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">8192</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">HDSP_MAX_CHANNELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fifo_size</span> <span class="o">=</span>		<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdsp_period_sizes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">8192</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hdsp_hw_constraints_period_sizes</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdsp_period_sizes</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">hdsp_period_sizes</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdsp_9632_sample_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">32000</span><span class="p">,</span> <span class="mi">44100</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="mi">64000</span><span class="p">,</span> <span class="mi">88200</span><span class="p">,</span> <span class="mi">96000</span><span class="p">,</span> <span class="mi">128000</span><span class="p">,</span> <span class="mi">176400</span><span class="p">,</span> <span class="mi">192000</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hw_constraint_list</span> <span class="n">hdsp_hw_constraints_9632_sample_rates</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hdsp_9632_sample_rates</span><span class="p">),</span>
	<span class="p">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">hdsp_9632_sample_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_rule_in_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_rule_out_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">list</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">snd_interval_list</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_rule_in_channels_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">96000</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">64000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_rule_out_channels_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">96000</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;</span> <span class="mi">48000</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="mi">96000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;</span> <span class="mi">64000</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_rule_rate_out_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hw_rule_rate_in_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">snd_pcm_hw_rule</span> <span class="o">*</span><span class="n">rule</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">rule</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_interval</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">hw_param_interval</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">128000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">&lt;=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">snd_interval</span> <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">64000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">96000</span><span class="p">,</span>
			<span class="p">.</span><span class="n">integer</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">return</span> <span class="n">snd_interval_refine</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_playback_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

        <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_hdsp_playback_subinfo</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_buffer</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">HDSP_DMA_AREA_BYTES</span><span class="p">;</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp_hw_constraints_period_sizes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">clock_source_locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp_hw_constraints_9632_sample_rates</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_hdsp_hw_rule_out_channels</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_hdsp_hw_rule_out_channels_rate</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
			     <span class="n">snd_hdsp_hw_rule_rate_out_channels</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RPM</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif_stream</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">creg_spdif</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
			<span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_playback_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RPM</span> <span class="o">!=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">access</span> <span class="o">|=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_INACTIVE</span><span class="p">;</span>
		<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span> <span class="o">|</span>
			<span class="n">SNDRV_CTL_EVENT_MASK_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">spdif_ctl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_set_sync</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_hdsp_capture_subinfo</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_buffer</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">HDSP_DMA_AREA_BYTES</span><span class="p">;</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">snd_pcm_hw_constraint_msbits</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_PERIOD_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp_hw_constraints_period_sizes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span> <span class="mi">192000</span><span class="p">;</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">SNDRV_PCM_RATE_KNOT</span><span class="p">;</span>
		<span class="n">snd_pcm_hw_constraint_list</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp_hw_constraints_9632_sample_rates</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_hdsp_hw_rule_in_channels</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span>
			     <span class="n">snd_hdsp_hw_rule_in_channels_rate</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">snd_pcm_hw_rule_add</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SNDRV_PCM_HW_PARAM_RATE</span><span class="p">,</span>
			     <span class="n">snd_hdsp_hw_rule_rate_in_channels</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span>
			     <span class="n">SNDRV_PCM_HW_PARAM_CHANNELS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_capture_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* helper functions for copying meter values */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_u32_le</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_u64_le</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src_low</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src_high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rms_low</span><span class="p">,</span> <span class="n">rms_high</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rms</span><span class="p">;</span>
	<span class="n">rms_low</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">src_low</span><span class="p">);</span>
	<span class="n">rms_high</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">src_high</span><span class="p">);</span>
	<span class="n">rms</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rms_high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">rms_low</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rms</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">copy_u48_le</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src_low</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src_high</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rms_low</span><span class="p">,</span> <span class="n">rms_high</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rms</span><span class="p">;</span>
	<span class="n">rms_low</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">src_low</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">;</span>
	<span class="n">rms_high</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">src_high</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff00</span><span class="p">;</span>
	<span class="n">rms</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">rms_high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">rms_low</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rms</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_9652_get_peak</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp_peak_rms</span> <span class="n">__user</span> <span class="o">*</span><span class="n">peak_rms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">doublespeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">ofs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_DoubleSpeedStatus</span><span class="p">)</span>
		<span class="n">doublespeed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">channels</span> <span class="o">=</span> <span class="n">doublespeed</span> <span class="o">?</span> <span class="mi">14</span> <span class="o">:</span> <span class="mi">26</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">doublespeed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">HDSP_9652_peakBase</span> <span class="o">-</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">input_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">-=</span> <span class="n">channels</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">playback_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">-=</span> <span class="n">channels</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">output_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">HDSP_9652_rmsBase</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u48_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">input_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">,</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">channels</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u48_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">playback_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">,</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ofs</span> <span class="o">+=</span> <span class="n">channels</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u48_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">output_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">,</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">ofs</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_9632_get_peak</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp_peak_rms</span> <span class="n">__user</span> <span class="o">*</span><span class="n">peak_rms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdsp_9632_meters</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">doublespeed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_DoubleSpeedStatus</span><span class="p">)</span>
		<span class="n">doublespeed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_9632_meters</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="o">+</span><span class="n">HDSP_9632_metersBase</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">input_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">input_peak</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">playback_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">playback_peak</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">output_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">output_peak</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u64_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">input_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">input_rms_low</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">input_rms_high</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u64_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">playback_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">playback_rms_low</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">playback_rms_high</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u64_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">output_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">output_rms_low</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">output_rms_high</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">doublespeed</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_get_peak</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp_peak_rms</span> <span class="n">__user</span> <span class="o">*</span><span class="n">peak_rms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">playback_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_playbackPeakLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">input_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_inputPeakLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">28</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u32_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">output_peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_outputPeakLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">26</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u64_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">playback_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_playbackRmsLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_playbackRmsLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_u64_le</span><span class="p">(</span><span class="o">&amp;</span><span class="n">peak_rms</span><span class="o">-&gt;</span><span class="n">input_rms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_inputRmsLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">HDSP_inputRmsLevel</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_hwdep_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">argp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SNDRV_HDSP_IOCTL_GET_PEAK_RMS</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdsp_peak_rms</span> <span class="n">__user</span> <span class="o">*</span><span class="n">peak_rms</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_peak_rms</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_check_for_iobox</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_FirmwareLoaded</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: firmware needs to be uploaded to the card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">H9652</span>:
			<span class="k">return</span> <span class="n">hdsp_9652_get_peak</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">peak_rms</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">H9632</span>:
			<span class="k">return</span> <span class="n">hdsp_9632_get_peak</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">peak_rms</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">hdsp_get_peak</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">peak_rms</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_HDSP_IOCTL_GET_CONFIG_INFO</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdsp_config_info</span> <span class="n">info</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_check_for_iobox</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_check_for_firmware</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">pref_sync_ref</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_pref_sync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">wordclock_sync_check</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_wc_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">H9632</span><span class="p">)</span>
		    <span class="n">info</span><span class="p">.</span><span class="n">adatsync_sync_check</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_adatsync_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_sync_check</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_spdif_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">Multiface</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">RPM</span> <span class="o">&amp;&amp;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">H9632</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">info</span><span class="p">.</span><span class="n">adat_sync_check</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_adat_sync_check</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_in</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_spdif_in</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_out</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_spdif_out</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_professional</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_spdif_professional</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_emphasis</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_spdif_emphasis</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_nonaudio</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_spdif_nonaudio</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">spdif_sample_rate</span> <span class="o">=</span> <span class="n">hdsp_spdif_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">system_sample_rate</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">autosync_sample_rate</span> <span class="o">=</span> <span class="n">hdsp_external_sample_rate</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">system_clock_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_system_clock_mode</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">clock_source</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_clock_source</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">autosync_ref</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_autosync_ref</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">info</span><span class="p">.</span><span class="n">line_out</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_line_out</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">da_gain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_da_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
			<span class="n">info</span><span class="p">.</span><span class="n">ad_gain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_ad_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
			<span class="n">info</span><span class="p">.</span><span class="n">phone_gain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_phone_gain</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
			<span class="n">info</span><span class="p">.</span><span class="n">xlr_breakout_cable</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_xlr_breakout_cable</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">RPM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">.</span><span class="n">da_gain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">hdsp_rpm_input12</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
			<span class="n">info</span><span class="p">.</span><span class="n">ad_gain</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">hdsp_rpm_input34</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span><span class="p">)</span>
			<span class="n">info</span><span class="p">.</span><span class="n">analog_extension_board</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">hdsp_aeb</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_HDSP_IOCTL_GET_9632_AEB</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdsp_9632_aeb</span> <span class="n">h9632_aeb</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">!=</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">h9632_aeb</span><span class="p">.</span><span class="n">aebi</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">-</span> <span class="n">H9632_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">h9632_aeb</span><span class="p">.</span><span class="n">aebo</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">-</span> <span class="n">H9632_SS_CHANNELS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">h9632_aeb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">h9632_aeb</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_HDSP_IOCTL_GET_VERSION</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdsp_version</span> <span class="n">hdsp_version</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_get_iobox_version</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdsp_version</span><span class="p">.</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">;</span>
		<span class="n">hdsp_version</span><span class="p">.</span><span class="n">firmware_rev</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">argp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdsp_version</span><span class="p">))))</span>
		    	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_HDSP_IOCTL_UPLOAD_FIRMWARE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdsp_firmware</span> <span class="n">__user</span> <span class="o">*</span><span class="n">firmware</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">firmware_data</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="cm">/* SNDRV_HDSP_IOCTL_GET_VERSION must have been called */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HDSP_FirmwareCached</span> <span class="o">|</span> <span class="n">HDSP_FirmwareLoaded</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: initializing firmware upload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">firmware</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_firmware</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">firmware_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">firmware</span><span class="o">-&gt;</span><span class="n">firmware_data</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_check_for_iobox</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">,</span> <span class="n">firmware_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">HDSP_FirmwareCached</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_load_firmware_from_cache</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_InitializationComplete</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_enable_io</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

			<span class="n">snd_hdsp_initialize_channels</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
			<span class="n">snd_hdsp_initialize_midi_flush</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_alsa_devices</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: error creating alsa devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">SNDRV_HDSP_IOCTL_GET_MIXER</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hdsp_mixer</span> <span class="n">__user</span> <span class="o">*</span><span class="n">mixer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp_mixer</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">argp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">mixer</span><span class="o">-&gt;</span><span class="n">matrix</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">mixer_matrix</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">*</span><span class="n">HDSP_MATRIX_MIXER_SIZE</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_hdsp_playback_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_hdsp_playback_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_hdsp_playback_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_hdsp_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_hdsp_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_hdsp_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_hdsp_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_hdsp_hw_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_hdsp_playback_copy</span><span class="p">,</span>
	<span class="p">.</span><span class="n">silence</span> <span class="o">=</span>	<span class="n">snd_hdsp_hw_silence</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_hdsp_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">snd_hdsp_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">snd_hdsp_capture_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">snd_hdsp_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>	<span class="n">snd_hdsp_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>	<span class="n">snd_hdsp_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>	<span class="n">snd_hdsp_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>	<span class="n">snd_hdsp_hw_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">copy</span> <span class="o">=</span>		<span class="n">snd_hdsp_capture_copy</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_create_hwdep</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_hwdep</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hwdep_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;HDSP hwdep&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">hwdep</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hdsp</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;HDSP hwdep interface&quot;</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">snd_hdsp_hwdep_ioctl</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">ioctl_compat</span> <span class="o">=</span> <span class="n">snd_hdsp_hwdep_ioctl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_create_pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">hdsp</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>

	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_PLAYBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hdsp_playback_ops</span><span class="p">);</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_hdsp_capture_ops</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="n">SNDRV_PCM_INFO_JOINT_DUPLEX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_9652_enable_mixer</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">|=</span> <span class="n">HDSP_9652_ENABLE_MIXER</span><span class="p">;</span>
	<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_control2Reg</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_enable_io</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_fifo_wait</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: enable_io fifo_wait failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_inputEnable</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_outputEnable</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_initialize_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">aebi_channels</span><span class="p">,</span> <span class="n">aebo_channels</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">Digiface</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Hammerfall DSP + Digiface&quot;</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">DIGIFACE_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">DIGIFACE_DS_CHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">H9652</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Hammerfall HDSP 9652&quot;</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">H9652_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">H9652_DS_CHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">H9632</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">);</span>
		<span class="cm">/* HDSP_AEBx bits are low when AEB are connected */</span>
		<span class="n">aebi_channels</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_AEBI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">aebo_channels</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">HDSP_AEBO</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Hammerfall HDSP 9632&quot;</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">H9632_SS_CHANNELS</span><span class="o">+</span><span class="n">aebi_channels</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">H9632_DS_CHANNELS</span><span class="o">+</span><span class="n">aebi_channels</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_in_channels</span> <span class="o">=</span> <span class="n">H9632_QS_CHANNELS</span><span class="o">+</span><span class="n">aebi_channels</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">H9632_SS_CHANNELS</span><span class="o">+</span><span class="n">aebo_channels</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">H9632_DS_CHANNELS</span><span class="o">+</span><span class="n">aebo_channels</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">qs_out_channels</span> <span class="o">=</span> <span class="n">H9632_QS_CHANNELS</span><span class="o">+</span><span class="n">aebo_channels</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">Multiface</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Hammerfall DSP + Multiface&quot;</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">MULTIFACE_SS_CHANNELS</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">MULTIFACE_DS_CHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RPM</span>:
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Hammerfall DSP + RPM&quot;</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_in_channels</span> <span class="o">=</span> <span class="n">RPM_CHANNELS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ss_out_channels</span> <span class="o">=</span> <span class="n">RPM_CHANNELS</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_in_channels</span> <span class="o">=</span> <span class="n">RPM_CHANNELS</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">ds_out_channels</span> <span class="o">=</span> <span class="n">RPM_CHANNELS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
 		<span class="cm">/* should never get here */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_initialize_midi_flush</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_hdsp_flush_midi_input</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">snd_hdsp_flush_midi_input</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_create_alsa_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_pcm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: Error creating pcm interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_midi</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: Error creating first midi interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">Digiface</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_midi</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: Error creating second midi interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_controls</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: Error creating ctl interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snd_hdsp_proc_init</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">system_sample_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">capture_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">playback_substream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_set_defaults</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: Error setting default values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_InitializationComplete</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Hammerfall DSP&quot;</span><span class="p">);</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
			<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: error registering card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">HDSP_InitializationComplete</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef HDSP_FW_LOADER</span>
<span class="cm">/* load firmware via hotplug fw loader */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hdsp_request_fw_loader</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwfile</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_get_iobox_version</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9652</span> <span class="o">||</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">==</span> <span class="n">H9632</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* caution: max length of firmware filename is 30! */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPM</span>:
		<span class="n">fwfile</span> <span class="o">=</span> <span class="s">&quot;rpm_firmware.bin&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Multiface</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">==</span> <span class="mh">0xa</span><span class="p">)</span>
			<span class="n">fwfile</span> <span class="o">=</span> <span class="s">&quot;multiface_firmware.bin&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fwfile</span> <span class="o">=</span> <span class="s">&quot;multiface_firmware_rev11.bin&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">Digiface</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">==</span> <span class="mh">0xa</span><span class="p">)</span>
			<span class="n">fwfile</span> <span class="o">=</span> <span class="s">&quot;digiface_firmware.bin&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fwfile</span> <span class="o">=</span> <span class="s">&quot;digiface_firmware_rev11.bin&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: invalid io_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fwfile</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: cannot load firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fwfile</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: too short firmware size %d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">));</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_cache</span><span class="p">));</span>

	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">HDSP_FirmwareCached</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_load_firmware_from_cache</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">HDSP_InitializationComplete</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_enable_io</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_hwdep</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: error creating hwdep device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snd_hdsp_initialize_channels</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="n">snd_hdsp_initialize_midi_flush</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_alsa_devices</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: error creating alsa devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdsp_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_9652</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_9632</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">rmidi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">output</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control2_register</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Undefined</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi_tasklet</span><span class="p">,</span> <span class="n">hdsp_midi_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_CLASS_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span><span class="p">);</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* From Martin Bjoernsen :</span>
<span class="cm">	    &quot;It is important that the card&#39;s latency timer register in</span>
<span class="cm">	    the PCI configuration space is set to a value much larger</span>
<span class="cm">	    than 0 by the computer&#39;s BIOS or the driver.</span>
<span class="cm">	    The windows driver always sets this 8 bit register [...]</span>
<span class="cm">	    to its maximum 255 to avoid problems with some computers.&quot;</span>
<span class="cm">	*/</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;H-DSP&quot;</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;Xilinx FPGA&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&lt;</span> <span class="mh">0xa</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&lt;</span> <span class="mh">0x64</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME Hammerfall DSP&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">firmware_rev</span> <span class="o">&lt;</span> <span class="mh">0x96</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME HDSP 9652&quot;</span><span class="p">;</span>
		<span class="n">is_9652</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span> <span class="o">=</span> <span class="s">&quot;RME HDSP 9632&quot;</span><span class="p">;</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">max_channels</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">is_9632</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="s">&quot;hdsp&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">HDSP_IO_EXTENT</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: unable to remap region 0x%lx-0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">+</span> <span class="n">HDSP_IO_EXTENT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">snd_hdsp_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: unable to use IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">precise_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">use_midi_tasklet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">dds_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_initialize_memory</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_9652</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_9632</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we wait a maximum of 10 seconds to let freshly</span>
<span class="cm">		 * inserted cardbus cards do their hardware init */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_wait_for_iobox</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hdsp_read</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_statusRegister</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_DllError</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HDSP_FW_LOADER</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">hdsp_request_fw_loader</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/* we don&#39;t fail as this can happen</span>
<span class="cm">				   if userspace is not ready for</span>
<span class="cm">				   firmware upload</span>
<span class="cm">				*/</span>
				<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Hammerfall-DSP: couldn&#39;t get firmware from userspace. try using hdsploader</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="cm">/* init is complete, we return */</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="cm">/* we defer initialization */</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: card initialization pending : waiting for firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_hwdep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">snd_printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Hammerfall-DSP: Firmware already present, initializing card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_version2</span><span class="p">)</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">RPM</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdsp_read</span><span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_status2Register</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HDSP_version1</span><span class="p">)</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Multiface</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">Digiface</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_enable_io</span><span class="p">(</span><span class="n">hdsp</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_9652</span><span class="p">)</span>
	        <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">H9652</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_9632</span><span class="p">)</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">H9632</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_hwdep</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">snd_hdsp_initialize_channels</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
	<span class="n">snd_hdsp_initialize_midi_flush</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">HDSP_FirmwareLoaded</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create_alsa_devices</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_hdsp_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop the audio, and cancel all interrupts */</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">midi_tasklet</span><span class="p">);</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">HDSP_Start</span><span class="o">|</span><span class="n">HDSP_AudioInterruptEnable</span><span class="o">|</span><span class="n">HDSP_Midi0InterruptEnable</span><span class="o">|</span><span class="n">HDSP_Midi1InterruptEnable</span><span class="p">);</span>
		<span class="n">hdsp_write</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">,</span> <span class="n">HDSP_controlRegister</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">control_register</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="n">snd_hdsp_free_buffers</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_hdsp_card_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdsp</span><span class="p">)</span>
		<span class="n">snd_hdsp_free</span><span class="p">(</span><span class="n">hdsp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">snd_hdsp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hdsp</span> <span class="o">*</span><span class="n">hdsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">dev</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">dev</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hdsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdsp</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_hdsp_card_free</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_hdsp_create</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">hdsp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;Hammerfall DSP&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx, irq %d&quot;</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
		<span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">,</span> <span class="n">hdsp</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">snd_hdsp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">hdsp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>     <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">snd_hdsp_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>    <span class="n">snd_hdsp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">snd_hdsp_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">hdsp_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
